<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AudioGuía Padre</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
  #menu, #mapa, #tresPuntos {
    position: fixed; top: 10px; right: 10px; margin-left: 10px; z-index: 1000;
    background: #eee; border: 1px solid #ccc; padding: 10px; display: none;
  }
  #btnCerrarIframe {
    position: fixed; top: 10px; right: 10px; z-index: 2000;
    background: black; color: red; font-weight: bold; font-size: 18px;
    border: 2px solid red; cursor: pointer; width: 30px; height: 30px;
    display: none; text-align: center; line-height: 26px;
    border-radius: 4px;
  }
  #modalReto {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: white; border: 2px solid #444; padding: 20px; z-index: 3000;
    display: none; width: 300px; text-align: center;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
  }
  #modalReto button {
    margin-top: 15px; padding: 10px 15px; font-size: 16px; cursor: pointer;
  }
  iframe {
    width: 100vw; height: 100vh; border: none; position: fixed; top: 0; left: 0;
    z-index: 1500; display: none;
  }
  #audioControl {
    position: fixed; bottom: 10px; left: 10px; background: #fff; padding: 10px;
    border: 1px solid #ccc; border-radius: 8px; z-index: 1100;
    display: flex; align-items: center; gap: 10px;
  }
  #btnPlay {
    color: red;
    font-weight: bold;
    cursor: pointer;
  }
  #btnPlay.playing {
    color: green;
  }
  #btnPause {
    cursor: pointer;
  }
</style>
</head>
<body>

<!-- Menús -->
<div id="menu">Menú Hamburguesa <button id="closeMenu">Cerrar</button></div>
<div id="mapa">Mapa <button id="closeMapa">Cerrar</button></div>
<div id="tresPuntos">Tres puntos <button id="closeTresPuntos">Cerrar</button></div>

<!-- Botón X para cerrar iframe -->
<div id="btnCerrarIframe">X</div>

<!-- Iframe para retos y puzzles -->
<iframe id="iframeContenido" src=""></iframe>

<!-- Modal para indicar reto -->
<div id="modalReto">
  <p>¡Resuelva su reto!</p>
  <button id="btnAbrirReto">Abrir reto</button>
  <button id="btnCerrarModal">Cerrar</button>
</div>

<!-- Controles de audio -->
<div id="audioControl">
  <button id="btnPlay" style="color:red;">Play</button>
  <button id="btnPause">Pause</button>
  <span id="nombreParada">Parada: -</span>
</div>

<script>
(() => {
  // Datos paradas con audio, retos y puzzles
  const paradas = [
    {
      id: 0,
      nombre: "Torres de Serranos",
      audioSrc: "Av1_audio_esp/Intro_ESPAÑOL_2.mp3",
      retosIndices: [1, 2],
      puzzleUrl: null,
    },
    {
      id: 1,
      nombre: "Puente de Serranos – Plaza de la crida",
      audioSrc: "audios/puente_serranos.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
    {
      id: 2,
      nombre: "Cortes Valencianas (Palacio de los Borgia)",
      audioSrc: "audios/cortes_valencianas.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
    {
      id: 3,
      nombre: "Plaza de la Virgen",
      audioSrc: "audios/plaza_virgen.mp3",
      retosIndices: [],
      puzzleUrl: "P8_puzzle_plaza_virgen.html",
    },
    {
      id: 4,
      nombre: "Plaza de la Almoína",
      audioSrc: "audios/plaza_almoina.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
    {
      id: 5,
      nombre: "Catedral de València",
      audioSrc: "audios/catedral_valencia.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
    {
      id: 6,
      nombre: "Plaza decimo Juno Bruto",
      audioSrc: "audios/plaza_juno_bruto.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
    {
      id: 7,
      nombre: "Basílica de València",
      audioSrc: "audios/basilica_valencia.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
    {
      id: 8,
      nombre: "Palacio Arzobispal",
      audioSrc: "audios/palacio_arzobispal.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
    {
      id: 9,
      nombre: "Plaza del Ayuntamiento",
      audioSrc: "audios/plaza_ayuntamiento.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
    {
      id: 10,
      nombre: "Edificio del Ayuntamiento de València",
      audioSrc: "audios/ayuntamiento_valencia.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
    {
      id: 11,
      nombre: "Estación de Ferrocarril (Estación del Norte)",
      audioSrc: "audios/estacion_norte.mp3",
      retosIndices: [],
      puzzleUrl: "P18_puzzle_plaza_de_Toros_y_estacion_norte.html",
    },
    {
      id: 12,
      nombre: "Plaza de Toros de València",
      audioSrc: "audios/plaza_toros.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
    {
      id: 13,
      nombre: "Casa estilo Árabe",
      audioSrc: "audios/casa_estilo_arabe.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
    {
      id: 14,
      nombre: "Palacio de Comunicaciones (Correos)",
      audioSrc: "audios/palacio_comunicaciones.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
    {
      id: 15,
      nombre: "Antigua sede del Banco de València",
      audioSrc: "audios/antigua_banco_valencia.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
    {
      id: 16,
      nombre: "Palacio del Marqués de Dos Aguas",
      audioSrc: "audios/palacio_marques_dos_aguas.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
    {
      id: 17,
      nombre: "Mercado Central",
      audioSrc: "audios/mercado_central.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
    {
      id: 18,
      nombre: "San Juan del Mercado",
      audioSrc: "audios/san_juan_mercado.mp3",
      retosIndices: [],
      puzzleUrl: "P18_puzzle_plaza_de_Toros_y_estacion_norte.html",
    },
    {
      id: 19,
      nombre: "Lonja de València",
      audioSrc: "audios/lonja_valencia.mp3",
      retosIndices: [],
      puzzleUrl: "P26_puzzle_lonja.html",
    },
    {
      id: 20,
      nombre: "Plaza del Doctor Collado",
      audioSrc: "audios/plaza_dr_collado.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
    {
      id: 21,
      nombre: "Plaza del Negrito",
      audioSrc: "audios/plaza_negrito.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
    {
      id: 22,
      nombre: "Calle Caballeros",
      audioSrc: "audios/calle_caballeros.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
    {
      id: 23,
      nombre: "Palacio de la Generalitat",
      audioSrc: "audios/palacio_generalitat.mp3",
      retosIndices: [],
      puzzleUrl: null,
    },
  ];

  // Estado actual
  let paradaActual = 0;
  let audioActivo = null;

  // Referencias DOM
  const btnPlay = document.getElementById("btnPlay");
  const btnPause = document.getElementById("btnPause");
  const nombreParadaSpan = document.getElementById("nombreParada");
  const iframe = document.getElementById("iframeContenido");
  const btnCerrarIframe = document.getElementById("btnCerrarIframe");
  const modalReto = document.getElementById("modalReto");
  const btnAbrirReto = document.getElementById("btnAbrirReto");
  const btnCerrarModal = document.getElementById("btnCerrarModal");

  // Menús
  const menuHamburguesa = document.getElementById("menu");
  const mapa = document.getElementById("mapa");
  const tresPuntos = document.getElementById("tresPuntos");
  const closeMenuBtn = document.getElementById("closeMenu");
  const closeMapaBtn = document.getElementById("closeMapa");
  const closeTresPuntosBtn = document.getElementById("closeTresPuntos");

  // Audio object
  let audio = new Audio();

  // Actualizar estado UI y cargar audio para parada actual
  function cargarParada(index) {
    paradaActual = index;
    const parada = paradas[index];
    nombreParadaSpan.textContent = "Parada: " + parada.nombre;

    // Cargar audio pero no reproducir
    audio.src = parada.audioSrc;
    audio.load();

    // Botón play rojo (audio no listo)
    btnPlay.classList.remove("playing");
    btnPlay.style.color = "red";

    // Ocultar iframe y modal si estaban abiertos
    iframe.style.display = "none";
    modalReto.style.display = "none";
    btnCerrarIframe.style.display = "none";
  }

  // Botón play: reproducir audio si cargado
  btnPlay.addEventListener("click", () => {
    if (!audio.src) return;
    audio.play();
    btnPlay.classList.add("playing");
    btnPlay.style.color = "green";
  });

  // Botón pause: pausar audio
  btnPause.addEventListener("click", () => {
    audio.pause();
    btnPlay.classList.remove("playing");
    btnPlay.style.color = "red";
  });

  // Evento cuando audio termina, mostrar modal reto
  audio.addEventListener("ended", () => {
    btnPlay.classList.remove("playing");
    btnPlay.style.color = "red";
    mostrarModalReto();
  });

  // Mostrar modal reto
  function mostrarModalReto() {
    modalReto.style.display = "block";
  }

  // Ocultar modal reto
  function ocultarModalReto() {
    modalReto.style.display = "none";
  }

  // Abrir iframe reto/puzzle al pulsar botón en modal
  btnAbrirReto.addEventListener("click", () => {
    ocultarModalReto();

    const parada = paradas[paradaActual];
    let urlRetos = "Av1-esp-retos-preguntas.html";

    // Si hay índices de retos, añadimos query param
    if (parada.retosIndices && parada.retosIndices.length > 0) {
      urlRetos += "?retos=" + parada.retosIndices.join(",");
    }

    // Si hay puzzle, lo usamos en lugar de retos
    if (parada.puzzleUrl) {
      iframe.src = parada.puzzleUrl;
    } else {
      iframe.src = urlRetos;
    }

    iframe.style.display = "block";
    btnCerrarIframe.style.display = "block";
  });

  // Cerrar modal reto
  btnCerrarModal.addEventListener("click", () => {
    ocultarModalReto();
  });

  // Cerrar iframe
  btnCerrarIframe.addEventListener("click", () => {
    iframe.style.display = "none";
    btnCerrarIframe.style.display = "none";
  });

  // Funciones para abrir y cerrar menús (y pausar audio)
  function abrirMenu(menu) {
    menu.style.display = "block";
    audio.pause();
    btnPlay.classList.remove("playing");
    btnPlay.style.color = "red";
  }
  function cerrarMenu(menu) {
    menu.style.display = "none";
    // No se reanuda audio automáticamente, usuario debe pulsar play
  }

  // Listeners menús
  document.getElementById("btnHamburguesa")?.addEventListener("click", () => abrirMenu(menuHamburguesa));
  document.getElementById("btnMapa")?.addEventListener("click", () => abrirMenu(mapa));
  document.getElementById("btnTresPuntos")?.addEventListener("click", () => abrirMenu(tresPuntos));

  closeMenuBtn.addEventListener("click", () => cerrarMenu(menuHamburguesa));
  closeMapaBtn.addEventListener("click", () => cerrarMenu(mapa));
  closeTresPuntosBtn.addEventListener("click", () => cerrarMenu(tresPuntos));

  // Avanzar parada (por ejemplo, con botón confirmar)
  function avanzarParada() {
    if (paradaActual + 1 < paradas.length) {
      cargarParada(paradaActual + 1);
    } else {
      // Ruta finalizada
      alert("¡Felicidades! Aventura completada.");
      // Aquí puedes añadir animación fuegos artificiales, limpiar datos, etc.
      // Borrar localStorage para limpiar info:
      localStorage.clear();
      // Recargar página para reiniciar todo
      location.reload();
    }
  }

  // Aquí puedes añadir botón o lógica para confirmar reto/puzzle completado y avanzar parada
  // Ejemplo sencillo con confirm():
  window.confirmarRetoCompletado = () => {
    if(confirm("¿Has completado el reto/puzzle?")) {
      avanzarParada();
    }
  };

  // Comunicación con hijo iframe (postMessage)
  window.addEventListener("message", (event) => {
    const { data } = event;
    // Ejemplo: hijo notifica reto completado
    if(data === "reto_completado") {
      avanzarParada();
      // Puedes enviar orden al hijo o hacer otras cosas aquí
    }
    // Otros mensajes según necesidad
  });

  // Guardar estado en localStorage para no perder progreso en recarga
  function guardarEstado() {
    localStorage.setItem("paradaActual", paradaActual);
  }
  function cargarEstado() {
    const guardado = localStorage.getItem("paradaActual");
    if(guardado !== null) {
      cargarParada(parseInt(guardado));
    } else {
      cargarParada(0);
    }
  }

  // Guardar estado cada vez que cambies parada
  const originalCargarParada = cargarParada;
  cargarParada = (index) => {
    originalCargarParada(index);
    guardarEstado();
  };

  // Inicio
  cargarEstado();

  // Exponer función global para avanzar parada desde consola o hijo si se quiere
  window.avanzarParada = avanzarParada;

  // Mostrar botones para abrir menús - simulación simple (opcional)
  const divMenus = document.createElement("div");
  divMenus.style.position = "fixed";
  divMenus.style.top = "10px";
  divMenus.style.left = "10px";
  divMenus.style.zIndex = "1000";
  divMenus.style.background = "#eee";
  divMenus.style.padding = "10px";
  divMenus.style.border = "1px solid #ccc";

  const btnHamburguesa = document.createElement("button");
  btnHamburguesa.textContent = "Hamburguesa";
  btnHamburguesa.id = "btnHamburguesa";
  divMenus.appendChild(btnHamburguesa);

  const btnMapa = document.createElement("button");
  btnMapa.textContent = "Mapa";
  btnMapa.id = "btnMapa";
  divMenus.appendChild(btnMapa);

  const btnTresPuntos = document.createElement("button");
  btnTresPuntos.textContent = "Tres puntos";
  btnTresPuntos.id = "btnTresPuntos";
  divMenus.appendChild(btnTresPuntos);

  document.body.appendChild(divMenus);
})();
</script>

</body>
</html>
