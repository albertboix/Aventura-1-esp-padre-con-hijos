<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mapa padre con Leaflet y iframe Av1-coordenadas.html</title>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-sA+o11o3JsKFY3Dc6rQ7PzGzO1bXYo7B1p+nJZpJb38="
  crossorigin=""
/>

<style>
  html, body, #map {
    height: 100%;
    margin: 0; padding: 0;
  }

  /* Botones flotantes */

  /* Hamburguesa inferior izquierda */
  #btnHamburguesa {
    position: fixed;
    bottom: 12px;
    left: 12px;
    width: 40px; height: 40px;
    background: #004080;
    border-radius: 6px;
    color: white;
    font-size: 28px;
    text-align: center;
    line-height: 40px;
    cursor: pointer;
    user-select: none;
    z-index: 1500;
  }

  /* Tres botones inferior derecha */
  #btnsDerecha {
    position: fixed;
    bottom: 12px;
    right: 12px;
    display: flex;
    gap: 8px;
    z-index: 1500;
  }
  #btnsDerecha button {
    width: 40px;
    height: 40px;
    background: #004080;
    border: none;
    border-radius: 6px;
    color: white;
    font-size: 20px;
    cursor: pointer;
    user-select: none;
  }

  /* Bot√≥n APAS esquina superior derecha */
  #btnAPAS {
    position: fixed;
    top: 12px;
    right: 12px;
    width: 40px; height: 40px;
    background: #004080;
    border-radius: 6px;
    color: white;
    font-size: 22px;
    text-align: center;
    line-height: 40px;
    cursor: pointer;
    user-select: none;
    z-index: 1500;
  }

  /* Bot√≥n GPS esquina superior izquierda */
  #btnGPS {
    position: fixed;
    top: 12px;
    left: 12px;
    width: 40px; height: 40px;
    background: #004080;
    border-radius: 6px;
    color: white;
    font-size: 22px;
    text-align: center;
    line-height: 40px;
    cursor: pointer;
    user-select: none;
    z-index: 1500;
  }

  /* Contenedor iframe con bot√≥n X para cerrar */
  #iframeContainer {
    position: fixed;
    top: 60px;
    right: 12px;
    width: 350px;
    height: 400px;
    background: #003366;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.7);
    z-index: 1400;
    display: flex;
    flex-direction: column;
  }
  #iframeContainer.hidden {
    display: none;
  }

  #iframeHeader {
    height: 36px;
    background: #0059b3;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    padding-right: 6px;
    user-select: none;
  }
  #iframeCloseBtn {
    background: orange;
    color: #003366;
    border: none;
    border-radius: 4px;
    font-weight: bold;
    cursor: pointer;
    width: 28px;
    height: 28px;
    line-height: 28px;
    text-align: center;
  }

  iframe {
    flex-grow: 1;
    border: none;
    border-radius: 0 0 8px 8px;
  }

  /* Bot√≥n play activable */
  #btnPlay {
    position: fixed;
    top: 60px;
    left: 60px;
    width: 48px; height: 48px;
    background: #007700;
    border-radius: 50%;
    color: white;
    font-size: 28px;
    line-height: 48px;
    text-align: center;
    cursor: pointer;
    user-select: none;
    z-index: 1500;
    opacity: 0.3;
    transition: opacity 0.3s;
  }
  #btnPlay.active {
    opacity: 1;
    background: #00cc00;
  }
</style>

</head>
<body>

<div id="map"></div>

<!-- Botones flotantes -->
<div id="btnHamburguesa" title="Men√∫">&#9776;</div>

<div id="btnsDerecha" title="Tres botones flotantes">
  <button title="Bot√≥n 1">1</button>
  <button title="Bot√≥n 2">2</button>
  <button title="Bot√≥n 3">3</button>
</div>

<div id="btnAPAS" title="Bot√≥n APAS">üó∫Ô∏è</div>

<div id="btnGPS" title="Activar/Desactivar GPS">üìç</div>

<!-- Bot√≥n play activable -->
<div id="btnPlay" title="Play">&#9658;</div>

<!-- Contenedor iframe -->
<div id="iframeContainer">
  <div id="iframeHeader">
    <button id="iframeCloseBtn" title="Cerrar iframe">X</button>
  </div>
  <iframe src="Av1-coordenadas.html" id="iframeAv1"></iframe>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-o9N1j7N46AIvL6auQJcMXj1S6hQz8ch+JXsnXYp9B38="
  crossorigin=""
></script>

<script>
  // Inicializamos el mapa
  const map = L.map('map').setView([40.4168, -3.7038], 13); // Madrid centro por defecto

  // A√±adimos OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  // Contenedor de marcadores para limpiar si es necesario
  const markers = {};

  // Escuchar mensajes del iframe Av1-coordenadas.html
  window.addEventListener('message', (event) => {
    // Podr√≠amos verificar origin si se requiere seguridad
    if (!event.data) return;

    if (event.data.tipo === 'paradas') {
      const paradas = event.data.paradas; // array con objetos {id, nombre, lat, lng}
      // Limpiar marcadores anteriores
      for(let key in markers) {
        map.removeLayer(markers[key]);
      }
      // A√±adir marcadores nuevos
      paradas.forEach(p => {
        const mk = L.marker([p.lat, p.lng]).addTo(map).bindPopup(p.nombre);
        mk.on('click', () => {
          mk.openPopup();
          // Enviar mensaje al iframe si quieres que haga algo
          // o aqu√≠ disparar evento en padre si se requiere
        });
        markers[p.id] = mk;
      });
    }

    if(event.data.tipo === 'parada_detectada') {
      const paradaId = event.data.id; // el slug de la parada
      activarBotonPlay(paradaId);
    }
  });

  // Funci√≥n para activar bot√≥n play
  const btnPlay = document.getElementById('btnPlay');
  function activarBotonPlay(paradaId) {
    // Por ahora simplemente lo activamos y ponemos t√≠tulo con id
    btnPlay.classList.add('active');
    btnPlay.title = `Play activado para parada: ${paradaId}`;
  }

  // Bot√≥n para cerrar/abrir iframe
  const iframeContainer = document.getElementById('iframeContainer');
  const iframeCloseBtn = document.getElementById('iframeCloseBtn');

  iframeCloseBtn.addEventListener('click', () => {
    if(iframeContainer.classList.contains('hidden')){
      iframeContainer.classList.remove('hidden');
      iframeCloseBtn.textContent = 'X';
    } else {
      iframeContainer.classList.add('hidden');
      iframeCloseBtn.textContent = '‚ñ∂';
    }
  });

  // Opcional: A√±adir funci√≥n para bot√≥n GPS para simular activar/desactivar
  const btnGPS = document.getElementById('btnGPS');
  let gpsActivo = false;
  btnGPS.addEventListener('click', () => {
    gpsActivo = !gpsActivo;
    btnGPS.style.background = gpsActivo ? '#007700' : '#004080';
    btnGPS.title = gpsActivo ? 'GPS Activado' : 'GPS Desactivado';
    // Aqu√≠ puedes a√±adir l√≥gica real de geolocalizaci√≥n si quieres
  });

  // Otros botones (hamburguesa, APAS, tres botones) pueden tener listeners vac√≠os por ahora
  document.getElementById('btnHamburguesa').addEventListener('click', () => {
    alert('Bot√≥n hamburguesa pulsado');
  });
  document.getElementById('btnAPAS').addEventListener('click', () => {
    alert('Bot√≥n APAS pulsado');
  });
  [...document.querySelectorAll('#btnsDerecha button')].forEach((btn, i) => {
    btn.addEventListener('click', () => {
      alert(`Bot√≥n derecho ${i+1} pulsado`);
    });
  });

</script>

</body>
</html>
