<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>App Aventura - Padre</title>
<style>
  /* Reset y básico */
  body {
    margin: 0; padding: 0; font-family: Arial, sans-serif;
    background: #f0f0f0;
  }

  /* Contenedor de mapa si hace falta */
  #mapa-contenedor {
    width: 100%; height: 100vh;
    background: #ddd; /* placeholder */
  }

  /* BOTONES FLOTANTES */
  .boton-flotante {
    position: fixed;
    background: #004080;
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    font-size: 26px;
    text-align: center;
    line-height: 50px;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    user-select: none;
    transition: background-color 0.3s;
    z-index: 1000;
  }
  .boton-flotante:hover {
    background: #0066cc;
  }

  /* Posiciones específicas */
  #btn-hamburguesa {
    bottom: 20px;
    left: 20px;
  }
  #btn-tres-puntos {
    bottom: 20px;
    left: 90px;
  }
  #btn-mapa {
    bottom: 20px;
    left: 160px;
  }

  /* SUBMENÚS (pestañas que salen junto a cada botón) */
  .submenu {
    position: fixed;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    padding: 10px;
    display: none;
    z-index: 1001;
    min-width: 180px;
  }
  /* Ubicamos los submenus cerca de sus botones */
  #submenu-hamburguesa {
    bottom: 80px;
    left: 20px;
  }
  #submenu-tres-puntos {
    bottom: 80px;
    left: 90px;
  }
  #submenu-mapa {
    bottom: 80px;
    left: 160px;
    display: flex;
    flex-direction: row;
    gap: 10px;
    min-width: auto;
  }

  /* Botones dentro de submenus */
  .submenu button {
    background: #004080;
    color: white;
    border: none;
    padding: 8px 12px;
    margin: 4px 0;
    width: 100%;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s;
  }
  /* Para submenu mapa que es fila, botones más pequeños */
  #submenu-mapa button {
    width: 50px;
    height: 50px;
    font-size: 24px;
    padding: 0;
    line-height: 50px;
  }
  .submenu button:hover {
    background: #0066cc;
  }

  /* PANTALLA COMPLETA CON IFRAME */
  #pantalla-completa {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #000c;
    z-index: 1100;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }
  #pantalla-completa iframe {
    width: 100vw;
    height: 100vh;
    border: none;
  }
  #cerrar-pantalla {
    position: absolute;
    top: 10px;
    right: 15px;
    background: #f33;
    border: none;
    color: white;
    font-size: 24px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    z-index: 1110;
    line-height: 36px;
  }

  /* MODAL TÉRMINOS Y CONDICIONES */
  #modal-terminos {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1200;
  }
  #contenido-terminos {
    background: white;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    border-radius: 10px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  #contenido-terminos iframe {
    flex: 1;
    border: none;
  }
  #btn-aceptar-terminos {
    background: #004080;
    color: white;
    border: none;
    padding: 15px;
    font-size: 18px;
    cursor: pointer;
    width: 100%;
  }
  #btn-aceptar-terminos:hover {
    background: #0066cc;
  }

  /* BLOQUEO DE INTERACCIÓN CUANDO NO HAY PERMISO */
  body.no-interactivo *:not(#modal-terminos):not(#modal-terminos *) {
    pointer-events: none;
    user-select: none;
  }
</style>
</head>
<body class="no-interactivo">

<div id="mapa-contenedor"></div>

<!-- Botones flotantes -->
<div id="btn-hamburguesa" class="boton-flotante" title="Menú">&#9776;</div>
<div id="btn-tres-puntos" class="boton-flotante" title="Opciones">&#8942;</div>
<div id="btn-mapa" class="boton-flotante" title="Mapa">&#128506;</div>

<!-- Submenús -->
<div id="submenu-hamburguesa" class="submenu">
  <button data-url="retos_con_puzzles_Av1_es.html">Retos y Puzzles</button>
  <button data-url="Gastronomia.html">Gastronomía</button>
  <button data-url="paginas_oficiales.html">Páginas Oficiales</button>
  <button data-url="enlaces_valencia_historica.html">València Histórica</button>
</div>

<div id="submenu-tres-puntos" class="submenu">
  <button data-url="Agradecimientos.html">Agradecimientos</button>
  <button data-url="consejos_seguridad_vial.html">Consejos Seguridad Vial</button>
  <button id="btn-fuentes-info">Fuentes (En desarrollo)</button>
</div>

<div id="submenu-mapa" class="submenu">
  <button title="Coordenadas" data-url="Av1-coordenadas.html" aria-label="Coordenadas">&#128506;</button>
  <button title="Ruta Completa" data-url="ruta_completa.html" aria-label="Ruta Completa">&#128205;</button>
  <button title="Mapa Tradicional" data-url="mapas/Av1_mapa.jpg" aria-label="Mapa Tradicional">&#128441;</button>
</div>

<!-- Pantalla completa -->
<div id="pantalla-completa">
  <button id="cerrar-pantalla" title="Cerrar pantalla completa">✕</button>
  <iframe id="iframe-contenido" src="" allow="geolocation; autoplay" allowfullscreen></iframe>
</div>

<!-- Modal términos y condiciones -->
<div id="modal-terminos">
  <div id="contenido-terminos">
    <iframe src="terminos_y_condiciones.html" title="Términos y condiciones"></iframe>
    <button id="btn-aceptar-terminos">Aceptar términos y condiciones</button>
  </div>
</div>

<script>
  const btnHamburguesa = document.getElementById('btn-hamburguesa');
  const btnTresPuntos = document.getElementById('btn-tres-puntos');
  const btnMapa = document.getElementById('btn-mapa');
  const submenuHamburguesa = document.getElementById('submenu-hamburguesa');
  const submenuTresPuntos = document.getElementById('submenu-tres-puntos');
  const submenuMapa = document.getElementById('submenu-mapa');
  const pantallaCompleta = document.getElementById('pantalla-completa');
  const iframeContenido = document.getElementById('iframe-contenido');
  const btnCerrarPantalla = document.getElementById('cerrar-pantalla');
  const modalTerminos = document.getElementById('modal-terminos');
  const btnAceptarTerminos = document.getElementById('btn-aceptar-terminos');
  const btnFuentesInfo = document.getElementById('btn-fuentes-info');
  const body = document.body;

  let permisosAceptados = false;
  let audioContext = null;
  let watchId = null;

  // Mostrar/Ocultar submenús
  function ocultarSubmenus() {
    submenuHamburguesa.style.display = 'none';
    submenuTresPuntos.style.display = 'none';
    submenuMapa.style.display = 'none';
  }

  function toggleSubmenu(submenu) {
    if(submenu.style.display === 'block' || submenu.style.display === 'flex'){
      ocultarSubmenus();
    } else {
      ocultarSubmenus();
      submenu.style.display = (submenu === submenuMapa) ? 'flex' : 'block';
    }
  }

  // Pedir permiso geolocalización (devuelve Promise)
  function pedirPermisoGPS(){
    return new Promise((resolve, reject) => {
      if(!navigator.geolocation){
        alert('Tu navegador no soporta geolocalización.');
        reject();
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          // Podemos usar watchPosition para actualizar si quieres, aquí sólo current para permiso
          resolve(pos.coords);
        },
        err => {
          alert('Permiso GPS denegado o error obteniendo ubicación.');
          reject();
        }
      );
    });
  }

  // Pedir permiso audio (resumido)
  function pedirPermisoAudio(){
    return new Promise((resolve, reject) => {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        audioContext.resume().then(() => resolve(true));
      } catch(e){
        alert('Audio no soportado o error al activar.');
        reject();
      }
    });
  }

  // Al aceptar términos se piden permisos y desbloquea interfaz
  btnAceptarTerminos.addEventListener('click', async () => {
    try {
      await pedirPermisoGPS();
      await pedirPermisoAudio();
      permisosAceptados = true;
      modalTerminos.style.display = 'none';
      body.classList.remove('no-interactivo');
    } catch {
      alert('Debes aceptar los permisos para continuar.');
    }
  });

  // Eventos botones flotantes
  btnHamburguesa.addEventListener('click', () => {
    if(!permisosAceptados) {
      alert('Debes aceptar términos y permisos para usar la app.');
      return;
    }
    toggleSubmenu(submenuHamburguesa);
  });
  btnTresPuntos.addEventListener('click', () => {
    if(!permisosAceptados) {
      alert('Debes aceptar términos y permisos para usar la app.');
      return;
    }
    toggleSubmenu(submenuTresPuntos);
  });
  btnMapa.addEventListener('click', () => {
    if(!permisosAceptados) {
      alert('Debes aceptar términos y permisos para usar la app.');
      return;
    }
    toggleSubmenu(submenuMapa);
  });

  // Fuentes info botón en desarrollo
  btnFuentesInfo.addEventListener('click', () => {
    alert('Esta sección está en desarrollo.');
  });

  // Abrir pantalla completa con URL
  function abrirPantallaCompleta(url) {
    ocultarSubmenus();
    pantallaCompleta.style.display = 'flex';

    // Si es imagen (mapa tradicional), lo cargamos como data URI en iframe o con etiqueta <img>
    // Como iframe no carga imagen bien con permisos etc, lo hacemos con html inline:
    if(url.endsWith('.jpg') || url.endsWith('.png')) {
      const htmlImg = `
        <html><body style="margin:0;display:flex;justify-content:center;align-items:center;background:#000">
          <img src="${url}" style="max-width:100vw; max-height:100vh;" alt="Mapa tradicional" />
        </body></html>`;
      const blob = new Blob([htmlImg], {type: 'text/html'});
      const blobUrl = URL.createObjectURL(blob);
      iframeContenido.src = blobUrl;

      // Bloqueo giro pantalla para imagen mapa tradicional
      if(screen.orientation && screen.orientation.lock){
        screen.orientation.lock('portrait').catch(()=>{});
      }
    } else {
      iframeContenido.src = url;
      // Desbloqueo orientación
      if(screen.orientation && screen.orientation.unlock){
        screen.orientation.unlock();
      }
    }

    // Aquí se podrían pausar audio, gps, etc (depende de implementación)
    if(watchId !== null){
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    if(audioContext){
      audioContext.suspend();
    }
  }

  // Eventos botones submenu (cada botón que tenga data-url)
  document.querySelectorAll('.submenu button[data-url]').forEach(btn => {
    btn.addEventListener('click', () => {
      if(!permisosAceptados) {
        alert('Debes aceptar términos y permisos para usar la app.');
        return;
      }
      abrirPantallaCompleta(btn.getAttribute('data-url'));
    });
  });

  // Cerrar pantalla completa
  btnCerrarPantalla.addEventListener('click', () => {
    pantallaCompleta.style.display = 'none';
    iframeContenido.src = '';
    ocultarSubmenus();

    // Desbloquear giro de pantalla
    if(screen.orientation && screen.orientation.unlock){
      screen.orientation.unlock();
    }

    // Reactivar audio y gps (si quieres aquí podrías reiniciar)
    if(audioContext){
      audioContext.resume();
    }
  });

  // Cerrar submenús si click fuera
  document.addEventListener('click', e => {
    if(!e.target.closest('.boton-flotante') && !e.target.closest('.submenu')) {
      ocultarSubmenus();
    }
  });

</script>
</body>
</html>
