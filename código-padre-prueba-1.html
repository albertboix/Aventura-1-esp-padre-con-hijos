<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aventura 1: Descubre Valencia (Padre)</title>
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
        /* CSS para el padre (código-padre-prueba-1.html) */
        body {
            font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif;
            margin: 1em;
            background: #fff;
            color: #222;
            font-size: 16px; /* Tamaño de fuente base */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: calc(100vh - 2em);
            justify-content: flex-start;
            position: relative; /* Necesario para posicionamiento de botones fijos */
        }
        h2 {
            margin-bottom: 0.8em;
            text-align: center;
            width: 100%;
        }

        /* Contenedor principal para iframes de retos/puzzles */
        #reto-container {
            /* Los bordes deben ser siempre de igual grosor. */
            border: 3px solid #ccc; /* Grosor inicial */
            border-radius: 8px;
            padding: 0;
            margin-bottom: 1em;
            position: relative;
            min-height: 250px;
            width: 100%;
            max-width: 980px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            transition: border-color 0.3s ease-in-out; /* Transición suave para el color del borde */
        }

        #reto-iframe,
        #puzzleIframe {
            width: 100%;
            height: 600px;
            border: none;
            display: none; /* Ocultos por defecto */
        }

        #button-container-padre {
            display: flex;
            flex-wrap: wrap;
            gap: 1em;
            margin-top: 1em;
            justify-content: center;
            width: 100%;
            min-height: 40px;
        }

        button.btn-padre {
            padding: 0.6em 1.2em;
            font-size: 1.1em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background-color: #0077cc;
            color: white;
            user-select: none;
            transition: background-color 0.3s ease;
        }
        button.btn-padre:hover {
            background-color: #005699;
        }
        button.btn-padre:disabled {
            background-color: #999;
            cursor: not-allowed;
        }

        #btnNextAfterReto {
            background-color: #0077cc;
            display: none; /* Oculto por defecto */
        }
        #btnNextAfterReto:hover {
            background-color: #005699;
        }

        /* Clases para el borde del contenedor, aplicadas por el padre */
        #reto-container.correct {
            border-color: #28a745; /* Verde */
        }
        #reto-container.incorrect {
            border-color: #c00; /* Rojo */
        }
        #reto-container.ready {
            border-color: #0077cc; /* Azul para "esperando respuesta" */
        }
        #reto-container.revealed {
            border-color: #ffc107; /* Naranja/Amarillo para respuesta mostrada */
        }
        #reto-container.no-reto {
            border-color: transparent; /* Transparente si no hay reto/puzzle */
        }

        /* Estilos para el reproductor de audio */
        .audio-player-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1em;
            margin-bottom: 2em;
            padding: 1em;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            width: 100%;
            max-width: 600px;
        }

        #audioControlContainer {
            display: flex;
            align-items: center;
            gap: 1em;
            width: 100%;
            justify-content: center;
        }

        /* El botón de play/pause ahora es un placeholder para el hijo */
        #playPauseBtn {
            padding: 1em;
            font-size: 1.2em;
            border: none;
            border-radius: 50%;
            background-color: #6c757d; /* Gris para indicar que no está activo todavía */
            color: white;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
        }
        #playPauseBtn.active { /* Clase para cuando está activo por proximidad */
            background-color: #28a745; /* Verde */
        }
        #playPauseBtn:hover:not(:disabled):not(.active) {
            background-color: #5a6268;
        }
        #playPauseBtn.active:hover:not(:disabled) {
            background-color: #218838;
        }

        #playPauseBtn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #playPauseBtn i {
            pointer-events: none; /* Evita que el icono interfiera con el click del botón */
        }

        #progressBarContainer {
            flex-grow: 1; /* Ocupa el espacio disponible */
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }

        #progressBar {
            height: 100%;
            width: 0%;
            background-color: #0077cc;
            border-radius: 4px;
        }

        #currentTime,
        #duration {
            font-size: 0.9em;
            color: #555;
            min-width: 40px; /* Para evitar saltos de texto */
            text-align: center;
        }

        #locationStatus {
            font-size: 0.9em;
            margin-top: 0.5em;
            text-align: center;
        }

        /* Controles de depuración para GPS */
        #gpsDebugControls {
            margin-top: 1.5em;
            padding: 1em;
            border: 1px dashed #ccc;
            border-radius: 8px;
            background-color: #f0f0f0;
            text-align: center;
            width: 100%;
            max-width: 600px;
        }
        #gpsDebugControls button {
            background-color: #0077cc;
            color: white;
            padding: 0.5em 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0.5em;
        }
        #gpsDebugControls button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #terminarAventuraBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #ff4d4d; /* Rojo para "Terminar" */
            color: white;
            padding: 1em 1.5em;
            border-radius: 50px; /* Botón flotante redondo */
            font-size: 1.1em;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: none; /* Oculto por defecto, se muestra al final */
        }
        #terminarAventuraBtn:hover {
            background-color: #cc0000;
        }

        /* --- NUEVOS ESTILOS PARA LOS BOTONES DESPLEGABLES --- */
        .floating-btn {
            position: fixed;
            background-color: #0077cc;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.8em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: background-color 0.3s ease;
        }
        .floating-btn:hover {
            background-color: #005699;
        }

        #leftMenuBtn {
            bottom: 20px;
            left: 20px;
        }

        #rightMenuBtn {
            bottom: 20px;
            right: 100px; /* Desplazado para no chocar con Terminar Aventura */
        }

        /* Estilos para los contenedores de menú desplegable */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6); /* Fondo semi-transparente */
            z-index: 1000;
            display: none; /* Oculto por defecto */
            justify-content: center;
            align-items: center;
        }

        .menu-container {
            background: #fff;
            padding: 1em;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90%;
            overflow: hidden; /* Para contener los iframes */
            display: flex;
            flex-direction: column;
            position: relative; /* Para posicionar la X de cierre */
        }

        /* Menú de la izquierda */
        #leftMenuContainer .menu-container {
            width: 400px; /* Ancho fijo para el menú de la izquierda */
        }

        /* Menú de la derecha */
        #rightMenuContainer .menu-container {
            width: 350px; /* Ancho fijo para el menú de la derecha */
        }

        .menu-tabs {
            display: flex;
            flex-direction: column; /* Cambiado a columna para mejor control de botones */
            gap: 0.5em;
            margin-bottom: 1em;
        }

        .menu-tab-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 0.8em 1.2em;
            border-radius: 5px;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 1.1em;
            color: #333;
        }
        .menu-tab-btn:hover {
            background-color: #e0e0e0;
        }
        .menu-tab-btn.active {
            background-color: #0077cc;
            color: white;
            border-color: #0077cc;
        }

        .tab-content {
            flex-grow: 1; /* Para que ocupe el espacio restante */
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden; /* Para el contenido del iframe */
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 200px; /* Altura mínima para el contenido */
            background-color: #f9f9f9;
        }

        .tab-content iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .tab-content .close-tab-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            color: #555;
            z-index: 1; /* Para que esté por encima del iframe */
            padding: 0.2em 0.5em;
        }
        .tab-content .close-tab-btn:hover {
            color: #c00;
        }

        .en-desarrollo-message {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            background-color: #fff;
            font-size: 1.5em;
            font-style: italic; /* Oblicuas */
            color: red; /* Rojo */
            text-align: center;
        }

        /* --- NUEVO ESTILO PARA EL CONTENEDOR DE PANTALLA COMPLETA --- */
        #fullScreenIframeContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff; /* Fondo blanco para el contenido */
            z-index: 10000; /* Asegura que esté por encima de todo */
            display: none; /* Oculto por defecto */
            flex-direction: column; /* Para organizar el botón de cerrar y el iframe */
            box-sizing: border-box; /* Incluir padding en el tamaño */
            padding-top: 50px; /* Espacio para el botón de cerrar */
        }

        #fullScreenIframeContainer iframe {
            width: 100%;
            height: 100%;
            border: none;
            flex-grow: 1; /* Ocupa el espacio restante */
        }

        #fullScreenCloseBtn {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5); /* Botón más discreto */
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10001; /* Más alto que el contenedor */
        }
        #fullScreenCloseBtn:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        /* Media Queries para pantallas más pequeñas */
        @media (max-width: 800px) and (orientation: landscape) {
            h2 {
                display: none;
            }
            body {
                margin: 0.5em;
            }
            #reto-container {
                min-height: auto;
                height: calc(100dvh - 80px);
                padding: 0;
                margin-bottom: 0.5em;
            }
            #reto-iframe,
            #puzzleIframe {
                height: 100%;
                max-width: 100%;
            }
            button.btn-padre {
                font-size: 1em;
                padding: 0.5em 1em;
            }
            .audio-player-container,
            #gpsDebugControls {
                max-width: 100%;
            }
            /* Ajustar tamaño de menús en landscape */
            #leftMenuContainer .menu-container,
            #rightMenuContainer .menu-container {
                width: 95%; /* Ocupar casi todo el ancho */
                max-height: 95%;
            }
        }

        @media (max-width: 600px) and (orientation: portrait) {
            #reto-iframe,
            #puzzleIframe {
                height: 400px;
            }
            #reto-container {
                min-height: 400px;
            }
            /* Ajustar tamaño de menús en portrait */
            #leftMenuContainer .menu-container,
            #rightMenuContainer .menu-container {
                width: 95%; /* Ocupar casi todo el ancho */
                max-height: 95%;
            }
            .floating-btn {
                width: 50px;
                height: 50px;
                font-size: 1.5em;
            }
            /* Ajustar posición del botón derecho más a la derecha */
            #rightMenuBtn {
                right: 20px; /* Más pegado al borde derecho */
            }
        }
    </style>
</head>
<body>
    <div id="welcomeOverlay">
        <div id="welcomeBox">
            <h1>¡Bienvenido a tu Aventura en Valencia!</h1>
            <p>
                Para disfrutar de esta experiencia, necesitamos acceder a algunas funciones de tu dispositivo.
                Por favor, acepta los permisos de <strong>ubicación (GPS)</strong> y permite la reproducción de <strong>audio</strong>.
                Esto nos permitirá guiarte por los puntos de interés y activar los retos y narraciones en el momento justo.
            </p>
            <button id="acceptPermissionsBtn">Aceptar y Empezar Aventura</button>
        </div>
    </div>

    <h2>Aventura 1: Descubre Valencia</h2>

    <div id="reto-container">
        <iframe id="reto-iframe" src="retos_con_puzzles_Av1_es.html?modo=principal"></iframe>
        <iframe id="puzzleIframe" src=""></iframe>
        <div id="loading-message" style="text-align: center; padding: 2em; font-size: 1.2em; display: none;">
            Cargando...
        </div>
    </div>

    <div class="audio-player-container" id="audioPlayerWrapper" style="display: none;">
        <h3>Audio del Punto <span id="currentAudioPoint"></span></h3>
        <iframe id="audioIframe" src="audio_player_hijo.html" style="width: 100%; height: 120px; border: none; display: none;"></iframe>
        <p id="locationStatus" style="color: red; font-weight: bold;">Esperando ubicación...</p>
    </div>

    <div id="button-container-padre">
        <button id="btnNextAfterReto" class="btn-padre">Continuar con la Aventura</button>
    </div>

    <div id="gpsDebugControls">
        <h4>Modo de Prueba GPS (Solo para desarrollo)</h4>
        <button id="toggleGpsMode">Activar/Desactivar GPS Real</button>
        <p>Estado GPS: <span id="gpsModeStatus">Real (intentando obtener)</span></p>
        <button id="simulateProximityBtn" disabled>Simular Proximidad</button>
    </div>

    <button id="leftMenuBtn" class="floating-btn"><i class="fas fa-bars"></i></button>
    <button id="rightMenuBtn" class="floating-btn"><i class="fas fa-ellipsis-v"></i></button>
    <button id="terminarAventuraBtn">Terminar Aventura</button>

    <div id="leftMenuContainer" class="menu-overlay">
        <div class="menu-container">
            <button class="close-tab-btn" onclick="hideLeftMenu()">&times;</button>
            <h3>Menú de Aventura</h3>
            <div class="menu-tabs">
                <button class="menu-tab-btn active" data-tab-target="retosPuzzlesTab">Retos y Puzzles</button>
                <button class="menu-tab-btn" data-tab-target="gastronomiaTab">Gastronomía</button>
                <button class="menu-tab-btn" data-tab-target="paginasOficialesTab">Páginas Oficiales</button>
                <button class="menu-tab-btn" data-tab-target="videosHistoricosTab">Videos Históricos</button>
            </div>
            <div id="retosPuzzlesTab" class="tab-content">
                <div class="en-desarrollo-message">Contenido de Retos y Puzzles en desarrollo...</div>
            </div>
            <div id="gastronomiaTab" class="tab-content" style="display:none;">
                <div class="en-desarrollo-message">Contenido de Gastronomía en desarrollo...</div>
            </div>
            <div id="paginasOficialesTab" class="tab-content" style="display:none;">
                <div class="en-desarrollo-message">Aquí encontrarás enlaces a páginas web oficiales relevantes de Valencia.</div>
            </div>
            <div id="videosHistoricosTab" class="tab-content" style="display:none;">
                <div class="en-desarrollo-message">Accede a una colección de videos históricos sobre Valencia.</div>
            </div>
        </div>
    </div>

    <div id="rightMenuContainer" class="menu-overlay">
        <div class="menu-container">
            <button class="close-tab-btn" onclick="hideRightMenu()">&times;</button>
            <h3>Información Adicional</h3>
            <div class="menu-tabs">
                <button class="menu-tab-btn active" data-tab-target="agradecimientosTab">Agradecimientos</button>
                <button class="menu-tab-btn" data-tab-target="fuentesInfoTab">Fuentes de Información</button>
                <button class="menu-tab-btn" data-tab-target="consejosSeguridadTab">Consejos y Seguridad Vial</button>
            </div>
            <div id="agradecimientosTab" class="tab-content">
                <div class="en-desarrollo-message">Agradecemos a todos los colaboradores y entidades que hicieron posible esta aventura.</div>
            </div>
            <div id="fuentesInfoTab" class="tab-content" style="display:none;">
                <div class="en-desarrollo-message">Aquí se detallarán las fuentes de información utilizadas para los contenidos de la aventura.</div>
            </div>
            <div id="consejosSeguridadTab" class="tab-content" style="display:none;">
                <div class="en-desarrollo-message">Consejos importantes para tu seguridad y la de los demás durante la aventura, incluyendo normas de tráfico.</div>
            </div>
        </div>
    </div>

    <div id="fullScreenIframeContainer">
        <button id="fullScreenCloseBtn"><i class="fas fa-times"></i></button>
        <iframe id="fullScreenIframe" src=""></iframe>
    </div>

    <script>
        // Variables globales
        let initialAudioPoint = 0; // El primer punto de audio/reto a cargar
        let gpsRealActivado = true; // Por defecto, intentar usar GPS real
        let currentStep = 0; // Controla el paso actual de la aventura

        // Definición de los puntos de interés de la aventura
        const audioPuntosInteres = [
            { id: 1, lat: 39.475962, lon: -0.375253, audio: 'audio/01_intro.mp3', distanciaActivacion: 50 }, // Plaza de la Virgen
            { id: 2, lat: 39.476483, lon: -0.376175, audio: 'audio/02_catedral.mp3', distanciaActivacion: 30 }, // Catedral de Valencia
            { id: 3, lat: 39.476602, lon: -0.377610, audio: 'audio/03_mercado.mp3', distanciaActivacion: 40 }, // Mercado Central
            // Añade más puntos aquí
        ];

        // Mapeo de puntos de interés a puzzles/retos
        // Cada clave es el id del punto de interes, y el valor es un array de objetos de reto
        // { tipo: 'reto'|'puzzle', src: 'url_del_iframe', activacion: 'auto'|'manual' }
        const puzzlesPorPunto = {
            1: [ // Punto 1: Plaza de la Virgen
                { tipo: 'reto', src: 'retos_con_puzzles_Av1_es.html?modo=pregunta1', activacion: 'manual' },
                { tipo: 'puzzle', src: 'puzzle_jigsaw.html', activacion: 'manual' } // Ejemplo de un puzzle
            ],
            2: [ // Punto 2: Catedral
                { tipo: 'reto', src: 'retos_con_puzzles_Av1_es.html?modo=pregunta2', activacion: 'manual' }
            ],
            // Puedes añadir más puntos y sus retos/puzzles aquí
        };

        // Referencias a elementos del DOM
        const retoContainer = document.getElementById('reto-container');
        const retoIframe = document.getElementById('reto-iframe');
        const puzzleIframe = document.getElementById('puzzleIframe');
        const btnNextAfterReto = document.getElementById('btnNextAfterReto');
        const playPauseBtn = document.getElementById('playPauseBtn');

        // Referencias de la pantalla de bienvenida
        const welcomeOverlay = document.getElementById('welcomeOverlay');
        const acceptPermissionsBtn = document.getElementById('acceptPermissionsBtn');

        // Referencias para el estado del GPS y depuración
        const gpsModeStatusSpan = document.getElementById('gpsModeStatus');
        const locationStatusSpan = document.getElementById('locationStatus');
        const toggleGpsModeBtn = document.getElementById('toggleGpsMode');
        const simulateProximityBtn = document.getElementById('simulateProximityBtn');
        let watchId; // Para almacenar el ID del watcher de geolocalización

        // Referencia al ID del punto de audio actual
        const currentAudioPointSpan = document.getElementById('currentAudioPoint');

        // Referencias de los botones flotantes y menús
        const leftMenuBtn = document.getElementById('leftMenuBtn');
        const rightMenuBtn = document.getElementById('rightMenuBtn');
        const terminarAventuraBtn = document.getElementById('terminarAventuraBtn');

        const leftMenuContainer = document.getElementById('leftMenuContainer');
        const rightMenuContainer = document.getElementById('rightMenuContainer');

        // Referencias para el iframe en pantalla completa
        const fullScreenIframeContainer = document.getElementById('fullScreenIframeContainer');
        const fullScreenIframe = document.getElementById('fullScreenIframe');
        const fullScreenCloseBtn = document.getElementById('fullScreenCloseBtn');

        // Referencia al iframe del reproductor de audio hijo
        const audioIframe = document.getElementById('audioIframe');

        // --- Funciones de Geolocalización y Proximidad ---

        // Función para solicitar permisos de geolocalización
        function requestGeolocationPermission() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log("Permiso de geolocalización concedido.");
                        // No se hace nada más aquí, startGeolocation se llama al aceptar
                    },
                    (error) => {
                        console.warn(`Error de geolocalización inicial: ${error.message}`);
                        if (error.code === error.PERMISSION_DENIED) {
                            alert("Permiso de ubicación denegado. La aventura funcionará en modo manual.");
                            gpsRealActivado = false;
                            gpsModeStatusSpan.textContent = "GPS Desactivado (Permiso denegado)";
                            locationStatusSpan.textContent = "GPS Desactivado (Permiso denegado).";
                            locationStatusSpan.style.color = '#dc3545'; // Rojo
                            simulateProximityBtn.disabled = false; // Habilitar simulación
                        }
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                alert("Tu navegador no soporta geolocalización. La aventura funcionará en modo manual.");
                gpsRealActivado = false;
                gpsModeStatusSpan.textContent = "GPS Desactivado (No soportado)";
                locationStatusSpan.textContent = "GPS Desactivado (No soportado).";
                locationStatusSpan.style.color = '#dc3545'; // Rojo
                simulateProximityBtn.disabled = false; // Habilitar simulación
            }
        }

        function startGeolocation() {
            if (gpsRealActivado && "geolocation" in navigator) {
                gpsModeStatusSpan.textContent = "Real (obteniendo ubicación...)";
                locationStatusSpan.textContent = "Buscando tu ubicación...";
                locationStatusSpan.style.color = '#ffc107'; // Amarillo
                watchId = navigator.geolocation.watchPosition(
                    handlePosition,
                    handleGeolocationError,
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
                console.log("Iniciando seguimiento de geolocalización.");
            } else {
                console.log("Geolocalización real desactivada o no soportada.");
                gpsModeStatusSpan.textContent = "GPS Desactivado (Modo Manual/Simulado)";
                locationStatusSpan.textContent = "GPS Desactivado.";
                locationStatusSpan.style.color = '#6c757d'; // Gris
                simulateProximityBtn.disabled = false; // Habilitar simulación en modo manual
            }
        }

        function stopGeolocation() {
            if (watchId !== undefined) {
                navigator.geolocation.clearWatch(watchId);
                watchId = undefined;
                console.log("Seguimiento de geolocalización detenido.");
            }
        }

        function updateLocationStatus(message, color = '#333') {
            locationStatusSpan.textContent = message;
            locationStatusSpan.style.color = color;
        }

        function handlePosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            console.log(`Ubicación: ${lat}, ${lon} (precisión: ${accuracy}m)`);
            updateLocationStatus(`Ubicación: ${lat.toFixed(6)}, ${lon.toFixed(6)} (±${accuracy.toFixed(0)}m)`, '#28a745'); // Verde

            // Verificar proximidad solo si no hay un reto/puzzle activo
            // y si el botón de "Continuar Aventura" no está visible (indicando que un reto ha terminado)
            if (!retoIframe.style.display && !puzzleIframe.style.display && btnNextAfterReto.style.display === 'none') {
                verificarProximidad(lat, lon);
            }
        }

        function handleGeolocationError(error) {
            console.error(`Error de geolocalización: ${error.message} (Código: ${error.code})`);
            let errorMessage = "Error al obtener ubicación.";
            let errorColor = '#dc3545'; // Rojo

            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "Permiso de ubicación denegado.";
                    gpsRealActivado = false; // Desactivar GPS real si se deniega el permiso
                    simulateProximityBtn.disabled = false; // Habilitar simulación
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "Ubicación no disponible.";
                    break;
                case error.TIMEOUT:
                    errorMessage = "Tiempo de espera agotado.";
                    break;
                default:
                    errorMessage = "Error desconocido de ubicación.";
                    break;
            }
            updateLocationStatus(errorMessage, errorColor);
            gpsModeStatusSpan.textContent = "GPS Desactivado (Error)";
        }

        // Función para calcular distancia entre dos puntos (fórmula de Haversine)
        function distanciaHaversine(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const φ1 = lat1 * Math.PI / 180; // φ, λ en radianes
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const d = R * c; // Distancia en metros
            return d;
        }

        function verificarProximidad(lat, lon) {
            if (currentStep < audioPuntosInteres.length) {
                const puntoActual = audioPuntosInteres[currentStep];
                const distancia = distanciaHaversine(lat, lon, puntoActual.lat, puntoActual.lon);
                console.log(`Distancia al punto ${puntoActual.id}: ${distancia.toFixed(2)}m`);
                updateLocationStatus(`Distancia al punto ${puntoActual.id}: ${distancia.toFixed(0)}m`, '#0077cc'); // Azul

                if (distancia < puntoActual.distanciaActivacion) {
                    if (!audioIframe.style.display) { // Solo si el audio no está activo
                        console.log(`¡Cerca del punto ${puntoActual.id}! Activando audio.`);
                        // Enviar mensaje al iframe del audio para que reproduzca
                        sendMessageToAudioChild('playAudio', { src: puntoActual.audio });
                        audioIframe.style.display = 'block';
                        document.getElementById('audioPlayerWrapper').style.display = 'flex';
                        currentAudioPointSpan.textContent = puntoActual.id;
                        playPauseBtn.classList.add('active'); // Indicar que el botón de audio está activo
                    }
                    // Si hay un reto o puzzle automático asociado a este punto, activarlo
                    const retosDelPunto = puzzlesPorPunto[puntoActual.id] || [];
                    const autoReto = retosDelPunto.find(r => r.activacion === 'auto');
                    if (autoReto && !retoIframe.style.display && !puzzleIframe.style.display) {
                        console.log(`Activando reto automático para el punto ${puntoActual.id}: ${autoReto.src}`);
                        if (autoReto.tipo === 'reto') {
                            cargarReto(autoReto.src);
                        } else if (autoReto.tipo === 'puzzle') {
                            mostrarPuzzle(autoReto.src);
                        }
                    }
                } else {
                    // Si nos alejamos del punto, pausar el audio
                    if (audioIframe.style.display) {
                        sendMessageToAudioChild('pauseAudio');
                        playPauseBtn.classList.remove('active');
                    }
                }
            } else {
                updateLocationStatus("Aventura completada o puntos agotados.", '#28a745');
                terminarAventuraBtn.style.display = 'block'; // Mostrar botón de terminar al final
            }
        }

        // --- Funciones de Control de la Aventura (Pasos, Retos, Puzzles) ---

        function cargarSiguientePaso() {
            ocultarRetoYPuzzle(); // Ocultar cualquier reto/puzzle anterior
            btnNextAfterReto.style.display = 'none'; // Ocultar botón de "Continuar Aventura"

            if (currentStep < audioPuntosInteres.length) {
                const puntoActual = audioPuntosInteres[currentStep];
                console.log(`Cargando paso ${currentStep + 1}: Punto ${puntoActual.id}`);
                currentAudioPointSpan.textContent = puntoActual.id;
                document.getElementById('audioPlayerWrapper').style.display = 'flex'; // Asegurarse de que el reproductor de audio esté visible

                // Iniciar la geolocalización si estamos en modo real
                if (gpsRealActivado) {
                    startGeolocation();
                } else {
                    // En modo manual, habilitar simulación si no está activo el GPS real
                    simulateProximityBtn.disabled = false;
                    // También, si no hay GPS real, el botón de play/pause se activa manualmente
                    playPauseBtn.classList.add('active'); // Asumimos que el usuario controlará el audio manualmente
                    sendMessageToAudioChild('loadAudio', { src: puntoActual.audio }); // Cargar el audio para reproducción manual
                }

                // Ocultar mensaje de carga
                document.getElementById('loading-message').style.display = 'none';

                // Si hay retos asociados al punto, prepararlos para ser mostrados (manualmente o automáticamente)
                const retosDelPunto = puzzlesPorPunto[puntoActual.id] || [];
                const tieneRetoManual = retosDelPPunto.some(r => r.activacion === 'manual');
                const tieneRetoAuto = retosDelPunto.some(r => r.activacion === 'auto');

                // Si no hay retos automáticos, o solo hay retos manuales, no se muestra nada hasta que el usuario actúe (ej. por proximidad manual)
                if (!tieneRetoAuto && !audioIframe.style.display && !gpsRealActivado) {
                    retoContainer.classList.add('no-reto'); // Ocultar borde si no hay reto activo
                } else {
                    // Si hay retos, el borde puede estar en estado "ready"
                    reiniciarEstadoReto(); // Poner el borde en color azul por defecto
                }

            } else {
                console.log("¡Aventura completada!");
                updateLocationStatus("¡Felicidades, la aventura ha terminado!", '#28a745');
                document.getElementById('audioPlayerWrapper').style.display = 'none';
                retoIframe.style.display = 'none';
                puzzleIframe.style.display = 'none';
                retoContainer.classList.add('no-reto');
                stopGeolocation(); // Detener el seguimiento del GPS al finalizar
                terminarAventuraBtn.style.display = 'block'; // Mostrar botón de terminar
            }
        }

        // Carga un reto en el iframe principal
        function cargarReto(url) {
            retoIframe.src = url;
            retoIframe.style.display = 'block';
            puzzleIframe.style.display = 'none'; // Asegurarse de que el puzzle esté oculto
            btnNextAfterReto.style.display = 'none'; // Ocultar el botón de continuar mientras el reto está activo
            retoContainer.classList.add('ready'); // Borde azul para "en espera"
            console.log("Reto cargado:", url);
        }

        // Muestra un puzzle en el iframe secundario
        function mostrarPuzzle(url) {
            puzzleIframe.src = url;
            puzzleIframe.style.display = 'block';
            retoIframe.style.display = 'none'; // Asegurarse de que el reto esté oculto
            btnNextAfterReto.style.display = 'none';
            retoContainer.classList.add('ready'); // Borde azul para "en espera"
            console.log("Puzzle cargado:", url);
        }

        // Oculta ambos iframes de reto/puzzle
        function ocultarRetoYPuzzle() {
            retoIframe.style.display = 'none';
            puzzleIframe.style.display = 'none';
            retoIframe.src = 'about:blank'; // Limpiar el contenido del iframe
            puzzleIframe.src = 'about:blank';
            retoContainer.classList.remove('correct', 'incorrect', 'ready', 'revealed');
            retoContainer.classList.add('no-reto'); // Borde transparente cuando no hay nada
        }

        // Reinicia el estado visual del contenedor del reto
        function reiniciarEstadoReto() {
            retoContainer.classList.remove('correct', 'incorrect', 'revealed', 'no-reto');
            retoContainer.classList.add('ready'); // Por defecto, el borde es azul cuando hay un reto
        }

        // --- Funciones para Menús y Pantalla Completa ---

        function showFullScreenIframe(url) {
            fullScreenIframe.src = url;
            fullScreenIframeContainer.style.display = 'flex';
        }

        function hideFullScreenIframe() {
            fullScreenIframe.src = ''; // Limpiar el contenido
            fullScreenIframeContainer.style.display = 'none';
        }

        function showLeftMenu() {
            leftMenuContainer.style.display = 'flex';
            // Activar la primera pestaña por defecto si no hay ninguna activa
            const firstTabBtn = leftMenuContainer.querySelector('.menu-tab-btn');
            if (firstTabBtn && !firstTabBtn.classList.contains('active')) {
                firstTabBtn.click(); // Simular clic en la primera pestaña
            }
        }

        function hideLeftMenu() {
            leftMenuContainer.style.display = 'none';
        }

        function showRightMenu() {
            rightMenuContainer.style.display = 'flex';
            // Activar la primera pestaña por defecto si no hay ninguna activa
            const firstTabBtn = rightMenuContainer.querySelector('.menu-tab-btn');
            if (firstTabBtn && !firstTabBtn.classList.contains('active')) {
                firstTabBtn.click(); // Simular clic en la primera pestaña
            }
        }

        function hideRightMenu() {
            rightMenuContainer.style.display = 'none';
        }

        // Función para abrir pestañas del MENÚ IZQUIERDO
        function openLeftMenuTab(tabName) {
            const menuContainer = document.getElementById('leftMenuContainer');
            const tabContents = menuContainer.querySelectorAll('.tab-content');
            tabContents.forEach(content => { content.style.display = 'none'; });

            const tabButtons = menuContainer.querySelectorAll('.menu-tab-btn');
            tabButtons.forEach(btn => { btn.classList.remove('active'); });

            const targetTabContent = document.getElementById(tabName);
            if (targetTabContent) {
                targetTabContent.style.display = 'flex'; // Usar flex para centrar mensaje "en desarrollo"
                const messageDiv = targetTabContent.querySelector('.en-desarrollo-message');
                if (messageDiv) messageDiv.style.display = 'flex'; // Asegurar que el mensaje se muestre
                // Por ahora, estas pestañas no cargan iframes específicos, solo el mensaje.
            }

            const targetTabButton = menuContainer.querySelector(`.menu-tab-btn[data-tab-target="${tabName}"]`);
            if (targetTabButton) {
                targetTabButton.classList.add('active');
            }
        }

        // Función para abrir pestañas del MENÚ DERECHO
        function openRightMenuTab(tabName) {
            const menuContainer = document.getElementById('rightMenuContainer');
            const tabContents = menuContainer.querySelectorAll('.tab-content');
            tabContents.forEach(content => { content.style.display = 'none'; });

            const tabButtons = menuContainer.querySelectorAll('.menu-tab-btn');
            tabButtons.forEach(btn => { btn.classList.remove('active'); });

            const targetTabContent = document.getElementById(tabName);
            if (targetTabContent) {
                targetTabContent.style.display = 'flex'; // Usar flex para centrar mensaje "en desarrollo"
                const messageDiv = targetTabContent.querySelector('.en-desarrollo-message');
                if (messageDiv) messageDiv.style.display = 'flex'; // Asegurar que el mensaje se muestre
                // Por ahora, estas pestañas tampoco cargan iframes específicos, solo el mensaje.
            }

            const targetTabButton = menuContainer.querySelector(`.menu-tab-btn[data-tab-target="${tabName}"]`);
            if (targetTabButton) {
                targetTabButton.classList.add('active');
            }
        }


        // --- Comunicación entre Padre e Hijo (iframes) ---

        // Función para enviar mensajes al iframe del reproductor de audio
        function sendMessageToAudioChild(type, data = {}) {
            if (audioIframe.contentWindow) {
                audioIframe.contentWindow.postMessage({ type, ...data }, '*');
            }
        }

        // Manejar mensajes recibidos de los iframes hijos
        window.addEventListener('message', (event) => {
            // Asegúrate de verificar el origin en un entorno de producción
            // if (event.origin !== "http://tu-dominio.com") return;

            const message = event.data;
            console.log("Mensaje recibido del hijo:", message);

            switch (message.type) {
                case 'retoCompletado':
                    // Recibe un mensaje de 'retos_con_puzzles_Av1_es.html'
                    console.log(`Reto completado con resultado: ${message.correct ? 'Correcto' : 'Incorrecto'}`);
                    if (message.correct) {
                        retoContainer.classList.add('correct');
                        alert("¡Respuesta correcta! Puedes continuar con la aventura.");
                    } else {
                        retoContainer.classList.add('incorrect');
                        alert("Respuesta incorrecta. Inténtalo de nuevo o avanza.");
                    }
                    btnNextAfterReto.style.display = 'block'; // Mostrar el botón para continuar
                    break;
                case 'puzzleCompletado':
                    console.log("Puzzle completado.");
                    retoContainer.classList.add('correct'); // O verde para puzzle completado
                    alert("¡Puzzle resuelto! Puedes continuar con la aventura.");
                    btnNextAfterReto.style.display = 'block';
                    break;
                case 'audioEnded':
                    console.log("Reproducción de audio finalizada.");
                    playPauseBtn.classList.remove('active'); // Desactivar el botón de play/pause
                    // Aquí podrías decidir si avanzas automáticamente al siguiente paso
                    // o esperas a la acción del usuario/proximidad
                    break;
                case 'audioReady':
                    console.log("Audio player hijo listo.");
                    // Cargar el primer audio si el GPS real está desactivado
                    if (!gpsRealActivado && currentStep < audioPuntosInteres.length) {
                        sendMessageToAudioChild('loadAudio', { src: audioPuntosInteres[currentStep].audio });
                        playPauseBtn.classList.add('active'); // Activar visualmente para reproducción manual
                    }
                    break;
                case 'audioTogglePlayPause':
                    // Este mensaje no debería ser necesario si el padre controla el audio
                    // pero si el hijo tiene su propio botón de play/pause, podría enviarlo
                    console.log("Audio toggled by child.");
                    break;
                case 'abrirFullscreen':
                    // Mensaje para abrir un iframe en pantalla completa
                    if (message.url) {
                        showFullScreenIframe(message.url);
                    }
                    break;
                case 'actualizarAudioControles':
                    // El hijo puede enviar información sobre el estado de su reproductor
                    // Puedes usar esto para actualizar la UI del padre si fuera necesario
                    break;
            }
        });

        // --- Event Listeners ---

        // Evento para aceptar permisos y comenzar la aventura
        acceptPermissionsBtn.addEventListener('click', () => {
            console.log("¡Botón 'Aceptar y Empezar' clickeado!"); // Mensaje de depuración
            welcomeOverlay.style.display = 'none'; // Oculta la pantalla de bienvenida
            if (gpsRealActivado) {
                // Si el GPS real está activo, pedirá permiso y luego iniciará la geolocalización
                startGeolocation();
            } else {
                // Si el GPS real está desactivado (por defecto o por denegación previa)
                gpsModeStatusSpan.textContent = "GPS Desactivado (Modo Manual/Simulado)";
                locationStatusSpan.textContent = "GPS Desactivado.";
                locationStatusSpan.style.color = '#6c757d'; // Gris
                simulateProximityBtn.disabled = false; // Habilitar simulación
            }
            cargarSiguientePaso(); // Iniciar la aventura (cargar el primer audio/reto)
        });

        // Evento para el botón "Continuar con la Aventura"
        btnNextAfterReto.addEventListener('click', () => {
            currentStep++; // Avanzar al siguiente paso de la aventura
            cargarSiguientePaso();
            // Asegurarse de que el audio se detenga si se estaba reproduciendo
            sendMessageToAudioChild('pauseAudio');
            playPauseBtn.classList.remove('active');
        });

        // Toggle GPS real / simulación
        toggleGpsModeBtn.addEventListener('click', () => {
            gpsRealActivado = !gpsRealActivado;
            if (gpsRealActivado) {
                stopGeolocation(); // Detener si estaba simulando
                requestGeolocationPermission(); // Solicitar permiso y luego iniciar real
            } else {
                stopGeolocation(); // Detener el GPS real
                gpsModeStatusSpan.textContent = "GPS Desactivado (Modo Manual/Simulado)";
                locationStatusSpan.textContent = "GPS Desactivado.";
                locationStatusSpan.style.color = '#6c757d';
            }
            simulateProximityBtn.disabled = gpsRealActivado; // Habilitar/deshabilitar botón de simulación
            console.log(`Modo GPS: ${gpsRealActivado ? 'Real' : 'Manual/Simulado'}`);
            // Recargar el paso actual para aplicar el nuevo modo GPS
            cargarSiguientePaso();
        });

        // Simular proximidad al siguiente punto (solo para depuración)
        simulateProximityBtn.addEventListener('click', () => {
            if (currentStep < audioPuntosInteres.length && !gpsRealActivado) {
                const puntoSimulado = audioPuntosInteres[currentStep];
                // Simular estar justo en el punto de activación
                verificarProximidad(puntoSimulado.lat, puntoSimulado.lon);

                // Si hay un reto o puzzle manual para este punto, mostrarlo también
                const retosDelPunto = puzzlesPorPunto[puntoSimulado.id] || [];
                const retoManual = retosDelPunto.find(r => r.activacion === 'manual');
                if (retoManual && !retoIframe.style.display && !puzzleIframe.style.display) {
                    console.log(`Activando reto manual simulado para el punto ${puntoSimulado.id}: ${retoManual.src}`);
                    if (retoManual.tipo === 'reto') {
                        cargarReto(retoManual.src);
                    } else if (retoManual.tipo === 'puzzle') {
                        mostrarPuzzle(retoManual.src);
                    }
                }
            } else if (gpsRealActivado) {
                alert("La simulación de proximidad solo funciona con el GPS Real Desactivado.");
            } else {
                alert("No hay más puntos para simular o la aventura ha terminado.");
            }
        });

        // Manejar click del botón de Terminar Aventura
        terminarAventuraBtn.addEventListener('click', () => {
            if (confirm("¿Estás seguro de que quieres terminar la aventura?")) {
                alert("¡Gracias por jugar! Aventura finalizada.");
                window.location.reload(); // Recargar la página para reiniciar
            }
        });

        // Event listeners para los botones flotantes
        leftMenuBtn.addEventListener('click', showLeftMenu);
        rightMenuBtn.addEventListener('click', showRightMenu);
        fullScreenCloseBtn.addEventListener('click', hideFullScreenIframe);

        // Event listeners para las pestañas del menú izquierdo
        leftMenuContainer.querySelectorAll('.menu-tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const tabTarget = button.dataset.tabTarget;
                openLeftMenuTab(tabTarget);
            });
        });

        // Event listeners para las pestañas del menú derecho
        rightMenuContainer.querySelectorAll('.menu-tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const tabTarget = button.dataset.tabTarget;
                openRightMenuTab(tabTarget);
            });
        });

        // Función para el botón de play/pause del audio (en el padre)
        playPauseBtn.addEventListener('click', () => {
            if (!gpsRealActivado) { // Solo si el GPS real está desactivado
                if (playPauseBtn.classList.contains('active')) {
                    sendMessageToAudioChild('pauseAudio');
                    playPauseBtn.classList.remove('active');
                } else {
                    sendMessageToAudioChild('playAudio', { src: audioPuntosInteres[currentStep].audio });
                    playPauseBtn.classList.add('active');
                }
            } else {
                alert("El control de audio manual está deshabilitado con el GPS real activo. El audio se reproducirá por proximidad.");
            }
        });

        // --- Inicialización de la Página ---

        function initPage() {
            // Cargar el primer paso (esto mostrará la pantalla de bienvenida o intentará GPS)
            console.log("Página inicializada.");
            requestGeolocationPermission(); // Solicitar permisos al cargar
        }

        // Mostrar la pantalla de bienvenida al cargar la ventana
        window.addEventListener('load', () => {
            welcomeOverlay.style.display = 'flex';
            // También asegura que el iframe de audio esté cargado para poder enviar mensajes
            audioIframe.style.display = 'block'; // Mostrar temporalmente para que se cargue, luego se oculta si no hay audio
            audioIframe.src = "audio_player_hijo.html"; // Asegúrate de que el src esté siempre cargado
            audioIframe.style.display = 'none'; // Ocultar después de cargarse
        });

        // Llamar a la función de inicialización cuando el DOM esté completamente cargado
        document.addEventListener('DOMContentLoaded', initPage);

    </script>
</body>
</html>
