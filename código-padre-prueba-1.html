<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mapa Aventura - Padre</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #map { height: 400px; }
    #reto { margin: 20px; padding: 15px; border: 1px solid #ccc; max-width: 600px; }
    #iconosPuzzle {
      display: flex; gap: 10px; margin: 20px;
    }
    .iconoPuzzle {
      width: 50px; height: 50px; background: red; border-radius: 8px; display: flex;
      align-items: center; justify-content: center; color: white; cursor: default;
      user-select: none; font-weight: bold;
    }
    .btn {
      margin-top: 10px; padding: 8px 16px; font-size: 1em; cursor: pointer;
    }
    #audioControl {
      margin: 20px;
    }
    #audioPlayBtn {
      background-color: red; color: white; border: none; padding: 10px 20px;
      font-size: 1em; cursor: pointer; border-radius: 5px;
    }
    #audioPlayBtn.active {
      background-color: green;
    }
  </style>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />
</head>
<body>

  <h1>Mapa Aventura - Padre</h1>

  <div id="map"></div>

  <div id="audioControl">
    <button id="audioPlayBtn" disabled>Reproducir Audio</button>
  </div>

  <div id="iconosPuzzle">
    <div class="iconoPuzzle" id="iconoPuzzle2">P2</div>
    <div class="iconoPuzzle" id="iconoPuzzle3">P3</div>
  </div>

  <div id="reto"></div>

  <iframe id="iframeHijo" src="hijo.html" style="width:100%; height:300px; border:none;"></iframe>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // --- Variables globales ---
    const mapa = L.map('map').setView([39.4754, -0.3763], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(mapa);

    const iframeHijo = document.getElementById('iframeHijo');

    const paradaData = {
      torres_serranos: {
        coords: [39.4754, -0.3763],
        audio: 'Av1_audio_esp/02 Intro ESPAÑOL 2.mp3',
        preguntaId: 2
      },
      plaza_de_la_crida: {
        coords: [39.4758, -0.3767],
        audio: 'Av1_audio_esp/03 Av1 Pista 3 ESPAÑOL.mp3',
        preguntaId: 3
      }
    };

    let markerActual = null;
    let indiceReto = -1;
    let audioActivo = null;
    let paradaActual = null;

    const audioPlayBtn = document.getElementById('audioPlayBtn');

    // --- Funciones ---

    function mostrarMarcador(coords) {
      if (markerActual) {
        mapa.removeLayer(markerActual);
      }
      markerActual = L.marker(coords, {
        icon: L.icon({
          iconUrl: 'icono_parada.png',
          iconSize: [32, 32]
        })
      }).addTo(mapa);
      mapa.setView(coords, 17);
    }

    function onParadaSeleccionada(paradaId) {
      const data = paradaData[paradaId];
      if (!data) {
        console.error('Parada no encontrada:', paradaId);
        return;
      }
      paradaActual = paradaId;
      mostrarMarcador(data.coords);

      // Enviar orden al hijo para activar audio y UI
      iframeHijo.contentWindow.postMessage({
        type: 'play-audio',
        audioSrc: data.audio,
        preguntaId: data.preguntaId,
        paradaId: paradaId
      }, '*');

      // Configurar botón de audio
      configurarAudio(data.audio);
    }

    function configurarAudio(src) {
      if (audioActivo) {
        audioActivo.pause();
        audioActivo = null;
      }

      audioActivo = new Audio(src);

      audioPlayBtn.disabled = false;
      audioPlayBtn.classList.remove('active');
      audioPlayBtn.textContent = "Reproducir Audio";

      audioPlayBtn.onclick = () => {
        if (audioActivo.paused) {
          audioActivo.play();
          audioPlayBtn.classList.add('active');
          audioPlayBtn.textContent = "Reproduciendo...";
        } else {
          audioActivo.pause();
          audioPlayBtn.classList.remove('active');
          audioPlayBtn.textContent = "Reproducir Audio";
        }
      };

      audioActivo.onended = () => {
        audioPlayBtn.classList.remove('active');
        audioPlayBtn.textContent = "Audio finalizado";
        audioPlayBtn.disabled = true;

        // Cambiar icono puzzle a verde y avisar retos
        const data = paradaData[paradaActual];
        activarIconoPuzzleEnPadre(data.preguntaId);
        ejecutarPregunta(data.preguntaId);
      };
    }

    function activarIconoPuzzleEnPadre(preguntaId) {
      const icono = document.getElementById(`iconoPuzzle${preguntaId}`);
      if (icono) {
        icono.style.backgroundColor = 'green';
      }
    }

    // Código retos (simplificado)
    const retos = [
      {
        tipo: "opcion",
        pregunta: "2. ¿Qué sostiene el niño en sus manos?",
        opciones: ["Una paloma", "Una Concha", "Alimentos"],
        correctas: ["Una Concha"],
        multiple: false
      },
      {
        tipo: "opcion",
        pregunta: "3. ¿Dónde está la Plaza de la Crida?",
        opciones: ["Centro", "Norte", "Sur"],
        correctas: ["Centro"],
        multiple: false
      }
    ];

    const retoDiv = document.getElementById('reto');

    function mostrarReto() {
      retoDiv.innerHTML = "";
      if (indiceReto < 0 || indiceReto >= retos.length) return;

      const reto = retos[indiceReto];

      const h3 = document.createElement('h3');
      h3.textContent = reto.pregunta;
      retoDiv.appendChild(h3);

      reto.opciones.forEach((op, i) => {
        const div = document.createElement('div');
        const input = document.createElement('input');
        input.type = reto.multiple ? 'checkbox' : 'radio';
        input.name = 'respuesta';
        input.id = `op${i}`;
        input.value = op;

        const label = document.createElement('label');
        label.htmlFor = input.id;
        label.textContent = op;

        div.appendChild(input);
        div.appendChild(label);

        retoDiv.appendChild(div);
      });

      const btnValidar = document.createElement('button');
      btnValidar.textContent = 'Validar respuesta';
      btnValidar.className = 'btn';
      retoDiv.appendChild(btnValidar);

      btnValidar.addEventListener('click', () => {
        const seleccionados = Array.from(
          retoDiv.querySelectorAll('input[name="respuesta"]:checked')
        ).map(input => input.value);

        if (seleccionados.length === 0) {
          alert('Por favor, selecciona una opción');
          return;
        }

        const correctas = reto.correctas;
        const acertado =
          reto.multiple
            ? correctas.every(c => seleccionados.includes(c)) && seleccionados.length === correctas.length
            : correctas.includes(seleccionados[0]);

        if (acertado) {
          alert('¡Respuesta correcta!');
        } else {
          alert('Respuesta incorrecta, intenta de nuevo.');
        }
      });
    }

    function ejecutarPregunta(preguntaId) {
      indiceReto = preguntaId - 2; // Ajuste índices
      mostrarReto();
    }

    // Escuchar mensajes del iframe hijo
    window.addEventListener('message', (event) => {
      const data = event.data;
      if (!data || !data.type) return;

      if (data.type === 'parada-click') {
        onParadaSeleccionada(data.paradaId);
      }
      // Si quieres controlar que hijo avise que audio terminó, puedes hacerlo aquí (pero ya lo hace el padre con el audio nativo)
    });

  </script>
</body>
</html>
