<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aventura Urbana - Valencia</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f4f4f4;
            color: #333;
            overflow-x: hidden; /* Evita el scroll horizontal */
        }
        header {
            background-color: #333;
            color: white;
            padding: 1em 0;
            text-align: center;
            font-size: 1.5em;
        }
        .main-content {
            flex-grow: 1;
            padding: 1em;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .info-box {
            background-color: white;
            padding: 1em;
            margin-bottom: 1em;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }
        #location-info {
            font-size: 1.1em;
            color: #555;
        }
        #current-step-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #0077cc;
            margin-bottom: 0.5em;
        }
        .btn-container {
            display: flex;
            justify-content: center;
            gap: 1em;
            margin-top: 1em;
            width: 100%;
            max-width: 600px;
        }
        .btn-padre {
            padding: 0.8em 1.5em;
            font-size: 1.1em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background-color: #0077cc;
            color: white;
            transition: background-color 0.3s ease, transform 0.1s ease;
            white-space: nowrap; /* Evita que el texto se rompa */
        }
        .btn-padre:hover {
            background-color: #005699;
            transform: scale(1.02);
        }
        .btn-padre:active {
            transform: scale(0.98);
        }
        .btn-padre:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Contenedor del iframe del audio */
        #audio-player-wrapper {
            width: 100%;
            max-width: 600px;
            margin-top: 1em;
            background-color: transparent; /* Para que el fondo del iframe se vea */
            border-radius: 8px; /* Coincide con el estilo del reproductor hijo */
            overflow: hidden; /* Asegura que el contenido interno no se salga */
        }
        #audioIframe {
            width: 100%;
            height: 150px; /* Aumentado ligeramente para el botón de siguiente paso */
            border: none;
            display: block; /* Asegurarse de que esté visible */
        }

        /* Contenedor del iframe del reto/puzzle */
        #reto-player-wrapper {
            width: 100%;
            max-width: 600px;
            margin-top: 1em;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            background-color: white;
            overflow: hidden; /* Asegura que el contenido interno no se salga */
            display: none; /* Inicialmente oculto */
        }
        #retoIframe {
            width: 100%;
            height: 400px; /* Altura ajustable según el contenido del reto */
            border: none;
            display: block;
        }

        /* Estilos del cartel "EN DESARROLLO" */
        .en-desarrollo-cartel {
            position: fixed; /* O 'absolute' si está dentro de un contenedor relativo */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg); /* Centrar y poner en oblicuo */
            font-size: 2.8em; /* Tamaño de fuente más grande */
            font-weight: bold;
            color: rgba(255, 0, 0, 0.8); /* Rojo más fuerte */
            background-color: rgba(255, 255, 0, 0.6); /* Fondo amarillo semi-transparente */
            padding: 20px 40px; /* Padding más grande */
            border: 4px solid rgba(255, 0, 0, 0.8); /* Borde más grueso y rojo */
            border-radius: 12px;
            z-index: 9999; /* Asegura que esté por encima de casi todo */
            white-space: nowrap; /* Evita que el texto se rompa */
            pointer-events: none; /* Permite hacer clic a través del cartel si está fijo */
            display: block; /* Asegúrate de que esté visible por defecto */
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            header {
                font-size: 1.2em;
            }
            .info-box, .btn-container, #audio-player-wrapper, #reto-player-wrapper {
                margin-left: 0.5em;
                margin-right: 0.5em;
            }
            .btn-padre {
                font-size: 1em;
                padding: 0.6em 1em;
            }
            #audioIframe {
                height: 140px; /* Ajuste para móviles */
            }
            #retoIframe {
                height: 350px; /* Ajuste para móviles */
            }
            .en-desarrollo-cartel {
                font-size: 2em; /* Ajuste para pantallas más pequeñas */
                padding: 15px 30px;
                transform: translate(-50%, -50%) rotate(-10deg); /* Menos oblicuo en móviles */
            }
        }
    </style>
</head>
<body>
    <header>
        Aventura Urbana: Valencia
    </header>

    <div class="main-content">
        <div class="info-box">
            <p id="current-step-display">Iniciando Aventura...</p>
            <p id="location-info">Esperando ubicación GPS...</p>
        </div>

        <div id="audio-player-wrapper">
            <iframe id="audioIframe" src="Av1_audio_esp.html"></iframe>
        </div>

        <div id="reto-player-wrapper">
            <iframe id="retoIframe" src=""></iframe>
        </div>

        <div class="btn-container" id="puzzle-feedback-buttons" style="display: none;">
            <button id="btnPuzzleCorrect" class="btn-padre">¡Reto Superado!</button>
            <button id="btnPuzzleIncorrect" class="btn-padre">Intentar de Nuevo</button>
        </div>

        <div class="en-desarrollo-cartel">EN DESARROLLO</div>

    </div>

    <script>
        // Referencias a elementos del DOM
        const locationInfo = document.getElementById('location-info');
        const currentStepDisplay = document.getElementById('current-step-display');
        const audioIframe = document.getElementById('audioIframe');
        const audioPlayerWrapper = document.getElementById('audio-player-wrapper');
        const retoIframe = document.getElementById('retoIframe');
        const retoPlayerWrapper = document.getElementById('reto-player-wrapper');
        const btnPuzzleCorrect = document.getElementById('btnPuzzleCorrect');
        const btnPuzzleIncorrect = document.getElementById('btnPuzzleIncorrect');
        const puzzleFeedbackButtons = document.getElementById('puzzle-feedback-buttons');

        // Estado de la Aventura
        let currentStepIndex = 0; // Empieza en el paso 0
        let audioHijoListo = false;
        let retoHijoListo = false;
        let audioPlayerIsPlaying = false; // Estado para saber si el audio está reproduciéndose
        let currentAudioCanPlay = false; // Viene del GPS, si estamos en zona

        // Definición de los pasos de la aventura (tus 30 paradas)
        // Cada paso puede tener un audio asociado, un reto asociado, o ambos.
        const adventureSteps = [
            {
                name: "Torres de Serranos - Introducción",
                coords: { latitude: 39.47953, longitude: -0.37759 }, // Coordenadas de ejemplo
                radius: 50, // radio en metros
                audioId: "audio_serranos_intro", // Este ID DEBE COINCIDIR con el 'id' en Av1_audio_esp.html
                retoUrl: null, // No hay reto en este paso
                instruction: "Bienvenido a la aventura. Dirígete a las Torres de Serranos y escucha la introducción.",
                stepType: "audio" // Indica que este paso principalmente es de audio
            },
            {
                name: "Muro de Santa Ana",
                coords: { latitude: 39.47700, longitude: -0.37500 }, // Coordenadas de ejemplo
                radius: 30,
                audioId: "audio_muro_santa_ana",
                retoUrl: "puzzle_muro_santa_ana.html", // URL del reto para este paso
                instruction: "Ahora, busca el Muro de Santa Ana y resuelve el reto.",
                stepType: "audio-then-reto" // Primero audio, luego reto
            },
            {
                name: "Plaza de la Virgen",
                coords: { latitude: 39.47600, longitude: -0.37400 },
                radius: 30,
                audioId: "audio_plaza_virgen",
                retoUrl: "puzzle_plaza_virgen.html",
                instruction: "Dirígete a la Plaza de la Virgen y completa la siguiente prueba.",
                stepType: "audio-then-reto"
            },
            // AÑADE AQUÍ LAS 27 PARADAS RESTANTES CON SUS COORDENADAS, RADIOS, AUDIO IDs Y RETOS
            // Ejemplo de otras paradas (asegúrate de que los IDs coinciden con Av1_audio_esp.html)
            {
                name: "Catedral y Miguelete",
                coords: { latitude: 39.47500, longitude: -0.37300 },
                radius: 40,
                audioId: "audio_catedral_fachada",
                retoUrl: "puzzle_catedral.html",
                instruction: "Descubre los secretos de la Catedral y su torre.",
                stepType: "audio-then-reto"
            },
            {
                name: "Baños Árabes",
                coords: { latitude: 39.47400, longitude: -0.37200 },
                radius: 25,
                audioId: "audio_banos_arabes",
                retoUrl: null,
                instruction: "Explora los antiguos baños árabes.",
                stepType: "audio"
            },
            // ... (añade las 25 paradas restantes aquí)
            {
                name: "Última Parada de la Aventura",
                coords: { latitude: 39.46800, longitude: -0.37000 },
                radius: 50,
                audioId: "audio_lonja_seda", // O el ID del último audio
                retoUrl: "puzzle_final.html", // O un reto final
                instruction: "¡Felicidades! Has llegado al final de tu aventura. Completa el reto final.",
                stepType: "audio-then-reto"
            }
        ];

        // --- Funciones de Gestión de Pasos ---

        function updateStepDisplay() {
            const currentStep = adventureSteps[currentStepIndex];
            if (currentStep) {
                currentStepDisplay.textContent = `Paso ${currentStepIndex + 1}: ${currentStep.name}`;
                locationInfo.textContent = currentStep.instruction; // Muestra la instrucción del paso
            } else {
                currentStepDisplay.textContent = "Aventura Terminada!";
                locationInfo.textContent = "Has completado todos los desafíos. ¡Gracias por jugar!";
                hideAudioPlayer();
                hideRetoPlayer();
            }
        }

        function prepareAudioStep(audioId, canPlay) {
            showAudioPlayer();
            hideRetoPlayer();
            // Envía el mensaje al iframe hijo para cargar el audio
            if (audioHijoListo) {
                audioIframe.contentWindow.postMessage({ type: 'loadAudio', idAudio: audioId, canPlay: canPlay }, '*');
                // Si el audio puede reproducirse por proximidad, y no está ya sonando
                if (canPlay && !audioPlayerIsPlaying) {
                    audioIframe.contentWindow.postMessage({ type: 'playAudio' }, '*');
                } else if (!canPlay && audioPlayerIsPlaying) {
                    // Si pierde proximidad y el audio estaba sonando, pausarlo
                    audioIframe.contentWindow.postMessage({ type: 'pauseAudio' }, '*');
                }
                // Asegúrate de que el hijo siempre reciba el estado de 'canPlay'
                audioIframe.contentWindow.postMessage({ type: 'updateCanPlay', canPlay: canPlay }, '*');
            } else {
                console.warn("Audio iframe no está listo para recibir mensajes.");
            }
        }

        function prepareRetoStep(retoUrl) {
            hideAudioPlayer();
            showRetoPlayer();
            retoIframe.src = retoUrl; // Carga la URL del reto en el iframe
            // Ocultar botones de feedback del puzzle inicialmente
            puzzleFeedbackButtons.style.display = 'none';
        }

        function showAudioPlayer() {
            audioPlayerWrapper.style.display = 'block';
        }

        function hideAudioPlayer() {
            audioPlayerWrapper.style.display = 'none';
            // Asegurarse de detener el audio al ocultar el reproductor
            if (audioHijoListo) {
                audioIframe.contentWindow.postMessage({ type: 'stopAudio' }, '*');
            }
        }

        function showRetoPlayer() {
            retoPlayerWrapper.style.display = 'block';
        }

        function hideRetoPlayer() {
            retoPlayerWrapper.style.display = 'none';
        }

        function avanzarPaso() {
            currentStepIndex++;
            updateStepDisplay();
            // Reiniciar el proceso de ubicación para el nuevo paso
            startLocationTracking();
        }

        // --- Gestión de la Ubicación GPS ---

        let watchId; // Para almacenar el ID del watcher de geolocalización

        function startLocationTracking() {
            if (navigator.geolocation) {
                // Opciones para la geolocalización
                const geoOptions = {
                    enableHighAccuracy: true, // Pide la mayor precisión posible
                    timeout: 10000,          // Espera hasta 10 segundos por una lectura
                    maximumAge: 0            // No usar una posición en caché, pedir una nueva
                };
                watchId = navigator.geolocation.watchPosition(geoSuccess, geoError, geoOptions);
                locationInfo.textContent = "Obteniendo tu ubicación...";
            } else {
                locationInfo.textContent = "Geolocalización no soportada por tu navegador.";
                alert("Tu navegador no soporta la geolocalización. La aventura no puede continuar.");
            }
        }

        function stopLocationTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }

        function geoSuccess(position) {
            const { latitude, longitude } = position.coords;
            const currentStep = adventureSteps[currentStepIndex];

            if (!currentStep) {
                // Aventura terminada, no seguir rastreando
                stopLocationTracking();
                return;
            }

            const targetLat = currentStep.coords.latitude;
            const targetLon = currentStep.coords.longitude;
            const detectionRadius = currentStep.radius; // Radio de detección para este paso

            const distance = calculateDistance(latitude, longitude, targetLat, targetLon);

            locationInfo.textContent = `Paso ${currentStepIndex + 1}: ${currentStep.name}. Distancia: ${distance.toFixed(2)} metros.`;

            // Lógica de proximidad y control de audio/reto
            if (distance <= detectionRadius) {
                currentAudioCanPlay = true; // Estamos en la zona
                locationInfo.textContent += " ¡Estás en la ubicación correcta!";
                
                // Si el paso tiene audio, prepáralo y quizás reprodúcelo
                if (currentStep.audioId) {
                    prepareAudioStep(currentStep.audioId, true); // True porque está en la zona
                } else {
                    hideAudioPlayer(); // Asegura que el reproductor de audio esté oculto si no hay audio
                }

                // Si el paso tiene un reto, prepáralo.
                // IMPORTANTE: El reto solo se mostrará una vez que el audio haya terminado y el usuario
                // haya pulsado "Siguiente Paso" desde el reproductor.
                if (currentStep.retoUrl && audioPlayer.ended) { // Solo si el audio ha terminado
                    // No hacemos nada aquí, el botón "Siguiente Paso" en el hijo lo gestionará
                } else if (!currentStep.audioId && currentStep.retoUrl) {
                    // Si no hay audio, cargar el reto directamente (ej: paso solo de reto)
                    // Esto puede depender de tu flujo. Por ahora, asumimos que si hay reto
                    // Y NO hay audio, se muestra directamente.
                    prepareRetoStep(currentStep.retoUrl);
                } else if (!currentStep.audioId && !currentStep.retoUrl) {
                    // Si no hay audio ni reto, avanzar automáticamente (o mostrar "siguiente paso" si prefieres)
                    // Para evitar bucles, solo avanzar si no hay audio y no hay reto definido
                    // Si quieres que el usuario pulse para avanzar aunque no haya audio ni reto:
                    // window.parent.postMessage({ type: 'audio-player-next-step' }, '*');
                    console.log(`Paso ${currentStepIndex + 1}: Sin audio ni reto. Se avanzaría automáticamente o con botón "Siguiente".`);
                    // Por ahora, no se avanza automáticamente para evitar saltos inesperados.
                    // El botón "Siguiente Paso" en el hijo debería activarse si no hay audio.
                    // Para esto, el hijo necesita saber si el paso no tiene audio, o forzar 'ended' si no hay src.
                    // Para simplificar, asumiremos que todos los pasos tienen audio o reto.
                }

            } else {
                currentAudioCanPlay = false; // Fuera de la zona
                // Pausar o evitar la reproducción de audio si estamos fuera de la zona
                if (currentStep.audioId) {
                    prepareAudioStep(currentStep.audioId, false); // False porque no está en la zona
                }
                hideRetoPlayer(); // Ocultar reto si nos alejamos
            }
        }

        function geoError(error) {
            let errorMessage = "Error de geolocalización: ";
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += "Permiso denegado por el usuario.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += "Información de ubicación no disponible.";
                    break;
                case error.TIMEOUT:
                    errorMessage += "Tiempo de espera agotado.";
                    break;
                case error.UNKNOWN_ERROR:
                    errorMessage += "Error desconocido.";
                    break;
            }
            locationInfo.textContent = errorMessage + " Por favor, asegúrate de que el GPS está activado y los permisos concedidos.";
            console.error(errorMessage, error);
            // Si hay un error, el audio no puede reproducirse
            if (audioHijoListo) {
                 audioIframe.contentWindow.postMessage({ type: 'updateCanPlay', canPlay: false }, '*');
            }
            hideAudioPlayer();
            hideRetoPlayer();
        }

        // --- Funciones Auxiliares ---

        // Función para calcular la distancia entre dos coordenadas (Fórmula de Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const φ1 = lat1 * Math.PI / 180; // φ, λ en radianes
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distancia en metros
        }

        // --- Manejo de mensajes desde los iframes hijos ---

        window.addEventListener("message", (event) => {
            // Es buena práctica verificar el origin de los mensajes en producción
            // if (event.origin !== "https://tu-dominio.github.io") return;

            const data = event.data;
            if (data && typeof data === 'object') {
                switch (data.type) {
                    case 'audio-hijo-listo':
                        audioHijoListo = true;
                        console.log("Audio iframe está listo.");
                        updateStepDisplay(); // Mostrar info del paso inicial
                        startLocationTracking(); // Empezar a rastrear ubicación
                        break;
                    case 'reto-hijo-listo':
                        retoHijoListo = true;
                        console.log("Reto iframe está listo.");
                        // Una vez el reto esté listo, si el tipo de paso lo requiere,
                        // podemos mostrar los botones de feedback del puzzle.
                        // Esto se controla ahora desde el botón de "Siguiente Paso" en el audio.
                        break;
                    case 'audio-player-next-step': // MENSAJE CLAVE DEL HIJO (NUEVO)
                        console.log("Mensaje recibido: 'audio-player-next-step'");
                        const currentStep = adventureSteps[currentStepIndex];
                        if (currentStep && currentStep.retoUrl) {
                            // Si el paso actual tiene un reto, cárgalo
                            prepareRetoStep(currentStep.retoUrl);
                            // También podríamos mostrar los botones de "Correcto/Incorrecto" aquí
                            // si el reto es interactivo y NO lo gestiona el propio iframe del reto.
                            // Por ahora, asumimos que el reto hijo enviará su propio resultado.
                        } else {
                            // Si no hay reto para este paso, o ya se ha completado, avanzar
                            avanzarPaso();
                        }
                        break;
                    case 'reto-resuelto':
                        // Este mensaje lo enviaría el iframe del reto si el puzzle se resuelve
                        if (data.result === 'correct') {
                            alert("¡Reto resuelto correctamente! Pasando al siguiente punto.");
                            avanzarPaso();
                        } else if (data.result === 'incorrect') {
                            alert("Respuesta incorrecta. Inténtalo de nuevo.");
                            // Podrías reiniciar el reto, dar una pista, etc.
                            // retoIframe.src = retoIframe.src; // Recarga el iframe del reto
                        }
                        break;
                    case 'audio-is-playing': // El hijo informa si el audio está activo
                        audioPlayerIsPlaying = data.isPlaying;
                        break;
                    case 'changeFontSize': // Si el padre quiere cambiar su propia fuente
                        document.body.style.fontSize = data.size + 'px';
                        break;
                }
            }
        });

        // Inicializar al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            updateStepDisplay();
            // Iniciar el rastreo de ubicación solo cuando el iframe de audio esté listo
            // (el iframe de audio enviará el mensaje 'audio-hijo-listo')
        });

        // Event Listeners para los botones de feedback del puzzle (si tuvieras un puzzle interactivo)
        btnPuzzleCorrect.addEventListener('click', () => {
            // Lógica para cuando el puzzle es correcto
            avanzarPaso();
            puzzleFeedbackButtons.style.display = 'none'; // Ocultar botones
        });

        btnPuzzleIncorrect.addEventListener('click', () => {
            // Lógica para cuando el puzzle es incorrecto
            alert("Inténtalo de nuevo. Puedes pedir una pista.");
            // Aquí podrías recargar el reto o dar una pista
            retoIframe.src = adventureSteps[currentStepIndex].retoUrl; // Recargar el reto
        });

    </script>
</body>
</html>
