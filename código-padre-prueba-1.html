<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aventura 1 - Padre</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #mapa { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
    .iframe-hijo {
      position: fixed;
      border: none;
      background: transparent;
      pointer-events: auto;
    }
    #hijo1 { /* Botones flotantes abajo */
      left: 0; right: 0; bottom: 0;
      width: 100vw; height: 120px;
      background: none;
      z-index: 20;
      pointer-events: none;
    }
    #hijo2 { /* Botones GPS */
      left: 0; right: 0; bottom: 130px;
      width: 100vw; height: 120px;
      background: none;
      z-index: 21;
      pointer-events: none;
    }
    #hijo3 { /* Audio */
      left: 50%; bottom: 260px;
      transform: translateX(-50%);
      width: 380px; max-width: 98vw; height: 140px;
      z-index: 22;
      background: none;
      pointer-events: none;
    }
    #hijo4 { /* Ventana de retos */
      top: 8vh; left: 50%;
      transform: translateX(-50%);
      width: 98vw; max-width: 600px; height: 60vh;
      display: none;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.18);
      z-index: 100;
      pointer-events: auto;
    }
    #hijo5 { /* GPS Casa */
      top: 12px; left: 12px;
      width: 90px; height: 90px;
      background: none;
      z-index: 200;
      pointer-events: auto;
    }
    @media (max-width: 600px) {
      #hijo3 { width: 98vw; min-width: 180px; height: 110px; }
      #hijo4 { max-width: 98vw; width: 98vw; left: 1vw; transform: none; }
      #hijo5 { width: 70px; height: 70px; }
      #hijo1, #hijo2 { height: 90px; }
    }
  </style>
</head>
<body>
  <div id="mapa"></div>
  <!-- Hijos (iframes) -->
  <iframe id="hijo1" class="iframe-hijo" src="Botones-y-subfunciones.html" allow="autoplay"></iframe>
  <iframe id="hijo2" class="iframe-hijo" src="Av1-botones-coordenadas.html"></iframe>
  <iframe id="hijo3" class="iframe-hijo" src="Av1_audio_esp.html"></iframe>
  <iframe id="hijo4" class="iframe-hijo" src="Av1-esp-retos-preguntas.html"></iframe>
  <iframe id="hijo5" class="iframe-hijo" src="Av1-boton-casa.html"></iframe>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- Datos de paradas y waypoints (de hijo 2) ---
    const secuencia = [
      { tipo: "parada", nombre: "Torres de Serranos (start)", lat: 39.47876, lng: -0.37626 },
      { tipo: "waypoint", lat: 39.47905, lng: -0.37613 },
      { tipo: "waypoint", lat: 39.47933, lng: -0.37647 },
      { tipo: "waypoint", lat: 39.47943, lng: -0.37636 },
      { tipo: "parada", nombre: "Puente de Serranos – Plaza de la crida", lat: 39.47959, lng: -0.37583 },
      { tipo: "waypoint", lat: 39.47939, lng: -0.3752 },
      { tipo: "waypoint", lat: 39.47902, lng: -0.37465 },
      { tipo: "waypoint", lat: 39.47866, lng: -0.3747 },
      { tipo: "parada", nombre: "Cortes Valencianas (Palacio de los Borgia)", lat: 39.47785, lng: -0.37485 },
      { tipo: "waypoint", lat: 39.47768, lng: -0.3749 },
      { tipo: "parada", nombre: "Plaza de la Virgen", lat: 39.47656, lng: -0.37529 },
      { tipo: "waypoint", lat: 39.4766, lng: -0.37473 },
      { tipo: "waypoint", lat: 39.47656, lng: -0.37453 },
      { tipo: "waypoint", lat: 39.47606, lng: -0.3746 },
      { tipo: "parada", nombre: "Plaza de la Almoína", lat: 39.47604, lng: -0.37451 },
      { tipo: "parada", nombre: "Catedral de València", lat: 39.47594, lng: -0.37474 },
      { tipo: "parada", nombre: "Plaza decimo Juno Bruto (Museo Arqueológico de la Almoína)", lat: 39.4762, lng: -0.37412 },
      { tipo: "parada", nombre: "Basílica de València", lat: 39.47611, lng: -0.37478 },
      { tipo: "waypoint", lat: 39.47603, lng: -0.37433 },
      { tipo: "parada", nombre: "Palacio Arzobispal", lat: 39.4755, lng: -0.37436 },
      { tipo: "waypoint", lat: 39.4756, lng: -0.37466 },
      { tipo: "waypoint", lat: 39.47514, lng: -0.37494 },
      { tipo: "waypoint", lat: 39.47447, lng: -0.3754 },
      { tipo: "waypoint", lat: 39.47378, lng: -0.3756 },
      { tipo: "waypoint", lat: 39.47212, lng: -0.37676 },
      { tipo: "parada", nombre: "Plaza del Ayuntamiento", lat: 39.47056, lng: -0.37677 },
      { tipo: "parada", nombre: "Edificio del Ayuntamiento de València", lat: 39.46971, lng: -0.37693 },
      { tipo: "waypoint", lat: 39.46795, lng: -0.37701 },
      { tipo: "parada", nombre: "Estación de Ferrocarril (Estación del Norte)", lat: 39.46722, lng: -0.37702 },
      { tipo: "parada", nombre: "Plaza de Toros de València", lat: 39.46709, lng: -0.37595 },
      { tipo: "waypoint", lat: 39.46714, lng: -0.37498 },
      { tipo: "parada", nombre: "Casa estilo Árabe", lat: 39.46753, lng: -0.37511 },
      { tipo: "parada", nombre: "Palacio de Comunicaciones (Correos)", lat: 39.46942, lng: -0.37559 },
      { tipo: "waypoint", lat: 39.4699, lng: -0.37573 },
      { tipo: "waypoint", lat: 39.4703, lng: -0.3759 },
      { tipo: "waypoint", lat: 39.47039, lng: -0.37505 },
      { tipo: "waypoint", lat: 39.47043, lng: -0.37427 },
      { tipo: "parada", nombre: "Antigua sede del Banco de València", lat: 39.47061, lng: -0.37408 },
      { tipo: "waypoint", lat: 39.47119, lng: -0.37423 },
      { tipo: "waypoint", lat: 39.47214, lng: -0.37446 },
      { tipo: "waypoint", lat: 39.47275, lng: -0.37445 },
      { tipo: "parada", nombre: "Palacio del Marqués de Dos Aguas (Museo Nacional de Crámica)", lat: 39.47276, lng: -0.37467 },
      { tipo: "waypoint", lat: 39.47315, lng: -0.37608 },
      { tipo: "waypoint", lat: 39.47261, lng: -0.37654 },
      { tipo: "waypoint", lat: 39.47225, lng: -0.37686 },
      { tipo: "waypoint", lat: 39.47265, lng: -0.37725 },
      { tipo: "parada", nombre: "Mercado Central", lat: 39.47377, lng: -0.37832 },
      { tipo: "parada", nombre: "San Juan del Mercado (Iglesia de los Santos Juanes)", lat: 39.47425, lng: -0.37895 },
      { tipo: "parada", nombre: "Lonja de València (Mercado de la Seda)", lat: 39.47426, lng: -0.37862 },
      { tipo: "waypoint", lat: 39.47445, lng: -0.37889 },
      { tipo: "waypoint", lat: 39.47459, lng: -0.37868 },
      { tipo: "waypoint", lat: 39.47475, lng: -0.37842 },
      { tipo: "waypoint", lat: 39.47436, lng: -0.37799 },
      { tipo: "parada", nombre: "Plaza del Doctor Collado", lat: 39.47444, lng: -0.3779 },
      { tipo: "waypoint", lat: 39.47473, lng: -0.37763 },
      { tipo: "waypoint", lat: 39.47493, lng: -0.37761 },
      { tipo: "waypoint", lat: 39.47559, lng: -0.37772 },
      { tipo: "parada", nombre: "Plaza del Negrito (Fuente del Negrito)", lat: 39.47611, lng: -0.37741 },
      { tipo: "parada", nombre: "Calle Caballeros", lat: 39.47663, lng: -0.3773 },
      { tipo: "waypoint", lat: 39.47661, lng: -0.37685 },
      { tipo: "parada", nombre: "Palacio de la Generalitat", lat: 39.47668, lng: -0.37671 },
      { tipo: "waypoint", lat: 39.47661, lng: -0.37685 },
      { tipo: "waypoint", lat: 39.47687, lng: -0.37686 },
      { tipo: "parada", nombre: "Calle de los Serranos (end)", lat: 39.47773, lng: -0.37671 }
    ];
    const paradas = secuencia.filter(p => p.tipo === 'parada');

    // --- Estado global ---
    let paradaActual = 0; // Índice de la parada actual
    let gpsOn = true;
    let polyline = null;
    let markerA = null, markerB = null;
    let recorrido = []; // Para la polyline verde de avance

    // --- Inicializar mapa ---
    const map = L.map('mapa').setView([39.478046, -0.375515], 14);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 40,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // --- Funciones de control de hijos ---
    const hijos = {
      1: document.getElementById('hijo1'),
      2: document.getElementById('hijo2'),
      3: document.getElementById('hijo3'),
      4: document.getElementById('hijo4'),
      5: document.getElementById('hijo5')
    };

    // --- Comunicación con hijos ---
    window.addEventListener('message', (event) => {
      const data = event.data;
      // Hijo 1: Botones y subfunciones
      if (data && data.type === 'pauseAudioFromBoton') {
        hijos[3].contentWindow.postMessage({ type: 'pauseAudio' }, '*');
      }
      // Hijo 2: Botones coordenadas pide mostrar mapa/ruta
      if (data && data.tipo === 'mostrar-mapa-gps') {
        mostrarRutaEnMapa(data.origen, data.destino);
      }
      if (data && data.tipo === 'mostrar-zoom-streetview') {
        mostrarStreetView(data.info);
      }
      if (data && data.tipo === 'mostrar-imagen') {
        mostrarImagenParada(data.info);
      }
      // Hijo 2: Llegada a destino
      if (data && data.tipo === 'ya-estoy-aqui') {
        avanzarAParada(data.parada);
      }
      // Hijo 3: Audio finalizado
      if (data && data.type === 'audioFinalizado') {
        activarReto(paradaActual);
      }
      // Hijo 4: Reto completado o continuar aventura
      if (data && data.type === 'reto-interactivo-completado') {
        avanzarRuta();
      }
      if (data && data.type === 'reto-respuesta-mostrada') {
        // El usuario ha pedido ver la respuesta, puedes decidir si avanzar o esperar acción manual
      }
      // Hijo 5: GPS Casa ON/OFF
      if (data && data.type === 'gpsStatus') {
        gpsOn = data.on;
        if (!gpsOn) {
          activarModoCasa();
        } else {
          iniciarAventura();
        }
      }
      if (data && data.type === 'seleccionParada') {
        mostrarParadaEnMapa(data.index);
        activarTodosLosBotones();
      }
    });

    // --- Funciones de lógica principal ---
    function iniciarAventura() {
      paradaActual = 0;
      avanzarRuta();
    }

    function avanzarRuta() {
      if (paradaActual >= paradas.length - 1) return;
      const origen = paradaActual;
      const destino = paradaActual + 1;
      hijos[2].contentWindow.postMessage({ tipo: 'navegar-de-a-b', origen, destino }, '*');
      mostrarRutaEnMapa(origen, destino);
      paradaActual = destino;
    }

    function avanzarAParada(paradaIndex) {
      hijos[3].contentWindow.postMessage({ type: 'setAudioParada', index: paradaIndex }, '*');
      // El audio hijo3 avisará cuando termine para activar el reto hijo4
    }

    function activarReto(paradaIndex) {
      hijos[4].style.display = 'block';
      hijos[4].contentWindow.postMessage({ type: 'mostrarRetoIndex', index: paradaIndex }, '*');
    }

    function activarTodosLosBotones() {
      hijos[2].contentWindow.postMessage({ tipo: 'navegar-de-a-b', origen: 0, destino: paradas.length - 1 }, '*');
      hijos[3].contentWindow.postMessage({ type: 'setAudioParada', index: 0 }, '*');
    }

    function activarModoCasa() {
      // Modo casa: permite seleccionar cualquier parada y activa todos los botones
      hijos[2].contentWindow.postMessage({ tipo: 'navegar-de-a-b', origen: 0, destino: paradas.length - 1 }, '*');
      hijos[3].contentWindow.postMessage({ type: 'setAudioParada', index: 0 }, '*');
    }

    function mostrarRutaEnMapa(origen, destino) {
      // Limpia rutas anteriores
      if (polyline) { map.removeLayer(polyline); }
      if (markerA) { map.removeLayer(markerA); }
      if (markerB) { map.removeLayer(markerB); }
      // Calcula la ruta entre origen y destino
      const idxA = secuencia.findIndex(p => p.tipo === 'parada' && p.nombre === paradas[origen].nombre);
      const idxB = secuencia.findIndex(p => p.tipo === 'parada' && p.nombre === paradas[destino].nombre);
      let ruta = [];
      if (idxA !== -1 && idxB !== -1 && idxA < idxB) {
        ruta = secuencia.slice(idxA, idxB + 1);
      }
      // Dibuja polyline
      const latlngs = ruta.map(p => [p.lat, p.lng]);
      polyline = L.polyline(latlngs, { color: 'red', weight: 6 }).addTo(map);
      // Marca puntos A y B
      markerA = L.marker([paradas[origen].lat, paradas[origen].lng], { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [32, 32] }) }).addTo(map);
      markerB = L.marker([paradas[destino].lat, paradas[destino].lng], { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684912.png', iconSize: [32, 32] }) }).addTo(map);
      map.fitBounds(polyline.getBounds(), { padding: [40, 40] });
    }

    function mostrarStreetView(info) {
      alert('Mostrar StreetView de: ' + info.nombre);
      // Aquí puedes integrar un visor de StreetView si lo deseas
    }

    function mostrarImagenParada(info) {
      alert('Mostrar imagen de: ' + info.nombre);
      // Aquí puedes mostrar la imagen asociada a la parada
    }

    function mostrarParadaEnMapa(index) {
      if (markerA) { map.removeLayer(markerA); }
      markerA = L.marker([paradas[index].lat, paradas[index].lng], { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [32, 32] }) }).addTo(map);
      map.setView([paradas[index].lat, paradas[index].lng], 16);
    }

    // --- Iniciar la aventura al cargar ---
    window.onload = iniciarAventura;
  </script>
</body>
</html>
