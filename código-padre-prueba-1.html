<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aventura 1: Descubre Valencia (Padre)</title>
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
        /* CSS para el padre (código-padre-prueba-1.html) */
        body {
            font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif;
            margin: 1em;
            background: #fff;
            color: #222;
            font-size: 16px; /* Tamaño de fuente base */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: calc(100vh - 2em);
            justify-content: flex-start;
            position: relative; /* Necesario para posicionamiento de botones fijos */
        }
        h2 {
            margin-bottom: 0.8em;
            text-align: center;
            width: 100%;
        }

        /* Contenedor principal para iframes de retos/puzzles */
        #reto-container {
            /* Los bordes deben ser siempre de igual grosor. */
            border: 3px solid #ccc; /* Grosor inicial */
            border-radius: 8px;
            padding: 0;
            margin-bottom: 1em;
            position: relative;
            min-height: 250px;
            width: 100%;
            max-width: 980px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            transition: border-color 0.3s ease-in-out; /* Transición suave para el color del borde */
        }

        #reto-iframe-principal, /* Cambiado el ID para el iframe principal */
        #puzzleIframe {
            width: 100%;
            height: 600px;
            border: none;
            display: none; /* Ocultos por defecto */
        }

        #button-container-padre {
            display: flex;
            flex-wrap: wrap;
            gap: 1em;
            margin-top: 1em;
            justify-content: center;
            width: 100%;
            min-height: 40px;
        }

        button.btn-padre {
            padding: 0.6em 1.2em;
            font-size: 1.1em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background-color: #0077cc;
            color: white;
            user-select: none;
            transition: background-color 0.3s ease;
        }
        button.btn-padre:hover {
            background-color: #005699;
        }
        button.btn-padre:disabled {
            background-color: #999;
            cursor: not-allowed;
        }

        #btnNextAfterReto {
            background-color: #0077cc;
            display: none; /* Oculto por defecto */
        }
        #btnNextAfterReto:hover {
            background-color: #005699;
        }

        /* Clases para el borde del contenedor, aplicadas por el padre */
        #reto-container.correct {
            border-color: #28a745; /* Verde */
        }
        #reto-container.incorrect {
            border-color: #c00; /* Rojo */
        }
        #reto-container.ready {
            border-color: #0077cc; /* Azul para "esperando respuesta" */
        }
        #reto-container.revealed {
            border-color: #ffc107; /* Naranja/Amarillo para respuesta mostrada */
        }
        #reto-container.no-reto {
            border-color: transparent; /* Transparente si no hay reto/puzzle */
        }

        /* Estilos para el reproductor de audio */
        .audio-player-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1em;
            margin-bottom: 2em;
            padding: 1em;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            width: 100%;
            max-width: 600px;
        }

        #audioControlContainer {
            display: flex;
            align-items: center;
            gap: 1em;
            width: 100%;
            justify-content: center;
        }

        /* El botón de play/pause ahora es un placeholder para el hijo */
        #playPauseBtn {
            padding: 1em;
            font-size: 1.2em;
            border: none;
            border-radius: 50%;
            background-color: #6c757d; /* Gris para indicar que no está activo todavía */
            color: white;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
        }
        #playPauseBtn.active { /* Clase para cuando está activo por proximidad */
            background-color: #28a745; /* Verde */
        }
        #playPauseBtn:hover:not(:disabled):not(.active) {
            background-color: #5a6268;
        }
        #playPauseBtn.active:hover:not(:disabled) {
            background-color: #218838;
        }

        #playPauseBtn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #playPauseBtn i {
            pointer-events: none; /* Evita que el icono interfiera con el click del botón */
        }

        #progressBarContainer {
            flex-grow: 1; /* Ocupa el espacio disponible */
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }

        #progressBar {
            height: 100%;
            width: 0%;
            background-color: #0077cc;
            border-radius: 4px;
        }

        #currentTime,
        #duration {
            font-size: 0.9em;
            color: #555;
            min-width: 40px; /* Para evitar saltos de texto */
            text-align: center;
        }

        #locationStatus {
            font-size: 0.9em;
            margin-top: 0.5em;
            text-align: center;
        }

        /* Controles de depuración para GPS */
        #gpsDebugControls {
            margin-top: 1.5em;
            padding: 1em;
            border: 1px dashed #ccc;
            border-radius: 8px;
            background-color: #f0f0f0;
            text-align: center;
            width: 100%;
            max-width: 600px;
        }
        #gpsDebugControls button {
            background-color: #0077cc;
            color: white;
            padding: 0.5em 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0.5em;
        }
        #gpsDebugControls button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #terminarAventuraBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #ff4d4d; /* Rojo para "Terminar" */
            color: white;
            padding: 1em 1.5em;
            border-radius: 50px; /* Botón flotante redondo */
            font-size: 1.1em;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: none; /* Oculto por defecto, se muestra al final */
        }
        #terminarAventuraBtn:hover {
            background-color: #cc0000;
        }

        /* --- NUEVOS ESTILOS PARA LOS BOTONES DESPLEGABLES --- */
        .floating-btn {
            position: fixed;
            background-color: #0077cc;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.8em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: background-color 0.3s ease;
        }
        .floating-btn:hover {
            background-color: #005699;
        }

        #leftMenuBtn {
            bottom: 20px;
            left: 20px;
        }

        #rightMenuBtn {
            bottom: 20px;
            right: 100px; /* Desplazado para no chocar con Terminar Aventura */
        }

        /* Estilos para los contenedores de menú desplegable */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6); /* Fondo semi-transparente */
            z-index: 1000;
            display: none; /* Oculto por defecto */
            justify-content: center;
            align-items: center;
        }

        .menu-container {
            background: #fff;
            padding: 1em;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90%;
            overflow: hidden; /* Para contener los iframes */
            display: flex;
            flex-direction: column;
            position: relative; /* Para posicionar la X de cierre */
        }

        /* Menú de la izquierda */
        #leftMenuContainer .menu-container {
            width: 400px; /* Ancho fijo para el menú de la izquierda */
        }

        /* Menú de la derecha */
        #rightMenuContainer .menu-container {
            width: 350px; /* Ancho fijo para el menú de la derecha */
        }

        /* --- Posición de la X de cierre (ahora arriba a la derecha) --- */
        .menu-container .close-tab-btn {
            position: absolute;
            top: 10px; /* Ajusta la distancia desde arriba */
            right: 10px; /* Ajusta la distancia desde la derecha */
            background: none;
            border: none;
            font-size: 1.8em; /* Tamaño de la X */
            cursor: pointer;
            color: #555;
            z-index: 10; /* Asegura que esté por encima de otros elementos */
            padding: 0; /* Elimina padding extra del botón */
            line-height: 1; /* Para centrar el carácter X */
        }
        .menu-container .close-tab-btn:hover {
            color: #c00;
        }


        .menu-tabs {
            display: flex;
            flex-direction: column; /* Cambiado a columna para mejor control de botones */
            gap: 0.5em;
            margin-bottom: 1em;
            margin-top: 1em; /* Espacio debajo del título y la X */
        }

        .menu-tab-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 0.8em 1.2em;
            border-radius: 5px;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 1.1em;
            color: #333;
        }
        .menu-tab-btn:hover {
            background-color: #e0e0e0;
        }
        .menu-tab-btn.active {
            background-color: #0077cc;
            color: white;
            border-color: #0077cc;
        }

        /* Estilos para el contenido de las pestañas (dentro del menú, NO en pantalla completa) */
        .tab-content {
            flex-grow: 1;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            display: none; /* Oculto por defecto */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            background-color: #f9f9f9;
            padding: 1em; /* Añadido padding para el mensaje */
        }

        .tab-content .en-desarrollo-message {
            font-size: 1.2em;
            font-style: italic;
            color: #666;
            text-align: center;
            display: flex; /* Asegurar que el mensaje esté centrado */
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }


        /* --- NUEVO ESTILO PARA EL CONTENEDOR DE PANTALLA COMPLETA --- */
        #fullScreenIframeContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff; /* Fondo blanco para el contenido */
            z-index: 10000; /* Asegura que esté por encima de todo */
            display: none; /* Oculto por defecto */
            flex-direction: column; /* Para organizar el botón de cerrar y el iframe */
            box-sizing: border-box; /* Incluir padding en el tamaño */
        }

        #fullScreenIframeContainer iframe {
            width: 100%;
            height: 100%;
            border: none;
            flex-grow: 1; /* Ocupa el espacio restante */
            display: block; /* Asegurarse de que el iframe se muestre */
        }

        #fullScreenCloseBtn {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5); /* Botón más discreto */
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10001; /* Más alto que el contenedor */
        }
        #fullScreenCloseBtn:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        /* Estilos específicos para la ventana de Términos y Condiciones */
        #termsOverlay {
            z-index: 100000; /* Más alto que cualquier otro overlay */
            display: flex; /* Asegura que esté visible al cargar */
        }

        #termsBox {
            width: 80%;
            height: 80%;
            max-width: 700px;
            max-height: 500px;
        }

        #termsIframe {
            flex-grow: 1;
            height: 100%;
            display: block; /* Debe ser visible cuando la ventana de términos está abierta */
        }

        /* Media Queries para pantallas más pequeñas */
        @media (max-width: 800px) and (orientation: landscape) {
            h2 {
                display: none;
            }
            body {
                margin: 0.5em;
            }
            #reto-container {
                min-height: auto;
                height: calc(100dvh - 80px);
                padding: 0;
                margin-bottom: 0.5em;
            }
            #reto-iframe-principal,
            #puzzleIframe {
                height: 100%;
                max-width: 100%;
            }
            button.btn-padre {
                font-size: 1em;
                padding: 0.5em 1em;
            }
            .audio-player-container,
            #gpsDebugControls {
                max-width: 100%;
            }
            /* Ajustar tamaño de menús en landscape */
            #leftMenuContainer .menu-container,
            #rightMenuContainer .menu-container,
            #termsBox {
                width: 95%; /* Ocupar casi todo el ancho */
                max-height: 95%;
            }
        }

        @media (max-width: 600px) and (orientation: portrait) {
            #reto-iframe-principal,
            #puzzleIframe {
                height: 400px;
            }
            #reto-container {
                min-height: 400px;
            }
            /* Ajustar tamaño de menús en portrait */
            #leftMenuContainer .menu-container,
            #rightMenuContainer .menu-container,
            #termsBox {
                width: 95%; /* Ocupar casi todo el ancho */
                max-height: 95%;
            }
            .floating-btn {
                width: 50px;
                height: 50px;
                font-size: 1.5em;
            }
            /* Ajustar posición del botón derecho más a la derecha */
            #rightMenuBtn {
                right: 20px; /* Más pegado al borde derecho */
            }
        }
    </style>
</head>
<body>
    <div id="termsOverlay" class="menu-overlay">
        <div id="termsBox" class="menu-container">
            <h3>Términos y Condiciones</h3>
            <iframe id="termsIframe" src="terminos_y_condiciones.html" style="width: 100%; height: 100%; border: none;"></iframe>
            <button id="acceptTermsBtn" class="btn-padre" style="margin-top: 1em; width: 100%;">Aceptar Términos y Continuar</button>
        </div>
    </div>

    <div id="welcomeOverlay" style="display: none;">
        <div id="welcomeBox">
            <h1>¡Bienvenido a tu Aventura en Valencia!</h1>
            <p>
                Para disfrutar de esta experiencia, necesitamos acceder a algunas funciones de tu dispositivo.
                Por favor, acepta los permisos de <strong>ubicación (GPS)</strong> y permite la reproducción de <strong>audio</strong>.
                Esto nos permitirá guiarte por los puntos de interés y activar los retos y narraciones en el momento justo.
            </p>
            <button id="acceptPermissionsBtn">Aceptar y Empezar Aventura</button>
        </div>
    </div>

    <h2>Aventura 1: Descubre Valencia</h2>

    <div id="reto-container">
        <iframe id="puzzleIframe" src=""></iframe> <div id="loading-message" style="text-align: center; padding: 2em; font-size: 1.2em; display: block;">
            Cargando la aventura...
        </div>
    </div>

    <div class="audio-player-container" id="audioPlayerWrapper" style="display: none;">
        <h3>Audio del Punto <span id="currentAudioPoint"></span></h3>
        <iframe id="audioIframe" src="audio_player_hijo.html" style="width: 100%; height: 120px; border: none; display: none;"></iframe>
        <p id="locationStatus" style="color: red; font-weight: bold;">Esperando ubicación...</p>
    </div>

    <div id="button-container-padre">
        <button id="btnNextAfterReto" class="btn-padre">Continuar con la Aventura</button>
    </div>

    <div id="gpsDebugControls">
        <h4>Modo de Prueba GPS (Solo para desarrollo)</h4>
        <button id="toggleGpsMode">Activar/Desactivar GPS Real</button>
        <p>Estado GPS: <span id="gpsModeStatus">Real (intentando obtener)</span></p>
        <button id="simulateProximityBtn" disabled>Simular Proximidad</button>
    </div>

    <button id="leftMenuBtn" class="floating-btn"><i class="fas fa-bars"></i></button>
    <button id="rightMenuBtn" class="floating-btn"><i class="fas fa-ellipsis-v"></i></button>
    <button id="terminarAventuraBtn">Terminar Aventura</button>

    <div id="leftMenuContainer" class="menu-overlay">
        <div class="menu-container">
            <button class="close-tab-btn" onclick="hideLeftMenu()">&times;</button>
            <h3>Menú de Aventura</h3>
            <div class="menu-tabs">
                <button class="menu-tab-btn" data-tab-target="retosPuzzlesTab">Retos y Puzzles</button>
                <button class="menu-tab-btn" data-tab-target="gastronomiaTab">Gastronomía</button>
                <button class="menu-tab-btn" data-tab-target="paginasOficialesTab">Páginas Oficiales</button>
                <button class="menu-tab-btn" data-tab-target="videosHistoricosTab">Videos Históricos</button>
            </div>
            <div id="retosPuzzlesTab" class="tab-content">
                <div class="en-desarrollo-message">Cargando Retos y Puzzles...</div>
            </div>
            <div id="gastronomiaTab" class="tab-content">
                <div class="en-desarrollo-message">Cargando Gastronomía...</div>
            </div>
            <div id="paginasOficialesTab" class="tab-content">
                <div class="en-desarrollo-message">Cargando Páginas Oficiales...</div>
            </div>
            <div id="videosHistoricosTab" class="tab-content">
                <div class="en-desarrollo-message">Cargando Videos Históricos...</div>
            </div>
        </div>
    </div>

    <div id="rightMenuContainer" class="menu-overlay">
        <div class="menu-container">
            <button class="close-tab-btn" onclick="hideRightMenu()">&times;</button>
            <h3>Información Adicional</h3>
            <div class="menu-tabs">
                <button class="menu-tab-btn" data-tab-target="agradecimientosTab">Agradecimientos</button>
                <button class="menu-tab-btn" data-tab-target="fuentesInfoTab">Fuentes de Información</button>
                <button class="menu-tab-btn" data-tab-target="consejosSeguridadTab">Consejos y Seguridad Vial</button>
            </div>
            <div id="agradecimientosTab" class="tab-content">
                <div class="en-desarrollo-message">Cargando Agradecimientos...</div>
            </div>
            <div id="fuentesInfoTab" class="tab-content">
                <div class="en-desarrollo-message">Cargando Fuentes de Información...</div>
            </div>
            <div id="consejosSeguridadTab" class="tab-content">
                <div class="en-desarrollo-message">Cargando Consejos y Seguridad Vial...</div>
            </div>
        </div>
    </div>

    <div id="fullScreenIframeContainer">
        <button id="fullScreenCloseBtn"><i class="fas fa-times"></i></button>
        <iframe id="fullScreenIframe" src=""></iframe>
    </div>

    <script>
        // Variables globales
        let initialAudioPoint = 0; // El primer punto de audio/reto a cargar
        let gpsRealActivado = true; // Por defecto, intentar usar GPS real
        let currentStep = 0; // Controla el paso actual de la aventura

        // Definición de los puntos de interés de la aventura
        const audioPuntosInteres = [
            { id: 1, lat: 39.475962, lon: -0.375253, audio: 'audio/01_intro.mp3', distanciaActivacion: 50 }, // Plaza de la Virgen
            { id: 2, lat: 39.476483, lon: -0.376175, audio: 'audio/02_catedral.mp3', distanciaActivacion: 30 }, // Catedral de Valencia
            { id: 3, lat: 39.476602, lon: -0.377610, audio: 'audio/03_mercado.mp3', distanciaActivacion: 40 }, // Mercado Central
            // Añade más puntos aquí
        ];

        // Mapeo de puntos de interés a puzzles/retos
        // Cada clave es el id del punto de interes, y el valor es un array de objetos de reto
        // { tipo: 'reto'|'puzzle', src: 'url_del_iframe', activacion: 'auto'|'manual' }
        const puzzlesPorPunto = {
            1: [ // Punto 1: Plaza de la Virgen
                { tipo: 'puzzle', src: 'puzzle_jigsaw.html', activacion: 'manual' } // Ejemplo de un puzzle
            ],
            2: [ // Punto 2: Catedral
                { tipo: 'reto', src: 'reto_especifico_punto2.html', activacion: 'manual' } // Ejemplo de un reto específico para el punto
            ],
            // Puedes añadir más puntos y sus retos/puzzles aquí
        };

        // Referencias a elementos del DOM
        const retoContainer = document.getElementById('reto-container');
        const puzzleIframe = document.getElementById('puzzleIframe');
        const btnNextAfterReto = document.getElementById('btnNextAfterReto');
        const playPauseBtn = document.getElementById('playPauseBtn');

        // Referencias de la pantalla de bienvenida
        const welcomeOverlay = document.getElementById('welcomeOverlay');
        const acceptPermissionsBtn = document.getElementById('acceptPermissionsBtn');

        // Referencias para el estado del GPS y depuración
        const gpsModeStatusSpan = document.getElementById('gpsModeStatus');
        const locationStatusSpan = document.getElementById('locationStatus');
        const toggleGpsModeBtn = document.getElementById('toggleGpsMode');
        const simulateProximityBtn = document.getElementById('simulateProximityBtn');
        let watchId; // Para almacenar el ID del watcher de geolocalización

        // Referencia al ID del punto de audio actual
        const currentAudioPointSpan = document.getElementById('currentAudioPoint');

        // Referencias de los botones flotantes y menús
        const leftMenuBtn = document.getElementById('leftMenuBtn');
        const rightMenuBtn = document.getElementById('rightMenuBtn');
        const terminarAventuraBtn = document.getElementById('terminarAventuraBtn');

        const leftMenuContainer = document.getElementById('leftMenuContainer');
        const rightMenuContainer = document.getElementById('rightMenuContainer');

        // Referencias para el iframe en pantalla completa
        const fullScreenIframeContainer = document.getElementById('fullScreenIframeContainer');
        const fullScreenIframe = document.getElementById('fullScreenIframe');
        const fullScreenCloseBtn = document.getElementById('fullScreenCloseBtn');

        // Referencia al iframe del reproductor de audio hijo
        const audioIframe = document.getElementById('audioIframe');

        // NUEVAS REFERENCIAS PARA TÉRMINOS Y CONDICIONES
        const termsOverlay = document.getElementById('termsOverlay');
        const acceptTermsBtn = document.getElementById('acceptTermsBtn');
        const termsIframe = document.getElementById('termsIframe');

        // NO MÁS retoIframeTab directo, todo va a fullScreenIframe
        // const retoIframeTab = document.getElementById('retoIframeTab');

        // --- Funciones de Geolocalización y Proximidad ---

        // Función para solicitar permisos de geolocalización
        function requestGeolocationPermission() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log("Permiso de geolocalización concedido.");
                        // No se hace nada más aquí, startGeolocation se llama al aceptar
                    },
                    (error) => {
                        console.warn(`Error de geolocalización inicial: ${error.message}`);
                        if (error.code === error.PERMISSION_DENIED) {
                            alert("Permiso de ubicación denegado. La aventura funcionará en modo manual.");
                            gpsRealActivado = false;
                            gpsModeStatusSpan.textContent = "GPS Desactivado (Permiso denegado)";
                            locationStatusSpan.textContent = "GPS Desactivado (Permiso denegado).";
                            locationStatusSpan.style.color = '#dc3545'; // Rojo
                            simulateProximityBtn.disabled = false; // Habilitar simulación
                        }
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                alert("Tu navegador no soporta geolocalización. La aventura funcionará en modo manual.");
                gpsRealActivado = false;
                gpsModeStatusSpan.textContent = "GPS Desactivado (No soportado)";
                locationStatusSpan.textContent = "GPS Desactivado (No soportado).";
                locationStatusSpan.style.color = '#dc3545'; // Rojo
                simulateProximityBtn.disabled = false; // Habilitar simulación
            }
        }

        function startGeolocation() {
            if (gpsRealActivado && "geolocation" in navigator) {
                gpsModeStatusSpan.textContent = "Real (obteniendo ubicación...)";
                locationStatusSpan.textContent = "Buscando tu ubicación...";
                locationStatusSpan.style.color = '#ffc107'; // Amarillo
                watchId = navigator.geolocation.watchPosition(
                    handlePosition,
                    handleGeolocationError,
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
                console.log("Iniciando seguimiento de geolocalización.");
            } else {
                console.log("Geolocalización real desactivada o no soportada.");
                gpsModeStatusSpan.textContent = "GPS Desactivado (Modo Manual/Simulado)";
                locationStatusSpan.textContent = "GPS Desactivado.";
                locationStatusSpan.style.color = '#6c757d'; // Gris
                simulateProximityBtn.disabled = false; // Habilitar simulación en modo manual
            }
        }

        function stopGeolocation() {
            if (watchId !== undefined) {
                navigator.geolocation.clearWatch(watchId);
                watchId = undefined;
                console.log("Seguimiento de geolocalización detenido.");
            }
        }

        function updateLocationStatus(message, color = '#333') {
            locationStatusSpan.textContent = message;
            locationStatusSpan.style.color = color;
        }

        function handlePosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            console.log(`Ubicación: ${lat}, ${lon} (precisión: ${accuracy}m)`);
            updateLocationStatus(`Ubicación: ${lat.toFixed(6)}, ${lon.toFixed(6)} (±${accuracy.toFixed(0)}m)`, '#28a745'); // Verde

            // Verificar proximidad solo si no hay un reto/puzzle activo en el `#reto-container`
            // y si el botón de "Continuar Aventura" no está visible (indicando que un reto ha terminado)
            if (!puzzleIframe.style.display || puzzleIframe.style.display === 'none') { // Asegura que no haya un puzzle activo
                 if (btnNextAfterReto.style.display === 'none') { // y que no se esté esperando para continuar la aventura
                     verificarProximidad(lat, lon);
                 }
             }
        }


        function handleGeolocationError(error) {
            console.error(`Error de geolocalización: ${error.message} (Código: ${error.code})`);
            let errorMessage = "Error al obtener ubicación.";
            let errorColor = '#dc3545'; // Rojo

            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "Permiso de ubicación denegado.";
                    gpsRealActivado = false; // Desactivar GPS real si se deniega el permiso
                    simulateProximityBtn.disabled = false; // Habilitar simulación
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "Ubicación no disponible.";
                    break;
                case error.TIMEOUT:
                    errorMessage = "Tiempo de espera agotado.";
                    break;
                default:
                    errorMessage = "Error desconocido de ubicación.";
                    break;
            }
            updateLocationStatus(errorMessage, errorColor);
            gpsModeStatusSpan.textContent = "GPS Desactivado (Error)";
        }

        // Función para calcular distancia entre dos puntos (fórmula de Haversine)
        function distanciaHaversine(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const φ1 = lat1 * Math.PI / 180; // φ, λ en radianes
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const d = R * c; // Distancia en metros
            return d;
        }

        function verificarProximidad(lat, lon) {
            if (currentStep < audioPuntosInteres.length) {
                const puntoActual = audioPuntosInteres[currentStep];
                const distancia = distanciaHaversine(lat, lon, puntoActual.lat, puntoActual.lon);
                console.log(`Distancia al punto ${puntoActual.id}: ${distancia.toFixed(2)}m`);
                updateLocationStatus(`Distancia al punto ${puntoActual.id}: ${distancia.toFixed(0)}m`, '#0077cc'); // Azul

                if (distancia < puntoActual.distanciaActivacion) {
                    if (!audioIframe.style.display || audioIframe.style.display === 'none') { // Solo si el audio no está activo
                        console.log(`¡Cerca del punto ${puntoActual.id}! Activando audio.`);
                        // Enviar mensaje al iframe del audio para que reproduzca
                        sendMessageToAudioChild('playAudio', { src: puntoActual.audio });
                        audioIframe.style.display = 'block';
                        document.getElementById('audioPlayerWrapper').style.display = 'flex';
                        currentAudioPointSpan.textContent = puntoActual.id;
                        playPauseBtn.classList.add('active'); // Indicar que el botón de audio está activo

                        // Activar el reto o puzzle si es de activación automática
                        const retosDelPunto = puzzlesPorPunto[puntoActual.id] || [];
                        const autoReto = retosDelPunto.find(r => r.activacion === 'auto');
                        if (autoReto && (puzzleIframe.style.display === 'none' || !puzzleIframe.style.display)) {
                            console.log(`Activando reto automático para el punto ${puntoActual.id}: ${autoReto.src}`);
                            if (autoReto.tipo === 'reto') {
                                cargarReto(autoReto.src);
                            } else if (autoReto.tipo === 'puzzle') {
                                mostrarPuzzle(autoReto.src);
                            }
                        }
                    }
                } else {
                    // Si nos alejamos del punto, pausar el audio
                    if (audioIframe.style.display === 'block') {
                        sendMessageToAudioChild('pauseAudio');
                        playPauseBtn.classList.remove('active');
                    }
                }
            } else {
                updateLocationStatus("Aventura completada o puntos agotados.", '#28a745');
                terminarAventuraBtn.style.display = 'block'; // Mostrar botón de terminar al final
            }
        }


        // --- Funciones de Control de la Aventura (Pasos, Retos, Puzzles) ---

        function cargarSiguientePaso() {
            ocultarRetoYPuzzle(); // Ocultar cualquier reto/puzzle anterior en el área principal
            btnNextAfterReto.style.display = 'none'; // Ocultar botón de "Continuar Aventura"

            if (currentStep < audioPuntosInteres.length) {
                const puntoActual = audioPuntosInteres[currentStep];
                console.log(`Cargando paso ${currentStep + 1}: Punto ${puntoActual.id}`);
                currentAudioPointSpan.textContent = puntoActual.id;
                document.getElementById('audioPlayerWrapper').style.display = 'flex'; // Asegurarse de que el reproductor de audio esté visible

                // Ocultar mensaje de carga inicial
                document.getElementById('loading-message').style.display = 'none';

                // Iniciar la geolocalización si estamos en modo real
                if (gpsRealActivado) {
                    startGeolocation();
                } else {
                    // En modo manual, habilitar simulación si no está activo el GPS real
                    simulateProximityBtn.disabled = false;
                    // También, si no hay GPS real, el botón de play/pause se activa manualmente
                    playPauseBtn.classList.add('active'); // Asumimos que el usuario controlará el audio manualmente
                    sendMessageToAudioChild('loadAudio', { src: puntoActual.audio }); // Cargar el audio para reproducción manual
                }

                // Determinar si hay un reto/puzzle en el punto actual para mostrar el borde
                const retosDelPunto = puzzlesPorPunto[puntoActual.id] || [];
                const tieneReto = retosDelPunto.length > 0;

                if (tieneReto) {
                    reiniciarEstadoReto(); // Poner el borde en color azul por defecto si se espera un reto/puzzle
                } else {
                    retoContainer.classList.add('no-reto'); // Ocultar borde si no hay reto activo para este punto
                }

            } else {
                console.log("¡Aventura completada!");
                updateLocationStatus("¡Felicidades, la aventura ha terminado!", '#28a745');
                document.getElementById('audioPlayerWrapper').style.display = 'none';
                puzzleIframe.style.display = 'none';
                retoContainer.classList.add('no-reto');
                stopGeolocation(); // Detener el seguimiento del GPS al finalizar
                terminarAventuraBtn.style.display = 'block'; // Mostrar botón de terminar
            }
        }

        // Carga un reto en el iframe principal del CONTENEDOR DE AVENTURA
        function cargarReto(url) {
            puzzleIframe.src = url;
            puzzleIframe.style.display = 'block';
            btnNextAfterReto.style.display = 'none'; // Ocultar el botón de continuar mientras el reto está activo
            retoContainer.classList.add('ready'); // Borde azul para "en espera"
            console.log("Reto cargado en contenedor principal:", url);
        }

        // Muestra un puzzle en el iframe secundario (en el contenedor de aventura)
        function mostrarPuzzle(url) {
            puzzleIframe.src = url;
            puzzleIframe.style.display = 'block';
            btnNextAfterReto.style.display = 'none';
            retoContainer.classList.add('ready'); // Borde azul para "en espera"
            console.log("Puzzle cargado en contenedor principal:", url);
        }

        // Oculta el iframe de puzzle/reto del contenedor principal
        function ocultarRetoYPuzzle() {
            puzzleIframe.style.display = 'none';
            puzzleIframe.src = 'about:blank'; // Limpiar el contenido del iframe
            retoContainer.classList.remove('correct', 'incorrect', 'ready', 'revealed');
            retoContainer.classList.add('no-reto'); // Borde transparente cuando no hay nada
        }

        // Reinicia el estado visual del contenedor del reto
        function reiniciarEstadoReto() {
            retoContainer.classList.remove('correct', 'incorrect', 'revealed', 'no-reto');
            retoContainer.classList.add('ready'); // Por defecto, el borde es azul cuando hay un reto
        }

        // --- Funciones para Menús y Pantalla Completa ---

        // Muestra el contenido en el iframe de pantalla completa
        function showContentInFullScreen(url) {
            fullScreenIframe.src = url;
            fullScreenIframeContainer.style.display = 'flex';
            // Ocultar los menús flotantes si están abiertos
            hideLeftMenu();
            hideRightMenu();
        }

        // Oculta el iframe de pantalla completa
        function hideFullScreenIframe() {
            fullScreenIframe.src = ''; // Limpiar el contenido
            fullScreenIframeContainer.style.display = 'none';
        }

        function showLeftMenu() {
            leftMenuContainer.style.display = 'flex';
            // Al abrir, desactiva todas las pestañas y oculta su contenido
            leftMenuContainer.querySelectorAll('.menu-tab-btn').forEach(btn => btn.classList.remove('active'));
            leftMenuContainer.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
        }

        function hideLeftMenu() {
            leftMenuContainer.style.display = 'none';
        }

        function showRightMenu() {
            rightMenuContainer.style.display = 'flex';
            // Al abrir, desactiva todas las pestañas y oculta su contenido
            rightMenuContainer.querySelectorAll('.menu-tab-btn').forEach(btn => btn.classList.remove('active'));
            rightMenuContainer.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
        }

        function hideRightMenu() {
            rightMenuContainer.style.display = 'none';
        }

        // --- Comunicación entre Padre e Hijo (iframes) ---

        // Función para enviar mensajes al iframe del reproductor de audio
        function sendMessageToAudioChild(type, data = {}) {
            if (audioIframe.contentWindow) {
                audioIframe.contentWindow.postMessage({ type, ...data }, '*');
            }
        }

        // Manejar mensajes recibidos de los iframes hijos
        window.addEventListener('message', (event) => {
            // Asegúrate de verificar el origin en un entorno de producción
            // if (event.origin !== "http://tu-dominio.com") return;

            const message = event.data;
            console.log("Mensaje recibido del hijo:", message);

            switch (message.type) {
                case 'retoCompletado':
                case 'puzzleCompletado':
                    // Verificar si el mensaje viene del iframe de AVENTURA (#puzzleIframe)
                    if (event.source === puzzleIframe.contentWindow) {
                        console.log(`Reto/Puzzle de aventura completado con resultado: ${message.correct ? 'Correcto' : 'Incorrecto'}`);
                        if (message.correct) {
                            retoContainer.classList.add('correct');
                            alert("¡Respuesta correcta! Puedes continuar con la aventura.");
                        } else {
                            retoContainer.classList.add('incorrect');
                            alert("Respuesta incorrecta. Inténtalo de nuevo o avanza.");
                        }
                        btnNextAfterReto.style.display = 'block'; // Mostrar el botón para continuar
                    }
                    // Ignorar mensajes de reto/puzzle del iframe de la pestaña, ya que son independientes y no afectan el flujo principal
                    break;
                case 'audioEnded':
                    console.log("Reproducción de audio finalizada.");
                    playPauseBtn.classList.remove('active'); // Desactivar el botón de play/pause
                    break;
                case 'audioReady':
                    console.log("Audio player hijo listo.");
                    // Cargar el primer audio si el GPS real está desactivado y el audio no está ya cargado
                    if (!gpsRealActivado && currentStep < audioPuntosInteres.length && audioPuntosInteres[currentStep].audio) {
                        sendMessageToAudioChild('loadAudio', { src: audioPuntosInteres[currentStep].audio });
                        playPauseBtn.classList.add('active'); // Activar visualmente para reproducción manual
                    }
                    break;
                case 'audioTogglePlayPause':
                    console.log("Audio toggled by child.");
                    break;
                case 'abrirFullscreen': // Mensaje para abrir un iframe en pantalla completa (ahora centralizado)
                    if (message.url) {
                        showContentInFullScreen(message.url);
                    }
                    break;
                case 'actualizarAudioControles':
                    break;
            }
        });

        // --- Event Listeners ---

        // Evento para aceptar permisos y comenzar la aventura (de la pantalla de bienvenida)
        acceptPermissionsBtn.addEventListener('click', () => {
            console.log("¡Botón 'Aceptar y Empezar' clickeado!"); // Mensaje de depuración
            welcomeOverlay.style.display = 'none'; // Oculta la pantalla de bienvenida
            if (gpsRealActivado) {
                // Si el GPS real está activo, pedirá permiso y luego iniciará la geolocalización
                startGeolocation();
            } else {
                // Si el GPS real está desactivado (por defecto o por denegación previa)
                gpsModeStatusSpan.textContent = "GPS Desactivado (Modo Manual/Simulado)";
                locationStatusSpan.textContent = "GPS Desactivado.";
                locationStatusSpan.style.color = '#6c757d'; // Gris
                simulateProximityBtn.disabled = false; // Habilitar simulación
            }
            cargarSiguientePaso(); // Iniciar la aventura (cargar el primer audio/reto)
        });

        // NUEVO: Evento para aceptar los términos y condiciones
        acceptTermsBtn.addEventListener('click', () => {
            termsOverlay.style.display = 'none'; // Oculta la ventana de términos
            welcomeOverlay.style.display = 'flex'; // Muestra la pantalla de bienvenida
        });

        // Evento para el botón "Continuar con la Aventura"
        btnNextAfterReto.addEventListener('click', () => {
            currentStep++; // Avanzar al siguiente paso de la aventura
            cargarSiguientePaso();
            // Asegurarse de que el audio se detenga si se estaba reproduciendo
            sendMessageToAudioChild('pauseAudio');
            playPauseBtn.classList.remove('active');
        });

        // Toggle GPS real / simulación
        toggleGpsModeBtn.addEventListener('click', () => {
            gpsRealActivado = !gpsRealActivado;
            if (gpsRealActivado) {
                stopGeolocation(); // Detener si estaba simulando
                requestGeolocationPermission(); // Solicitar permiso y luego iniciar real
            } else {
                stopGeolocation(); // Detener el GPS real
                gpsModeStatusSpan.textContent = "GPS Desactivado (Modo Manual/Simulado)";
                locationStatusSpan.textContent = "GPS Desactivado.";
                locationStatusSpan.style.color = '#6c757d';
            }
            simulateProximityBtn.disabled = gpsRealActivado; // Habilitar/deshabilitar botón de simulación
            console.log(`Modo GPS: ${gpsRealActivado ? 'Real' : 'Manual/Simulado'}`);
            // Recargar el paso actual para aplicar el nuevo modo GPS
            cargarSiguientePaso();
        });

        // Simular proximidad al siguiente punto (solo para depuración)
        simulateProximityBtn.addEventListener('click', () => {
            if (currentStep < audioPuntosInteres.length && !gpsRealActivado) {
                const puntoSimulado = audioPuntosInteres[currentStep];
                // Simular estar justo en el punto de activación
                verificarProximidad(puntoSimulado.lat, puntoSimulado.lon);

                // Si hay un reto o puzzle manual para este punto, mostrarlo también
                const retosDelPunto = puzzlesPorPunto[puntoSimulado.id] || [];
                const retoManual = retosDelPunto.find(r => r.activacion === 'manual');
                if (retoManual && (puzzleIframe.style.display === 'none' || !puzzleIframe.style.display)) { // Solo si no hay un puzzle ya abierto
                    console.log(`Activando reto manual simulado para el punto ${puntoSimulado.id}: ${retoManual.src}`);
                    if (retoManual.tipo === 'reto') {
                        cargarReto(retoManual.src);
                    } else if (retoManual.tipo === 'puzzle') {
                        mostrarPuzzle(retoManual.src);
                    }
                }
            } else if (gpsRealActivado) {
                alert("La simulación de proximidad solo funciona con el GPS Real Desactivado.");
            } else {
                alert("No hay más puntos para simular o la aventura ha terminado.");
            }
        });

        // Manejar click del botón de Terminar Aventura
        terminarAventuraBtn.addEventListener('click', () => {
            if (confirm("¿Estás seguro de que quieres terminar la aventura?")) {
                alert("¡Gracias por jugar! Aventura finalizada.");
                window.location.reload(); // Recargar la página para reiniciar
            }
        });

        // Event listeners para los botones flotantes
        leftMenuBtn.addEventListener('click', showLeftMenu);
        rightMenuBtn.addEventListener('click', showRightMenu);
        fullScreenCloseBtn.addEventListener('click', hideFullScreenIframe);

        // Event listeners para las pestañas del menú izquierdo (ahora abren en pantalla completa)
        leftMenuContainer.querySelectorAll('.menu-tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const tabTarget = button.dataset.tabTarget;
                let urlToLoad = '';
                switch(tabTarget) {
                    case 'retosPuzzlesTab':
                        urlToLoad = 'retos_con_puzzles_Av1_es.html?modo=principal';
                        break;
                    case 'gastronomiaTab':
                        urlToLoad = 'Gastronomia.html';
                        break;
                    case 'paginasOficialesTab':
                        urlToLoad = 'paginas_oficiales.html';
                        break;
                    case 'videosHistoricosTab':
                        urlToLoad = 'enlaces_valencia_historica.html';
                        break;
                }
                if (urlToLoad) {
                    showContentInFullScreen(urlToLoad);
                }
            });
        });

        // Event listeners para las pestañas del menú derecho (ahora abren en pantalla completa)
        rightMenuContainer.querySelectorAll('.menu-tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const tabTarget = button.dataset.tabTarget;
                let urlToLoad = '';
                switch(tabTarget) {
                    case 'agradecimientosTab':
                        urlToLoad = 'Agradecimientos.html';
                        break;
                    case 'fuentesInfoTab':
                        // Aquí podrías cargar un HTML con las fuentes de información
                        urlToLoad = 'fuentes_informacion.html'; // Ejemplo de URL
                        break;
                    case 'consejosSeguridadTab':
                        urlToLoad = 'consejos_seguridad_vial.html';
                        break;
                }
                if (urlToLoad) {
                    showContentInFullScreen(urlToLoad);
                }
            });
        });

        // Función para el botón de play/pause del audio (en el padre)
        playPauseBtn.addEventListener('click', () => {
            if (!gpsRealActivado) { // Solo si el GPS real está desactivado
                if (playPauseBtn.classList.contains('active')) {
                    sendMessageToAudioChild('pauseAudio');
                    playPauseBtn.classList.remove('active');
                } else {
                    sendMessageToAudioChild('playAudio', { src: audioPuntosInteres[currentStep].audio });
                    playPauseBtn.classList.add('active');
                }
            } else {
                alert("El control de audio manual está deshabilitado con el GPS real activo. El audio se reproducirá por proximidad.");
            }
        });

        // --- Inicialización de la Página ---

        function initPage() {
            console.log("Página inicializada después de bienvenida.");
            requestGeolocationPermission(); // Solicitar permisos al cargar
        }

        // Mostrar la ventana de Términos y Condiciones al cargar la ventana
        window.addEventListener('load', () => {
            termsOverlay.style.display = 'flex'; // Asegura que los términos sean lo primero
            // Asegurarse de que el iframe de audio esté cargado para poder enviar mensajes
            audioIframe.style.display = 'block'; // Mostrar temporalmente para que se cargue, luego se oculta si no hay audio
            audioIframe.src = "audio_player_hijo.html"; // Asegúrate de que el src esté siempre cargado
            audioIframe.style.display = 'none'; // Ocultar después de cargarse
        });

        // Llamar a la función de inicialización cuando el DOM esté completamente cargado
        document.addEventListener('DOMContentLoaded', () => {
            // Asegurar que termsOverlay esté visible al inicio, y welcomeOverlay oculto.
            termsOverlay.style.display = 'flex';
            welcomeOverlay.style.display = 'none';
        });

    </script>
</body>
</html>
