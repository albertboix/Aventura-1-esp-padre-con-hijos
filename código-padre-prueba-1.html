<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aventura Padre - Control Orquesta</title>
    <style>
        /* Estilos b√°sicos para botones flotantes */
        body {
            margin: 0; font-family: Arial, sans-serif; background: #f0f0f0;
        }
        #appContainer {
            position: relative; min-height: 100vh;
            padding-bottom: 60px; /* espacio para botones flotantes */
        }

        /* Botones flotantes principales */
        .floating-btn {
            position: fixed;
            width: 50px; height: 50px;
            border-radius: 50%;
            background-color: #003366;
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center;
            font-size: 24px;
            z-index: 1100;
            transition: background-color 0.3s ease;
        }
        .floating-btn:hover {
            background-color: #0055aa;
        }
        #btn-hamburger {
            bottom: 80px;
            left: 20px;
        }
        #btn-three-dots {
            bottom: 80px;
            right: 20px;
        }
        #btn-map {
            bottom: 20px;
            right: 20px;
        }

        /* Botones desplegados del mapa */
        #mapDropdown {
            position: fixed;
            bottom: 80px;
            right: 20px;
            display: none;
            flex-direction: column;
            gap: 8px;
            z-index: 1150;
        }
        #mapDropdown button {
            width: 50px; height: 50px;
            border-radius: 50%;
            background-color: #004080;
            border: none;
            color: white;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center;
            transition: background-color 0.3s ease;
        }
        #mapDropdown button:hover {
            background-color: #0066cc;
        }

        /* Modal t√©rminos y condiciones */
        #termsConditionsModal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        #termsContent {
            background: white;
            max-width: 500px;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 0 15px rgba(0,0,0,0.4);
        }
        #acceptTermsBtn {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #004080;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }
        #acceptTermsBtn:hover {
            background-color: #0066cc;
        }

        /* Mensaje de estado GPS */
        #gpsStatusIndicator {
            position: fixed;
            bottom: 140px;
            left: 20px;
            padding: 8px 12px;
            background-color: #28a745; /* verde por defecto */
            color: white;
            border-radius: 4px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            user-select: none;
            cursor: default;
            z-index: 1100;
            transition: background-color 0.3s ease;
        }
        #gpsStatusIndicator.offline {
            background-color: #dc3545; /* rojo cuando GPS apagado o simulado */
        }

        /* Paneles desplegables (hamburguesa y tres puntos) */
        .side-panel {
            position: fixed;
            top: 0; bottom: 0;
            width: 300px;
            background: white;
            box-shadow: 2px 0 8px rgba(0,0,0,0.2);
            overflow-y: auto;
            z-index: 1500;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        .side-panel.open {
            transform: translateX(0);
        }
        #panel1 {
            left: 0;
        }
        #panel2 {
            right: 0;
            transform: translateX(100%);
        }
        #panel2.open {
            transform: translateX(0);
        }

        /* Bot√≥n cerrar panel */
        .close-panel-btn {
            display: block;
            text-align: right;
            padding: 10px;
            font-weight: bold;
            cursor: pointer;
            background: #003366;
            color: white;
        }
        .panel-content {
            padding: 15px;
        }

        /* Modal pantalla completa para pesta√±as y mapas */
        #fullscreenModal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            z-index: 3000;
            overflow: hidden;
        }
        #fullscreenContent {
            flex: 1;
            position: relative;
            background: #fff;
            overflow-y: auto;
            padding: 20px;
        }
        #fullscreenCloseBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: orange;
            color: navy;
            border: none;
            padding: 8px 12px;
            font-weight: bold;
            font-size: 20px;
            cursor: pointer;
            border-radius: 4px;
            z-index: 3100;
            box-shadow: 0 0 5px rgba(0,0,0,0.7);
        }

        /* Iframe fullscreen para contenido */
        #fullscreenIframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Imagen fullscreen para mapa bloqueado */
        #fullscreenImage {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: #001f3f;
        }

    </style>
</head>
<body>
    <div id="appContainer">
        <!-- Aqu√≠ estar√° el contenido principal de la app -->
        <!-- Podr√°s incluir mensajes de estado o info -->
        <div id="locationInfo" style="padding:10px; font-weight: bold;"></div>

        <!-- Iframes hijos se crean din√°micamente cuando se usen -->

        <!-- Panel izquierdo hamburguesa -->
        <div id="panel1" class="side-panel">
            <div class="close-panel-btn" id="closePanel1">X</div>
            <div class="panel-content">
                <h2>Men√∫</h2>
                <button id="tabBtnTextoAventuras">Texto Aventuras</button><br />
                <button id="tabBtnTextoLecturaFacil">Texto Lectura F√°cil</button><br />
                <button id="tabBtnAgradecimientos">Agradecimientos</button><br />
                <button id="tabBtnFuentesInfo">Fuentes e Informaci√≥n</button><br />
                <button id="tabBtnGastronomia">Gastronom√≠a</button><br />
                <button id="tabBtnConsejosSeguridad">Consejos Seguridad Vial</button><br />
            </div>
        </div>

        <!-- Panel derecho tres puntos -->
        <div id="panel2" class="side-panel">
            <div class="close-panel-btn" id="closePanel2">X</div>
            <div class="panel-content">
                <h2>Recursos</h2>
                <button id="tabBtnRetos">Retos y Puzzles</button><br />
                <button id="tabBtnEnlacesHistoricos">Enlaces Hist√≥ricos</button><br />
                <button id="tabBtnPaginasOficiales">P√°ginas Oficiales</button><br />
            </div>
        </div>

        <!-- Bot√≥n Prueba en casa (estado GPS) -->
        <div id="gpsStatusIndicator" title="Estado del GPS: verde=normal, rojo=simulaci√≥n o desconectado">
            GPS: OK
        </div>

        <!-- Botones flotantes principales -->
        <button class="floating-btn" id="btn-hamburger" title="Men√∫ ‚ò∞">&#9776;</button>
        <button class="floating-btn" id="btn-three-dots" title="Recursos ‚ãÆ">&#8942;</button>
        <button class="floating-btn" id="btn-map" title="Mapa üó∫Ô∏è">üó∫Ô∏è</button>

        <!-- Botones desplegables para mapa -->
        <div id="mapDropdown">
            <button id="btn-map-pin" title="Mostrar mapa con localizaciones üìç">üìç</button>
            <button id="btn-map-adventure" title="Mostrar mapa aventura completa üó∫Ô∏è">üó∫Ô∏è</button>
            <button id="btn-map-compass" title="Mostrar mapa orientaci√≥n üß≠">üß≠</button>
        </div>
    </div>

    <!-- Modal T√©rminos y Condiciones -->
    <div id="termsConditionsModal">
        <div id="termsContent">
            <h2>T√©rminos y Condiciones</h2>
            <iframe src="terminos_y_condiciones.html" style="width: 100%; height: 300px; border:none;"></iframe>
            <button id="acceptTermsBtn">Acepto los t√©rminos y condiciones</button>
        </div>
    </div>

    <!-- Modal pantalla completa para pesta√±as y mapas -->
    <div id="fullscreenModal">
        <button id="fullscreenCloseBtn">X</button>
        <div id="fullscreenContent">
            <iframe id="fullscreenIframe" src="" allowfullscreen></iframe>
            <img id="fullscreenImage" src="" alt="Mapa Bloqueado" style="display:none;" />
        </div>
    </div>

    <script>
        // Variables de estado global
        let adventureStarted = false;
        let gpsPermisoConcedido = false;
        let audioHijoListo = false;
        let retoHijoListo = false;
        let currentStepIndex = 0;
        let audioPlayerIsPlaying = false;
        let currentAudioCanPlay = false;

        // Referencias DOM
        const appContainer = document.getElementById('appContainer');
        const termsConditionsModal = document.getElementById('termsConditionsModal');
        const acceptTermsBtn = document.getElementById('acceptTermsBtn');
        const gpsStatusIndicator = document.getElementById('gpsStatusIndicator');

        const btnHamburger = document.getElementById('btn-hamburger');
        const btnThreeDots = document.getElementById('btn-three-dots');
        const btnMap = document.getElementById('btn-map');

        const mapDropdown = document.getElementById('mapDropdown');
        const btnMapPin = document.getElementById('btn-map-pin');
        const btnMapAdventure = document.getElementById('btn-map-adventure');
        const btnMapCompass = document.getElementById('btn-map-compass');

        const panel1 = document.getElementById('panel1');
        const panel2 = document.getElementById('panel2');
        const closePanel1 = document.getElementById('closePanel1');
        const closePanel2 = document.getElementById('closePanel2');

        const fullscreenModal = document.getElementById('fullscreenModal');
        const fullscreenCloseBtn = document.getElementById('fullscreenCloseBtn');
        const fullscreenIframe = document.getElementById('fullscreenIframe');
        const fullscreenImage = document.getElementById('fullscreenImage');

        // Variables iframe hijos (se crear√°n cuando se usen)
        let iframeAudio = null;
        let iframeRetos = null;
        let iframeCoordenadas = null;

        // Mostrar / ocultar paneles hamburguesa y tres puntos
        btnHamburger.addEventListener('click', () => {
            if(panel1.classList.contains('open')) {
                panel1.classList.remove('open');
            } else {
                panel1.classList.add('open');
                panel2.classList.remove('open');
                mapDropdown.style.display = 'none'; // esconder men√∫ mapa si estaba abierto
            }
        });

        btnThreeDots.addEventListener('click', () => {
            if(panel2.classList.contains('open')) {
                panel2.classList.remove('open');
            } else {
                panel2.classList.add('open');
                panel1.classList.remove('open');
                mapDropdown.style.display = 'none'; // esconder men√∫ mapa si estaba abierto
            }
        });

        closePanel1.addEventListener('click', () => {
            panel1.classList.remove('open');
        });
        closePanel2.addEventListener('click', () => {
            panel2.classList.remove('open');
        });

        // Mapa desplegable al pulsar btnMap
        btnMap.addEventListener('click', () => {
            if(mapDropdown.style.display === 'flex') {
                mapDropdown.style.display = 'none';
            } else {
                mapDropdown.style.display = 'flex';
                panel1.classList.remove('open');
                panel2.classList.remove('open');
            }
        });

        // Cerrar fullscreen
        fullscreenCloseBtn.addEventListener('click', () => {
            cerrarFullscreen();
        });

        // Botones desplegables del mapa
        btnMapPin.addEventListener('click', () => {
            abrirMapaLeaflet('pin');
        });
        btnMapAdventure.addEventListener('click', () => {
            abrirMapaLeaflet('adventure');
        });
        btnMapCompass.addEventListener('click', () => {
            abrirMapaImagen();
        });

        // Funci√≥n para abrir el mapa con Leaflet seg√∫n tipo
        function abrirMapaLeaflet(tipo) {
            mapDropdown.style.display = 'none';
            // Carga una p√°gina interna con mapa Leaflet para evitar c√≥digo complejo aqu√≠
            // Le pasamos tipo por query param para que Av1-coordenadas.html filtre paradas o todas las paradas

            // Suponemos que hay un archivo: mapas/mapa_leaflet.html que recibe ?tipo=pin o ?tipo=adventure
            fullscreenIframe.style.display = 'block';
            fullscreenImage.style.display = 'none';
            fullscreenIframe.src = `mapas/mapa_leaflet.html?tipo=${tipo}`;
            fullscreenModal.style.display = 'flex';
        }

        // Funci√≥n para abrir la imagen mapa bloqueado
        function abrirMapaImagen() {
            mapDropdown.style.display = 'none';
            fullscreenIframe.style.display = 'none';
            fullscreenImage.style.display = 'block';
            fullscreenImage.src = 'mapas/Av1_mapa.jpg';
            fullscreenModal.style.display = 'flex';
        }

        // Funci√≥n para cerrar fullscreen
        function cerrarFullscreen() {
            fullscreenModal.style.display = 'none';
            fullscreenIframe.src = '';
            fullscreenImage.src = '';
        }

        // Estado GPS simulado o real
        function actualizarEstadoGPS(estadoOk) {
            if(estadoOk) {
                gpsStatusIndicator.classList.remove('offline');
                gpsStatusIndicator.textContent = 'GPS: OK';
            } else {
                gpsStatusIndicator.classList.add('offline');
                gpsStatusIndicator.textContent = 'GPS: SIMULADO';
            }
        }

        // --- T√©rminos y condiciones ---
        acceptTermsBtn.addEventListener('click', () => {
            termsConditionsModal.style.display = 'none';
            adventureStarted = true;
            iniciarAventura();
        });

        // Aqu√≠ iniciar√≠as la l√≥gica de la aventura
        function iniciarAventura() {
            console.log("Aventura iniciada");
            // Por ejemplo: crear iframe Av1-coordenadas.html
            cargarIframeCoordenadas();
            // Podr√≠as pedir permisos GPS aqu√≠ o simularlos
            detectarGPS();
        }

        // Crear iframe coordenadas
        function cargarIframeCoordenadas() {
            if(iframeCoordenadas) return; // Ya creado

            iframeCoordenadas = document.createElement('iframe');
            iframeCoordenadas.src = 'Av1-coordenadas.html';
            iframeCoordenadas.style.display = 'none'; // oculto
            iframeCoordenadas.id = 'iframe-coordenadas';
            document.body.appendChild(iframeCoordenadas);
        }

        // Funci√≥n simulada detecci√≥n GPS (puedes usar Geolocation API real)
        function detectarGPS() {
            // Aqu√≠ puedes poner l√≥gica real, por ahora simulamos OK
            actualizarEstadoGPS(true);
        }

        // Escuchar mensajes postMessage de iframes hijos
        window.addEventListener('message', (event) => {
            // Validar origen o contenido seg√∫n convenga (omito para ejemplo)
            const data = event.data;

            if(!data || typeof data !== 'object') return;

            switch(data.type) {
                case 'estadoGPS':
                    actualizarEstadoGPS(data.estadoOk);
                    break;
                case 'activarPlay':
                    // Activar bot√≥n play para coordenada X
                    activarBotonPlay(data.coordenadaId);
                    break;
                case 'audioTerminado':
                    // Mostrar ventana flotante "Resuelva su reto"
                    mostrarRetoModal();
                    break;
                case 'retoCompletado':
                    // Volver a coordenadas para siguiente punto
                    avanzarSiguientePunto();
                    break;
                default:
                    console.warn('Mensaje desconocido recibido:', data);
            }
        });

        // Funciones para activar bot√≥n play, mostrar reto, avanzar paso...
        function activarBotonPlay(coordenadaId) {
            console.log('Activar bot√≥n play para:', coordenadaId);
            // Aqu√≠ puedes actualizar UI o habilitar un bot√≥n para reproducir audio
            // Por ahora directamente lanzo la reproducci√≥n para ejemplo
            reproducirAudioParaCoordenada(coordenadaId);
        }

        function reproducirAudioParaCoordenada(coordenadaId) {
            if(iframeAudio) {
                document.body.removeChild(iframeAudio);
                iframeAudio = null;
            }
            iframeAudio = document.createElement('iframe');
            iframeAudio.src = `Av1_audio_esp.html?coordenada=${encodeURIComponent(coordenadaId)}`;
            iframeAudio.style.display = 'none';
            iframeAudio.id = 'iframe-audio';
            document.body.appendChild(iframeAudio);

            audioPlayerIsPlaying = true;
        }

        function mostrarRetoModal() {
            if(iframeRetos) {
                document.body.removeChild(iframeRetos);
                iframeRetos = null;
            }
            iframeRetos = document.createElement('iframe');
            iframeRetos.src = 'Av1-esp-retos-preguntas.html';
            iframeRetos.style.position = 'fixed';
            iframeRetos.style.top = '50%';
            iframeRetos.style.left = '50%';
            iframeRetos.style.transform = 'translate(-50%, -50%)';
            iframeRetos.style.width = '90%';
            iframeRetos.style.height = '80%';
            iframeRetos.style.border = '4px solid orange';
            iframeRetos.style.zIndex = '4000';
            document.body.appendChild(iframeRetos);
        }

        function avanzarSiguientePunto() {
            console.log('Avanzar al siguiente punto en Av1-coordenadas');
            // Aqu√≠ le indicamos a iframeCoordenadas que debe actualizar el punto
            if(iframeCoordenadas) {
                iframeCoordenadas.contentWindow.postMessage({ type: 'siguientePunto' }, '*');
            }
        }

        // Listeners para botones de panel1 (hamburguesa) y panel2 (tres puntos)

        // Panel 1 (hamburguesa)
        document.getElementById('tabBtnTextoAventuras').addEventListener('click', () => {
            showFullscreenTabContent('', true); // Cartel EN DESARROLLO
        });
        document.getElementById('tabBtnTextoLecturaFacil').addEventListener('click', () => {
            showFullscreenTabContent('', true); // Cartel EN DESARROLLO
        });
        document.getElementById('tabBtnAgradecimientos').addEventListener('click', () => {
            showFullscreenTabContent('Agradecimientos.html', false);
        });
        document.getElementById('tabBtnFuentesInfo').addEventListener('click', () => {
            showFullscreenTabContent('', true); // Cartel EN DESARROLLO
        });
        document.getElementById('tabBtnGastronomia').addEventListener('click', () => {
            showFullscreenTabContent('Gastronomia.html', false);
        });
        document.getElementById('tabBtnConsejosSeguridad').addEventListener('click', () => {
            showFullscreenTabContent('consejos_seguridad_vial.html', false);
        });

        // Panel 2 (tres puntos)
        document.getElementById('tabBtnRetos').addEventListener('click', () => {
            showFullscreenTabContent('Av1-esp-retos-preguntas.html', false);
        });
        document.getElementById('tabBtnEnlacesHistoricos').addEventListener('click', () => {
            showFullscreenTabContent('', true); // Cartel EN DESARROLLO
        });
        document.getElementById('tabBtnPaginasOficiales').addEventListener('click', () => {
            showFullscreenTabContent('', true); // Cartel EN DESARROLLO
        });

        // Funci√≥n para mostrar contenido en modal fullscreen con iframe
        // Si enDesarrollo = true, muestra cartel "EN DESARROLLO"
        function showFullscreenTabContent(url, enDesarrollo) {
            if (enDesarrollo) {
                fullscreenIframe.style.display = 'none';
                fullscreenImage.style.display = 'block';
                fullscreenImage.src = 'mapas/en_desarrollo.jpg'; // Imagen cartel desarrollo
            } else {
                fullscreenImage.style.display = 'none';
                fullscreenIframe.style.display = 'block';
                fullscreenIframe.src = url;
            }
            fullscreenModal.style.display = 'flex';
            mapDropdown.style.display = 'none';
            panel1.classList.remove('open');
            panel2.classList.remove('open');
        }

        // Iniciar app mostrando modal t√©rminos y condiciones
        window.onload = () => {
            termsConditionsModal.style.display = 'flex';
        };
    </script>
</body>
</html>
