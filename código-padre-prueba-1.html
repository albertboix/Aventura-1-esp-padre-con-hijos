<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Padre - Mapa Leaflet con Comunicación Hijo</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  #mapa { height: 400px; }
  #fuegos { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; }
  #reto, #respuestaCorrectaTexto, #btnMostrarRespuesta, #btnNextAfterReto {
    margin: 10px 0;
  }
  #btnMostrarRespuesta, #btnNextAfterReto {
    cursor: pointer;
    padding: 5px 15px;
    border-radius: 5px;
    border: none;
    background-color: #007bff;
    color: white;
  }
  #btnMostrarRespuesta:hover, #btnNextAfterReto:hover {
    background-color: #0056b3;
  }
  #btnEnviar {
    cursor: pointer;
    padding: 5px 15px;
    border-radius: 5px;
    border: none;
    background-color: #28a745;
    color: white;
    margin-top: 10px;
  }
  #btnEnviar:disabled {
    background-color: #94d3a2;
    cursor: not-allowed;
  }
  .correct { border: 2px solid green; padding: 10px; }
  .incorrect { border: 2px solid red; padding: 10px; }
  .respuesta { margin: 5px 0; }
  .puzzle-active iframe { width: 100%; height: 400px; border: none; }
</style>
</head>
<body>

<h2>Mapa y Retos</h2>
<div id="mapa"></div>

<h3>Hijo (iframe):</h3>
<iframe id="iframeHijo" src="hijo.html" style="width:100%; height:300px; border: 1px solid #ccc;"></iframe>

<div id="reto"></div>
<button id="btnMostrarRespuesta">Mostrar Respuesta</button>
<div id="respuestaCorrectaTexto" style="display:none; font-weight:bold; margin-top:10px;"></div>
<button id="btnNextAfterReto">Siguiente Reto</button>

<div id="fuegos"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // Variables globales
  const mapa = L.map('mapa').setView([39.47, -0.38], 14); // Ajusta coordenadas iniciales
  let marcadorActual = null;
  const iframeHijo = document.getElementById('iframeHijo');

  // Cargar mapa Leaflet con tile layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
  }).addTo(mapa);

  // Datos de paradas y sus coordenadas y audios y preguntas (ejemplo)
  const paradasData = {
    torres_serranos: {
      coords: [39.4791, -0.3767],
      audio: 'Av1_audio_esp/02 Intro ESPAÑOL 2.mp3',
      preguntaId: 2
    },
    plaza_de_la_crida: {
      coords: [39.4763, -0.3821],
      audio: 'Av1_audio_esp/03 Av1 Pista 3 ESPAÑOL.mp3',
      preguntaId: 3
    }
  };

  // Referencias DOM
  const retoDiv = document.getElementById('reto');
  const btnEnviar = document.createElement('button');
  btnEnviar.textContent = 'Enviar';
  btnEnviar.id = 'btnEnviar';
  btnEnviar.style.display = 'none';

  const btnMostrarRespuesta = document.getElementById('btnMostrarRespuesta');
  const divRespuestaCorrecta = document.getElementById('respuestaCorrectaTexto');
  const btnNext = document.getElementById('btnNextAfterReto');

  // Simulación retos base (agrega tus retos aquí)
  const retos = [
    {}, // índice 0 vacío porque empieza en 2 (según el ejemplo)
    {},
    {
      tipo: "opcion",
      pregunta: "2. ¿Qué sostiene el niño en sus manos?",
      opciones: ["Una paloma", "Una Concha", "Alimentos"],
      correctas: ["Una Concha"],
      multiple: false,
    },
    {
      tipo: "opcion",
      pregunta: "3. ¿Dónde está ubicada la Plaza de la Crida?",
      opciones: ["Centro histórico", "Zona moderna", "Parque central"],
      correctas: ["Centro histórico"],
      multiple: false,
    }
  ];

  let indiceRetoActual = null; // Para controlar reto actual

  // Función para mostrar reto
  function mostrarReto(indice) {
    if (!retos[indice]) {
      retoDiv.textContent = 'No hay reto disponible.';
      btnEnviar.style.display = 'none';
      btnMostrarRespuesta.style.display = 'none';
      btnNext.style.display = 'none';
      divRespuestaCorrecta.style.display = 'none';
      return;
    }

    const reto = retos[indice];
    retoDiv.innerHTML = '';
    divRespuestaCorrecta.style.display = 'none';
    divRespuestaCorrecta.textContent = '';
    btnNext.style.display = 'none';

    const preguntaElem = document.createElement('h3');
    preguntaElem.textContent = reto.pregunta;
    retoDiv.appendChild(preguntaElem);

    if (reto.tipo === 'opcion' || reto.tipo === 'opcion-multiple') {
      const tipoInput = reto.multiple ? 'checkbox' : 'radio';

      reto.opciones.forEach((op, i) => {
        const divOpcion = document.createElement('div');
        divOpcion.className = 'respuesta';
        const input = document.createElement('input');
        input.type = tipoInput;
        input.name = 'op';
        input.id = 'opcion' + i;
        input.value = op;

        const label = document.createElement('label');
        label.htmlFor = input.id;
        label.textContent = op;

        divOpcion.appendChild(input);
        divOpcion.appendChild(label);
        retoDiv.appendChild(divOpcion);
      });

      retoDiv.appendChild(btnEnviar);
      btnEnviar.style.display = 'inline-block';
      btnEnviar.disabled = false;
    } else {
      retoDiv.textContent = 'Tipo de reto no soportado.';
      btnEnviar.style.display = 'none';
    }

    indiceRetoActual = indice;
  }

  // Función para verificar respuesta
  function verificar() {
    const reto = retos[indiceRetoActual];
    btnEnviar.disabled = true;
    divRespuestaCorrecta.style.display = 'none';
    divRespuestaCorrecta.textContent = '';
    retoDiv.classList.remove('correct', 'incorrect');

    let esCorrecto = false;

    if (reto.tipo === 'opcion') {
      const seleccion = document.querySelector('input[name="op"]:checked');
      if (!seleccion) {
        alert('Por favor, seleccione una opción.');
        btnEnviar.disabled = false;
        return;
      }
      esCorrecto = reto.correctas.includes(seleccion.value);
    } else if (reto.tipo === 'opcion-multiple') {
      const seleccionadas = Array.from(document.querySelectorAll('input[name="op"]:checked')).map(i => i.value);
      if (seleccionadas.length === 0) {
        alert('Por favor, seleccione al menos una opción.');
        btnEnviar.disabled = false;
        return;
      }
      esCorrecto = reto.correctas.every(c => seleccionadas.includes(c)) && seleccionadas.every(s => reto.correctas.includes(s));
    }

    if (esCorrecto) {
      retoDiv.classList.add('correct');
      activarFuegosArtificiales();
      btnNext.style.display = 'inline-block';
      btnMostrarRespuesta.style.display = 'inline-block';
      btnEnviar.style.display = 'none';
    } else {
      retoDiv.classList.add('incorrect');
      navigator.vibrate?.(300);
      btnEnviar.disabled = false;
      btnMostrarRespuesta.style.display = 'inline-block';
    }
  }

  btnEnviar.addEventListener('click', verificar);

  btnMostrarRespuesta.addEventListener('click', () => {
    if (indiceRetoActual && retos[indiceRetoActual]) {
      divRespuestaCorrecta.textContent = 'Respuesta correcta: ' + retos[indiceRetoActual].correctas.join(', ');
      divRespuestaCorrecta.style.display = 'block';
    }
  });

  btnNext.addEventListener('click', () => {
    if (indiceRetoActual) {
      indiceRetoActual++;
      mostrarReto(indiceRetoActual);
    }
  });

  // Función fuegos artificiales (puedes usar la tuya)
  const fuegosDiv = document.getElementById('fuegos');
  const DURACION_TOTAL_MS = 3000;

  function activarFuegosArtificiales() {
    fuegosDiv.innerHTML = '';
    fuegosDiv.style.display = 'block';

    const NUM_CHISPAS = 30;
    const NUM_EXPLOSIONES = 15;

    for (let e = 0; e < NUM_EXPLOSIONES; e++) {
      setTimeout(() => {
        const w = fuegosDiv.offsetWidth || window.innerWidth;
        const h = fuegosDiv.offsetHeight || window.innerHeight;
        const startX = Math.random() * w;
        const startY = Math.random() * h;

        for (let i = 0; i < NUM_CHISPAS; i++) {
          const chispa = document.createElement('div');
          chispa.style.position = 'absolute';
          chispa.style.borderRadius = '50%';
          chispa.style.backgroundColor = `hsl(${Math.floor(Math.random() * 360)}, 100%, 70%)`;
          chispa.style.width = '5px';
          chispa.style.height = '5px';
          chispa.style.left = `${startX}px`;
          chispa.style.top = `${startY}px`;
          chispa.style.opacity = 1;
          chispa.style.pointerEvents = 'none';

          fuegosDiv.appendChild(chispa);

          setTimeout(() => {
            chispa.style.transition = 'all 1s ease-out';
            const angle = Math.random() * 2 * Math.PI;
            const radius = 100 + Math.random() * 50;
            const newX = startX + radius * Math.cos(angle);
            const newY = startY + radius * Math.sin(angle);
            chispa.style.left = `${newX}px`;
            chispa.style.top = `${newY}px`;
            chispa.style.opacity = 0;
          }, 50);

          setTimeout(() => {
            chispa.remove();
          }, 1050);
        }
      }, e * (DURACION_TOTAL_MS / NUM_EXPLOSIONES));
    }

    setTimeout(() => {
      fuegosDiv.style.display = 'none';
      fuegosDiv.innerHTML = '';
    }, DURACION_TOTAL_MS);
  }

  // Función para añadir marcador en Leaflet
  function agregarMarcador(paradaId) {
    if (marcadorActual) {
      mapa.removeLayer(marcadorActual);
    }
    const parada = paradasData[paradaId];
    if (!parada) return;

    marcadorActual = L.marker(parada.coords).addTo(mapa);
    mapa.setView(parada.coords, 16);
  }

  // Comunicación con hijo
  window.addEventListener('message', (event) => {
    const data = event.data;
    if (!data || !data.type) return;

    if (data.type === 'parada-click') {
      const paradaId = data.paradaId;
      agregarMarcador(paradaId);

      // Enviar al hijo que reproduzca el audio y active play
      const parada = paradasData[paradaId];
      if (!parada) return;

      iframeHijo.contentWindow.postMessage({
        type: 'play-audio',
        audioSrc: parada.audio,
        preguntaId: parada.preguntaId,
        paradaId: paradaId
      }, '*');
    } else if (data.type === 'audio-ended') {
      // Cambiar icono puzzle en hijo (mandar mensaje si quieres, aquí sólo log)
      console.log('Audio terminado para pregunta', data.preguntaId);

      // Aquí activar puzzle en padre (podrías cambiar UI o similar)
      activarIconoPuzzle(data.paradaId);

      // Ejecutar reto correspondiente
      mostrarReto(data.preguntaId);
    }
  });

  // Función para activar icono puzzle (puedes extender para que cambie icono en el iframe o padre)
  function activarIconoPuzzle(paradaId) {
    // Por ejemplo, mandar mensaje a iframe para activar puzzle (cambiar fondo rojo a verde)
    iframeHijo.contentWindow.postMessage({
      type: 'activar-puzzle',
      paradaId
    }, '*');
  }

</script>
</body>
</html>
