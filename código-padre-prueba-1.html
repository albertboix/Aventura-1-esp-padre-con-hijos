<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aventura en Val√®ncia</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }
    #mapa {
      height: 100%;
      width: 100%;
    }
    iframe {
      width: 0;
      height: 0;
      border: none;
      position: absolute;
      z-index: -1;
    }
    .boton-flotante {
      position: fixed;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 24px;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
    }
    #hamburguesa { bottom: 20px; left: 20px; }
    #mas-opciones { bottom: 20px; right: 20px; }
    #btn-mapa { top: 20px; right: 20px; }
    #gps-prueba {
      top: 20px;
      left: 20px;
      width: auto;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 14px;
      position: fixed;
      user-select: none;
      font-weight: bold;
    }
    /* Paneles hamburguesa y tres puntos animados */
    .panel {
      position: fixed;
      background: white;
      color: black;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      z-index: 1100;
      width: 75vw;
      height: 75vh;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      opacity: 0;
      display: flex;
      flex-direction: column;
      padding: 20px;
      gap: 1rem;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .panel.abierto {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
      display: flex;
    }
    .panel iframe {
      flex: 1;
      border: none;
      border-radius: 6px;
      width: 100%;
    }
    .cerrar-panel {
      align-self: flex-end;
      background: #007BFF;
      color: white;
      font-weight: bold;
      font-size: 20px;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
    }
    .submenu {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 10px;
    }
    .submenu button {
      font-size: 18px;
      background: transparent;
      border: none;
      text-align: left;
      cursor: pointer;
      user-select: none;
      padding: 8px 12px;
      border-radius: 8px;
      transition: background-color 0.2s ease;
    }
    .submenu button:hover {
      background-color: #e0e0ff;
    }
    /* Bot√≥n tierra - men√∫ vertical con fondo azul redondo */
    #menu-mapa {
      position: fixed;
      top: 80px;
      right: 20px;
      display: none;
      flex-direction: column;
      gap: 12px;
      z-index: 1150;
      user-select: none;
    }
    #menu-mapa button {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: #007BFF;
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
      transition: background-color 0.2s ease;
    }
    #menu-mapa button:hover {
      background-color: #005bb5;
    }
    /* Panel imagen br√∫jula fullscreen */
    #imagen-full {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: black;
      z-index: 13000;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #imagen-full img {
      max-width: 100%;
      max-height: 100%;
      touch-action: none;
      cursor: grab;
      user-select: none;
    }
    #imagen-full img:active {
      cursor: grabbing;
    }
    #btn-cerrar-imagen {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      padding: 6px 12px;
      cursor: pointer;
      user-select: none;
      z-index: 13001;
    }
  </style>
</head>
<body>
  <div id="mapa"></div>
  <iframe id="hijo" src="Av1-coordenadas.html"></iframe>

  <button id="hamburguesa" class="boton-flotante" title="Men√∫ Hamburguesa">‚ò∞</button>
  <button id="mas-opciones" class="boton-flotante" title="M√°s Opciones">‚ãÆ</button>
  <button id="btn-mapa" class="boton-flotante" title="Mapa Tierra">üåç</button>
  <button id="gps-prueba" style="background: red;">Modo casa OFF</button>

  <!-- Paneles hamburguesa y tres puntos -->
  <div id="panel-hamburguesa" class="panel">
    <button class="cerrar-panel" onclick="cerrarPanel()">X</button>
    <div class="submenu">
      <button onclick="cargar('retos_con_puzzles_Av1_es.html')">1 Retos y Puzzles</button>
      <button onclick="cargar('Gastronomia.html')">2 Gastronom√≠a</button>
      <button onclick="cargar('paginas_oficiales.html')">3 P√°ginas Oficiales</button>
      <button onclick="cargar('enlaces_valencia_historica.html')">4 Val√®ncia Hist√≥rica</button>
    </div>
  </div>

  <div id="panel-trespuntos" class="panel">
    <button class="cerrar-panel" onclick="cerrarPanel()">X</button>
    <div class="submenu">
      <button onclick="cargar('Agradecimientos.html')">1 Agradecimientos</button>
      <button onclick="cargar('consejos_seguridad_vial.html')">2 Consejos y Seguridad</button>
      <button>3 Fuentes (en desarrollo)</button>
    </div>
  </div>

  <!-- Men√∫ vertical bot√≥n tierra -->
  <div id="menu-mapa">
    <button title="Siguiente Punto" onclick="enviarMensajeAlIframe({ tipo: 'mostrar_siguiente' })">üìç</button>
    <button title="Ruta Completa" onclick="enviarMensajeAlIframe({ tipo: 'mostrar_ruta' })">üó∫Ô∏è</button>
    <button title="Br√∫jula" onclick="mostrarImagen()">üß≠</button>
  </div>

  <!-- Imagen br√∫jula fullscreen -->
  <div id="imagen-full">
    <button id="btn-cerrar-imagen" title="Cerrar Imagen">X</button>
    <img id="imagen-brujula" src="mapas/Av1_mapa.jpg" alt="Br√∫jula" />
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Librer√≠a panzoom para zoom y paneo imagen -->
  <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@9.4.0/dist/panzoom.min.js"></script>

  <script>
    const mapa = L.map('mapa').setView([39.4699, -0.3763], 14); // Valencia
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(mapa);

    let modoCasaActivo = false;

    const btnGps = document.getElementById('gps-prueba');
    const iframeHijo = document.getElementById('hijo');
    const menuMapa = document.getElementById('menu-mapa');
    const panelHamburguesa = document.getElementById('panel-hamburguesa');
    const panelTresPuntos = document.getElementById('panel-trespuntos');
    const btnMapa = document.getElementById('btn-mapa');
    const btnHamburguesa = document.getElementById('hamburguesa');
    const btnMasOpciones = document.getElementById('mas-opciones');

    function actualizarBotonGps() {
      if (modoCasaActivo) {
        btnGps.textContent = "Modo casa ON";
        btnGps.style.backgroundColor = "green";
      } else {
        btnGps.textContent = "Modo casa OFF";
        btnGps.style.backgroundColor = "red";
      }
    }

    btnGps.addEventListener('click', () => {
      modoCasaActivo = !modoCasaActivo;
      actualizarBotonGps();
      iframeHijo.contentWindow.postMessage({ tipo: 'gps_modo', activo: modoCasaActivo }, '*');
    });

    actualizarBotonGps();

    // Panel hamburguesa y tres puntos con animaci√≥n y exclusividad
    function cerrarPanel() {
      panelHamburguesa.classList.remove('abierto');
      panelTresPuntos.classList.remove('abierto');
    }
    btnHamburguesa.onclick = () => {
      if (panelHamburguesa.classList.contains('abierto')) {
        cerrarPanel();
      } else {
        panelTresPuntos.classList.remove('abierto');
        panelHamburguesa.classList.add('abierto');
      }
    };
    btnMasOpciones.onclick = () => {
      if (panelTresPuntos.classList.contains('abierto')) {
        cerrarPanel();
      } else {
        panelHamburguesa.classList.remove('abierto');
        panelTresPuntos.classList.add('abierto');
      }
    };

    // Men√∫ mapa vertical con botones azules redondos (solo iconos)
    btnMapa.onclick = () => {
      const abierto = menuMapa.style.display === 'flex';
      if (abierto) {
        menuMapa.style.display = 'none';
      } else {
        cerrarPanel();
        menuMapa.style.display = 'flex';
      }
    };

    // Si se abre men√∫ mapa, cerramos hamburguesa y tres puntos, y viceversa
    [btnHamburguesa, btnMasOpciones].forEach(btn => {
      btn.addEventListener('click', () => {
        menuMapa.style.display = 'none';
      });
    });
    btnMapa.addEventListener('click', () => {
      panelHamburguesa.classList.remove('abierto');
      panelTresPuntos.classList.remove('abierto');
    });

    // Enviar mensaje al iframe
    function enviarMensajeAlIframe(mensaje) {
      iframeHijo.contentWindow.postMessage(mensaje, '*');
    }

    // Funci√≥n mostrar imagen br√∫jula fullscreen + zoom + bloqueo orientaci√≥n
    const imagenFull = document.getElementById('imagen-full');
    const imgBrujula = document.getElementById('imagen-brujula');
    const btnCerrarImagen = document.getElementById('btn-cerrar-imagen');
    let panzoomInstance = null;

    function mostrarImagen() {
      cerrarPanel();
      menuMapa.style.display = 'none';
      imagenFull.style.display = 'flex';

      // Lock orientation if possible
      if (screen.orientation && screen.orientation.lock) {
        screen.orientation.lock('portrait').catch(() => {
          // Fail silently if no permission
        });
      }

      // Inicializar panzoom
      if (!panzoomInstance) {
        panzoomInstance = Panzoom(imgBrujula, {
          maxScale: 5,
          minScale: 1,
          contain: 'outside',
        });
        imgBrujula.parentElement.addEventListener('wheel', panzoomInstance.zoomWithWheel);
      }
    }
    btnCerrarImagen.onclick = () => {
      imagenFull.style.display = 'none';
      if (screen.orientation && screen.orientation.unlock) {
        screen.orientation.unlock();
      }
    };

    // Funci√≥n cargar en iframe con url pasada
    function cargar(url) {
      iframeHijo.src = url;
      cerrarPanel();
      menuMapa.style.display = 'none';
    }
  </script>
</body>
</html>
