<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>App Padre Mejorada</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    #mapa {
      height: 100vh;
      width: 100vw;
    }

    .boton-flotante-grande, .boton-flotante {
      position: fixed;
      background: #007acc;
      color: white;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      font-size: 2.4rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      user-select: none;
      z-index: 12000;
    }

    #hamburguesa {
      bottom: 15px;
      left: 15px;
    }

    #mas-opciones {
      bottom: 15px;
      right: 15px;
    }

    #btn-mapa {
      top: 15px;
      right: 15px;
    }

    #gps-prueba {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 13000;
      width: 130px;
      height: 40px;
      font-size: 1rem;
      border-radius: 6px;
      text-align: center;
      background: red;
      color: white;
      cursor: pointer;
      user-select: none;
    }

    /* Panels for pesta√±as */
    .panel {
      position: fixed;
      background: transparent; /* Fondo transparente para ver mapa detr√°s */
      color: black;
      z-index: 13000;
      display: none;
      flex-direction: column;
      padding: 10px 0;
      overflow-y: visible;
      user-select: none;
    }

    #panel-hamburguesa, #panel-trespuntos {
      bottom: 80px; /* Por encima de botones flotantes inferiores */
      max-height: 50vh;
      width: 200px;
    }

    #panel-hamburguesa {
      left: 15px;
    }

    #panel-trespuntos {
      right: 15px;
    }

    /* Panel mapa (tierra) debajo del bot√≥n */
    #panel-mapa {
      top: 75px;
      right: 15px;
      width: 60px;
      display: none;
      flex-direction: column;
      gap: 10px;
      user-select: none;
    }

    /* Pesta√±as individuales */
    .submenu button {
      font-size: 1.4rem;
      background: #f0f0f0;
      border: none;
      padding: 12px 16px;
      text-align: left;
      cursor: pointer;
      color: #007acc;
      user-select: none;
      border-radius: 8px;
      margin: 5px 0;
      transition: background-color 0.3s ease, opacity 0.3s ease, transform 0.3s ease;
      opacity: 0;
      transform: translateY(20px);
    }

    .submenu button.show {
      opacity: 1;
      transform: translateY(0);
    }

    .submenu button:hover {
      background-color: #e0e0e0;
    }

    /* Tierra icons (solo iconos con fondo azul redondo) */
    #panel-mapa .submenu button {
      width: 56px;
      height: 56px;
      font-size: 2rem;
      padding: 0;
      background: #007acc;
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 56px;
      margin: 6px 0;
      cursor: pointer;
    }

    /* Panel iframe a pantalla completa */
    #panel-iframe-full {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: white;
      z-index: 14000;
      display: none;
      flex-direction: column;
    }

    #panel-iframe-full iframe {
      width: 100%;
      height: 100%;
      border: none;
      flex-grow: 1;
    }

    /* Bot√≥n cerrar X naranja sobre azul */
    #panel-iframe-full .cerrar-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #007acc;
      color: orange;
      font-weight: bold;
      font-size: 22px;
      padding: 6px 14px;
      border: none;
      cursor: pointer;
      border-radius: 6px;
      z-index: 15000;
      user-select: none;
    }

    /* Imagen mapa a pantalla completa con zoom y scroll */
    #imagen-full {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: white;
      border-radius: 0;
      box-shadow: 0 0 25px rgba(0,0,0,0.5);
      z-index: 14000;
      display: none;
      overflow: auto;
      user-select: none;
    }

    #imagen-full img {
      max-width: none;
      max-height: none;
      width: auto;
      height: auto;
      cursor: grab;
    }

    /* Terminos y condiciones */
    #terminos {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: white;
      z-index: 15000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      user-select: none;
    }

    #terminos iframe {
      width: 90vw;
      height: 80vh;
      border: none;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }

    #aceptar-terminos {
      margin-top: 20px;
      font-size: 1rem;
      padding: 10px 20px;
      background: #007acc;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
    }

  </style>
</head>
<body>
  <div id="mapa"></div>
  <iframe id="hijo" src="Av1-coordenadas.html" style="width:0; height:0; border:none; position:absolute; z-index:-1;"></iframe>

  <button id="hamburguesa" class="boton-flotante">‚ò∞</button>
  <button id="mas-opciones" class="boton-flotante">‚ãÆ</button>
  <button id="btn-mapa" class="boton-flotante">üåç</button>
  <button id="gps-prueba">Casa OFF</button>

  <div id="panel-hamburguesa" class="panel">
    <div class="submenu">
      <button data-url="retos_con_puzzles_Av1_es.html">Retos y Puzzles</button>
      <button data-url="Gastronomia.html">Gastronom√≠a</button>
      <button data-url="paginas_oficiales.html">P√°ginas Oficiales</button>
      <button data-url="enlaces_valencia_historica.html">Val√®ncia Hist√≥rica</button>
    </div>
  </div>

  <div id="panel-trespuntos" class="panel">
    <div class="submenu">
      <button data-url="Agradecimientos.html">Agradecimientos</button>
      <button data-url="consejos_seguridad_vial.html">Consejos y Seguridad</button>
      <button disabled>Fuentes (en desarrollo)</button>
    </div>
  </div>

  <div id="panel-mapa" class="panel">
    <div class="submenu">
      <button data-mapa="mostrar_siguiente">üìç</button>
      <button data-mapa="mostrar_ruta">üó∫Ô∏è</button>
      <button id="btn-brujula">üß≠</button>
    </div>
  </div>

  <!-- Iframe fullscreen panel -->
  <div id="panel-iframe-full">
    <button class="cerrar-panel" id="cerrar-iframe">X</button>
    <iframe src="" frameborder="0"></iframe>
  </div>

  <!-- Imagen fullscreen mapa -->
  <div id="imagen-full">
    <button class="cerrar-panel" id="cerrar-imagen">X</button>
    <img src="https://cdn-icons-png.flaticon.com/512/21/21601.png" alt="Br√∫jula" />
  </div>

  <!-- Terminos y condiciones -->
  <div id="terminos" style="display:none;">
    <iframe src="terminos_condiciones.html"></iframe>
    <button id="aceptar-terminos">Aceptar T√©rminos</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let mapa = L.map('mapa').setView([39.4726, -0.37739], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(mapa);

    // Variables control pesta√±as abiertas
    let panelHamburguesaAbierto = false;
    let panelTresPuntosAbierto = false;
    let panelMapaAbierto = false;
    let iframeVisible = false;
    let imagenVisible = false;

    // Referencias DOM
    const btnHamburguesa = document.getElementById('hamburguesa');
    const btnTresPuntos = document.getElementById('mas-opciones');
    const btnMapa = document.getElementById('btn-mapa');
    const btnGps = document.getElementById('gps-prueba');
    const panelHamburguesa = document.getElementById('panel-hamburguesa');
    const panelTresPuntos = document.getElementById('panel-trespuntos');
    const panelMapa = document.getElementById('panel-mapa');
    const panelIframeFull = document.getElementById('panel-iframe-full');
    const iframeFull = panelIframeFull.querySelector('iframe');
    const btnCerrarIframe = document.getElementById('cerrar-iframe');
    const imagenFull = document.getElementById('imagen-full');
    const btnCerrarImagen = document.getElementById('cerrar-imagen');
    const btnBrujula = document.getElementById('btn-brujula');
    const terminos = document.getElementById('terminos');
    const btnAceptarTerminos = document.getElementById('aceptar-terminos');

    // Estado GPS
    let gpsEncendido = false;

    // Funciones para abrir/cerrar paneles y pesta√±as
    function cerrarTodosPaneles() {
      cerrarPanelHamburguesa();
      cerrarPanelTresPuntos();
      cerrarPanelMapa();
      cerrarIframeFull();
      cerrarImagenFull();
    }

    function togglePanel(panel, flagName) {
      if (window[flagName]) {
        panel.style.display = 'none';
        window[flagName] = false;
      } else {
        cerrarTodosPaneles();
        panel.style.display = 'flex';
        window[flagName] = true;
      }
    }

    // Mostrar panel hamburguesa
    btnHamburguesa.addEventListener('click', () => {
      // Toggle
      if(panelHamburguesaAbierto){
        cerrarPanelHamburguesa();
      } else {
        cerrarPanelTresPuntos();
        cerrarPanelMapa();
        abrirPanelHamburguesa();
      }
    });

    // Mostrar panel tres puntos
    btnTresPuntos.addEventListener('click', () => {
      if(panelTresPuntosAbierto){
        cerrarPanelTresPuntos();
      } else {
        cerrarPanelHamburguesa();
        cerrarPanelMapa();
        abrirPanelTresPuntos();
      }
    });

    // Mostrar panel mapa (tierra)
    btnMapa.addEventListener('click', () => {
      if(panelMapaAbierto){
        cerrarPanelMapa();
      } else {
        cerrarPanelHamburguesa();
        cerrarPanelTresPuntos();
        abrirPanelMapa();
      }
    });

    function abrirPanelHamburguesa() {
      panelHamburguesa.style.display = 'flex';
      panelHamburguesaAbierto = true;
      animarPestanas(panelHamburguesa);
    }
    function cerrarPanelHamburguesa() {
      panelHamburguesa.style.display = 'none';
      panelHamburguesaAbierto = false;
      resetAnimacionPestanas(panelHamburguesa);
    }
    function abrirPanelTresPuntos() {
      panelTresPuntos.style.display = 'flex';
      panelTresPuntosAbierto = true;
      animarPestanas(panelTresPuntos);
    }
    function cerrarPanelTresPuntos() {
      panelTresPuntos.style.display = 'none';
      panelTresPuntosAbierto = false;
      resetAnimacionPestanas(panelTresPuntos);
    }
    function abrirPanelMapa() {
      panelMapa.style.display = 'flex';
      panelMapaAbierto = true;
      animarPestanas(panelMapa);
    }
    function cerrarPanelMapa() {
      panelMapa.style.display = 'none';
      panelMapaAbierto = false;
      resetAnimacionPestanas(panelMapa);
    }

    // Animaci√≥n de las pesta√±as individuales (botones)
    function animarPestanas(panel) {
      const botones = panel.querySelectorAll('button');
      botones.forEach((btn, i) => {
        setTimeout(() => {
          btn.classList.add('show');
        }, i * 80);
      });
    }
    function resetAnimacionPestanas(panel) {
      const botones = panel.querySelectorAll('button');
      botones.forEach(btn => btn.classList.remove('show'));
    }

    // Click en botones pesta√±as (hamburguesa y tres puntos) - abrir iframe fullscreen
    function abrirIframe(url) {
      iframeFull.src = url;
      panelIframeFull.style.display = 'flex';
      iframeVisible = true;
      cerrarTodosPaneles();
    }

    // Bot√≥n cerrar iframe fullscreen
    btnCerrarIframe.addEventListener('click', () => {
      cerrarIframeFull();
    });
    function cerrarIframeFull() {
      iframeFull.src = '';
      panelIframeFull.style.display = 'none';
      iframeVisible = false;
    }

    // A√±adimos eventos a botones dentro de panel hamburguesa
    panelHamburguesa.querySelectorAll('button').forEach(boton => {
      boton.addEventListener('click', () => {
        const url = boton.getAttribute('data-url');
        if(url){
          abrirIframe(url);
        }
      });
    });

    // A√±adimos eventos a botones dentro de panel tres puntos
    panelTresPuntos.querySelectorAll('button').forEach(boton => {
      boton.addEventListener('click', () => {
        const url = boton.getAttribute('data-url');
        if(url){
          abrirIframe(url);
        }
      });
    });

    // PANEL MAPA - manejo de iconos debajo bot√≥n tierra
    // Al pulsar iconos de la tierra, se abre contenido fullscreen

    // Variables para contenido del bot√≥n tierra
    let contenidoSiguienteVisible = false;
    let contenidoRutaVisible = false;
    let imagenBrujulaVisible = false;

    // Bot√≥n üìç (mostrar_siguiente)
    panelMapa.querySelector('button[data-mapa="mostrar_siguiente"]').addEventListener('click', () => {
      abrirIframe('mostrar_siguiente.html'); // Aqu√≠ deber√≠as poner el contenido real
    });

    // Bot√≥n üó∫Ô∏è (mostrar_ruta)
    panelMapa.querySelector('button[data-mapa="mostrar_ruta"]').addEventListener('click', () => {
      abrirIframe('mostrar_ruta.html'); // Aqu√≠ deber√≠as poner el contenido real
    });

    // Bot√≥n br√∫jula üß≠ abre imagen fullscreen con zoom y scroll
    btnBrujula.addEventListener('click', () => {
      imagenFull.style.display = 'flex';
      imagenVisible = true;
      cerrarTodosPaneles();
    });

    btnCerrarImagen.addEventListener('click', () => {
      cerrarImagenFull();
    });
    function cerrarImagenFull() {
      imagenFull.style.display = 'none';
      imagenVisible = false;
    }

    // Gesti√≥n bot√≥n GPS Casa ON/OFF
    btnGps.addEventListener('click', () => {
      gpsEncendido = !gpsEncendido;
      if(gpsEncendido){
        btnGps.textContent = 'Casa ON';
        btnGps.style.background = 'green';
        // Mensaje para apagar GPS (gps_modo: true)
        window.parent.postMessage({ gps_modo: true }, '*');
      } else {
        btnGps.textContent = 'Casa OFF';
        btnGps.style.background = 'red';
        // Mensaje para encender GPS (gps_modo: false)
        window.parent.postMessage({ gps_modo: false }, '*');
      }
    });

    // Evento para cerrar paneles si pulsas fuera (clic fuera de paneles)
    document.addEventListener('click', (e) => {
      if (!panelHamburguesa.contains(e.target) && e.target !== btnHamburguesa &&
          !panelTresPuntos.contains(e.target) && e.target !== btnTresPuntos &&
          !panelMapa.contains(e.target) && e.target !== btnMapa &&
          !panelIframeFull.contains(e.target) && e.target !== btnCerrarIframe &&
          !imagenFull.contains(e.target) && e.target !== btnCerrarImagen &&
          e.target !== btnBrujula) {
        cerrarTodosPaneles();
      }
    });

    // Manejo bot√≥n atr√°s en m√≥viles para cerrar paneles abiertos
    window.addEventListener('popstate', (event) => {
      if(panelHamburguesaAbierto || panelTresPuntosAbierto || panelMapaAbierto || iframeVisible || imagenVisible){
        cerrarTodosPaneles();
        history.pushState(null, null, location.href);
      }
    });

    // Para prevenir bloqueo por bot√≥n atr√°s en m√≥viles
    history.pushState(null, null, location.href);

    // Terminos y condiciones - mostrar solo la primera vez
    if(!localStorage.getItem('aceptadoTerminos')){
      terminos.style.display = 'flex';
    }

    btnAceptarTerminos.addEventListener('click', () => {
      localStorage.setItem('aceptadoTerminos', 'true');
      terminos.style.display = 'none';
    });

  </script>
</body>
</html>
