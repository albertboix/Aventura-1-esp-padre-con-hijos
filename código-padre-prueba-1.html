<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa Padre</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    iframe {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 50%;
      height: 50%;
      border: 2px solid blue;
      z-index: 900;
    }
    #cerrarIframe {
      position: fixed;
      bottom: 50%;
      right: 50%;
      background: blue;
      color: orange;
      border: none;
      padding: 5px 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1001;
    }

    .btn-flotante {
      position: fixed;
      z-index: 999;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    #menu-hamburguesa {
      bottom: 10px;
      left: 10px;
    }
    #botones-derecha {
      bottom: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #boton-gps-prueba {
      top: 10px;
      left: 10px;
      background-color: lightgray;
      color: black;
      font-weight: bold;
    }
    #boton-mapa-ruta {
      top: 10px;
      right: 10px;
    }
    #boton-gps-prueba.activo {
      background-color: green;
      color: white;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- Bot√≥n cerrar iframe -->
<button id="cerrarIframe">X</button>

<!-- Iframe del hijo -->
<iframe id="iframe-hijo" src="Av1-coordenadas.html"></iframe>

<!-- Bot√≥n GPS prueba casa -->
<div id="boton-gps-prueba" class="btn-flotante">GPS Prueba Casa</div>

<!-- Bot√≥n mapa ruta -->
<div id="boton-mapa-ruta" class="btn-flotante">üó∫Ô∏è</div>

<!-- Men√∫ hamburguesa -->
<div id="menu-hamburguesa" class="btn-flotante">‚ò∞</div>

<!-- Botones verticales ‚ãÆ -->
<div id="botones-derecha" class="btn-flotante">
  <div>‚ãÆ</div>
  <div>‚ãÆ</div>
  <div>‚ãÆ</div>
</div>

<script>
  // Crear el mapa
  const map = L.map('map').setView([40.4168, -3.7038], 13); // Madrid

  // Capa de OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  // Marcar si est√° activado el GPS de prueba
  let gpsActivo = false;

  document.getElementById('boton-gps-prueba').addEventListener('click', () => {
    gpsActivo = !gpsActivo;
    const boton = document.getElementById('boton-gps-prueba');
    boton.classList.toggle('activo', gpsActivo);
    if (gpsActivo) {
      alert('GPS simulado activado');
    } else {
      alert('GPS simulado desactivado');
    }
  });

  // Cerrar iframe
  document.getElementById('cerrarIframe').addEventListener('click', () => {
    document.getElementById('iframe-hijo').style.display = 'none';
    document.getElementById('cerrarIframe').style.display = 'none';
  });

  // Detecci√≥n de paradas desde el hijo
  window.addEventListener('message', (event) => {
    if (!event.data || typeof event.data !== 'object') return;

    if (event.data.tipo === 'parada_detectada') {
      const paradaId = event.data.id;
      activarBotonPlay(paradaId);
    }

    if (event.data.tipo === 'paradas') {
      const paradas = event.data.lista;
      paradas.forEach(p => {
        const marker = L.marker([p.lat, p.lng]).addTo(map);
        marker.bindPopup(p.nombre || p.id || 'Parada');
      });
    }
  });

  // Simula activar bot√≥n play
  function activarBotonPlay(id) {
    console.log(`Activar bot√≥n play para la parada: ${id}`);
    alert(`Parada detectada: ${id}`);
  }
</script>

</body>
</html>
