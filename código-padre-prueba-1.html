<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>App Aventura - Padre</title>
<style>
  /* Igual que antes (omito para no repetir), pero aquí está el body para bloquear botones */
  body.no-interactivo *:not(#modal-terminos):not(#modal-terminos *) {
    pointer-events: none;
    user-select: none;
  }
</style>
</head>
<body class="no-interactivo">

<div id="mapa-contenedor"></div>

<!-- Botones flotantes (igual que antes) -->
<div id="btn-hamburguesa" class="boton-flotante" title="Menú">&#9776;</div>
<div id="btn-tres-puntos" class="boton-flotante" title="Opciones">&#8942;</div>
<div id="btn-mapa" class="boton-flotante" title="Mapa">&#128506;</div>

<!-- Submenús (igual que antes) -->
<div id="submenu-hamburguesa" class="submenu">
  <button data-url="retos_con_puzzles_Av1_es.html">Retos y Puzzles</button>
  <button data-url="Gastronomia.html">Gastronomía</button>
  <button data-url="paginas_oficiales.html">Páginas Oficiales</button>
  <button data-url="enlaces_valencia_historica.html">València Histórica</button>
</div>

<div id="submenu-tres-puntos" class="submenu">
  <button data-url="Agradecimientos.html">Agradecimientos</button>
  <button data-url="consejos_seguridad_vial.html">Consejos Seguridad Vial</button>
  <button data-url="fuentes_informacion.html">Fuentes (En desarrollo)</button>
</div>

<div id="submenu-mapa" class="submenu" style="display:none;">
  <button title="Coordenadas" data-url="Av1-coordenadas.html">&#128506;</button>
  <button title="Mapa de la Aventura" data-url="mapa-aventura.html">&#127759;</button>
  <button title="Mapa Tradicional" data-url="mapa-tradicional.html">&#128441;</button>
</div>

<!-- Pestaña pantalla completa -->
<div id="pantalla-completa" style="display:none; flex-direction: column;">
  <button id="cerrar-pantalla">✕</button>
  <iframe id="iframe-contenido" src="" allow="geolocation; autoplay" allowfullscreen></iframe>
</div>

<!-- Modal términos y condiciones -->
<div id="modal-terminos">
  <div id="contenido-terminos">
    <iframe src="terminos_y_condiciones.html"></iframe>
    <button id="btn-aceptar-terminos">Aceptar términos y condiciones</button>
  </div>
</div>

<script>
  let audioActivo = false;
  let gpsActivo = false;
  let permisosAceptados = false;

  // Elementos
  const btnHamburguesa = document.getElementById('btn-hamburguesa');
  const btnTresPuntos = document.getElementById('btn-tres-puntos');
  const btnMapa = document.getElementById('btn-mapa');
  const submenuHamburguesa = document.getElementById('submenu-hamburguesa');
  const submenuTresPuntos = document.getElementById('submenu-tres-puntos');
  const submenuMapa = document.getElementById('submenu-mapa');
  const pantallaCompleta = document.getElementById('pantalla-completa');
  const iframeContenido = document.getElementById('iframe-contenido');
  const btnCerrarPantalla = document.getElementById('cerrar-pantalla');
  const modalTerminos = document.getElementById('modal-terminos');
  const btnAceptarTerminos = document.getElementById('btn-aceptar-terminos');
  const body = document.body;

  // Bloquear/Desbloquear interacción con botones
  function bloquearInteraccion() {
    body.classList.add('no-interactivo');
  }
  function desbloquearInteraccion() {
    body.classList.remove('no-interactivo');
  }

  bloquearInteraccion();

  // Permisos reales para GPS
  async function pedirPermisoGPS() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        alert('Geolocalización no disponible');
        reject(false);
        return;
      }
      navigator.geolocation.getCurrentPosition(
        () => resolve(true),
        () => {
          alert('Permiso GPS denegado');
          reject(false);
        }
      );
    });
  }

  // Permisos reales para audio (audio context)
  async function pedirPermisoAudio() {
    return new Promise((resolve, reject) => {
      try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        audioCtx.resume().then(() => {
          resolve(true);
        }).catch(() => {
          alert('No se pudo activar el audio');
          reject(false);
        });
      } catch {
        alert('Audio no soportado');
        reject(false);
      }
    });
  }

  // Al aceptar términos, pedir permisos
  btnAceptarTerminos.addEventListener('click', async () => {
    try {
      await pedirPermisoGPS();
      gpsActivo = true;
      await pedirPermisoAudio();
      audioActivo = true;
      permisosAceptados = true;
      modalTerminos.style.display = 'none';
      desbloquearInteraccion();
    } catch {
      // Si no concede permisos, se queda bloqueado, no se cierra modal ni habilitan botones
      alert('Debes aceptar los permisos para continuar.');
    }
  });

  // Ocultar todos submenus
  function ocultarSubmenus() {
    submenuHamburguesa.style.display = 'none';
    submenuTresPuntos.style.display = 'none';
    submenuMapa.style.display = 'none';
  }

  // Solo permitir abrir submenus si permisos aceptados
  btnHamburguesa.addEventListener('click', () => {
    if(!permisosAceptados) return alert('Debes aceptar términos y permisos para usar la app.');
    if (submenuHamburguesa.style.display === 'block') submenuHamburguesa.style.display = 'none';
    else {
      ocultarSubmenus();
      submenuHamburguesa.style.display = 'block';
    }
  });
  btnTresPuntos.addEventListener('click', () => {
    if(!permisosAceptados) return alert('Debes aceptar términos y permisos para usar la app.');
    if (submenuTresPuntos.style.display === 'block') submenuTresPuntos.style.display = 'none';
    else {
      ocultarSubmenus();
      submenuTresPuntos.style.display = 'block';
    }
  });
  btnMapa.addEventListener('click', () => {
    if(!permisosAceptados) return alert('Debes aceptar términos y permisos para usar la app.');
    if (submenuMapa.style.display === 'flex') submenuMapa.style.display = 'none';
    else {
      ocultarSubmenus();
      submenuMapa.style.display = 'flex';
    }
  });

  // Abrir pantalla completa desde submenu
  function abrirPantallaCompleta(url) {
    ocultarSubmenus();
    iframeContenido.src = url;
    pantallaCompleta.style.display = 'flex';
  }

  // Eventos click en botones submenu
  document.querySelectorAll('.submenu button').forEach(btn => {
    btn.addEventListener('click', () => {
      if(!permisosAceptados) return alert('Debes aceptar términos y permisos para usar la app.');
      const url = btn.getAttribute('data-url');
      abrirPantallaCompleta(url);
    });
  });

  // Cerrar pantalla completa
  btnCerrarPantalla.addEventListener('click', () => {
    pantallaCompleta.style.display = 'none';
    iframeContenido.src = '';

    // Enviar mensaje para desbloquear rotación (en caso mapa tradicional)
    window.postMessage('desbloquear-rotacion', '*');
  });

  // Escuchar mensajes desde iframe (para bloqueo rotación)
  window.addEventListener('message', (event) => {
    if (event.data === 'bloquear-rotacion') {
      if(screen.orientation && screen.orientation.lock) {
        screen.orientation.lock('portrait').catch(() => {});
      }
    }
    if(event.data === 'desbloquear-rotacion'){
      if(screen.orientation && screen.orientation.unlock) {
        screen.orientation.unlock();
      }
    }
  });

  // Cerrar submenus si click fuera
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.boton-flotante') && !e.target.closest('.submenu')) ocultarSubmenus();
  });

</script>
</body>
</html>
