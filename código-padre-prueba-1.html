<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aventura 1: Descubre Valencia (Padre)</title>
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
        /* CSS para el padre (código-padre-prueba-1.html) */
        body {
            font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif;
            margin: 1em;
            background: #fff;
            color: #222;
            font-size: 16px; /* Tamaño de fuente base */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: calc(100vh - 2em);
            justify-content: flex-start;
            position: relative; /* Necesario para posicionamiento de botones fijos */
        }
        h2 {
            margin-bottom: 0.8em;
            text-align: center;
            width: 100%;
        }

        /* Contenedor principal para iframes de retos/puzzles y el mapa */
        #reto-container {
            /* Los bordes deben ser siempre de igual grosor. */
            border: 3px solid #ccc; /* Grosor inicial */
            border-radius: 8px;
            padding: 0;
            margin-bottom: 1em;
            position: relative;
            min-height: 250px;
            width: 100%;
            max-width: 980px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            transition: border-color 0.3s ease-in-out; /* Transición suave para el color del borde */
        }

        /* Ambos iframes deben ocupar el 100% del contenedor cuando estén activos */
        #gpsIframe, /* NUEVO: para el mapa GPS */
        #puzzleIframe {
            width: 100%;
            height: 600px; /* Altura estándar, ajustada por media queries si es necesario */
            border: none;
            display: none; /* Ocultos por defecto, el JS los activa */
        }
        /* Por defecto, el gpsIframe estará visible, a menos que el puzzleIframe lo reemplace */
        #gpsIframe {
            display: block; /* El mapa siempre visible al inicio */
        }


        #button-container-padre {
            display: flex;
            flex-wrap: wrap;
            gap: 1em;
            margin-top: 1em;
            justify-content: center;
            width: 100%;
            min-height: 40px;
        }

        button.btn-padre {
            padding: 0.6em 1.2em;
            font-size: 1.1em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background-color: #0077cc;
            color: white;
            user-select: none;
            transition: background-color 0.3s ease;
        }
        button.btn-padre:hover {
            background-color: #005699;
        }
        button.btn-padre:disabled {
            background-color: #999;
            cursor: not-allowed;
        }

        #btnNextAfterReto {
            background-color: #0077cc;
            display: none; /* Oculto por defecto */
        }
        #btnNextAfterReto:hover {
            background-color: #005699;
        }

        /* Clases para el borde del contenedor, aplicadas por el padre */
        #reto-container.correct {
            border-color: #28a745; /* Verde */
        }
        #reto-container.incorrect {
            border-color: #c00; /* Rojo */
        }
        #reto-container.ready {
            border-color: #0077cc; /* Azul para "esperando respuesta" o reto activo */
        }
        #reto-container.revealed {
            border-color: #ffc107; /* Naranja/Amarillo para respuesta mostrada */
        }
        #reto-container.no-reto {
            border-color: transparent; /* Transparente si no hay reto/puzzle */
        }

        /* Estilos para el reproductor de audio */
        .audio-player-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1em;
            margin-bottom: 2em;
            padding: 1em;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            width: 100%;
            max-width: 600px;
        }

        #audioControlContainer {
            display: flex;
            align-items: center;
            gap: 1em;
            width: 100%;
            justify-content: center;
        }

        /* El botón de play/pause */
        #playPauseBtn {
            padding: 1em;
            font-size: 1.2em;
            border: none;
            border-radius: 50%;
            background-color: #6c757d; /* Gris para indicar que no está activo todavía */
            color: white;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
        }
        #playPauseBtn.ready { /* Clase para cuando está listo para reproducir (por proximidad) */
            background-color: #0077cc; /* Azul para "listo" */
        }
        #playPauseBtn.active { /* Clase para cuando está reproduciendo */
            background-color: #28a745; /* Verde */
        }
        #playPauseBtn:hover:not(:disabled):not(.active):not(.ready) {
            background-color: #5a6268;
        }
        #playPauseBtn.ready:hover:not(:disabled) {
            background-color: #005699;
        }
        #playPauseBtn.active:hover:not(:disabled) {
            background-color: #218838;
        }

        #playPauseBtn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #playPauseBtn i {
            pointer-events: none; /* Evita que el icono interfiera con el click del botón */
        }

        #progressBarContainer {
            flex-grow: 1; /* Ocupa el espacio disponible */
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }

        #progressBar {
            height: 100%;
            width: 0%;
            background-color: #0077cc;
            border-radius: 4px;
        }

        #currentTime,
        #duration {
            font-size: 0.9em;
            color: #555;
            min-width: 40px; /* Para evitar saltos de texto */
            text-align: center;
        }

        #locationStatus {
            font-size: 0.9em;
            margin-top: 0.5em;
            text-align: center;
        }

        /* Controles de depuración para GPS */
        #gpsDebugControls {
            margin-top: 1.5em;
            padding: 1em;
            border: 1px dashed #ccc;
            border-radius: 8px;
            background-color: #f0f0f0;
            text-align: center;
            width: 100%;
            max-width: 600px;
        }
        #gpsDebugControls button {
            background-color: #0077cc;
            color: white;
            padding: 0.5em 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0.5em;
        }
        #gpsDebugControls button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #terminarAventuraBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #ff4d4d; /* Rojo para "Terminar" */
            color: white;
            padding: 1em 1.5em;
            border-radius: 50px; /* Botón flotante redondo */
            font-size: 1.1em;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: none; /* Oculto por defecto, se muestra al final */
        }
        #terminarAventuraBtn:hover {
            background-color: #cc0000;
        }

        /* --- NUEVOS ESTILOS PARA LOS BOTONES DESPLEGABLES --- */
        .floating-btn {
            position: fixed;
            background-color: #0077cc;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.8em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000; /* Asegura que estén por encima de todo el contenido principal */
            transition: background-color 0.3s ease;
        }
        .floating-btn:hover {
            background-color: #005699;
        }

        #leftMenuBtn {
            bottom: 20px;
            left: 20px;
        }

        #rightMenuBtn {
            bottom: 20px;
            right: 100px; /* Desplazado para no chocar con Terminar Aventura */
        }
        
        /* NUEVO: Botón de mapa flotante */
        #mapMenuBtn {
            bottom: 90px; /* Por encima de leftMenuBtn */
            left: 20px;
            z-index: 1000; /* Asegura que esté por encima de todo el contenido principal */
            display: none; /* Se muestra cuando la aventura inicia */
        }

        /* Estilos para los contenedores de menú desplegable */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6); /* Fondo semi-transparente */
            z-index: 1001; /* Ligeramente más alto que los botones flotantes */
            display: none; /* Oculto por defecto */
            justify-content: center;
            align-items: center;
        }

        .menu-container {
            background: #fff;
            padding: 1em;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90%;
            overflow: hidden; /* Para contener los iframes */
            display: flex;
            flex-direction: column;
            position: relative; /* Para posicionar la X de cierre */
        }

        /* Menú de la izquierda */
        #leftMenuContainer .menu-container {
            width: 400px; /* Ancho fijo para el menú de la izquierda */
        }

        /* Menú de la derecha */
        #rightMenuContainer .menu-container {
            width: 350px; /* Ancho fijo para el menú de la derecha */
        }
        
        /* NUEVO: Menú del mapa */
        #mapMenuContainer .menu-container {
            width: 300px; /* Ancho fijo para el menú del mapa */
        }

        /* --- Posición de la X de cierre (ahora arriba a la derecha) --- */
        .menu-container .close-tab-btn {
            position: absolute;
            top: 10px; /* Ajusta la distancia desde arriba */
            right: 10px; /* Ajusta la distancia desde la derecha */
            background: none;
            border: none;
            font-size: 1.8em; /* Tamaño de la X */
            cursor: pointer;
            color: #555;
            z-index: 10; /* Asegura que esté por encima de otros elementos */
            padding: 0; /* Elimina padding extra del botón */
            line-height: 1; /* Para centrar el carácter X */
        }
        .menu-container .close-tab-btn:hover {
            color: #c00;
        }


        .menu-tabs {
            display: flex;
            flex-direction: column; /* Cambiado a columna para mejor control de botones */
            gap: 0.5em;
            margin-bottom: 1em;
            margin-top: 1em; /* Espacio debajo del título y la X */
        }

        .menu-tab-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 0.8em 1.2em;
            border-radius: 5px;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 1.1em;
            color: #333;
        }
        .menu-tab-btn:hover {
            background-color: #e0e0e0;
        }
        .menu-tab-btn.active {
            background-color: #0077cc;
            color: white;
            border-color: #0077cc;
        }

        /* Estilos para el contenido de las pestañas (dentro del menú, NO en pantalla completa) */
        .tab-content {
            flex-grow: 1;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            display: none; /* Oculto por defecto */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            background-color: #f9f9f9;
            padding: 1em; /* Añadido padding para el mensaje */
        }

        .tab-content .en-desarrollo-message {
            font-size: 1.2em;
            font-style: italic;
            color: #666;
            text-align: center;
            display: flex; /* Asegurar que el mensaje esté centrado */
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }


        /* --- NUEVO ESTILO PARA EL CONTENEDOR DE PANTALLA COMPLETA --- */
        #fullScreenIframeContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff; /* Fondo blanco para el contenido */
            z-index: 10000; /* Asegura que esté por encima de todo */
            display: none; /* Oculto por defecto */
            flex-direction: column; /* Para organizar el botón de cerrar y el iframe */
            box-sizing: border-box; /* Incluir padding en el tamaño */
        }

        #fullScreenIframeContainer iframe {
            width: 100%;
            height: 100%;
            border: none;
            flex-grow: 1; /* Ocupa el espacio restante */
            display: block; /* Asegurarse de que el iframe se muestre */
        }

        #fullScreenCloseBtn {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5); /* Botón más discreto */
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10001; /* Más alto que el contenedor */
        }
        #fullScreenCloseBtn:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        /* Estilos específicos para la ventana de Términos y Condiciones */
        #termsOverlay {
            z-index: 100000; /* Más alto que cualquier otro overlay */
            display: flex; /* Asegura que esté visible al cargar */
        }

        #termsBox {
            width: 80%;
            height: 80%;
            max-width: 700px;
            max-height: 500px;
        }

        #termsIframe {
            flex-grow: 1;
            height: 100%;
            display: block; /* Debe ser visible cuando la ventana de términos está abierta */
        }

        /* Estilos para la pantalla de bienvenida/permisos (ahora flotante) */
        #welcomeOverlay {
            z-index: 99999; /* Un poco menos que los términos, para que estos estén primero */
            display: none; /* Oculto por defecto */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }

        #welcomeBox {
            background: #fff;
            padding: 2em;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            max-width: 500px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 1.5em;
        }
        #welcomeBox h1 {
            font-size: 1.8em;
            margin-bottom: 0.5em;
            color: #0077cc;
        }
        #welcomeBox p {
            font-size: 1.1em;
            line-height: 1.5;
            color: #333;
        }
        #acceptPermissionsBtn {
            background-color: #28a745;
            color: white;
            padding: 0.8em 1.5em;
            border: none;
            border-radius: 6px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #acceptPermissionsBtn:hover {
            background-color: #218838;
        }


        /* Media Queries para pantallas más pequeñas */
        @media (max-width: 800px) and (orientation: landscape) {
            h2 {
                display: none;
            }
            body {
                margin: 0.5em;
            }
            #reto-container {
                min-height: auto;
                height: calc(100dvh - 80px);
                padding: 0;
                margin-bottom: 0.5em;
            }
            #gpsIframe,
            #puzzleIframe {
                height: 100%;
                max-width: 100%;
            }
            button.btn-padre {
                font-size: 1em;
                padding: 0.5em 1em;
            }
            .audio-player-container,
            #gpsDebugControls {
                max-width: 100%;
            }
            /* Ajustar tamaño de menús en landscape */
            #leftMenuContainer .menu-container,
            #rightMenuContainer .menu-container,
            #mapMenuContainer .menu-container, /* NUEVO */
            #termsBox,
            #welcomeBox { /* También la caja de bienvenida */
                width: 95%; /* Ocupar casi todo el ancho */
                max-height: 95%;
            }
        }

        @media (max-width: 600px) and (orientation: portrait) {
            #gpsIframe,
            #puzzleIframe {
                height: 400px;
            }
            #reto-container {
                min-height: 400px;
            }
            /* Ajustar tamaño de menús en portrait */
            #leftMenuContainer .menu-container,
            #rightMenuContainer .menu-container,
            #mapMenuContainer .menu-container, /* NUEVO */
            #termsBox,
            #welcomeBox { /* También la caja de bienvenida */
                width: 95%; /* Ocupar casi todo el ancho */
                max-height: 95%;
            }
            .floating-btn {
                width: 50px;
                height: 50px;
                font-size: 1.5em;
            }
            /* Ajustar posición del botón derecho más a la derecha */
            #rightMenuBtn {
                right: 20px; /* Más pegado al borde derecho */
            }
        }
    </style>
</head>
<body>
    <div id="termsOverlay" class="menu-overlay">
        <div id="termsBox" class="menu-container">
            <h3>Términos y Condiciones</h3>
            <iframe id="termsIframe" src="terminos_y_condiciones.html" style="width: 100%; height: 100%; border: none;"></iframe>
            <button id="acceptTermsBtn" class="btn-padre" style="margin-top: 1em; width: 100%;">Aceptar Términos y Continuar</button>
        </div>
    </div>

    <div id="welcomeOverlay" style="display: none;">
        <div id="welcomeBox">
            <h1>¡Bienvenido a tu Aventura en Valencia!</h1>
            <p>
                Para disfrutar plenamente de esta experiencia, necesitamos acceder a algunas funciones de tu dispositivo.
                Por favor, acepta los permisos de <strong>ubicación (GPS)</strong> y permite la reproducción de <strong>audio</strong>.
                Esto nos permitirá guiarte por los puntos de interés y activar los retos y narraciones en el momento justo.
            </p>
            <button id="acceptPermissionsBtn">Entendido, ¡Empezar Aventura!</button>
        </div>
    </div>

    <h2>Aventura 1: Descubre Valencia</h2>

    <div id="reto-container">
        <iframe id="gpsIframe" src="Av1-coordenadas.html" style="width: 100%; height: 100%; border: none; display: block;"></iframe>

        <iframe id="puzzleIframe" src="" style="display: none;"></iframe>

        <div id="loading-message" style="text-align: center; padding: 2em; font-size: 1.2em; display: none;">
            Cargando la aventura...
        </div>
    </div>

    <div class="audio-player-container" id="audioPlayerWrapper" style="display: none;">
        <h3>Audio del Punto <span id="currentAudioPoint"></span></h3>
        <iframe id="audioIframe" src="audio_player_hijo.html" style="width: 100%; height: 120px; border: none; display: none;"></iframe>
        <p id="locationStatus" style="color: red; font-weight: bold;">Esperando ubicación...</p>
    </div>

    <div id="button-container-padre">
        <button id="btnNextAfterReto" class="btn-padre">Continuar con la Aventura</button>
    </div>

    <div id="gpsDebugControls">
        <h4>Modo de Prueba GPS (Solo para desarrollo)</h4>
        <button id="toggleGpsMode">Activar/Desactivar GPS Real</button>
        <p>Estado GPS: <span id="gpsModeStatus">Real (intentando obtener)</span></p>
        <button id="simulateProximityBtn" disabled>Simular Proximidad</button>
    </div>

    <button id="leftMenuBtn" class="floating-btn"><i class="fas fa-bars"></i></button>
    <button id="rightMenuBtn" class="floating-btn"><i class="fas fa-ellipsis-v"></i></button>
    <button id="mapMenuBtn" class="floating-btn"><i class="fas fa-map"></i></button> <button id="terminarAventuraBtn">Terminar Aventura</button>

    <div id="leftMenuContainer" class="menu-overlay">
        <div class="menu-container">
            <button class="close-tab-btn" onclick="hideLeftMenu()">&times;</button>
            <h3>Menú de Aventura</h3>
            <div class="menu-tabs">
                <button class="menu-tab-btn" data-tab-target="retosPuzzlesTab">Retos y Puzzles (Juego)</button>
                <button class="menu-tab-btn" data-tab-target="gastronomiaTab">Gastronomía</button>
                <button class="menu-tab-btn" data-tab-target="paginasOficialesTab">Páginas Oficiales</button>
                <button class="menu-tab-btn" data-tab-target="videosHistoricosTab">Videos Históricos</button>
            </div>
            <div id="retosPuzzlesTab" class="tab-content">
                <div class="en-desarrollo-message">Cargando Retos y Puzzles...</div>
            </div>
            <div id="gastronomiaTab" class="tab-content">
                <div class="en-desarrollo-message">Cargando Gastronomía...</div>
            </div>
            <div id="paginasOficialesTab" class="tab-content">
                <div class="en-desarrollo-message">Cargando Páginas Oficiales...</div>
            </div>
            <div id="videosHistoricosTab" class="tab-content">
                <div class="en-desarrollo-message">Cargando Videos Históricos...</div>
            </div>
        </div>
    </div>

    <div id="rightMenuContainer" class="menu-overlay">
        <div class="menu-container">
            <button class="close-tab-btn" onclick="hideRightMenu()">&times;</button>
            <h3>Información Adicional</h3>
            <div class="menu-tabs">
                <button class="menu-tab-btn" data-tab-target="agradecimientosTab">Agradecimientos</button>
                <button class="menu-tab-btn" data-tab-target="fuentesInfoTab">Fuentes de Información</button>
                <button class="menu-tab-btn" data-tab-target="consejosSeguridadTab">Consejos y Seguridad Vial</button>
            </div>
            <div id="agradecimientosTab" class="tab-content">
                <div class="en-desarrollo-message">Cargando Agradecimientos...</div>
            </div>
            <div id="fuentesInfoTab" class="tab-content">
                <div class="en-desarrollo-message">Cargando Fuentes de Información...</div>
            </div>
            <div id="consejosSeguridadTab" class="tab-content">
                <div class="en-desarrollo-message">Cargando Consejos y Seguridad Vial...</div>
            </div>
        </div>
    </div>

    <div id="mapMenuContainer" class="menu-overlay">
        <div class="menu-container">
            <button class="close-tab-btn" onclick="hideMapMenu()">&times;</button>
            <h3>Opciones del Mapa</h3>
            <div class="menu-tabs">
                <button class="menu-tab-btn" id="mapFocusNextBtn">Centrar en Siguiente Punto</button>
                <button class="menu-tab-btn" id="mapShowFullRouteBtn">Ver Ruta Completa</button>
            </div>
        </div>
    </div>

    <div id="fullScreenIframeContainer">
        <button id="fullScreenCloseBtn"><i class="fas fa-times"></i></button>
        <iframe id="fullScreenIframe" src=""></iframe>
    </div>

    <script>
        // Variables globales
        let currentStep = 0; // Controla el paso actual de la aventura
        let gpsRealActivado = true; // Por defecto, intentar usar GPS real

        // Referencias a elementos del DOM
        const retoContainer = document.getElementById('reto-container');
        const puzzleIframe = document.getElementById('puzzleIframe');
        const btnNextAfterReto = document.getElementById('btnNextAfterReto');
        const playPauseBtn = document.getElementById('playPauseBtn');

        // Referencia al iframe del mapa GPS
        const gpsIframe = document.getElementById('gpsIframe');

        // Referencias de la pantalla de bienvenida/permisos
        const welcomeOverlay = document.getElementById('welcomeOverlay');
        const acceptPermissionsBtn = document.getElementById('acceptPermissionsBtn');

        // Referencias para el estado del GPS y depuración
        const gpsModeStatusSpan = document.getElementById('gpsModeStatus');
        const locationStatusSpan = document.getElementById('locationStatus');
        const toggleGpsModeBtn = document.getElementById('toggleGpsMode');
        const simulateProximityBtn = document.getElementById('simulateProximityBtn');

        // Referencia al ID del punto de audio actual
        const currentAudioPointSpan = document.getElementById('currentAudioPoint');

        // Referencias de los botones flotantes y menús
        const leftMenuBtn = document.getElementById('leftMenuBtn');
        const rightMenuBtn = document.getElementById('rightMenuBtn');
        const mapMenuBtn = document.getElementById('mapMenuBtn');
        const terminarAventuraBtn = document.getElementById('terminarAventuraBtn');

        const leftMenuContainer = document.getElementById('leftMenuContainer');
        const rightMenuContainer = document.getElementById('rightMenuContainer');
        const mapMenuContainer = document.getElementById('mapMenuContainer');

        // Referencias para el iframe en pantalla completa
        const fullScreenIframeContainer = document.getElementById('fullScreenIframeContainer');
        const fullScreenIframe = document.getElementById('fullScreenIframe');
        const fullScreenCloseBtn = document.getElementById('fullScreenCloseBtn');

        // Referencia al iframe del reproductor de audio hijo
        const audioIframe = document.getElementById('audioIframe');

        // REFERENCIAS PARA TÉRMINOS Y CONDICIONES
        const termsOverlay = document.getElementById('termsOverlay');
        const acceptTermsBtn = document.getElementById('acceptTermsBtn');
        const termsIframe = document.getElementById('termsIframe');

        // --- Funciones de Control de la Aventura (Pasos, Retos, Puzzles) ---

        // Función auxiliar para pausar el audio
        function pauseCurrentAudio() {
            sendMessageToAudioChild('pauseAudio');
            playPauseBtn.classList.remove('active', 'ready');
            playPauseBtn.disabled = true; // Deshabilitar el botón cuando el audio es pausado por acción del usuario/menú
        }

        // Esta función ahora solo AVANZA el contador del paso y notifica al iframe del mapa
        // para que cargue su siguiente punto. Toda la lógica de "qué audio/puzzle toca"
        // residirá en el iframe del mapa.
        function cargarSiguientePaso() {
            ocultarRetoYPuzzle(); // Ocultar cualquier reto/puzzle anterior en el área principal
            btnNextAfterReto.style.display = 'none'; // Ocultar botón de "Continuar Aventura"
            
            pauseCurrentAudio(); // Pausar audio al cambiar de paso
            playPauseBtn.disabled = true; // Asegurarse de que el botón esté deshabilitado inicialmente para el nuevo paso

            console.log(`Cargando paso ${currentStep + 1}`);
            currentAudioPointSpan.textContent = `...`; // El mapa hijo informará el ID del punto

            document.getElementById('audioPlayerWrapper').style.display = 'flex'; // Asegurarse de que el reproductor de audio esté visible
            mapMenuBtn.style.display = 'flex'; // Mostrar el botón del mapa

            // Asegurarse de que el mapa sea visible y el puzzle esté oculto
            gpsIframe.style.display = 'block';
            puzzleIframe.style.display = 'none';

            // Enviar mensaje al iframe del mapa para ir al siguiente punto
            gpsIframe.contentWindow.postMessage({
                type: "avanzar_siguiente_parada", // El mapa hijo gestiona cuál es el siguiente punto
                gpsRealActivo: gpsRealActivado // Indica al hijo si el padre está en modo GPS real
            }, "*");

            locationStatusSpan.textContent = "Cargando siguiente punto...";
            retoContainer.classList.add('no-reto'); // Por defecto, sin borde hasta que el mapa hijo indique un reto.
        }

        // Carga un reto en el iframe principal del CONTENEDOR DE AVENTURA
        function cargarReto(url) {
            pauseCurrentAudio(); // Pausar audio al cargar un reto
            puzzleIframe.src = url;
            puzzleIframe.style.display = 'block';
            gpsIframe.style.display = 'none'; // Ocultar el mapa cuando el reto esté activo
            btnNextAfterReto.style.display = 'none'; // Ocultar el botón de continuar mientras el reto está activo
            retoContainer.classList.remove('no-reto');
            retoContainer.classList.add('ready'); // Borde azul para "en espera"
            console.log("Reto cargado en contenedor principal:", url);
        }

        // Muestra un puzzle en el iframe secundario (en el contenedor de aventura)
        function mostrarPuzzle(url) {
            pauseCurrentAudio(); // Pausar audio al mostrar un puzzle
            puzzleIframe.src = url;
            puzzleIframe.style.display = 'block';
            gpsIframe.style.display = 'none'; // Ocultar el mapa cuando el puzzle esté activo
            btnNextAfterReto.style.display = 'none';
            retoContainer.classList.remove('no-reto');
            retoContainer.classList.add('ready'); // Borde azul para "en espera"
            console.log("Puzzle cargado en contenedor principal:", url);
        }

        // Oculta el iframe de puzzle/reto del contenedor principal
        function ocultarRetoYPuzzle() {
            puzzleIframe.style.display = 'none';
            puzzleIframe.src = 'about:blank'; // Limpiar el contenido del iframe
            retoContainer.classList.remove('correct', 'incorrect', 'ready', 'revealed');
            retoContainer.classList.add('no-reto'); // Borde transparente si no hay reto/puzzle
            gpsIframe.style.display = 'block'; // Asegurarse de que el mapa vuelva a ser visible
            // No pausar el audio aquí, ya que volver al mapa no implica pausar el audio de la parada
        }

        // Reinicia el estado visual del contenedor del reto
        function reiniciarEstadoReto() {
            retoContainer.classList.remove('correct', 'incorrect', 'revealed', 'no-reto');
            retoContainer.classList.add('ready'); // Por defecto, el borde es azul cuando hay un reto
        }

        // --- Funciones para Menús y Pantalla Completa ---

        // Muestra el contenido en el iframe de pantalla completa
        function showContentInFullScreen(url) {
            pauseCurrentAudio(); // Pausar audio al abrir cualquier contenido en pantalla completa
            fullScreenIframe.src = url;
            fullScreenIframeContainer.style.display = 'flex';
            // Ocultar los menús flotantes si están abiertos
            hideLeftMenu();
            hideRightMenu();
            hideMapMenu(); // También el menú del mapa
            // Notificar al iframe del mapa que se oculte para liberar recursos si está visible
            gpsIframe.contentWindow.postMessage({ type: "ocultar_mapa" }, "*");
        }

        // Oculta el iframe de pantalla completa
        function hideFullScreenIframe() {
            fullScreenIframe.src = ''; // Limpiar el contenido
            fullScreenIframeContainer.style.display = 'none';
            // Re-evaluar el estado del audio y del botón de play
            // Si el GPS real está activo, el audio puede activarse por proximidad
            // o el botón de play puede habilitarse si se sigue cerca del punto.
            // Para simplificar, volvemos al estado inicial de 'espera' para el play
            playPauseBtn.disabled = true;
            playPauseBtn.classList.remove('active', 'ready');
            // Notificar al iframe del mapa que se muestre de nuevo
            gpsIframe.contentWindow.postMessage({ type: "mostrar_mapa" }, "*");
        }

        function showLeftMenu() {
            pauseCurrentAudio(); // Pausar audio al abrir el menú izquierdo
            leftMenuContainer.style.display = 'flex';
            // Al abrir, desactiva todas las pestañas y oculta su contenido
            leftMenuContainer.querySelectorAll('.menu-tab-btn').forEach(btn => btn.classList.remove('active'));
            leftMenuContainer.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            // Notificar al iframe del mapa que se oculte
            gpsIframe.contentWindow.postMessage({ type: "ocultar_mapa" }, "*");
        }

        function hideLeftMenu() {
            leftMenuContainer.style.display = 'none';
            // Notificar al iframe del mapa que se muestre de nuevo
            gpsIframe.contentWindow.postMessage({ type: "mostrar_mapa" }, "*");
        }

        function showRightMenu() {
            pauseCurrentAudio(); // Pausar audio al abrir el menú derecho
            rightMenuContainer.style.display = 'flex';
            // Al abrir, desactiva todas las pestañas y oculta su contenido
            rightMenuContainer.querySelectorAll('.menu-tab-btn').forEach(btn => btn.classList.remove('active'));
            rightMenuContainer.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            // Notificar al iframe del mapa que se oculte
            gpsIframe.contentWindow.postMessage({ type: "ocultar_mapa" }, "*");
        }

        function hideRightMenu() {
            rightMenuContainer.style.display = 'none';
            // Notificar al iframe del mapa que se muestre de nuevo
            gpsIframe.contentWindow.postMessage({ type: "mostrar_mapa" }, "*");
        }

        // Funciones para el menú del mapa
        function showMapMenu() {
            pauseCurrentAudio(); // Pausar audio al abrir el menú del mapa
            mapMenuContainer.style.display = 'flex';
            // Aquí no necesitamos ocultar el mapa hijo porque este menú interactúa con él directamente.
        }

        function hideMapMenu() {
            mapMenuContainer.style.display = 'none';
        }

        // --- Comunicación entre Padre e Hijo (iframes) ---

        // Función para enviar mensajes al iframe del reproductor de audio
        function sendMessageToAudioChild(type, data = {}) {
            if (audioIframe.contentWindow) {
                audioIframe.contentWindow.postMessage({ type, ...data }, '*');
            }
        }

        // Manejar mensajes recibidos de los iframes hijos
        window.addEventListener('message', (event) => {
            // Asegúrate de verificar el origin en un entorno de producción
            // if (event.origin !== "http://tu-dominio.com") return;

            const message = event.data;
            console.log("Mensaje recibido del hijo:", message);

            switch (message.type) {
                case 'retoCompletado':
                case 'puzzleCompletado':
                    // Verificar si el mensaje viene del iframe de AVENTURA (#puzzleIframe)
                    if (event.source === puzzleIframe.contentWindow) {
                        console.log(`Reto/Puzzle de aventura completado con resultado: ${message.correct ? 'Correcto' : 'Incorrecto'}`);
                        if (message.correct) {
                            retoContainer.classList.add('correct');
                            alert("¡Respuesta correcta! Puedes continuar con la aventura.");
                        } else {
                            retoContainer.classList.add('incorrect');
                            alert("Respuesta incorrecta. Inténtalo de nuevo o avanza.");
                        }
                        btnNextAfterReto.style.display = 'block'; // Mostrar el botón para continuar
                        pauseCurrentAudio(); // Asegurarse de que el audio se pause
                    }
                    break;
                case 'audioEnded':
                    console.log("Reproducción de audio finalizada.");
                    playPauseBtn.classList.remove('active'); // Desactivar el botón de play/pause
                    break;
                case 'audioReady':
                    console.log("Audio player hijo listo.");
                    // Este mensaje ya no inicia la carga de audio aquí, el mapa hijo lo hará.
                    break;
                case 'abrirFullscreen': // Mensaje para abrir un iframe en pantalla completa (ahora centralizado)
                    if (message.url) {
                        showContentInFullScreen(message.url);
                    }
                    break;

                // --- CASOS PARA LA COMUNICACIÓN CON EL MAPA GPS (Av1-coordenadas.html) ---

                case 'gps-hijo-listo':
                    // El hijo del mapa avisa cuando está listo y ha inicializado el GPS.
                    if (event.source === gpsIframe.contentWindow) {
                        console.log("Padre: GPS Hijo listo.");
                        // El padre puede ahora pedir la primera parada o esperar al usuario.
                        // Ya no necesitamos pedir paradas al hijo aquí.
                    }
                    break;

                case 'coordenadas-actualizadas':
                    // El hijo del mapa envía la ubicación y distancia actualizadas.
                    if (event.source === gpsIframe.contentWindow) {
                        locationStatusSpan.textContent = `Ubicación: ${message.lat.toFixed(6)}, ${message.lon.toFixed(6)} (±${message.accuracy.toFixed(0)}m) - Distancia al punto ${message.targetId}: ${message.distance.toFixed(0)}m`;
                        locationStatusSpan.style.color = '#0077cc'; // Azul para ubicación
                        currentAudioPointSpan.textContent = message.targetId || '...'; // Mostrar ID del punto actual del mapa
                    }
                    break;

                case 'coordenadas-cerca':
                    // El hijo del mapa avisa que está cerca del punto de interés actual.
                    if (event.source === gpsIframe.contentWindow) {
                        console.log(`¡Padre: Cerca del punto ${message.paradaId}! Activando botón de play.`);
                        // Habilitamos el botón de play y cargamos el audio desde aquí
                        sendMessageToAudioChild('loadAudio', { src: message.audioUrl }); // Carga el audio que el mapa hijo indica
                        if (!playPauseBtn.classList.contains('active')) { // Solo si no está ya reproduciendo
                            playPauseBtn.disabled = false; // Habilitar el botón de play
                            playPauseBtn.classList.add('ready'); // Añadir clase 'ready' para indicar visualmente que está listo
                        }
                        locationStatusSpan.textContent = `¡Estás cerca de ${message.paradaNombre}! Pulsa Play.`; // Actualizar el mensaje
                    }
                    break;

                case 'coordenadas-lejos':
                    // El hijo del mapa avisa que se ha alejado del punto de interés actual.
                    if (event.source === gpsIframe.contentWindow) {
                        console.log(`Padre: Lejos del punto ${message.paradaId}. Pausando audio.`);
                        pauseCurrentAudio(); // Pausar audio si nos alejamos
                        locationStatusSpan.textContent = `Te has alejado de ${message.paradaNombre}.`;
                    }
                    break;

                case 'coordenadas-completadas':
                    // El hijo del mapa avisa que se ha llegado al punto de interés actual.
                    if (event.source === gpsIframe.contentWindow) {
                        currentStep = message.paradaIndex; // Actualizar el paso del padre
                        console.log(`¡Padre: Llegada a la parada: ${message.paradaId}!`);
                        locationStatusSpan.textContent = `¡Has llegado a ${message.paradaNombre}!`;
                        locationStatusSpan.style.color = '#28a745'; // Verde para confirmación

                        pauseCurrentAudio(); // Pausar audio una vez que se ha llegado completamente

                        // Si hay un reto o puzzle para este punto, el mapa hijo nos lo indicará
                        if (message.retoUrl) {
                            console.log(`Activando reto del mapa hijo para el punto ${message.paradaId}: ${message.retoUrl}`);
                            gpsIframe.style.display = 'none'; // Ocultar el mapa para mostrar el puzzle
                            // El mapa hijo debe indicar si es un 'reto' o 'puzzle'
                            if (message.retoTipo === 'reto') {
                                cargarReto(message.retoUrl);
                            } else if (message.retoTipo === 'puzzle') {
                                mostrarPuzzle(message.retoUrl);
                            } else {
                                // Por defecto, si no especifica, asumimos puzzle
                                mostrarPuzzle(message.retoUrl);
                            }
                        } else {
                            // Si no hay reto, muestra el botón de "Continuar Aventura" directamente
                            btnNextAfterReto.style.display = 'block';
                            retoContainer.classList.add('no-reto'); // Asegurar borde transparente
                        }
                    }
                    break;

                case 'coordenadas-error':
                    // Mensaje de error de geolocalización desde Av1-coordenadas.html
                    if (event.source === gpsIframe.contentWindow) {
                        console.error("Error de GPS del mapa:", message.error);
                        locationStatusSpan.textContent = `Error del GPS: ${message.error}`;
                        locationStatusSpan.style.color = '#dc3545'; // Rojo
                        // Si hay un error, actualizamos el estado del GPS en el padre
                        gpsRealActivado = false;
                        toggleGpsModeBtn.textContent = "Activar GPS Real";
                        gpsModeStatusSpan.textContent = "GPS Desactivado (Error)";
                        simulateProximityBtn.disabled = false;
                        pauseCurrentAudio(); // Pausar audio si hay un error de GPS
                    }
                    break;
                case 'aventura-completada':
                    // El mapa hijo notifica que la aventura ha llegado a su fin
                    if (event.source === gpsIframe.contentWindow) {
                        console.log("¡Aventura completada!");
                        locationStatusSpan.textContent = "¡Felicidades, la aventura ha terminado!";
                        locationStatusSpan.style.color = '#28a745';
                        document.getElementById('audioPlayerWrapper').style.display = 'none';
                        gpsIframe.style.display = 'none'; // Ocultar el mapa al finalizar
                        puzzleIframe.style.display = 'none';
                        retoContainer.classList.add('no-reto');
                        terminarAventuraBtn.style.display = 'block'; // Mostrar botón de terminar
                        mapMenuBtn.style.display = 'none'; // Ocultar botón del mapa
                    }
                    break;
                case 'imagen-modal-abierto':
                    // Notificar al padre que el modal de imagen en el GPS hijo está abierto.
                    pauseCurrentAudio();
                    break;
                case 'imagen-modal-cerrado':
                    // Notificar al padre que el modal de imagen en el GPS hijo está cerrado.
                    // El audio no se reanuda automáticamente, el usuario debe pulsarlo si es necesario.
                    break;
            }
        });

        // --- Event Listeners ---

        // Evento para aceptar los Términos y Condiciones
        acceptTermsBtn.addEventListener('click', () => {
            termsOverlay.style.display = 'none'; // Oculta la ventana de términos
            welcomeOverlay.style.display = 'flex'; // Muestra la pantalla de bienvenida/permisos
        });

        // Evento para aceptar permisos y comenzar la aventura (de la pantalla de bienvenida/permisos)
        acceptPermissionsBtn.addEventListener('click', () => {
            console.log("¡Botón 'Entendido, ¡Empezar Aventura!' clickeado!"); // Mensaje de depuración
            welcomeOverlay.style.display = 'none'; // Oculta la pantalla de bienvenida/permisos

            // Iniciar la carga del audio player hijo al aceptar permisos
            audioIframe.style.display = 'block'; // Necesario para que el iframe esté en el DOM y pueda recibir mensajes
            audioIframe.src = "audio_player_hijo.html";
            audioIframe.style.display = 'none'; // Lo ocultamos hasta que se necesite mostrar el reproductor

            // Al aceptar permisos, le decimos al GPS hijo que inicie su proceso de solicitud
            gpsIframe.contentWindow.postMessage({ type: "iniciar_gps_con_permiso" }, "*");

            cargarSiguientePaso(); // Iniciar la aventura (cargar el primer punto del mapa)
        });

        // Evento para el botón "Continuar con la Aventura"
        btnNextAfterReto.addEventListener('click', () => {
            cargarSiguientePaso(); // Avanzar al siguiente paso de la aventura
        });

        // Toggle GPS real / simulación
        toggleGpsModeBtn.addEventListener('click', () => {
            gpsRealActivado = !gpsRealActivado; // Invertir el estado
            if (gpsRealActivado) {
                // Enviar mensaje al gpsIframe para que active el GPS real
                gpsIframe.contentWindow.postMessage({ type: "activar_gps_real" }, "*");
                gpsModeStatusSpan.textContent = "Real (obteniendo ubicación...)";
                locationStatusSpan.textContent = "Reiniciando GPS real...";
                locationStatusSpan.style.color = '#ffc107'; // Amarillo
            } else {
                // Enviar mensaje al gpsIframe para que detenga el GPS real y active el modo manual/simulado
                gpsIframe.contentWindow.postMessage({ type: "desactivar_gps_real" }, "*");
                gpsModeStatusSpan.textContent = "GPS Desactivado (Modo Manual/Simulado)";
                locationStatusSpan.textContent = "GPS Desactivado.";
                locationStatusSpan.style.color = '#6c757d';
            }
            simulateProximityBtn.disabled = gpsRealActivado; // Habilitar/deshabilitar botón de simulación
            console.log(`Modo GPS: ${gpsRealActivado ? 'Real' : 'Manual/Simulado'}`);

            pauseCurrentAudio(); // Pausar audio al cambiar el modo GPS
            // No es necesario llamar a cargarSiguientePaso() aquí. El mapa hijo se encargará.
            // Si el modo GPS real está activado, el mapa empezará a buscar la ubicación.
            // Si está desactivado, el botón de simulación se habilitará.
        });

        // Simular proximidad al siguiente punto (solo para depuración)
        simulateProximityBtn.addEventListener('click', () => {
            if (!gpsRealActivado) { // Solo si el GPS real está desactivado
                // Enviamos un mensaje al iframe del mapa para que simule proximidad al punto actual
                // El iframe del mapa es el que sabe cuál es el "current step" para la simulación
                gpsIframe.contentWindow.postMessage({
                    type: "simular_proximidad_al_punto_actual"
                }, "*");
                console.log(`Padre: Solicitando al mapa hijo simular proximidad al punto actual.`);
            } else {
                alert("La simulación de proximidad solo funciona con el GPS Real Desactivado. Desactívalo primero.");
            }
        });

        // Manejar click del botón de Terminar Aventura
        terminarAventuraBtn.addEventListener('click', () => {
            if (confirm("¿Estás seguro de que quieres terminar la aventura?")) {
                alert("¡Gracias por jugar! Aventura finalizada.");
                window.location.reload(); // Recargar la página para reiniciar
            }
        });

        // Event listeners para los botones flotantes
        leftMenuBtn.addEventListener('click', showLeftMenu);
        rightMenuBtn.addEventListener('click', showRightMenu);
        mapMenuBtn.addEventListener('click', showMapMenu);
        fullScreenCloseBtn.addEventListener('click', hideFullScreenIframe);

        // Event listeners para los sub-botones del menú del mapa
        document.getElementById('mapFocusNextBtn').addEventListener('click', () => {
            gpsIframe.contentWindow.postMessage({ type: "mapa-hijo-focus-next-point" }, "*");
            hideMapMenu(); // Ocultar el menú del mapa después de la acción
        });

        document.getElementById('mapShowFullRouteBtn').addEventListener('click', () => {
            gpsIframe.contentWindow.postMessage({ type: "mapa-hijo-show-full-route" }, "*");
            hideMapMenu(); // Ocultar el menú del mapa después de la acción
        });


        // Event listeners para las pestañas del menú izquierdo (abren en pantalla completa)
        leftMenuContainer.querySelectorAll('.menu-tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const tabTarget = button.dataset.tabTarget;
                let urlToLoad = '';
                switch(tabTarget) {
                    case 'retosPuzzlesTab':
                        urlToLoad = 'retos_con_puzzles_Av1_es.html'; // Juego externo
                        break;
                    case 'gastronomiaTab':
                        urlToLoad = 'Gastronomia.html';
                        break;
                    case 'paginasOficialesTab':
                        urlToLoad = 'paginas_oficiales.html';
                        break;
                    case 'videosHistoricosTab':
                        urlToLoad = 'enlaces_valencia_historica.html';
                        break;
                }
                if (urlToLoad) {
                    showContentInFullScreen(urlToLoad);
                }
            });
        });

        // Event listeners para las pestañas del menú derecho (abren en pantalla completa)
        rightMenuContainer.querySelectorAll('.menu-tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const tabTarget = button.dataset.tabTarget;
                let urlToLoad = '';
                switch(tabTarget) {
                    case 'agradecimientosTab':
                        urlToLoad = 'Agradecimientos.html';
                        break;
                    case 'fuentesInfoTab':
                        urlToLoad = 'fuentes_informacion.html'; // Ejemplo de URL
                        break;
                    case 'consejosSeguridadTab':
                        urlToLoad = 'consejos_seguridad_vial.html';
                        break;
                }
                if (urlToLoad) {
                    showContentInFullScreen(urlToLoad);
                }
            });
        });

        // Función para el botón de play/pause del audio (en el padre)
        playPauseBtn.addEventListener('click', () => {
            if (!playPauseBtn.disabled) { // Solo si el botón NO está deshabilitado
                if (playPauseBtn.classList.contains('active')) {
                    sendMessageToAudioChild('pauseAudio');
                    playPauseBtn.classList.remove('active');
                    playPauseBtn.classList.add('ready'); // Vuelve a estado 'listo'
                } else {
                    // Pedir al mapa hijo que indique qué audio debería reproducirse
                    // y el mapa hijo enviará un mensaje 'loadAudio' de vuelta al padre,
                    // que luego el padre reenvía al iframe de audio.
                    // Para simplificar ahora mismo, asumimos que el audio ya fue cargado
                    // por el mensaje 'coordenadas-cerca'.
                    sendMessageToAudioChild('playAudio'); // Solo play/resume
                    playPauseBtn.classList.add('active');
                    playPauseBtn.classList.remove('ready'); // Quita estado 'listo'
                }
            } else {
                console.warn("El audio se activará cuando te acerques al punto o actives el modo manual.");
            }
        });

        // --- Inicialización de la Página ---

        // Función que se ejecuta al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            // Asegurar que termsOverlay esté visible al inicio y el resto oculto
            termsOverlay.style.display = 'flex';
            welcomeOverlay.style.display = 'none';
            document.getElementById('audioPlayerWrapper').style.display = 'none';
            puzzleIframe.style.display = 'none';
            btnNextAfterReto.style.display = 'none';
            terminarAventuraBtn.style.display = 'none';
            leftMenuContainer.style.display = 'none';
            rightMenuContainer.style.display = 'none';
            mapMenuContainer.style.display = 'none';
            mapMenuBtn.style.display = 'none';
            fullScreenIframeContainer.style.display = 'none';
            document.getElementById('loading-message').style.display = 'none';
            
            // Asegurarse de que el gpsIframe esté visible desde el principio
            gpsIframe.style.display = 'block';

            // Deshabilitar el botón de play al inicio
            playPauseBtn.disabled = true;
            playPauseBtn.classList.remove('active', 'ready');
        });
    </script>
</body>
</html>
