<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Av1_coordenadas (GPS Google Maps)</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif;
            overflow: hidden; /* Evita barras de desplazamiento */
            height: 100%; /* Asegura que el body y html ocupen toda la altura */
        }
        #map {
            height: 100%; /* El padre definir√° el tama√±o real de este iframe */
            width: 100%; /* El padre definir√° el tama√±o real de este iframe */
            border: 3px solid #ddd; /* Borde del mapa */
            box-sizing: border-box; /* Asegura que el padding/border no aumenten el tama√±o total */
        }
        #message-overlay {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 10;
            font-size: 0.9em;
            text-align: center;
            display: none; /* Oculto por defecto */
            max-width: 90%;
            pointer-events: none; /* Permite clics "a trav√©s" si est√° visible pero no interactivo */
            border: 2px solid #555;
        }

        /* Estilos para el bot√≥n de c√°mara y la superposici√≥n de imagen */
        #camera-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 2.5em; /* Tama√±o del icono */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 11; /* Por encima de message-overlay */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            opacity: 0.8; /* Ligeramente transparente cuando no se usa */
            transition: opacity 0.3s ease;
            border: 2px solid #ccc;
            display: none; /* Oculto por defecto, se muestra por JS */
        }

        #camera-button:hover {
            opacity: 1;
        }

        #image-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; /* Ocupa el 100% del iframe padre */
            height: 100%; /* Ocupa el 100% del iframe padre */
            background-color: rgba(0, 0, 0, 0.6); 
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 12; /* Por encima de todo lo dem√°s en este iframe */
            display: none; /* Oculto por defecto */
        }

        #image-modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: transparent;
            padding: 0;
        }

        #destination-image {
            max-width: 100%;
            max-height: 75vh; 
            height: auto;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            object-fit: contain;
            display: none;
            border: 3px solid #eee;
        }

        #close-image-button {
            background-color: #f44336; /* Rojo */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border: 2px solid #c2332a;
        }

        #close-image-button:hover {
            background-color: #d32f2f;
        }

        /* Estilos para el spinner de carga */
        .spinner {
            border: 6px solid #f3f3f3; /* Light grey */
            border-top: 6px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            display: none; /* Oculto por defecto */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="message-overlay"></div>

    <button id="camera-button">üì∏</button>

    <div id="image-modal-overlay">
        <div id="image-modal-content">
            <div id="image-spinner" class="spinner"></div>
            <img id="destination-image" src="" alt="Imagen del destino">
            <button id="close-image-button" style="display: none;">Cerrar</button>
        </div>
    </div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let userMarker; // Marcador para la posici√≥n del usuario
        let stopMarkers = []; // Array para almacenar todos los marcadores de las paradas
        let currentTargetIndex = -1; // √çndice de la parada actual en paradasAventura
        let currentTargetData = null; // Datos completos del currentTarget (lat, lon, radio, etc.)
        let watchId; // Para almacenar el ID del observador de geolocalizaci√≥n
        let arrivalSent = false; // Bandera para evitar enviar el mensaje de llegada m√∫ltiples veces
        let proximitySent = false; // Bandera para evitar enviar el mensaje de "cerca" m√∫ltiples veces
        let gpsRealActivado = true; // El padre controlar√° esto, pero el hijo necesita un estado inicial

        const overlay = document.getElementById('message-overlay');
        const cameraButton = document.getElementById('camera-button');
        const imageModalOverlay = document.getElementById('image-modal-overlay');
        const destinationImage = document.getElementById('destination-image');
        const closeImageButton = document.getElementById('close-image-button');
        const imageSpinner = document.getElementById('image-spinner');

        // --- LISTA DE PARADAS PARA LA AVENTURA 1 (¬°CON WAYPOINTS E IMAGEN, Y AUDIO INCLUIDOS!) ---
        const paradasAventura = [
            // PARADA 0: Torres de Serranos (start) Plaza de los Fueros
            { id: 1, nombreParada: "Torres de Serranos (start) Plaza de los Fueros", lat: 39.47876, lon: -0.37626, radio: 20,
              waypoints: [{ lat: 39.47943, lon: -0.37636 }],
              imagen: "img/torres_serranos.jpg", audio: "audio/torres_serranos.mp3" }, 
            
            // PARADA 1: Puente de Serranos ‚Äì Plaza de la Crida
            { id: 2, nombreParada: "Puente de Serranos ‚Äì Plaza de la Crida", lat: 39.47959, lon: -0.37583, radio: 20,
              waypoints: [{ lat: 39.47939, lon: -0.3752 }],
              imagen: "img/puente_serranos.jpg", audio: "audio/puente_serranos.mp3" }, 
            
            // PARADA 2: Calle Muro Santa Ana
            { id: 3, nombreParada: "Calle Muro Santa Ana", lat: 39.47866, lon: -0.3747, radio: 15,
              waypoints: [],
              imagen: "img/muro_santa_ana.jpg", audio: "audio/muro_santa_ana.mp3" }, 
            
            // PARADA 3: Cortes Valencianas (Palacio de los Borgia)
            { id: 4, nombreParada: "Cortes Valencianas (Palacio de los Borgia)", lat: 39.47785, lon: -0.37485, radio: 15,
              waypoints: [],
              imagen: "img/palacio_borgia.jpg", audio: "audio/palacio_borgia.mp3" }, 
            
            // PARADA 4: Iglesia de San Lorenzo
            { id: 5, nombreParada: "Iglesia de San Lorenzo", lat: 39.47768, lon: -0.3749, radio: 15,
              waypoints: [],
              imagen: "img/iglesia_san_lorenzo.jpg", audio: "audio/iglesia_san_lorenzo.mp3" }, 
            
            // PARADA 5: Plaza de la Virgen
            { id: 6, nombreParada: "Plaza de la Virgen", lat: 39.47656, lon: -0.37529, radio: 25,
              waypoints: [{ lat: 39.4766, lon: -0.37473 }],
              imagen: "img/plaza_virgen.jpg", audio: "audio/plaza_virgen.mp3" }, 
            
            // PARADA 6: Plaza de la Almo√≠na
            { id: 7, nombreParada: "Plaza de la Almo√≠na", lat: 39.47609, lon: -0.37449, radio: 15,
              waypoints: [],
              imagen: "img/plaza_almoina.jpg", audio: "audio/plaza_almoina.mp3" }, 
            
            // PARADA 7: Catedral de Val√®ncia
            { id: 8, nombreParada: "Catedral de Val√®ncia", lat: 39.47594, lon: -0.37474, radio: 10,
              waypoints: [],
              imagen: "img/catedral_valencia.jpg", audio: "audio/catedral_valencia.mp3" }, 
            
            // PARADA 8: Plaza Decimo Juno Bruto (Museo Arqueol√≥gico de la Almo√≠na)
            { id: 9, nombreParada: "Plaza Decimo Juno Bruto (Museo Arqueol√≥gico de la Almo√≠na)", lat: 39.4762, lon: -0.37412, radio: 15,
              waypoints: [],
              imagen: "img/museo_almoina.jpg", audio: "audio/museo_almoina.mp3" }, 
            
            // PARADA 9: Bas√≠lica de Val√®ncia
            { id: 10, nombreParada: "Bas√≠lica de Val√®ncia", lat: 39.47611, lon: -0.37478, radio: 10,
              waypoints: [],
              imagen: "img/basilica_valencia.jpg", audio: "audio/basilica_valencia.mp3" }, 
            
            // PARADA 10: Casa del Punt de Gantxo
            { id: 11, nombreParada: "Casa del Punt de Gantxo", lat: 39.47603, lon: -0.37433, radio: 10,
              waypoints: [],
              imagen: "img/punt_gantxo.jpg", audio: "audio/punt_gantxo.mp3" }, 
            
            // PARADA 11: Palacio Arzobispal
            { id: 12, nombreParada: "Palacio Arzobispal", lat: 39.4755, lon: -0.37436, radio: 10,
              waypoints: [],
              imagen: "img/palacio_arzobispal.jpg", audio: "audio/palacio_arzobispal.mp3" }, 
            
            // PARADA 12: Puerta Rom√°nica de la Catedral
            { id: 13, nombreParada: "Puerta Rom√°nica de la Catedral", lat: 39.4756, lon: -0.37466, radio: 10,
              waypoints: [],
              imagen: "img/puerta_romanica.jpg", audio: "audio/puerta_romanica.mp3" }, 
            
            // PARADA 13: Torre del Miguelete
            { id: 14, nombreParada: "Torre del Miguelete", lat: 39.47533, lon: -0.37563, radio: 10,
              waypoints: [
                  { lat: 39.47514, lon: -0.37494 }, // Waypoint 4
                  { lat: 39.47447, lon: -0.3754 },  // Waypoint 5
                  { lat: 39.47212, lon: -0.37676 }   // Waypoint 6
              ],
              imagen: "img/miguelete.jpg", audio: "audio/miguelete.mp3" }, 
            
            // PARADA 14: Plaza del Ayuntamiento
            { id: 15, nombreParada: "Plaza del Ayuntamiento", lat: 39.47056, lon: -0.37677, radio: 20,
              waypoints: [],
              imagen: "img/plaza_ayuntamiento.jpg", audio: "audio/plaza_ayuntamiento.mp3" }, 
            
            // PARADA 15: Edificio del Ayuntamiento de Val√®ncia
            { id: 16, nombreParada: "Edificio del Ayuntamiento de Val√®ncia", lat: 39.46971, lon: -0.37693, radio: 15,
              waypoints: [{ lat: 39.46795, lon: -0.37701 }],
              imagen: "img/ayuntamiento_edificio.jpg", audio: "audio/ayuntamiento_edificio.mp3" }, 
            
            // PARADA 16: Estaci√≥n de Ferrocarril (Estaci√≥n del Norte)
            { id: 17, nombreParada: "Estaci√≥n de Ferrocarril (Estaci√≥n del Norte)", lat: 39.46722, lon: -0.37702, radio: 30,
              waypoints: [],
              imagen: "img/estacion_norte.jpg", audio: "audio/estacion_norte.mp3" }, 
            
            // PARADA 17: Plaza de Toros de Val√®ncia
            { id: 18, nombreParada: "Plaza de Toros de Val√®ncia", lat: 39.46709, lon: -0.37595, radio: 30,
              waypoints: [{ lat: 39.46714, lon: -0.37498 }],
              imagen: "img/plaza_toros.jpg", audio: "audio/plaza_toros.mp3" }, 
            
            // PARADA 18: Casa estilo √Årabe
            { id: 19, nombreParada: "Casa estilo √Årabe", lat: 39.46753, lon: -0.37511, radio: 15,
              waypoints: [],
              imagen: "img/casa_arabe.jpg", audio: "audio/casa_arabe.mp3" }, 
            
            // PARADA 19: Palacio de Comunicaciones (Correos)
            { id: 20, nombreParada: "Palacio de Comunicaciones (Correos)", lat: 39.46942, lon: -0.37559, radio: 10,
              waypoints: [],
              imagen: "img/correos.jpg", audio: "audio/correos.mp3" }, 
            
            // PARADA 20: Edificio Suay (La Equitativa)
            { id: 21, nombreParada: "Edificio Suay (La Equitativa)", lat: 39.4699, lon: -0.37573, radio: 10,
              waypoints: [
                  { lat: 39.4703, lon: -0.3759 },   // Waypoint 9
                  { lat: 39.47039, lon: -0.37505 }  // Waypoint 10
              ],
              imagen: "img/edificio_suay.jpg", audio: "audio/edificio_suay.mp3" }, 
            
            // PARADA 21: Antigua sede del Banco de Val√®ncia
            { id: 22, nombreParada: "Antigua sede del Banco de Val√®ncia", lat: 39.47061, lon: -0.37408, radio: 10,
              waypoints: [{ lat: 39.47119, lon: -0.37423 }],
              imagen: "img/banco_valencia.jpg", audio: "audio/banco_valencia.mp3" }, 
            
            // PARADA 22: Iglesia de San Juan de la Cruz
            { id: 23, nombreParada: "Iglesia de San Juan de la Cruz", lat: 39.47214, lon: -0.37446, radio: 15,
              waypoints: [],
              imagen: "img/san_juan_cruz.jpg", audio: "audio/san_juan_cruz.mp3" }, 
            
            // PARADA 23: Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica)
            { id: 24, nombreParada: "Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica)", lat: 39.47276, lon: -0.37467, radio: 15,
              waypoints: [
                  { lat: 39.47311, lon: -0.37589 }, // Waypoint 12
                  { lat: 39.47261, lon: -0.37654 }, // Waypoint 13
                  { lat: 39.47265, lon: -0.37725 }  // Waypoint 14
              ],
              imagen: "img/palacio_dos_aguas.jpg", audio: "audio/palacio_dos_aguas.mp3" }, 
            
            // PARADA 24: Mercado Central
            { id: 25, nombreParada: "Mercado Central", lat: 39.47377, lon: -0.37832, radio: 20,
              waypoints: [],
              imagen: "img/mercado_central.jpg", audio: "audio/mercado_central.mp3" }, 
            
            // PARADA 25: San Juan del Mercado (Iglesia de los Santos Juanes)
            { id: 26, nombreParada: "San Juan del Mercado (Iglesia de los Santos Juanes)", lat: 39.47425, lon: -0.37895, radio: 15,
              waypoints: [],
              imagen: "img/santos_juanes.jpg", audio: "audio/santos_juanes.mp3" }, 
            
            // PARADA 26: Lonja de Val√®ncia (Mercado de la Seda)
            { id: 27, nombreParada: "Lonja de Val√®ncia (Mercado de la Seda)", lat: 39.47426, lon: -0.37862, radio: 20,
              waypoints: [{ lat: 39.47459, lon: -0.37868 }],
              imagen: "img/lonja_seda.jpg", audio: "audio/lonja_seda.mp3" }, 
            
            // PARADA 27: Plaza del Doctor Collado
            { id: 28, nombreParada: "Plaza del Doctor Collado", lat: 39.47444, lon: -0.3779, radio: 10,
              waypoints: [{ lat: 39.47521, lon: -0.37766 }],
              imagen: "img/plaza_collado.jpg", audio: "audio/plaza_collado.mp3" }, 
            
            // PARADA 28: Plaza del Negrito (Fuente del Negrito)
            { id: 29, nombreParada: "Plaza del Negrito (Fuente del Negrito)", lat: 39.47611, lon: -0.37741, radio: 10,
              waypoints: [],
              imagen: "img/fuente_negrito.jpg", audio: "audio/fuente_negrito.mp3" }, 
            
            // PARADA 29: Calle Caballeros
            { id: 30, nombreParada: "Calle Caballeros", lat: 39.47663, lon: -0.3773, radio: 10,
              waypoints: [],
              imagen: "img/calle_caballeros.jpg", audio: "audio/calle_caballeros.mp3" }, 
            
            // PARADA 30: Palacio de la Generalitat
            { id: 31, nombreParada: "Palacio de la Generalitat", lat: 39.47668, lon: -0.37671, radio: 10,
              waypoints: [],
              imagen: "img/palacio_generalitat.jpg", audio: "audio/palacio_generalitat.mp3" }, 
            
            // PARADA 31: Calle Serranos (Fin de la aventura)
            { id: 32, nombreParada: "Calle Serranos (Fin de la aventura)", lat: 39.47774, lon: -0.37671, radio: 15,
              waypoints: [],
              imagen: "img/fin_aventura.jpg", audio: "audio/fin_aventura.mp3" } 
        ];

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 39.4700, lng: -0.3760 }, // Centro inicial en Valencia
                zoom: 15,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                polylineOptions: {
                    strokeColor: '#0077cc', // Color de la ruta
                    strokeOpacity: 0.8,
                    strokeWeight: 6 
                },
                suppressMarkers: true // Suprime los marcadores por defecto de Google para usar los nuestros
            });

            // Marcador para la posici√≥n del usuario
            userMarker = new google.maps.Marker({
                map: map,
                position: { lat: 0, lng: 0 }, // Posici√≥n inicial, se actualizar√° con el GPS
                icon: { // Icono para el usuario (c√≠rculo azul, por ejemplo)
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: '#4285F4', // Azul de Google
                    fillOpacity: 0.9,
                    strokeWeight: 1,
                    strokeColor: '#FFFFFF'
                },
                title: "Tu Posici√≥n"
            });

            // A√±adir marcadores para todas las paradas (todos azules inicialmente)
            paradasAventura.forEach((parada, index) => {
                const marker = new google.maps.Marker({
                    position: { lat: parada.lat, lng: parada.lon },
                    map: map,
                    // Usar un icono local para los marcadores
                    icon: { 
                        url: 'img/marker-blue.png', // Icono azul predeterminado
                        scaledSize: new google.maps.Size(32, 32)
                    },
                    title: `Parada ${index}: ${parada.nombreParada}`
                });
                stopMarkers.push(marker); // Almacena para posible gesti√≥n posterior
            });

            overlay.style.display = 'block';
            overlay.textContent = 'Esperando permisos de ubicaci√≥n y destino del padre...';

            // Intentar obtener la posici√≥n una vez al inicio para disparar el permiso del navegador
            // Esto es solo para la primera solicitud de permiso si no se ha hecho antes.
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log("Permiso de geolocalizaci√≥n obtenido al inicio.");
                    // No hacemos nada m√°s aqu√≠, watchUserPosition() se encargar√° cuando el padre lo pida.
                },
                (error) => {
                    console.warn("No se pudo obtener la ubicaci√≥n al inicio (posiblemente permiso denegado o no solicitado):", error.code);
                    if (error.code === error.PERMISSION_DENIED) {
                        window.parent.postMessage({ type: "coordenadas-error", error: "Permiso de geolocalizaci√≥n denegado. La aplicaci√≥n no podr√° funcionar sin √©l." }, "*");
                        overlay.textContent = "Error: Permiso de ubicaci√≥n denegado. Habilita la ubicaci√≥n en tu navegador para continuar.";
                    }
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );

            // *** IMPORTANTE: Enviamos las paradas al padre al cargarse ***
            window.parent.postMessage({ type: "gps-hijo-listo", paradas: paradasAventura }, "*");

            // A√±adir event listeners para el bot√≥n de la c√°mara y el bot√≥n de cerrar
            cameraButton.addEventListener('click', showDestinationImage);
            closeImageButton.addEventListener('click', hideDestinationImage);
            
            // Listener para cuando la imagen termina de cargar
            destinationImage.addEventListener('load', () => {
                imageSpinner.style.display = 'none'; // Ocultar spinner
                destinationImage.style.display = 'block'; // Mostrar imagen
                closeImageButton.style.display = 'block'; // Mostrar bot√≥n de cerrar
            });

            // Manejo de errores de carga de imagen
            destinationImage.addEventListener('error', () => {
                imageSpinner.style.display = 'none'; // Ocultar spinner
                destinationImage.style.display = 'none'; // Asegurarse de que la imagen no se muestre si hay error
                closeImageButton.style.display = 'block'; // Mostrar bot√≥n de cerrar para que el usuario pueda cerrar el modal
                console.error("Error al cargar la imagen: " + destinationImage.src);
                overlay.textContent = "No se pudo cargar la imagen del destino. Verifica la ruta."; // Mensaje al usuario
                // Tambi√©n podr√≠as enviar un mensaje al padre si quieres que maneje este error
                window.parent.postMessage({ type: "imagen-error", imageUrl: destinationImage.src }, "*");
            });

            updateCameraButtonVisibility(); // Actualizar la visibilidad inicial del bot√≥n de la c√°mara
        }

        // Funci√≥n para calcular la distancia entre dos puntos (f√≥rmula de Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const œÜ1 = lat1 * Math.PI / 180; // lat1 en radianes
            const œÜ2 = lat2 * Math.PI / 180; // lat2 en radianes
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180; // Diferencia de latitud en radianes
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180; // Diferencia de longitud en radianes

            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distancia en metros
        }

        // Funci√≥n centralizada para controlar la visibilidad del bot√≥n de la c√°mara
        function updateCameraButtonVisibility() {
            if (currentTargetData && document.getElementById('map').style.display !== 'none' && imageModalOverlay.style.display === 'none') {
                cameraButton.style.display = 'flex';
            } else {
                cameraButton.style.display = 'none';
            }
        }

        // Funci√≥n para iniciar la observaci√≥n de la posici√≥n del usuario
        function watchUserPosition() {
            // Limpiar el observador anterior si ya existe para evitar duplicados
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }

            // Resetear las banderas para la nueva parada
            arrivalSent = false;
            proximitySent = false; 

            updateCameraButtonVisibility(); // Actualizar visibilidad del bot√≥n al iniciar/reiniciar

            overlay.textContent = 'Obteniendo ubicaci√≥n...';
            
            // Iniciar la observaci√≥n de geolocalizaci√≥n
            watchId = navigator.geolocation.watchPosition((position) => {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;
                const accuracy = position.coords.accuracy; // Precisi√≥n en metros
                const userLatLng = new google.maps.LatLng(userLat, userLon);

                userMarker.setPosition(userLatLng); // Actualizar la posici√≥n del marcador del usuario
                map.setCenter(userLatLng); // Centrar el mapa en el usuario
                
                // Si hay un destino objetivo
                if (currentTargetData) {
                    const targetLatLng = new google.maps.LatLng(currentTargetData.lat, currentTargetData.lon);
                    
                    // Enviar siempre la ubicaci√≥n actualizada al padre
                    window.parent.postMessage({ 
                        type: "coordenadas-actualizadas", 
                        lat: userLat, 
                        lon: userLon, 
                        accuracy: accuracy,
                        targetId: currentTargetData.id,
                        distance: calculateDistance(userLat, userLon, currentTargetData.lat, currentTargetData.lon)
                    }, "*");

                    const requestOptions = {
                        origin: userLatLng,
                        destination: targetLatLng,
                        travelMode: google.maps.TravelMode.WALKING
                    };

                    // A√±adir waypoints si existen para la parada actual
                    if (currentTargetData.waypoints && currentTargetData.waypoints.length > 0) {
                        requestOptions.waypoints = currentTargetData.waypoints.map(wp => ({
                            location: new google.maps.LatLng(wp.lat, wp.lon),
                            stopover: false
                        }));
                        requestOptions.optimizeWaypoints = false;
                    }

                    directionsService.route(requestOptions, (response, status) => {
                        if (status === 'OK') {
                            directionsRenderer.setDirections(response);
                            const leg = response.routes[0].legs[0];
                            const distance = leg.distance.value; // Distancia en metros

                            overlay.textContent = `Dir√≠gete a: ${currentTargetData.nombreParada}.\nDistancia: ${leg.distance.text} (${leg.duration.text})\nPrecisi√≥n: ${accuracy.toFixed(0)}m`;
                            
                            // L√≥gica de proximidad (ej. a 70m antes del radio de llegada)
                            const proximityThreshold = currentTargetData.radio + 70; 
                            if (distance <= proximityThreshold && distance > currentTargetData.radio && !proximitySent) {
                                console.log(`Cerca del punto ${currentTargetData.nombreParada}. Distancia: ${distance}m`);
                                window.parent.postMessage({ 
                                    type: "coordenadas-cerca", 
                                    paradaIndex: currentTargetIndex,
                                    paradaId: currentTargetData.id,
                                    paradaNombre: currentTargetData.nombreParada
                                }, "*");
                                proximitySent = true; 
                            } else if (distance > proximityThreshold && proximitySent) {
                                // Si se aleja despu√©s de haber estado cerca
                                console.log(`Alej√°ndose del punto ${currentTargetData.nombreParada}. Distancia: ${distance}m`);
                                window.parent.postMessage({ 
                                    type: "coordenadas-lejos", 
                                    paradaIndex: currentTargetIndex,
                                    paradaId: currentTargetData.id,
                                    paradaNombre: currentTargetData.nombreParada
                                }, "*");
                                proximitySent = false; 
                                arrivalSent = false; 
                            }
                            
                            // L√≥gica de llegada
                            if (distance <= currentTargetData.radio && !arrivalSent) {
                                overlay.textContent = `¬°Has llegado a ${currentTargetData.nombreParada}!`;
                                window.parent.postMessage({ 
                                    type: "coordenadas-completadas", 
                                    paradaIndex: currentTargetIndex,
                                    paradaId: currentTargetData.id,
                                    paradaNombre: currentTargetData.nombreParada,
                                    audioUrl: currentTargetData.audio // Enviar la URL del audio
                                }, "*"); 
                                arrivalSent = true; 
                                if (watchId) {
                                    navigator.geolocation.clearWatch(watchId); // Detener la observaci√≥n hasta la siguiente parada
                                    watchId = null; 
                                }
                                directionsRenderer.setDirections({ routes: [] }); // Borrar la ruta del mapa
                                
                                map.setCenter(targetLatLng); // Centrar el mapa en la parada final con un zoom mayor
                                map.setZoom(18); 

                                hideMapContent(); // Oculta el contenido del mapa para que el padre pueda mostrar el audio
                            }
                        } else {
                            // Si Directions API falla, usamos la distancia directa (Haversine)
                            const directDistance = calculateDistance(userLat, userLon, currentTargetData.lat, currentTargetData.lon);
                            overlay.textContent = `Dir√≠gete a: ${currentTargetData.nombreParada}.\nDistancia: ${directDistance.toFixed(0)}m (ruta no disponible)\nPrecisi√≥n: ${accuracy.toFixed(0)}m`;
                            console.error('Directions request failed due to ' + status + '. Calculando distancia directa.');
                            directionsRenderer.setDirections({ routes: [] }); // Asegurarse de que no haya ruta vieja

                            // L√≥gica de proximidad con distancia directa
                            const proximityThreshold = currentTargetData.radio + 70;
                            if (directDistance <= proximityThreshold && directDistance > currentTargetData.radio && !proximitySent) {
                                console.log(`Cerca del punto ${currentTargetData.nombreParada}. Distancia: ${directDistance}m (directa)`);
                                window.parent.postMessage({ 
                                    type: "coordenadas-cerca", 
                                    paradaIndex: currentTargetIndex,
                                    paradaId: currentTargetData.id,
                                    paradaNombre: currentTargetData.nombreParada
                                }, "*");
                                proximitySent = true;
                            } else if (directDistance > proximityThreshold && proximitySent) {
                                console.log(`Alej√°ndose del punto ${currentTargetData.nombreParada}. Distancia: ${directDistance}m (directa)`);
                                window.parent.postMessage({ 
                                    type: "coordenadas-lejos", 
                                    paradaIndex: currentTargetIndex,
                                    paradaId: currentTargetData.id,
                                    paradaNombre: currentTargetData.nombreParada
                                }, "*");
                                proximitySent = false;
                                arrivalSent = false;
                            }
                            
                            // L√≥gica de llegada con distancia directa
                            if (directDistance <= currentTargetData.radio && !arrivalSent) {
                                overlay.textContent = `¬°Has llegado a ${currentTargetData.nombreParada}!`;
                                window.parent.postMessage({ 
                                    type: "coordenadas-completadas", 
                                    paradaIndex: currentTargetIndex,
                                    paradaId: currentTargetData.id,
                                    paradaNombre: currentTargetData.nombreParada,
                                    audioUrl: currentTargetData.audio // Enviar la URL del audio
                                }, "*"); 
                                arrivalSent = true;
                                if (watchId) {
                                    navigator.geolocation.clearWatch(watchId);
                                    watchId = null;
                                }
                                map.setCenter(targetLatLng);
                                map.setZoom(18);

                                hideMapContent(); // Oculta el contenido del mapa para que el padre pueda mostrar el audio
                            }
                        }
                    });
                } else {
                    overlay.textContent = 'Ubicaci√≥n actual: ' + userLat.toFixed(5) + ', ' + userLon.toFixed(5) + ` (Precisi√≥n: ${accuracy.toFixed(0)}m)\nEsperando destino...`;
                    directionsRenderer.setDirections({ routes: [] }); // Borrar cualquier ruta existente
                }
                updateCameraButtonVisibility(); // Actualizar visibilidad del bot√≥n despu√©s de cada actualizaci√≥n
            }, (error) => {
                console.error('Error de geolocalizaci√≥n:', error);
                let errorMessage = 'Error de ubicaci√≥n: ';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage += 'Permiso denegado. Habilita la ubicaci√≥n en tu navegador.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage += 'Ubicaci√≥n no disponible.';
                        break;
                    case error.TIMEOUT:
                        errorMessage += 'Tiempo de espera agotado. Intenta de nuevo.';
                        break;
                    case error.UNKNOWN_ERROR:
                        errorMessage += 'Error desconocido.';
                        break;
                }
                overlay.textContent = errorMessage;
                window.parent.postMessage({ type: "coordenadas-error", error: errorMessage }, "*");
                if (watchId) { // Asegurarse de limpiar el watch en caso de error
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }
                updateCameraButtonVisibility(); // Actualizar visibilidad del bot√≥n en caso de error
            }, {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 15000 
            });
        }

        // Funci√≥n para mostrar la imagen del destino actual (este modal se mantiene en el hijo)
        function showDestinationImage() {
            if (currentTargetData && currentTargetData.imagen) {
                imageSpinner.style.display = 'block'; // Mostrar spinner
                destinationImage.style.display = 'none'; // Ocultar imagen mientras carga
                closeImageButton.style.display = 'none'; // Ocultar bot√≥n de cerrar mientras carga
                destinationImage.src = currentTargetData.imagen;  
                imageModalOverlay.style.display = 'flex'; // Mostrar la superposici√≥n
                window.parent.postMessage({ type: "imagen-modal-abierto" }, "*"); // Notificar al padre
            } else {
                console.warn('No hay imagen disponible para este destino o currentTargetData es nulo.');
                overlay.textContent = 'No hay imagen disponible para este destino.'; // Mensaje al usuario
                imageModalOverlay.style.display = 'none'; // Asegurarse de que el modal est√© oculto
            }
            updateCameraButtonVisibility(); // Actualizar visibilidad del bot√≥n
        }

        // Funci√≥n para ocultar la imagen del destino
        function hideDestinationImage() {
            imageModalOverlay.style.display = 'none'; // Ocultar la superposici√≥n
            destinationImage.src = ''; // Limpiar la imagen para ahorrar memoria
            imageSpinner.style.display = 'none'; // Asegurarse de que el spinner tambi√©n est√© oculto
            destinationImage.style.display = 'none'; // Resetear estado de la imagen
            closeImageButton.style.display = 'none'; // Resetear estado del bot√≥n
            window.parent.postMessage({ type: "imagen-modal-cerrado" }, "*"); // Notificar al padre
            updateCameraButtonVisibility(); // Actualizar visibilidad del bot√≥n
        }
        
        // --- Funciones para controlar la visibilidad del contenido del mapa ---
        function hideMapContent() {
            document.getElementById('map').style.display = 'none';
            document.getElementById('message-overlay').style.display = 'none';
            // Detener watchId si el mapa se oculta y no estamos en un estado de "llegada"
            if (watchId && !arrivalSent) { 
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                console.log("GPS watch detenido al ocultar el mapa.");
            }
            directionsRenderer.setMap(null); // Desasociar el DirectionsRenderer del mapa
            updateCameraButtonVisibility(); // Actualizar visibilidad del bot√≥n
        }

        function showMapContent() {
            document.getElementById('map').style.display = 'block';
            document.getElementById('message-overlay').style.display = 'block';
            directionsRenderer.setMap(map); // Reasociar el DirectionsRenderer al mapa
            
            // Si el GPS real est√° activado y hay un objetivo, retomar la observaci√≥n
            if (gpsRealActivado && currentTargetData) {
                watchUserPosition(); // Esto limpiar√° el watch existente y crear√° uno nuevo
            } else if (gpsRealActivado && !currentTargetData) {
                 // Si el GPS real est√° activado pero no hay destino, solo mostrar ubicaci√≥n actual
                watchUserPosition(); // Esto inicializar√° el watch si no existe
                overlay.textContent = "GPS Real Activado. Esperando destino...";
            }
            updateCameraButtonVisibility(); // Actualizar visibilidad del bot√≥n
        }

        // Listener para mensajes del padre
        window.addEventListener("message", (event) => {
            // En producci√≥n, es buena pr√°ctica verificar el origen:
            // if (event.origin !== "https://tu-dominio.com") return; 

            if (!event.data || !event.data.type) {
                return; // Ignorar mensajes sin tipo
            }

            console.log("Mensaje recibido del padre en GPS Hijos:", event.data.type, event.data);

            switch (event.data.type) {
                case "iniciar_gps_con_permiso":
                    gpsRealActivado = true; // Asegurarse de que el modo real est√© activado
                    showMapContent(); // Asegurarse de que el contenido del mapa est√© visible y reactive GPS si es necesario
                    break;
                case "irA_coordenadas":
                    const paradaIndex = event.data.paradaIndex;
                    if (paradaIndex !== undefined && paradasAventura[paradaIndex]) {
                        currentTargetIndex = paradaIndex;
                        currentTargetData = paradasAventura[paradaIndex];
                        console.log("Mensaje 'irA_coordenadas' recibido del padre. Destino:", currentTargetData.nombreParada);
                        
                        // Actualizar el icono del marcador de destino a rojo (actual activo) y resetear los dem√°s a azul
                        stopMarkers.forEach((marker, index) => {
                            if (index === paradaIndex) {
                                marker.setIcon({
                                    url: 'img/marker-red.png', // Marcador rojo para el objetivo actual
                                    scaledSize: new google.maps.Size(32, 32)
                                });
                            } else {
                                marker.setIcon({
                                    url: 'img/marker-blue.png', // Marcador azul para el resto
                                    scaledSize: new google.maps.Size(32, 32)
                                });
                            }
                        });

                        // Si GPS real est√° activado, iniciar/reiniciar observaci√≥n.
                        if (gpsRealActivado) {
                            showMapContent(); // Asegurarse de que el contenido del mapa est√© visible y reactive GPS
                        } else {
                            // Si no, limpiar el watch y esperar mensaje de simulaci√≥n.
                            if (watchId) { 
                                navigator.geolocation.clearWatch(watchId);
                                watchId = null;
                            }
                            directionsRenderer.setDirections({ routes: [] }); // Borrar cualquier ruta existente
                            overlay.textContent = `Esperando simulaci√≥n para: ${currentTargetData.nombreParada}`;
                            showMapContent(); // Asegurarse de que el contenido del mapa est√© visible
                        }
                    } else {
                        console.error("Mensaje 'irA_coordenadas' recibido con √≠ndice de parada inv√°lido:", paradaIndex);
                        overlay.textContent = "Error: Destino no encontrado.";
                        directionsRenderer.setDirections({ routes: [] }); 
                        if (watchId) { 
                            navigator.geolocation.clearWatch(watchId);
                            watchId = null;
                        }
                        currentTargetIndex = -1;
                        currentTargetData = null;
                        stopMarkers.forEach(marker => marker.setIcon({ url: 'img/marker-blue.png', scaledSize: new google.maps.Size(32, 32) })); // Reset all to blue
                        showMapContent(); // Asegurarse de que el contenido del mapa est√© visible
                    }
                    updateCameraButtonVisibility(); // Actualizar visibilidad del bot√≥n
                    break;
                case "simular_ubicacion":
                    gpsRealActivado = false; // Forzar modo simulaci√≥n
                    const { lat, lon, targetParadaIndex } = event.data;
                    
                    if (watchId) { 
                        navigator.geolocation.clearWatch(watchId);
                        watchId = null;
                    }
                    
                    // Consolidar la l√≥gica de asignaci√≥n de target
                    if (targetParadaIndex !== undefined && paradasAventura[targetParadaIndex]) {
                        currentTargetIndex = targetParadaIndex;
                        currentTargetData = paradasAventura[targetParadaIndex];
                        stopMarkers.forEach((marker, index) => {
                            if (index === targetParadaIndex) {
                                marker.setIcon({ url: 'img/marker-red.png', scaledSize: new google.maps.Size(32, 32) });
                            } else {
                                marker.setIcon({ url: 'img/marker-blue.png', scaledSize: new google.maps.Size(32, 32) });
                            }
                        });
                        arrivalSent = false; 
                        proximitySent = false;
                    } else if (!currentTargetData) {
                        console.warn("No hay un destino establecido o v√°lido para simular ubicaci√≥n.");
                        overlay.textContent = "Error: No hay destino v√°lido para simular.";
                        showMapContent();
                        updateCameraButtonVisibility();
                        return; // Salir de la funci√≥n si no hay un destino v√°lido
                    }

                    const simulatedLatLng = new google.maps.LatLng(lat, lon);
                    userMarker.setPosition(simulatedLatLng);
                    map.setCenter(simulatedLatLng);
                    showMapContent(); // Asegurarse de que el contenido del mapa est√© visible

                    const targetLat = currentTargetData.lat;
                    const targetLon = currentTargetData.lon;
                    const directDistance = calculateDistance(lat, lon, targetLat, targetLon);

                    const requestOptions = {
                        origin: simulatedLatLng,
                        destination: new google.maps.LatLng(targetLat, targetLon),
                        travelMode: google.maps.TravelMode.WALKING
                    };

                    if (currentTargetData.waypoints && currentTargetData.waypoints.length > 0) {
                        requestOptions.waypoints = currentTargetData.waypoints.map(wp => ({
                            location: new google.maps.LatLng(wp.lat, wp.lon),
                            stopover: false
                        }));
                        requestOptions.optimizeWaypoints = false;
                    }

                    directionsService.route(requestOptions, (response, status) => {
                        if (status === 'OK') {
                            directionsRenderer.setDirections(response);
                            const leg = response.routes[0].legs[0];
                            const distance = leg.distance.value;

                            overlay.textContent = `Ubicaci√≥n simulada: ${lat.toFixed(5)}, ${lon.toFixed(5)}\nDistancia a ${currentTargetData.nombreParada}: ${leg.distance.text} (${leg.duration.text})`;

                            const proximityThreshold = currentTargetData.radio + 70;
                            if (distance <= proximityThreshold && distance > currentTargetData.radio && !proximitySent) {
                                window.parent.postMessage({ 
                                    type: "coordenadas-cerca", 
                                    paradaIndex: currentTargetIndex,
                                    paradaId: currentTargetData.id,
                                    paradaNombre: currentTargetData.nombreParada
                                }, "*");
                                proximitySent = true;
                            } else if (distance > proximityThreshold && proximitySent) {
                                window.parent.postMessage({ 
                                    type: "coordenadas-lejos", 
                                    paradaIndex: currentTargetIndex,
                                    paradaId: currentTargetData.id,
                                    paradaNombre: currentTargetData.nombreParada
                                }, "*");
                                proximitySent = false;
                                arrivalSent = false;
                            }

                            if (distance <= currentTargetData.radio && !arrivalSent) {
                                overlay.textContent = `¬°Has llegado a ${currentTargetData.nombreParada}! (Simulado)`;
                                window.parent.postMessage({ 
                                    type: "coordenadas-completadas", 
                                    paradaIndex: currentTargetIndex,
                                    paradaId: currentTargetData.id,
                                    paradaNombre: currentTargetData.nombreParada,
                                    audioUrl: currentTargetData.audio 
                                }, "*");
                                arrivalSent = true;
                                directionsRenderer.setDirections({ routes: [] });
                                map.setCenter(new google.maps.LatLng(targetLat, targetLon));
                                map.setZoom(18);

                                hideMapContent(); 
                            }
                        } else {
                            overlay.textContent = `Ubicaci√≥n simulada: ${lat.toFixed(5)}, ${lon.toFixed(5)}\nDistancia a ${currentTargetData.nombreParada}: ${directDistance.toFixed(0)}m (ruta no disponible)`;
                            directionsRenderer.setDirections({ routes: [] });

                            const proximityThreshold = currentTargetData.radio + 70;
                            if (directDistance <= proximityThreshold && directDistance > currentTargetData.radio && !proximitySent) {
                                window.parent.postMessage({ 
                                    type: "coordenadas-cerca", 
                                    paradaIndex: currentTargetIndex,
                                    paradaId: currentTargetData.id,
                                    paradaNombre: currentTargetData.nombreParada
                                }, "*");
                                proximitySent = true;
                            } else if (directDistance > proximityThreshold && proximitySent) {
                                window.parent.postMessage({ 
                                    type: "coordenadas-lejos", 
                                    paradaIndex: currentTargetIndex,
                                    paradaId: currentTargetData.id,
                                    paradaNombre: currentTargetData.nombreParada
                                }, "*");
                                proximitySent = false;
                                arrivalSent = false;
                            }

                            if (directDistance <= currentTargetData.radio && !arrivalSent) {
                                overlay.textContent = `¬°Has llegado a ${currentTargetData.nombreParada}! (Simulado)`;
                                window.parent.postMessage({ 
                                    type: "coordenadas-completadas", 
                                    paradaIndex: currentTargetIndex,
                                    paradaId: currentTargetData.id,
                                    paradaNombre: currentTargetData.nombreParada,
                                    audioUrl: currentTargetData.audio 
                                }, "*");
                                arrivalSent = true;
                                map.setCenter(new google.maps.LatLng(targetLat, targetLon));
                                map.setZoom(18);

                                hideMapContent(); 
                            }
                        }
                        updateCameraButtonVisibility(); // Actualizar visibilidad del bot√≥n
                    });
                    break;
                case "detener_gps":
                    if (watchId) {
                        navigator.geolocation.clearWatch(watchId);
                        watchId = null;
                    }
                    overlay.textContent = "GPS detenido.";
                    directionsRenderer.setDirections({ routes: [] });
                    currentTargetIndex = -1; // Resetear el objetivo
                    currentTargetData = null;
                    // Resetear todos los marcadores a azul
                    stopMarkers.forEach((marker) => {
                        marker.setIcon({
                            url: 'img/marker-blue.png', 
                            scaledSize: new google.maps.Size(32, 32)
                        });
                    });
                    showMapContent(); // Volver a mostrar el contenido del mapa
                    updateCameraButtonVisibility(); // Actualizar visibilidad del bot√≥n
                    break;
                case "activar_gps_real":
                    gpsRealActivado = true;
                    // Resetear todos los marcadores a azul si no hay un objetivo activo
                    // Si hay un objetivo activo, el mensaje 'irA_coordenadas' lo manejar√° al reestablecerlo
                    if (currentTargetIndex === -1) { 
                        stopMarkers.forEach((marker) => {
                            marker.setIcon({
                                url: 'img/marker-blue.png', 
                                scaledSize: new google.maps.Size(32, 32)
                            });
                        });
                    }
                    showMapContent(); // Asegurarse de que el contenido del mapa est√© visible y active GPS
                    updateCameraButtonVisibility(); // Actualizar visibilidad del bot√≥n
                    break;
                case "desactivar_gps_real":
                    gpsRealActivado = false;
                    if (watchId) {
                        navigator.geolocation.clearWatch(watchId);
                        watchId = null;
                    }
                    overlay.textContent = "GPS Desactivado. Usa el modo de simulaci√≥n o activa el GPS real.";
                    directionsRenderer.setDirections({ routes: [] });
                    // No cambiamos el icono del currentTarget si estamos en modo simulaci√≥n y hay uno
                    // porque el modo simulaci√≥n podr√≠a necesitar el marcador rojo.
                    // Si no hay target, todos deben ser azules.
                    if (currentTargetIndex === -1) {
                         stopMarkers.forEach((marker) => {
                            marker.setIcon({
                                url: 'img/marker-blue.png', 
                                scaledSize: new google.maps.Size(32, 32)
                            });
                        });
                    }
                    showMapContent(); // Asegurarse de que el contenido del mapa est√© visible
                    updateCameraButtonVisibility(); // Actualizar visibilidad del bot√≥n
                    break;
                case "mostrar_mapa": 
                    showMapContent();
                    break;
                case "ocultar_mapa": 
                    hideMapContent();
                    break;
                case "mapa-hijo-focus-next-point": 
                    if (currentTargetData) {
                        map.setCenter(new google.maps.LatLng(currentTargetData.lat, currentTargetData.lon));
                        map.setZoom(18); 
                        overlay.textContent = `Centrado en: ${currentTargetData.nombreParada}`;
                    } else {
                        overlay.textContent = "No hay un destino activo para centrar.";
                    }
                    break;
                case "mapa-hijo-show-full-route": 
                    if (directionsRenderer.getDirections()) {
                        map.fitBounds(directionsRenderer.getDirections().routes[0].bounds);
                        overlay.textContent = "Mostrando ruta completa.";
                    } else if (currentTargetData && userMarker.getPosition()) {
                        const bounds = new google.maps.LatLngBounds();
                        bounds.extend(userMarker.getPosition());
                        bounds.extend(new google.maps.LatLng(currentTargetData.lat, currentTargetData.lon));
                        map.fitBounds(bounds);
                        overlay.textContent = "Mostrando vista general entre tu posici√≥n y el destino.";
                    } else {
                        overlay.textContent = "No hay ruta activa o ubicaci√≥n para mostrar.";
                    }
                    break;
            }
        });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADA891ty6RNChTmaTd2JUCfUM9y3Ia6pM&callback=initMap"></script>
</body>
</html>
