<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Detección de parada por coordenadas</title>
</head>
<body>
  <h1>Detección de parada</h1>
  <p id="estado">Esperando ubicación…</p>

  <script>
    const paradas = [
      { nombre: "Torres de Serranos", lat: 39.4795, lng: -0.3757 },
      { nombre: "Puente de Serranos – Plaza de la crida", lat: 39.4782, lng: -0.3750 },
      { nombre: "Cortes Valencianas (Palacio de los Borgia)", lat: 39.4788, lng: -0.3744 },
      { nombre: "Plaza de la Virgen", lat: 39.4781, lng: -0.3766 },
      { nombre: "Plaza de la Almoína", lat: 39.4777, lng: -0.3758 },
      { nombre: "Catedral de València", lat: 39.4776, lng: -0.3753 },
      { nombre: "Plaza decimo Juno Bruto", lat: 39.4771, lng: -0.3749 },
      { nombre: "Basílica de València", lat: 39.4780, lng: -0.3754 },
      { nombre: "Palacio Arzobispal", lat: 39.4775, lng: -0.3756 },
      { nombre: "Plaza del Ayuntamiento", lat: 39.4698, lng: -0.3763 },
      { nombre: "Edificio del Ayuntamiento de València", lat: 39.4695, lng: -0.3762 },
      { nombre: "Estación de Ferrocarril (Estación del Norte)", lat: 39.4655, lng: -0.3770 },
      { nombre: "Plaza de Toros de València", lat: 39.4652, lng: -0.3767 },
      { nombre: "Casa estilo Árabe", lat: 39.4672, lng: -0.3759 },
      { nombre: "Palacio de Comunicaciones (Correos)", lat: 39.4693, lng: -0.3761 },
      { nombre: "Antigua sede del Banco de València", lat: 39.4691, lng: -0.3760 },
      { nombre: "Palacio del Marqués de Dos Aguas", lat: 39.4703, lng: -0.3747 },
      { nombre: "Mercado Central", lat: 39.4741, lng: -0.3780 },
      { nombre: "San Juan del Mercado", lat: 39.4739, lng: -0.3776 },
      { nombre: "Lonja de València", lat: 39.4742, lng: -0.3772 },
      { nombre: "Plaza del Doctor Collado", lat: 39.4740, lng: -0.3768 },
      { nombre: "Plaza del Negrito", lat: 39.4760, lng: -0.3755 },
      { nombre: "Calle Caballeros", lat: 39.4768, lng: -0.3751 },
      { nombre: "Palacio de la Generalitat", lat: 39.4784, lng: -0.3752 },
    ];

    function slugify(texto) {
      return texto.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // quita acentos
        .replace(/[^a-z0-9]+/g, '-')                     // reemplaza no alfanumérico por guiones
        .replace(/(^-|-$)/g, '');                        // quita guiones al inicio/final
    }

    function getDistanceMeters(lat1, lng1, lat2, lng2) {
      const R = 6371000; // Radio Tierra en m
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function detectarParada(pos) {
      const { latitude, longitude } = pos.coords;

      for (const parada of paradas) {
        const dist = getDistanceMeters(latitude, longitude, parada.lat, parada.lng);
        if (dist < 15) {
          const slug = slugify(parada.nombre);
          document.getElementById("estado").textContent =
            Estás en: ${parada.nombre} (${Math.round(dist)} m);

          // ✅ Paso 1: enviar slug/id robusto al padre
          window.parent.postMessage({ tipo: "parada_detectada", id: slug }, "*");
          return;
        }
      }

      document.getElementById("estado").textContent =
        No estás cerca de ninguna parada (${latitude.toFixed(5)}, ${longitude.toFixed(5)});
    }

    function error(err) {
      document.getElementById("estado").textContent = "Error obteniendo ubicación: " + err.message;
    }

    navigator.geolocation.watchPosition(detectarParada, error, {
      enableHighAccuracy: true,
      maximumAge: 1000,
      timeout: 5000,
    });
  </script>
</body>
</html>
