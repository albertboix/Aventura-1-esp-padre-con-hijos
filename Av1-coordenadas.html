<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Detección de parada por coordenadas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 1em;
      position: relative;
      min-height: 100vh;
    }
    #estado {
      margin: 1em 0;
      font-weight: bold;
    }
    #listaParadas {
      list-style: none;
      padding: 0;
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    #listaParadas li {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      transition: background-color 0.3s;
    }
    #listaParadas li:hover {
      background-color: #f0f0f0;
    }
    #btnMapa {
      margin: 1em 0;
      padding: 8px 16px;
      cursor: pointer;
      background-color: #007bff;
      border: none;
      border-radius: 4px;
      color: white;
      font-size: 1em;
    }
    #map {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 1000;
      display: none;
    }
    #map.leaflet-container {
      width: 100%;
      height: 100%;
    }
    #cerrarMapa {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1100;
      background: rgba(255,255,255,0.9);
      border: none;
      padding: 6px 12px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
    }
  </style>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-o1bfrXJsAw+ZjF0wtX+c2LuRm2zI8Fw7QCEaqN+Q8kw="
    crossorigin=""
  />
</head>
<body>
  <h1>Detección de parada</h1>
  <p id="estado">Esperando ubicación…</p>

  <button id="btnMapa">Mostrar mapa</button>

  <ul id="listaParadas" aria-label="Lista de paradas"></ul>

  <div id="map">
    <button id="cerrarMapa">Cerrar mapa ✕</button>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-oCknbDwhJyoZ0chF88PlJ8uyT3+q3lvVZ/QQ5CRd9lg="
    crossorigin=""
  ></script>

  <script>
    const paradas = [
      { tipo: "parada", nombre: "Torres de Serranos (start)", lat: 39.47876, lng: -0.37626 },
  { tipo: "waypoint", lat: 39.47905, lng: -0.37613 },
  { tipo: "waypoint", lat: 39.47933, lng: -0.37647 },
  { tipo: "waypoint", lat: 39.47943, lng: -0.37636 },
  { tipo: "parada", nombre: "Puente de Serranos – Plaza de la crida", lat: 39.47959, lng: -0.37583 },
  { tipo: "waypoint", lat: 39.47939, lng: -0.3752 },
  { tipo: "waypoint", lat: 39.47902, lng: -0.37465 },
  { tipo: "waypoint", lat: 39.47866, lng: -0.3747 },
  { tipo: "parada", nombre: "Cortes Valencianas (Palacio de los Borgia)", lat: 39.47785, lng: -0.37485 },
  { tipo: "waypoint", lat: 39.47768, lng: -0.3749 },
  { tipo: "parada", nombre: "Plaza de la Virgen", lat: 39.47656, lng: -0.37529 },
  { tipo: "waypoint", lat: 39.4766, lng: -0.37473 },
  { tipo: "waypoint", lat: 39.47656, lng: -0.37453 },
  { tipo: "waypoint", lat: 39.47606, lng: -0.3746 },
  { tipo: "parada", nombre: "Plaza de la Almoína", lat: 39.47604, lng: -0.37451 },
  { tipo: "parada", nombre: "Catedral de València", lat: 39.47594, lng: -0.37474 },
  { tipo: "parada", nombre: "Plaza decimo Juno Bruto (Museo Arqueológico de la Almoína)", lat: 39.4762, lng: -0.37412 },
  { tipo: "parada", nombre: "Basílica de València", lat: 39.47611, lng: -0.37478 },
  { tipo: "waypoint", lat: 39.47603, lng: -0.37433 },
  { tipo: "parada", nombre: "Palacio Arzobispal", lat: 39.4755, lng: -0.37436 },
  { tipo: "waypoint", lat: 39.4756, lng: -0.37466 },
  { tipo: "waypoint", lat: 39.47514, lng: -0.37494 },
  { tipo: "waypoint", lat: 39.47447, lng: -0.3754 },
  { tipo: "waypoint", lat: 39.47378, lng: -0.3756 },
  { tipo: "waypoint", lat: 39.47212, lng: -0.37676 },
  { tipo: "parada", nombre: "Plaza del Ayuntamiento", lat: 39.47056, lng: -0.37677 },
  { tipo: "parada", nombre: "Edificio del Ayuntamiento de València", lat: 39.46971, lng: -0.37693 },
  { tipo: "waypoint", lat: 39.46795, lng: -0.37701 },
  { tipo: "parada", nombre: "Estación de Ferrocarril (Estación del Norte)", lat: 39.46722, lng: -0.37702 },
  { tipo: "parada", nombre: "Plaza de Toros de València", lat: 39.46709, lng: -0.37595 },
  { tipo: "waypoint", lat: 39.46714, lng: -0.37498 },
  { tipo: "parada", nombre: "Casa estilo Árabe", lat: 39.46753, lng: -0.37511 },
  { tipo: "parada", nombre: "Palacio de Comunicaciones (Correos)", lat: 39.46942, lng: -0.37559 },
  { tipo: "waypoint", lat: 39.4699, lng: -0.37573 },
  { tipo: "waypoint", lat: 39.4703, lng: -0.3759 },
  { tipo: "waypoint", lat: 39.47039, lng: -0.37505 },
  { tipo: "waypoint", lat: 39.47043, lng: -0.37427 },
  { tipo: "parada", nombre: "Antigua sede del Banco de València", lat: 39.47061, lng: -0.37408 },
  { tipo: "waypoint", lat: 39.47119, lng: -0.37423 },
  { tipo: "waypoint", lat: 39.47214, lng: -0.37446 },
  { tipo: "waypoint", lat: 39.47275, lng: -0.37445 },
  { tipo: "parada", nombre: "Palacio del Marqués de Dos Aguas (Museo Nacional de Crámica)", lat: 39.47276, lng: -0.37467 },
  { tipo: "waypoint", lat: 39.47315, lng: -0.37608 },
  { tipo: "waypoint", lat: 39.47261, lng: -0.37654 },
  { tipo: "waypoint", lat: 39.47225, lng: -0.37686 },
  { tipo: "waypoint", lat: 39.47265, lng: -0.37725 },
  { tipo: "parada", nombre: "Mercado Central", lat: 39.47377, lng: -0.37832 },
  { tipo: "parada", nombre: "San Juan del Mercado (Iglesia de los Santos Juanes)", lat: 39.47425, lng: -0.37895 },
  { tipo: "parada", nombre: "Lonja de València (Mercado de la Seda)", lat: 39.47426, lng: -0.37862 },
  { tipo: "waypoint", lat: 39.47445, lng: -0.37889 },
  { tipo: "waypoint", lat: 39.47459, lng: -0.37868 },
  { tipo: "waypoint", lat: 39.47475, lng: -0.37842 },
  { tipo: "waypoint", lat: 39.47436, lng: -0.37799 },
  { tipo: "parada", nombre: "Plaza del Doctor Collado", lat: 39.47444, lng: -0.3779 },
  { tipo: "waypoint", lat: 39.47473, lng: -0.37763 },
  { tipo: "waypoint", lat: 39.47493, lng: -0.37761 },
  { tipo: "waypoint", lat: 39.47559, lng: -0.37772 },
  { tipo: "parada", nombre: "Plaza del Negrito (Fuente del Negrito)", lat: 39.47611, lng: -0.37741 },
  { tipo: "parada", nombre: "Calle Caballeros", lat: 39.47663, lng: -0.3773 },
  { tipo: "waypoint", lat: 39.47661, lng: -0.37685 },
  { tipo: "parada", nombre: "Palacio de la Generalitat", lat: 39.47668, lng: -0.37671 },
  { tipo: "waypoint", lat: 39.47661, lng: -0.37685 },
  { tipo: "waypoint", lat: 39.47687, lng: -0.37686 },
  { tipo: "parada", nombre: "Calle de los Serranos (end)", lat: 39.47773, lng: -0.37671 }
    ];

    // Rellenar lista de paradas con li clicables
    const lista = document.getElementById('listaParadas');
    paradas.forEach((parada, i) => {
      const li = document.createElement('li');
      li.textContent = parada.nombre;
      li.tabIndex = 0; // accesible con teclado
      li.setAttribute('role', 'button');
      li.addEventListener('click', () => {
        document.getElementById('estado').textContent = `Parada seleccionada: ${parada.nombre}`;
      });
      li.addEventListener('keypress', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          li.click();
        }
      });
      lista.appendChild(li);
    });

    // Enviar las coordenadas al padre para que pinte la ruta en el mapa padre
    window.addEventListener("load", () => {
      const puntos = paradas.map(({nombre, lat, lng}) => ({ nombre, lat, lng }));
      window.parent.postMessage({ tipo: "coordenadas", puntos }, "*");
    });

    // Función para slugificar
    function slugify(texto) {
      return texto.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '');
    }

    // Calcular distancia en metros
    function getDistanceMeters(lat1, lng1, lat2, lng2) {
      const R = 6371000;
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Detección de parada por GPS
    function detectarParada(pos) {
      const { latitude, longitude } = pos.coords;

      for (const parada of paradas) {
        const dist = getDistanceMeters(latitude, longitude, parada.lat, parada.lng);
        if (dist < 15) {
          const slug = slugify(parada.nombre);
          document.getElementById("estado").textContent =
            `Estás en: ${parada.nombre} (${Math.round(dist)} m)`;

          // Enviar al padre (si se usa iframe)
          window.parent.postMessage({ tipo: "parada_detectada", id: slug }, "*");
          return;
        }
      }

      document.getElementById("estado").textContent =
        `No estás cerca de ninguna parada (${latitude.toFixed(5)}, ${longitude.toFixed(5)})`;
    }

    // Error geolocalización
    function error(err) {
      document.getElementById("estado").textContent = "Error obteniendo ubicación: " + err.message;
    }

    // Iniciar geolocalización
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(detectarParada, error, {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 5000,
      });
    } else {
      document.getElementById("estado").textContent = "Geolocalización no soportada por este navegador.";
    }

    // --- MAPA LEAFLET ---

    const btnMapa = document.getElementById('btnMapa');
    const mapDiv = document.getElementById('map');
    const cerrarMapaBtn = document.getElementById('cerrarMapa');
    let map;
    let markers = [];

    btnMapa.addEventListener('click', () => {
      if (!map) {
        // Crear mapa centrado en la primera parada
        map = L.map('map').setView([paradas[0].lat, paradas[0].lng], 15);

        // Capa de mapa OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Añadir marcadores
        paradas.forEach(parada => {
          const marker = L.marker([parada.lat, parada.lng]).addTo(map);
          marker.bindPopup(parada.nombre);
          markers.push(marker);
        });
      }

      mapDiv.style.display = 'block';
      map.invalidateSize(); // ajustar tamaño tras mostrar
    });

    cerrarMapaBtn.addEventListener('click', () => {
      mapDiv.style.display = 'none';
    });
  </script>
</body>
</html>
