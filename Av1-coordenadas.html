<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Detección de parada por coordenadas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 1em;
      position: relative;
      min-height: 100vh;
    }
    #estado {
      margin: 1em 0;
      font-weight: bold;
    }
    #listaParadas {
      list-style: none;
      padding: 0;
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    #listaParadas li {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      transition: background-color 0.3s;
    }
    #listaParadas li:hover {
      background-color: #f0f0f0;
    }
    #btnMapa {
      margin: 1em 0;
      padding: 8px 16px;
      cursor: pointer;
      background-color: #007bff;
      border: none;
      border-radius: 4px;
      color: white;
      font-size: 1em;
    }
    #map {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 1000;
      display: none;
    }
    #map.leaflet-container {
      width: 100%;
      height: 100%;
    }
    #cerrarMapa {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1100;
      background: rgba(255,255,255,0.9);
      border: none;
      padding: 6px 12px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
    }
  </style>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-o1bfrXJsAw+ZjF0wtX+c2LuRm2zI8Fw7QCEaqN+Q8kw="
    crossorigin=""
  />
</head>
<body>
  <h1>Detección de parada</h1>
  <p id="estado">Esperando ubicación…</p>

  <button id="btnMapa">Mostrar mapa</button>

  <ul id="listaParadas" aria-label="Lista de paradas"></ul>

  <div id="map">
    <button id="cerrarMapa">Cerrar mapa ✕</button>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-oCknbDwhJyoZ0chF88PlJ8uyT3+q3lvVZ/QQ5CRd9lg="
    crossorigin=""
  ></script>

  <script>
    const paradas = [
      { nombre: "Torres de Serranos", lat: 39.4795, lng: -0.3757 },
      { nombre: "Puente de Serranos – Plaza de la crida", lat: 39.4782, lng: -0.3750 },
      { nombre: "Cortes Valencianas (Palacio de los Borgia)", lat: 39.4788, lng: -0.3744 },
      { nombre: "Plaza de la Virgen", lat: 39.4781, lng: -0.3766 },
      { nombre: "Plaza de la Almoína", lat: 39.4777, lng: -0.3758 },
      { nombre: "Catedral de València", lat: 39.4776, lng: -0.3753 },
      { nombre: "Plaza decimo Juno Bruto", lat: 39.4771, lng: -0.3749 },
      { nombre: "Basílica de València", lat: 39.4780, lng: -0.3754 },
      { nombre: "Palacio Arzobispal", lat: 39.4775, lng: -0.3756 },
      { nombre: "Plaza del Ayuntamiento", lat: 39.4698, lng: -0.3763 },
      { nombre: "Edificio del Ayuntamiento de València", lat: 39.4695, lng: -0.3762 },
      { nombre: "Estación de Ferrocarril (Estación del Norte)", lat: 39.4655, lng: -0.3770 },
      { nombre: "Plaza de Toros de València", lat: 39.4652, lng: -0.3767 },
      { nombre: "Casa estilo Árabe", lat: 39.4672, lng: -0.3759 },
      { nombre: "Palacio de Comunicaciones (Correos)", lat: 39.4693, lng: -0.3761 },
      { nombre: "Antigua sede del Banco de València", lat: 39.4691, lng: -0.3760 },
      { nombre: "Palacio del Marqués de Dos Aguas", lat: 39.4703, lng: -0.3747 },
      { nombre: "Mercado Central", lat: 39.4741, lng: -0.3780 },
      { nombre: "San Juan del Mercado", lat: 39.4739, lng: -0.3776 },
      { nombre: "Lonja de València", lat: 39.4742, lng: -0.3772 },
      { nombre: "Plaza del Doctor Collado", lat: 39.4740, lng: -0.3768 },
      { nombre: "Plaza del Negrito", lat: 39.4760, lng: -0.3755 },
      { nombre: "Calle Caballeros", lat: 39.4768, lng: -0.3751 },
      { nombre: "Palacio de la Generalitat", lat: 39.4784, lng: -0.3752 }
    ];

    // Rellenar lista de paradas con li clicables
    const lista = document.getElementById('listaParadas');
    paradas.forEach((parada, i) => {
      const li = document.createElement('li');
      li.textContent = parada.nombre;
      li.tabIndex = 0; // que sea accesible con teclado
      li.setAttribute('role', 'button');
      li.addEventListener('click', () => {
        document.getElementById('estado').textContent = `Parada seleccionada: ${parada.nombre}`;
      });
      li.addEventListener('keypress', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          li.click();
        }
      });
      lista.appendChild(li);
    });

    // Función para slugificar
    function slugify(texto) {
      return texto.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '');
    }

    // Calcular distancia en metros
    function getDistanceMeters(lat1, lng1, lat2, lng2) {
      const R = 6371000;
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Detección de parada por GPS
    function detectarParada(pos) {
      const { latitude, longitude } = pos.coords;

      for (const parada of paradas) {
        const dist = getDistanceMeters(latitude, longitude, parada.lat, parada.lng);
        if (dist < 15) {
          const slug = slugify(parada.nombre);
          document.getElementById("estado").textContent =
            `Estás en: ${parada.nombre} (${Math.round(dist)} m)`;

          // Enviar al padre (si se usa iframe)
          window.parent.postMessage({ tipo: "parada_detectada", id: slug }, "*");
          return;
        }
      }

      document.getElementById("estado").textContent =
        `No estás cerca de ninguna parada (${latitude.toFixed(5)}, ${longitude.toFixed(5)})`;
    }

    // Error geolocalización
    function error(err) {
      document.getElementById("estado").textContent = "Error obteniendo ubicación: " + err.message;
    }

    // Variable para almacenar watcher id
    let geoWatcherId = null;

    // Función para iniciar geolocalización
    function iniciarGeolocalizacion() {
      if (navigator.geolocation) {
        geoWatcherId = navigator.geolocation.watchPosition(detectarParada, error, {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 5000,
        });
      } else {
        document.getElementById("estado").textContent = "Geolocalización no soportada por este navegador.";
      }
    }

    // Función para detener geolocalización
    function detenerGeolocalizacion() {
      if (geoWatcherId !== null) {
        navigator.geolocation.clearWatch(geoWatcherId);
        geoWatcherId = null;
        document.getElementById("estado").textContent = "Geolocalización detenida.";
      }
    }

    // Al cargar, enviar las coordenadas al padre (para el mapa padre)
    window.addEventListener("load", () => {
      window.parent.postMessage({ tipo: "coordenadas", puntos: paradas }, "*");
      // Iniciar geolocalización por defecto (puedes modificar si quieres que sea solo cuando padre mande)
      iniciarGeolocalizacion();
    });

    // Escuchar mensajes del padre para activar/desactivar geolocalización
    window.addEventListener("message", (event) => {
      if (!event.data || !event.data.tipo) return;

      if (event.data.tipo === "activar_gps") {
        iniciarGeolocalizacion();
      } else if (event.data.tipo === "desactivar_gps") {
        detenerGeolocalizacion();
      }
    });

    // --- MAPA LEAFLET ---

    const btnMapa = document.getElementById('btnMapa');
    const mapDiv = document.getElementById('map');
    const cerrarMapaBtn = document.getElementById('cerrarMapa');
    let map;
    let markers = [];

    btnMapa.addEventListener('click', () => {
      if (!map) {
        // Crear mapa centrado en la primera parada
        map = L.map('map').setView([paradas[0].lat, paradas[0].lng], 15);

        // Capa de mapa OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Añadir marcadores
        paradas.forEach(parada => {
          const marker = L.marker([parada.lat, parada.lng]).addTo(map);
          marker.bindPopup(parada.nombre);
          markers.push(marker);
        });
      }

      mapDiv.style.display = 'block';
      map.invalidateSize(); // para que Leaflet ajuste tamaño tras mostrar
    });

    cerrarMapaBtn.addEventListener('click', () => {
      mapDiv.style.display = 'none';
    });
  </script>
</body>
</html>
