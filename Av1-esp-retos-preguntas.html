<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Reto Interactivo Aventura 1 Español (Hijo 4)</title>
<style>
    /* --- ESTILOS DEL IFRAME DE RETOS --- */
    /* Para que la ventana de retos ocupe todo el área del iframe menos 1px en cada borde,
       ajusta el padding y el tamaño del contenedor principal. Modifica el valor de --borde-reto
       para cambiar fácilmente el margen respecto al borde del iframe. */
    :root {
        --borde-reto: 1px; /* Margen respecto a cada borde del iframe */
    }
    body {
        font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif;
        margin: 0;
        background: #fff;
        color: #222;
        font-size: 16px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        min-height: 100vh;
        box-sizing: border-box;
        padding: var(--borde-reto);
        width: calc(100vw - 2 * var(--borde-reto));
        height: calc(100vh - 2 * var(--borde-reto));
    }
    
    /* Estado deshabilitado para toda la interfaz */
    body.disabled {
        pointer-events: none;
        opacity: 0.6;
        user-select: none;
    }
    
    /* Overlay de estado deshabilitado */
    .disabled-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(128, 128, 128, 0.3);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        color: #666;
        text-align: center;
    }
    
    body.disabled .disabled-overlay {
        display: flex;
    }
    
    #reto-contenido, #button-container, #respuestaCorrectaTexto, #fuegos {
        /* Asegura que los elementos internos no sobresalgan */
        box-sizing: border-box;
        width: 100%;
    }
    h3 {
        margin-top: 0;
        margin-bottom: 0.8em;
        font-size: 1.5em;
        text-align: center;
        width: 100%;
    }
    .opciones-container {
        width: 100%;
        max-width: 600px;
        text-align: left;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .respuesta {
        margin: 0.4em 0;
        font-size: 1.3em;
        display: flex;
        align-items: center;
    }
    .respuesta input[type="radio"],
    .respuesta input[type="checkbox"] {
        margin-right: 0.7em;
        transform: scale(1.3);
        cursor: pointer;
    }
    .respuesta input[type="text"] {
        flex-grow: 1;
        font-size: 1.3em;
        padding: 0.3em 0.5em;
        border-radius: 4px;
        border: 1px solid #999;
        width: calc(100% - 1.4em);
    }
    #button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1em;
        margin-top: 1.5em;
        justify-content: center;
        width: 100%;
        min-height: 40px;
    }
    button.btn {
        padding: 0.6em 1.2em;
        font-size: 1.1em;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background-color: #0077cc;
        color: white;
        user-select: none;
        transition: background-color 0.3s ease;
    }
    button.btn:hover {
        background-color: #005699;
    }
    button.btn:disabled {
        background-color: #999;
        cursor: not-allowed;
    }
    #btnMostrarRespuesta {
        background-color: #28a745;
        display: none;
    }
    #btnMostrarRespuesta:hover {
        background-color: #1e7e34;
    }
    #respuestaCorrectaTexto {
        margin-top: 1em;
        font-weight: bold;
        text-align: center;
        width: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 0.8em 1em;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        font-size: 1.2em;
        color: #222;
        z-index: 20;
        display: none;
        box-sizing: border-box;
    }
    #fuegos {
        pointer-events: none;
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        overflow: hidden;
        display: none;
    }
    @media (max-width: 600px) {
        h3 { font-size: 1.3em; }
        .respuesta { font-size: 1.1em; }
        button.btn { font-size: 1em; padding: 0.5em 1em; }
        #respuestaCorrectaTexto { font-size: 1.1em; }
    }
</style>
</head>
<body>
    <!-- Script para importar el módulo de men"continue su Aventura" el codigo debería informar al padre que ya ha acabado para que el padre continue su labor"sajería -->
    <script type="module">
        // Hacer mensajeria disponible globalmente
        import { inicializarMensajeria, TIPOS_MENSAJE, LOG_LEVELS } from './js/mensajeria.js';
        window.mensajeria = { inicializarMensajeria, TIPOS_MENSAJE, LOG_LEVELS };
    </script>
    
    <!-- Overlay para estado deshabilitado -->
    <div class="disabled-overlay">
        <div>
            <div>🔒 Retos Deshabilitados</div>
            <div style="font-size: 0.8em; margin-top: 10px;">Active el modo casa para acceder a los retos</div>
        </div>
    </div>
    
    <!-- El contenido de la ventana de retos ocupa todo el área del iframe menos 1px en cada borde. Cambia --borde-reto arriba para ajustar el margen. -->
    <div id="reto-contenido"></div>
    <div id="button-container">
        <button id="btnEnviar" class="btn">Enviar</button>
        <button id="btnMostrarRespuesta" class="btn">Mostrar Respuesta</button>
    </div>
    <div id="respuestaCorrectaTexto"></div>
    <div id="fuegos"></div>
    <!-- Botón flotante para continuar tras acertar el reto -->
    <button id="btnContinueReto" class="btn" style="display:none;position:fixed;bottom:30px;right:30px;z-index:3000;background:#ff9800;font-size:1.2em;padding:1em 2em;box-shadow:0 2px 8px rgba(0,0,0,0.2);">Continúe su reto</button>
<script>
// ================== VARIABLES DE CONTROL DE MODO ==================

let modoActual = 'aventura'; // 'aventura' o 'casa'
let controlesHabilitados = false;
let retosDisabled = true; // Empezar con retos deshabilitados (modo aventura)

// ================== FUNCIONES DE CONTROL DE MODO ==================

/**
 * Habilita los controles según el modo especificado
 * @param {string} modo - 'casa' o 'aventura'
 */
function enableControls(modo = 'casa') {
    modoActual = modo;
    controlesHabilitados = true;
    retosDisabled = false;
    
    // Actualizar la interfaz
    document.body.classList.remove('disabled');
    
    // Notificar al padre que los controles están habilitados
    if (window.mensajeria) {
        mensajeria.enviarMensaje(mensajeria.TIPOS_MENSAJE.SISTEMA.CONTROL, {
            tipo: 'controles_habilitados',
            modo: modo,
            origen: 'hijo4-retos'
        });
    }
    
    console.log(`✅ HIJO 4: Controles habilitados en modo ${modo}`);
}

/**
 * Deshabilita los controles con un motivo específico
 * @param {string} motivo - Razón de la deshabilitación
 */
function disableControls(motivo = 'desconocido') {
    controlesHabilitados = false;
    retosDisabled = true;
    
    // Actualizar la interfaz
    document.body.classList.add('disabled');
    
    // Notificar al padre que los controles están deshabilitados
    if (window.mensajeria) {
        mensajeria.enviarMensaje(mensajeria.TIPOS_MENSAJE.SISTEMA.CONTROL, {
            tipo: 'controles_deshabilitados',
            motivo: motivo,
            origen: 'hijo4-retos'
        });
    }
    
    // Si hay un reto en progreso, reiniciarlo
    if (currentRetoIndex !== -1) {
        resetCurrentReto();
    }
    
    console.log(`🚫 HIJO 4: Controles deshabilitados - ${motivo}`);
}

/**
 * Maneja el cambio de modo (casa/aventura)
 * @param {string} modo - 'casa' o 'aventura'
 * @param {boolean} habilitar - Si es true, habilita los controles
 */
function manejarCambioModo(modo, habilitar = false) {
    console.log(`🔄 HIJO 4: Cambiando a modo ${modo}, habilitar: ${habilitar}`);
    
    // Actualizar el modo actual
    modoActual = modo;
    
    // Habilitar o deshabilitar controles según el parámetro
    if (habilitar) {
        enableControls(modo);
    } else {
        disableControls(`cambio_a_modo_${modo}`);
    }
    
    // Notificar al padre del cambio de modo
    if (window.mensajeria) {
        mensajeria.enviarMensaje(mensajeria.TIPOS_MENSAJE.SISTEMA.CONFIGURACION, {
            tipo: 'cambio_modo',
            modo: modo,
            habilitado: habilitar,
            origen: 'hijo4-retos'
        });
    }
}

// Funciones de compatibilidad con el sistema anterior
function enableRetos() {
    manejarCambioModo('casa', true);
}

function disableRetos(motivo = 'modo_aventura') {
    manejarCambioModo('aventura', false);
}

function resetCurrentReto() {
    // Reiniciar el estado del reto actual
    btnEnviar.disabled = false;
    btnMostrarRespuesta.style.display = "none";
    btnContinueReto.style.display = "none";
    divRespuestaCorrecta.style.display = "none";
    divRespuestaCorrecta.textContent = "";
    fuegosDiv.innerHTML = "";
    fuegosDiv.style.display = "none";
}

// ================== ARRAY DE RETOS DE LA AVENTURA 1 ==================

// Cada objeto representa un reto. El campo 'tipo' puede ser 'opcion', 'opcion-multiple', 'texto' o 'puzzle'.
// El campo 'correctas' contiene la(s) respuesta(s) correcta(s).
const retosAventura1Es = [
  {
    reto: 1,
    id: "R-1",
    tipo: "opcion",
    pregunta: "1. ¿Cuántas Aventuras pueden hacerse con Valencia be Guides?",
    opciones: ["4", "5", "6", "7"],
    correctas: ["7"],
    multiple: false
  },
  {
    reto: 2,
    id: "R-2",
    tipo: "opcion",
    pregunta: "2. ¿Sabría decirme cómo se llaman estas Torres?",
    opciones: ["Torres de Quart", "Torres de Serranos", "Torre del Miguelete", "Torre de Santa catalina"],
    correctas: ["Torres de Serranos"],
    multiple: false
  },
  {
    reto: 3,
    id: "R-3",
    tipo: "opcion",
    pregunta: "3. ¿En la cumbre de las torres ondea la bandera de Valencia: sus colores se componen de rojo, amarillo y… ?",
    opciones: ["Violeta", "Verde", "Azul"],
    correctas: ["Azul"],
    multiple: false
  },
  {
    reto: 4,
    id: "R-4",
    tipo: "texto",
    pregunta: "4. ¿Sabría decirme el nombre de la calle?",
    correctas: ["Calle Muro de Santa Ana"]
  },
  {
    reto: 5,
    id: "R-5",
    tipo: "opcion",
    pregunta: "5. ¿Qué porta San Lorenzo en la mano?",
    opciones: ["Una Paloma", "Una cuchara", "Una parrilla"],
    correctas: ["Una parrilla"],
    multiple: false
  },
  {
    reto: 6,
    id: "R-6",
    tipo: "opcion",
    pregunta: "6. ¿Con qué mano sujeta Neptuno la cornucopia?",
    opciones: ["Izquierda", "Derecha"],
    correctas: ["Derecha"],
    multiple: false
  },
  {
    reto: 7,
    id: "R-7",
    tipo: "texto",
    pregunta: "7. ¿Cuántas figuras rodean la fuente?",
    correctas: ["8"]
  },
  {
    reto: 8,
    id: "PZ-8",
    tipo: "puzzle",
    pregunta: "8. Plaza de la Virgen",
    src: "P8_puzzle_plaza_virgen.html"
  },
  {
    reto: 9,
    id: "R-9",
    tipo: "opcion",
    pregunta: "9. ¿Qué figura esculpida puede verse en el marco del cuadro?",
    opciones: ["Un Dragón", "Un Murciélago", "Una Corona"],
    correctas: ["Una Corona"],
    multiple: false
  },
  {
    reto: 10,
    id: "R-10",
    tipo: "opcion-multiple",
    pregunta: "10. ¿Qué puede verse dentro?",
    opciones: ["Un Altar", "Una bandera", "Una espada"],
    correctas: ["Un Altar", "Una bandera"],
    multiple: true
  },
  {
    reto: 11,
    id: "R-11",
    tipo: "texto",
    pregunta: "11. Sobre ésta hay una placa conmemorativa. ¿En qué año fue expuesta dicha placa?",
    correctas: ["1952"]
  },
  {
    reto: 12,
    id: "R-12",
    tipo: "texto",
    pregunta: "12. ¿En qué año se edificó esta finca? ¡Pista! Mire en la parte superior de la fachada.",
    correctas: ["1906"]
  },
  {
    reto: 13,
    id: "R-13",
    tipo: "opcion",
    pregunta: "13. ¿Qué puede verse dentro?",
    opciones: ["Una Plaza de Toros", "Unos baños romanos", "Una estación de metro"],
    correctas: ["Unos baños romanos"],
    multiple: false
  },
  {
    reto: 14,
    id: "R-14",
    tipo: "opcion",
    pregunta: "14. ¿Sabría determinar qué geometría tiene?",
    opciones: ["hexagonal", "Octogonal", "Cuadrangular"],
    correctas: ["hexagonal"],
    multiple: false
  },
  {
    reto: 15,
    id: "R-15",
    tipo: "texto",
    pregunta: "15. ¿Cuántos Arcos componen la puerta?",
    correctas: ["6"]
  },
  {
    reto: 16,
    id: "R-16",
    tipo: "opcion",
    pregunta: "16. ¿Recuerda qué animal corona el escudo municipal?",
    opciones: ["Un Dragón", "Un Murciélago", "Un Caballo"],
    correctas: ["Un Murciélago"],
    multiple: false
  },
  {
    reto: 17,
    id: "R-17",
    tipo: "opcion",
    pregunta: "17. ¡Preste atención a la fachada de la primera torre! ¿Qué Fruta Cítrica natural de Valencia decora la fachada?",
    opciones: ["Limones", "Pomelos", "Naranjas"],
    correctas: ["Naranjas"],
    multiple: false
  },
  {
    reto: 18,
    id: "PZ-18",
    tipo: "puzzle",
    pregunta: "18. Plaza de Toros y Estación del Norte",
    src: "P18_puzzle_plaza_de_Toros_y_estacion_norte.html"
  },
  {
    reto: 19,
    id: "R-19",
    tipo: "texto",
    pregunta: "19. ¿Sabría decirme qué comercio alberga dicho edificio?",
    correctas: ["?"]
  },
  {
    reto: 20,
    id: "R-20",
    tipo: "opcion-multiple",
    pregunta: "20. Sobre la entrada principal, en un arco de medio punto, figuras alegóricas representan a los cinco continentes. ¿Qué porta la figura central en sus manos?",
    opciones: ["Una Corona", "Una Espada", "Una Antorcha"],
    correctas: ["Una Antorcha", "Una Espada"],
    multiple: true
  },
  {
    reto: 21,
    id: "R-21",
    tipo: "opcion",
    pregunta: "21. ¿Qué porta la figura en la mano?",
    opciones: ["Una balanza", "Un libro", "Una pluma"],
    correctas: ["Una balanza"],
    multiple: false
  },
  {
    reto: 22,
    id: "R-22",
    tipo: "texto",
    pregunta: "22. ¿Cuantas plantas tiene el edificio?",
    correctas: ["10"]
  },
  {
    reto: 23,
    id: "R-23",
    tipo: "opcion",
    pregunta: "23. Busque la vidriera con los colores de la Señera valenciana en la fachada del edificio. ¿Sabría determinar qué forma tiene?",
    opciones: ["Cuadrangular", "Redonda", "Triangular"],
    correctas: ["Redonda"],
    multiple: false
  },
  {
    reto: 24,
    id: "R-24",
    tipo: "opcion-multiple",
    pregunta: "24. ¿Qué sostiene la virgen en sus manos?",
    opciones: ["Un Rosario", "Un niño", "Una corona"],
    correctas: ["Un Rosario", "Un niño"],
    multiple: true
  },
  {
    reto: 25,
    id: "R-25",
    tipo: "opcion",
    pregunta: "25. ¿Qué le entrega el ángel al niño?",
    opciones: ["Una paloma", "Un orbe", "Alimentos"],
    correctas: ["Un orbe"],
    multiple: false
  },
  {
    reto: 26,
    id: "PZ-26",
    tipo: "puzzle",
    pregunta: "26. Lonja de la Seda",
    src: "P26_puzzle_lonja.html"
  },
  {
    reto: 27,
    id: "R-27",
    tipo: "opcion-multiple",
    pregunta: "27. El barquero que rema a contracorriente.",
    opciones: ["Un hombre con rostro triste manejando un pequeño bote de madera escapa a contracorriente de un monstruo."],
    correctas: ["Un hombre con rostro triste manejando un pequeño bote de madera escapa a contracorriente de un monstruo."],
    multiple: true
  },
  {
    reto: 28,
    id: "R-28",
    tipo: "opcion-multiple",
    pregunta: "28. Un árbol muerto: símbolo del Pecado, se ve entre las dos hojas de la puerta y cumple la función de parteluz.",
    opciones: ["Observe en la copa del árbol como 4 hombres desnudos se azotan entre si."],
    correctas: ["Observe en la copa del árbol como 4 hombres desnudos se azotan entre si."],
    multiple: true
  },
  {
    reto: 29,
    id: "R-29",
    tipo: "opcion-multiple",
    pregunta: "29. A la derecha, un ángel que muestra su pene y...",
    opciones: ["se dispone a introducirlo en un jarrón que sostiene con la otra mano. Algo extraño e inusual ¿no le parece?"],
    correctas: ["se dispone a introducirlo en un jarrón que sostiene con la otra mano. Algo extraño e inusual ¿no le parece?"],
    multiple: true
  },
  {
    reto: 30,
    id: "R-30",
    tipo: "opcion-multiple",
    pregunta: "30. En el centro El barbudo y el león:",
    opciones: ["Original y contradictoria escena en la cual el manso es precisamente el león y no el anciano barbudo."],
    correctas: ["Original y contradictoria escena en la cual el manso es precisamente el león y no el anciano barbudo."],
    multiple: true
  },
  {
    reto: 31,
    id: "R-31",
    tipo: "opcion-multiple",
    pregunta: "31. ¡Aquí va un reto extra! ¡Busque al fornicador de la lonja!",
    opciones: ["En una de sus ventanas, hallará a un hombre tallado, no se le advierte su cabeza, pero sí sus genitales, Y muy claramente."],
    correctas: ["En una de sus ventanas, hallará a un hombre tallado, no se le advierte su cabeza, pero sí sus genitales, Y muy claramente."],
    multiple: true
  },
  {
    reto: 32,
    id: "R-32",
    tipo: "opcion",
    pregunta: "32. ¿Qué sostiene el niño en sus manos?",
    opciones: ["Una paloma", "Una Concha", "Alimentos"],
    correctas: ["Una Concha"],
    multiple: false
  }
];

// ================== REFERENCIAS A ELEMENTOS DEL DOM ==================

const retoContenidoDiv = document.getElementById("reto-contenido");
const btnEnviar = document.getElementById("btnEnviar");
const btnMostrarRespuesta = document.getElementById("btnMostrarRespuesta");
const divRespuestaCorrecta = document.getElementById("respuestaCorrectaTexto");
const fuegosDiv = document.getElementById("fuegos");
const btnContinueReto = document.getElementById("btnContinueReto");
let currentRetoIndex = -1;
const DURACION_TOTAL_MS = 3000;

// ================== FUNCIONES DE MENSAJERÍA PADRE-HIJO ==================

/**
 * Envía un mensaje al padre usando mensajeria.js
 * @param {string} tipo - Tipo de mensaje (ej: SISTEMA.ESTADO, NAVEGACION.ACCION, etc.)
 * @param {Object} datos - Datos del mensaje
 */
function enviarMensajeAlPadre(tipo, datos = {}) {
    if (!window.mensajeria || !window.mensajeria.enviarMensaje) {
        console.error('❌ No se puede enviar mensaje: mensajeria.js no está disponible');
        return;
    }
    
    // Asegurarse de que los datos tengan el origen
    const mensaje = {
        ...datos,
        origen: 'hijo4-retos',
        timestamp: Date.now()
    };
    
    window.mensajeria.enviarMensaje(tipo, mensaje);
}

// ================== EFECTOS VISUALES ==================

// --- EFECTO: Fuegos artificiales al acertar ---
function fuegosArtificiales() {
    const NUM_CHISPAS_POR_FUEGO = 30;
    const NUM_EXPLOSIONES = 15;
    fuegosDiv.innerHTML = "";
    fuegosDiv.style.display = "block";
    for (let e = 0; e < NUM_EXPLOSIONES; e++) {
        const delayExplosion = (DURACION_TOTAL_MS / NUM_EXPLOSIONES) * e;
        setTimeout(() => {
            const startX = Math.random() * fuegosDiv.offsetWidth;
            const startY = Math.random() * fuegosDiv.offsetHeight;
            for (let i = 0; i < NUM_CHISPAS_POR_FUEGO; i++) {
                let chispa = document.createElement("div");
                chispa.style.position = "absolute";
                chispa.style.borderRadius = "50%";
                chispa.style.width = "12px";
                chispa.style.height = "12px";
                chispa.style.background = `hsl(${Math.random() * 360}, 100%, 70%)`;
                chispa.style.opacity = "1";
                chispa.style.left = `${startX}px`;
                chispa.style.top = `${startY}px`;
                chispa.style.zIndex = "10";
                fuegosDiv.appendChild(chispa);
                const angle = Math.random() * Math.PI * 2;
                const distance = Math.random() * 80 + 40;
                const endX = startX + distance * Math.cos(angle);
                const endY = startY + distance * Math.sin(angle);
                const chispaDuration = DURACION_TOTAL_MS / NUM_EXPLOSIONES * 1.5;
                chispa.style.transition = `all ${chispaDuration}ms ease-out`;
                setTimeout(() => {
                    chispa.style.left = `${endX}px`;
                    chispa.style.top = `${endY}px`;
                    chispa.style.opacity = "0";
                    chispa.style.transform = "scale(0.5)";
                }, 10);
                setTimeout(() => {
                    if (chispa.parentNode) {
                        chispa.parentNode.removeChild(chispa);
                    }
                }, delayExplosion + chispaDuration + 50);
            }
        }, delayExplosion);
    }
    setTimeout(() => {
        fuegosDiv.style.display = "none";
    }, DURACION_TOTAL_MS + 100);
}

// --- EFECTO: Vibración al fallar ---
function vibrar() {
    if (navigator.vibrate) navigator.vibrate(300);
}

// ================== GESTIÓN DE RETOS ==================

// --- RENDERIZAR EL RETO SEGÚN EL ÍNDICE QUE ENVÍA EL PADRE ---
function renderizarReto(retoIndex) {
    // No renderizar si los retos están deshabilitados
    if (retosDisabled) {
        console.log('🚫 HIJO 4: No se puede renderizar reto - retos deshabilitados');
        enviarAlPadre({ type: "reto-hijo-error", message: "Retos deshabilitados", index: retoIndex });
        return;
    }
    
    currentRetoIndex = retoIndex;
    const reto = retosAventura1Es[currentRetoIndex];
    if (!reto) {
        console.error("Reto no encontrado para el índice:", retoIndex);
        enviarAlPadre({ type: "reto-hijo-error", message: "Reto no encontrado", index: retoIndex });
        return;
    }
    retoContenidoDiv.innerHTML = '';
    btnEnviar.style.display = "inline-block";
    btnEnviar.disabled = false;
    btnMostrarRespuesta.style.display = "none";
    btnContinueReto.style.display = "none";
    divRespuestaCorrecta.style.display = "none";
    divRespuestaCorrecta.textContent = "";
    fuegosDiv.innerHTML = "";
    fuegosDiv.style.display = "none";
    let preguntaElem = document.createElement("h3");
    preguntaElem.textContent = reto.pregunta;
    retoContenidoDiv.appendChild(preguntaElem);
    if (reto.tipo === "opcion" || reto.tipo === "opcion-multiple") {
        const opcionesContainer = document.createElement("div");
        opcionesContainer.className = "opciones-container";
        const inputType = reto.multiple ? "checkbox" : "radio";
        reto.opciones.forEach((opcion, i) => {
            const divOpcion = document.createElement("div");
            divOpcion.className = "respuesta";
            const input = document.createElement("input");
            input.type = inputType;
            input.name = "op";
            input.value = opcion;
            input.id = "opcion" + i;
            divOpcion.appendChild(input);
            const label = document.createElement("label");
            label.htmlFor = input.id;
            label.textContent = opcion;
            divOpcion.appendChild(label);
            opcionesContainer.appendChild(divOpcion);
        });
        retoContenidoDiv.appendChild(opcionesContainer);
    } else if (reto.tipo === "texto") {
        const inputTexto = document.createElement("input");
        inputTexto.type = "text";
        inputTexto.id = "respuestaTexto";
        inputTexto.autocomplete = "off";
        inputTexto.spellcheck = false;
        inputTexto.setAttribute("inputmode", "text");
        inputTexto.placeholder = "Escriba su respuesta aquí...";
        retoContenidoDiv.appendChild(inputTexto);
        setTimeout(() => inputTexto.focus(), 200);
    }
    // No notificamos al padre aún, esperamos a que el usuario haga clic en Continuar
    console.log(`🧩 HIJO 4: Reto ${retoIndex + 1} renderizado`);
}

// --- VERIFICAR LA RESPUESTA DEL USUARIO ---
function verificar() {
    const retoActual = retosAventura1Es[currentRetoIndex];
    if (!retoActual) return;

    const opciones = document.querySelectorAll('input[type="radio"]:checked, input[type="checkbox"]:checked');
    const inputTexto = document.getElementById("respuestaTexto");
    let respuestaUsuario = [];

    if (opciones.length > 0) {
        opciones.forEach((opcion) => {
            respuestaUsuario.push(opcion.value);
        });
    } else if (inputTexto) {
        respuestaUsuario.push(inputTexto.value.trim().toLowerCase());
    } else {
        mostrarMensaje("Por favor, selecciona una opción o escribe tu respuesta.", "error");
        return;
    }

    // Verificar si la respuesta es correcta (comparación insensible a mayúsculas/minúsculas)
    const esCorrecta = retoActual.correctas.some((correcta) =>
        respuestaUsuario.some((respuesta) => respuesta.toLowerCase() === correcta.toLowerCase())
    );

    // Mostrar retroalimentación
    if (esCorrecta) {
        mostrarMensaje("¡Respuesta correcta!", "exito");
        fuegosArtificiales();
        
        // Habilitar el botón de continuar
        const btnContinuar = document.getElementById("btnContinueReto");
        if (btnContinuar) {
            btnContinuar.disabled = false;
            
            // Asegurarse de que el botón tenga un manejador de eventos
            btnContinuar.onclick = function() {
                console.log(`🏁 HIJO 4: Continuar después del reto ${window.retoActual?.id}`);
                
                // Notificar al padre que el usuario quiere continuar
                if (window.retoActual) {
                    enviarMensajeAlPadre('RETO.FINALIZADO', {
                        retoId: window.retoActual.id,
                        exito: true,
                        continuar: true
                    });
                }
                
                // Limpiar la referencia al reto actual
                delete window.retoActual;
                
                // Limpiar la interfaz
                if (retoContenidoDiv) {
                    retoContenidoDiv.innerHTML = '';
                }
                
                // Deshabilitar el botón de nuevo
                btnContinuar.disabled = true;
            };
            
            btnContinuar.focus();
        }
        
        // Notificar al padre que el reto se completó exitosamente
        if (window.retoActual) {
            enviarMensajeAlPadre('RETO.COMPLETADO', {
                retoId: window.retoActual.id,
                exito: true,
                esPuzzle: false
            });
        }
        
        console.log(`✅ HIJO 4: Reto ${retoActual.reto} completado correctamente`);
    } else {
        vibrar();
        btnEnviar.disabled = false;
        btnMostrarRespuesta.style.display = "inline-block";
        enviarAlPadre({ type: "reto-interactivo-fallado", index: currentRetoIndex });
        console.log(`❌ HIJO 4: Reto ${currentRetoIndex + 1} fallado`);
    }
}

// ================== EVENT LISTENERS ==================

// --- MOSTRAR RESPUESTA CORRECTA AL USUARIO ---
btnMostrarRespuesta.addEventListener("click", () => {
    if (currentRetoIndex === -1 || retosDisabled) return;
    
    const reto = retosAventura1Es[currentRetoIndex];
    if (reto.tipo === "opcion" || reto.tipo === "opcion-multiple") {
        divRespuestaCorrecta.textContent = "Respuesta correcta: " + reto.correctas.join(", ");
    } else if (reto.tipo === "texto") {
        divRespuestaCorrecta.textContent = "Puede continuar con la aventura.";
    }
    divRespuestaCorrecta.style.display = "block";
    btnEnviar.disabled = true;
    
    // Mostrar el botón de continuar si no está visible
    if (btnContinueReto.style.display === "none") {
        btnContinueReto.style.display = "inline-block";
    }
});

// --- BOTÓN CONTINÚE SU RETO ---
btnContinueReto.addEventListener("click", () => {
    if (retosDisabled) return;
    
    btnContinueReto.style.display = "none";
    
    // Notificar al padre que el reto se ha completado
    enviarAlPadre({ 
        type: "retoCompletado",
        retoId: retosAventura1Es[currentRetoIndex].id || `R-${currentRetoIndex + 1}`,
        index: currentRetoIndex
    });
    
    // Opcional: Ocultar el iframe (el padre también puede manejarlo)
    window.setTimeout(() => {
        if (window.frameElement) window.frameElement.style.display = 'none';
    }, 100);
});

// --- EVENTOS DE BOTONES ---
btnEnviar.addEventListener("click", verificar);

// ================== MANEJADORES DE MENSAJES ==================

/**
 * Configura los manejadores de mensajes usando mensajeria.js
 */
function configurarManejadoresMensajes() {
    if (!window.mensajeria || !window.mensajeria.registrarManejador) {
        console.error('❌ No se pueden configurar manejadores: mensajeria.js no está disponible');
        return;
    }
    
    // Manejar cambio de modo
    window.mensajeria.registrarManejador(
        window.mensajeria.TIPOS_MENSAJE.SISTEMA.CONFIGURACION, 
        (mensaje) => {
            if (mensaje.datos?.tipo === 'cambio_modo') {
                const { modo, habilitar } = mensaje.datos;
                console.log(`🔄 HIJO 4: Recibido cambio de modo: ${modo}, habilitar: ${habilitar}`);
                manejarCambioModo(modo, habilitar);
            }
        }
    );
    
    // Manejar controles
    window.mensajeria.registrarManejador(
        window.mensajeria.TIPOS_MENSAJE.SISTEMA.CONTROL,
        (mensaje) => {
            if (mensaje.datos?.tipo === 'habilitar_controles') {
                console.log('🔓 HIJO 4: Habilitando controles');
                enableControls(mensaje.datos.modo || 'casa');
            } else if (mensaje.datos?.tipo === 'deshabilitar_controles') {
                console.log('🔒 HIJO 4: Deshabilitando controles');
                disableControls(mensaje.datos.motivo || 'desconocido');
            }
        }
    );
    
    // Manejar solicitud de mostrar reto
    window.mensajeria.registrarManejador(
        'RETO.MOSTRAR',
        (mensaje) => {
            if (typeof mensaje.datos?.index === 'number') {
                console.log(`🎯 HIJO 4: Mostrando reto ${mensaje.datos.index}`);
                // Almacenar el ID del reto actual
                window.retoActual = {
                    id: retosAventura1Es[mensaje.datos.index].id,
                    index: mensaje.datos.index
                };
                renderizarReto(mensaje.datos.index);
            }
        }
    );
    
    // Manejar solicitud de mostrar puzzle
    window.mensajeria.registrarManejador(
        'PUZZLE.MOSTRAR',
        (mensaje) => {
            if (mensaje.datos?.puzzleId) {
                console.log(`🧩 HIJO 4: Mostrando puzzle ${mensaje.datos.puzzleId} del reto ${mensaje.datos.retoId}`);
                // Almacenar el ID del puzzle actual
                window.puzzleActual = {
                    id: mensaje.datos.puzzleId,
                    retoId: mensaje.datos.retoId
                };
                
                // Notificar que el puzzle se mostró
                enviarMensajeAlPadre('PUZZLE.MOSTRADO', {
                    puzzleId: mensaje.datos.puzzleId,
                    retoId: mensaje.datos.retoId
                });
            }
        }
    );
    
    // Manejar notificación de puzzle completado
    window.mensajeria.registrarManejador(
        'PUZZLE.COMPLETADO',
        (mensaje) => {
            console.log(`✅ HIJO 4: Puzzle ${mensaje.datos?.puzzleId} completado`);
            // Notificar al padre que el puzzle se completó
            enviarMensajeAlPadre('PUZZLE.FINALIZADO', {
                puzzleId: mensaje.datos?.puzzleId,
                exito: true,
                retoId: window.retoActual?.id
            });
            
            // Limpiar referencia al puzzle actual
            delete window.puzzleActual;
        }
    );
}

// ================== INICIALIZACIÓN ==================

// --- INICIALIZAR MENSAJERÍA Y NOTIFICAR AL PADRE ---
window.addEventListener("DOMContentLoaded", async () => {
    try {
        // Inicializar variables para rastrear el reto/puzzle actual
        window.retoActual = null;
        window.puzzleActual = null;
        
        // Inicializar mensajería
        if (!window.mensajeria || !window.mensajeria.inicializarMensajeria) {
            throw new Error('El módulo de mensajería no está disponible');
        }
        
        // Configurar mensajería
        await window.mensajeria.inicializarMensajeria({
            iframeId: 'hijo4',
            logLevel: window.mensajeria.LOG_LEVELS.DEBUG,
            debug: true
        });
        
        // Configurar manejadores de mensajes
        configurarManejadoresMensajes();
        
        console.log('🔌 HIJO 4: Mensajería inicializada correctamente');
        
        // Empezar con retos deshabilitados (modo aventura)
        manejarCambioModo('aventura', false);
        
        // Notificar al padre que el hijo está listo
        enviarMensajeAlPadre(window.mensajeria.TIPOS_MENSAJE.SISTEMA.ESTADO, {
            tipo: 'hijo_listo',
            modo: modoActual,
            controlesHabilitados: controlesHabilitados
        });
        
        console.log(`🧩 HIJO 4: Retos inicializados - Modo: ${modoActual}, Controles: ${controlesHabilitados ? 'Habilitados' : 'Deshabilitados'}`);
    } catch (error) {
        console.error('❌ HIJO 4: Error al inicializar:', error);
        // Asegurarse de que los retos estén deshabilitados en caso de error
        disableControls('error_inicializacion');
        
        // Notificar el error al padre si es posible
        if (window.mensajeria?.enviarMensaje) {
            window.mensajeria.enviarMensaje(
                window.mensajeria.TIPOS_MENSAJE.SISTEMA.ERROR,
                {
                    tipo: 'error_inicializacion',
                    mensaje: error.message,
                    stack: error.stack
                }
            );
        }
    }
});
</script>
</body>
</html>
