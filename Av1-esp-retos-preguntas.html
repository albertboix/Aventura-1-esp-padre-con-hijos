<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retos y Preguntas - Aventura 1</title>
    <script type="module">
        // ================== IMPORTACIÓN Y CONFIGURACIÓN ==================
        let Mensajeria, TIPOS_MENSAJE;
        
        try {
            const module = await import('./js/mensajeria.js');
            Mensajeria = module.default || module.Mensajeria;
            TIPOS_MENSAJE = module.TIPOS_MENSAJE;
        } catch (error) {
            console.error('Error al cargar mensajería:', error);
            // Fallback básico
            Mensajeria = {
                enviarMensaje: () => Promise.resolve(),
                registrarControlador: () => {},
                inicializarMensajeria: () => Promise.resolve()
            };
            TIPOS_MENSAJE = {
                SISTEMA: { LISTO: 'sistema_listo', CAMBIO_MODO: 'cambio_modo' },
                RETOS: { ABRIR: 'reto_abrir', COMPLETADO: 'reto_completado' }
            };
        }
        
        // Configuración del componente
        const CONFIG = {
            iframeId: 'hijo4-retos',
            debug: true,
            logLevel: 1,
            REINTENTOS: {
                MAXIMOS: 3,
                TIEMPO_ESPERA: 1000,
                FACTOR: 2
            }
        };

        // Estado global de la aplicación
        let estadoApp = {
            modo: 'aventura',
            controlesHabilitados: false,
            retoActual: null,
            retosCompletados: [],
            preguntaActual: null,
            respuestasUsuario: {},
            puntoActual: null,
            ultimoError: null,
            
            // ================== ARRAY DE RETOS DE LA AVENTURA 1 ==================
            // Cada objeto representa un reto. El campo 'tipo' puede ser 'opcion', 'opcion-multiple', 'texto' o 'puzzle'.
            // El campo 'correctas' contiene la(s) respuesta(s) correcta(s).
            retosAventura1Es: [
              {
                reto: 1,
                id: "R-1",
                tipo: "opcion",
                pregunta: "1. ¿Cuántas Aventuras pueden hacerse con Valencia be Guides?",
                opciones: ["4", "5", "6", "7"],
                correctas: ["7"],
                multiple: false
              },
              {
                reto: 2,
                id: "R-2",
                tipo: "opcion",
                pregunta: "2. ¿Sabría decirme cómo se llaman estas Torres?",
                opciones: ["Torres de Quart", "Torres de Serranos", "Torre del Miguelete", "Torre de Santa catalina"],
                correctas: ["Torres de Serranos"],
                multiple: false
              },
              {
                reto: 3,
                id: "R-3",
                tipo: "opcion",
                pregunta: "3. ¿En la cumbre de las torres ondea la bandera de Valencia: sus colores se componen de rojo, amarillo y… ?",
                opciones: ["Violeta", "Verde", "Azul"],
                correctas: ["Azul"],
                multiple: false
              },
              {
                reto: 4,
                id: "R-4",
                tipo: "texto",
                pregunta: "4. ¿Sabría decirme el nombre de la calle?",
                correctas: ["Calle Muro de Santa Ana"]
              },
              {
                reto: 5,
                id: "R-5",
                tipo: "opcion",
                pregunta: "5. ¿Qué porta San Lorenzo en la mano?",
                opciones: ["Una Paloma", "Una cuchara", "Una parrilla"],
                correctas: ["Una parrilla"],
                multiple: false
              },
              {
                reto: 6,
                id: "R-6",
                tipo: "opcion",
                pregunta: "6. ¿Con qué mano sujeta Neptuno la cornucopia?",
                opciones: ["Izquierda", "Derecha"],
                correctas: ["Derecha"],
                multiple: false
              },
              {
                reto: 7,
                id: "R-7",
                tipo: "texto",
                pregunta: "7. ¿Cuántas figuras rodean la fuente?",
                correctas: ["8"]
              },
              {
                reto: 8,
                id: "PZ-8",
                tipo: "puzzle",
                pregunta: "8. Plaza de la Virgen",
                src: "P8_puzzle_plaza_virgen.html"
              },
              {
                reto: 9,
                id: "R-9",
                tipo: "opcion",
                pregunta: "9. ¿Qué figura esculpida puede verse en el marco del cuadro?",
                opciones: ["Un Dragón", "Un Murciélago", "Una Corona"],
                correctas: ["Una Corona"],
                multiple: false
              },
              {
                reto: 10,
                id: "R-10",
                tipo: "opcion-multiple",
                pregunta: "10. ¿Qué puede verse dentro?",
                opciones: ["Un Altar", "Una bandera", "Una espada"],
                correctas: ["Un Altar", "Una bandera"],
                multiple: true
              },
              {
                reto: 11,
                id: "R-11",
                tipo: "texto",
                pregunta: "11. Sobre ésta hay una placa conmemorativa. ¿En qué año fue expuesta dicha placa?",
                correctas: ["1952"]
              },
              {
                reto: 12,
                id: "R-12",
                tipo: "texto",
                pregunta: "12. ¿En qué año se edificó esta finca? ¡Pista! Mire en la parte superior de la fachada.",
                correctas: ["1906"]
              },
              {
                reto: 13,
                id: "R-13",
                tipo: "opcion",
                pregunta: "13. ¿Qué puede verse dentro?",
                opciones: ["Una Plaza de Toros", "Unos baños romanos", "Una estación de metro"],
                correctas: ["Unos baños romanos"],
                multiple: false
              },
              {
                reto: 14,
                id: "R-14",
                tipo: "opcion",
                pregunta: "14. ¿Sabría determinar qué geometría tiene?",
                opciones: ["hexagonal", "Octogonal", "Cuadrangular"],
                correctas: ["hexagonal"],
                multiple: false
              },
              {
                reto: 15,
                id: "R-15",
                tipo: "texto",
                pregunta: "15. ¿Cuántos Arcos componen la puerta?",
                correctas: ["6"]
              },
              {
                reto: 16,
                id: "R-16",
                tipo: "opcion",
                pregunta: "16. ¿Recuerda qué animal corona el escudo municipal?",
                opciones: ["Un Dragón", "Un Murciélago", "Un Caballo"],
                correctas: ["Un Murciélago"],
                multiple: false
              },
              {
                reto: 17,
                id: "R-17",
                tipo: "opcion",
                pregunta: "17. ¡Preste atención a la fachada de la primera torre! ¿Qué Fruta Cítrica natural de Valencia decora la fachada?",
                opciones: ["Limones", "Pomelos", "Naranjas"],
                correctas: ["Naranjas"],
                multiple: false
              },
              {
                reto: 18,
                id: "PZ-18",
                tipo: "puzzle",
                pregunta: "18. Plaza de Toros y Estación del Norte",
                src: "P18_puzzle_plaza_de_Toros_y_estacion_norte.html"
              },
              {
                reto: 19,
                id: "R-19",
                tipo: "texto",
                pregunta: "19. ¿Sabría decirme qué comercio alberga dicho edificio?",
                correctas: ["?"]
              },
              {
                reto: 20,
                id: "R-20",
                tipo: "opcion-multiple",
                pregunta: "20. Sobre la entrada principal, en un arco de medio punto, figuras alegóricas representan a los cinco continentes. ¿Qué porta la figura central en sus manos?",
                opciones: ["Una Corona", "Una Espada", "Una Antorcha"],
                correctas: ["Una Antorcha", "Una Espada"],
                multiple: true
              },
              {
                reto: 21,
                id: "R-21",
                tipo: "opcion",
                pregunta: "21. ¿Qué porta la figura en la mano?",
                opciones: ["Una balanza", "Un libro", "Una pluma"],
                correctas: ["Una balanza"],
                multiple: false
              },
              {
                reto: 22,
                id: "R-22",
                tipo: "texto",
                pregunta: "22. ¿Cuantas plantas tiene el edificio?",
                correctas: ["10"]
              },
              {
                reto: 23,
                id: "R-23",
                tipo: "opcion",
                pregunta: "23. Busque la vidriera con los colores de la Señera valenciana en la fachada del edificio. ¿Sabría determinar qué forma tiene?",
                opciones: ["Cuadrangular", "Redonda", "Triangular"],
                correctas: ["Redonda"],
                multiple: false
              },
              {
                reto: 24,
                id: "R-24",
                tipo: "opcion-multiple",
                pregunta: "24. ¿Qué sostiene la virgen en sus manos?",
                opciones: ["Un Rosario", "Un niño", "Una corona"],
                correctas: ["Un Rosario", "Un niño"],
                multiple: true
              },
              {
                reto: 25,
                id: "R-25",
                tipo: "opcion",
                pregunta: "25. ¿Qué le entrega el ángel al niño?",
                opciones: ["Una paloma", "Un orbe", "Alimentos"],
                correctas: ["Un orbe"],
                multiple: false
              },
              {
                reto: 26,
                id: "PZ-26",
                tipo: "puzzle",
                pregunta: "26. Lonja de la Seda",
                src: "P26_puzzle_lonja.html"
              },
              {
                reto: 27,
                id: "R-27",
                tipo: "opcion-multiple",
                pregunta: "27. El barquero que rema a contracorriente.",
                opciones: ["Un hombre con rostro triste manejando un pequeño bote de madera escapa a contracorriente de un monstruo."],
                correctas: ["Un hombre con rostro triste manejando un pequeño bote de madera escapa a contracorriente de un monstruo."],
                multiple: true
              },
              {
                reto: 28,
                id: "R-28",
                tipo: "opcion-multiple",
                pregunta: "28. Un árbol muerto: símbolo del Pecado, se ve entre las dos hojas de la puerta y cumple la función de parteluz.",
                opciones: ["Observe en la copa del árbol como 4 hombres desnudos se azotan entre si."],
                correctas: ["Observe en la copa del árbol como 4 hombres desnudos se azotan entre si."],
                multiple: true
              },
              {
                reto: 29,
                id: "R-29",
                tipo: "opcion-multiple",
                pregunta: "29. A la derecha, un ángel que muestra su pene y...",
                opciones: ["se dispone a introducirlo en un jarrón que sostiene con la otra mano. Algo extraño e inusual ¿no le parece?"],
                correctas: ["se dispone a introducirlo en un jarrón que sostiene con la otra mano. Algo extraño e inusual ¿no le parece?"],
                multiple: true
              },
              {
                reto: 30,
                id: "R-30",
                tipo: "opcion-multiple",
                pregunta: "30. En el centro El barbudo y el león:",
                opciones: ["Original y contradictoria escena en la cual el manso es precisamente el león y no el anciano barbudo."],
                correctas: ["Original y contradictoria escena en la cual el manso es precisamente el león y no el anciano barbudo."],
                multiple: true
              },
              {
                reto: 31,
                id: "R-31",
                tipo: "opcion-multiple",
                pregunta: "31. ¡Aquí va un reto extra! ¡Busque al fornicador de la lonja!",
                opciones: ["En una de sus ventanas, hallará a un hombre tallado, no se le advierte su cabeza, pero sí sus genitales, Y muy claramente."],
                correctas: ["En una de sus ventanas, hallará a un hombre tallado, no se le advierte su cabeza, pero sí sus genitales, Y muy claramente."],
                multiple: true
              },
              {
                reto: 32,
                id: "R-32",
                tipo: "opcion",
                pregunta: "32. ¿Qué sostiene el niño en sus manos?",
                opciones: ["Una paloma", "Una Concha", "Alimentos"],
                correctas: ["Una Concha"],
                multiple: false
              }
            ],
            inicializado: false
        };

        // Variables globales
        let currentRetoIndex = -1;
        let retosDisabled = true;

        // ================== FUNCIONES DE UTILIDAD ==================
        function mostrarMensaje(mensaje, tipo = 'info', duracion = 3000) {
            console.log(`[${CONFIG.iframeId}] ${tipo.toUpperCase()}: ${mensaje}`);
            
            // Crear elemento de notificación si no existe
            let notificacion = document.getElementById('notificacion-mensaje');
            if (!notificacion) {
                notificacion = document.createElement('div');
                notificacion.id = 'notificacion-mensaje';
                notificacion.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 10px 20px;
                    border-radius: 5px;
                    color: white;
                    font-weight: bold;
                    z-index: 10000;
                    transition: opacity 0.3s;
                `;
                document.body.appendChild(notificacion);
            }
            
            // Establecer color según tipo
            const colores = {
                info: '#2196F3',
                exito: '#4CAF50',
                error: '#f44336',
                advertencia: '#FF9800'
            };
            
            notificacion.style.backgroundColor = colores[tipo] || colores.info;
            notificacion.textContent = mensaje;
            notificacion.style.opacity = '1';
            
            // Auto-ocultar
            setTimeout(() => {
                if (notificacion) {
                    notificacion.style.opacity = '0';
                    setTimeout(() => {
                        if (notificacion && notificacion.parentNode) {
                            notificacion.parentNode.removeChild(notificacion);
                        }
                    }, 300);
                }
            }, duracion);
        }

        function vibrar() {
            if (navigator.vibrate) {
                navigator.vibrate(300);
            }
        }

        function fuegosArtificiales() {
            const fuegosDiv = document.getElementById('fuegos');
            if (!fuegosDiv) return;
            
            fuegosDiv.style.display = 'block';
            fuegosDiv.innerHTML = `
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                            font-size: 3em; animation: celebration 2s ease-in-out;">
                    🎉 ¡Correcto! 🎉
                </div>
            `;
            
            setTimeout(() => {
                fuegosDiv.style.display = 'none';
                fuegosDiv.innerHTML = '';
            }, 2000);
        }

        // ================== FUNCIONES DE MENSAJERÍA ==================
        async function enviarMensajeAlPadre(tipo, datos = {}) {
            try {
                if (Mensajeria && typeof Mensajeria.enviarMensaje === 'function') {
                    await Mensajeria.enviarMensaje('padre', tipo, datos);
                    console.log(`[${CONFIG.iframeId}] Mensaje enviado al padre:`, { tipo, datos });
                } else {
                    console.warn(`[${CONFIG.iframeId}] Mensajería no disponible para enviar:`, { tipo, datos });
                }
            } catch (error) {
                console.error(`[${CONFIG.iframeId}] Error enviando mensaje al padre:`, error);
            }
        }

        async function notificarError(tipoError, datos = {}) {
            await enviarMensajeAlPadre('sistema_error', {
                tipo: tipoError,
                componente: 'retos',
                ...datos
            });
        }

        async function notificarEstado(tipo, datos = {}) {
            await enviarMensajeAlPadre('reto_estado', {
                tipo,
                componente: 'retos',
                ...datos
            });
        }

        // ================== FUNCIONES DE CONTROL ==================
        function enableControls(modo = 'casa') {
            console.log(`[${CONFIG.iframeId}] Habilitando controles en modo: ${modo}`);
            
            estadoApp.controlesHabilitados = true;
            estadoApp.modo = modo;
            retosDisabled = false;
            
            // Actualizar interfaz
            document.body.classList.remove('disabled');
            
            const overlay = document.querySelector('.disabled-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function disableControls(motivo = 'desconocido') {
            console.log(`[${CONFIG.iframeId}] Deshabilitando controles. Motivo: ${motivo}`);
            
            estadoApp.controlesHabilitados = false;
            retosDisabled = true;
            
            // Actualizar interfaz
            document.body.classList.add('disabled');
            
            let overlay = document.querySelector('.disabled-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'disabled-overlay';
                overlay.innerHTML = '<div>Controles deshabilitados</div>';
                document.body.appendChild(overlay);
            }
            overlay.style.display = 'flex';
        }

        // ================== FUNCIONES DE MANEJO DE MODO ==================
        async function manejarCambioModo(mensaje) {
            try {
                const { modo, habilitar = false, motivo = 'cambio_modo' } = mensaje.datos || {};
                
                if (!modo || !['casa', 'aventura'].includes(modo)) {
                    throw new Error(`Modo no válido: ${modo}`);
                }

                const modoAnterior = estadoApp.modo;
                estadoApp.modo = modo;

                if (habilitar) {
                    enableControls(modo);
                } else {
                    disableControls(motivo);
                }

                // Si cambiamos a modo casa, cerrar retos abiertos
                if (modo === 'casa' && estadoApp.retoActual) {
                    cerrarReto();
                }

                console.log(`[${CONFIG.iframeId}] Modo cambiado de '${modoAnterior}' a '${modo}'`);

                return {
                    estado: 'ok',
                    modoAnterior,
                    modoNuevo: modo
                };

            } catch (error) {
                console.error(`[${CONFIG.iframeId}] Error al cambiar modo:`, error);
                await notificarError('error_cambio_modo', {
                    mensaje: error.message,
                    modo: mensaje.datos?.modo
                });
                throw error;
            }
        }

        // ================== INICIALIZACIÓN ==================
        async function inicializarMensajeria() {
            try {
                console.log(`[${CONFIG.iframeId}] Iniciando sistema de retos...`);

                // Inicializar mensajería
                await Mensajeria.inicializarMensajeria({
                    iframeId: CONFIG.iframeId,
                    debug: CONFIG.debug,
                    logLevel: CONFIG.logLevel
                });

                // Registrar manejadores de mensajes
                registrarManejadores();

                // Inicializar interfaz
                inicializarInterfaz();

                // Marcar como inicializado
                estadoApp.inicializado = true;

                // Notificar al padre que estamos listos
                await enviarMensajeAlPadre('sistema_estado', {
                    tipo: 'inicializacion_completa',
                    estado: 'listo',
                    componente: 'retos',
                    version: '2.0.0',
                    capacidades: ['preguntas', 'validacion', 'progreso']
                });

                console.log(`[${CONFIG.iframeId}] ✅ Sistema de retos inicializado correctamente`);

            } catch (error) {
                console.error(`[${CONFIG.iframeId}] ❌ Error en inicialización:`, error);
                await notificarError('inicializacion', error);
            }
        }

        // ================== REGISTRO DE MANEJADORES ==================
        function registrarManejadores() {
            if (!Mensajeria || typeof Mensajeria.registrarControlador !== 'function') {
                console.warn('⚠️ No se pueden configurar manejadores: Mensajeria no disponible');
                return;
            }

            // Manejador de cambio de modo
            Mensajeria.registrarControlador('cambio_modo', manejarCambioModo);
            Mensajeria.registrarControlador(TIPOS_MENSAJE.SISTEMA?.CAMBIO_MODO || 'cambio_modo', manejarCambioModo);

            // Manejador de controles
            Mensajeria.registrarControlador('habilitar_controles', (mensaje) => {
                const { modo } = mensaje.datos || {};
                enableControls(modo || 'casa');
            });

            Mensajeria.registrarControlador('deshabilitar_controles', (mensaje) => {
                const { motivo } = mensaje.datos || {};
                disableControls(motivo || 'desconocido');
            });

            // Manejador de retos
            Mensajeria.registrarControlador('mostrar_reto', (mensaje) => {
                const { index } = mensaje.datos || {};
                if (typeof index === 'number') {
                    renderizarReto(index);
                }
            });

            console.log(`[${CONFIG.iframeId}] Manejadores de mensajes registrados`);
        }

        // ================== FUNCIONES DE INTERFAZ ==================
        function inicializarInterfaz() {
            // Crear elementos necesarios del DOM
            if (!document.getElementById('reto-contenido')) {
                const container = document.createElement('div');
                container.id = 'reto-contenido';
                container.className = 'reto-contenido';
                document.body.appendChild(container);
            }

            if (!document.getElementById('button-container')) {
                const buttonContainer = document.createElement('div');
                buttonContainer.id = 'button-container';
                buttonContainer.className = 'button-container';
                
                // Crear botones
                const btnEnviar = document.createElement('button');
                btnEnviar.id = 'btnEnviar';
                btnEnviar.className = 'btn';
                btnEnviar.textContent = 'Enviar';
                btnEnviar.addEventListener('click', verificar);
                
                const btnMostrarRespuesta = document.createElement('button');
                btnMostrarRespuesta.id = 'btnMostrarRespuesta';
                btnMostrarRespuesta.className = 'btn';
                btnMostrarRespuesta.textContent = 'Mostrar Respuesta';
                btnMostrarRespuesta.style.display = 'none';
                btnMostrarRespuesta.addEventListener('click', mostrarRespuesta);
                
                const btnContinuar = document.createElement('button');
                btnContinuar.id = 'btnContinueReto';
                btnContinuar.className = 'btn';
                btnContinuar.textContent = 'Continuar';
                btnContinuar.style.display = 'none';
                btnContinuar.addEventListener('click', continuarReto);
                
                buttonContainer.appendChild(btnEnviar);
                buttonContainer.appendChild(btnMostrarRespuesta);
                buttonContainer.appendChild(btnContinuar);
                document.body.appendChild(buttonContainer);
            }

            if (!document.getElementById('respuestaCorrectaTexto')) {
                const respuestaDiv = document.createElement('div');
                respuestaDiv.id = 'respuestaCorrectaTexto';
                respuestaDiv.style.display = 'none';
                document.body.appendChild(respuestaDiv);
            }

            if (!document.getElementById('fuegos')) {
                const fuegosDiv = document.createElement('div');
                fuegosDiv.id = 'fuegos';
                fuegosDiv.style.display = 'none';
                document.body.appendChild(fuegosDiv);
            }

            console.log(`[${CONFIG.iframeId}] Interfaz inicializada`);
        }

        // ================== FUNCIONES DE RETOS ==================
        function renderizarReto(retoIndex) {
            if (retosDisabled) {
                console.log('🚫 No se puede renderizar reto - retos deshabilitados');
                return;
            }
            
            currentRetoIndex = retoIndex;
            const reto = retosAventura1Es[currentRetoIndex];
            if (!reto) {
                console.error("Reto no encontrado para el índice:", retoIndex);
                return;
            }

            const retoContenidoDiv = document.getElementById('reto-contenido');
            const btnEnviar = document.getElementById('btnEnviar');
            const btnMostrarRespuesta = document.getElementById('btnMostrarRespuesta');
            const btnContinuar = document.getElementById('btnContinueReto');
            const respuestaDiv = document.getElementById('respuestaCorrectaTexto');
            const fuegosDiv = document.getElementById('fuegos');

            // Limpiar interfaz
            retoContenidoDiv.innerHTML = '';
            btnEnviar.style.display = "inline-block";
            btnEnviar.disabled = false;
            btnMostrarRespuesta.style.display = "none";
            btnContinuar.style.display = "none";
            respuestaDiv.style.display = "none";
            respuestaDiv.textContent = "";
            fuegosDiv.innerHTML = "";
            fuegosDiv.style.display = "none";

            // Crear pregunta
            const preguntaElem = document.createElement("h3");
            preguntaElem.textContent = reto.pregunta;
            retoContenidoDiv.appendChild(preguntaElem);

            if (reto.tipo === "opcion" || reto.tipo === "opcion-multiple") {
                const opcionesContainer = document.createElement("div");
                opcionesContainer.className = "opciones-container";
                const inputType = reto.multiple ? "checkbox" : "radio";
                
                reto.opciones.forEach((opcion, i) => {
                    const divOpcion = document.createElement("div");
                    divOpcion.className = "respuesta";
                    
                    const input = document.createElement("input");
                    input.type = inputType;
                    input.name = "op";
                    input.value = opcion;
                    input.id = "opcion" + i;
                    divOpcion.appendChild(input);
                    
                    const label = document.createElement("label");
                    label.htmlFor = input.id;
                    label.textContent = opcion;
                    divOpcion.appendChild(label);
                    
                    opcionesContainer.appendChild(divOpcion);
                });
                retoContenidoDiv.appendChild(opcionesContainer);
            } else if (reto.tipo === "texto") {
                const inputTexto = document.createElement("input");
                inputTexto.type = "text";
                inputTexto.id = "respuestaTexto";
                inputTexto.placeholder = "Escriba su respuesta aquí...";
                retoContenidoDiv.appendChild(inputTexto);
                setTimeout(() => inputTexto.focus(), 200);
            }

            estadoApp.retoActual = reto;
            console.log(`🧩 Reto ${retoIndex + 1} renderizado`);
        }

        async function verificar() {
            const reto = retosAventura1Es[currentRetoIndex];
            if (!reto) {
                mostrarMensaje('No hay un reto actual para verificar', 'error');
                return;
            }

            // Obtener respuesta del usuario
            const opciones = document.querySelectorAll('input[type="radio"]:checked, input[type="checkbox"]:checked');
            const inputTexto = document.getElementById("respuestaTexto");
            let respuestaUsuario = [];

            if (opciones.length > 0) {
                opciones.forEach((opcion) => {
                    respuestaUsuario.push(opcion.value);
                });
            } else if (inputTexto && inputTexto.value.trim() !== '') {
                respuestaUsuario.push(inputTexto.value.trim());
            } else {
                mostrarMensaje("Por favor, selecciona una opción o escribe tu respuesta.", "error");
                return;
            }

            // Verificar respuesta
            const esCorrecta = reto.correctas.some((correcta) =>
                respuestaUsuario.some((respuesta) => respuesta.toLowerCase() === correcta.toLowerCase())
            );

            if (esCorrecta) {
                await manejarRespuestaCorrecta(reto);
            } else {
                await manejarRespuestaIncorrecta(reto);
            }
        }

        async function manejarRespuestaCorrecta(reto) {
            mostrarMensaje("¡Respuesta correcta!", "exito");
            fuegosArtificiales();
            
            const btnEnviar = document.getElementById("btnEnviar");
            const btnContinuar = document.getElementById("btnContinueReto");
            
            if (btnEnviar) btnEnviar.disabled = true;
            if (btnContinuar) {
                btnContinuar.style.display = "inline-block";
                btnContinuar.disabled = false;
            }

            await enviarMensajeAlPadre('reto_completado', {
                retoId: reto.id,
                exito: true,
                puntos: reto.puntos || 10
            });
        }

        async function manejarRespuestaIncorrecta(reto) {
            vibrar();
            mostrarMensaje("Respuesta incorrecta. Inténtalo de nuevo.", "error");
            
            const btnMostrarRespuesta = document.getElementById("btnMostrarRespuesta");
            if (btnMostrarRespuesta) {
                btnMostrarRespuesta.style.display = "inline-block";
            }

            await notificarEstado('reto_fallido', { retoId: reto.id });
        }

        function mostrarRespuesta() {
            const reto = retosAventura1Es[currentRetoIndex];
            if (!reto) return;

            const respuestaDiv = document.getElementById('respuestaCorrectaTexto');
            const btnEnviar = document.getElementById("btnEnviar");
            const btnContinuar = document.getElementById("btnContinueReto");

            if (respuestaDiv) {
                respuestaDiv.textContent = `Respuesta correcta: ${reto.correctas.join(", ")}`;
                respuestaDiv.style.display = "block";
            }

            if (btnEnviar) btnEnviar.disabled = true;
            if (btnContinuar) {
                btnContinuar.style.display = "inline-block";
                btnContinuar.disabled = false;
            }
        }

        function continuarReto() {
            const reto = retosAventura1Es[currentRetoIndex];
            if (!reto) return;

            // Limpiar interfaz
            const retoContenidoDiv = document.getElementById('reto-contenido');
            if (retoContenidoDiv) retoContenidoDiv.innerHTML = '';

            const btnContinuar = document.getElementById("btnContinueReto");
            if (btnContinuar) btnContinuar.style.display = "none";

            // Notificar al padre
            enviarMensajeAlPadre('reto_finalizado', {
                retoId: reto.id,
                continuar: true
            });

            console.log(`Continuando después del reto: ${reto.id}`);
        }

        function cerrarReto() {
            if (!estadoApp.retoActual) return;

            const retoId = estadoApp.retoActual.id;
            estadoApp.retoActual = null;
            currentRetoIndex = -1;

            // Limpiar interfaz
            const retoContenidoDiv = document.getElementById('reto-contenido');
            if (retoContenidoDiv) retoContenidoDiv.innerHTML = '';

            enviarMensajeAlPadre('reto_cerrado', { retoId });
            console.log(`Reto cerrado: ${retoId}`);
        }

        // ================== FUNCIONES GLOBALES ==================
        window.enableControls = enableControls;
        window.disableControls = disableControls;
        window.renderizarReto = renderizarReto;
        window.verificar = verificar;
        window.mostrarRespuesta = mostrarRespuesta;
        window.continuarReto = continuarReto;

        // ================== INICIALIZACIÓN AL CARGAR DOM ==================
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log(`[${CONFIG.iframeId}] DOM cargado, inicializando...`);
                
                // Inicializar mensajería
                await inicializarMensajeria();
                
                // Empezar con controles deshabilitados
                disableControls('inicializacion');
                
                console.log(`[${CONFIG.iframeId}] ✅ Inicialización completada`);
                
            } catch (error) {
                console.error(`[${CONFIG.iframeId}] ❌ Error en inicialización:`, error);
                mostrarMensaje('Error al inicializar el sistema de retos', 'error');
            }
        });

    </script>
    <style>
        /* --- ESTILOS BÁSICOS --- */
        :root {
            --borde-reto: 1px;
        }
        
        body {
            font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif;
            margin: 0;
            background: #fff;
            color: #222;
            font-size: 16px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            padding: var(--borde-reto);
            width: calc(100vw - 2 * var(--borde-reto));
            height: calc(100vh - 2 * var(--borde-reto));
        }
        
        /* Estado deshabilitado */
        body.disabled {
            pointer-events: none;
            opacity: 0.6;
            user-select: none;
        }
        
        .disabled-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(128, 128, 128, 0.3);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: #666;
            text-align: center;
        }
        
        body.disabled .disabled-overlay {
            display: flex;
        }
        
        /* Contenedores */
        .reto-contenido, .button-container, #respuestaCorrectaTexto, #fuegos {
            box-sizing: border-box;
            width: 100%;
        }
        
        h3 {
            margin-top: 0;
            margin-bottom: 0.8em;
            font-size: 1.5em;
            text-align: center;
            width: 100%;
        }
        
        .opciones-container {
            width: 100%;
            max-width: 600px;
            text-align: left;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .respuesta {
            margin: 0.4em 0;
            font-size: 1.3em;
            display: flex;
            align-items: center;
        }
        
        .respuesta input[type="radio"],
        .respuesta input[type="checkbox"] {
            margin-right: 0.7em;
            transform: scale(1.3);
            cursor: pointer;
        }
        
        .respuesta input[type="text"] {
            flex-grow: 1;
            font-size: 1.3em;
            padding: 0.3em 0.5em;
            border-radius: 4px;
            border: 1px solid #999;
            width: calc(100% - 1.4em);
        }
        
        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1em;
            margin-top: 1.5em;
            justify-content: center;
            width: 100%;
            min-height: 40px;
        }
        
        button.btn {
            padding: 0.6em 1.2em;
            font-size: 1.1em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background-color: #0077cc;
            color: white;
            user-select: none;
            transition: background-color 0.3s ease;
        }
        
        button.btn:hover {
            background-color: #005699;
        }
        
        button.btn:disabled {
            background-color: #999;
            cursor: not-allowed;
        }
        
        #btnMostrarRespuesta {
            background-color: #28a745;
        }
        
        #btnMostrarRespuesta:hover {
            background-color: #1e7e34;
        }
        
        #respuestaCorrectaTexto {
            margin-top: 1em;
            font-weight: bold;
            text-align: center;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 0.8em 1em;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 1.2em;
            color: #222;
            z-index: 20;
            box-sizing: border-box;
        }
        
        #fuegos {
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            overflow: hidden;
        }

        /* Animaciones */
        @keyframes celebration {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            h3 { font-size: 1.3em; }
            .respuesta { font-size: 1.1em; }
            button.btn { font-size: 1em; padding: 0.5em 1em; }
            #respuestaCorrectaTexto { font-size: 1.1em; }
        }
    </style>
</head>
<body>
    <div class="disabled-overlay">
        <div>Controles deshabilitados</div>
    </div>
</body>
</html>
        flex-grow: 1;
        font-size: 1.3em;
        padding: 0.3em 0.5em;
        border-radius: 4px;
        border: 1px solid #999;
        width: calc(100% - 1.4em);
    }
    #button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1em;
        margin-top: 1.5em;
        justify-content: center;
        width: 100%;
        min-height: 40px;
    }
    button.btn {
        padding: 0.6em 1.2em;
        font-size: 1.1em;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background-color: #0077cc;
        color: white;
        user-select: none;
        transition: background-color 0.3s ease;
    }
    button.btn:hover {
        background-color: #005699;
    }
    button.btn:disabled {
        background-color: #999;
        cursor: not-allowed;
    }
    #btnMostrarRespuesta {
        background-color: #28a745;
        display: none;
    }
    #btnMostrarRespuesta:hover {
        background-color: #1e7e34;
    }
    #respuestaCorrectaTexto {
        margin-top: 1em;
        font-weight: bold;
        text-align: center;
        width: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 0.8em 1em;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        font-size: 1.2em;
        color: #222;
        z-index: 20;
        display: none;
        box-sizing: border-box;
    }
    #fuegos {
        pointer-events: none;
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        overflow: hidden;
        display: none;
    }
    @media (max-width: 600px) {
        h3 { font-size: 1.3em; }
        .respuesta { font-size: 1.1em; }
        button.btn { font-size: 1em; padding: 0.5em 1em; }
        #respuestaCorrectaTexto { font-size: 1.1em; }
    }

        /* --- ESTILOS DEL IFRAME DE RETOS --- */
    /* Para que la ventana de retos ocupe todo el área del iframe menos 1px en cada borde,
       ajusta el padding y el tamaño del contenedor principal. Modifica el valor de --borde-reto
       para cambiar fácilmente el margen respecto al borde del iframe. */
    :root {
        --borde-reto: 1px; /* Margen respecto a cada borde del iframe */
    }
    body {
        font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif;
        margin: 0;
        background: #fff;
        color: #222;
        font-size: 16px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        min-height: 100vh;
        box-sizing: border-box;
        padding: var(--borde-reto);
        width: calc(100vw - 2 * var(--borde-reto));
        height: calc(100vh - 2 * var(--borde-reto));
    }
    
    /* Estado deshabilitado para toda la interfaz */
    body.disabled {
        pointer-events: none;
        opacity: 0.6;
        user-select: none;
    }
    
    /* Overlay de estado deshabilitado */
    .disabled-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(128, 128, 128, 0.3);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        color: #666;
        text-align: center;
    }
    
    body.disabled .disabled-overlay {
        display: flex;
    }
    
    #reto-contenido, #button-container, #respuestaCorrectaTexto, #fuegos {
        /* Asegura que los elementos internos no sobresalgan */
        box-sizing: border-box;
        width: 100%;
    }
    h3 {
        margin-top: 0;
        margin-bottom: 0.8em;
        font-size: 1.5em;
        text-align: center;
        width: 100%;
    }
    .opciones-container {
        width: 100%;
        max-width: 600px;
        text-align: left;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .respuesta {
        margin: 0.4em 0;
        font-size: 1.3em;
        display: flex;
        align-items: center;
    }
    .respuesta input[type="radio"],
    .respuesta input[type="checkbox"] {
        margin-right: 0.7em;
        transform: scale(1.3);
        cursor: pointer;
    }
    .respuesta input[type="text"] {
        flex-grow: 1;
        font-size: 1.3em;
        padding: 0.3em 0.5em;
        border-radius: 4px;
        border: 1px solid #999;
        width: calc(100% - 1.4em);
    }
    #button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1em;
        margin-top: 1.5em;
        justify-content: center;
        width: 100%;
        min-height: 40px;
    }
    button.btn {
        padding: 0.6em 1.2em;
        font-size: 1.1em;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background-color: #0077cc;
        color: white;
        user-select: none;
        transition: background-color 0.3s ease;
    }
    button.btn:hover {
        background-color: #005699;
    }
    button.btn:disabled {
        background-color: #999;
        cursor: not-allowed;
    }
    #btnMostrarRespuesta {
        background-color: #28a745;
        display: none;
    }
    #btnMostrarRespuesta:hover {
        background-color: #1e7e34;
    }
    #respuestaCorrectaTexto {
        margin-top: 1em;
        font-weight: bold;
        text-align: center;
        width: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 0.8em 1em;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        font-size: 1.2em;
        color: #222;
        z-index: 20;
        display: none;
        box-sizing: border-box;
    }
    #fuegos {
        pointer-events: none;
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        overflow: hidden;
        display: none;
    }
    @media (max-width: 600px) {
        h3 { font-size: 1.3em; }
        .respuesta { font-size: 1.1em; }
        button.btn { font-size: 1em; padding: 0.5em 1em; }
        #respuestaCorrectaTexto { font-size: 1.1em; }
    }

        /* --- ESTILOS DEL IFRAME DE RETOS --- */
    /* Para que la ventana de retos ocupe todo el área del iframe menos 1px en cada borde,
       ajusta el padding y el tamaño del contenedor principal. Modifica el valor de --borde-reto
       para cambiar fácilmente el margen respecto al borde del iframe. */
    :root {
        --borde-reto: 1px; /* Margen respecto a cada borde del iframe */
    }
    body {
        font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif;
        margin: 0;
        background: #fff;
        color: #222;
        font-size: 16px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        min-height: 100vh;
        box-sizing: border-box;
        padding: var(--borde-reto);
        width: calc(100vw - 2 * var(--borde-reto));
        height: calc(100vh - 2 * var(--borde-reto));
    }
    
    /* Estado deshabilitado para toda la interfaz */
    body.disabled {
        pointer-events: none;
        opacity: 0.6;
        user-select: none;
    }
    
    /* Overlay de estado deshabilitado */
    .disabled-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(128, 128, 128, 0.3);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        color: #666;
        text-align: center;
    }
    
    body.disabled .disabled-overlay {
        display: flex;
    }
    
    #reto-contenido, #button-container, #respuestaCorrectaTexto, #fuegos {
        /* Asegura que los elementos internos no sobresalgan */
        box-sizing: border-box;
        width: 100%;
    }
    h3 {
        margin-top: 0;
        margin-bottom: 0.8em;
        font-size: 1.5em;
        text-align: center;
        width: 100%;
    }
    .opciones-container {
        width: 100%;
        max-width: 600px;
        text-align: left;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .respuesta {
        margin: 0.4em 0;
        font-size: 1.3em;
        display: flex;
        align-items: center;
    }
    .respuesta input[type="radio"],
    .respuesta input[type="checkbox"] {
        margin-right: 0.7em;
        transform: scale(1.3);
        cursor: pointer;
    }
    .respuesta input[type="text"] {
        flex-grow: 1;
        font-size: 1.3em;
        padding: 0.3em 0.5em;
        border-radius: 4px;
        border: 1px solid #999;
        width: calc(100% - 1.4em);
    }
    #button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1em;
        margin-top: 1.5em;
        justify-content: center;
        width: 100%;
        min-height: 40px;
    }
    button.btn {
        padding: 0.6em 1.2em;
        font-size: 1.1em;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background-color: #0077cc;
        color: white;
        user-select: none;
        transition: background-color 0.3s ease;
    }
    button.btn:hover {
        background-color: #005699;
    }
    button.btn:disabled {
        background-color: #999;
        cursor: not-allowed;
    }
    #btnMostrarRespuesta {
        background-color: #28a745;
        display: none;
    }
    #btnMostrarRespuesta:hover {
        background-color: #1e7e34;
    }
    #respuestaCorrectaTexto {
        margin-top: 1em;
        font-weight: bold;
        text-align: center;
        width: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 0.8em 1em;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        font-size: 1.2em;
        color: #222;
        z-index: 20;
        display: none;
        box-sizing: border-box;
    }
    #fuegos {
        pointer-events: none;
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        overflow: hidden;
        display: none;
    }
    @media (max-width: 600px) {
        h3 { font-size: 1.3em; }
        .respuesta { font-size: 1.1em; }
        button.btn { font-size: 1em; padding: 0.5em 1em; }
        #respuestaCorrectaTexto { font-size: 1.1em; }
    }

        /* --- ESTILOS DEL IFRAME DE RETOS --- */
    /* Para que la ventana de retos ocupe todo el área del iframe menos 1px en cada borde,
       ajusta el padding y el tamaño del contenedor principal. Modifica el valor de --borde-reto
       para cambiar fácilmente el margen respecto al borde del iframe. */
    :root {
        --borde-reto: 1px; /* Margen respecto a cada borde del iframe */
    }
    body {
        font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif;
        margin: 0;
        background: #fff;
        color: #222;
        font-size: 16px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        min-height: 100vh;
        box-sizing: border-box;
        padding: var(--borde-reto);
        width: calc(100vw - 2 * var(--borde-reto));
        height: calc(100vh - 2 * var(--borde-reto));
    }
    
    /* Estado deshabilitado para toda la interfaz */
    body.disabled {
        pointer-events: none;
        opacity: 0.6;
        user-select: none;
    }
    
    /* Overlay de estado deshabilitado */
    .disabled-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(128, 128, 128, 0.3);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        color: #666;
        text-align: center;
    }
    
    body.disabled .disabled-overlay {
        display: flex;
    }
    
    #reto-contenido, #button-container, #respuestaCorrectaTexto, #fuegos {
        /* Asegura que los elementos internos no sobresalgan */
        box-sizing: border-box;
        width: 100%;
    }
    h3 {
        margin-top: 0;
        margin-bottom: 0.8em;
        font-size: 1.5em;
        text-align: center;
        width: 100%;
    }
    .opciones-container {
        width: 100%;
        max-width: 600px;
        text-align: left;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .respuesta {
        margin: 0.4em 0;
        font-size: 1.3em;
        display: flex;
        align-items: center;
    }
    .respuesta input[type="radio"],
    .respuesta input[type="checkbox"] {
        margin-right: 0.7em;
        transform: scale(1.3);
        cursor: pointer;
    }
    .respuesta input[type="text"] {
        flex-grow: 1;
        font-size: 1.3em;
        padding: 0.3em 0.5em;
        border-radius: 4px;
        border: 1px solid #999;
        width: calc(100% - 1.4em);
    }
    #button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1em;
        margin-top: 1.5em;
        justify-content: center;
        width: 100%;
        min-height: 40px;
    }
    button.btn {
        padding: 0.6em 1.2em;
        font-size: 1.1em;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background-color: #0077cc;
        color: white;
        user-select: none;
        transition: background-color 0.3s ease;
    }
    button.btn:hover {
        background-color: #005699;
    }
    button.btn:disabled {
        background-color: #999;
        cursor: not-allowed;
    }
    #btnMostrarRespuesta {
        background-color: #28a745;
        display: none;
    }
    #btnMostrarRespuesta:hover {
        background-color: #1e7e34;
    }
    #respuestaCorrectaTexto {
        margin-top: 1em;
        font-weight: bold;
        text-align: center;
        width: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 0.8em 1em;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        font-size: 1.2em;
        color: #222;
        z-index: 20;
        display: none;
        box-sizing: border-box;
    }
    #fuegos {
        pointer-events: none;
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        overflow: hidden;
        display: none;
    }
    @media (max-width: 600px) {
        h3 { font-size: 1.3em; }
        .respuesta { font-size: 1.1em; }
        button.btn { font-size: 1em; padding: 0.5em 1em; }
        #respuestaCorrectaTexto { font-size: 1.1em; }
    }

        /* --- ESTILOS DEL IFRAME DE RETOS --- */
    /* Para que la ventana de retos ocupe todo el área del iframe menos 1px en cada borde,
       ajusta el padding y el tamaño del contenedor principal. Modifica el valor de --borde-reto
       para cambiar fácilmente el margen respecto al borde del iframe. */
    :root {
        --borde-reto: 1px; /* Margen respecto a cada borde del iframe */
    }
    body {
        font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif;
        margin: 0;
        background: #fff;
        color: #222;
        font-size: 16px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        min-height: 100vh;
        box-sizing: border-box;
        padding: var(--borde-reto);
        width: calc(100vw - 2 * var(--borde-reto));
        height: calc(100vh - 2 * var(--borde-reto));
    }
    
    /* Estado deshabilitado para toda la interfaz */
    body.disabled {
        pointer-events: none;
        opacity: 0.6;
        user-select: none;
    }
    
    /* Overlay de estado deshabilitado */
    .disabled-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(128, 128, 128, 0.3);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        color: #666;
        text-align: center;
    }
    
    body.disabled .disabled-overlay {
        display: flex;
    }
    
    #reto-contenido, #button-container, #respuestaCorrectaTexto, #fuegos {
        /* Asegura que los elementos internos no sobresalgan */
        box-sizing: border-box;
        width: 100%;
    }
    h3 {
        margin-top: 0;
        margin-bottom: 0.8em;
        font-size: 1.5em;
        text-align: center;
        width: 100%;
    }
    .opciones-container {
        width: 100%;
        max-width: 600px;
        text-align: left;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .respuesta {
        margin: 0.4em 0;
        font-size: 1.3em;
        display: flex;
        align-items: center;
    }
    .respuesta input[type="radio"],
    .respuesta input[type="checkbox"] {
        margin-right: 0.7em;
        transform: scale(1.3);
        cursor: pointer;
    }
    .respuesta input[type="text"] {
        flex-grow: 1;
        font-size: 1.3em;
        padding: 0.3em 0.5em;
        border-radius: 4px;
        border: 1px solid #999;
        width: calc(100% - 1.4em);
    }
    #button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1em;
        margin-top: 1.5em;
        justify-content: center;
        width: 100%;
        min-height: 40px;
    }
    button.btn {
        padding: 0.6em 1.2em;
        font-size: 1.1em;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background-color: #0077cc;
        color: white;
        user-select: none;
        transition: background-color 0.3s ease;
    }
    button.btn:hover {
        background-color: #005699;
    }
    button.btn:disabled {
        background-color: #999;
        cursor: not-allowed;
    }
    #btnMostrarRespuesta {
        background-color: #28a745;
        display: none;
    }
    #btnMostrarRespuesta:hover {
        background-color: #1e7e34;
    }
    #respuestaCorrectaTexto {
        margin-top: 1em;
        font-weight: bold;
        text-align: center;
        width: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 0.8em 1em;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        font-size: 1.2em;
        color: #222;
        z-index: 20;
        display: none;
        box-sizing: border-box;
    }
    #fuegos {
        pointer-events: none;
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        overflow: hidden;
        display: none;
    }
    @media (max-width: 600px) {
        h3 { font-size: 1.3em; }
        .respuesta { font-size: 1.1em; }
        button.btn { font-size: 1em; padding: 0.5em 1em; }
        #respuestaCorrectaTexto { font-size: 1.1em; }
    }

        /* --- ESTILOS DEL IFRAME DE RETOS --- */
    /* Para que la ventana de retos ocupe todo el área del iframe menos 1px en cada borde,
       ajusta el padding y el tamaño del contenedor principal. Modifica el valor de --borde-reto
       para cambiar fácilmente el margen respecto al borde del iframe. */
    :root {
        --borde-reto: 1px; /* Margen respecto a cada borde del iframe */
    }
    body {
        font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif;
        margin: 0;
        background: #fff;
        color: #222;
        font-size: 16px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        min-height: 100vh;
        box-sizing: border-box;
        padding: var(--borde-reto);
        width: calc(100vw - 2 * var(--borde-reto));
        height: calc(100vh - 2 * var(--borde-reto));
    }
    
    /* Estado deshabilitado para toda la interfaz */
    body.disabled {
        pointer-events: none;
        opacity: 0.6;
        user-select: none;
    }
    
    /* Overlay de estado deshabilitado */
    .disabled-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(128, 128, 128, 0.3);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        color: #666;
        text-align: center;
    }
    
    body.disabled .disabled-overlay {
        display: flex;
    }
    
    #reto-contenido, #button-container, #respuestaCorrectaTexto, #fuegos {
        /* Asegura que los elementos internos no sobresalgan */
        box-sizing: border-box;
        width: 100%;
    }
    h3 {
        margin-top: 0;
        margin-bottom: 0.8em;
        font-size: 1.5em;
        text-align: center;
        width: 100%;
    }
    .opciones-container {
        width: 100%;
        max-width: 600px;
        text-align: left;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .respuesta {
        margin: 0.4em 0;
        font-size: 1.3em;
        display: flex;
        align-items: center;
    }
    .respuesta input[type="radio"],
    .respuesta input[type="checkbox"] {
        margin-right: 0.7em;
        transform: scale(1.3);
        cursor: pointer;
    }
    .respuesta input[type="text"] {
        flex-grow: 1;
        font-size: 1.3em;
        padding: 0.3em 0.5em;
        border-radius: 4px;
        border: 1px solid #999;
        width: calc(100% - 1.4em);
    }
    #button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1em;
        margin-top: 1.5em;
        justify-content: center;
        width: 100%;
        min-height: 40px;
    }
    button.btn {
        padding: 0.6em 1.2em;
        font-size: 1.1em;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background-color: #0077cc;
        color: white;
        user-select: none;
        transition: background-color 0.3s ease;
    }
    button.btn:hover {
        background-color: #005699;
    }
    button.btn:disabled {
        background-color: #999;
        cursor: not-allowed;
    }
    #btnMostrarRespuesta {
        background-color: #28a745;
        display: none;
    }
    #btnMostrarRespuesta:hover {
        background-color: #1e7e34;
    }
    #respuestaCorrectaTexto {
        margin-top: 1em;
        font-weight: bold;
        text-align: center;
        width: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 0.8em 1em;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        font-size: 1.2em;
        color: #222;
        z-index: 20;
        display: none;
        box-sizing: border-box;
    }
    #fuegos {
        pointer-events: none;
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        overflow: hidden;
        display: none;
    }
    @media (max-width: 600px) {
        h3 { font-size: 1.3em; }
        .respuesta { font-size: 1.1em; }
        button.btn { font-size: 1em; padding: 0.5em 1em; }
        #respuestaCorrectaTexto { font-size: 1.1em; }
    }

        /* --- ESTILOS DEL IFRAME DE RETOS --- */
    /* Para que la ventana de retos ocupe todo el área del iframe menos 1px en cada borde,
       ajusta el padding y el tamaño del contenedor principal. Modifica el valor de --borde-reto
       para cambiar fácilmente el margen respecto al borde del iframe. */
    :root {
        --borde-reto: 1px; /* Margen respecto a cada borde del iframe */
    }
    body {
        font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif;
        margin: 0;
        background: #fff;
        color: #222;
        font-size: 16px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        min-height: 100vh;
        box-sizing: border-box;
        padding: var(--borde-reto);
        width: calc(100vw - 2 * var(--borde-reto));
        height: calc(100vh - 2 * var(--borde-reto));
    }
    
    /* Estado deshabilitado para toda la interfaz */
    body.disabled {
        pointer-events: none;
        opacity: 0.6;
        user-select: none;
    }
    
    /* Overlay de estado deshabilitado */
    .disabled-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(128, 128, 128, 0.3);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        color: #666;
        text-align: center;
    }
    
    body.disabled .disabled-overlay {
        display: flex;
    }
    
    #reto-contenido, #button-container, #respuestaCorrectaTexto, #fuegos {
        /* Asegura que los elementos internos no sobresalgan */
        box-sizing: border-box;
        width: 100%;
    }
    h3 {
        margin-top: 0;
        margin-bottom: 0.8em;
        font-size: 1.5em;
        text-align: center;
        width: 100%;
    }
    .opciones-container {
        width: 100%;
        max-width: 600px;
        text-align: left;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .respuesta {
        margin: 0.4em 0;
        font-size: 1.3em;
        display: flex;
        align-items: center;
    }
    .respuesta input[type="radio"],
    .respuesta input[type="checkbox"] {
        margin-right: 0.7em;
        transform: scale(1.3);
        cursor: pointer;
    }
    .respuesta input[type="text"] {
        flex-grow: 1;
        font-size: 1.3em;
        padding: 0.3em 0.5em;
        border-radius: 4px;
        border: 1px solid #999;
        width: calc(100% - 1.4em);
    }
    #button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1em;
        margin-top: 1.5em;
        justify-content: center;
        width: 100%;
        min-height: 40px;
    }
    button.btn {
        padding: 0.6em 1.2em;
        font-size: 1.1em;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background-color: #0077cc;
        color: white;
        user-select: none;
        transition: background-color 0.3s ease;
    }
    button.btn:hover {
        background-color: #005699;
    }
    button.btn:disabled {
        background-color: #999;
        cursor: not-allowed;
    }
    #btnMostrarRespuesta {
        background-color: #28a745;
        display: none;
    }
    #btnMostrarRespuesta:hover {
        background-color: #1e7e34;
    }
    #respuestaCorrectaTexto {
        margin-top: 1em;
        font-weight: bold;
        text-align: center;
        width: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 0.8em 1em;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        font-size: 1.2em;
        color: #222;
        z-index: 20;
        display: none;
        box-sizing: border-box;
    }
    #fuegos {
        pointer-events: none;
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        overflow: hidden;
        display: none;
    }
    @media (max-width: 600px) {
        h3 { font-size: 1.3em; }
        .respuesta { font-size: 1.1em; }
        button.btn { font-size: 1em; padding: 0.5em 1em; }
        #respuestaCorrectaTexto { font-size: 1.1em; }
    }

        /* --- ESTILOS DEL IFRAME DE RETOS --- */
    /* Para que la ventana de retos ocupe todo el área del iframe menos 1px en cada borde,
       ajusta el padding y el tamaño del contenedor principal. Modifica el valor de --borde-reto
       para cambiar fácilmente el margen respecto al borde del iframe. */
    :root {
        --borde-reto: 1px; /* Margen respecto a cada borde del iframe */
    }
    body {
        font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif;
        margin: 0;
        background: #fff;
        color: #222;
        font-size: 16px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        min-height: 100vh;
        box-sizing: border-box;
        padding: var(--borde-reto);
        width: calc(100vw - 2 * var(--borde-reto));
        height: calc(100vh - 2 * var(--borde-reto));
    }
    
    /* Estado deshabilitado para toda la interfaz */
    body.disabled {
        pointer-events: none;
        opacity: 0.6;
        user-select: none;
    }
    
    /* Overlay de estado deshabilitado */
    .disabled-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(128, 128, 128, 0.3);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        color: #666;
        text-align: center;
    }
    
    body.disabled .disabled-overlay {
        display: flex;
    }
    
    #reto-contenido, #button-container, #respuestaCorrectaTexto, #fuegos {
        /* Asegura que los elementos internos no sobresalgan */
        box-sizing: border-box;
        width: 100%;
    }
    h3 {
        margin-top: 0;
        margin-bottom: 0.8em;
        font-size: 1.5em;
        text-align: center;
        width: 100%;
    }
    .opciones-container {
        width: 100%;
        max-width: 600px;
        text-align: left;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .respuesta {
        margin: 0.4em 0;
        font-size: 1.3em;
        display: flex;
        align-items: center;
    }
    .respuesta input[type="radio"],
    .respuesta input[type="checkbox"] {
        margin-right: 0.7em;
        transform: scale(1.3);
        cursor: pointer;
    }
    .respuesta input[type="text"] {
        flex-grow: 1;
        font-size: 1.3em;
        padding: 0.3em 0.5em;
        border-radius: 4px;
        border: 1px solid #999;
        width: calc(100% - 1.4em);
    }
    #button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1em;
        margin-top: 1.5em;
        justify-content: center;
        width: 100%;
        min-height: 40px;
    }
    button.btn {
        padding: 0.6em 1.2em;
        font-size: 1.1em;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background-color: #0077cc;
        color: white;
        user-select: none;
        transition: background-color 0.3s ease;
    }
    button.btn:hover {
        background-color: #005699;
    }
    button.btn:disabled {
        background-color: #999;
        cursor: not-allowed;
    }
    #btnMostrarRespuesta {
        background-color: #28a745;
        display: none;
    }
    #btnMostrarRespuesta:hover {
        background-color: #1e7e34;
    }
    #respuestaCorrectaTexto {
        margin-top: 1em;
        font-weight: bold;
        text-align: center;
        width: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 0.8em 1em;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        font-size: 1.2em;
        color: #222;
        z-index: 20;
        display: none;
        box-sizing: border-box;
    }
    #fuegos {
        pointer-events: none;
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        overflow: hidden;
        display: none;
    }
    @media (max-width: 600px) {
        h3 { font-size: 1.3em; }
        .respuesta { font-size: 1.1em; }
        button.btn { font-size: 1em; padding: 0.5em 1em; }
        #respuestaCorrectaTexto { font-size: 1.1em; }
    }

        /* --- ESTILOS DEL IFRAME DE RETOS --- */
    /* Para que la ventana de retos ocupe todo el área del iframe menos 1px en cada borde,
       ajusta el padding y el tamaño del contenedor principal. Modifica el valor de --borde-reto
       para cambiar fácilmente el margen respecto al borde del iframe. */
    :root {
        --borde-reto: 1px; /* Margen respecto a cada borde del iframe */
    }
    body {
        font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif;
        margin: 0;
        background: #fff;
        color: #222;
        font-size: 16px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        min-height: 100vh;
        box-sizing: border-box;
        padding: var(--borde-reto);
        width: calc(100vw - 2 * var(--borde-reto));
        height: calc(100vh - 2 * var(--borde-reto));
    }
    
    /* Estado deshabilitado para toda la interfaz */
    body.disabled {
        pointer-events: none;
        opacity: 0.6;
        user-select: none;
    }
    
    /* Overlay de estado deshabilitado */
    .disabled-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(128, 128, 128, 0.3);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        color: #666;
        text-align: center;
    }
    
    body.disabled .disabled-overlay {
        display: flex;
    }
    
    #reto-contenido, #button-container, #respuestaCorrectaTexto, #fuegos {
        /* Asegura que los elementos internos no sobresalgan */
        box-sizing: border-box;
        width: 100%;
    }
    h3 {
        margin-top: 0;
        margin-bottom: 0.8em;
        font-size: 1.5em;
        text-align: center;
        width: 100%;
    }
    .opciones-container {
        width: 100%;
        max-width: 600px;
        text-align: left;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .respuesta {
        margin: 0.4em 0;
        font-size: 1.3em;
        display: flex;
        align-items: center;
    }
    .respuesta input[type="radio"],
    .respuesta input[type="checkbox"] {
        margin-right: 0.7em;
        transform: scale(1.3);
        cursor: pointer;
    }
    .respuesta input[type="text"] {
        flex-grow: 1;
        font-size: 1.3em;
        padding: 0.3em 0.5em;
        border-radius: 4px;
        border: 1px solid #999;
        width: calc(100% - 1.4em);
    }
    #button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1em;
        margin-top: 1.5em;
        justify-content: center;
        width: 100%;
        min-height: 40px;
    }
    button.btn {
        padding: 0.6em 1.2em;
        font-size: 1.1em;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background-color: #0077cc;
        color: white;
        user-select: none;
        transition: background-color 0.3s ease;
    }
    button.btn:hover {
        background-color: #005699;
    }
    button.btn:disabled {
        background-color: #999;
        cursor: not-allowed;
    }
    #btnMostrarRespuesta {
        background-color: #28a745;
        display: none;
    }
    #btnMostrarRespuesta:hover {
        background-color: #1e7e34;
    }
    #respuestaCorrectaTexto {
        margin-top: 1em;
        font-weight: bold;
        text-align: center;
        width: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 0.8em 1em;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        font-size: 1.2em;
        color: #222;
        z-index: 20;
        display: none;
        box-sizing: border-box;
    }
    #fuegos {
        pointer-events: none;
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        overflow: hidden;
        display: none;

// --- EFECTO: Vibración al fallar ---
function vibrar() {
    if (navigator.vibrate) navigator.vibrate(300);
}

// ================== GESTIÓN DE RETOS ==================

// --- RENDERIZAR EL RETO SEGÚN EL ÍNDICE QUE ENVÍA EL PADRE ---
function renderizarReto(retoIndex) {
    // No renderizar si los retos están deshabilitados
    if (retosDisabled) {
        console.log('🚫 HIJO 4: No se puede renderizar reto - retos deshabilitados');
        enviarAlPadre({ type: "reto-hijo-error", message: "Retos deshabilitados", index: retoIndex });
        return;
    }
    
    currentRetoIndex = retoIndex;
    const reto = retosAventura1Es[currentRetoIndex];
    if (!reto) {
        console.error("Reto no encontrado para el índice:", retoIndex);
        enviarAlPadre({ type: "reto-hijo-error", message: "Reto no encontrado", index: retoIndex });
        return;
    }
    retoContenidoDiv.innerHTML = '';
    btnEnviar.style.display = "inline-block";
    btnEnviar.disabled = false;
    btnMostrarRespuesta.style.display = "none";
    btnContinueReto.style.display = "none";
    divRespuestaCorrecta.style.display = "none";
    divRespuestaCorrecta.textContent = "";
    fuegosDiv.innerHTML = "";
    fuegosDiv.style.display = "none";
    let preguntaElem = document.createElement("h3");
    preguntaElem.textContent = reto.pregunta;
    retoContenidoDiv.appendChild(preguntaElem);
    if (reto.tipo === "opcion" || reto.tipo === "opcion-multiple") {
        const opcionesContainer = document.createElement("div");
        opcionesContainer.className = "opciones-container";
        const inputType = reto.multiple ? "checkbox" : "radio";
        reto.opciones.forEach((opcion, i) => {
            const divOpcion = document.createElement("div");
            divOpcion.className = "respuesta";
            const input = document.createElement("input");
            input.type = inputType;
            input.name = "op";
            input.value = opcion;
            input.id = "opcion" + i;
            divOpcion.appendChild(input);
            const label = document.createElement("label");
            label.htmlFor = input.id;
            label.textContent = opcion;
            divOpcion.appendChild(label);
            opcionesContainer.appendChild(divOpcion);
        });
        retoContenidoDiv.appendChild(opcionesContainer);
    } else if (reto.tipo === "texto") {
        const inputTexto = document.createElement("input");
        inputTexto.type = "text";
        inputTexto.id = "respuestaTexto";
        inputTexto.autocomplete = "off";
        inputTexto.spellcheck = false;
        inputTexto.setAttribute("inputmode", "text");
        inputTexto.placeholder = "Escriba su respuesta aquí...";
        retoContenidoDiv.appendChild(inputTexto);
        setTimeout(() => inputTexto.focus(), 200);
    }
    // No notificamos al padre aún, esperamos a que el usuario haga clic en Continuar
    console.log(`🧩 HIJO 4: Reto ${retoIndex + 1} renderizado`);
}

// --- VERIFICAR LA RESPUESTA DEL USUARIO ---
async function verificar() {
    const idTransaccion = `verificar_respuesta_${Date.now()}`;
    let retoActual, respuestaUsuario;
    
    try {
        // Validar que hay un reto actual
        retoActual = retosAventura1Es[currentRetoIndex];
        if (!retoActual) {
            throw new Error('No hay un reto actual para verificar');
        }
        
        console.log(`[${IFRAME_ID}] Verificando respuesta para reto:`, { 
            retoId: retoActual.id, 
            idTransaccion 
        });

        // Obtener la respuesta del usuario
        const opciones = document.querySelectorAll('input[type="radio"]:checked, input[type="checkbox"]:checked');
        const inputTexto = document.getElementById("respuestaTexto");
        respuestaUsuario = [];

        if (opciones.length > 0) {
            opciones.forEach((opcion) => {
                respuestaUsuario.push(opcion.value);
            });
        } else if (inputTexto && inputTexto.value.trim() !== '') {
            respuestaUsuario.push(inputTexto.value.trim());
        } else {
            mostrarMensaje("Por favor, selecciona una opción o escribe tu respuesta.", "error");
            return;
        }

        // Verificar si la respuesta es correcta (comparación insensible a mayúsculas/minúsculas)
        const esCorrecta = retoActual.correctas.some((correcta) =>
            respuestaUsuario.some((respuesta) => respuesta.toLowerCase() === correcta.toLowerCase())
        );

        // Actualizar el estado
        estadoApp.ultimaRespuesta = {
            retoId: retoActual.id,
            respuesta: respuestaUsuario,
            esCorrecta,
            timestamp: new Date().toISOString(),
            idTransaccion
        };

        // Mostrar retroalimentación
        if (esCorrecta) {
            await manejarRespuestaCorrecta(retoActual, idTransaccion);
        } else {
            await manejarRespuestaIncorrecta(retoActual, idTransaccion);
        }
        
    } catch (error) {
        console.error(`[${IFRAME_ID}] Error al verificar la respuesta:`, error);
        
        // Notificar al padre del error
        await notificarError('error_verificar_respuesta', {
            retoId: retoActual?.id,
            respuestaUsuario,
            idTransaccion,
            mensaje: error.message,
            stack: error.stack,
            timestamp: new Date().toISOString()
        });
        
        // Mostrar mensaje de error al usuario
        mostrarMensaje("Ha ocurrido un error al verificar tu respuesta. Por favor, inténtalo de nuevo.", "error");
    }
}

/**
 * Maneja una respuesta correcta del usuario
 * @param {Object} retoActual - El reto actual
 * @param {string} idTransaccion - ID de transacción para seguimiento
 */
async function manejarRespuestaCorrecta(retoActual, idTransaccion) {
    // Mostrar retroalimentación visual
    mostrarMensaje("¡Respuesta correcta!", "exito");
    fuegosArtificiales();
    
    // Deshabilitar controles
    const btnEnviar = document.getElementById("btnEnviar");
    if (btnEnviar) btnEnviar.disabled = true;
    
    // Habilitar el botón de continuar
    const btnContinuar = document.getElementById("btnContinueReto");
    if (btnContinuar) {
        btnContinuar.disabled = false;
        
        // Configurar manejador de eventos para continuar
        const manejarContinuar = async () => {
            console.log(`[${IFRAME_ID}] Continuando después del reto ${retoActual.id}`);
            
            try {
                // Notificar al padre que el usuario quiere continuar
                await enviarMensajeAlPadre('reto_finalizado', {
                    retoId: retoActual.id,
                    exito: true,
                    continuar: true,
                    idTransaccion
                });
                
                // Limpiar la interfaz
                const retoContenidoDiv = document.getElementById("reto-contenido");
                if (retoContenidoDiv) {
                    retoContenidoDiv.innerHTML = '';
                }
                
                // Deshabilitar el botón de nuevo
                btnContinuar.disabled = true;
                
                // Limpiar el manejador de eventos para evitar duplicados
                btnContinuar.removeEventListener('click', manejarContinuar);
                
            } catch (error) {
                console.error(`[${IFRAME_ID}] Error al continuar después del reto:`, error);
                mostrarMensaje("Error al continuar. Por favor, inténtalo de nuevo.", "error");
            }
        };
        
        // Asignar el manejador de eventos
        btnContinuar.addEventListener('click', manejarContinuar);
        btnContinuar.focus();
    }
    
    // Notificar al padre que el reto se completó exitosamente
    await enviarMensajeAlPadre('reto_completado', {
        retoId: retoActual.id,
        tipo: retoActual.tipo,
        exito: true,
        esPuzzle: false,
        puntos: retoActual.puntos || 10,
        idTransaccion,
        timestamp: new Date().toISOString()
    });
    
    console.log(`[${IFRAME_ID}] Reto completado correctamente:`, { 
        retoId: retoActual.id,
        idTransaccion 
    });
}

/**
 * Maneja una respuesta incorrecta del usuario
 * @param {Object} retoActual - El reto actual
 * @param {string} idTransaccion - ID de transacción para seguimiento
 */
async function manejarRespuestaIncorrecta(retoActual, idTransaccion) {
    // Efecto de vibración para retroalimentación
    vibrar();
    
    // Habilitar controles para reintentar
    const btnEnviar = document.getElementById("btnEnviar");
    if (btnEnviar) btnEnviar.disabled = false;
    
    // Mostrar botón para ver la respuesta
    const btnMostrarRespuesta = document.getElementById("btnMostrarRespuesta");
    if (btnMostrarRespuesta) {
        btnMostrarRespuesta.style.display = "inline-block";
    }
    
    // Notificar al padre del fallo
    await notificarEstado('reto_fallido', {
        retoId: retoActual.id,
        idTransaccion,
        timestamp: new Date().toISOString()
    });
    
    console.log(`[${IFRAME_ID}] Respuesta incorrecta para el reto:`, { 
        retoId: retoActual.id,
        idTransaccion 
    });
}

// ================== EVENT LISTENERS ==================

// --- REFERENCIAS A ELEMENTOS DEL DOM ---
const elementosUI = {
    // Obtiene los elementos del DOM de forma perezosa
    get btnEnviar() { return document.getElementById("btnEnviar"); },
    get btnContinueReto() { return document.getElementById("btnContinueReto"); },
    get divRespuestaCorrecta() { return document.getElementById("respuesta-correcta"); },
    get retoContenido() { return document.getElementById("reto-contenido"); },
    get btnMostrarRespuesta() { return document.getElementById("btnMostrarRespuesta"); },
    get iframe() { return window.frameElement; },
    
    // Métodos de utilidad
    limpiarContenido() {
        if (this.retoContenido) this.retoContenido.innerHTML = '';
        if (this.divRespuestaCorrecta) {
            this.divRespuestaCorrecta.textContent = '';
            this.divRespuestaCorrecta.style.display = 'none';
        }
    },
    
    configurarBotonContinuar(manejador) {
        if (!this.btnContinueReto) return;
        
        // Clonar el botón para eliminar manejadores anteriores
        const nuevoBoton = this.btnContinueReto.cloneNode(true);
        this.btnContinueReto.parentNode.replaceChild(nuevoBoton, this.btnContinueReto);
        
        // Configurar el nuevo manejador
        nuevoBoton.style.display = 'inline-block';
        nuevoBoton.addEventListener('click', manejador, { once: true });
    },
    
    ocultarInterfaz() {
        if (this.iframe) {
            this.iframe.style.display = 'none';
        }
    }
};

// --- FUNCIONES DE UTILIDAD ---

/**
 * Limpia la interfaz del reto
 */
function limpiarInterfaz() {
    elementosUI.limpiarContenido();
    
    if (elementosUI.btnEnviar) {
        elementosUI.btnEnviar.disabled = false;
    }
    
    if (elementosUI.btnContinueReto) {
        elementosUI.btnContinueReto.style.display = 'none';
    }
}

/**
 * Notifica al padre que un reto ha finalizado
 * @param {Object} reto - El reto actual
 * @param {string} idTransaccion - ID de transacción para seguimiento
 * @param {boolean} exito - Indica si el reto se completó con éxito
 * @param {boolean} respuestaMostrada - Indica si se mostró la respuesta
 * @returns {Promise<void>}
 */
async function notificarRetoFinalizado(reto, idTransaccion, exito, respuestaMostrada = false) {
    return enviarMensajeAlPadre('reto_finalizado', {
        retoId: reto.id,
        exito,
        respuestaMostrada,
        continuar: true,
        idTransaccion,
        timestamp: new Date().toISOString()
    });
}

/**
 * Muestra un mensaje de error al usuario y lo registra
 * @param {Error|string} error - El error ocurrido o mensaje de error
 * @param {string} contexto - Contexto donde ocurrió el error
 * @param {Object} [datosAdicionales={}] - Datos adicionales para el log
 * @returns {Promise<Error>} El error procesado
 */
async function manejarError(error, contexto, datosAdicionales = {}) {
    // Manejar tanto objetos Error como strings
    const errorObj = typeof error === 'string' ? new Error(error) : error;
    const { retoId, idTransaccion } = datosAdicionales;
    const mensajeError = `[${IFRAME_ID}] Error en ${contexto}: ${errorObj.message}`;
    
    console.error(mensajeError, errorObj);
    
    if (idTransaccion) {
        try {
            await notificarError(`error_${contexto}`.toLowerCase(), {
                retoId,
                idTransaccion,
                mensaje: errorObj.message,
                stack: errorObj.stack,
                ...datosAdicionales,
                timestamp: new Date().toISOString()
            });
        } catch (notifyError) {
            console.error(`[${IFRAME_ID}] Error al notificar error al padre:`, notifyError);
        }
    }
    
    mostrarMensaje(`Ha ocurrido un error al ${contexto}. Por favor, inténtalo de nuevo.`, "error");
    return errorObj;
}

/**
 * Muestra la respuesta correcta al usuario y notifica al padre
 * @param {Object} reto - El reto actual
 * @param {string} idTransaccion - ID de transacción para seguimiento
 */
async function mostrarRespuestaCorrecta(reto, idTransaccion) {
    if (!reto) {
        return manejarError(new Error('reto no definido'), 'mostrar respuesta', { idTransaccion });
    }

    try {
        // Mostrar la respuesta correcta según el tipo de reto
        if (elementosUI.divRespuestaCorrecta) {
            elementosUI.divRespuestaCorrecta.textContent = 
                (reto.tipo === "opcion" || reto.tipo === "opcion-multiple")
                    ? `Respuesta correcta: ${reto.correctas.join(", ")}`
                    : "Puede continuar con la aventura.";
            elementosUI.divRespuestaCorrecta.style.display = "block";
        }

        // Deshabilitar el botón de enviar
        if (elementosUI.btnEnviar) {
            elementosUI.btnEnviar.disabled = true;
        }

        // Configurar el botón de continuar
        const manejarContinuar = async () => {
            try {
                await notificarRetoFinalizado(reto, idTransaccion, false, true);
                limpiarInterfaz();
            } catch (error) {
                await manejarError(error, 'continuar después de mostrar respuesta', { 
                    retoId: reto.id, 
                    idTransaccion 
                });
            }
        };
        
        elementosUI.configurarBotonContinuar(manejarContinuar);
        
        // Notificar al padre que se mostró la respuesta
        await notificarEstado('respuesta_mostrada', {
            retoId: reto.id,
            respuestaCorrecta: reto.correctas,
            idTransaccion,
            timestamp: new Date().toISOString()
        });
        
        console.log(`[${IFRAME_ID}] Respuesta mostrada para el reto:`, { 
            retoId: reto.id,
            idTransaccion 
        });
        
    } catch (error) {
        await manejarError(error, 'mostrar respuesta', { retoId: reto?.id, idTransaccion });
    }
}

// --- MOSTRAR RESPUESTA CORRECTA AL USUARIO ---
btnMostrarRespuesta.addEventListener("click", async () => {
    if (currentRetoIndex === -1 || !estadoApp.controlesHabilitados) {
        console.warn(`[${IFRAME_ID}] No se puede mostrar la respuesta: reto no disponible o controles deshabilitados`);
        return;
    }
    
    const reto = retosAventura1Es[currentRetoIndex];
    const idTransaccion = `mostrar_respuesta_${Date.now()}`;
    
    console.log(`[${IFRAME_ID}] Mostrando respuesta para reto:`, { 
        retoId: reto?.id, 
        idTransaccion 
    });
    
    await mostrarRespuestaCorrecta(reto, idTransaccion);
});

/**
 * Maneja la acción de continuar después de completar un reto
 * @param {Object} reto - El reto actual
 * @param {string} idTransaccion - ID de transacción para seguimiento
 * @param {boolean} [exito=false] - Indica si el reto se completó con éxito
 */
async function manejarContinuarReto(reto, idTransaccion, exito = false) {
    if (!reto) {
        return manejarError(new Error('reto no definido'), 'continuar reto', { idTransaccion, exito });
    }

    try {
        // Ocultar el botón de continuar
        if (elementosUI.btnContinueReto) {
            elementosUI.btnContinueReto.style.display = "none";
        }

        // Notificar al padre que el reto se ha completado
        await notificarRetoFinalizado(reto, idTransaccion, exito, false);

        // Limpiar la interfaz
        limpiarInterfaz();

        // Ocultar el iframe después de un breve retraso
        setTimeout(() => elementosUI.ocultarInterfaz(), 100);

        console.log(`[${IFRAME_ID}] Continuando después del reto:`, { 
            retoId: reto.id,
            exito,
            idTransaccion 
        });

    } catch (error) {
        await manejarError(error, 'continuar reto', { 
            retoId: reto?.id, 
            idTransaccion, 
            exito 
        });
    }
}

// --- BOTÓN CONTINUAR RETO ---
btnContinueReto.addEventListener("click", async () => {
    if (currentRetoIndex === -1 || !estadoApp.controlesHabilitados) {
        console.warn(`[${IFRAME_ID}] No se puede continuar: reto no disponible o controles deshabilitados`);
        return;
    }
    
    const reto = retosAventura1Es[currentRetoIndex];
    const idTransaccion = `continuar_reto_${Date.now()}`;
    
    console.log(`[${IFRAME_ID}] Continuando reto:`, { 
        retoId: reto?.id, 
        idTransaccion 
    });
    
    await manejarContinuarReto(reto, idTransaccion, true);
});

// --- EVENTOS DE BOTONES ---
btnEnviar.addEventListener("click", verificar);

// ================== MANEJADORES DE MENSAJES ==================

// --- CONFIGURAR MANEJADORES DE MENSAJES ---
function configurarManejadoresMensajes() {
    if (!window.Mensajeria || typeof window.Mensajeria.registrarControlador !== 'function') {
        console.error('❌ No se pueden configurar manejadores: Mensajeria no está disponible');
        return;
    }
    
    // Manejar cambio de modo (sistema:cambio_modo)
    window.Mensajeria.registrarControlador(
        window.Mensajeria.TIPOS_MENSAJE.CAMBIO_MODO,
        async (mensaje) => {
            try {
                const { modo, habilitar = true, motivo = 'cambio_modo', forzar = false } = mensaje.datos || {};
                const idTransaccion = mensaje.datos?.idTransaccion || `ext-${Date.now()}`;
                
                console.log(`[${IFRAME_ID}] 🔄 Recibido cambio de modo:`, { 
                    modo, 
                    habilitar, 
                    motivo, 
                    forzar,
                    idTransaccion,
                    origen: mensaje.origen,
                    timestamp: new Date().toISOString()
                });
                
                // Validar que el mensaje tenga los datos necesarios
                if (!modo) {
                    const error = new Error('Mensaje de cambio de modo inválido: falta el parámetro "modo"');
                    error.codigo = 'MENSAJE_INVALIDO';
                    throw error;
                }
                
                // Llamar a la función de manejo de cambio de modo
                const resultado = await manejarCambioModo({
                    ...mensaje,
                    datos: {
                        ...mensaje.datos,
                        idTransaccion,
                        notificarPadre: false // Ya que el mensaje viene del padre
                    }
                });
                
                console.log(`[${IFRAME_ID}] ✅ Cambio de modo completado:`, { 
                    modo, 
                    resultado,
                    idTransaccion,
                    timestamp: new Date().toISOString()
                });
                
                return resultado;
                
            } catch (error) {
                console.error(`[${IFRAME_ID}] ❌ Error al procesar cambio de modo:`, error);
                
                // Notificar al padre del error
                try {
                    await notificarError('error_procesar_cambio_modo', {
                        mensaje: error.message,
                        codigo: error.codigo || 'ERROR_DESCONOCIDO',
                        stack: error.stack,
                        mensajeOriginal: mensaje,
                        timestamp: new Date().toISOString()
                    });
                } catch (notifyError) {
                    console.error(`[${IFRAME_ID}] Error al notificar el error al padre:`, notifyError);
                }
                
                // Relanzar el error para que se propague correctamente
                throw error;
            }
        }
    );
    
    // Manejar controles
    window.Mensajeria.registrarControlador(
        'habilitar_controles',
        (mensaje) => {
            const { modo } = mensaje.datos || {};
            console.log('🔓 HIJO 4: Habilitando controles');
            enableControls(modo || 'casa');
        }
    );

    window.Mensajeria.registrarControlador(
        'deshabilitar_controles',
        (mensaje) => {
            const { motivo } = mensaje.datos || {};
            console.log('🔒 HIJO 4: Deshabilitando controles');
            disableControls(motivo || 'desconocido');
        }
    );
    
    // Manejar solicitud de mostrar reto
    window.Mensajeria.registrarControlador(
        window.Mensajeria.TIPOS_MENSAJE.RETO,
        (mensaje) => {
            const { accion, parametros } = mensaje.datos || {};
            if (accion === 'mostrar' && typeof parametros?.index === 'number') {
                console.log(`🎯 HIJO 4: Mostrando reto ${parametros.index}`);
                // Almacenar el ID del reto actual
                window.retoActual = {
                    id: retosAventura1Es[parametros.index].id,
                    index: parametros.index
                };
                renderizarReto(parametros.index);
            }
        }
    );
    
    // Manejar solicitud de mostrar puzzle
    window.Mensajeria.registrarControlador(
        'PUZZLE.MOSTRAR',
        (mensaje) => {
            const { puzzleId, retoId } = mensaje.datos || {};
            if (puzzleId) {
                console.log(`🧩 HIJO 4: Mostrando puzzle ${puzzleId} del reto ${retoId}`);
                // Almacenar el ID del puzzle actual
                window.puzzleActual = { id: puzzleId, retoId };
                
                // Notificar que el puzzle se mostró
                enviarMensajeAlPadre('puzzle_mostrado', { puzzleId, retoId });
            }
        }
    );
    
    // Manejar notificación de puzzle completado
    window.Mensajeria.registrarControlador(
        'PUZZLE.COMPLETADO',
        (mensaje) => {
            const { puzzleId } = mensaje.datos || {};
            console.log(`✅ HIJO 4: Puzzle ${puzzleId} completado`);
            
            // Notificar al padre que el puzzle se completó
            enviarMensajeAlPadre('puzzle_finalizado', {
                puzzleId,
                exito: true,
                retoId: window.retoActual?.id
            });
            
            // Limpiar referencia al puzzle actual
            delete window.puzzleActual;
        }
    );
}

// ================== INICIALIZACIÓN ==================

// --- INICIALIZAR MENSAJERÍA Y NOTIFICAR AL PADRE ---
window.addEventListener("DOMContentLoaded", async () => {
  try {
    console.log(`[${IFRAME_ID}] DOM cargado, inicializando mensajería...`);
    
    // Inicializar mensajería
    await inicializarMensajeria();
    
    // Configurar manejadores de eventos
    if (typeof configurarManejadoresEventos === 'function') {
      configurarManejadoresEventos();
    }
    
    console.log(`[${IFRAME_ID}] Inicialización completada`);
  } catch (error) {
    console.error(`[${IFRAME_ID}] Error en la inicialización:`, error);
    mostrarErrorInicializacion(error);
  }
    try {
        // Inicializar variables para rastrear el reto/puzzle actual
        window.retoActual = null;
        window.puzzleActual = null;
        
        // Verificar que Mensajeria esté disponible
        if (typeof window.Mensajeria === 'undefined') {
            console.error('❌ No se pudo cargar el módulo de mensajería');
            throw new Error('El módulo de mensajería no está disponible');
        }
        
        // Inicializar mensajería con configuración
        try {
            await window.Mensajeria.inicializarMensajeria({
                iframeId: 'hijo4',
                logLevel: 1, // 0=DEBUG, 1=INFO, 2=WARN, 3=ERROR, 4=NONE
                debug: true,
                dominioPermitido: '*',
                maxRetries: 3,
                retryDelay: 1000
            });
            
            console.log('✅ HIJO 4: Mensajería inicializada correctamente');
        } catch (error) {
            console.error('❌ HIJO 4: Error al inicializar la mensajería:', error);
            throw error; // Relanzar para ser manejado por el catch externo
        }
        
        // Configurar manejadores de mensajes
        configurarManejadoresMensajes();
        console.log('✅ HIJO 4: Manejadores de mensajes configurados');
        
        // Empezar con retos deshabilitados (modo aventura por defecto)
        manejarCambioModo('aventura', false);
        
        // Notificar al padre que el hijo está listo
        try {
            await enviarMensajeAlPadre('sistema_estado', {
                tipo: 'inicializacion_completa',
                estado: 'listo',
                modo: 'aventura',
                controlesHabilitados: false,
                timestamp: Date.now()
            });
            console.log('✅ HIJO 4: Notificación de inicialización enviada al padre');
        } catch (error) {
            console.warn('⚠️ HIJO 4: No se pudo notificar al padre:', error);
            // Continuar a pesar del error de notificación
        }
        
        console.log(`✅ HIJO 4: Inicialización completada - Modo: aventura, Controles: Deshabilitados`);
    } catch (error) {
        console.error('❌ HIJO 4: Error crítico durante la inicialización:', error);
        
        // Asegurarse de que los retos estén deshabilitados en caso de error
        disableControls('error_inicializacion');
        
        // Notificar el error al padre si es posible
        if (window.Mensajeria?.enviarMensaje) {
            try {
                await window.Mensajeria.enviarMensaje(
                    'padre',
                    'sistema_error',
                    {
                        tipo: 'error_inicializacion',
                        mensaje: error.message,
                        stack: process.env.NODE_ENV === 'development' ? error.stack : undefined,
                        timestamp: Date.now()
                    },
                    { maxRetries: 2, retryDelay: 500 }
                );
            } catch (e) {
                console.error('❌ HIJO 4: No se pudo notificar el error al padre:', e);
            }
        }
        
        // Mostrar mensaje de error al usuario
        mostrarErrorInicializacion(error);
    }
});
</script>
</body>
</html>
