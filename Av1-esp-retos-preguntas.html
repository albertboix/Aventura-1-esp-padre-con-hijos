<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retos y Preguntas - Aventura 1</title>
    <script type="module">
        // Standardized import for mensajeria.js
        import { 
            TIPOS_MENSAJE, 
            inicializarMensajeria, 
            enviarMensaje, 
            registrarControlador,
            TIPOS_MENSAJE
        } from './mensajeria.js';
        
        // Initialize notificarError if not already defined
        if (typeof window.notificarError === 'undefined') {
            window.notificarError = function(tipo, error, datosAdicionales = {}) {
                const errorObj = error instanceof Error ? error : new Error(String(error));
                const errorInfo = {
                    tipo,
                    mensaje: errorObj.message,
                    stack: errorObj.stack,
                    ...datosAdicionales,
                    timestamp: new Date().toISOString()
                };
                console.error(`[Retos] Error (${tipo}):`, errorInfo);
                return errorInfo;
            };
        }
        
        // ================== CONFIGURACI√ìN ==================
        // Constantes y variables globales
        const IFRAME_ID = 'retosIframe';
        
        // Configuraci√≥n del componente
        const CONFIG = {
            iframeId: 'hijo4-retos',
            debug: true,
            logLevel: 1,
            REINTENTOS: {
                MAXIMOS: 3,
                TIEMPO_ESPERA: 1000,
                FACTOR: 2
            }
        };
        
        // Hacer notificarError disponible globalmente
        window.notificarError = notificarError;

        // Inicializaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', async () => {
            console.log(`[${CONFIG.iframeId}] DOM cargado, inicializando...`);
            
            try {
                // Configuraci√≥n de mensajer√≠a
                await inicializarMensajeria({
                    iframeId: CONFIG.iframeId,
                    debug: CONFIG.debug,
                    logLevel: CONFIG.logLevel
                });

                // Inicializar el sistema de retos
                await inicializarSistemaRetos();
                
                // Registrar manejadores de mensajes
                registrarManejadores();
                
                console.log(`[${CONFIG.iframeId}] Aplicaci√≥n inicializada correctamente`);
            } catch (error) {
                console.error(`[${CONFIG.iframeId}] Error al inicializar la aplicaci√≥n:`, error);
                await notificarError('inicializacion', error);
            }
        });

        // Estado global de la aplicaci√≥n
        let estadoApp = {
            modo: 'aventura',
            controlesHabilitados: false,
            retoActual: null,
            retosCompletados: [],
            preguntaActual: null,
            respuestasUsuario: {},
            puntoActual: null,
            ultimoError: null,
            
            // ================== ARRAY DE RETOS DE LA AVENTURA 1 ==================
            // Cada objeto representa un reto. El campo 'tipo' puede ser 'opcion', 'opcion-multiple', 'texto' o 'puzzle'.
            // El campo 'correctas' contiene la(s) respuesta(s) correcta(s).
            retosAventura1Es: [
              {
                reto: 1,
                id: "R-1",
                tipo: "opcion",
                pregunta: "1. ¬øCu√°ntas Aventuras pueden hacerse con Valencia be Guides?",
                opciones: ["4", "5", "6", "7"],
                correctas: ["7"],
                multiple: false
              },
              {
                reto: 2,
                id: "R-2",
                tipo: "opcion",
                pregunta: "2. ¬øSabr√≠a decirme c√≥mo se llaman estas Torres?",
                opciones: ["Torres de Quart", "Torres de Serranos", "Torre del Miguelete", "Torre de Santa catalina"],
                correctas: ["Torres de Serranos"],
                multiple: false
              },
              {
                reto: 3,
                id: "R-3",
                tipo: "opcion",
                pregunta: "3. ¬øEn la cumbre de las torres ondea la bandera de Valencia: sus colores se componen de rojo, amarillo y‚Ä¶ ?",
                opciones: ["Violeta", "Verde", "Azul"],
                correctas: ["Azul"],
                multiple: false
              },
              {
                reto: 4,
                id: "R-4",
                tipo: "texto",
                pregunta: "4. ¬øSabr√≠a decirme el nombre de la calle?",
                correctas: ["Calle Muro de Santa Ana"]
              },
              {
                reto: 5,
                id: "R-5",
                tipo: "opcion",
                pregunta: "5. ¬øQu√© porta San Lorenzo en la mano?",
                opciones: ["Una Paloma", "Una cuchara", "Una parrilla"],
                correctas: ["Una parrilla"],
                multiple: false
              },
              {
                reto: 6,
                id: "R-6",
                tipo: "opcion",
                pregunta: "6. ¬øCon qu√© mano sujeta Neptuno la cornucopia?",
                opciones: ["Izquierda", "Derecha"],
                correctas: ["Derecha"],
                multiple: false
              },
              {
                reto: 7,
                id: "R-7",
                tipo: "texto",
                pregunta: "7. ¬øCu√°ntas figuras rodean la fuente?",
                correctas: ["8"]
              },
              {
                reto: 8,
                id: "PZ-8",
                tipo: "puzzle",
                pregunta: "8. Plaza de la Virgen",
                src: "P8_puzzle_plaza_virgen.html"
              },
              {
                reto: 9,
                id: "R-9",
                tipo: "opcion",
                pregunta: "9. ¬øQu√© figura esculpida puede verse en el marco del cuadro?",
                opciones: ["Un Drag√≥n", "Un Murci√©lago", "Una Corona"],
                correctas: ["Una Corona"],
                multiple: false
              },
              {
                reto: 10,
                id: "R-10",
                tipo: "opcion-multiple",
                pregunta: "10. ¬øQu√© puede verse dentro?",
                opciones: ["Un Altar", "Una bandera", "Una espada"],
                correctas: ["Un Altar", "Una bandera"],
                multiple: true
              },
              {
                reto: 11,
                id: "R-11",
                tipo: "texto",
                pregunta: "11. Sobre √©sta hay una placa conmemorativa. ¬øEn qu√© a√±o fue expuesta dicha placa?",
                correctas: ["1952"]
              },
              {
                reto: 12,
                id: "R-12",
                tipo: "texto",
                pregunta: "12. ¬øEn qu√© a√±o se edific√≥ esta finca? ¬°Pista! Mire en la parte superior de la fachada.",
                correctas: ["1906"]
              },
              {
                reto: 13,
                id: "R-13",
                tipo: "opcion",
                pregunta: "13. ¬øQu√© puede verse dentro?",
                opciones: ["Una Plaza de Toros", "Unos ba√±os romanos", "Una estaci√≥n de metro"],
                correctas: ["Unos ba√±os romanos"],
                multiple: false
              },
              {
                reto: 14,
                id: "R-14",
                tipo: "opcion",
                pregunta: "14. ¬øSabr√≠a determinar qu√© geometr√≠a tiene?",
                opciones: ["hexagonal", "Octogonal", "Cuadrangular"],
                correctas: ["hexagonal"],
                multiple: false
              },
              {
                reto: 15,
                id: "R-15",
                tipo: "texto",
                pregunta: "15. ¬øCu√°ntos Arcos componen la puerta?",
                correctas: ["6"]
              },
              {
                reto: 16,
                id: "R-16",
                tipo: "opcion",
                pregunta: "16. ¬øRecuerda qu√© animal corona el escudo municipal?",
                opciones: ["Un Drag√≥n", "Un Murci√©lago", "Un Caballo"],
                correctas: ["Un Murci√©lago"],
                multiple: false
              },
              {
                reto: 17,
                id: "R-17",
                tipo: "opcion",
                pregunta: "17. ¬°Preste atenci√≥n a la fachada de la primera torre! ¬øQu√© Fruta C√≠trica natural de Valencia decora la fachada?",
                opciones: ["Limones", "Pomelos", "Naranjas"],
                correctas: ["Naranjas"],
                multiple: false
              },
              {
                reto: 18,
                id: "PZ-18",
                tipo: "puzzle",
                pregunta: "18. Plaza de Toros y Estaci√≥n del Norte",
                src: "P18_puzzle_plaza_de_Toros_y_estacion_norte.html"
              },
              {
                reto: 19,
                id: "R-19",
                tipo: "texto",
                pregunta: "19. ¬øSabr√≠a decirme qu√© comercio alberga dicho edificio?",
                correctas: ["?"]
              },
              {
                reto: 20,
                id: "R-20",
                tipo: "opcion-multiple",
                pregunta: "20. Sobre la entrada principal, en un arco de medio punto, figuras aleg√≥ricas representan a los cinco continentes. ¬øQu√© porta la figura central en sus manos?",
                opciones: ["Una Corona", "Una Espada", "Una Antorcha"],
                correctas: ["Una Antorcha", "Una Espada"],
                multiple: true
              },
              {
                reto: 21,
                id: "R-21",
                tipo: "opcion",
                pregunta: "21. ¬øQu√© porta la figura en la mano?",
                opciones: ["Una balanza", "Un libro", "Una pluma"],
                correctas: ["Una balanza"],
                multiple: false
              },
              {
                reto: 22,
                id: "R-22",
                tipo: "texto",
                pregunta: "22. ¬øCuantas plantas tiene el edificio?",
                correctas: ["10"]
              },
              {
                reto: 23,
                id: "R-23",
                tipo: "opcion",
                pregunta: "23. Busque la vidriera con los colores de la Se√±era valenciana en la fachada del edificio. ¬øSabr√≠a determinar qu√© forma tiene?",
                opciones: ["Cuadrangular", "Redonda", "Triangular"],
                correctas: ["Redonda"],
                multiple: false
              },
              {
                reto: 24,
                id: "R-24",
                tipo: "opcion-multiple",
                pregunta: "24. ¬øQu√© sostiene la virgen en sus manos?",
                opciones: ["Un Rosario", "Un ni√±o", "Una corona"],
                correctas: ["Un Rosario", "Un ni√±o"],
                multiple: true
              },
              {
                reto: 25,
                id: "R-25",
                tipo: "opcion",
                pregunta: "25. ¬øQu√© le entrega el √°ngel al ni√±o?",
                opciones: ["Una paloma", "Un orbe", "Alimentos"],
                correctas: ["Un orbe"],
                multiple: false
              },
              {
                reto: 26,
                id: "PZ-26",
                tipo: "puzzle",
                pregunta: "26. Lonja de la Seda",
                src: "P26_puzzle_lonja.html"
              },
              {
                reto: 27,
                id: "R-27",
                tipo: "opcion-multiple",
                pregunta: "27. El barquero que rema a contracorriente.",
                opciones: ["Un hombre con rostro triste manejando un peque√±o bote de madera escapa a contracorriente de un monstruo."],
                correctas: ["Un hombre con rostro triste manejando un peque√±o bote de madera escapa a contracorriente de un monstruo."],
                multiple: true
              },
              {
                reto: 28,
                id: "R-28",
                tipo: "opcion-multiple",
                pregunta: "28. Un √°rbol muerto: s√≠mbolo del Pecado, se ve entre las dos hojas de la puerta y cumple la funci√≥n de parteluz.",
                opciones: ["Observe en la copa del √°rbol como 4 hombres desnudos se azotan entre si."],
                correctas: ["Observe en la copa del √°rbol como 4 hombres desnudos se azotan entre si."],
                multiple: true
              },
              {
                reto: 29,
                id: "R-29",
                tipo: "opcion-multiple",
                pregunta: "29. A la derecha, un √°ngel que muestra su pene y...",
                opciones: ["se dispone a introducirlo en un jarr√≥n que sostiene con la otra mano. Algo extra√±o e inusual ¬øno le parece?"],
                correctas: ["se dispone a introducirlo en un jarr√≥n que sostiene con la otra mano. Algo extra√±o e inusual ¬øno le parece?"],
                multiple: true
              },
              {
                reto: 30,
                id: "R-30",
                tipo: "opcion-multiple",
                pregunta: "30. En el centro El barbudo y el le√≥n:",
                opciones: ["Original y contradictoria escena en la cual el manso es precisamente el le√≥n y no el anciano barbudo."],
                correctas: ["Original y contradictoria escena en la cual el manso es precisamente el le√≥n y no el anciano barbudo."],
                multiple: true
              },
              {
                reto: 31,
                id: "R-31",
                tipo: "opcion-multiple",
                pregunta: "31. ¬°Aqu√≠ va un reto extra! ¬°Busque al fornicador de la lonja!",
                opciones: ["En una de sus ventanas, hallar√° a un hombre tallado, no se le advierte su cabeza, pero s√≠ sus genitales, Y muy claramente."],
                correctas: ["En una de sus ventanas, hallar√° a un hombre tallado, no se le advierte su cabeza, pero s√≠ sus genitales, Y muy claramente."],
                multiple: true
              },
              {
                reto: 32,
                id: "R-32",
                tipo: "opcion",
                pregunta: "32. ¬øQu√© sostiene el ni√±o en sus manos?",
                opciones: ["Una paloma", "Una Concha", "Alimentos"],
                correctas: ["Una Concha"],
                multiple: false
              }
            ],
            inicializado: false
        };

        // Variables globales
        let currentRetoIndex = -1;
        let retosDisabled = true;
        let elementoActual = null; // Almacena el elemento actual (parada o tramo)

        // Funci√≥n para habilitar controles
        function habilitarControles(mensaje) {
            estadoApp.controlesHabilitados = true;
            retosDisabled = false;
            document.body.classList.remove ('disabled');
            console.log('[HIJO4] Controles habilitados');
        }
        
        // Funci√≥n para deshabilitar controles
        function deshabilitarControles(mensaje) {
            estadoApp.controlesHabilitados = false;
            retosDisabled = true;
            document.body.classList.add('disabled');
            console.log(`[HIJO4] Controles deshabilitados: ${mensaje?.datos?.motivo || 'sin motivo especificado'}`);
        }
        
        // Funci√≥n para manejar cambios de modo
        function manejarCambioModo(mensaje) {
            if (mensaje.datos && mensaje.datos.modo) {
                estadoApp.modo = mensaje.datos.modo;
                console.log(`[HIJO4] Modo cambiado a: ${estadoApp.modo}`);
            }
        }

        // ================== FUNCIONES DE UTILIDAD ==================
        function mostrarMensaje(mensaje, tipo = 'info', duracion = 3000) {
            console.log(`[${CONFIG.iframeId}] ${tipo.toUpperCase()}: ${mensaje}`);
            
            // Crear elemento de notificaci√≥n si no existe
            let notificacion = document.getElementById('notificacion-mensaje');
            if (!notificacion) {
                notificacion = document.createElement('div');
                notificacion.id = 'notificacion-mensaje';
                notificacion.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 10px 20px;
                    border-radius: 5px;
                    color: white;
                    font-weight: bold;
                    z-index: 10000;
                    transition: opacity 0.3s;
                `;
                document.body.appendChild(notificacion);
            }
            
            // Establecer color seg√∫n tipo
            const colores = {
                info: '#2196F3',
                exito: '#4CAF50',
                error: '#f44336',
                advertencia: '#FF9800'
            };
            
            notificacion.style.backgroundColor = colores[tipo] || colores.info;
            notificacion.textContent = mensaje;
            notificacion.style.opacity = '1';
            
            // Auto-ocultar
            setTimeout(() => {
                if (notificacion) {
                    notificacion.style.opacity = '0';
                    setTimeout(() => {
                        if (notificacion && notificacion.parentNode) {
                            notificacion.parentNode.removeChild(notificacion);
                        }
                    }, 300);
                }
            }, duracion);
        }

        function vibrar() {
            if (navigator.vibrate) {
                navigator.vibrate(300);
            }
        }

        function fuegosArtificiales() {
            const fuegosDiv = document.getElementById('fuegos');
            if (!fuegosDiv) return;
            
            fuegosDiv.style.display = 'block';
            fuegosDiv.innerHTML = `
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                            font-size: 3em; animation: celebration 2s ease-in-out;">
                    üéâ ¬°Correcto! üéâ
                </div>
            `;
            
            setTimeout(() => {
                fuegosDiv.style.display = 'none';
                fuegosDiv.innerHTML = '';
            }, 2000);
        }

        // ================== FUNCIONES DE MENSAJER√çA ==================
        async function enviarMensajeAlPadre(tipo, datos = {}) {
            try {
                await enviarMensaje('padre', tipo, datos);
                console.log(`[${CONFIG.iframeId}] Mensaje enviado al padre:`, { tipo, datos });
            } catch (error) {
                console.error(`[${CONFIG.iframeId}] Error enviando mensaje al padre:`, error);
                throw error; // Relanzar para manejo superior si es necesario
            }
        }

        async function notificarError(tipoError, datos = {}) {
            await enviarMensajeAlPadre('sistema_error', {
                tipo: tipoError,
                componente: 'retos',
                ...datos
            });
        }

        async function notificarEstado(tipo, datos = {}) {
            await enviarMensajeAlPadre('reto_estado', {
                tipo,
                componente: 'retos',
                ...datos
            });
        }

        // ================== FUNCIONES DE CONTROL ==================
        function enableControls(modo = 'casa') {
            console.log(`[${CONFIG.iframeId}] Habilitando controles en modo: ${modo}`);
            
            estadoApp.controlesHabilitados = true;
            estadoApp.modo = modo;
            retosDisabled = false;
            
            // Actualizar interfaz
            document.body.classList.remove('disabled');
            
            const overlay = document.querySelector('.disabled-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function disableControls(motivo = 'desconocido') {
            console.log(`[${CONFIG.iframeId}] Deshabilitando controles. Motivo: ${motivo}`);
            
            estadoApp.controlesHabilitados = false;
            retosDisabled = true;
            
            // Actualizar interfaz
            document.body.classList.add('disabled');
            
            let overlay = document.querySelector('.disabled-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'disabled-overlay';
                overlay.innerHTML = '<div>Controles deshabilitados</div>';
                document.body.appendChild(overlay);
            }
            overlay.style.display = 'flex';
        }

        // ================== FUNCIONES DE MANEJO DE MODO ==================
        async function manejarCambioModo(mensaje) {
            try {
                const { modo, timestamp, motivo = 'cambio_modo' } = mensaje.datos || {};
                
                // Validar modo
                if (modo !== 'casa' && modo !== 'aventura') {
                    throw new Error(`Modo no v√°lido: ${modo}`);
                }

                console.log(`[${CONFIG.iframeId}] Cambiando a modo: ${modo}`, motivo ? `(Motivo: ${motivo})` : '');
                
                const modoAnterior = estadoApp.modo;
                estadoApp.modo = modo;

                // Actualizar controles seg√∫n el modo
                enableControls(modo);

                // Si cambiamos a modo casa, cerrar retos abiertos
                if (modo === 'casa' && estadoApp.retoActual) {
                    cerrarReto();
                }

                // Renderizar el reto actual con el nuevo modo
                if (elementoActual) {
                    renderizarRetoActual();
                }

                // Enviar confirmaci√≥n al padre
                if (enviarMensaje) {
                    await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO_CONFIRMACION, {
                        modo,
                        timestamp,
                        origen: CONFIG.iframeId,
                        exito: true,
                        modoAnterior
                    });
                    
                    // Broadcast del nuevo estado a todos los componentes
                    await enviarMensaje('todos', TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO_ESTADO, {
                        modo,
                        timestamp: Date.now(),
                        origen: CONFIG.iframeId
                    });
                }

                return {
                    estado: 'ok',
                    modoAnterior,
                    modoNuevo: modo,
                    timestamp: Date.now()
                };

            } catch (error) {
                console.error(`[${CONFIG.iframeId}] Error al cambiar modo:`, error);
                
                // Notificar error al padre
                if (enviarMensaje) {
                    await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.ERROR, {
                        tipo: 'cambio_modo',
                        mensaje: error.message,
                        stack: error.stack,
                        origen: CONFIG.iframeId,
                        modo: mensaje.datos?.modo,
                        modoAnterior: estadoApp.modo
                    }).catch(console.error);
                }
                
                // Revertir al modo anterior en caso de error
                if (mensaje.datos?.modo) {
                    estadoApp.modo = mensaje.datos.modo;
                }
                
                return {
                    estado: 'error',
                    error: error.message,
                    modoActual: estadoApp.modo,
                    timestamp: Date.now()
                };
            }
        }

        // ================== INICIALIZACI√ìN ==================
        async function inicializarSistemaRetos() {
            try {
                console.log(`[${CONFIG.iframeId}] Iniciando sistema de retos...`);

                // Inicializar interfaz
                inicializarInterfaz();

                // Marcar como inicializado
                estadoApp.inicializado = true;

                // Notificar al padre que estamos listos
                await enviarMensajeAlPadre('sistema_estado', {
                    tipo: 'inicializacion_completa',
                    estado: 'listo',
                    componente: 'retos',
                    version: '2.0.0',
                    capacidades: ['preguntas', 'validacion', 'progreso']
                });

                console.log(`[${CONFIG.iframeId}] ‚úÖ Sistema de retos inicializado correctamente`);

            } catch (error) {
                console.error(`[${CONFIG.iframeId}] ‚ùå Error en inicializaci√≥n:`, error);
                await notificarError('inicializacion', error);
            }
        }

        // ================== REGISTRO DE MANEJADORES ==================
        // Funci√≥n para actualizar el elemento actual
        function actualizarElementoActual(id) {
            if (id) {
                // Buscar en el array de retos
                let retoIndex = -1;
                
                // Buscar en retos de aventura
                if (estadoApp.modo === 'aventura') {
                    retoIndex = estadoApp.retosAventura1Es.findIndex(reto => reto.id === id);
                    if (retoIndex !== -1) {
                        elementoActual = estadoApp.retosAventura1Es[retoIndex];
                        return true;
                    }
                } 
                // Buscar en retos de casa
                else if (estadoApp.modo === 'casa') {
                    retoIndex = estadoApp.retosCasa1Es.findIndex(reto => reto.id === id);
                    if (retoIndex !== -1) {
                        elementoActual = estadoApp.retosCasa1Es[retoIndex];
                        return true;
                    }
                }
                
                console.warn(`[${CONFIG.iframeId}] No se encontr√≥ un reto con ID:`, id);
                return false;
            } else {
                elementoActual = null;
                return false;
            }
        }
        
        function registrarManejadores() {
            // Manejador de cambio de elemento de navegaci√≥n
            registrarControlador('NAVEGACION.CAMBIO_ELEMENTO', (mensaje) => {
                const { id } = mensaje.datos || {};
                if (id) {
                    const encontrado = actualizarElementoActual(id);
                    if (encontrado && estadoApp.modo === 'aventura' && estadoApp.controlesHabilitados) {
                        // Mostrar el reto correspondiente si est√° en modo aventura
                        const retoIndex = estadoApp.retosAventura1Es.findIndex(r => r.id === id);
                        if (retoIndex !== -1) {
                            renderizarReto(retoIndex);
                        }
                    }
                }
            });
            
            // Manejador de cambio de modo estandarizado
            registrarControlador(TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, manejarCambioModo);
            
            // Sincronizar estado de modo al inicio
            registrarControlador(TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO_ESTADO, async (mensaje) => {
                if (mensaje.origen !== CONFIG.iframeId && mensaje.datos?.modo !== estadoApp.modo) {
                    console.log(`[${CONFIG.iframeId}] Sincronizando modo: ${mensaje.datos.modo} desde ${mensaje.origen}`);
                    await manejarCambioModo(mensaje);
                }
            });

            // Manejador de controles
            registrarControlador(TIPOS_MENSAJE.UI.HABILITAR_CONTROLES, (mensaje) => {
                const { modo } = mensaje.datos || {};
                enableControls(modo || 'casa');
            });

            registrarControlador(TIPOS_MENSAJE.UI.DESHABILITAR_CONTROLES, (mensaje) => {
                const { motivo } = mensaje.datos || {};
                disableControls(motivo || 'desconocido');
            });

            // Manejador de retos
            registrarControlador('mostrar_reto', (mensaje) => {
                const { index } = mensaje.datos || {};
                if (typeof index === 'number') {
                    renderizarReto(index);
                }
            });

            console.log(`[${CONFIG.iframeId}] Manejadores de mensajes registrados`);
        }

        // ================== FUNCIONES DE INTERFAZ ==================
        function inicializarInterfaz() {
            // Crear elementos necesarios del DOM
            if (!document.getElementById('reto-contenido')) {
                const container = document.createElement('div');
                container.id = 'reto-contenido';
                container.className = 'reto-contenido';
                document.body.appendChild(container);
            }

            if (!document.getElementById('button-container')) {
                const buttonContainer = document.createElement('div');
                buttonContainer.id = 'button-container';
                buttonContainer.className = 'button-container';
                
                // Crear botones
                const btnEnviar = document.createElement('button');
                btnEnviar.id = 'btnEnviar';
                btnEnviar.className = 'btn';
                btnEnviar.textContent = 'Enviar';
                btnEnviar.addEventListener('click', verificar);
                
                const btnMostrarRespuesta = document.createElement('button');
                btnMostrarRespuesta.id = 'btnMostrarRespuesta';
                btnMostrarRespuesta.className = 'btn';
                btnMostrarRespuesta.textContent = 'Mostrar Respuesta';
                btnMostrarRespuesta.style.display = 'none';
                btnMostrarRespuesta.addEventListener('click', mostrarRespuesta);
                
                const btnContinuar = document.createElement('button');
                btnContinuar.id = 'btnContinueReto';
                btnContinuar.className = 'btn';
                btnContinuar.textContent = 'Continuar';
                btnContinuar.style.display = 'none';
                btnContinuar.addEventListener('click', continuarReto);
                
                buttonContainer.appendChild(btnEnviar);
                buttonContainer.appendChild(btnMostrarRespuesta);
                buttonContainer.appendChild(btnContinuar);
                document.body.appendChild(buttonContainer);
            }

            if (!document.getElementById('respuestaCorrectaTexto')) {
                const respuestaDiv = document.createElement('div');
                respuestaDiv.id = 'respuestaCorrectaTexto';
                respuestaDiv.style.display = 'none';
                document.body.appendChild(respuestaDiv);
            }

            if (!document.getElementById('fuegos')) {
                const fuegosDiv = document.createElement('div');
                fuegosDiv.id = 'fuegos';
                fuegosDiv.style.display = 'none';
                document.body.appendChild(fuegosDiv);
            }

            console.log(`[${CONFIG.iframeId}] Interfaz inicializada`);
        }

        // ================== FUNCIONES DE RETOS ==================
        function renderizarReto(retoIndex) {
            if (retosDisabled) {
                console.log('üö´ No se puede renderizar reto - retos deshabilitados');
                return;
            }
            
            currentRetoIndex = retoIndex;
            const reto = retosAventura1Es[currentRetoIndex];
            if (!reto) {
                console.error("Reto no encontrado para el √≠ndice:", retoIndex);
                return;
            }

            const retoContenidoDiv = document.getElementById('reto-contenido');
            const btnEnviar = document.getElementById('btnEnviar');
            const btnMostrarRespuesta = document.getElementById('btnMostrarRespuesta');
            const btnContinuar = document.getElementById('btnContinueReto');
            const respuestaDiv = document.getElementById('respuestaCorrectaTexto');
            const fuegosDiv = document.getElementById('fuegos');

            // Limpiar interfaz
            retoContenidoDiv.innerHTML = '';
            btnEnviar.style.display = "inline-block";
            btnEnviar.disabled = false;
            btnMostrarRespuesta.style.display = "none";
            btnContinuar.style.display = "none";
            respuestaDiv.style.display = "none";
            respuestaDiv.textContent = "";
            fuegosDiv.innerHTML = "";
            fuegosDiv.style.display = "none";

            // Crear pregunta
            const preguntaElem = document.createElement("h3");
            preguntaElem.textContent = reto.pregunta;
            retoContenidoDiv.appendChild(preguntaElem);

            if (reto.tipo === "opcion" || reto.tipo === "opcion-multiple") {
                const opcionesContainer = document.createElement("div");
                opcionesContainer.className = "opciones-container";
                const inputType = reto.multiple ? "checkbox" : "radio";
                
                reto.opciones.forEach((opcion, i) => {
                    const divOpcion = document.createElement("div");
                    divOpcion.className = "respuesta";
                    
                    const input = document.createElement("input");
                    input.type = inputType;
                    input.name = "op";
                    input.value = opcion;
                    input.id = "opcion" + i;
                    divOpcion.appendChild(input);
                    
                    const label = document.createElement("label");
                    label.htmlFor = input.id;
                    label.textContent = opcion;
                    divOpcion.appendChild(label);
                    
                    opcionesContainer.appendChild(divOpcion);
                });
                retoContenidoDiv.appendChild(opcionesContainer);
            } else if (reto.tipo === "texto") {
                const inputTexto = document.createElement("input");
                inputTexto.type = "text";
                inputTexto.id = "respuestaTexto";
                inputTexto.placeholder = "Escriba su respuesta aqu√≠...";
                retoContenidoDiv.appendChild(inputTexto);
                setTimeout(() => inputTexto.focus(), 200);
            }

            estadoApp.retoActual = reto;
            console.log(`üß© Reto ${retoIndex + 1} renderizado`);
        }

        async function verificar() {
            const reto = retosAventura1Es[currentRetoIndex];
            if (!reto) {
                mostrarMensaje('No hay un reto actual para verificar', 'error');
                return;
            }

            // Obtener respuesta del usuario
            const opciones = document.querySelectorAll('input[type="radio"]:checked, input[type="checkbox"]:checked');
            const inputTexto = document.getElementById("respuestaTexto");
            let respuestaUsuario = [];

            if (opciones.length > 0) {
                opciones.forEach((opcion) => {
                    respuestaUsuario.push(opcion.value);
                });
            } else if (inputTexto && inputTexto.value.trim() !== '') {
                respuestaUsuario.push(inputTexto.value.trim());
            } else {
                mostrarMensaje("Por favor, selecciona una opci√≥n o escribe tu respuesta.", "error");
                return;
            }

            // Verificar respuesta
            const esCorrecta = reto.correctas.some((correcta) =>
                respuestaUsuario.some((respuesta) => respuesta.toLowerCase() === correcta.toLowerCase())
            );

            if (esCorrecta) {
                await manejarRespuestaCorrecta(reto);
            } else {
                await manejarRespuestaIncorrecta(reto);
            }
        }

        async function manejarRespuestaCorrecta(reto) {
            mostrarMensaje("¬°Respuesta correcta!", "exito");
            fuegosArtificiales();
            
            const btnEnviar = document.getElementById("btnEnviar");
            const btnContinuar = document.getElementById("btnContinueReto");
            
            if (btnEnviar) btnEnviar.disabled = true;
            if (btnContinuar) {
                btnContinuar.style.display = "inline-block";
                btnContinuar.disabled = false;
            }

            await enviarMensajeAlPadre('reto_completado', {
                retoId: reto.id,
                exito: true,
                puntos: reto.puntos || 10
            });
        }

        async function manejarRespuestaIncorrecta(reto) {
            vibrar();
            mostrarMensaje("Respuesta incorrecta. Int√©ntalo de nuevo.", "error");
            
            const btnMostrarRespuesta = document.getElementById("btnMostrarRespuesta");
            if (btnMostrarRespuesta) {
                btnMostrarRespuesta.style.display = "inline-block";
            }

            await notificarEstado('reto_fallido', { retoId: reto.id });
        }

        function mostrarRespuesta() {
            const reto = retosAventura1Es[currentRetoIndex];
            if (!reto) return;

            const respuestaDiv = document.getElementById('respuestaCorrectaTexto');
            const btnEnviar = document.getElementById("btnEnviar");
            const btnContinuar = document.getElementById("btnContinueReto");

            if (respuestaDiv) {
                respuestaDiv.textContent = `Respuesta correcta: ${reto.correctas.join(", ")}`;
                respuestaDiv.style.display = "block";
            }

            if (btnEnviar) btnEnviar.disabled = true;
            if (btnContinuar) {
                btnContinuar.style.display = "inline-block";
                btnContinuar.disabled = false;
            }
        }

        function continuarReto() {
            const reto = retosAventura1Es[currentRetoIndex];
            if (!reto) return;

            // Limpiar interfaz
            const retoContenidoDiv = document.getElementById('reto-contenido');
            if (retoContenidoDiv) retoContenidoDiv.innerHTML = '';

            const btnContinuar = document.getElementById("btnContinueReto");
            if (btnContinuar) btnContinuar.style.display = "none";

            // Notificar al padre
            enviarMensajeAlPadre('reto_finalizado', {
                retoId: reto.id,
                continuar: true
            });

            console.log(`Continuando despu√©s del reto: ${reto.id}`);
        }

        function cerrarReto() {
            if (!estadoApp.retoActual) return;

            const retoId = estadoApp.retoActual.id;
            estadoApp.retoActual = null;
            currentRetoIndex = -1;

            // Limpiar interfaz
            const retoContenidoDiv = document.getElementById('reto-contenido');
            if (retoContenidoDiv) retoContenidoDiv.innerHTML = '';

            enviarMensajeAlPadre('reto_cerrado', { retoId });
            console.log(`Reto cerrado: ${retoId}`);
        }

        // ================== FUNCIONES GLOBALES ==================
        window.enableControls = enableControls;
        window.disableControls = disableControls;
        window.renderizarReto = renderizarReto;
        window.verificar = verificar;
        window.mostrarRespuesta = mostrarRespuesta;
        window.continuarReto = continuarReto;

        // ================== INICIALIZACI√ìN AL CARGAR DOM ==================
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log(`[${CONFIG.iframeId}] DOM cargado, inicializando...`);
                
                // Inicializar mensajer√≠a
                await inicializarMensajeria();
                
                // Empezar con controles deshabilitados
                disableControls('inicializacion');
                
                console.log(`[${CONFIG.iframeId}] ‚úÖ Inicializaci√≥n completada`);
                
            } catch (error) {
                console.error(`[${CONFIG.iframeId}] ‚ùå Error en inicializaci√≥n:`, error);
                mostrarMensaje('Error al inicializar el sistema de retos', 'error');
            }
        });

    </script>
    <style>
        /* --- ESTILOS B√ÅSICOS Y DEL IFRAME DE RETOS --- */
        :root {
            --borde-reto: 1px;
        }
        body {
            font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif;
            margin: 0;
            background: #fff;
            color: #222;
            font-size: 16px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            padding: var(--borde-reto);
            width: calc(100vw - 2 * var(--borde-reto));
            height: calc(100vh - 2 * var(--borde-reto));
        }
        body.disabled {
            pointer-events: none;
            opacity: 0.6;
            user-select: none;
        }
        .disabled-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(128, 128, 128, 0.3);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: #666;
            text-align: center;
        }
        body.disabled .disabled-overlay {
            display: flex;
        }
        .reto-contenido, .button-container, #respuestaCorrectaTexto, #fuegos {
            box-sizing: border-box;
            width: 100%;
        }
        h3 {
            margin-top: 0;
            margin-bottom: 0.8em;
            font-size: 1.5em;
            text-align: center;
            width: 100%;
        }
        .opciones-container {
            width: 100%;
            max-width: 600px;
            text-align: left;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .respuesta {
            margin: 0.4em 0;
            font-size: 1.3em;
            display: flex;
            align-items: center;
        }
        .respuesta input[type="radio"],
        .respuesta input[type="checkbox"] {
            margin-right: 0.7em;
            transform: scale(1.3);
            cursor: pointer;
        }
        .respuesta input[type="text"] {
            flex-grow: 1;
            font-size: 1.3em;
            padding: 0.3em 0.5em;
            border-radius: 4px;
            border: 1px solid #999;
            width: calc(100% - 1.4em);
        }
        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1em;
            margin-top: 1.5em;
            justify-content: center;
            width: 100%;
            min-height: 40px;
        }
        button.btn {
            padding: 0.6em 1.2em;
            font-size: 1.1em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background-color: #0077cc;
            color: white;
            user-select: none;
            transition: background-color 0.3s ease;
        }
        button.btn:hover {
            background-color: #005699;
        }
        button.btn:disabled {
            background-color: #999;
            cursor: not-allowed;
        }
        #btnMostrarRespuesta {
            background-color: #28a745;
            display: none;
        }
        #btnMostrarRespuesta:hover {
            background-color: #1e7e34;
        }
        #respuestaCorrectaTexto {
            margin-top: 1em;
            font-weight: bold;
            text-align: center;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 0.8em 1em;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 1.2em;
            color: #222;
            z-index: 20;
            display: none;
            box-sizing: border-box;
        }
        #fuegos {
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            overflow: hidden;
            display: none;
        }
        @keyframes celebration {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        @media (max-width: 600px) {
            h3 { font-size: 1.3em; }
            .respuesta { font-size: 1.1em; }
            button.btn { font-size: 1em; padding: 0.5em 1em; }
            #respuestaCorrectaTexto { font-size: 1.1em; }
        }
    </style>
</head>
<body>
    <div class="disabled-overlay">
        <div>Controles deshabilitados</div>
    </div>
</body>
</html>
        /* Animaciones */
        @keyframes celebration {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            h3 { font-size: 1.3em; }
            .respuesta { font-size: 1.1em; }
            button.btn { font-size: 1em; padding: 0.5em 1em; }
            #respuestaCorrectaTexto { font-size: 1.1em; }
        }
    </style>
</head>
<body>
    <div class="disabled-overlay">
        <div>Controles deshabilitados</div>
    </div>
</body>
</html>
    </style>
</head>
<body>
    <div class="disabled-overlay">
        <div>Controles deshabilitados</div>
    </div>
</body>
</html>
        
