<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Detección de parada por coordenadas (Modo GPS OFF)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 1em; position: relative; min-height: 100vh; }
    #estado { margin: 1em 0; font-weight: bold; }
    #listaParadas { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; border: 1px solid #ccc; border-radius: 5px; }
    #listaParadas li { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; transition: background-color 0.3s; }
    #listaParadas li:hover { background-color: #f0f0f0; }
    #btnMapa { margin: 1em 0; padding: 8px 16px; cursor: pointer; background-color: #007bff; border: none; border-radius: 4px; color: white; font-size: 1em; }
    #map { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000; display: none; }
    #map.leaflet-container { width: 100%; height: 100%; }
    #cerrarMapa { position: absolute; top: 10px; right: 10px; z-index: 1100; background: rgba(255,255,255,0.9); border: none; padding: 6px 12px; font-weight: bold; cursor: pointer; border-radius: 4px; }
    #modoGps { margin-bottom: 1em; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
</head>
<body>
  <h1>Detección de parada</h1>
  <label id="modoGps"><input type="checkbox" id="gpsSwitch" checked /> GPS ON</label>
  <p id="estado">Esperando ubicación…</p>
  <button id="btnMapa">Mostrar mapa</button>
  <ul id="listaParadas" aria-label="Lista de paradas"></ul>
  <div id="map">
    <button id="cerrarMapa">Cerrar mapa ✕</button>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // --- Datos de paradas con idAudio y retoIndex ---
    const paradas = [
      { tipo: "parada", nombre: "Torres de Serranos (start)", lat: 39.47876, lng: -0.37626, idAudio: "audio_serranos_intro", retoIndex: 1 },
      { tipo: "parada", nombre: "Puente de Serranos – Plaza de la crida", lat: 39.47959, lng: -0.37583, idAudio: "audio_puente_serranos", retoIndex: 2 }
      // ...añade aquí el resto de paradas con sus idAudio y retoIndex...
    ];

    // --- Renderiza la lista de paradas ---
    const lista = document.getElementById('listaParadas');
    paradas.forEach((parada, i) => {
      if (!parada.nombre) return;
      const li = document.createElement('li');
      li.textContent = parada.nombre;
      li.tabIndex = 0;
      li.setAttribute('role', 'button');
      li.addEventListener('click', () => {
        document.getElementById('estado').textContent = `Parada seleccionada: ${parada.nombre}`;
        // Si GPS está OFF, simula llegada a la parada
        if (!document.getElementById('gpsSwitch').checked) {
          window.parent.postMessage({
            tipo: "gps_marcar_parada",
            parada: parada.nombre,
            coords: { lat: parada.lat, lng: parada.lng },
            idAudio: parada.idAudio,
            retoIndex: parada.retoIndex
          }, "*");
        }
      });
      li.addEventListener('keypress', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          li.click();
        }
      });
      lista.appendChild(li);
    });

    // --- GPS ON/OFF ---
    const gpsSwitch = document.getElementById('gpsSwitch');
    gpsSwitch.addEventListener('change', () => {
      if (gpsSwitch.checked) {
        document.getElementById('estado').textContent = "Esperando ubicación…";
        iniciarGeolocalizacion();
      } else {
        document.getElementById('estado').textContent = "GPS OFF. Selecciona una parada para simular.";
        if (geoWatchId !== null) {
          navigator.geolocation.clearWatch(geoWatchId);
          geoWatchId = null;
        }
      }
    });

    // --- Geolocalización real ---
    let geoWatchId = null;
    function iniciarGeolocalizacion() {
      if (navigator.geolocation) {
        geoWatchId = navigator.geolocation.watchPosition(detectarParada, error, {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 5000,
        });
      } else {
        document.getElementById("estado").textContent = "Geolocalización no soportada por este navegador.";
      }
    }

    function getDistanceMeters(lat1, lng1, lat2, lng2) {
      const R = 6371000;
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function detectarParada(pos) {
      const { latitude, longitude } = pos.coords;
      for (const parada of paradas) {
        const dist = getDistanceMeters(latitude, longitude, parada.lat, parada.lng);
        if (dist < 15) {
          document.getElementById("estado").textContent =
            `Estás en: ${parada.nombre} (${Math.round(dist)} m)`;
          window.parent.postMessage({
            tipo: "gps_marcar_parada",
            parada: parada.nombre,
            coords: { lat: parada.lat, lng: parada.lng },
            idAudio: parada.idAudio,
            retoIndex: parada.retoIndex
          }, "*");
          return;
        }
      }
      document.getElementById("estado").textContent =
        `No estás cerca de ninguna parada (${latitude.toFixed(5)}, ${longitude.toFixed(5)})`;
    }

    function error(err) {
      document.getElementById("estado").textContent = "Error obteniendo ubicación: " + err.message;
    }

    // --- Iniciar geolocalización si GPS ON ---
    if (gpsSwitch.checked) iniciarGeolocalizacion();

    // --- MAPA LEAFLET ---
    const btnMapa = document.getElementById('btnMapa');
    const mapDiv = document.getElementById('map');
    const cerrarMapaBtn = document.getElementById('cerrarMapa');
    let map;
    let markers = [];

    btnMapa.addEventListener('click', () => {
      if (!map) {
        map = L.map('map').setView([paradas[0].lat, paradas[0].lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        paradas.forEach(parada => {
          const marker = L.marker([parada.lat, parada.lng]).addTo(map);
          marker.bindPopup(parada.nombre);
          markers.push(marker);
        });
      }
      mapDiv.style.display = 'block';
      map.invalidateSize();
    });

    cerrarMapaBtn.addEventListener('click', () => {
      mapDiv.style.display = 'none';
    });

    // --- Enviar coordenadas al padre al cargar ---
    window.addEventListener("load", () => {
      const puntos = paradas.map(({nombre, lat, lng}) => ({ nombre, lat, lng }));
      window.parent.postMessage({ tipo: "coordenadas", puntos }, "*");
    });
  </script>
</body>
</html>
