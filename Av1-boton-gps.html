<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GPS y Paradas Unificado</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: 'Book Antiqua', 'Palatino Linotype', 'Palatino', Georgia, serif;
    }
    .trapezoid-float {
      position: fixed;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      width: 370px;
      max-width: 98vw;
      height: 370px;
      background: linear-gradient(90deg, #007aff 0%, #00c6ff 100%);
      clip-path: polygon(8% 0%, 92% 0%, 100% 100%, 0% 100%);
      border-radius: 22px 22px 18px 18px/30px 30px 18px 18px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.18);
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 9999;
      padding: 0 0 18px 0;
      justify-content: flex-end;
    }
    .iconos-row {
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      width: 100%;
      margin-top: 18px;
      margin-bottom: 0;
      gap: 0.5em;
    }
    .icon-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(90deg, #007aff 0%, #00c6ff 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 2.7em;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.13);
      transition: background 0.2s;
      position: relative;
      margin: 0 8px;
      color: #bbb;
    }
    .icon-btn.active-on {
      color: #34c759;
    }
    .icon-btn.active-off {
      color: #e53935;
    }
    .icon-btn .icon-label {
      font-size: 1.1em;
      font-weight: bold;
      margin-top: 2px;
      letter-spacing: 1px;
      text-align: center;
      color: #bbb;
      transition: color 0.2s;
    }
    .icon-btn.active-on .icon-label {
      color: #34c759;
    }
    .icon-btn.active-off .icon-label {
      color: #e53935;
    }
    .icon-btn .fa-house {
      font-size: 1.5em;
      margin-bottom: 2px;
    }
    .icon-btn .fa-camera {
      font-size: 1.2em;
      margin-bottom: 0;
    }
    .icon-btn .fa-arrow-right {
      font-size: 1em;
      margin-left: 2px;
      color: #fff;
      filter: drop-shadow(0 1px 2px #007aff);
    }
    .paradas-list {
      display: none;
      flex-direction: column;
      align-items: center;
      width: 95%;
      max-height: 220px;
      overflow-y: auto;
      background: rgba(255,255,255,0.95);
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin: 10px auto 0 auto;
      padding: 6px 0;
      z-index: 10000;
      position: relative;
    }
    .parada-block {
      width: 98%;
      margin: 4px auto 8px auto;
      background: #f5f5f5;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 6px 8px 8px 8px;
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      position: relative;
    }
    .parada-header {
      display: flex;
      align-items: center;
      font-size: 1em;
      margin-bottom: 2px;
      width: 100%;
    }
    .parada-num {
      font-weight: bold;
      margin-right: 8px;
      color: #007aff;
    }
    .foto-row {
      display: flex;
      align-items: center;
      width: 100%;
      margin-top: 2px;
      gap: 6px;
    }
    .foto-row input {
      flex: 1 1 auto;
      font-size: 0.98em;
      padding: 3px 7px;
      border-radius: 5px;
      border: 1px solid #aaa;
    }
    .foto-btn {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(90deg, #007aff 0%, #00c6ff 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.13);
      color: #fff;
      margin-left: 2px;
      transition: background 0.2s;
    }
    .foto-btn:active {
      background: linear-gradient(90deg, #005699 0%, #00aaff 100%);
    }
    @media (max-width: 500px) {
      .trapezoid-float { width: 99vw; min-width: 0; }
      .icon-btn { width: 60px; height: 60px; font-size: 1.5em; }
      .paradas-list { max-height: 120px; }
      .foto-row input { font-size: 0.9em; }
    }
  </style>
</head>
<body>
  <div class="trapezoid-float" id="trapezoidFloat">
    <div class="iconos-row">
      <!-- Casa ON -->
      <button id="btnGpsOn" class="icon-btn" title="GPS ON">
        <i class="fa-solid fa-house"></i>
        <span class="icon-label">ON</span>
      </button>
      <!-- Casa OFF -->
      <button id="btnGpsOff" class="icon-btn" title="GPS OFF">
        <i class="fa-solid fa-house"></i>
        <span class="icon-label">OFF</span>
      </button>
    </div>
    <div class="paradas-list" id="paradasList"></div>
  </div>
  <script>
    // Paradas y waypoints (waypoints no tienen nombre ni srcFoto)
    const paradas = [
      { tipo: "parada", nombre: "Torres de Serranos (start)", lat: 39.47876, lng: -0.37626, idAudio: "audio_serranos_intro", srcFoto: "fotos_Av1/00_torres_de_serranos_back.jpg" },
      { tipo: "waypoint", lat: 39.47905, lng: -0.37613 },
      { tipo: "waypoint", lat: 39.47933, lng: -0.37647 },
      { tipo: "waypoint", lat: 39.47943, lng: -0.37636 },
      { tipo: "parada", nombre: "Puente de Serranos – Plaza de la crida", lat: 39.47959, lng: -0.37583, idAudio: "audio_puente_serranos", srcFoto: "fotos_Av1/01_puente_de_serranos.jpg" },
      { tipo: "waypoint", lat: 39.47939, lng: -0.3752 },
      { tipo: "waypoint", lat: 39.47902, lng: -0.37465 },
      { tipo: "waypoint", lat: 39.47866, lng: -0.3747 },
      { tipo: "parada", nombre: "Cortes Valencianas (Palacio de los Borgia)", lat: 39.47785, lng: -0.37485, idAudio: "audio_cortes_valencianas", srcFoto: "fotos_Av1/02_cortes_valencianas.jpg" },
      { tipo: "waypoint", lat: 39.47768, lng: -0.3749 },
      { tipo: "parada", nombre: "Plaza de la Virgen", lat: 39.47656, lng: -0.37529, idAudio: "audio_plaza_virgen", srcFoto: "fotos_Av1/03_plaza_virgen.jpg" },
      { tipo: "waypoint", lat: 39.4766, lng: -0.37473 },
      { tipo: "waypoint", lat: 39.47656, lng: -0.37453 },
      { tipo: "waypoint", lat: 39.47606, lng: -0.3746 },
      { tipo: "parada", nombre: "Plaza de la Almoína", lat: 39.47604, lng: -0.37451, idAudio: "audio_plaza_almoina", srcFoto: "fotos_Av1/04_plaza_almoina.jpg" },
      { tipo: "parada", nombre: "Catedral de València", lat: 39.47594, lng: -0.37474, idAudio: "audio_catedral", srcFoto: "fotos_Av1/05_catedral.jpg" },
      { tipo: "parada", nombre: "Plaza decimo Juno Bruto (Museo Arqueológico de la Almoína)", lat: 39.4762, lng: -0.37412, idAudio: "audio_juno_bruto", srcFoto: "fotos_Av1/06_juno_bruto.jpg" },
      { tipo: "parada", nombre: "Basílica de València", lat: 39.47611, lng: -0.37478, idAudio: "audio_basilica", srcFoto: "fotos_Av1/07_basilica.jpg" },
      { tipo: "waypoint", lat: 39.47603, lng: -0.37433 },
      { tipo: "parada", nombre: "Palacio Arzobispal", lat: 39.4755, lng: -0.37436, idAudio: "audio_palacio_arzobispal", srcFoto: "fotos_Av1/08_palacio_arzobispal.jpg" },
      { tipo: "waypoint", lat: 39.4756, lng: -0.37466 },
      { tipo: "waypoint", lat: 39.47514, lng: -0.37494 },
      { tipo: "waypoint", lat: 39.47447, lng: -0.3754 },
      { tipo: "waypoint", lat: 39.47378, lng: -0.3756 },
      { tipo: "waypoint", lat: 39.47212, lng: -0.37676 },
      { tipo: "parada", nombre: "Plaza del Ayuntamiento", lat: 39.47056, lng: -0.37677, idAudio: "audio_plaza_ayuntamiento", srcFoto: "fotos_Av1/09_plaza_ayuntamiento.jpg" },
      { tipo: "parada", nombre: "Edificio del Ayuntamiento de València", lat: 39.46971, lng: -0.37693, idAudio: "audio_edificio_ayuntamiento", srcFoto: "fotos_Av1/10_edificio_ayuntamiento.jpg" },
      { tipo: "waypoint", lat: 39.46795, lng: -0.37701 },
      { tipo: "parada", nombre: "Estación de Ferrocarril (Estación del Norte)", lat: 39.46722, lng: -0.37702, idAudio: "audio_estacion_norte", srcFoto: "fotos_Av1/11_estacion_norte.jpg" },
      { tipo: "parada", nombre: "Plaza de Toros de València", lat: 39.46709, lng: -0.37595, idAudio: "audio_plaza_toros", srcFoto: "fotos_Av1/12_plaza_toros.jpg" },
      { tipo: "waypoint", lat: 39.46714, lng: -0.37498 },
      { tipo: "parada", nombre: "Casa estilo Árabe", lat: 39.46753, lng: -0.37511, idAudio: "audio_casa_arabe", srcFoto: "fotos_Av1/13_casa_arabe.jpg" },
      { tipo: "parada", nombre: "Palacio de Comunicaciones (Correos)", lat: 39.46942, lng: -0.37559, idAudio: "audio_correos", srcFoto: "fotos_Av1/14_correos.jpg" },
      { tipo: "waypoint", lat: 39.4699, lng: -0.37573 },
      { tipo: "waypoint", lat: 39.4703, lng: -0.3759 },
      { tipo: "waypoint", lat: 39.47039, lng: -0.37505 },
      { tipo: "waypoint", lat: 39.47043, lng: -0.37427 },
      { tipo: "parada", nombre: "Antigua sede del Banco de València", lat: 39.47061, lng: -0.37408, idAudio: "audio_banco_valencia", srcFoto: "fotos_Av1/15_banco_valencia.jpg" },
      { tipo: "waypoint", lat: 39.47119, lng: -0.37423 },
      { tipo: "waypoint", lat: 39.47214, lng: -0.37446 },
      { tipo: "waypoint", lat: 39.47275, lng: -0.37445 },
      { tipo: "parada", nombre: "Palacio del Marqués de Dos Aguas (Museo Nacional de Crámica)", lat: 39.47276, lng: -0.37467, idAudio: "audio_dos_aguas", srcFoto: "fotos_Av1/16_dos_aguas.jpg" },
      { tipo: "waypoint", lat: 39.47315, lng: -0.37608 },
      { tipo: "waypoint", lat: 39.47261, lng: -0.37654 },
      { tipo: "waypoint", lat: 39.47225, lng: -0.37686 },
      { tipo: "waypoint", lat: 39.47265, lng: -0.37725 },
      { tipo: "parada", nombre: "Mercado Central", lat: 39.47377, lng: -0.37832, idAudio: "audio_mercado_central", srcFoto: "fotos_Av1/17_mercado_central.jpg" },
      { tipo: "parada", nombre: "San Juan del Mercado (Iglesia de los Santos Juanes)", lat: 39.47425, lng: -0.37895, idAudio: "audio_san_juan", srcFoto: "fotos_Av1/18_san_juan.jpg" },
      { tipo: "parada", nombre: "Lonja de València (Mercado de la Seda)", lat: 39.47426, lng: -0.37862, idAudio: "audio_lonja", srcFoto: "fotos_Av1/19_lonja.jpg" },
      { tipo: "waypoint", lat: 39.47445, lng: -0.37889 },
      { tipo: "waypoint", lat: 39.47459, lng: -0.37868 },
      { tipo: "waypoint", lat: 39.47475, lng: -0.37842 },
      { tipo: "waypoint", lat: 39.47436, lng: -0.37799 },
      { tipo: "parada", nombre: "Plaza del Doctor Collado", lat: 39.47444, lng: -0.3779, idAudio: "audio_doctor_collado", srcFoto: "fotos_Av1/20_doctor_collado.jpg" },
      { tipo: "waypoint", lat: 39.47473, lng: -0.37763 },
      { tipo: "waypoint", lat: 39.47493, lng: -0.37761 },
      { tipo: "waypoint", lat: 39.47559, lng: -0.37772 },
      { tipo: "parada", nombre: "Plaza del Negrito (Fuente del Negrito)", lat: 39.47611, lng: -0.37741, idAudio: "audio_negrito", srcFoto: "fotos_Av1/21_negrito.jpg" },
      { tipo: "parada", nombre: "Calle Caballeros", lat: 39.47663, lng: -0.3773, idAudio: "audio_caballeros", srcFoto: "fotos_Av1/22_caballeros.jpg" },
      { tipo: "waypoint", lat: 39.47661, lng: -0.37685 },
      { tipo: "parada", nombre: "Palacio de la Generalitat", lat: 39.47668, lng: -0.37671, idAudio: "audio_generalitat", srcFoto: "fotos_Av1/23_generalitat.jpg" },
      { tipo: "waypoint", lat: 39.47661, lng: -0.37685 },
      { tipo: "waypoint", lat: 39.47687, lng: -0.37686 },
      { tipo: "parada", nombre: "Calle de los Serranos (end)", lat: 39.47773, lng: -0.37671, idAudio: "audio_calle_serranos_end", srcFoto: "fotos_Av1/24_calle_serranos_end.jpg" }
    ];

    // --- Estado ---
    let gpsActivo = true;
    let watchId = null;

    // --- Elementos ---
    const btnGpsOn = document.getElementById('btnGpsOn');
    const btnGpsOff = document.getElementById('btnGpsOff');
    const paradasList = document.getElementById('paradasList');

    // --- Inicialización de botones ---
    function actualizarBotones() {
      if (gpsActivo) {
        btnGpsOn.classList.add('active-on');
        btnGpsOff.classList.remove('active-off');
        paradasList.style.display = 'none';
      } else {
        btnGpsOn.classList.remove('active-on');
        btnGpsOff.classList.add('active-off');
        paradasList.style.display = 'flex';
      }
    }

    btnGpsOn.addEventListener('click', () => {
      if (!gpsActivo) {
        gpsActivo = true;
        actualizarBotones();
        iniciarGPS();
      }
    });
    btnGpsOff.addEventListener('click', () => {
      if (gpsActivo) {
        gpsActivo = false;
        actualizarBotones();
        detenerGPS();
      }
    });

    // --- Paradas manuales (solo las de tipo parada) ---
    let paradaNum = 1;
    paradas.forEach((p, idx) => {
      if (p.tipo === "parada") {
        const paradaBlock = document.createElement('div');
        paradaBlock.className = 'parada-block';

        // Cabecera con número y nombre
        const header = document.createElement('div');
        header.className = 'parada-header';
        header.innerHTML = `<span class="parada-num">Parada ${paradaNum}:</span> ${p.nombre}`;
        paradaBlock.appendChild(header);

        // Fila de input SRC y botón cámara+flecha
        const fotoRow = document.createElement('div');
        fotoRow.className = 'foto-row';

        const input = document.createElement('input');
        input.type = 'text';
        input.value = p.srcFoto || "";
        input.placeholder = 'SRC de la foto...';

        const btnFoto = document.createElement('button');
        btnFoto.className = 'foto-btn';
        btnFoto.title = 'Enviar foto de esta parada';
        btnFoto.innerHTML = '<i class="fa-solid fa-camera"></i><i class="fa-solid fa-arrow-right"></i>';

        btnFoto.addEventListener('click', () => {
          window.parent.postMessage({
            tipo: 'muestra_foto',
            parada: paradaNum,
            src: input.value.trim()
          }, '*');
        });

        fotoRow.appendChild(input);
        fotoRow.appendChild(btnFoto);
        paradaBlock.appendChild(fotoRow);

        // Al hacer click en la cabecera, marcar parada
        header.addEventListener('click', () => {
          if (!gpsActivo) {
            marcarParada(p);
          }
        });

        paradasList.appendChild(paradaBlock);
        paradaNum++;
      }
    });

    // --- GPS real ---
    function iniciarGPS() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
      }
      if (navigator.geolocation) {
        watchId = navigator.geolocation.watchPosition(detectarParada, errorGPS, {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 5000,
        });
      }
    }
    function detenerGPS() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
    }
    function getDistanceMeters(lat1, lng1, lat2, lng2) {
      const R = 6371000;
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }
    function detectarParada(pos) {
      const { latitude, longitude } = pos.coords;
      let paradaCercana = null;
      let minDist = 999999;
      let paradaNumGps = 1;
      for (let i = 0; i < paradas.length; i++) {
        const parada = paradas[i];
        if (parada.tipo === "parada") {
          const dist = getDistanceMeters(latitude, longitude, parada.lat, parada.lng);
          if (dist < 30 && dist < minDist) {
            paradaCercana = parada;
            minDist = dist;
          }
          paradaNumGps++;
        }
      }
      if (paradaCercana) {
        marcarParada(paradaCercana);
      }
      // Enviar la polyline de la ruta (todos los puntos, incluidos waypoints)
      window.parent.postMessage({ tipo: 'gps_ruta', waypoints: paradas.map(p => ({lat:p.lat, lng:p.lng})) }, '*');
    }
    function errorGPS(err) {
      window.parent.postMessage({ tipo: 'gps_error', mensaje: err.message }, '*');
    }

    // --- Marcar parada (enviar al padre) ---
    function marcarParada(parada) {
      window.parent.postMessage({
        tipo: 'gps_marcar_parada',
        parada: parada.nombre,
        coords: { lat: parada.lat, lng: parada.lng },
        idAudio: parada.idAudio
      }, '*');
    }

    // --- Inicialización ---
    actualizarBotones();
    if (gpsActivo) iniciarGPS();

    // --- Limpieza al cerrar ventana ---
    window.addEventListener('beforeunload', () => {
      detenerGPS();
    });
  </script>
</body>
</html>
