<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Av1-boton-gps</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: transparent;
      user-select: none;
      overflow: hidden;
    }
    #boton-gps {
      position: fixed;
      top: 10px;
      left: 10px;
      max-width: 22vw; /* Más ancho */
      max-height: 70vh;
      overflow-y: auto;
      background: white;
      border: 1px solid #ccc;
      padding: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 9999;
      border-radius: 6px;
      display: block;
    }
    #minimizado-icono {
      position: fixed;
      top: 10px;
      left: 10px;
      width: 40px;
      height: 40px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10000;
    }
    #minimizado-icono svg {
      width: 24px;
      height: 24px;
      fill: #444;
    }
    .minimizar-btn {
      float: right;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #555;
      padding: 0 5px;
    }
    #cabecera {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    /* Mensaje GPS ON/OFF en columna */
    #gps-estado-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-left: 8px;
    }
    #gps-label {
      font-size: 1.1rem;
      font-weight: bold;
      color: #222;
      margin-bottom: 2px;
      letter-spacing: 1px;
    }
    #estado.on {
      color: #e53935;
      font-weight: bold;
      font-size: 1.2rem;
    }
    #estado.off {
      color: #43a047;
      font-weight: bold;
      font-size: 1.2rem;
    }
    #icono-casa.on svg {
      fill: #e53935;
    }
    #icono-casa.off svg {
      fill: #43a047;
    }
    #coords {
      display: flex;
      flex-direction: column;
      gap: 4px;
      background: white;
      padding: 0;
      margin-bottom: 8px;
    }
    #paradas {
      display: none;
      flex-direction: column;
      gap: 4px;
      background: white;
      max-height: 30vh;
      overflow-y: auto;
      margin-top: 8px;
      padding: 0;
    }
    .parada-btn {
      width: 100%;
      background: #f5f5f5;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      text-align: left;
      font-size: 1rem;
      transition: background 0.2s;
    }
    .parada-btn:hover {
      background: #e0e0e0;
    }
  </style>
</head>
<body>
  <div id="minimizado-icono" title="Mostrar GPS">
    <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
  </div>
  <div id="boton-gps" role="button" tabindex="0" aria-pressed="true" aria-label="Activar simulación GPS">
    <button class="minimizar-btn" title="Minimizar GPS">−</button>
    <div id="cabecera">
      <div id="icono-casa" class="on" aria-hidden="true">
        <svg viewBox="0 0 24 24" focusable="false">
          <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
        </svg>
      </div>
      <div id="gps-estado-container">
        <span id="gps-label">GPS</span>
        <span id="estado" class="on">ON</span>
      </div>
    </div>
    <div id="coords">
      <label>Latitud:
        <input type="number" step="0.000001" id="lat" value="39.478046" aria-label="Latitud de simulación" />
      </label>
      <label>Longitud:
        <input type="number" step="0.000001" id="lng" value="-0.375515" aria-label="Longitud de simulación" />
      </label>
    </div>
    <div id="paradas"></div>
  </div>
  <script>
    function inicializarGPS() {
      const boton = document.getElementById('boton-gps');
      const estadoElem = document.getElementById('estado');
      const iconoCasa = document.getElementById('icono-casa');
      const coordsDiv = document.getElementById('coords');
      const latInput = document.getElementById('lat');
      const lngInput = document.getElementById('lng');
      const paradasDiv = document.getElementById('paradas');
      const minimizarBtn = document.querySelector('.minimizar-btn');
      const minimizadoIcono = document.getElementById('minimizado-icono');

      const paradas = [
        { nombre: "Torres de Serranos", lat: 39.4795, lng: -0.3757 },
        { nombre: "Puente de Serranos – Plaza de la crida", lat: 39.4782, lng: -0.3750 },
        { nombre: "Cortes Valencianas (Palacio de los Borgia)", lat: 39.4788, lng: -0.3744 },
        { nombre: "Plaza de la Virgen", lat: 39.4781, lng: -0.3766 },
        { nombre: "Plaza de la Almoína", lat: 39.4777, lng: -0.3758 },
        { nombre: "Catedral de València", lat: 39.4776, lng: -0.3753 },
        { nombre: "Plaza decimo Juno Bruto", lat: 39.4771, lng: -0.3749 },
        { nombre: "Basílica de València", lat: 39.4780, lng: -0.3754 },
        { nombre: "Palacio Arzobispal", lat: 39.4775, lng: -0.3756 },
        { nombre: "Plaza del Ayuntamiento", lat: 39.4698, lng: -0.3763 },
        { nombre: "Edificio del Ayuntamiento de València", lat: 39.4695, lng: -0.3762 },
        { nombre: "Estación de Ferrocarril (Estación del Norte)", lat: 39.4655, lng: -0.3770 },
        { nombre: "Plaza de Toros de València", lat: 39.4652, lng: -0.3767 },
        { nombre: "Casa estilo Árabe", lat: 39.4672, lng: -0.3759 },
        { nombre: "Palacio de Comunicaciones (Correos)", lat: 39.4693, lng: -0.3761 },
        { nombre: "Antigua sede del Banco de València", lat: 39.4691, lng: -0.3760 },
        { nombre: "Palacio del Marqués de Dos Aguas", lat: 39.4703, lng: -0.3747 },
        { nombre: "Mercado Central", lat: 39.4741, lng: -0.3780 },
        { nombre: "San Juan del Mercado", lat: 39.4739, lng: -0.3776 },
        { nombre: "Lonja de València", lat: 39.4742, lng: -0.3772 },
        { nombre: "Plaza del Doctor Collado", lat: 39.4740, lng: -0.3768 },
        { nombre: "Plaza del Negrito", lat: 39.4760, lng: -0.3755 },
        { nombre: "Calle Caballeros", lat: 39.4768, lng: -0.3751 },
        { nombre: "Palacio de la Generalitat", lat: 39.4784, lng: -0.3752 }
      ];

      let gpsActivo = true;

      function enviarMensaje(paradaNombre = null) {
        const lat = parseFloat(latInput.value);
        const lng = parseFloat(lngInput.value);
        window.parent.postMessage({
          tipo: 'gps_modo',
          activo: gpsActivo,
          coords: { lat, lng },
          parada: paradaNombre || null
        }, '*');
      }

      function marcarParada(parada) {
        // Solo enviar si GPS está en OFF
        if (!gpsActivo) {
          window.parent.postMessage({
            tipo: 'gps_marcar_parada',
            parada: parada.nombre,
            coords: { lat: parada.lat, lng: parada.lng }
          }, '*');
        }
      }

      function actualizarVisual() {
        if (gpsActivo) {
          estadoElem.textContent = 'ON';
          estadoElem.classList.add('on');
          estadoElem.classList.remove('off');
          iconoCasa.classList.add('on');
          iconoCasa.classList.remove('off');
          boton.setAttribute('aria-pressed', 'true');
          coordsDiv.style.display = 'none';
          paradasDiv.style.display = 'none';
        } else {
          estadoElem.textContent = 'OFF';
          estadoElem.classList.remove('on');
          estadoElem.classList.add('off');
          iconoCasa.classList.remove('on');
          iconoCasa.classList.add('off');
          boton.setAttribute('aria-pressed', 'false');
          coordsDiv.style.display = 'flex';
          paradasDiv.style.display = 'flex';
        }
      }

      // Cambia entre ON/OFF solo al hacer click en la cabecera (no al cambiar coordenadas ni paradas)
      boton.addEventListener('click', (e) => {
        // Solo cambiar si el click es en la cabecera o fuera de los inputs/paradas
        if (
          e.target === boton ||
          e.target === document.getElementById('cabecera') ||
          e.target === document.getElementById('icono-casa') ||
          e.target === document.getElementById('gps-label') ||
          e.target === estadoElem
        ) {
          gpsActivo = !gpsActivo;
          actualizarVisual();
          enviarMensaje();
        }
      });

      latInput.addEventListener('change', () => {
        if (!gpsActivo) {
          enviarMensaje();
        }
      });

      lngInput.addEventListener('change', () => {
        if (!gpsActivo) {
          enviarMensaje();
        }
      });

      boton.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          // Solo cambiar ON/OFF si el foco está en la cabecera
          if (document.activeElement === boton) {
            gpsActivo = !gpsActivo;
            actualizarVisual();
            enviarMensaje();
          }
        }
      });

      window.addEventListener('message', (e) => {
        if (e.data.tipo === 'solicitar-estado-gps') {
          enviarMensaje();
        }
      });

      window.parent.postMessage({ tipo: 'boton-gps-listo' }, '*');

      // Añadir paradas como botones en columna
      paradas.forEach((p) => {
        const btn = document.createElement('button');
        btn.className = 'parada-btn';
        btn.textContent = p.nombre;
        btn.addEventListener('click', (ev) => {
          latInput.value = p.lat;
          lngInput.value = p.lng;
          enviarMensaje(p.nombre);
          marcarParada(p);
          // NO cambiar gpsActivo aquí, se mantiene en OFF
        });
        paradasDiv.appendChild(btn);
      });

      minimizarBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        boton.style.display = 'none';
        minimizadoIcono.style.display = 'flex';
      });

      minimizadoIcono.addEventListener('click', () => {
        boton.style.display = 'block';
        minimizadoIcono.style.display = 'none';
      });

      actualizarVisual();
      enviarMensaje();
    }

    window.addEventListener('load', inicializarGPS);
  </script>
</body>
</html>
