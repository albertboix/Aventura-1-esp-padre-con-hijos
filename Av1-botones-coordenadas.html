<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Av1-botones-coordenadas-(hijo2)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --btn-size: 60px;
            --icon-size: 1.3em;
            --progress-thick: 12px;
            --trapecio-width: 280px;
            --trapecio-height: 180px; /* Aumentado para acomodar los nuevos botones */
            --trapecio-bg: white;
            --trapecio-shadow: 0 2px 10px rgba(0,0,0,0.15);
            --trapecio-radius: 12px;
            --progress-color: #0077cc;
            --progress-bg: #e0e0e0;
            --timer-font-size: 1.0em;
            --timer-color: #333;
        }

        /* Encapsular estilos */
        .hijo2-container body, .hijo2-container html {
            height: 100%;
            margin: 0;
            padding: 0;
            background: transparent !important;
            font-family: Arial, sans-serif;
        }

        /* Contenedor principal con forma trapezoidal */
        .container {
            width: var(--trapecio-width);
            height: var(--trapecio-height);
            background: var(--trapecio-bg);
            border-radius: var(--trapecio-radius);
            box-shadow: var(--trapecio-shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            gap: 0.2em;
            z-index: 1200;
            padding: 5px 8px;
            box-sizing: border-box;
            border: none;
            margin: 0 auto;
        }

        .botones-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            width: 100%;
        }

        .boton {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            padding: 0;
        }

        .boton.activo {
            background: linear-gradient(135deg, #007bff, #0056b3);
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .boton:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .boton:active {
            transform: scale(0.95);
        }

        .boton.disabled {
            background: linear-gradient(135deg, #6c757d, #495057);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .boton.disabled:hover {
            transform: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        /* Control individual del tama√±o de iconos */
        .icon-gps {
            font-size: 1.2em;
        }

        .icon-imagen {
            font-size: 1.1em;
        }

        .icon-video {
            font-size: 1.1em;
        }

        /* Estilos para los nuevos botones */
        .icon-ubicacion {
            font-size: 1.2em;
            transform: rotate(180deg); /* Girar el emoji 180 grados */
            display: inline-block;
        }

        .icon-mapa-completo {
            font-size: 1.2em;
        }

        .icon-mapa-jpg {
            font-size: 1.2em;
        }

        .status {
            width: 100%;
            text-align: center;
            font-size: 0.9em;
            padding: 5px 0;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.7);
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-height: 24px;
        }

        .gps-icon {
            animation: pulse 1.5s infinite;
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        /* Media queries para m√≥viles */
        @media (max-width: 500px) {
            .container {
                width: calc(var(--trapecio-width) * 0.9);
                height: calc(var(--trapecio-height) * 0.9);
            }
            .boton {
                width: calc(var(--btn-size) * 0.9);
                height: calc(var(--btn-size) * 0.9);
            }
            .status {
                font-size: 0.8em;
            }
        }

        /* Mantenemos algunos estilos originales para compatibilidad */
        body.controles-deshabilitados .container {
            opacity: 0.7;
            pointer-events: none;
        }

        /* Estilos para el cambio de modo - Simplificados */
        .modo-aventura #btn-gps.activo {
            animation: pulse 1.5s infinite;
        }

        /* Estilos del Modal para imagen/video */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 90%;
            max-height: 90%;
            position: relative;
            overflow: hidden;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            color: #333;
            cursor: pointer;
            background: #f1f1f1;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .modal-title {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #333;
        }
        .media-container img, .media-container video {
            max-width: 100%;
            max-height: 70vh;
            display: block;
            margin: 0 auto;
            border-radius: 5px;
        }

        /* Estilo para la l√≠nea de ruta */
        .ruta-polyline {
            stroke: #0077ff;
            stroke-width: 6px;
            stroke-opacity: 0.8;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Estilo para el bot√≥n de ubicaci√≥n actual con texto */
        .ubicacion-btn {
            font-size: 0.65em;
            text-align: center;
            line-height: 1.1;
            padding: 2px;
            white-space: nowrap;
            overflow: hidden;
            font-weight: bold;
        }

        /* Ajustar altura del contenedor para acomodar 6 botones */
        .container {
            height: 200px;
        }

        /* Estilos para el estado del GPS */
        .gps-activo {
            background-color: #d4edda;
            color: #155724;
        }
        
        .gps-inactivo {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body class="modo-casa hijo2-container">
    <div class="container">
        <div class="botones-row">
            <!-- Bot√≥n GPS con √≠cono de sat√©lite -->
            <button id="btn-gps" class="boton" title="Mostrar coordenadas GPS">
                <i class="fas fa-satellite-dish icon-gps"></i>
            </button>
            
            <!-- Bot√≥n para mostrar imagen -->
            <button id="btn-imagen" class="boton" title="Mostrar imagen de la parada">
                <i class="fas fa-image icon-imagen"></i>
            </button>
            
            <!-- Bot√≥n para mostrar video -->
            <button id="btn-video" class="boton" title="Mostrar video del recorrido">
                <i class="fas fa-video icon-video"></i>
            </button>
        </div>

        <!-- Nueva fila de botones -->
        <div class="botones-row">
            <!-- Bot√≥n para ubicaci√≥n actual del usuario - Mantener emoji de gota de sangre girado 180¬∞ -->
            <button id="btn-ubicacion" class="boton" title="Mostrar ruta a la siguiente parada">
                <span class="icon-ubicacion">ü©∏</span>
            </button>
            
            <!-- Bot√≥n para mapa completo -->
            <button id="btn-mapa-completo" class="boton" title="Ver mapa completo">
                <span class="icon-mapa-completo">üó∫Ô∏è</span>
            </button>
            
            <!-- Bot√≥n para mapa en JPG -->
            <button id="btn-mapa-jpg" class="boton" title="Ver mapa en imagen JPG">
                <span class="icon-mapa-jpg">üì∑</span>
            </button>
        </div>

        <div class="status" id="status">Esperando activaci√≥n...</div>
    </div>

    <div id="modal-medios" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h3 class="modal-title">Imagen de la parada</h3>
            <div class="media-container">
                <!-- Contenido din√°mico: imagen o video -->
            </div>
        </div>
    </div>

    <script type="module">
        // =================================================================================
        // 1. IMPORTACIONES Y CONFIGURACI√ìN
        // =================================================================================
        import { 
        inicializarMensajeria, 
        registrarControlador, 
        enviarMensaje 
    } from './js/mensajeria.js';
    import { TIPOS_MENSAJE } from './js/constants.js';
    import { modoHandler } from './js/modo-handler.js';
    import logger from './js/logger.js';
    
    const COMPONENTE_ID = 'BOTONES-COORDENADAS';
    const IFRAME_ID = 'coordenadas-iframe'; // Debe coincidir con el ID del iframe en el padre
    
    // ================== COORDENADAS DE LAS PARADAS ==================
    // Mover a scope global para que sea accesible en todo el m√≥dulo
    const COORDENADAS_PARADAS = [
    {
        id: 'P-0',
        tipo: "inicio",
        parada: 0, // ‚Üê Parada 0 ‚Äì INICIO (223, 226, 228, 229) reto 2 //
        nombre: "Torres de Serranos (start)",
        coordenadas: { lat: 39.47876, lng: -0.37626 },
        imagen: 'fotos_Av1/00_torres_de_serranos_back.jpg',
        video: 'videos/parada_0.mp4',
    },
    {
        id: 'TR-1',
        tipo: "tramo",
        tramo: 1, // ‚Üê tramo 1 (Torres de Serranos ‚Üí Plaza de la crida) (2, 126,) //
        nombre: "Torres de Serranos ‚Üí Plaza de la crida (Puente de Serranos)",
        inicio: { lat: 39.47876, lng: -0.37626 },
        waypoints: [
            { lat: 39.47905, lng: -0.37613 },
            { lat: 39.47933, lng: -0.37647 },
            { lat: 39.47943, lng: -0.37636 }
        ],
        fin: { lat: 39.47959, lng: -0.37583 },
        imagen: 'fotos_Av1/01_torres_de_serranos_front.jpg',
        video: 'videos/tramo_1.mp4',
    },
    {
        id: 'P-1',
        tipo: "parada",
        parada: 1, // ‚Üê Parada 1 - Plaza de la crida (Puente de Serranos) (233) Reto 3 //
        nombre: "Plaza de la crida (Puente de Serranos)",
        coordenadas: { lat: 39.47959, lng: -0.37583 },
        imagen: 'fotos_Av1/01_torres_de_serranos_front.jpg',
    },
    {
        id: 'TR-2',
        tipo: "tramo",
        tramo: 2, // ‚Üê tramo 2 (Plaza de la crida ‚Üí Calle Muro de Santa Ana) (81) //
        nombre: "Plaza de la crida ‚Üí Calle Muro de Santa Ana",
        inicio: { lat: 39.47959, lng: -0.37583 },
        waypoints: [
            { lat: 39.47939, lng: -0.3752 },
            { lat: 39.47902, lng: -0.37465 },
            { lat: 39.47866, lng: -0.3747 }
        ],
        fin: { lat: 39.47866, lng: -0.3747 },
        imagen: 'muro de Santa ana.jpg',
        video: 'videos/tramo 2_2.mp4',
    },
    {
        id: 'P-2',
        tipo: "parada",
        parada: 2, // ‚Üê Parada 2 (Calle Muro de Santa Ana) (68) Reto 4 //
        nombre: "Calle Muro de Santa Ana",
        coordenadas: { lat: 39.47866, lng: -0.3747 },
        imagen: 'muro de Santa ana.jpg',
    },
    {
        id: 'TR-3',
        tipo: "tramo",
        tramo: 3, // ‚Üê tramo 3 (Calle Muro de Santa Ana ‚Üí Palacio de los Borgia) (52) //
        nombre: "Calle Muro de Santa Ana ‚Üí Palacio de los Borgia",
        inicio: { lat: 39.47866, lng: -0.3747 },
        waypoints: [],
        fin: { lat: 39.47768, lng: -0.3749 },
        imagen: 'fotos_Av1/02_cortes_valencianas.jpg',
        video: 'videos/tramo_3.mp4',
    },
    {
        id: 'P-3',
        tipo: "parada",
        parada: 3, // ‚Üê Parada 3 (Iglesia de San Lorenzo) (686, 682-B, 462, 683, 684) Reto 5 //
        nombre: "Iglesia de San Lorenzo",
        coordenadas: { lat: 39.47768, lng: -0.3749 },
        imagen: 'fotos_Av1/03_iglesia_de_san_lorenzo.jpg',
    },
    {
        id: 'TR-4',
        tipo: "tramo",
        tramo: 4, // ‚Üê tramo 4 (Iglesia de San Lorenzo ‚Üí Plaza de la Virgen) (465-B) //
        nombre: "Iglesia de San Lorenzo ‚Üí Plaza de la Virgen",
        inicio: { lat: 39.47768, lng: -0.3749 },
        waypoints: [],
        fin: { lat: 39.47656, lng: -0.37529 },
        imagen: 'fotos_Av1/04_plaza_de_la_virgen.jpg',
        video: 'videos/tramo_4.mp4',
    },
    {
        id: 'P-4',
        tipo: "parada",
        parada: 4, // ‚Üê Parada 4 (Plaza de la Virgen) (466, 467) Reto 6 //
        nombre: "Plaza de la Virgen Reto 6",
        coordenadas: { lat: 39.47656, lng: -0.37529 },
        imagen: 'fotos_Av1/04_plaza_de_la_virgen.jpg',
    },
    {
        id: 'P-5',
        tipo: "parada",
        parada: 5, // ‚Üê Parada 5 (Plaza de la Virgen) (468) Reto 7, 8 Puzzle plaza de la virgen //
        nombre: "Plaza de la Virgen Reto 7",
        coordenadas: { lat: 39.47656, lng: -0.37529 },
        imagen: 'fotos_Av1/04_plaza_de_la_virgen.jpg',
    },
    {
        id: 'TR-5',
        tipo: "tramo",
        tramo: 5, // ‚Üê tramo 5 (Plaza de la Virgen ‚Üí Plaza de la Almo√≠na) (477-B, 479, 141, 83, 8-C) //
        nombre: "Plaza de la Virgen ‚Üí Plaza de la Almo√≠na",
        inicio: { lat: 39.47656, lng: -0.37529 },
        waypoints: [
            { lat: 39.4766, lng: -0.37473 },
            { lat: 39.47656, lng: -0.37453 },
            { lat: 39.47606, lng: -0.3746 }
        ],
        fin: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/05_plaza_de_la_almoina.jpg',
        video: 'videos/tramo_5.mp4',
    },
    {
        id: 'P-6',
        tipo: "parada",
        parada: 6, // ‚Üê Parada 6 (Panel cer√°mico muro Catedral) (434, 440, 441, 442) Reto 9 //
        nombre: "Panel cer√°mico muro Catedral",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/06_panel_ceramico_muro_norte_catedral.jpg',
    },
    {
        id: 'P-7',
        tipo: "parada",
        parada: 7, // ‚Üê Parada 7 (Capilla exterior catedral) (443, 444, 445) Reto 10 //
        nombre: "Capilla exterior catedral Reto 10",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/07!!!_capilla_exterior_catedral.jpg',
    },
    {
        id: 'P-8',
        tipo: "parada",
        parada: 8, // ‚Üê Parada 8 (Capilla exterior catedral) (445) Reto 11 //
        nombre: "Capilla exterior catedral Reto 11",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/07!!!_capilla_exterior_catedral.jpg',
    },
    {
        id: 'P-9',
        tipo: "parada",
        parada: 9, // ‚Üê Parada 9 (Arco Novo Catedral y Puerta Negra Bas√≠lica) (446, 355, 447, 11-B, 451, 452) //
        nombre: "Arco Novo Catedral y Puerta Negra Bas√≠lica",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/08_arco_novo_catedral.jpg',
        imagen2: 'fotos_Av1/09_puerta_negra_relieve_basilica.jpg',
    },
    // PARADA 10
    {
        id: 'P-10',
        tipo: "parada",
        parada: 10,
        nombre: "Casa del Punt de Gantxo",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/10_casa_del_punt_de_gantxo.jpg',
    },
    {
        id: 'TR-6',
        tipo: "tramo",
        tramo: 6, // ‚Üê tramo 6 (Plaza de la Almo√≠na ‚Üí Plaza Decimo Junio Bruto) (457, 10-B) //
        nombre: "Plaza de la Almo√≠na ‚Üí Plaza Decimo Junio Bruto (Museo Arqueol√≥gico de la Almo√≠na)",
        inicio: { lat: 39.47594, lng: -0.37474 },
        waypoints: [],
        fin: { lat: 39.4762, lng: -0.37412 },
        imagen: 'fotos_Av1/05_plaza_de_la_almoina.jpg',
        video: 'videos/tramo_6.mp4',
    },
    {
        id: 'P-11',
        tipo: "parada",
        parada: 11, // ‚Üê Parada 11 (Museo arqueol√≥gico La Almo√≠na) (458) Reto 13 //
        nombre: "Museo arqueol√≥gico La Almo√≠na",
        coordenadas: { lat: 39.4762, lng: -0.37412 },
        imagen: 'fotos_Av1/27_museo_la_almoina.jpg',
    },
    {
        id: 'P-12',
        tipo: "parada",
        parada: 12, // ‚Üê Parada 12 (Museo arqueol√≥gico La Almo√≠na) (459, 460, 461) //
        nombre: "Museo arqueol√≥gico La Almo√≠na",
        coordenadas: { lat: 39.4762, lng: -0.37412 },
        imagen: 'fotos_Av1/27_museo_la_almoina.jpg',
    },
    {
        id: 'P-13',
        tipo: "parada",
        parada: 13, // ‚Üê Parada 13 (Vista de la Catedral, Cimborrio) (8-C, 464) Reto14 //
        nombre: "Vista de la Catedral, Cimborrio",
        coordenadas: { lat: 39.4762, lng: -0.37412 },
        imagen: 'fotos_Av1/05_plaza_de_la_almoina.jpg',
    },
    {
        id: 'TR-7',
        tipo: "tramo",
        tramo: 7, // ‚Üê tramo 7 (Museo arqueol√≥gico La Almo√≠na ‚Üí Palacio Arzobispal) (85) //
        nombre: "Museo arqueol√≥gico La Almo√≠na ‚Üí Palacio Arzobispal",
        inicio: { lat: 39.47611, lng: -0.37478 },
        waypoints: [
            { lat: 39.47604, lng: -0.37442 },
            { lat: 39.47584, lng: -0.37443 },
            { lat: 39.47561, lng: -0.37451 }
        ],
        fin: { lat: 39.4755, lng: -0.37436 },
        imagen: 'fotos_Av1/11_palacio_arzobispal.jpg',
        video: 'videos/parada_8.mp4',
    },
    {
        id: 'P-14',
        tipo: "parada",
        parada: 14, // ‚Üê Parada 14 (Palacio Arzobispal y Puerta Rom√°nica de la Catedral) (673, 86, 426-B, 141, 437, 438) Reto 15 //
        nombre: "Palacio Arzobispal y Puerta Rom√°nica de la Catedral",
        coordenadas: { lat: 39.4755, lng: -0.37436 },
        imagen: 'fotos_Av1/12_puerta_romanica_catedral.jpg',
    },
    {
        id: 'P-15',
        tipo: "parada",
        parada: 15, // ‚Üê Parada 15 (Puerta Rom√°nica de la Catedral) (439) //
        nombre: "Puerta Rom√°nica de la Catedral",
        coordenadas: { lat: 39.47561, lng: -0.37465 },
        imagen: 'fotos_Av1/12_puerta_romanica_catedral.jpg',
    },
    {
        id: 'TR-8',
        tipo: "tramo",
        tramo: 8, // ‚Üê tramo 8 (Puerta Rom√°nica de la Catedral ‚Üí Plaza del Ayuntamiento) (125) //
        nombre: "Puerta Rom√°nica de la Catedral ‚Üí Plaza del Ayuntamiento",
        inicio: { lat: 39.47561, lng: -0.37465 },
        waypoints: [
            { lat: 39.4756, lng: -0.37466 },
            { lat: 39.47514, lng: -0.37494 },
            { lat: 39.47447, lng: -0.3754 },
            { lat: 39.47378, lng: -0.3756 },
            { lat: 39.47212, lng: -0.37676 }
        ],
        fin: { lat: 39.47056, lng: -0.37677 },
        imagen: 'fotos_Av1/13_plaza_del_ayuntamiento.jpg',
        video: 'videos/tramo_8.mp4',
    },
    {
        id: 'P-16',
        tipo: "parada",
        parada: 16, // ‚Üê Parada 16 (Plaza del Ayuntamiento) (13-B, 263, 332, 14-C) //
        nombre: "Plaza del Ayuntamiento",
        coordenadas: { lat: 39.47056, lng: -0.37677 },
        imagen: 'fotos_Av1/13_plaza_del_ayuntamiento.jpg',
    },
    {
        id: 'TR-9',
        tipo: "tramo",
        tramo: 9, // ‚Üê tramo 9 (Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento) (334, 335) //
        nombre: "Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento de Val√®ncia",
        inicio: { lat: 39.47056, lng: -0.37677 },
        waypoints: [],
        fin: { lat: 39.46971, lng: -0.37693 },
        imagen: 'fotos_Av1/14_ayuntamiento.jpg',
        video: 'videos/tramo_9.mp4',
    },
    {
        id: 'P-17',
        tipo: "parada",
        parada: 17, // ‚Üê Parada 17 (Edificio del Ayuntamiento) (336, 337, 338) Reto 16 //
        nombre: "Edificio del Ayuntamiento",
        coordenadas: { lat: 39.46971, lng: -0.37693 },
        imagen: 'fotos_Av1/14_ayuntamiento.jpg',
    },
    {
        id: 'P-18',
        tipo: "parada",
        parada: 18, // ‚Üê Parada 18 (Edificio del Ayuntamiento) (339, 340, 341, 54) //
        nombre: "Edificio del Ayuntamiento",
        coordenadas: { lat: 39.46971, lng: -0.37693 },
        imagen: 'fotos_Av1/14_ayuntamiento.jpg',
    },
    {
        id: 'TR-10',
        tipo: "tramo",
        tramo: 10, // ‚Üê tramo 10 (Edificio del Ayuntamiento ‚Üí Estaci√≥n del Norte) (87, 15-C) //
        nombre: "Edificio del Ayuntamiento ‚Üí Estaci√≥n del Norte",
        inicio: { lat: 39.46971, lng: -0.37693 },
        waypoints: [
            { lat: 39.46795, lng: -0.37701 }
        ],
        fin: { lat: 39.46722, lng: -0.37702 },
        imagen: 'fotos_Av1/15_plaza_de_toros_y_estacion_del_norte.jpg',
        video: 'videos/tramo_10.mp4',
    },
    {
        id: 'P-19',
        tipo: "parada",
        parada: 19, // ‚Üê Parada 19 (Estaci√≥n del Norte) (326) Reto 17, 18 Puzzle Estaci√≥n del Norte//
        nombre: "Estaci√≥n del Norte",
        coordenadas: { lat: 39.46722, lng: -0.37702 },
        imagen: 'fotos_Av1/15_plaza_de_toros_y_estacion_del_norte.jpg',
    },
    {
        id: 'TR-11',
        tipo: "tramo",
        tramo: 11, // ‚Üê tramo 11 (Estaci√≥n del Norte ‚Üí Plaza de Toros) (20-C, 323-B, 88) //
        nombre: "Estaci√≥n del Norte ‚Üí Plaza de Toros de Val√®ncia",
        inicio: { lat: 39.46722, lng: -0.37702 },
        waypoints: [],
        fin: { lat: 39.46709, lng: -0.37595 },
        imagen: 'fotos_Av1/15_plaza_de_toros_y_estacion_del_norte.jpg',
        video: 'videos/tramo_11.mp4',
    },
    {
        id: 'TR-12',
        tipo: "tramo",
        tramo: 12, // ‚Üê Tramo 12 (Plaza de Toros ‚Üí Casa estilo √Årabe) (89, 3-D) //
        nombre: "Plaza de Toros ‚Üí Casa estilo √Årabe",
        inicio: { lat: 39.46709, lng: -0.37595 },
        waypoints: [
            { lat: 39.46714, lng: -0.37498 }
        ],
        fin: { lat: 39.46753, lng: -0.37511 },
        imagen: 'fotos_Av1/16!!!!_casa_estilo_arabe.jpg',
        video: 'videos/parada_13.mp4',
    },
    {
        id: 'P-20',
        tipo: "parada",
        parada: 20, // ‚Üê Parada 20 (Casa estilo √Årabe) (99) Reto 19 //
        nombre: "Casa estilo √Årabe",
        coordenadas: { lat: 39.46753, lng: -0.37511 },
        imagen: 'fotos_Av1/16!!!!_casa_estilo_arabe.jpg',
    },
    {
        id: 'P-21',
        tipo: "parada",
        parada: 21, // ‚Üê Parada 21 (Casa estilo √Årabe, mitad Aventura) (100) //
        nombre: "Casa estilo √Årabe, mitad Aventura",
        coordenadas: { lat: 39.46753, lng: -0.37511 },
        imagen: 'fotos_Av1/16!!!!_casa_estilo_arabe.jpg',
    },
    {
        id: 'TR-13',
        tipo: "tramo",
        tramo: 13, // ‚Üê tramo 13 (Casa estilo √Årabe ‚Üí Palacio de Comunicaciones) (21-B) //
        nombre: "Casa estilo √Årabe ‚Üí Palacio de Comunicaciones (Correos)",
        inicio: { lat: 39.46753, lng: -0.37511 },
        waypoints: [],
        fin: { lat: 39.46942, lng: -0.37559 },
        imagen: 'fotos_Av1/17_correos.jpg',
        video: 'videos/tramo_13.mp4',
    },
    {
        id: 'P-22',
        tipo: "parada",
        parada: 22, // ‚Üê Parada 22 (Palacio de Comunicaciones) (21-C) //
        nombre: "Palacio de Comunicaciones: Correos",
        coordenadas: { lat: 39.46942, lng: -0.37559 },
        imagen: 'fotos_Av1/17_correos.jpg',
    },
    {
        id: 'P-23',
        tipo: "parada",
        parada: 23, // ‚Üê Parada 23 (Edificio Suay) (22-C) //
        nombre: "Edificio Suay",
        coordenadas: { lat: 39.46942, lng: -0.37559 },
        imagen: 'fotos_Av1/18_edificio_suay.jpg',
    },
    {
        id: 'TR-14',
        tipo: "tramo",
        tramo: 14, // ‚Üê tramo 14 (Palacio de Comunicaciones ‚Üí Banco de Val√®ncia) (90) //
        nombre: "Palacio de Comunicaciones ‚Üí Banco de Val√®ncia",
        inicio: { lat: 39.46942, lng: -0.37559 },
        waypoints: [
            { lat: 39.4699, lng: -0.37573 },
            { lat: 39.4703, lng: -0.3759 },
            { lat: 39.47039, lng: -0.37505 },
            { lat: 39.47043, lng: -0.37427 }
        ],
        fin: { lat: 39.47061, lng: -0.37408 },
        imagen: 'fotos_Av1/19_banco_de_valencia.jpg',
        video: 'videos/tramo_14.mp4',
    },
    {
        id: 'P-24',
        tipo: "parada",
        parada: 24, // ‚Üê Parada 24 (Banco de Valencia) (23-C) //
        nombre: "Banco de Valencia",
        coordenadas: { lat: 39.47061, lng: -0.37408 },
        imagen: 'fotos_Av1/19_banco_de_valencia.jpg',
    },
    {
        id: 'TR-15',
        tipo: "tramo",
        tramo: 15, // ‚Üê tramo 15 (Banco de Val√®ncia ‚Üí Palacio del Marqu√©s de Dos Aguas) (91) //
        nombre: "Banco de Val√®ncia ‚Üí Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica)",
        inicio: { lat: 39.47061, lng: -0.37408 },
        waypoints: [
            { lat: 39.47119, lng: -0.37423 },
            { lat: 39.47214, lng: -0.37446 },
            { lat: 39.47275, lng: -0.37445 }
        ],
        fin: { lat: 39.47276, lng: -0.37467 },
        imagen: 'fotos_Av1/20!!!!_ marques_de_dos aguas.jpg',
        video: 'videos/parada_16.mp4',
    },
    {
        id: 'P-25',
        tipo: "parada",
        parada: 25, // ‚Üê Parada 25 (Palacio del Marqu√©s de Dos Aguas) (24-C, 25-C, 26-C, 27-C, 28-C, 29-C, 30-C, 31-C, 32-C, 33-C, 34-C, 35-C) //
        nombre: "Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica)",
        coordenadas: { lat: 39.47276, lng: -0.37467 },
        imagen: 'fotos_Av1/20!!!!_ marques_de_dos aguas.jpg',
    },
    {
        id: 'TR-16',
        tipo: "tramo",
        tramo: 16, // ‚Üê tramo 16 (Palacio del Marqu√©s ‚Üí Mercado Central) (92, 93) //
        nombre: "Palacio del Marqu√©s ‚Üí Mercado Central",
        inicio: { lat: 39.47276, lng: -0.37467 },
        waypoints: [
            { lat: 39.47315, lng: -0.37608 },
            { lat: 39.47261, lng: -0.37654 },
            { lat: 39.47225, lng: -0.37686 },
            { lat: 39.47265, lng: -0.37725 }
        ],
        fin: { lat: 39.47377, lng: -0.37832 },
        imagen: 'fotos_Av1/21_mercado_central.jpg',
        video: 'videos/tramo_16.mp4',
    },
    {
        id: 'P-26',
        tipo: "parada",
        parada: 26, // ‚Üê Parada 26 (Mercado central) (36-C, 37-C, 38-C, 39-C, 40-C, 41-C, 42-C, 43-C) //
        nombre: "Mercado central",
        coordenadas: { lat: 39.47377, lng: -0.37832 },
        imagen: 'fotos_Av1/21_mercado_central.jpg',
    },
    {
        id: 'TR-17',
        tipo: "tramo",
        tramo: 17, // ‚Üê tramo 17 (Mercado Central ‚Üí Iglesia de los Santos Juanes) (94) //
        nombre: "Mercado Central ‚Üí Iglesia de los Santos Juanes",
        inicio: { lat: 39.47377, lng: -0.37832 },
        waypoints: [],
        fin: { lat: 39.47425, lng: -0.37895 },
        imagen: 'fotos_Av1/22_iglesia_san_juan_del_mercado.jpg',
        video: 'videos/tramo_17.mp4',
    },
    {
        id: 'P-27',
        tipo: "parada",
        parada: 27, // ‚Üê Parada 27 (Iglesia de los Santos Juanes) (44-C, 45-C, 46-C, 47-C, 48-C, 49-C, 50-C, 51-C, 52-C, 53-C, 54-C, 55-C, 56-C, 57-C, 58-C) //
        nombre: "Iglesia de los Santos Juanes reto 24",
        coordenadas: { lat: 39.47425, lng: -0.37895 },
        imagen: 'fotos_Av1/22_iglesia_san_juan_del_mercado.jpg',
    },
    {
        id: 'P-28',
        tipo: "parada",
        parada: 28, // ‚Üê Parada 28 (Iglesia de los Santos Juanes) (59-C) Reto 25 //
        nombre: "Iglesia de los Santos Juanes reto 25",
        coordenadas: { lat: 39.47425, lng: -0.37895 },
        imagen: 'fotos_Av1/22_iglesia_san_juan_del_mercado.jpg',
    },
    {
        id: 'TR-18',
        tipo: "tramo",
        tramo: 18, // ‚Üê tramo 18 (Iglesia Santos Juanes ‚Üí Lonja de Val√®ncia) (95) //
        nombre: "Iglesia Santos Juanes ‚Üí Lonja de Val√®ncia (Mercado de la Seda)",
        inicio: { lat: 39.47425, lng: -0.37895 },
        waypoints: [],
        fin: { lat: 39.47426, lng: -0.37862 },
        imagen: 'fotos_Av1/23_lonja.jpg',
        video: 'videos/parada_19.mp4',
    },
    {
        id: 'P-29',
        tipo: "parada",
        parada: 29, // ‚Üê Parada 29 (Lonja Puerta de Los Pecados barquero) (60-C) //
        nombre: "Lonja Puerta de Los Pecados barquero",
        coordenadas: { lat: 39.4742, lng: -0.37851 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        id: 'P-30',
        tipo: "parada",
        parada: 30, // ‚Üê Parada 30 (Lonja Puerta de Los Pecados √°rbol muerto) (60-C) //
        nombre: "Lonja Puerta de Los Pecados √°rbol muerto",
        coordenadas: { lat: 39.4742, lng: -0.37851 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        id: 'TR-19',
        tipo: "tramo",
        tramo: 19, // ‚Üê tramo 19 (Lonja G√°rgolas) (96) //
        nombre: "Lonja G√°rgolas",
        inicio: { lat: 39.4742, lng: -0.37851 },
        waypoints: [],
        fin: { lat: 39.4742, lng: -0.37881 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        id: 'P-31',
        tipo: "parada",
        parada: 31, // ‚Üê Parada 31 (Lonja G√°rgolas √°ngel vasija) (61-C) //
        nombre: "Lonja G√°rgolas √°ngel vasija",
        coordenadas: { lat: 39.4742, lng: -0.37881 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        id: 'P-32',
        tipo: "parada",
        parada: 32, // ‚Üê Parada 32 (Lonja G√°rgolas barbudo y le√≥n) (61-C) //
        nombre: "Lonja G√°rgolas barbudo y le√≥n",
        coordenadas: { lat: 39.4742, lng: -0.37881 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        id: 'P-33',
        tipo: "parada",
        parada: 33, // ‚Üê Parada 33 (Lonja G√°rgolas fornicador ventana) (61-C) //
        nombre: "Lonja G√°rgolas fornicador ventana",
        coordenadas: { lat: 39.47439, lng: -0.37887 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        id: 'TR-20',
        tipo: "tramo",
        tramo: 20, // ‚Üê tramo 20 (Lonja ‚Üí Plaza del Doctor Collado) (97) //
        nombre: "Lonja ‚Üí Plaza del Doctor Collado",
        inicio: { lat: 39.47426, lng: -0.37862 },
        waypoints: [
            { lat: 39.47445, lng: -0.37889 },
            { lat: 39.47459, lng: -0.37868 },
            { lat: 39.47475, lng: -0.37842 },
            { lat: 39.47436, lng: -0.37799 }
        ],
        fin: { lat: 39.47444, lng: -0.3779 },
        imagen: 'fotos_Av1/24_lonja2.jpg',
        video: 'videos/tramo_20.mp4',
    },
    {
        id: 'TR-21',
        tipo: "tramo",
        tramo: 21, // ‚Üê tramo 21 (Plaza del Doctor Collado ‚Üí Plaza del Negrito) (333, 397, 41, 398, 198, 671, 522, 32-C) //
        nombre: "Plaza del Doctor Collado ‚Üí Plaza del Negrito (Fuente del Negrito)",
        inicio: { lat: 39.47444, lng: -0.3779 },
        waypoints: [
            { lat: 39.47473, lng: -0.37763 },
            { lat: 39.47493, lng: -0.37761 },
            { lat: 39.47559, lng: -0.37772 }
        ],
        fin: { lat: 39.47611, lng: -0.37741 },
        imagen: 'fotos_Av1/25_fuente_del_negrito.jpg',
        video: 'videos/parada_21.mp4',
    },
    {
        id: 'P-34',
        tipo: "parada",
        parada: 34, // ‚Üê Parada 34 (Fuente del Negrito) (382, 501) Reto 32 //
        nombre: "Fuente del Negrito",
        coordenadas: { lat: 39.47611, lng: -0.37741 },
        imagen: 'fotos_Av1/25_fuente_del_negrito.jpg',
    },
    {
        id: 'TR-22',
        tipo: "tramo",
        tramo: 22, // ‚Üê tramo 22 (Plaza del Negrito ‚Üí Calle Caballeros) (33-B, 486, 480-B) //
        nombre: "Plaza del Negrito ‚Üí Calle Caballeros",
        inicio: { lat: 39.47611, lng: -0.37741 },
        waypoints: [
            { lat: 39.47663, lng: -0.3773 },
            { lat: 39.47661, lng: -0.37685 }
        ],
        fin: { lat: 39.47668, lng: -0.37671 },
        imagen: 'fotos_Av1/26_palau_de_la_generalitat.jpg',
        video: 'videos/parada_22.mp4',
    },
    {
        id: 'P-35',
        tipo: "parada",
        parada: 35, // ‚Üê Parada 35 (Palau de la Generalitat) (481-B, 482-B, 2-D) //
        nombre: "Palau de la Generalitat",
        coordenadas: { lat: 39.47668, lng: -0.37671 },
        imagen: 'fotos_Av1/26_palau_de_la_generalitat.jpg',
    },
    {
        id: 'TR-23',
        tipo: "tramo",
        tramo: 23, // ‚Üê tramo 23 (Palacio de la Generalitat ‚Üí Calle de los Serranos - FINAL) //
        nombre: "Palacio de la Generalitat ‚Üí Calle de los Serranos (FINAL)",
        inicio: { lat: 39.47668, lng: -0.37671 },
        waypoints: [
            { lat: 39.47661, lng: -0.37685 },
            { lat: 39.47687, lng: -0.37686 }
        ],
        fin: { lat: 39.47773, lng: -0.37671 },
        imagen: 'fotos_Av1/00_torres_de_serranos_back.jpg',
        video: 'videos/parada_24.mp4',
    },
    {
        id: 'P-36',
        tipo: "parada",
        parada: 36, // ‚Üê Parada 36 (Torres de Serranos Final) (audio despedida) //
        nombre: "Torres de Serranos Final",
        coordenadas: { lat: 39.47773, lng: -0.37671 },
        imagen: 'fotos_Av1/00_torres_de_serranos_back.jpg',
    }
        ];
        
        // Hacer el array accesible globalmente
        window.puntosRuta = puntosRuta;
    </script>
    <script type="module">
    // =================================================================================
    // 2. MANEJADORES DE MENSAJES
    // =================================================================================
    async function inicializarManejadoresMensajes() {
            try {
                // SISTEMA.PING - Responder con PONG
                registrarControlador('SISTEMA.PING', (mensaje) => {
                    console.log('üîî Recibido PING, enviando PONG');
                    return { timestamp: new Date().toISOString() };
                });

                // NAVEGACION.MOSTRAR_RUTA - Mostrar ruta en el mapa
                registrarControlador('NAVEGACION.MOSTRAR_RUTA', (mensaje) => {
                    const { ruta } = mensaje.datos;
                    console.log('üõ£Ô∏è Mostrando ruta:', ruta);
                    // Implementar l√≥gica para mostrar la ruta en el mapa
                    return { estado: 'ok' };
                });

                // DATOS.COORDENADAS_PARADAS - Enviar coordenadas de las paradas
                registrarControlador('DATOS.COORDENADAS_PARADAS', async () => {
                    console.log('üìç Enviando coordenadas de paradas');
                    // Obtener solo las paradas (no los tramos)
                    const paradas = puntosRuta.filter(p => p.tipo === 'parada');
                    return { 
                        paradas: paradas.map(p => ({
                            id: p.id,
                            nombre: p.nombre,
                            coordenadas: p.coordenadas
                        }))
                    };
                });

                // NAVEGACION.ACTUALIZAR_ESTADO - Actualizar estado de navegaci√≥n
                registrarControlador('NAVEGACION.ACTUALIZAR_ESTADO', (mensaje) => {
                    const { estado: nuevoEstado } = mensaje.datos;
                    console.log('üîÑ Actualizando estado de navegaci√≥n:', nuevoEstado);
                    // Actualizar el estado local
                    estadoComponente.estadoNavegacion = nuevoEstado;
                    // Actualizar la UI seg√∫n el nuevo estado
                    actualizarEstadoBotones();
                    return { estado: 'actualizado' };
                });

                // NAVEGACION.ESTABLECER_DESTINO - Establecer un destino en el mapa
                registrarControlador('NAVEGACION.ESTABLECER_DESTINO', (mensaje) => {
                    const { destino } = mensaje.datos;
                    console.log('üéØ Estableciendo destino:', destino);
                    // Implementar l√≥gica para establecer el destino en el mapa
                    return { 
                        estado: 'ok',
                        mensaje: `Destino establecido: ${destino.nombre || destino.id}`
                    };
                });

                console.log('‚úÖ Manejadores de mensajes registrados');
            } catch (error) {
                console.error('‚ùå Error al inicializar manejadores de mensajes:', error);
                throw error;
            }
        }

        // =================================================================================
        // 3. ESTADO DEL COMPONENTE
        // =================================================================================
        const estadoComponente = {
            modo: 'casa',
            gpsActivo: false,
            watchId: null,
            ultimaActualizacionGPS: 0,
            intervaloMinimo: 5000, // 5 segundos entre actualizaciones para ahorrar bater√≠a
            posicionUsuario: null,
            paradaActual: null,
            distanciaAlDestino: null,
            tipoParadaActual: null, // 'parada' o 'tramo'
            idParadaActual: null,  // 'P-X' o 'TR-X'
            controlesHabilitados: true,
            elementosDOM: {}, // Referencias a botones
            botonesActivos: {
                gps: false,
                imagen: false,
                video: false,
                ubicacion: false,
                mapaCompleto: true, // Siempre activo
                mapaJpg: true       // Siempre activo
            }
        };

        // =================================================================================
        // 3. L√ìGICA DE LA INTERFAZ
        // =================================================================================
        
        // Actualizar los estados de todos los botones seg√∫n reglas espec√≠ficas
        function actualizarEstadoBotones() {
            const { 
                modo, 
                posicionUsuario, 
                distanciaAlDestino, 
                tipoParadaActual, 
                idParadaActual, 
                elementosDOM,
                controlesHabilitados
            } = estadoComponente;
            
            // Si los controles est√°n deshabilitados globalmente, desactivar todo
            if (!controlesHabilitados) {
                desactivarTodosLosBottones();
                return;
            }
            
            // Bot√≥n Video (üé•)
            // Habilitado: SOLO en modo casa Y cuando es un tramo (TR-X)
            // Deshabilitado: En paradas (P-X) o cuando el usuario est√° a menos de 20 metros de la ubicaci√≥n
            if (elementosDOM.btnVideo) {
                const esTramo = tipoParadaActual === 'tramo' || (idParadaActual && idParadaActual.startsWith('TR-'));
                const distanciaMenor20m = distanciaAlDestino !== null && distanciaAlDestino < 20;
                
                if (modo === 'casa' && esTramo) {
                    activarBoton(elementosDOM.btnVideo);
                    console.log('üé• Bot√≥n video ACTIVADO: modo casa y es tramo');
                } else if (distanciaMenor20m) {
                    desactivarBoton(elementosDOM.btnVideo);
                    console.log('üé• Bot√≥n video DESACTIVADO: distancia < 20m');
                } else if (!esTramo) {
                    desactivarBoton(elementosDOM.btnVideo);
                    console.log('üé• Bot√≥n video DESACTIVADO: no es tramo');
                } else if (modo !== 'casa') {
                    desactivarBoton(elementosDOM.btnVideo);
                    console.log('üé• Bot√≥n video DESACTIVADO: no es modo casa');
                }
            }
            
            // Bot√≥n Imagen (üì∑)
            // Habilitado: Siempre en modo casa, o en modo aventura para la parada/tramo actual
            // Deshabilitado: Cuando el usuario est√° a menos de 10 metros de la ubicaci√≥n
            if (elementosDOM.btnImagen) {
                const distanciaMenor10m = distanciaAlDestino !== null && distanciaAlDestino < 10;
                const esParadaActual = idParadaActual !== null;
                
                if (distanciaMenor10m) {
                    desactivarBoton(elementosDOM.btnImagen);
                    console.log('üì∑ Bot√≥n imagen DESACTIVADO: distancia < 10m');
                } else if (modo === 'casa') {
                    activarBoton(elementosDOM.btnImagen);
                    console.log('üì∑ Bot√≥n imagen ACTIVADO: modo casa');
                } else if (modo === 'aventura' && esParadaActual) {
                    activarBoton(elementosDOM.btnImagen);
                    console.log('üì∑ Bot√≥n imagen ACTIVADO: modo aventura y parada actual');
                } else {
                    desactivarBoton(elementosDOM.btnImagen);
                    console.log('üì∑ Bot√≥n imagen DESACTIVADO: condiciones no cumplidas');
                }
            }
            
            // Bot√≥n GPS (üõ∞Ô∏è)
            // Habilitado: Solo cuando el usuario est√° entre 10 y 59.9 metros de la ubicaci√≥n
            // Deshabilitado: En modo casa o cuando el usuario est√° a m√°s de 60 metros de la ubicaci√≥n
            if (elementosDOM.btnGps) {
                if (modo === 'casa') {
                    desactivarBoton(elementosDOM.btnGps);
                    console.log('üõ∞Ô∏è Bot√≥n GPS DESACTIVADO: modo casa');
                } else if (distanciaAlDestino !== null && distanciaAlDestino >= 10 && distanciaAlDestino < 60) {
                    activarBoton(elementosDOM.btnGps);
                    console.log(`üõ∞Ô∏è Bot√≥n GPS ACTIVADO: distancia entre 10-60m (${distanciaAlDestino.toFixed(1)}m)`);
                } else {
                    desactivarBoton(elementosDOM.btnGps);
                    console.log(`üõ∞Ô∏è Bot√≥n GPS DESACTIVADO: distancia fuera de rango (${distanciaAlDestino?.toFixed(1) || 'desconocida'}m)`);
                }
            }
            
            // Bot√≥n Ubicaci√≥n Actual
            // Habilitado: En modo aventura cuando el usuario est√° a m√°s de 60 metros del punto
            // Deshabilitado: En modo casa o cuando el usuario est√° a menos de 60 metros
            if (elementosDOM.btnUbicacion) {
                if (modo === 'casa') {
                    desactivarBoton(elementosDOM.btnUbicacion);
                    console.log('üß≠ Bot√≥n ubicaci√≥n DESACTIVADO: modo casa');
                } else if (distanciaAlDestino !== null && distanciaAlDestino > 60) {
                    activarBoton(elementosDOM.btnUbicacion);
                    console.log(`üß≠ Bot√≥n ubicaci√≥n ACTIVADO: distancia > 60m (${distanciaAlDestino.toFixed(1)}m)`);
                } else {
                    desactivarBoton(elementosDOM.btnUbicacion);
                    console.log(`üß≠ Bot√≥n ubicaci√≥n DESACTIVADO: distancia menor a 60m (${distanciaAlDestino?.toFixed(1) || 'desconocida'}m)`);
                }
            }
            
            // Botones de mapa completo y mapa JPG siempre est√°n habilitados
            if (elementosDOM.btnMapaCompleto) {
                activarBoton(elementosDOM.btnMapaCompleto);
            }
            
            if (elementosDOM.btnMapaJpg) {
                activarBoton(elementosDOM.btnMapaJpg);
            }
        }
        
        // Funci√≥n para desactivar un bot√≥n
        function desactivarBoton(boton) {
            if (!boton) return;
            boton.disabled = true;
            boton.classList.add('deshabilitado');
            boton.setAttribute('aria-disabled', 'true');
            boton.setAttribute('title', 'Funci√≥n no disponible en este momento');
        }

        // Funci√≥n para activar un bot√≥n
        function activarBoton(boton, titulo = '') {
            if (!boton) return;
            boton.disabled = false;
            boton.classList.remove('deshabilitado');
            boton.setAttribute('aria-disabled', 'false');
            if (titulo) {
                boton.setAttribute('title', titulo);
            }
        }

        // Funci√≥n para calcular distancia entre dos puntos geogr√°ficos en metros
        function calcularDistancia(coord1, coord2) {
            if (!coord1 || !coord2) return null;
            if (!coord1.lat || !coord1.lng || !coord2.lat || !coord2.lng) return null;

            const R = 6371e3; // Radio de la Tierra en metros
            const œÜ1 = coord1.lat * Math.PI/180;
            const œÜ2 = coord2.lat * Math.PI/180;
            const ŒîœÜ = (coord2.lat - coord1.lat) * Math.PI/180;
            const ŒîŒª = (coord2.lng - coord1.lng) * Math.PI/180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                    Math.cos(œÜ1) * Math.cos(œÜ2) *
                    Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distancia en metros
        }

        // Funci√≥n para actualizar la distancia al destino
        function actualizarDistanciaDestino() {
            if (!estadoComponente.posicionUsuario) {
                estadoComponente.distanciaAlDestino = null;
                return;
            }
            
            // Buscar coordenadas del punto actual
            const puntoActual = buscarPuntoActual();
            if (!puntoActual || !puntoActual.coordenadas) {
                estadoComponente.distanciaAlDestino = null;
                return;
            }
            
            const distancia = calcularDistancia(
                estadoComponente.posicionUsuario,
                puntoActual.coordenadas
            );
            
            // Actualizar estado
            estadoComponente.distanciaAlDestino = distancia;
            console.log(`üìè Distancia calculada al destino: ${distancia?.toFixed(1) || 'desconocida'} metros`);
            
            // Actualizar estado de botones ya que la distancia cambi√≥
            actualizarEstadoBotones();
            
            return distancia;
        }
        
        // Buscar el punto (parada o tramo) actual en el array de paradas
        function buscarPuntoActual() {
            if (!estadoComponente.idParadaActual) return null;
            
            // Buscar en el array de paradas
            const punto = COORDENADAS_PARADAS.find(p => 
                p.id === estadoComponente.idParadaActual
            );
            
            if (punto) {
                console.log(`üéØ Punto actual encontrado: ${punto.id} - ${punto.nombre || ''}`);
            } else {
                console.log(`‚ö†Ô∏è No se encontr√≥ punto con ID: ${estadoComponente.idParadaActual}`);
            }
            
            return punto;
        }

        // Controlador de mensajes del padre
        window.addEventListener('message', (event) => {
            const mensaje = event.data;
            if (!mensaje || !mensaje.tipo) return;
            
            console.log('Mensaje recibido del padre:', mensaje);
            
            switch (mensaje.tipo) {
                case TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO:
                    manejarCambioModo(mensaje);
                    break;
                case TIPOS_MENSAJE.NAVEGACION.CAMBIO_PARADA:
                    manejarCambioParada(mensaje);
                    break;
                case TIPOS_MENSAJE.CONTROL.HABILITAR:
                    manejarHabilitarControles(mensaje);
                    break;
                case TIPOS_MENSAJE.CONTROL.DESHABILITAR:
                    manejarDeshabilitarControles(mensaje);
                    break;
                // Agregar otros casos seg√∫n sea necesario
            }
        });

        // Funci√≥n para activar el GPS
        function activarGPS() {
            // Si ya hay un watcher, eliminarlo primero
            if (estadoComponente.watchId) {
                desactivarGPS();
            }
            
            estadoComponente.gpsActivo = true;
            
            // Activar estilo del bot√≥n GPS
            const botonGPS = document.getElementById('btn-gps');
            if (botonGPS) {
                botonGPS.classList.add('activo');
            }
            
            // Verificar permisos cada vez que se activa
            verificarPermisosGPS();
        }

        // Funci√≥n para desactivar el GPS
        function desactivarGPS() {
            if (estadoComponente.watchId !== null) {
                navigator.geolocation.clearWatch(estadoComponente.watchId);
                estadoComponente.watchId = null;
            }
            
            estadoComponente.gpsActivo = false;
            
            // Desactivar estilo del bot√≥n GPS
            const botonGPS = document.getElementById('btn-gps');
            if (botonGPS) {
                botonGPS.classList.remove('activo');
            }
            
            actualizarStatus('GPS desactivado', false);
            
            console.log('[COORDENADAS] GPS desactivado');
        }

        // Verificar permisos y activar GPS si est√°n concedidos
        function verificarPermisosGPS() {
            if (!navigator.geolocation) {
                actualizarStatus('Tu navegador no soporta geolocalizaci√≥n', false);
                return;
            }
            
            // Mostrar el estado de carga mientras se solicitan permisos
            actualizarStatus('Solicitando acceso a GPS...', true);
            
            // Verificar permisos utilizando navigator.permissions si est√° disponible
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({ name: 'geolocation' })
                    .then(permissionStatus => {
                        console.log(`[COORDENADAS] Estado de permiso GPS: ${permissionStatus.state}`);
                        
                        if (permissionStatus.state === 'granted') {
                            actualizarStatus('Permiso GPS concedido', false);
                            iniciarWatchPosition();
                        } else if (permissionStatus.state === 'prompt') {
                            // Solicitar√° permiso al llamar a watchPosition
                            iniciarWatchPosition();
                        } else if (permissionStatus.state === 'denied') {
                            actualizarStatus('Permiso GPS denegado. Act√≠valo en tu navegador', false);
                            
                            // Mostrar di√°logo con instrucciones para habilitar GPS
                            mostrarDialogoPermisoDenegado();
                        }
                        
                        // Escuchar cambios en el permiso
                        permissionStatus.onchange = function() {
                            console.log(`[COORDENADAS] Cambio en permiso GPS: ${this.state}`);
                            if (this.state === 'granted' && estadoComponente.gpsActivo) {
                                iniciarWatchPosition();
                            }
                        };
                    })
                    .catch(error => {
                        console.error('[COORDENADAS] Error al verificar permisos:', error);
                        // Intentar directamente con watchPosition como fallback
                        iniciarWatchPosition();
                    });
            } else {
                // El navegador no soporta navigator.permissions, intentar directamente
                iniciarWatchPosition();
            }
        }

        // Funci√≥n para mostrar di√°logo explicando c√≥mo habilitar GPS despu√©s de denegar el permiso
        function mostrarDialogoPermisoDenegado() {
            // Crear un contenedor para el di√°logo
            const tooltipElement = document.createElement('div');
            tooltipElement.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 0 20px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 80%;
                text-align: center;
            `;

            // Contenido del di√°logo
            tooltipElement.innerHTML = `
                <h3>Permiso GPS denegado</h3>
                <p>Para usar esta funcionalidad, necesitas activar el GPS:</p>
                <ol style="text-align: left; margin: 10px 0;">
                    <li>Haz clic en el icono del candado en la barra de direcciones.</li>
                    <li>Busca "Ubicaci√≥n" y cambia a "Permitir".</li>
                    <li>Recarga la p√°gina para aplicar los cambios.</li>
                </ol>
                <button id="cerrar-dialogo-gps" style="
                    margin-top: 10px;
                    padding: 8px 16px;
                    background: #007bff;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                ">Cerrar</button>
            `;

            // A√±adir el di√°logo al cuerpo del documento
            document.body.appendChild(tooltipElement);

            // A√±adir evento para cerrar el di√°logo
            document.getElementById('cerrar-dialogo-gps').addEventListener('click', () => {
                tooltipElement.remove();
            });
        }

        // Funci√≥n para mostrar el estado de carga
        function mostrarEstadoCarga(mensaje) {
            const statusElement = document.getElementById('status');
            if (!statusElement) return;
            
            statusElement.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${mensaje}`;
        }

        // Funci√≥n para ocultar el estado de carga
        function ocultarEstadoCarga() {
            const statusElement = document.getElementById('status');
            if (!statusElement) return;
            
            statusElement.innerHTML = '';
        }

        // Iniciar el seguimiento de posici√≥n
        function iniciarWatchPosition() {
            if (!estadoComponente.gpsActivo) return;
            
            mostrarEstadoCarga('Obteniendo ubicaci√≥n...');
            
            estadoComponente.watchId = navigator.geolocation.watchPosition(
                handlePosicionGPS,
                handleErrorGPS,
                { 
                    enableHighAccuracy: true,  // Mayor precisi√≥n (m√°s bater√≠a)
                    timeout: 10000,            // 10 segundos de timeout
                    maximumAge: 0              // No usar posiciones en cach√©
                }
            );
            
            console.log('[COORDENADAS] GPS activado con watchPosition');
        }

        // Manejar posici√≥n recibida del GPS with throttling para ahorrar bater√≠a
        function handlePosicionGPS(position) {
            const ahora = Date.now();
            
            // Limitar la frecuencia de actualizaciones
            if (ahora - estadoComponente.ultimaActualizacionGPS >= estadoComponente.intervaloMinimo) {
                estadoComponente.ultimaActualizacionGPS = ahora;
                
                const coords = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };
                
                estadoComponente.posicionUsuario = coords;
                
                // Actualizar interfaz
                actualizarStatus(`Posici√≥n: ${coords.lat.toFixed(5)}, ${coords.lng.toFixed(5)}`, false);
                
                // Notificar al padre
                console.log('Enviando actualizaci√≥n de posici√≥n al padre');
                enviarMensaje('padre', TIPOS_MENSAJE.NAVEGACION.ACTUALIZAR_POSICION, {
                    coordenadas: coords,
                    timestamp: new Date().toISOString(),
                    origen: 'hijo2'
                }).catch(err => console.error('Error al enviar posici√≥n:', err));
                
                // Actualizar distancia al destino y estado de botones
                actualizarDistanciaDestino();
            } else {
                // Si no ha pasado suficiente tiempo, solo actualizamos la posici√≥n sin enviar mensajes
                estadoComponente.posicionUsuario = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };
                
                // Actualizar s√≥lo el texto sin animaci√≥n
                const statusElement = document.getElementById('status');
                if (statusElement) {
                    statusElement.textContent = `Posici√≥n: ${position.coords.latitude.toFixed(5)}, ${position.coords.longitude.toFixed(5)}`;
                }
            }
        }

        // Manejar error de GPS
        function handleErrorGPS(error) {
            let mensaje = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    mensaje = 'Usuario deneg√≥ acceso al GPS';
                    break;
                case error.POSITION_UNAVAILABLE:
                    mensaje = 'Ubicaci√≥n no disponible';
                    break;
                case error.TIMEOUT:
                    mensaje = 'Timeout al obtener ubicaci√≥n';
                    break;
                default:
                    mensaje = 'Error desconocido del GPS';
            }
            
            console.warn(`[COORDENADAS] Error GPS (${error.code}): ${mensaje}`);
            actualizarStatus(mensaje, false);
            
            // Desactivar bot√≥n GPS si se deneg√≥ permiso
            if (error.code === error.PERMISSION_DENIED) {
                const botonGPS = document.getElementById('btn-gps');
                if (botonGPS) {
                    botonGPS.classList.remove('activo');
                    botonGPS.classList.add('disabled');
                    setTimeout(() => botonGPS.classList.remove('disabled'), 3000);
                }
            }
        }

        // Funci√≥n para actualizar el estado visual
        function actualizarStatus(mensaje, cargando = false) {
            const statusElement = document.getElementById('status');
            if (!statusElement) return;
            
            if (cargando) {
                statusElement.innerHTML = `<i class="fas fa-spinner fa-spin loading"></i> ${mensaje}`;
            } else {
                statusElement.innerHTML = mensaje;
            }
        }

        // A√±adir manejador para cambio de visibilidad de p√°gina
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                console.log('[COORDENADAS] P√°gina visible, verificando estado GPS');
                
                // Si estamos en modo aventura, verificar el GPS
                if (estadoComponente.modo === 'aventura' && estadoComponente.gpsActivo) {
                    actualizarStatus('Restableciendo GPS...', true);
                    
                    // Verificar permisos y reiniciar GPS
                    verificarPermisosGPS();
                    
                    // Notificar al padre que estamos activos de nuevo
                    enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.ESTADO, {
                        componente: 'hijo2',
                        estado: 'activo',
                        modo: estadoComponente.modo,
                        timestamp: new Date().toISOString()
                    }).catch(err => console.error('Error al notificar estado:', err));
                }
            } else {
                console.log('[COORDENADAS] P√°gina oculta, pausando GPS');
                // Opcionalmente, pausar operaciones GPS intensivas cuando la p√°gina no es visible
            }
        });

        // El array COORDENADAS_PARADAS ya est√° en el scope global
        // Actualizar el array global de puntos de ruta si no est√° definido
        if (!window.puntosRuta) {
            window.puntosRuta = COORDENADAS_PARADAS.map(p => ({
                id: p.id,
                tipo: p.tipo,
                parada: p.parada,
                tramo: p.tramo,
                nombre: p.nombre
            }));
        }
        
        // Manejar solicitudes de paradas de otros componentes
        function manejarSolicitudParadas(mensaje) {
            console.log(' [COORDENADAS] manejarSolicitudParadas INVOCADO con:', mensaje);
            console.log(' [COORDENADAS] Datos de la solicitud:', mensaje.datos);

            const { puntoId } = mensaje.datos || {};
            console.log(' [COORDENADAS] Solicitando datos para puntoId:', puntoId);

            logger.info('Recibida solicitud de paradas desde:', mensaje.origen || 'desconocido');

            // Buscar el punto en el array local
            const puntoEncontrado = window.puntosRuta.find(p =>
                p.id === puntoId ||
                p.parada === puntoId ||
                p.tramo === puntoId
            );

            console.log(' [COORDENADAS] Punto encontrado:', puntoEncontrado);

            if (puntoEncontrado) {
                console.log(' [COORDENADAS] Datos del punto encontrados:', {
                    id: puntoEncontrado.id,
                    tipo: puntoEncontrado.tipo,
                    nombre: puntoEncontrado.nombre,
                    imagen: puntoEncontrado.imagen,
                    video: puntoEncontrado.video,
                    coordenadas: puntoEncontrado.coordenadas
                });
            } else {
                console.warn(' [COORDENADAS] No se encontr√≥ el punto:', puntoId, 'en el array de', window.puntosRuta.length, 'puntos');
            }

            return {
                paradas: window.puntosRuta,
                puntoEncontrado: puntoEncontrado,
                puntoId: puntoId,
                timestamp: new Date().toISOString(),
                total: window.puntosRuta ? window.puntosRuta.length : 0
            };
        }
        
        function manejarClickUbicacion() {
            console.log('üìç Bot√≥n de ubicaci√≥n clickeado');
            // Aqu√≠ puedes agregar la l√≥gica para manejar el clic en el bot√≥n de ubicaci√≥n
            // Por ejemplo, centrar el mapa en la ubicaci√≥n actual o mostrar un di√°logo
            
            // Notificar al padre que se hizo clic en el bot√≥n de ubicaci√≥n
            enviarMensaje('padre', 'NAVEGACION.CENTRAR_EN_UBICACION', {
                origen: 'hijo2',
                timestamp: new Date().toISOString()
            });
        }
        
        function manejarClickGps() {
            console.log('üìç Bot√≥n GPS clickeado');
            const gpsBtn = document.getElementById('btn-gps');
            if (gpsBtn) {
                gpsBtn.classList.toggle('activo');
                const isActive = gpsBtn.classList.contains('activo');
                console.log(`GPS ${isActive ? 'activado' : 'desactivado'}`);
                
                if (isActive) {
                    // Activar el seguimiento GPS
                    activarGPS();
                } else {
                    // Desactivar el seguimiento GPS
                    desactivarGPS();
                }
            }
            const status = document.getElementById('status');
                if (status) {
                    status.textContent = isActive ? 'GPS activado' : 'GPS desactivado';
                    status.className = 'status ' + (isActive ? 'gps-activo' : 'gps-inactivo');
                }
            }
        
        function manejarClickMapaCompleto() {
            console.log('üìç Bot√≥n de mapa completo clickeado');
            // Aqu√≠ puedes agregar la l√≥gica para manejar el clic en el bot√≥n de mapa completo
            // Por ejemplo, mostrar el mapa completo o cambiar la vista
            
            // Notificar al padre que se hizo clic en el bot√≥n de mapa completo
            enviarMensaje('padre', 'NAVEGACION.MOSTRAR_MAPA_COMPLETO', {
                origen: 'hijo2',
                timestamp: new Date().toISOString()
            });
        }
        
        function manejarClickMapaJPG() {
            console.log('üìç Bot√≥n de mapa JPG clickeado');
            // Aqu√≠ puedes agregar la l√≥gica para manejar el clic en el bot√≥n de mapa JPG
            // Por ejemplo, mostrar el mapa JPG o cambiar la vista
            
            // Notificar al padre que se hizo clic en el bot√≥n de mapa JPG
            enviarMensaje('padre', 'NAVEGACION.MOSTRAR_MAPA_JPG', {
                origen: 'hijo2',
                timestamp: new Date().toISOString()
            });
        }

        // Manejador para la solicitud de estado del mapa
        async function manejarSolicitudEstadoMapa(mensaje) {
            console.log('üì© Recibida solicitud de estado del mapa');
            
            try {
                // Extraer las paradas del array AVENTURA_DATOS
                const paradas = [];
                
                // Filtrar solo los elementos que son paradas (tipo 'parada')
                AVENTURA_DATOS.forEach(item => {
                    if (item.tipo === 'parada' && item.coordenadas) {
                        paradas.push({
                            id: item.id,
                            nombre: item.nombre || `Parada ${item.parada}`,
                            lat: item.coordenadas.lat,
                            lng: item.coordenadas.lng,
                            tipo: 'parada',
                            parada: item.parada,
                            descripcion: item.descripcion || ''
                        });
                    }
                });
                
                console.log(`üìç Preparando ${paradas.length} paradas para enviar`);
                
                // Enviar respuesta con las paradas
                await enviarMensaje('padre', TIPOS_MENSAJE.NAVEGACION.ESTADO_MAPA, { 
                    paradas: paradas,
                    timestamp: new Date().toISOString(),
                    origen: 'coordenadas'
                });
                
                console.log('‚úÖ Datos de paradas enviados correctamente');
                
            } catch (error) {
                console.error('‚ùå Error al procesar la solicitud de estado del mapa:', error);
                // Enviar mensaje de error
                await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.ERROR, {
                    origen: 'coordenadas',
                    error: 'Error al procesar la solicitud de estado del mapa',
                    detalle: error.message
                });
            }
        }

        // =================================================================================
        // 5. INICIALIZACI√ìN
        // =================================================================================
        
        // Registrar manejador para la solicitud de estado del mapa
        registrarControlador(TIPOS_MENSAJE.NAVEGACION.SOLICITAR_ESTADO_MAPA, manejarSolicitudEstadoMapa);
        // Inicializar el componente
        async function inicializar() {
            try {
                console.log('üöÄ Inicializando componente de botones-coordenadas...');
                
                // Inicializar manejadores de mensajes
                await inicializarManejadoresMensajes();
                
                // Notificar al padre que el componente est√° listo
                await enviarMensaje('padre', 'SISTEMA.COMPONENTE_INICIALIZADO', {
                    componente: 'botones-coordenadas',
                    estado: 'listo',
                    timestamp: new Date().toISOString()
                });
                
                // Notificar que la inicializaci√≥n ha finalizado
                await enviarMensaje('padre', 'SISTEMA.INICIALIZACION_FINALIZADA', {
                    componente: 'botones-coordenadas',
                    timestamp: new Date().toISOString()
                });
                
                // Configurar logger
                logger.configure({ 
                    iframeId: IFRAME_ID, 
                    debug: true 
                });

                // Inicializar mensajer√≠a
                await inicializarMensajeria({ 
                    iframeId: IFRAME_ID,
                    logLevel: 3,
                    modoDebug: true
                });
                
                console.log('‚úÖ Mensajer√≠a inicializada en el componente de coordenadas');
                
                // Notificar al padre que el componente est√° listo
                await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.COMPONENTE_LISTO, {
                    componente: 'coordenadas',
                    estado: 'listo',
                    timestamp: new Date().toISOString()
                });

                // Guardar referencias a elementos DOM
                estadoComponente.elementosDOM = {
                    btnGps: document.getElementById('btn-gps'),
                    btnImagen: document.getElementById('btn-imagen'),
                    btnVideo: document.getElementById('btn-video'),
                    btnUbicacion: document.getElementById('btn-ubicacion'),
                    btnMapaCompleto: document.getElementById('btn-mapa-completo'),
                    btnMapaJpg: document.getElementById('btn-mapa-jpg')
                };

                // Configurar eventos de botones
                if (estadoComponente.elementosDOM.btnGps) {
                    estadoComponente.elementosDOM.btnGps.addEventListener('click', manejarClickGps);
                }
                if (estadoComponente.elementosDOM.btnImagen) {
                    estadoComponente.elementosDOM.btnImagen.addEventListener('click', () => mostrarMedio('imagen'));
                }
                if (estadoComponente.elementosDOM.btnVideo) {
                    estadoComponente.elementosDOM.btnVideo.addEventListener('click', () => mostrarMedio('video'));
                }
                if (estadoComponente.elementosDOM.btnUbicacion) {
                    estadoComponente.elementosDOM.btnUbicacion.addEventListener('click', manejarClickUbicacion);
                }
                if (estadoComponente.elementosDOM.btnMapaCompleto) {
                    estadoComponente.elementosDOM.btnMapaCompleto.addEventListener('click', manejarClickMapaCompleto);
                }
                if (estadoComponente.elementosDOM.btnMapaJpg) {
                    estadoComponente.elementosDOM.btnMapaJpg.addEventListener('click', manejarClickMapaJPG);
                }

                // Registrar eventos para los nuevos botones
                document.getElementById('btn-ubicacion').addEventListener('click', manejarClickUbicacion);
                document.getElementById('btn-mapa-completo').addEventListener('click', manejarClickMapaCompleto);

                // Notificar al padre que estamos listos
                await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.COMPONENTE_LISTO, { componente: IFRAME_ID });
                actualizarStatus('Listo para navegar');
                logger.info('Componente de coordenadas inicializado con nuevo dise√±o.');

                // Inicialmente, desactivar el bot√≥n de ubicaci√≥n
                desactivarBoton(document.getElementById('btn-ubicacion'));
                
                return true;
            } catch (error) {
                console.error('Error al inicializar componente:', error);
                actualizarStatus('Error al inicializar componente');
                return false;
            }
        }

        registrarControlador(TIPOS_MENSAJE.DATOS.SOLICITAR_PARADA, (mensaje) => {
            const { parada_id, tramo_id } = mensaje.datos || {};
            let parada = null;

            if (parada_id) {
                parada = paradas.find(p => p.parada_id === parada_id || p.id === parada_id);
            } else if (tramo_id) {
                parada = paradas.find(p => p.tramo_id === tramo_id || p.id === tramo_id);
            }

            if (parada) {
                enviarMensaje(mensaje.origen, TIPOS_MENSAJE.DATOS.RESPUESTA_PARADA, { parada });
            } else {
                enviarMensaje(mensaje.origen, TIPOS_MENSAJE.DATOS.RESPUESTA_PARADA, { error: 'No encontrada', parada_id, tramo_id });
            }
        });

        // Confirmar recepci√≥n de mensajes
        registrarControlador(TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, (mensaje) => {
            console.log('Cambio de modo recibido:', mensaje.datos);
            enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.CONFIRMACION, { estado: 'recibido', origen: 'hijo2' });
        });

        inicializar().catch(error => {
            actualizarStatus('Error al inicializar componente');
        });

        // =================================================================================
        // 6. MANEJO DE MENSAJES DEL PADRE
        // =================================================================================
        
        window.addEventListener('message', (event) => {
            const { tipo, datos } = event.data;

            if (tipo === 'SISTEMA.PING') {
                window.parent.postMessage({ tipo: 'SISTEMA.PONG', datos: { timestamp: Date.now() } }, '*');
            }

            if (tipo === 'NAVEGACION.MOSTRAR_RUTA') {
                // Handle showing a route on the map
                console.log('Mostrar ruta:', datos);
            }

            if (tipo === 'DATOS.COORDENADAS_PARADAS') {
                // Send coordinates of stops
                window.parent.postMessage({ tipo: 'DATOS.COORDENADAS_PARADAS', datos: { coordenadas: [] } }, '*');
            }

            if (tipo === 'NAVEGACION.ACTUALIZAR_ESTADO') {
                // Update navigation state
                console.log('Actualizar estado de navegaci√≥n:', datos);
            }

            if (tipo === 'NAVEGACION.ESTABLECER_DESTINO') {
                // Set a destination on the map
                console.log('Establecer destino:', datos);
            }

            if (tipo === 'NAVEGACION.SOLICITAR_DESTINO') {
                // Request a specific destination
                window.parent.postMessage({ tipo: 'NAVEGACION.SOLICITAR_DESTINO', datos: { destino: 'Ejemplo' } }, '*');
            }
        });

        window.parent.postMessage({ tipo: 'SISTEMA.INICIALIZACION_FINALIZADA', datos: { componente: 'Av1-botones-coordenadas' } }, '*');
        window.parent.postMessage({ tipo: 'SISTEMA.COMPONENTE_INICIALIZADO', datos: { componente: 'Av1-botones-coordenadas' } }, '*');
    </script>
</div>
</body>
</html>
