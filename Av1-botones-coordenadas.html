<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Botones y Coordenadas GPS</title>
    <style>
        :root {
            /* Variables de dise√±o para botones y barra de progreso */
            --btn-size: 60px;
            --icon-size: 1.5em;
            --progress-thick: 20px; /* GROSOR DE LA BARRA DE PROGRESO UNIFORME CON HIJO 3 */
            --timer-font-size: 1.1em; /* AJUSTADO: Reducido de 1.3em a 1.1em, igualado con hijo3 */
        }

        body {
            margin: 0;
            padding: 5px;
            background: transparent;
            font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif; /* IGUALADO: Misma fuente elegante que hijo3 */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        /* Contenedor principal con la forma trapezoidal (ancho arriba, estrecho abajo) */
        .container {
            width: 290px; /* AJUSTADO: Reducido de 340px a 290px, igualado con hijo3 */
            height: 155px; /* Altura aumentada para incluir m√°rgenes */
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.13);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            padding: 5px 8px 5px 8px;
            box-sizing: border-box;
            margin: 5px 0; /* NUEVO: M√°rgenes superior e inferior de 5px */
            
            /* === CLAVE PARA LA FORMA TRAPEZOIDAL (ancho arriba, estrecho abajo) === */
            clip-path: polygon(0% 0%, 100% 0%, 92% 100%, 8% 100%); /* PERFECTAMENTE COMPLEMENTARIO: mismo ancho estrecho (84%) que hijo3, pero invertido */
        }

        /* Barra de Progreso */
        .progress-container {
            width: 90%;
            height: var(--progress-thick);
            background-color: #d0d0d0;
            border-radius: calc(var(--progress-thick) / 2);
            overflow: hidden;
            margin: 3px 0;
            position: relative;
            cursor: pointer;
            border: 1px solid #bbb;
        }

        .progress-bar {
            height: 100%;
            width: 5%;
            background: linear-gradient(90deg, #007bff, #00c6ff);
            border-radius: calc(var(--progress-thick) / 2);
            transition: none;
        }

        .time-display {
            width: 90%;
            display: flex;
            justify-content: space-between;
            color: #333;
            font-size: var(--timer-font-size);
            margin: 2px 0;
        }

        .botones-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin: 2px 0;
        }

        .boton {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%; /* C√çRCULO */
            border: none;
            background: linear-gradient(135deg, #dc3545, #c82333); /* Rojo por defecto */
            color: white;
            font-size: var(--icon-size);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            flex-shrink: 0;
        }

        .boton.activo {
            background: linear-gradient(135deg, #28a745, #1e7e34); /* Verde cuando est√° activo */
        }

        .boton:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .boton:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .boton.disabled {
            background: linear-gradient(135deg, #dc3545, #c82333);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .boton.disabled:hover {
            transform: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
        }

        /* Control individual del tama√±o de iconos */
        .icon-gps {
            font-size: var(--icon-size);
        }

        .icon-imagen {
            font-size: var(--icon-size);
        }

        .icon-video {
            font-size: var(--icon-size);
        }

        .status {
            margin: 2px 0;
            padding: 3px;
            background: white;
            border-radius: 5px;
            font-size: 10px;
            text-align: center;
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 90%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .gps-icon {
            width: 16px;
            height: 16px;
            margin-right: 5px;
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Media queries para m√≥viles - IGUALADO con hijo3 */
        @media (max-width: 500px) {
            body {
                padding: 2px; /* Menos padding en m√≥viles */
            }
            
            .container {
                width: 98vw; /* IGUALADO: Mismo ancho responsive que hijo3 */
                height: 155px; /* IGUALADO: Misma altura que hijo3 tambi√©n en m√≥viles */
                /* El clip-path se mantiene igual: polygon(0% 0%, 100% 0%, 92% 100%, 8% 100%) */
                /* para preservar la geometr√≠a del trapecio en todos los dispositivos */
            }
            
            .progress-container {
                margin: 1px 0; /* Reducir margen en m√≥viles */
            }
            
            .time-display {
                margin: 1px 0; /* Reducir margen en m√≥viles */
            }
            
            .botones-row {
                gap: 8px; /* Reducir gap entre botones en m√≥viles */
                margin: 1px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="time-display">
            <span id="elapsedTime">00:00</span>
            <span id="totalTime">05:30</span>
        </div>
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="botones-row">
            <button id="btn-gps" class="boton">
                <span class="icon-gps">üõ∞Ô∏è</span>
            </button>
            <button id="btn-imagen" class="boton disabled">
                <span class="icon-imagen">üì∏</span>
            </button>
            <button id="btn-video" class="boton disabled">
                <span class="icon-video">üìΩÔ∏è</span>
            </button>
        </div>
        <div class="status" id="status" style="display: none;">
            <!-- Mensaje flotante ahora ser√° manejado por el padre -->
        </div>
    </div>

    <script>
        // ================== COORDENADAS DE LAS PARADAS ==================
       
          const COORDENADAS_PARADAS = [
    {
        tipo: "inicio",
        parada: 0, // ‚Üê Parada 0 ‚Äì INICIO (223, 226, 228, 229) reto 2 //
        nombre: "Torres de Serranos (start)",
        coordenadas: { lat: 39.47876, lng: -0.37626 },
        imagen: 'fotos_Av1/00_torres_de_serranos_back.jpg',
        video: 'videos/parada_0.mp4',
    },
    {
        tipo: "tramo",
        tramo: 1, // ‚Üê tramo 1 (Torres de Serranos ‚Üí Plaza de la crida) (2, 126,) //
        nombre: "Torres de Serranos ‚Üí Plaza de la crida (Puente de Serranos)",
        inicio: { lat: 39.47876, lng: -0.37626 },
        waypoints: [
            { lat: 39.47905, lng: -0.37613 },
            { lat: 39.47933, lng: -0.37647 },
            { lat: 39.47943, lng: -0.37636 }
        ],
        fin: { lat: 39.47959, lng: -0.37583 },
        imagen: 'fotos_Av1/01_torres_de_serranos_front.jpg',
        video: 'videos/tramo_1.mp4',
    },
    {
        tipo: "parada",
        parada: 1, // ‚Üê Parada 1 - Plaza de la crida (Puente de Serranos) (233) Reto 3 //
        nombre: "Plaza de la crida (Puente de Serranos)",
        coordenadas: { lat: 39.47959, lng: -0.37583 },
        imagen: 'fotos_Av1/01_torres_de_serranos_front.jpg',
    },
    {
        tipo: "tramo",
        tramo: 2, // ‚Üê tramo 2 (Plaza de la crida ‚Üí Calle Muro de Santa Ana) (81) //
        nombre: "Plaza de la crida ‚Üí Calle Muro de Santa Ana",
        inicio: { lat: 39.47959, lng: -0.37583 },
        waypoints: [
            { lat: 39.47939, lng: -0.3752 },
            { lat: 39.47902, lng: -0.37465 },
            { lat: 39.47866, lng: -0.3747 }
        ],
        fin: { lat: 39.47866, lng: -0.3747 },
        imagen: 'muro de Santa ana.jpg',
        video: 'videos/tramo 2_2.mp4',
    },
    {
        tipo: "parada",
        parada: 2, // ‚Üê Parada 2 (Calle Muro de Santa Ana) (68) Reto 4 //
        nombre: "Calle Muro de Santa Ana",
        coordenadas: { lat: 39.47866, lng: -0.3747 },
        imagen: 'muro de Santa ana.jpg',
    },
    {
        tipo: "tramo",
        tramo: 3, // ‚Üê tramo 3 (Calle Muro de Santa Ana ‚Üí Palacio de los Borgia) (52) //
        nombre: "Calle Muro de Santa Ana ‚Üí Palacio de los Borgia",
        inicio: { lat: 39.47866, lng: -0.3747 },
        waypoints: [],
        fin: { lat: 39.47768, lng: -0.3749 },
        imagen: 'fotos_Av1/02_cortes_valencianas.jpg',
        video: 'videos/tramo_3.mp4',
    },
    {
        tipo: "parada",
        parada: 3, // ‚Üê Parada 3 (Iglesia de San Lorenzo) (686, 682-B, 462, 683, 684) Reto 5 //
        nombre: "Iglesia de San Lorenzo",
        coordenadas: { lat: 39.47768, lng: -0.3749 },
        imagen: 'fotos_Av1/03_iglesia_de_san_lorenzo.jpg',
    },
    {
        tipo: "tramo",
        tramo: 4, // ‚Üê tramo 4 (Iglesia de San Lorenzo ‚Üí Plaza de la Virgen) (465-B) //
        nombre: "Iglesia de San Lorenzo ‚Üí Plaza de la Virgen",
        inicio: { lat: 39.47768, lng: -0.3749 },
        waypoints: [],
        fin: { lat: 39.47656, lng: -0.37529 },
        imagen: 'fotos_Av1/04_plaza_de_la_virgen.jpg',
        video: 'videos/tramo_4.mp4',
    },
    {
        tipo: "parada",
        parada: 4, // ‚Üê Parada 4 (Plaza de la Virgen) (466, 467) Reto 6 //
        nombre: "Plaza de la Virgen Reto 6",
        coordenadas: { lat: 39.47656, lng: -0.37529 },
        imagen: 'fotos_Av1/04_plaza_de_la_virgen.jpg',
    },
    {
        tipo: "parada",
        parada: 5, // ‚Üê Parada 5 (Plaza de la Virgen) (468) Reto 7, 8 Puzzle plaza de la virgen //
        nombre: "Plaza de la Virgen Reto 7",
        coordenadas: { lat: 39.47656, lng: -0.37529 },
        imagen: 'fotos_Av1/04_plaza_de_la_virgen.jpg',
    },
    {
        tipo: "tramo",
        tramo: 5, // ‚Üê tramo 5 (Plaza de la Virgen ‚Üí Plaza de la Almo√≠na) (477-B, 479, 141, 83, 8-C) //
        nombre: "Plaza de la Virgen ‚Üí Plaza de la Almo√≠na",
        inicio: { lat: 39.47656, lng: -0.37529 },
        waypoints: [
            { lat: 39.4766, lng: -0.37473 },
            { lat: 39.47656, lng: -0.37453 },
            { lat: 39.47606, lng: -0.3746 }
        ],
        fin: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/05_plaza_de_la_almoina.jpg',
        video: 'videos/tramo_5.mp4',
    },
    {
        tipo: "parada",
        parada: 6, // ‚Üê Parada 6 (Panel cer√°mico muro Catedral) (434, 440, 441, 442) Reto 9 //
        nombre: "Panel cer√°mico muro Catedral",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/06_panel_ceramico_muro_norte_catedral.jpg',
    },
    {
        tipo: "parada",
        parada: 7, // ‚Üê Parada 7 (Capilla exterior catedral) (443, 444, 445) Reto 10 //
        nombre: "Capilla exterior catedral Reto 10",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/07!!!_capilla_exterior_catedral.jpg',
    },
    {
        tipo: "parada",
        parada: 8, // ‚Üê Parada 8 (Capilla exterior catedral) (445) Reto 11 //
        nombre: "Capilla exterior catedral Reto 11",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/07!!!_capilla_exterior_catedral.jpg',
    },
    {
        tipo: "parada",
        parada: 9, // ‚Üê Parada 9 (Arco Novo Catedral y Puerta Negra Bas√≠lica) (446, 355, 447, 11-B, 451, 452) //
        nombre: "Arco Novo Catedral y Puerta Negra Bas√≠lica",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/08_arco_novo_catedral.jpg',
        imagen2: 'fotos_Av1/09_puerta_negra_relieve_basilica.jpg',
    },
    {
        tipo: "parada",
        parada: 10, // ‚Üê Parada 10 (Casa del Punt de Gantxo) (51-C, 354, 455, 455-B, 456) reto 12 //
        nombre: "Casa del Punt de Gantxo",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/10_casa_del_punt_de_gantxo.jpg',
    },
    {
        tipo: "tramo",
        tramo: 6, // ‚Üê tramo 6 (Plaza de la Almo√≠na ‚Üí Plaza Decimo Junio Bruto) (457, 10-B) //
        nombre: "Plaza de la Almo√≠na ‚Üí Plaza Decimo Junio Bruto (Museo Arqueol√≥gico de la Almo√≠na)",
        inicio: { lat: 39.47594, lng: -0.37474 },
        waypoints: [],
        fin: { lat: 39.4762, lng: -0.37412 },
        imagen: 'fotos_Av1/05_plaza_de_la_almoina.jpg',
        video: 'videos/tramo_6.mp4',
    },
    {
        tipo: "parada",
        parada: 11, // ‚Üê Parada 11 (Museo arqueol√≥gico La Almo√≠na) (458) Reto 13 //
        nombre: "Museo arqueol√≥gico La Almo√≠na",
        coordenadas: { lat: 39.4762, lng: -0.37412 },
        imagen: 'fotos_Av1/27_museo_la_almoina.jpg',
    },
    {
        tipo: "parada",
        parada: 12, // ‚Üê Parada 12 (Museo arqueol√≥gico La Almo√≠na) (459, 460, 461) //
        nombre: "Museo arqueol√≥gico La Almo√≠na",
        coordenadas: { lat: 39.4762, lng: -0.37412 },
        imagen: 'fotos_Av1/27_museo_la_almoina.jpg',
    },
    {
        tipo: "parada",
        parada: 13, // ‚Üê Parada 13 (Vista de la Catedral, Cimborrio) (8-C, 464) Reto14 //
        nombre: "Vista de la Catedral, Cimborrio",
        coordenadas: { lat: 39.4762, lng: -0.37412 },
        imagen: 'fotos_Av1/05_plaza_de_la_almoina.jpg',
    },
    {
        tramo: 7, // ‚Üê tramo 7 (Museo arqueol√≥gico La Almo√≠na ‚Üí Palacio Arzobispal) (85) //
        tipo: "tramo",
        nombre: "Museo arqueol√≥gico La Almo√≠na ‚Üí Palacio Arzobispal",
        inicio: { lat: 39.47611, lng: -0.37478 },
        waypoints: [
            { lat: 39.47604, lng: -0.37442 },
            { lat: 39.47584, lng: -0.37443 },
            { lat: 39.47561, lng: -0.37451 }
        ],
        fin: { lat: 39.4755, lng: -0.37436 },
        imagen: 'fotos_Av1/11_palacio_arzobispal.jpg',
        video: 'videos/parada_8.mp4',
    },
    {
        parada: 14, // ‚Üê Parada 14 (Palacio Arzobispal y Puerta Rom√°nica de la Catedral) (673, 86, 426-B, 141, 437, 438) Reto 15 //
        tipo: "parada",
        nombre: "Palacio Arzobispal y Puerta Rom√°nica de la Catedral",
        coordenadas: { lat: 39.4755, lng: -0.37436 },
        imagen: 'fotos_Av1/12_puerta_romanica_catedral.jpg',
    },
    {
        parada: 15, // ‚Üê Parada 15 (Puerta Rom√°nica de la Catedral) (439) //
        tipo: "parada",
        nombre: "Puerta Rom√°nica de la Catedral",
        coordenadas: { lat: 39.47561, lng: -0.37465 },
        imagen: 'fotos_Av1/12_puerta_romanica_catedral.jpg',
    },
    {
        tramo: 8, // ‚Üê tramo 8 (Puerta Rom√°nica de la Catedral ‚Üí Plaza del Ayuntamiento) (125)  //
        tipo: "tramo",
        nombre: "Puerta Rom√°nica de la Catedral ‚Üí Plaza del Ayuntamiento",
        inicio: { lat: 39.47561, lng: -0.37465 },
        waypoints: [
            { lat: 39.4756, lng: -0.37466 },
            { lat: 39.47514, lng: -0.37494 },
            { lat: 39.47447, lng: -0.3754 },
            { lat: 39.47378, lng: -0.3756 },
            { lat: 39.47212, lng: -0.37676 }
        ],
        fin: { lat: 39.47056, lng: -0.37677 },
        imagen: 'fotos_Av1/13_plaza_del_ayuntamiento.jpg',
        video: 'videos/tramo_8.mp4',
    },
    {
        parada: 16, // ‚Üê Parada 16 (Plaza del Ayuntamiento) (13-B, 263, 332, 14-C) //
        tipo: "parada",
        nombre: "Plaza del Ayuntamiento",
        coordenadas: { lat: 39.47056, lng: -0.37677 },
        imagen: 'fotos_Av1/13_plaza_del_ayuntamiento.jpg',
    },
    {
        tramo: 9, // ‚Üê tramo 9 (Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento) (334, 335) //
        tipo: "tramo",
        nombre: "Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento de Val√®ncia",
        inicio: { lat: 39.47056, lng: -0.37677 },
        waypoints: [],
        fin: { lat: 39.46971, lng: -0.37693 },
        imagen: 'fotos_Av1/14_ayuntamiento.jpg',
        video: 'videos/tramo_9.mp4',
    },
    {
        parada: 17, // ‚Üê Parada 17 (Edificio del Ayuntamiento) (336, 337, 338) Reto 16 //
        tipo: "parada",
        nombre: "Edificio del Ayuntamiento",
        coordenadas: { lat: 39.46971, lng: -0.37693 },
        imagen: 'fotos_Av1/14_ayuntamiento.jpg',
    },
    {
        parada: 18, // ‚Üê Parada 18 (Edificio del Ayuntamiento) (339, 340, 341, 54) //
        tipo: "parada",
        nombre: "Edificio del Ayuntamiento",
        coordenadas: { lat: 39.46971, lng: -0.37693 },
        imagen: 'fotos_Av1/14_ayuntamiento.jpg',
    },
    {
        tramo: 10, // ‚Üê tramo 10 (Edificio del Ayuntamiento ‚Üí Estaci√≥n del Norte) (87, 15-C) //
        tipo: "tramo",
        nombre: "Edificio del Ayuntamiento ‚Üí Estaci√≥n del Norte",
        inicio: { lat: 39.46971, lng: -0.37693 },
        waypoints: [
            { lat: 39.46795, lng: -0.37701 }
        ],
        fin: { lat: 39.46722, lng: -0.37702 },
        imagen: 'fotos_Av1/15_plaza_de_toros_y_estacion_del_norte.jpg',
        video: 'videos/tramo_10.mp4',
    },
    {
        parada: 19, // ‚Üê Parada 19 (Estaci√≥n del Norte) (326) Reto 17, 18 Puzzle Estaci√≥n del Norte//
        tipo: "parada",
        nombre: "Estaci√≥n del Norte",
        coordenadas: { lat: 39.46722, lng: -0.37702 },
        imagen: 'fotos_Av1/15_plaza_de_toros_y_estacion_del_norte.jpg',
    },
    {
        tramo: 11, // ‚Üê tramo 11 (Estaci√≥n del Norte ‚Üí Plaza de Toros) (20-C, 323-B, 88) //
        tipo: "tramo",
        nombre: "Estaci√≥n del Norte ‚Üí Plaza de Toros de Val√®ncia",
        inicio: { lat: 39.46722, lng: -0.37702 },
        waypoints: [],
        fin: { lat: 39.46709, lng: -0.37595 },
        imagen: 'fotos_Av1/15_plaza_de_toros_y_estacion_del_norte.jpg',
        video: 'videos/tramo_11.mp4',
    },
    {
        tramo: 12, // ‚Üê Tramo 12 (Plaza de Toros ‚Üí Casa estilo √Årabe) (89, 3-D) //
        tipo: "tramo",
        nombre: "Plaza de Toros ‚Üí Casa estilo √Årabe",
        inicio: { lat: 39.46709, lng: -0.37595 },
        waypoints: [
            { lat: 39.46714, lng: -0.37498 }
        ],
        fin: { lat: 39.46753, lng: -0.37511 },
        imagen: 'fotos_Av1/16!!!!_casa_estilo_arabe.jpg',
        video: 'videos/parada_13.mp4',
    },
    {
        parada: 20, // ‚Üê Parada 20 (Casa estilo √Årabe) (99) Reto 19 //
        tipo: "parada",
        nombre: "Casa estilo √Årabe",
        coordenadas: { lat: 39.46753, lng: -0.37511 },
        imagen: 'fotos_Av1/16!!!!_casa_estilo_arabe.jpg',
    },
    {
        parada: 21, // ‚Üê Parada 21 (Casa estilo √Årabe, mitad Aventura) (100) //
        tipo: "parada",
        nombre: "Casa estilo √Årabe, mitad Aventura",
        coordenadas: { lat: 39.46753, lng: -0.37511 },
        imagen: 'fotos_Av1/16!!!!_casa_estilo_arabe.jpg',
    },
    {
        tramo: 13, // ‚Üê tramo 13 (Casa estilo √Årabe ‚Üí Palacio de Comunicaciones) (21-B) //
        tipo: "tramo",
        nombre: "Casa estilo √Årabe ‚Üí Palacio de Comunicaciones (Correos)",
        inicio: { lat: 39.46753, lng: -0.37511 },
        waypoints: [],
        fin: { lat: 39.46942, lng: -0.37559 },
        imagen: 'fotos_Av1/17_correos.jpg',
        video: 'videos/tramo_13.mp4',
    },
    {
        parada: 22, // ‚Üê Parada 22 (Palacio de Comunicaciones: Correos) (700, 343, 344) Reto 20 //
        tipo: "parada",
        nombre: "Palacio de Comunicaciones: Correos",
        coordenadas: { lat: 39.46942, lng: -0.37559 },
        imagen: 'fotos_Av1/17_correos.jpg',
    },
    {
        parada: 23, // ‚Üê Parada 23 (Edificio Suay) (693, 693-B) Reto 21 //
        tipo: "parada",
        nombre: "Edificio Suay",
        coordenadas: { lat: 39.46942, lng: -0.37559 },
        imagen: 'fotos_Av1/18_edificio_suay.jpg',
    },
    {
        tramo: 14, // ‚Üê tramo 14 (Palacio de Comunicaciones ‚Üí Banco de Val√®ncia) (345, 347, 348, 22) //
        tipo: "tramo",
        nombre: "Palacio de Comunicaciones ‚Üí Banco de Val√®ncia",
        inicio: { lat: 39.46942, lng: -0.37559 },
        waypoints: [
            { lat: 39.4699, lng: -0.37573 },
            { lat: 39.4703, lng: -0.3759 },
            { lat: 39.47039, lng: -0.37505 },
            { lat: 39.47043, lng: -0.37427 }
        ],
        fin: { lat: 39.47061, lng: -0.37408 },
        imagen: 'fotos_Av1/19_banco_de_valencia.jpg',
        video: 'videos/tramo_14.mp4',
    },
    {
        parada: 24, // ‚Üê Parada 24 (Banco de Valencia) (349, 350) Reto 22 //
        tipo: "parada",
        nombre: "Banco de Valencia",
        coordenadas: { lat: 39.47061, lng: -0.37408 },
        imagen: 'fotos_Av1/19_banco_de_valencia.jpg',
    },
    {
        tramo: 15, // ‚Üê tramo 15 (Banco de Val√®ncia ‚Üí Palacio del Marqu√©s de Dos Aguas) (351, 23-B, 352, 354) //
        tipo: "tramo",
        nombre: "Banco de Val√®ncia ‚Üí Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica)",
        inicio: { lat: 39.47061, lng: -0.37408 },
        waypoints: [
            { lat: 39.47119, lng: -0.37423 },
            { lat: 39.47214, lng: -0.37446 },
            { lat: 39.47275, lng: -0.37445 }
        ],
        fin: { lat: 39.47276, lng: -0.37467 },
        imagen: 'fotos_Av1/20!!!!_ marques_de_dos aguas.jpg',
        video: 'videos/parada_16.mp4',
    },
    {
        parada: 25, // ‚Üê Parada 25 (Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica) (356, 357) //
        tipo: "parada",
        nombre: "Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica)",
        coordenadas: { lat: 39.47276, lng: -0.37467 },
        imagen: 'fotos_Av1/20!!!!_ marques_de_dos aguas.jpg',
    },
    {
        tramo: 16, // ‚Üê tramo 16 (Palacio del Marqu√©s ‚Üí Mercado Central) (358, 359, 401) //
        tipo: "tramo",
        nombre: "Palacio del Marqu√©s ‚Üí Mercado Central",
        inicio: { lat: 39.47276, lng: -0.37467 },
        waypoints: [
            { lat: 39.47315, lng: -0.37608 },
            { lat: 39.47261, lng: -0.37654 },
            { lat: 39.47225, lng: -0.37686 },
            { lat: 39.47265, lng: -0.37725 }
        ],
        fin: { lat: 39.47377, lng: -0.37832 },
        imagen: 'fotos_Av1/21_mercado_central.jpg',
        video: 'videos/tramo_16.mp4',
    },
    {
        parada: 26, // ‚Üê Parada 26 (Mercado central) (701, 24-D, 361, 362, 363, 364) Reto 23 //
        tipo: "parada",
        nombre: "Mercado central",
        coordenadas: { lat: 39.47377, lng: -0.37832 },
        imagen: 'fotos_Av1/21_mercado_central.jpg',
    },
    {
        tramo: 17, // ‚Üê tramo 17 (Mercado Central ‚Üí Iglesia Santos Juanes) (274, 27-C) //
        tipo: "tramo",
        nombre: "Mercado Central ‚Üí Iglesia de los Santos Juanes",
        inicio: { lat: 39.47377, lng: -0.37832 },
        waypoints: [],
        fin: { lat: 39.47425, lng: -0.37895 },
        imagen: 'fotos_Av1/22_iglesia_san_juan_del_mercado.jpg',
        video: 'videos/tramo_17.mp4',
    },
    {
        parada: 27, // ‚Üê Parada 27 (Iglesia de los Santos Juanes) (365, 366) Reto 24 //
        tipo: "parada",
        nombre: "Iglesia de los Santos Juanes reto 24",
        coordenadas: { lat: 39.47425, lng: -0.37895 },
        imagen: 'fotos_Av1/22_iglesia_san_juan_del_mercado.jpg',
    },
    {
        parada: 28, // ‚Üê Parada 28 (Iglesia de los Santos Juanes) (367) Reto 25 //
        tipo: "parada",
        nombre: "Iglesia de los Santos Juanes reto 25",
        coordenadas: { lat: 39.47425, lng: -0.37895 },
        imagen: 'fotos_Av1/22_iglesia_san_juan_del_mercado.jpg',
    },
    {
        tramo: 18, // ‚Üê tramo 18 (Iglesia Santos Juanes ‚Üí Lonja) (368, 369, 28, 370, 371, 372, 373, 374, 375, 376, 377) //
        tipo: "tramo",
        nombre: "Iglesia Santos Juanes ‚Üí Lonja de Val√®ncia (Mercado de la Seda)",
        inicio: { lat: 39.47425, lng: -0.37895 },
        waypoints: [],
        fin: { lat: 39.47426, lng: -0.37862 },
        imagen: 'fotos_Av1/23_lonja.jpg',
        video: 'videos/parada_19.mp4',
    },
    {
        parada: 29, // ‚Üê Parada 29 (Lonja Puerta de Los Pecados barquero) (378, 379) 26 Puzzle Lonja, Reto 27 //
        tipo: "parada",
        nombre: "Lonja Puerta de Los Pecados barquero",
        coordenadas: { lat: 39.4742, lng: -0.37851 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        parada: 30, // ‚Üê Parada 30 (Lonja Puerta de Los Pecados √°rbol muerto) (380, 381) Reto 28 //
        tipo: "parada",
        nombre: "Lonja Puerta de Los Pecados √°rbol muerto",
        coordenadas: { lat: 39.4742, lng: -0.37851 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        tramo: 19, // ‚Üê tramo 19 (Lonja G√°rgolas) (383) //
        tipo: "tramo",
        nombre: "Lonja G√°rgolas",
        inicio: { lat: 39.4742, lng: -0.37851 },
        waypoints: [],
        fin: { lat: 39.4742, lng: -0.37881 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        parada: 31, // ‚Üê Parada 31 (Lonja G√°rgolas √°ngel vasija) (384) Reto 29 //
        tipo: "parada",
        nombre: "Lonja G√°rgolas √°ngel vasija",
        coordenadas: { lat: 39.4742, lng: -0.37881 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        parada: 32, // ‚Üê Parada 32 (Lonja G√°rgolas barbudo y le√≥n) (385) Reto 30 //
        tipo: "parada",
        nombre: "Lonja G√°rgolas barbudo y le√≥n",
        coordenadas: { lat: 39.4742, lng: -0.37881 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        parada: 33, // ‚Üê Parada 33 (Lonja G√°rgolas fornicador ventana) (386) Reto 31 //
        tipo: "parada",
        nombre: "Lonja G√°rgolas fornicador ventana",
        coordenadas: { lat: 39.47439, lng: -0.37887 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        tramo: 20, // ‚Üê tramo 20 (Lonja ‚Üí Plaza del Doctor Collado) (388, 389, 390, 391, 392) //
        tipo: "tramo",
        nombre: "Lonja ‚Üí Plaza del Doctor Collado",
        inicio: { lat: 39.47426, lng: -0.37862 },
        waypoints: [
            { lat: 39.47445, lng: -0.37889 },
            { lat: 39.47459, lng: -0.37868 },
            { lat: 39.47475, lng: -0.37842 },
            { lat: 39.47436, lng: -0.37799 }
        ],
        fin: { lat: 39.47444, lng: -0.3779 },
        imagen: 'fotos_Av1/24_lonja2.jpg',
        video: 'videos/tramo_20.mp4',
    },
    {
        tramo: 21, // ‚Üê tramo 21 (Plaza del Doctor Collado ‚Üí Plaza del Negrito) (333, 397, 41, 398, 198, 671, 522, 32-C) //
        tipo: "tramo",
        nombre: "Plaza del Doctor Collado ‚Üí Plaza del Negrito (Fuente del Negrito)",
        inicio: { lat: 39.47444, lng: -0.3779 },
        waypoints: [
            { lat: 39.47473, lng: -0.37763 },
            { lat: 39.47493, lng: -0.37761 },
            { lat: 39.47559, lng: -0.37772 }
        ],
        fin: { lat: 39.47611, lng: -0.37741 },
        imagen: 'fotos_Av1/25_fuente_del_negrito.jpg',
        video: 'videos/parada_21.mp4',
    },
    {
        parada: 34, // ‚Üê Parada 34 (Fuente del Negrito) (382, 501) Reto 32 //
        tipo: "parada",
        nombre: "Fuente del Negrito",
        coordenadas: { lat: 39.47611, lng: -0.37741 },
        imagen: 'fotos_Av1/25_fuente_del_negrito.jpg',
    },
    {
        tramo: 22, // ‚Üê tramo 22 (Plaza del Negrito ‚Üí Calle Caballeros) (33-B, 486, 480-B) //
        tipo: "tramo",
        nombre: "Plaza del Negrito ‚Üí Calle Caballeros",
        inicio: { lat: 39.47611, lng: -0.37741 },
        waypoints: [
            { lat: 39.47663, lng: -0.3773 },
            { lat: 39.47661, lng: -0.37685 }
        ],
        fin: { lat: 39.47668, lng: -0.37671 },
        imagen: 'fotos_Av1/26_palau_de_la_generalitat.jpg',
        video: 'videos/parada_22.mp4',
    },
    {
        parada: 35, // ‚Üê Parada 35 (Palau de la Generalitat) (481-B, 482-B, 2-D) //
        tipo: "parada",
        nombre: "Palau de la Generalitat",
        coordenadas: { lat: 39.47668, lng: -0.37671 },
        imagen: 'fotos_Av1/26_palau_de_la_generalitat.jpg',
    },
    {
        tramo: 23, // ‚Üê tramo 23 (Palacio de la Generalitat ‚Üí Calle de los Serranos - FINAL) //
        tipo: "tramo",
        nombre: "Palacio de la Generalitat ‚Üí Calle de los Serranos (FINAL)",
        inicio: { lat: 39.47668, lng: -0.37671 },
        waypoints: [
            { lat: 39.47661, lng: -0.37685 },
            { lat: 39.47687, lng: -0.37686 }
        ],
        fin: { lat: 39.47773, lng: -0.37671 },
        imagen: 'fotos_Av1/00_torres_de_serranos_back.jpg',
        video: 'videos/parada_24.mp4',
    },
    {
        parada: 36, // ‚Üê Parada 36 (Torres de Serranos Final) (audio despedida) //
        tipo: "parada",
        nombre: "Torres de Serranos Final",
        coordenadas: { lat: 39.47773, lng: -0.37671 },
        imagen: 'fotos_Av1/00_torres_de_serranos_back.jpg',
    }
];

           

        // Variables globales
        let ubicacionActual = null;
        let paradaActual = 0; // ‚Üê Ahora empieza en parada 0 (inicio)
        let watchId = null;
        let modoCasa = false;

        // Variables para la barra de progreso
        let totalTripTime = 330; // 5:30 en segundos por defecto
        let tripElapsedTime = 0;
        let tripProgressInterval;
        let isDraggingProgress = false;

        // Referencias a elementos DOM
        const btnGps = document.getElementById('btn-gps');
        const btnImagen = document.getElementById('btn-imagen');
        const btnVideo = document.getElementById('btn-video');
        const status = document.getElementById('status');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const elapsedTimeSpan = document.getElementById('elapsedTime');
        const totalTimeSpan = document.getElementById('totalTime');

        // ================ FUNCIONES DE BARRA DE PROGRESO ================
        
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function updateTripProgressBar() {
            if (totalTripTime > 0) {
                const progress = (tripElapsedTime / totalTripTime) * 100;
                progressBar.style.width = `${progress}%`;
                elapsedTimeSpan.textContent = formatTime(tripElapsedTime);
            }
        }

        function startTripProgressSimulation() {
            clearInterval(tripProgressInterval);
            tripProgressInterval = setInterval(() => {
                if (!isDraggingProgress && tripElapsedTime < totalTripTime) {
                    tripElapsedTime++;
                    updateTripProgressBar();
                } else if (tripElapsedTime >= totalTripTime) {
                    clearInterval(tripProgressInterval);
                }
            }, 1000);
        }

        function resetTripProgress() {
            clearInterval(tripProgressInterval);
            tripElapsedTime = 0;
            progressBar.style.width = '0%';
            elapsedTimeSpan.textContent = '00:00';
            updateTripProgressBar();
        }

        // Funcionalidad de arrastre de la barra de progreso
        function seek(e) {
            if (totalTripTime === 0) return;

            const rect = progressContainer.getBoundingClientRect();
            let clickX = e.clientX - rect.left;

            if (e.touches && e.touches.length > 0) {
                clickX = e.touches[0].clientX - rect.left;
            }

            let newTime = (clickX / rect.width) * totalTripTime;
            newTime = Math.max(0, Math.min(newTime, totalTripTime));

            tripElapsedTime = newTime;
            updateTripProgressBar();

            if (watchId) {
                startTripProgressSimulation();
            }
        }

        // Event listeners para la barra de progreso
        progressContainer.addEventListener('mousedown', (e) => {
            isDraggingProgress = true;
            seek(e);
            clearInterval(tripProgressInterval);
        });

        progressContainer.addEventListener('mousemove', (e) => {
            if (isDraggingProgress) {
                seek(e);
            }
        });

        progressContainer.addEventListener('mouseup', () => {
            isDraggingProgress = false;
            if (watchId) {
                startTripProgressSimulation();
            }
        });

        progressContainer.addEventListener('touchstart', (e) => {
            isDraggingProgress = true;
            seek(e);
            clearInterval(tripProgressInterval);
        });

        progressContainer.addEventListener('touchmove', (e) => {
            if (isDraggingProgress) {
                seek(e);
            }
        });

        progressContainer.addEventListener('touchend', () => {
            isDraggingProgress = false;
            if (watchId) {
                startTripProgressSimulation();
            }
        });

        // ================== FUNCIONES DE UTILIDAD ==================
        function calcularDistancia(lat1, lng1, lat2, lng2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lng2-lng1) * Math.PI/180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                    Math.cos(œÜ1) * Math.cos(œÜ2) *
                    Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distancia en metros
        }

        function actualizarStatus(mensaje, loading = false) {
            // Enviar mensaje al padre para mostrar en ventana flotante
            window.parent.postMessage({
                tipo: 'statusMensaje',
                mensaje: mensaje,
                loading: loading
            }, '*');
            
            console.log(`üì± HIJO 2: Status enviado al padre - ${mensaje} ${loading ? '(loading)' : ''}`);
        }

        function activarBoton(boton) {
            boton.classList.remove('disabled');
            boton.classList.add('activo');
        }

        function desactivarBoton(boton) {
            boton.classList.add('disabled');
            boton.classList.remove('activo');
        }

        function activarTodosBotones() {
            // En modo casa, NO activar GPS - solo imagen y video
            if (modoCasa) {
                activarBoton(btnImagen);
                activarBoton(btnVideo);
                // GPS permanece desactivado en modo casa
                actualizarStatus('Modo Casa - Botones imagen y video activados');
            } else {
                // En modo aventura, activar todos los botones incluyendo GPS
                activarBoton(btnGps);
                activarBoton(btnImagen);
                activarBoton(btnVideo);
                actualizarStatus('Todos los botones activados');
            }
        }

        function desactivarTodosBotones() {
            desactivarBoton(btnGps);
            desactivarBoton(btnImagen);
            desactivarBoton(btnVideo);
        }

        // ================== FUNCIONES GPS ==================
        
        // Verificar permisos de geolocalizaci√≥n antes de usar GPS
        async function verificarPermisosGPS() {
            if (!navigator.permissions) {
                return 'unknown'; // Navegador antiguo
            }
            
            try {
                const permissionStatus = await navigator.permissions.query({name: 'geolocation'});
                return permissionStatus.state; // 'granted', 'denied', 'prompt'
            } catch (error) {
                console.warn('No se pudieron verificar permisos GPS:', error);
                return 'unknown';
            }
        }
        
        function iniciarGPS() {
            // Verificar protocolo HTTPS en producci√≥n
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                actualizarStatus('GPS requiere HTTPS en producci√≥n');
                console.warn('Geolocalizaci√≥n requiere HTTPS en producci√≥n');
                return;
            }

            if (!navigator.geolocation) {
                actualizarStatus('GPS no disponible en este dispositivo');
                return;
            }

            actualizarStatus('Obteniendo ubicaci√≥n GPS...', true);
            
            // Iniciar simulaci√≥n de progreso cuando se activa GPS
            resetTripProgress();
            totalTimeSpan.textContent = formatTime(totalTripTime);
            startTripProgressSimulation();

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            };

            // Obtener ubicaci√≥n inicial
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    ubicacionActual = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // Enviar ubicaci√≥n al padre
                    enviarMensajeAlPadre({
                        tipo: 'actualizarUbicacionMapa',
                        lat: ubicacionActual.lat,
                        lng: ubicacionActual.lng
                    });

                    actualizarStatus(`GPS activo - Precisi√≥n: ${Math.round(position.coords.accuracy)}m`);
                    verificarLlegadaAParada();
                },
                (error) => {
                    console.error('Error GPS:', error);
                    let mensajeError = 'Error al obtener ubicaci√≥n GPS';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            mensajeError = 'Permisos GPS denegados. Act√≠valos en configuraci√≥n.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            mensajeError = 'Ubicaci√≥n GPS no disponible';
                            break;
                        case error.TIMEOUT:
                            mensajeError = 'Tiempo de espera GPS agotado';
                            break;
                    }
                    
                    actualizarStatus(mensajeError);
                    
                    // En caso de error, activar modo casa autom√°ticamente
                    setTimeout(() => {
                        if (!ubicacionActual) {
                            actualizarStatus('Activando modo sin GPS...');
                            activarModoCasa();
                        }
                    }, 3000);
                },
                options
            );

            // Comenzar seguimiento continuo
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    ubicacionActual = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // Enviar ubicaci√≥n actualizada al padre
                    enviarMensajeAlPadre({
                        tipo: 'actualizarUbicacionMapa',
                        lat: ubicacionActual.lat,
                        lng: ubicacionActual.lng
                    });

                    verificarLlegadaAParada();
                },
                (error) => {
                    console.error('Error GPS tracking:', error);
                    
                    // Solo mostrar error si no tenemos ubicaci√≥n previa
                    if (!ubicacionActual) {
                        let mensajeError = 'Error en seguimiento GPS';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                mensajeError = 'Permisos GPS revocados';
                                activarModoCasa(); // Cambiar autom√°ticamente a modo casa
                                break;
                            case error.POSITION_UNAVAILABLE:
                                mensajeError = 'GPS temporalmente no disponible';
                                break;
                            case error.TIMEOUT:
                                mensajeError = 'Conexi√≥n GPS lenta';
                                break;
                        }
                        
                        actualizarStatus(mensajeError);
                    }
                },
                options
            );
        }

        function detenerGPS() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            ubicacionActual = null;
            
            // Detener y resetear progreso cuando se desactiva GPS
            clearInterval(tripProgressInterval);
            resetTripProgress();
            
            actualizarStatus('GPS desactivado');
        }

        function verificarLlegadaAParada() {
            // En modo casa, no verificar llegada a paradas
            if (modoCasa) return;
            
            if (!ubicacionActual || paradaActual > 24) return; // ‚Üê Ahora hasta parada 24 (0-24 = 25 paradas totales)

            // Buscar la parada actual por n√∫mero
            const paradaDestino = COORDENADAS_PARADAS.find(p => p.parada === paradaActual);
            if (!paradaDestino) return;

            const distancia = calcularDistancia(
                ubicacionActual.lat, ubicacionActual.lng,
                paradaDestino.lat, paradaDestino.lng
            );

            const RADIO_LLEGADA = 50; // 50 metros de radio

            if (distancia <= RADIO_LLEGADA) {
                actualizarStatus(`¬°Has llegado a la parada ${paradaActual}!`);
                activarTodosBotones();
                
                // Notificar al padre que hemos llegado
                enviarMensajeAlPadre({
                    tipo: 'ya-estoy-aqui',
                    parada: paradaActual
                });
            } else {
                actualizarStatus(`Distancia a parada ${paradaActual}: ${Math.round(distancia)}m`);
            }
        }

        // ================== FUNCIONES DE NAVEGACI√ìN ==================
        async function obtenerRuta(origen, destino) {
            try {
                // Simular obtenci√≥n de ruta (en una implementaci√≥n real usar√≠as una API de routing)
                return [
                    { lat: origen.lat, lng: origen.lng },
                    { lat: destino.lat, lng: destino.lng }
                ];
            } catch (error) {
                console.error('Error obteniendo ruta:', error);
                return null;
            }
        }

        async function navegarDeAB(origenIndex, destinoIndex) {
            if (!ubicacionActual) {
                actualizarStatus('Necesitas activar GPS primero');
                return;
            }

            // Buscar origen y destino por n√∫mero de parada
            const origen = origenIndex !== undefined ? 
                COORDENADAS_PARADAS.find(p => p.parada === origenIndex) : ubicacionActual;
            const destino = COORDENADAS_PARADAS.find(p => p.parada === destinoIndex);

            if (!destino) {
                console.error('Destino no v√°lido');
                return;
            }

            actualizarStatus('Calculando ruta...', true);
            
            const ruta = await obtenerRuta(origen, destino);
            
            if (ruta) {
                enviarMensajeAlPadre({
                    tipo: 'mostrar-mapa-gps',
                    ruta: ruta,
                    origen: origen,
                    destino: destino
                });
                
                paradaActual = destinoIndex;
                actualizarStatus(`Navegando a parada ${destinoIndex}`);
            } else {
                actualizarStatus('Error calculando ruta');
            }
        }

        // ================== EVENTOS DE BOTONES ==================
        btnGps.addEventListener('click', async () => {
            if (btnGps.classList.contains('disabled')) return;
            
            // En modo casa, el GPS est√° desactivado
            if (modoCasa) {
                actualizarStatus('GPS desactivado en modo casa');
                return;
            }
            
            // Verificar permisos antes de iniciar GPS
            const permisos = await verificarPermisosGPS();
            if (permisos === 'denied') {
                actualizarStatus('Permisos GPS denegados. Revisa configuraci√≥n del navegador.');
                return;
            }
            
            // Si no hay ubicaci√≥n actual, iniciar GPS primero
            if (!ubicacionActual) {
                iniciarGPS();
                return;
            }
            
            // Bot√≥n 1: GPS - Navegaci√≥n de punto A a punto B
            const paradaDestino = COORDENADAS_PARADAS.find(p => p.parada === paradaActual);
            
            if (paradaDestino) {
                actualizarStatus(`Navegando a parada ${paradaActual}...`);
                
                // Enviar mensaje al padre para mostrar navegaci√≥n GPS
                enviarMensajeAlPadre({
                    tipo: 'mostrar-navegacion-gps',
                    paradaActual: paradaActual,
                    coordenadasDestino: paradaDestino,
                    ubicacionUsuario: ubicacionActual
                });
            }
        });

        btnImagen.addEventListener('click', () => {
            if (btnImagen.classList.contains('disabled')) return;
            
            // Bot√≥n 2: Mostrar imagen de la parada actual
            const paradaInfo = COORDENADAS_PARADAS.find(p => p.parada === paradaActual);
            
            if (paradaInfo && paradaInfo.imagen) {
                if (modoCasa) {
                    actualizarStatus(`Modo Casa - Imagen parada ${paradaActual}`);
                } else {
                    actualizarStatus(`Mostrando imagen de parada ${paradaActual}`);
                }
                
                enviarMensajeAlPadre({
                    tipo: 'mostrar-imagen',
                    parada: paradaActual,           // ‚Üê N√∫mero de parada directo
                    imagenSrc: paradaInfo.imagen,   // ‚Üê Propiedad imagen directa
                    paradaNombre: paradaInfo.nombre,
                    modoCasa: modoCasa
                });
            }
        });

        btnVideo.addEventListener('click', () => {
            if (btnVideo.classList.contains('disabled')) return;
            
            // Bot√≥n 3: Zoom-in 2 segundos y luego mostrar video
            const paradaInfo = COORDENADAS_PARADAS.find(p => p.parada === paradaActual);
            
            if (paradaInfo && paradaInfo.video) {
                if (modoCasa) {
                    actualizarStatus(`Modo Casa - Video parada ${paradaActual}`);
                } else {
                    actualizarStatus(`Preparando video de parada ${paradaActual}...`);
                }
                
                // En modo casa, mostrar video directamente sin zoom
                if (modoCasa) {
                    enviarMensajeAlPadre({
                        tipo: 'mostrar-video',
                        parada: paradaActual,
                        videoSrc: paradaInfo.video,    // ‚Üê Propiedad video directa
                        autoplay: true,
                        modoCasa: true
                    });
                } else {
                    // Modo aventura: primero zoom, luego video
                    enviarMensajeAlPadre({
                        tipo: 'mostrar-zoom-coordenadas',
                        coordenadas: paradaInfo,
                        parada: paradaActual
                    });
                    
                    setTimeout(() => {
                        enviarMensajeAlPadre({
                            tipo: 'mostrar-video',
                            parada: paradaActual,
                            videoSrc: paradaInfo.video,   // ‚Üê Propiedad video directa
                            autoplay: true,
                            modoCasa: false
                        });
                        
                        actualizarStatus(`Reproduciendo video de parada ${paradaActual}`);
                    }, 2000);
                }
            }
        });

        // ================== COMUNICACI√ìN CON EL PADRE ==================
        function enviarMensajeAlPadre(mensaje) {
            try {
                window.parent.postMessage(mensaje, '*');
                console.log('Mensaje enviado al padre:', mensaje.tipo || mensaje.type);
            } catch (error) {
                console.error('Error enviando mensaje al padre:', error);
                actualizarStatus('Error de comunicaci√≥n con el padre');
            }
        }
        
        // ================== COMUNICACI√ìN CON EL HIJO 5 (Av1-boton-casa.html) ==================
        function enviarMensajeAHijo5(mensaje) {
            // Enviar mensaje espec√≠ficamente al hijo 5 a trav√©s del padre
            enviarMensajeAlPadre({
                tipo: 'mensaje-para-hijo5',
                mensaje: mensaje
            });
        }
        
        function enviarEstadoModoAHijo5() {
            enviarMensajeAHijo5({
                tipo: 'estado-modo-actual',
                modoCasa: modoCasa,
                paradaActual: paradaActual
            });
        }
        
        // ================== FUNCIONES DE MODO CASA/AVENTURA ==================
        function activarModoCasa() {
            modoCasa = true;
            
            // Desactivar GPS cuando se activa modo casa
            detenerGPS();
            desactivarBoton(btnGps);
            
            // Activar botones foto y video en modo casa
            activarBoton(btnImagen);
            activarBoton(btnVideo);
            
            // Resetear progreso en modo casa
            clearInterval(tripProgressInterval);
            resetTripProgress();
            
            actualizarStatus('Modo Casa activado - GPS desactivado');
            
            // Notificar al padre del cambio de modo
            enviarMensajeAlPadre({
                tipo: 'modo-casa-activado',
                modoCasa: true
            });
            
            // Confirmar al hijo 5 que el modo casa est√° activo
            enviarMensajeAHijo5({
                tipo: 'confirmacion-modo-casa',
                activo: true
            });
        }
        
        function activarModoAventura() {
            modoCasa = false;
            
            // En modo aventura, el comportamiento depende de si hemos llegado a una parada
            if (ubicacionActual) {
                verificarLlegadaAParada();
            } else {
                // Si no hay ubicaci√≥n, todos los botones est√°n desactivados
                desactivarTodosBotones();
            }
            
            actualizarStatus('Modo Aventura activado - GPS disponible');
            
            // Notificar al padre del cambio de modo
            enviarMensajeAlPadre({
                tipo: 'modo-aventura-activado',
                modoCasa: false
            });
            
            // Confirmar al hijo 5 que el modo aventura est√° activo
            enviarMensajeAHijo5({
                tipo: 'confirmacion-modo-aventura',
                activo: true
            });
        }

        // Escuchar mensajes del padre
        window.addEventListener('message', (event) => {
            const data = event.data;
            
            // El padre nos dice en qu√© parada estamos
            if (data && data.tipo === 'actualizar-parada-actual') {
                paradaActual = data.parada;
                actualizarStatus(`Parada actual: ${paradaActual}`); // ‚Üê N√∫meros directos 0-24
            }
            
            // El padre activa el bot√≥n GPS (rojo ‚Üí verde)
            if (data && data.tipo === 'activar-boton-gps') {
                activarBoton(btnGps);
                actualizarStatus('GPS activado - Listo para navegar');
            }
            
            // El padre activa el bot√≥n de imagen (rojo ‚Üí verde)
            if (data && data.tipo === 'activar-boton-imagen') {
                activarBoton(btnImagen);
                actualizarStatus('Bot√≥n imagen activado');
            }
            
            // El padre activa el bot√≥n de video (rojo ‚Üí verde)
            if (data && data.tipo === 'activar-boton-video') {
                activarBoton(btnVideo);
                actualizarStatus('Bot√≥n video activado');
            }
            
            // NUEVO: Modo casa - activar solo imagen y video, NO GPS
            if (data && data.tipo === 'activar-modo-casa-botones') {
                activarBoton(btnImagen);
                activarBoton(btnVideo);
                // GPS permanece desactivado en modo casa
                desactivarBoton(btnGps);
                actualizarStatus('Modo Casa - Botones imagen y video activados');
                console.log('üè† HIJO 2: Modo casa activado - Solo imagen y video habilitados');
            }
            
            // El padre activa todos los botones
            if (data && data.tipo === 'activar-todos-botones') {
                activarTodosBotones();
                actualizarStatus('Todos los botones activados');
            }
            
            // El padre desactiva todos los botones
            if (data && data.tipo === 'desactivar-todos-botones') {
                desactivarTodosBotones();
                actualizarStatus('Esperando activaci√≥n...');
            }
            
            // Actualizar ubicaci√≥n del usuario
            if (data && data.tipo === 'actualizar-ubicacion-usuario') {
                ubicacionActual = {
                    lat: data.lat,
                    lng: data.lng
                };
            }
            
            // ========== MENSAJES DEL HIJO 5 (Av1-boton-casa.html) ==========
            
            // El hijo 5 nos informa que el bot√≥n casa fue activado
            if (data && data.tipo === 'boton-casa-activado') {
                activarModoCasa();
            }
            
            // El hijo 5 nos informa que el bot√≥n casa fue desactivado
            if (data && data.tipo === 'boton-casa-desactivado') {
                activarModoAventura();
            }
            
            // El hijo 5 solicita el estado actual del modo
            if (data && data.tipo === 'solicitar-estado-modo') {
                enviarEstadoModoAHijo5();
            }
        });

        // ================== INICIALIZACI√ìN ==================
        document.addEventListener('DOMContentLoaded', () => {
            // Todos los botones empiezan desactivados (fondo rojo)
            desactivarTodosBotones();
            
            // Inicializar barra de progreso
            totalTimeSpan.textContent = formatTime(totalTripTime);
            resetTripProgress();
            
            actualizarStatus('Pulsa GPS para obtener tu ubicaci√≥n');
            
            // Notificar al hijo 5 el estado inicial (modo aventura)
            setTimeout(() => {
                enviarEstadoModoAHijo5();
            }, 1000);
        });
    </script>
</body>
</html>
