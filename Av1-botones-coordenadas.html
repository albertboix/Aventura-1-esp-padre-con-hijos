<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Botones y Coordenadas GPS (Hijo 2)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            /* Variables de dise√±o para botones y barra de progreso */
            --btn-size: 80px;
            --icon-size: 2.7em;
            --progress-thick: 25px; /* GROSOR DE LA BARRA DE PROGRESO UNIFORME CON HIJO 3 */
            --timer-font-size: 1.3em;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: transparent !important; /* Fondo del iframe transparente */
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: transparent !important; /* Fondo del iframe transparente */
            overflow: hidden; /* Evita scroll dentro del iframe */
            display: flex;
            flex-direction: column; /* Coloca los elementos en columna */
            align-items: center; /* Centra horizontalmente */
            justify-content: flex-start; /* Alinea los elementos arriba del contenedor */
        }

        /* Contenedor principal con la forma trapezoidal invertida (corta arriba, larga abajo) */
        .gps-controls-container {
            width: 100%; /* Ocupa el ancho completo del iframe */
            height: 100%; /* Ocupa el alto completo del iframe */
            background: white; /* Fondo del trapecio blanco */
            border-radius: 18px; /* Mantener bordes redondeados */
            box-shadow: 0 2px 12px rgba(0,0,0,0.13);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around; /* Distribuye espacio entre elementos */
            padding: 5px 10px 5px 10px; /* Ejemplo: 2px arriba, 10px derecha, 5px abajo, 10px izquierda */
            box-sizing: border-box; /* Incluye padding en el ancho/alto */

            /* === CLAVE PARA LA FORMA TRAPEZOIDAL INVERTIDA (corta arriba, larga abajo) === */
            clip-path: polygon(0% 0%, 100% 0%, 92% 100%, 8% 100%);
        }

        /* Barra de Progreso */
        .progress-container {
            width: 90%;
            height: var(--progress-thick);
            background-color: #e0e0e0; /* Gris */
            border-radius: calc(var(--progress-thick) / 2);
            overflow: hidden;
            margin-top: 5px; /* Peque√±o margen superior */
            margin-bottom: 5px; /* Peque√±o margen inferior */
            position: relative;
            cursor: pointer; /* Indicar que es interactiva */
        }

        .progress-bar {
            height: 100%;
            width: 0%; /* Se actualizar√° con JS */
            background: linear-gradient(90deg, #007bff, #00c6ff); /* Degradado azul */
            border-radius: calc(var(--progress-thick) / 2);
            transition: none; /* Eliminar transici√≥n para permitir arrastre suave */
        }

        .time-display {
            width: 90%;
            display: flex;
            justify-content: space-between;
            color: #333;
            font-size: var(--timer-font-size);
            margin-bottom: 0px; /* MENOS PADDING ENTRE BOTONES Y BARRA */
            margin-top: 5x; /* Margen superior para separarlo de la parte superior del trapecio */
        }

        .coordenadas-display {
            color: #333;
            font-size: 0.9em;
            text-align: center;
            margin-top: 5px; /* Peque√±o margen superior */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 95%; /* Asegura que no se desborde */
        }

        .buttons-row {
            display: flex;
            gap: 15px; /* Espacio entre botones */
            justify-content: center;
            align-items: center;
            flex-wrap: wrap; /* Permite que los botones se envuelvan en pantallas peque√±as */
            margin-top: 5px; /* MENOS PADDING ENTRE BOTONES Y BARRA (ajustado para que los botones no est√©n pegados a las coordenadas) */
        }

        .control-button {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(90deg, #0077cc 0%, #00aaff 100%);
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            flex-shrink: 0; /* Evita que el bot√≥n se encoja */
        }

        .control-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .control-button:active:not(:disabled) {
            transform: scale(0.95);
        }

        /* Estilo para los botones cuando est√°n bloqueados/desbloqueados */
        .btn-locked {
            background: linear-gradient(90deg, #ff3b30 0%, #ff5c5c 100%); /* Rojo - Bloqueado */
        }
        .btn-unlocked {
            background: linear-gradient(90deg, #34c759 0%, #43e97b 100%); /* Verde - Desbloqueado */
        }
        .btn-route-active {
            background: linear-gradient(90deg, #007bff 0%, #00c6ff 100%); /* Azul - Ruta activa */
        }
        .btn-photo-active {
            background: linear-gradient(90deg, #ff9500 0%, #ffcc00 100%); /* Naranja - Foto activa */
        }
        .btn-video-active {
            background: linear-gradient(90deg, #5856d6 0%, #6464ff 100%); /* Morado - Video activo */
        }

        /* Media queries para pantallas peque√±as (mantiene la coherencia con Hijo 3) */
        @media (max-width: 500px) {
            :root {
                --btn-size: 48px;
                --icon-size: 1.5em;
            }
            .coordenadas-display {
                font-size: 0.75em;
            }
            .buttons-row {
                gap: 10px;
            }
            .time-display {
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="gps-controls-container">
        <div class="time-display">
            <span id="elapsedTime">00:00</span>
            <span id="totalTime">00:00</span>
        </div>
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="coordenadas-display" id="coordenadasDisplay">Esperando GPS...</div>
        <div class="buttons-row">
            <button id="routeBtn" class="control-button btn-locked" title="Mostrar Ruta" disabled>
                üõ∞Ô∏è
            </button>
            <button id="photoBtn" class="control-button btn-locked" title="Ver Foto" disabled>
                üì∏
            </button>
            <button id="videoBtn" class="control-button btn-locked" title="Ver Video" disabled>
                üìΩÔ∏è
            </button>
        </div>
    </div>

    <script>
        const coordenadasDisplay = document.getElementById('coordenadasDisplay');
        const routeBtn = document.getElementById('routeBtn');
        const photoBtn = document.getElementById('photoBtn');
        const videoBtn = document.getElementById('videoBtn');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const elapsedTimeSpan = document.getElementById('elapsedTime');
        const totalTimeSpan = document.getElementById('totalTime');

        let watchId = null; // ID del observador de geolocalizaci√≥n
        let isGpsActive = false;
        let currentTargetParadaIndex = null; // √çndice de la parada objetivo actual
        let currentParadaInfo = null; // Guarda la info completa de la parada actual
        let buttonsUnlocked = false; // Estado de los botones (bloqueados/desbloqueados)

        // Simulaci√≥n de tiempo para la barra de progreso (ej. tiempo restante para llegar a la parada)
        let totalTripTime = 0; // Duraci√≥n total del viaje simulado en segundos
        let tripElapsedTime = 0; // Tiempo transcurrido del viaje simulado en segundos
        let tripProgressInterval;
        let isDraggingProgress = false; // Estado para el arrastre

        // Definici√≥n de PARADAS (actualizada con las coordenadas correctas y medios)
        const PARADAS_COORDENADAS = [
            // Parada 0
            { lat: 39.47876, lng: -0.37626, nombre: "Torres de Serranos (start)", foto: "torres_serranos.jpg", video: "torres_serranos.mp4" },
            // Parada 1
            { lat: 39.47959, lng: -0.37583, nombre: "Puente de Serranos ‚Äì Plaza de la crida", foto: "puente_serranos.jpg", video: "puente_serranos.mp4" },
            // Parada 2
            { lat: 39.47785, lng: -0.37485, nombre: "Cortes Valencianas (Palacio de los Borgia)", foto: "cortes_valencianas.jpg", video: "cortes_valencianas.mp4" },
            // Parada 3
            { lat: 39.47656, lng: -0.37529, nombre: "Plaza de la Virgen", foto: "plaza_virgen.jpg", video: "plaza_virgen.mp4" },
            // Parada 4
            { lat: 39.47604, lng: -0.37451, nombre: "Plaza de la Almo√≠na", foto: "plaza_almoina.jpg", video: "plaza_almoina.mp4" },
            // Parada 5
            { lat: 39.47594, lng: -0.37474, nombre: "Catedral de Val√®ncia", foto: "catedral_valencia.jpg", video: "catedral_valencia.mp4" },
            // Parada 6
            { lat: 39.4762, lng: -0.37412, nombre: "Plaza decimo Juno Bruto (Museo Arqueol√≥gico de la Almo√≠na)", foto: "plaza_juno_bruto.jpg", video: "plaza_juno_bruto.mp4" },
            // Parada 7
            { lat: 39.47611, lng: -0.37478, nombre: "Bas√≠lica de Val√®ncia", foto: "basilica_valencia.jpg", video: "basilica_valencia.mp4" },
            // Parada 8
            { lat: 39.4755, lng: -0.37436, nombre: "Palacio Arzobispal", foto: "palacio_arzobispal.jpg", video: "palacio_arzobispal.mp4" },
            // Parada 9
            { lat: 39.47056, lng: -0.37677, nombre: "Plaza del Ayuntamiento", foto: "plaza_ayuntamiento.jpg", video: "plaza_ayuntamiento.mp4" },
            // Parada 10
            { lat: 39.46971, lng: -0.37693, nombre: "Edificio del Ayuntamiento de Val√®ncia", foto: "edificio_ayuntamiento.jpg", video: "edificio_ayuntamiento.mp4" },
            // Parada 11
            { lat: 39.46722, lng: -0.37702, nombre: "Estaci√≥n de Ferrocarril (Estaci√≥n del Norte)", foto: "estacion_norte.jpg", video: "estacion_norte.mp4" },
            // Parada 12
            { lat: 39.46709, lng: -0.37595, nombre: "Plaza de Toros de Val√®ncia", foto: "plaza_toros.jpg", video: "plaza_toros.mp4" },
            // Parada 13
            { lat: 39.46753, lng: -0.37511, nombre: "Casa estilo √Årabe", foto: "casa_arabe.jpg", video: "casa_arabe.mp4" },
            // Parada 14
            { lat: 39.46942, lng: -0.37559, nombre: "Palacio de Comunicaciones (Correos)", foto: "palacio_comunicaciones.jpg", video: "palacio_comunicaciones.mp4" },
            // Parada 15
            { lat: 39.47061, lng: -0.37408, nombre: "Antigua sede del Banco de Val√®ncia", foto: "banco_valencia.jpg", video: "banco_valencia.mp4" },
            // Parada 16
            { lat: 39.47276, lng: -0.37467, nombre: "Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cr√°mica)", foto: "palacio_dos_aguas.jpg", video: "palacio_dos_aguas.mp4" },
            // Parada 17
            { lat: 39.47377, lng: -0.37832, nombre: "Mercado Central", foto: "mercado_central.jpg", video: "mercado_central.mp4" },
            // Parada 18
            { lat: 39.47425, lng: -0.37895, nombre: "San Juan del Mercado (Iglesia de los Santos Juanes)", foto: "san_juan_mercado.jpg", video: "san_juan_mercado.mp4" },
            // Parada 19
            { lat: 39.47426, lng: -0.37862, nombre: "Lonja de Val√®ncia (Mercado de la Seda)", foto: "lonja_valencia.jpg", video: "lonja_valencia.mp4" },
            // Parada 20
            { lat: 39.47444, lng: -0.3779, nombre: "Plaza del Doctor Collado", foto: "plaza_doctor_collado.jpg", video: "plaza_doctor_collado.mp4" },
            // Parada 21
            { lat: 39.47611, lng: -0.37741, nombre: "Plaza del Negrito (Fuente del Negrito)", foto: "plaza_negrito.jpg", video: "plaza_negrito.mp4" },
            // Parada 22
            { lat: 39.47663, lng: -0.3773, nombre: "Calle Caballeros", foto: "calle_caballeros.jpg", video: "calle_caballeros.mp4" },
            // Parada 23
            { lat: 39.47668, lng: -0.37671, nombre: "Palacio de la Generalitat", foto: "palacio_generalitat.jpg", video: "palacio_generalitat.mp4" },
            // Parada 24
            { lat: 39.47773, lng: -0.37671, nombre: "Calle de los Serranos (end)", foto: "calle_serranos_end.jpg", video: "calle_serranos_end.mp4" }
        ];

        // Trayectos con waypoints organizados por paradas
        const TRAYECTOS_COORDENADAS = {
            // Parada 0 a Parada 1: Torres de Serranos a Puente de Serranos ‚Äì Plaza de la crida
            "0-1": {
                inicio: { lat: 39.47876, lng: -0.37626 },
                waypoints: [
                    { lat: 39.47905, lng: -0.37613 },
                    { lat: 39.47933, lng: -0.37647 },
                    { lat: 39.47943, lng: -0.37636 }
                ],
                fin: { lat: 39.47959, lng: -0.37583 }
            },
            // Parada 1 a Parada 2: Puente de Serranos ‚Äì Plaza de la crida a Cortes Valencianas (Palacio de los Borgia)
            "1-2": {
                inicio: { lat: 39.47959, lng: -0.37583 },
                waypoints: [
                    { lat: 39.47939, lng: -0.3752 },
                    { lat: 39.47902, lng: -0.37465 },
                    { lat: 39.47866, lng: -0.3747 }
                ],
                fin: { lat: 39.47785, lng: -0.37485 }
            },
            // Parada 2 a Parada 3: Cortes Valencianas (Palacio de los Borgia) a Plaza de la Virgen
            "2-3": {
                inicio: { lat: 39.47785, lng: -0.37485 },
                waypoints: [
                    { lat: 39.47768, lng: -0.3749 }
                ],
                fin: { lat: 39.47656, lng: -0.37529 }
            },
            // Parada 3 a Parada 4: Plaza de la Virgen a Plaza de la Almo√≠na
            "3-4": {
                inicio: { lat: 39.47656, lng: -0.37529 },
                waypoints: [
                    { lat: 39.4766, lng: -0.37473 },
                    { lat: 39.47656, lng: -0.37453 },
                    { lat: 39.47606, lng: -0.3746 }
                ],
                fin: { lat: 39.47604, lng: -0.37451 }
            },
            // Parada 4 a Parada 5: Plaza de la Almo√≠na a Catedral de Val√®ncia
            "4-5": {
                inicio: { lat: 39.47604, lng: -0.37451 },
                waypoints: [],
                fin: { lat: 39.47594, lng: -0.37474 }
            },
            // Parada 5 a Parada 6: Catedral de Val√®ncia a Plaza decimo Juno Bruto (Museo Arqueol√≥gico de la Almo√≠na)
            "5-6": {
                inicio: { lat: 39.47594, lng: -0.37474 },
                waypoints: [],
                fin: { lat: 39.4762, lng: -0.37412 }
            },
            // Parada 6 a Parada 7: Plaza decimo Juno Bruto (Museo Arqueol√≥gico de la Almo√≠na) a Bas√≠lica de Val√®ncia
            "6-7": {
                inicio: { lat: 39.4762, lng: -0.37412 },
                waypoints: [],
                fin: { lat: 39.47611, lng: -0.37478 }
            },
            // Parada 7 a Parada 8: Bas√≠lica de Val√®ncia a Palacio Arzobispal
            "7-8": {
                inicio: { lat: 39.47611, lng: -0.37478 },
                waypoints: [
                    { lat: 39.47603, lng: -0.37433 }
                ],
                fin: { lat: 39.4755, lng: -0.37436 }
            },
            // Parada 8 a Parada 9: Palacio Arzobispal a Plaza del Ayuntamiento
            "8-9": {
                inicio: { lat: 39.4755, lng: -0.37436 },
                waypoints: [
                    { lat: 39.4756, lng: -0.37466 },
                    { lat: 39.47514, lng: -0.37494 },
                    { lat: 39.47447, lng: -0.3754 },
                    { lat: 39.47378, lng: -0.3756 },
                    { lat: 39.47212, lng: -0.37676 }
                ],
                fin: { lat: 39.47056, lng: -0.37677 }
            },
            // Parada 9 a Parada 10: Plaza del Ayuntamiento a Edificio del Ayuntamiento de Val√®ncia
            "9-10": {
                inicio: { lat: 39.47056, lng: -0.37677 },
                waypoints: [],
                fin: { lat: 39.46971, lng: -0.37693 }
            },
            // Parada 10 a Parada 11: Edificio del Ayuntamiento de Val√®ncia a Estaci√≥n de Ferrocarril (Estaci√≥n del Norte)
            "10-11": {
                inicio: { lat: 39.46971, lng: -0.37693 },
                waypoints: [
                    { lat: 39.46795, lng: -0.37701 }
                ],
                fin: { lat: 39.46722, lng: -0.37702 }
            },
            // Parada 11 a Parada 12: Estaci√≥n de Ferrocarril (Estaci√≥n del Norte) a Plaza de Toros de Val√®ncia
            "11-12": {
                inicio: { lat: 39.46722, lng: -0.37702 },
                waypoints: [],
                fin: { lat: 39.46709, lng: -0.37595 }
            },
            // Parada 12 a Parada 13: Plaza de Toros de Val√®ncia a Casa estilo √Årabe
            "12-13": {
                inicio: { lat: 39.46709, lng: -0.37595 },
                waypoints: [
                    { lat: 39.46714, lng: -0.37498 }
                ],
                fin: { lat: 39.46753, lng: -0.37511 }
            },
            // Parada 13 a Parada 14: Casa estilo √Årabe a Palacio de Comunicaciones (Correos)
            "13-14": {
                inicio: { lat: 39.46753, lng: -0.37511 },
                waypoints: [],
                fin: { lat: 39.46942, lng: -0.37559 }
            },
            // Parada 14 a Parada 15: Palacio de Comunicaciones (Correos) a Antigua sede del Banco de Val√®ncia
            "14-15": {
                inicio: { lat: 39.46942, lng: -0.37559 },
                waypoints: [
                    { lat: 39.4699, lng: -0.37573 },
                    { lat: 39.4703, lng: -0.3759 },
                    { lat: 39.47039, lng: -0.37505 },
                    { lat: 39.47043, lng: -0.37427 }
                ],
                fin: { lat: 39.47061, lng: -0.37408 }
            },
            // Parada 15 a Parada 16: Antigua sede del Banco de Val√®ncia a Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cr√°mica)
            "15-16": {
                inicio: { lat: 39.47061, lng: -0.37408 },
                waypoints: [
                    { lat: 39.47119, lng: -0.37423 },
                    { lat: 39.47214, lng: -0.37446 },
                    { lat: 39.47275, lng: -0.37445 }
                ],
                fin: { lat: 39.47276, lng: -0.37467 }
            },
            // Parada 16 a Parada 17: Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cr√°mica) a Mercado Central
            "16-17": {
                inicio: { lat: 39.47276, lng: -0.37467 },
                waypoints: [
                    { lat: 39.47315, lng: -0.37608 },
                    { lat: 39.47261, lng: -0.37654 },
                    { lat: 39.47225, lng: -0.37686 },
                    { lat: 39.47265, lng: -0.37725 }
                ],
                fin: { lat: 39.47377, lng: -0.37832 }
            },
            // Parada 17 a Parada 18: Mercado Central a San Juan del Mercado (Iglesia de los Santos Juanes)
            "17-18": {
                inicio: { lat: 39.47377, lng: -0.37832 },
                waypoints: [],
                fin: { lat: 39.47425, lng: -0.37895 }
            },
            // Parada 18 a Parada 19: San Juan del Mercado (Iglesia de los Santos Juanes) a Lonja de Val√®ncia (Mercado de la Seda)
            "18-19": {
                inicio: { lat: 39.47425, lng: -0.37895 },
                waypoints: [],
                fin: { lat: 39.47426, lng: -0.37862 }
            },
            // Parada 19 a Parada 20: Lonja de Val√®ncia (Mercado de la Seda) a Plaza del Doctor Collado
            "19-20": {
                inicio: { lat: 39.47426, lng: -0.37862 },
                waypoints: [
                    { lat: 39.47445, lng: -0.37889 },
                    { lat: 39.47459, lng: -0.37868 },
                    { lat: 39.47475, lng: -0.37842 },
                    { lat: 39.47436, lng: -0.37799 }
                ],
                fin: { lat: 39.47444, lng: -0.3779 }
            },
            // Parada 20 a Parada 21: Plaza del Doctor Collado a Plaza del Negrito (Fuente del Negrito)
            "20-21": {
                inicio: { lat: 39.47444, lng: -0.3779 },
                waypoints: [
                    { lat: 39.47473, lng: -0.37763 },
                    { lat: 39.47493, lng: -0.37761 },
                    { lat: 39.47559, lng: -0.37772 }
                ],
                fin: { lat: 39.47611, lng: -0.37741 }
            },
            // Parada 21 a Parada 22: Plaza del Negrito (Fuente del Negrito) a Calle Caballeros
            "21-22": {
                inicio: { lat: 39.47611, lng: -0.37741 },
                waypoints: [],
                fin: { lat: 39.47663, lng: -0.3773 }
            },
            // Parada 22 a Parada 23: Calle Caballeros a Palacio de la Generalitat
            "22-23": {
                inicio: { lat: 39.47663, lng: -0.3773 },
                waypoints: [
                    { lat: 39.47661, lng: -0.37685 }
                ],
                fin: { lat: 39.47668, lng: -0.37671 }
            },
            // Parada 23 a Parada 24: Palacio de la Generalitat a Calle de los Serranos (end)
            "23-24": {
                inicio: { lat: 39.47668, lng: -0.37671 },
                waypoints: [
                    { lat: 39.47661, lng: -0.37685 },
                    { lat: 39.47687, lng: -0.37686 }
                ],
                fin: { lat: 39.47773, lng: -0.37671 }
            }
        };

        // Rango de proximidad para activar la parada (en metros)
        const PROXIMITY_RADIUS_METERS = 20; // Ajusta seg√∫n sea necesario

        // Funciones auxiliares
        function toRadians(deg) {
            return deg * (Math.PI / 180);
        }

        // Calcula la distancia entre dos puntos Lat/Lng usando la f√≥rmula Haversine
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Metros
            const œÜ1 = toRadians(lat1);
            const œÜ2 = toRadians(lat2);
            const ŒîœÜ = toRadians(lat2 - lat1);
            const ŒîŒª = toRadians(lon2 - lon1);

            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const distance = R * c;
            return distance;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function updateTripProgressBar() {
            if (totalTripTime > 0) {
                const progress = (tripElapsedTime / totalTripTime) * 100;
                progressBar.style.width = `${progress}%`;
                elapsedTimeSpan.textContent = formatTime(tripElapsedTime);
            }
        }

        function startTripProgressSimulation() {
            clearInterval(tripProgressInterval);
            tripProgressInterval = setInterval(() => {
                if (!isDraggingProgress && tripElapsedTime < totalTripTime) { // Solo avanza si no se est√° arrastrando
                    tripElapsedTime++;
                    updateTripProgressBar();
                } else if (tripElapsedTime >= totalTripTime) {
                    clearInterval(tripProgressInterval);
                    // Opcional: acciones al finalizar el "viaje"
                }
            }, 1000); // Actualiza cada segundo
        }

        function resetTripProgress() {
            clearInterval(tripProgressInterval);
            tripElapsedTime = 0;
            totalTripTime = 0;
            progressBar.style.width = '0%';
            elapsedTimeSpan.textContent = '00:00';
            totalTimeSpan.textContent = '00:00';
        }

        // --- Funciones de control de botones ---
        function unlockButtons() {
            console.log('=== HIJO2: DESBLOQUEANDO BOTONES ===');
            buttonsUnlocked = true;
            routeBtn.disabled = false;
            photoBtn.disabled = false;
            videoBtn.disabled = false;
            
            routeBtn.classList.remove('btn-locked');
            photoBtn.classList.remove('btn-locked');
            videoBtn.classList.remove('btn-locked');
            
            routeBtn.classList.add('btn-unlocked');
            photoBtn.classList.add('btn-unlocked');
            videoBtn.classList.add('btn-unlocked');
            
            // Enviar confirmaci√≥n al padre
            window.parent.postMessage({
                tipo: 'test-respuesta',
                mensaje: 'Botones desbloqueados correctamente en hijo2'
            }, '*');
        }

        function lockButtons() {
            buttonsUnlocked = false;
            routeBtn.disabled = true;
            photoBtn.disabled = true;
            videoBtn.disabled = true;
            
            routeBtn.classList.remove('btn-unlocked', 'btn-route-active');
            photoBtn.classList.remove('btn-unlocked', 'btn-photo-active');
            videoBtn.classList.remove('btn-unlocked', 'btn-video-active');
            
            routeBtn.classList.add('btn-locked');
            photoBtn.classList.add('btn-locked');
            videoBtn.classList.add('btn-locked');
        }

        function resetButtonStates() {
            if (buttonsUnlocked) {
                routeBtn.classList.remove('btn-route-active');
                photoBtn.classList.remove('btn-photo-active');
                videoBtn.classList.remove('btn-video-active');
                
                routeBtn.classList.add('btn-unlocked');
                photoBtn.classList.add('btn-unlocked');
                videoBtn.classList.add('btn-unlocked');
            }
        }

        // --- Funcionalidades de los botones ---
        
        // Bot√≥n 1: Mostrar ruta en el mapa (üõ∞Ô∏è)
        routeBtn.addEventListener('click', () => {
            if (!buttonsUnlocked) return;
            
            resetButtonStates();
            routeBtn.classList.remove('btn-unlocked');
            routeBtn.classList.add('btn-route-active');
            
            if (currentTargetParadaIndex !== null && PARADAS_COORDENADAS[currentTargetParadaIndex]) {
                // Crear ruta con waypoints desde parada actual a destino
                const currentParada = currentTargetParadaIndex > 0 ? PARADAS_COORDENADAS[currentTargetParadaIndex - 1] : null;
                const targetParada = PARADAS_COORDENADAS[currentTargetParadaIndex];
                const trayectoKey = currentTargetParadaIndex > 0 ? `${currentTargetParadaIndex - 1}-${currentTargetParadaIndex}` : '0-1';
                const trayecto = TRAYECTOS_COORDENADAS[trayectoKey];
                
                let ruta = [];
                if (trayecto) {
                    ruta.push(trayecto.inicio);
                    ruta = ruta.concat(trayecto.waypoints);
                    ruta.push(trayecto.fin);
                } else {
                    // Si no hay trayecto definido, usar solo origen y destino
                    if (currentParada) ruta.push(currentParada);
                    ruta.push(targetParada);
                }
                
                // Enviar mensaje al padre para mostrar ruta con polyline y chinchetas
                window.parent.postMessage({
                    tipo: 'mostrar-ruta-con-chinchetas',
                    ruta: ruta,
                    origen: currentParada || targetParada, // Chincheta verde (usuario)
                    destino: targetParada, // Chincheta roja (destino)
                    nombre: targetParada.nombre
                }, '*');
                
                coordenadasDisplay.textContent = `Ruta mostrada a: ${targetParada.nombre}`;
            } else {
                alert('No hay parada objetivo seleccionada.');
            }
        });

        // Bot√≥n 2: Mostrar foto (üì∏)
        photoBtn.addEventListener('click', () => {
            if (!buttonsUnlocked) return;
            
            resetButtonStates();
            photoBtn.classList.remove('btn-unlocked');
            photoBtn.classList.add('btn-photo-active');
            
            if (currentTargetParadaIndex !== null && PARADAS_COORDENADAS[currentTargetParadaIndex]) {
                const paradaData = PARADAS_COORDENADAS[currentTargetParadaIndex];
                
                // Enviar mensaje al padre para mostrar imagen
                window.parent.postMessage({
                    tipo: 'mostrar-imagen',
                    info: paradaData
                }, '*');
                
                coordenadasDisplay.textContent = `Mostrando foto: ${paradaData.nombre}`;
            } else {
                alert('No hay parada objetivo seleccionada.');
            }
        });

        // Bot√≥n 3: Mostrar video (üìΩÔ∏è)
        videoBtn.addEventListener('click', () => {
            if (!buttonsUnlocked) return;
            
            resetButtonStates();
            videoBtn.classList.remove('btn-unlocked');
            videoBtn.classList.add('btn-video-active');
            
            if (currentTargetParadaIndex !== null && PARADAS_COORDENADAS[currentTargetParadaIndex]) {
                const paradaData = PARADAS_COORDENADAS[currentTargetParadaIndex];
                
                // Enviar mensaje al padre para mostrar video
                window.parent.postMessage({
                    tipo: 'mostrar-video',
                    info: paradaData
                }, '*');
                
                coordenadasDisplay.textContent = `Mostrando video: ${paradaData.nombre}`;
            } else {
                alert('No hay parada objetivo seleccionada.');
            }
        });

        // Funcionalidad de arrastre de la barra de progreso
        function seek(e) {
            if (totalTripTime === 0) return; // No hacer nada si no hay duraci√≥n

            const rect = progressContainer.getBoundingClientRect();
            let clickX = e.clientX - rect.left; // Posici√≥n X del clic/arrastre dentro del contenedor

            // Manejar touch events
            if (e.touches && e.touches.length > 0) {
                clickX = e.touches[0].clientX - rect.left;
            }

            let newTime = (clickX / rect.width) * totalTripTime;

            // Asegurarse de que el tiempo no exceda la duraci√≥n ni sea negativo
            newTime = Math.max(0, Math.min(newTime, totalTripTime));

            tripElapsedTime = newTime;
            updateTripProgressBar();

            // Si se est√° reproduciendo, reanudar la simulaci√≥n de progreso desde el nuevo tiempo
            // (En este caso, si el GPS est√° activo, reanudamos la simulaci√≥n)
            if (isGpsActive) {
                startTripProgressSimulation();
            }
        }

        progressContainer.addEventListener('mousedown', (e) => {
            isDraggingProgress = true;
            seek(e); // Ajustar inmediatamente al clic inicial
            // Pausar la simulaci√≥n de avance para evitar conflictos
            clearInterval(tripProgressInterval);
        });

        progressContainer.addEventListener('mousemove', (e) => {
            if (isDraggingProgress) {
                seek(e);
            }
        });

        progressContainer.addEventListener('mouseup', () => {
            isDraggingProgress = false;
            // Reanudar la simulaci√≥n de avance solo si el GPS est√° activo
            if (isGpsActive) {
                startTripProgressSimulation();
            }
        });

        // Para eventos t√°ctiles
        progressContainer.addEventListener('touchstart', (e) => {
            isDraggingProgress = true;
            seek(e);
            clearInterval(tripProgressInterval);
        });

        progressContainer.addEventListener('touchmove', (e) => {
            if (isDraggingProgress) {
                seek(e);
            }
        });

        progressContainer.addEventListener('touchend', () => {
            isDraggingProgress = false;
            if (isGpsActive) {
                startTripProgressSimulation();
            }
        });


        // --- Listener para mensajes del padre ---
        window.addEventListener('message', (event) => {
            console.log('=== HIJO2 RECIBI√ì MENSAJE ===');
            console.log('Origen:', event.origin);
            console.log('Datos:', event.data);
            
            const data = event.data;
            
            // Mensaje para navegar de una parada a otra
            if (data && data.tipo === 'navegar-de-a-b') {
                if (PARADAS_COORDENADAS[data.destino]) {
                    currentTargetParadaIndex = data.destino; // Establece el objetivo como la siguiente parada
                    currentParadaInfo = PARADAS_COORDENADAS[data.destino];
                    coordenadasDisplay.textContent = `Pr√≥xima parada: ${data.destino + 1} - ${currentParadaInfo.nombre}`;
                    resetTripProgress(); // Reiniciar progreso al establecer nueva ruta
                } else {
                    currentTargetParadaIndex = null;
                    currentParadaInfo = null;
                    coordenadasDisplay.textContent = 'Aventura Finalizada';
                    resetTripProgress();
                }
            }
            
            // Mensaje para activar todos los botones (cambiar de rojo a verde)
            if (data && data.tipo === 'activar-todos-botones') {
                unlockButtons();
            }
            
            // Mensaje para activar modo casa (bloquear botones)
            if (data && data.tipo === 'activar-modo-casa') {
                lockButtons();
                coordenadasDisplay.textContent = 'Modo Casa Activo';
            }
            
            // Mensaje para iniciar GPS hacia una parada espec√≠fica
            if (data && data.tipo === 'iniciar-gps-a-parada') {
                currentTargetParadaIndex = 0; // Empezar por la primera parada
                currentParadaInfo = PARADAS_COORDENADAS[0];
                unlockButtons(); // Desbloquear botones al iniciar aventura
                coordenadasDisplay.textContent = `Aventura iniciada - ${data.paradaDestinoNombre}`;
            }
        });

        // Inicializaci√≥n: Botones bloqueados por defecto
        lockButtons();
        coordenadasDisplay.textContent = 'Esperando inicio de aventura...';
    </script>
</body>
</html>
