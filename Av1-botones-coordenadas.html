<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Botones y Coordenadas GPS</title>
    <style>
        :root {
            /* Variables de dise√±o para botones y barra de progreso */
            --btn-size: 60px;
            --icon-size: 1.5em;
        }

        body {
            margin: 0;
            padding: 5px;
            background: transparent;
            font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif; /* IGUALADO: Misma fuente elegante que hijo3 */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        /* Contenedor principal con la forma trapezoidal (ancho arriba, estrecho abajo) */
        .container {
            width: 290px; /* AJUSTADO: Reducido de 340px a 290px, igualado con hijo3 */
            height: 155px; /* Altura aumentada para incluir m√°rgenes */
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.13);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            padding: 5px 8px;
            box-sizing: border-box;
            margin: 5px 0;
            clip-path: polygon(0% 0%, 100% 0%, 92% 100%, 8% 100%);
        }

        /* Contenedor de botones de navegaci√≥n */
        .nav-buttons-container {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .nav-button {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            color: white;
            font-size: var(--icon-size);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                       transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                       box-shadow 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* Ensure all navigation buttons stay green */
        #btn-punto, #btn-ruta, #btn-brujula {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .nav-button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .botones-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin: 2px 0;
        }

        .boton {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            font-size: var(--icon-size);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                       background 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                       transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                       box-shadow 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            flex-shrink: 0;
        }

        .boton.activo {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            box-shadow: 0 3px 8px rgba(40, 167, 69, 0.3);
        }

        .boton:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }

        .boton.activo:hover {
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .boton:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.1s ease;
        }

        .boton.disabled {
            background: linear-gradient(135deg, #dc3545, #c82333);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .boton.activo {
            animation: subtle-pulse 2s infinite;
        }

        @keyframes subtle-pulse {
            0%, 100% { box-shadow: 0 3px 8px rgba(40, 167, 69, 0.3); }
            50% { box-shadow: 0 3px 8px rgba(40, 167, 69, 0.5); }
        }

        .boton.transitioning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);
        }

        .boton.disabled:hover {
            transform: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
        }

        /* Estilos para los iconos */
        .icon-gps {
            font-size: var(--icon-size);
        }
        
        .icon-imagen {
            font-size: var(--icon-size);
        }
        
        .icon-video {
            font-size: var(--icon-size);
        }

        .status {
            margin: 2px 0;
            padding: 3px;
            background: white;
            border-radius: 5px;
            font-size: 10px;
            text-align: center;
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 90%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .gps-icon {
            width: 16px;
            height: 16px;
            margin-right: 5px;
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @media (max-width: 500px) {
            body { padding: 2px; }
            .container {
                width: 98vw;
                height: 155px;
            }
            .progress-container { margin: 1px 0; }
            .time-display { margin: 1px 0; }
            .botones-row { gap: 8px; margin: 1px 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-buttons-container">
            <button id="btn-punto" class="nav-button" title="Punto de inter√©s">üìç</button>
            <button id="btn-ruta" class="nav-button" title="Ver ruta">üó∫Ô∏è</button>
            <button id="btn-brujula" class="nav-button" title="Br√∫jula">üß≠</button>
        </div>
        <div class="botones-row">
            <button id="btn-gps" class="boton">
                <span class="icon-gps">üõ∞Ô∏è</span>
            </button>
            <button id="btn-imagen" class="boton disabled">
                <span class="icon-imagen">üì∏</span>
            </button>
            <button id="btn-video" class="boton disabled">
                <span class="icon-video">üìΩÔ∏è</span>
            </button>
        </div>

        <div class="status" id="status" style="display: none;">
            <!-- Mensaje flotante ahora ser√° manejado por el padre -->
        </div>
    </div>

    <script>
        // ================== COORDENADAS DE LAS PARADAS ==================
       
    const COORDENADAS_PARADAS = [
  // ‚Üê Parada 0 ‚Äì INICIO (223, 226, 228, 229) reto 2 //
  {
    tipo: "inicio",
    id: "P-0",
    parada: 0,
    nombre: "Torres de Serranos (start)",
    coordenadas: { lat: 39.47876, lng: -0.37626 },
    imagen: 'fotos_Av1/00_torres_de_serranos_back.jpg',
    video: 'videos/parada_0.mp4',
  },
  // ‚Üê tramo 1 (Torres de Serranos ‚Üí Plaza de la crida) (2, 126,) //
  {
    tipo: "tramo",
    id: "TR-1",
    tramo: 1,
    nombre: "Torres de Serranos ‚Üí Plaza de la crida (Puente de Serranos)",
    inicio: { lat: 39.47876, lng: -0.37626 },
    waypoints: [
      { lat: 39.47905, lng: -0.37613 },
      { lat: 39.47933, lng: -0.37647 },
      { lat: 39.47943, lng: -0.37636 }
    ],
    fin: { lat: 39.47959, lng: -0.37583 },
    imagen: 'fotos_Av1/01_torres_de_serranos_front.jpg',
    video: 'videos/tramo_1.mp4',
  },
  // ‚Üê Parada 1 - Plaza de la crida (Puente de Serranos) (233) Reto 3 //
  {
    tipo: "parada",
    id: "P-1",
    parada: 1,
    nombre: "Plaza de la crida (Puente de Serranos)",
    coordenadas: { lat: 39.47959, lng: -0.37583 },
    imagen: 'fotos_Av1/01_torres_de_serranos_front.jpg',
  },
  // ‚Üê tramo 2 (Plaza de la crida ‚Üí Calle Muro de Santa Ana) (81) //
  {
    tipo: "tramo",
    id: "TR-2",
    tramo: 2,
    nombre: "Plaza de la crida ‚Üí Calle Muro de Santa Ana",
    inicio: { lat: 39.47959, lng: -0.37583 },
    waypoints: [
      { lat: 39.47939, lng: -0.3752 },
      { lat: 39.47902, lng: -0.37465 },
      { lat: 39.47866, lng: -0.3747 }
    ],
    fin: { lat: 39.47866, lng: -0.3747 },
    imagen: 'muro de Santa ana.jpg',
    video: 'videos/tramo 2_2.mp4',
  },
  // ‚Üê Parada 2 (Calle Muro de Santa Ana) (68) Reto 4 //
  {
    tipo: "parada",
    id: "P-2",
    parada: 2,
    nombre: "Calle Muro de Santa Ana",
    coordenadas: { lat: 39.47866, lng: -0.3747 },
    imagen: 'muro de Santa ana.jpg',
  },
  // ‚Üê tramo 3 (Calle Muro de Santa Ana ‚Üí Palacio de los Borgia) (52) //
  {
    tipo: "tramo",
    id: "TR-3",
    tramo: 3,
    nombre: "Calle Muro de Santa Ana ‚Üí Palacio de los Borgia",
    inicio: { lat: 39.47866, lng: -0.3747 },
    waypoints: [],
    fin: { lat: 39.47768, lng: -0.3749 },
    imagen: 'fotos_Av1/02_cortes_valencianas.jpg',
    video: 'videos/tramo_3.mp4',
  },
  // ‚Üê Parada 3 (Iglesia de San Lorenzo) (686, 682-B, 462, 683, 684) Reto 5 //
  {
    tipo: "parada",
    id: "P-3",
    parada: 3,
    nombre: "Iglesia de San Lorenzo",
    coordenadas: { lat: 39.47768, lng: -0.3749 },
    imagen: 'fotos_Av1/03_iglesia_de_san_lorenzo.jpg',
  },
  // ‚Üê tramo 4 (Iglesia de San Lorenzo ‚Üí Plaza de la Virgen) (465-B) //
  {
    tipo: "tramo",
    id: "TR-4",
    tramo: 4,
    nombre: "Iglesia de San Lorenzo ‚Üí Plaza de la Virgen",
    inicio: { lat: 39.47768, lng: -0.3749 },
    waypoints: [],
    fin: { lat: 39.47656, lng: -0.37529 },
    imagen: 'fotos_Av1/04_plaza_de_la_virgen.jpg',
    video: 'videos/tramo_4.mp4',
  },
  // ‚Üê Parada 4 (Plaza de la Virgen) (466, 467) Reto 6 //
  {
    tipo: "parada",
    id: "P-4",
    parada: 4,
    nombre: "Plaza de la Virgen Reto 6",
    coordenadas: { lat: 39.47656, lng: -0.37529 },
    imagen: 'fotos_Av1/04_plaza_de_la_virgen.jpg',
  },
  // ‚Üê Parada 5 (Plaza de la Virgen) (468) Reto 7, 8 Puzzle plaza de la virgen //
  {
    tipo: "parada",
    id: "P-5",
    parada: 5,
    nombre: "Plaza de la Virgen Reto 7",
    coordenadas: { lat: 39.47656, lng: -0.37529 },
    imagen: 'fotos_Av1/04_plaza_de_la_virgen.jpg',
  },
  // ‚Üê tramo 5 (Plaza de la Virgen ‚Üí Plaza de la Almo√≠na) (477-B, 479, 141, 83, 8-C) //
  {
    tipo: "tramo",
    id: "TR-5",
    tramo: 5,
    nombre: "Plaza de la Virgen ‚Üí Plaza de la Almo√≠na",
    inicio: { lat: 39.47656, lng: -0.37529 },
    waypoints: [
      { lat: 39.4766, lng: -0.37473 },
      { lat: 39.47656, lng: -0.37453 },
      { lat: 39.47606, lng: -0.3746 }
    ],
    fin: { lat: 39.47604, lng: -0.37451 },
    imagen: 'fotos_Av1/05_plaza_de_la_almoina.jpg',
    video: 'videos/tramo_5.mp4',
  },
  // ‚Üê Parada 6 (Panel cer√°mico muro Catedral) (434, 440, 441, 442) Reto 9 //
  {
    tipo: "parada",
    id: "P-6",
    parada: 6,
    nombre: "Panel cer√°mico muro Catedral",
    coordenadas: { lat: 39.47604, lng: -0.37451 },
    imagen: 'fotos_Av1/06_panel_ceramico_muro_norte_catedral.jpg',
  },
  // ‚Üê Parada 7 (Capilla exterior catedral) (443, 444, 445) Reto 10 //
  {
    tipo: "parada",
    id: "P-7",
    parada: 7,
    nombre: "Capilla exterior catedral Reto 10",
    coordenadas: { lat: 39.47604, lng: -0.37451 },
    imagen: 'fotos_Av1/07!!!_capilla_exterior_catedral.jpg',
  },
  // ‚Üê Parada 8 (Capilla exterior catedral) (445) Reto 11 //
  {
    tipo: "parada",
    id: "P-8",
    parada: 8,
    nombre: "Capilla exterior catedral Reto 11",
    coordenadas: { lat: 39.47604, lng: -0.37451 },
    imagen: 'fotos_Av1/07!!!_capilla_exterior_catedral.jpg',
  },
  // ‚Üê Parada 9 (Arco Novo Catedral y Puerta Negra Bas√≠lica) (446, 355, 447, 11-B, 451, 452) //
  {
    tipo: "parada",
    id: "P-9",
    parada: 9,
    nombre: "Arco Novo Catedral y Puerta Negra Bas√≠lica",
    coordenadas: { lat: 39.47604, lng: -0.37451 },
    imagen: 'fotos_Av1/08_arco_novo_catedral.jpg',
    imagen2: 'fotos_Av1/09_puerta_negra_relieve_basilica.jpg',
  },
  // ‚Üê Parada 10 (Casa del Punt de Gantxo) (51-C, 354, 455, 455-B, 456) reto 12 //
  {
    tipo: "parada",
    id: "P-10",
    parada: 10,
    nombre: "Casa del Punt de Gantxo",
    coordenadas: { lat: 39.47604, lng: -0.37451 },
    imagen: 'fotos_Av1/10_casa_del_punt_de_gantxo.jpg',
  },
  // ‚Üê tramo 6 (Plaza de la Almo√≠na ‚Üí Plaza Decimo Junio Bruto) (457, 10-B) //
  {
    tipo: "tramo",
    id: "TR-6",
    tramo: 6,
    nombre: "Plaza de la Almo√≠na ‚Üí Plaza Decimo Junio Bruto (Museo Arqueol√≥gico de la Almo√≠na)",
    inicio: { lat: 39.47594, lng: -0.37478 },
    waypoints: [],
    fin: { lat: 39.4762, lng: -0.37412 },
    imagen: 'fotos_Av1/05_plaza_de_la_almoina.jpg',
    video: 'videos/tramo_6.mp4',
  },
  // ‚Üê Parada 11 (Museo arqueol√≥gico La Almo√≠na) (458) Reto 13 //
  {
    tipo: "parada",
    id: "P-11",
    parada: 11,
    nombre: "Museo arqueol√≥gico La Almo√≠na",
    coordenadas: { lat: 39.4762, lng: -0.37412 },
    imagen: 'fotos_Av1/27_museo_la_almoina.jpg',
  },
  // ‚Üê Parada 12 (Museo arqueol√≥gico La Almo√≠na) (459, 460, 461) //
  {
    tipo: "parada",
    id: "P-12",
    parada: 12,
    nombre: "Museo arqueol√≥gico La Almo√≠na",
    coordenadas: { lat: 39.4762, lng: -0.37412 },
    imagen: 'fotos_Av1/27_museo_la_almoina.jpg',
  },
  // ‚Üê Parada 13 (Vista de la Catedral, Cimborrio) (8-C, 464) Reto14 //
  {
    tipo: "parada",
    id: "P-13",
    parada: 13,
    nombre: "Vista de la Catedral, Cimborrio",
    coordenadas: { lat: 39.4762, lng: -0.37412 },
    imagen: 'fotos_Av1/05_plaza_de_la_almoina.jpg',
  },
  // ‚Üê tramo 7 (Museo arqueol√≥gico La Almo√≠na ‚Üí Palacio Arzobispal) (85) //
  {
    tipo: "tramo",
    id: "TR-7",
    tramo: 7,
    nombre: "Museo arqueol√≥gico La Almo√≠na ‚Üí Palacio Arzobispal",
    inicio: { lat: 39.47611, lng: -0.37478 },
    waypoints: [
      { lat: 39.47604, lng: -0.37442 },
      { lat: 39.47584, lng: -0.37443 },
      { lat: 39.47561, lng: -0.37451 }
    ],
    fin: { lat: 39.4755, lng: -0.37436 },
    imagen: 'fotos_Av1/11_palacio_arzobispal.jpg',
    video: 'videos/parada_8.mp4',
  },
  // ‚Üê Parada 14 (Palacio Arzobispal y Puerta Rom√°nica de la Catedral) (673, 86, 426-B, 141, 437, 438) Reto 15 //
  {
    tipo: "parada",
    id: "P-14",
    parada: 14,
    nombre: "Palacio Arzobispal y Puerta Rom√°nica de la Catedral",
    coordenadas: { lat: 39.4755, lng: -0.37436 },
    imagen: 'fotos_Av1/12_puerta_romanica_catedral.jpg',
  },
  // ‚Üê Parada 15 (Puerta Rom√°nica de la Catedral) (439) //
  {
    tipo: "parada",
    id: "P-15",
    parada: 15,
    nombre: "Puerta Rom√°nica de la Catedral",
    coordenadas: { lat: 39.47561, lng: -0.37465 },
    imagen: 'fotos_Av1/12_puerta_romanica_catedral.jpg',
  },
  // ‚Üê tramo 8 (Puerta Rom√°nica de la Catedral ‚Üí Plaza del Ayuntamiento) (125) //
  {
    tipo: "tramo",
    id: "TR-8",
    tramo: 8,
    nombre: "Puerta Rom√°nica de la Catedral ‚Üí Plaza del Ayuntamiento",
    inicio: { lat: 39.47561, lng: -0.37465 },
    waypoints: [
      { lat: 39.4756, lng: -0.37466 },
      { lat: 39.47514, lng: -0.37494 },
      { lat: 39.47447, lng: -0.3754 },
      { lat: 39.47378, lng: -0.3756 },
      { lat: 39.47212, lng: -0.37676 }
    ],
    fin: { lat: 39.47056, lng: -0.37677 },
    imagen: 'fotos_Av1/13_plaza_del_ayuntamiento.jpg',
    video: 'videos/tramo_8.mp4',
  },
  // ‚Üê Parada 16 (Plaza del Ayuntamiento) (13-B, 263, 332, 14-C) //
  {
    tipo: "parada",
    id: "P-16",
    parada: 16,
    nombre: "Plaza del Ayuntamiento",
    coordenadas: { lat: 39.47056, lng: -0.37677 },
    imagen: 'fotos_Av1/13_plaza_del_ayuntamiento.jpg',
  },
  // ‚Üê tramo 9 (Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento) (334, 335) //
  {
    tipo: "tramo",
    id: "TR-9",
    tramo: 9,
    nombre: "Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento de Val√®ncia",
    inicio: { lat: 39.47056, lng: -0.37677 },
    waypoints: [],
    fin: { lat: 39.46971, lng: -0.37693 },
    imagen: 'fotos_Av1/14_ayuntamiento.jpg',
    video: 'videos/tramo_9.mp4',
  },
  // ‚Üê Parada 17 (Edificio del Ayuntamiento) (336, 337, 338) Reto 16 //
  {
    tipo: "parada",
    id: "P-17",
    parada: 17,
    nombre: "Edificio del Ayuntamiento",
    coordenadas: { lat: 39.46971, lng: -0.37693 },
    imagen: 'fotos_Av1/14_ayuntamiento.jpg',
  },
  // ‚Üê Parada 18 (Edificio del Ayuntamiento) (339, 340, 341, 54) //
  {
    tipo: "parada",
    id: "P-18",
    parada: 18,
    nombre: "Edificio del Ayuntamiento",
    coordenadas: { lat: 39.46971, lng: -0.37693 },
    imagen: 'fotos_Av1/14_ayuntamiento.jpg',
  },
  // ‚Üê tramo 10 (Edificio del Ayuntamiento ‚Üí Estaci√≥n del Norte) (87, 15-C) //
  {
    tipo: "tramo",
    id: "TR-10",
    tramo: 10,
    nombre: "Edificio del Ayuntamiento ‚Üí Estaci√≥n del Norte",
    inicio: { lat: 39.46971, lng: -0.37693 },
    waypoints: [
      { lat: 39.46795, lng: -0.37701 }
    ],
    fin: { lat: 39.46722, lng: -0.37702 },
    imagen: 'fotos_Av1/15_plaza_de_toros_y_estacion_del_norte.jpg',
    video: 'videos/tramo_10.mp4',
  },
  // ‚Üê Parada 19 (Estaci√≥n del Norte) (326) Reto 17, 18 Puzzle Estaci√≥n del Norte//
  {
    tipo: "parada",
    id: "P-19",
    parada: 19,
    nombre: "Estaci√≥n del Norte",
    coordenadas: { lat: 39.46722, lng: -0.37702 },
    imagen: 'fotos_Av1/15_plaza_de_toros_y_estacion_del_norte.jpg',
  },
  // ‚Üê tramo 11 (Estaci√≥n del Norte ‚Üí Plaza de Toros) (20-C, 323-B, 88) //
  {
    tipo: "tramo",
    id: "TR-11",
    tramo: 11,
    nombre: "Estaci√≥n del Norte ‚Üí Plaza de Toros de Val√®ncia",
    inicio: { lat: 39.46722, lng: -0.37702 },
    waypoints: [],
    fin: { lat: 39.46709, lng: -0.37595 },
    imagen: 'fotos_Av1/15_plaza_de_toros_y_estacion_del_norte.jpg',
    video: 'videos/tramo_11.mp4',
  },
  // ‚Üê Tramo 12 (Plaza de Toros ‚Üí Casa estilo √Årabe) (89, 3-D) //
  {
    tipo: "tramo",
    id: "TR-12",
    tramo: 12,
    nombre: "Plaza de Toros ‚Üí Casa estilo √Årabe",
    inicio: { lat: 39.46709, lng: -0.37595 },
    waypoints: [
      { lat: 39.46714, lng: -0.37498 }
    ],
    fin: { lat: 39.46753, lng: -0.37511 },
    imagen: 'fotos_Av1/16!!!!_casa_estilo_arabe.jpg',
    video: 'videos/parada_13.mp4',
  },
  // ‚Üê Parada 20 (Casa estilo √Årabe) (99) Reto 19 //
  {
    tipo: "parada",
    id: "P-20",
    parada: 20,
    nombre: "Casa estilo √Årabe",
    coordenadas: { lat: 39.46753, lng: -0.37511 },
    imagen: 'fotos_Av1/16!!!!_casa_estilo_arabe.jpg',
  },
  // ‚Üê Parada 21 (Casa estilo √Årabe, mitad Aventura) (100) //
  {
    tipo: "parada",
    id: "P-21",
    parada: 21,
    nombre: "Casa estilo √Årabe, mitad Aventura",
    coordenadas: { lat: 39.46753, lng: -0.37511 },
    imagen: 'fotos_Av1/16!!!!_casa_estilo_arabe.jpg',
  },
  // ‚Üê tramo 13 (Casa estilo √Årabe ‚Üí Palacio de Comunicaciones) (21-B) //
  {
    tipo: "tramo",
    id: "TR-13",
    tramo: 13,
    nombre: "Casa estilo √Årabe ‚Üí Palacio de Comunicaciones (Correos)",
    inicio: { lat: 39.46753, lng: -0.37511 },
    waypoints: [],
    fin: { lat: 39.46942, lng: -0.37559 },
    imagen: 'fotos_Av1/17_correos.jpg',
    video: 'videos/tramo_13.mp4',
  },
  // ‚Üê Parada 22 (Palacio de Comunicaciones: Correos) (700, 343, 344) Reto 20 //
  {
    tipo: "parada",
    id: "P-22",
    parada: 22,
    nombre: "Palacio de Comunicaciones: Correos",
    coordenadas: { lat: 39.46942, lng: -0.37559 },
    imagen: 'fotos_Av1/17_correos.jpg',
  },
  // ‚Üê Parada 23 (Edificio Suay) (693, 693-B) Reto 21 //
  {
    tipo: "parada",
    id: "P-23",
    parada: 23,
    nombre: "Edificio Suay",
    coordenadas: { lat: 39.46942, lng: -0.37559 },
    imagen: 'fotos_Av1/18_edificio_suay.jpg',
  },
  // ‚Üê tramo 14 (Palacio de Comunicaciones ‚Üí Banco de Val√®ncia) (345, 347, 348, 22) //
  {
    tipo: "tramo",
    id: "TR-14",
    tramo: 14,
    nombre: "Palacio de Comunicaciones ‚Üí Banco de Val√®ncia",
    inicio: { lat: 39.46942, lng: -0.37559 },
    waypoints: [
      { lat: 39.4699, lng: -0.37573 },
      { lat: 39.4703, lng: -0.3759 },
      { lat: 39.47039, lng: -0.37505 },
      { lat: 39.47043, lng: -0.37427 }
    ],
    fin: { lat: 39.47061, lng: -0.37408 },
    imagen: 'fotos_Av1/19_banco_de_valencia.jpg',
    video: 'videos/tramo_14.mp4',
  },
  // ‚Üê Parada 24 (Banco de Valencia) (349, 350) Reto 22 //
  {
    tipo: "parada",
    id: "P-24",
    parada: 24,
    nombre: "Banco de Valencia",
    coordenadas: { lat: 39.47061, lng: -0.37408 },
    imagen: 'fotos_Av1/19_banco_de_valencia.jpg',
  },
  // ‚Üê tramo 15 (Banco de Val√®ncia ‚Üí Palacio del Marqu√©s de Dos Aguas) (351, 23-B, 352, 354) //
  {
    tipo: "tramo",
    id: "TR-15",
    tramo: 15,
    nombre: "Banco de Val√®ncia ‚Üí Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica)",
    inicio: { lat: 39.47061, lng: -0.37408 },
    waypoints: [
      { lat: 39.47119, lng: -0.37423 },
      { lat: 39.47214, lng: -0.37446 },
      { lat: 39.47275, lng: -0.37445 }
    ],
    fin: { lat: 39.47276, lng: -0.37467 },
    imagen: 'fotos_Av1/20!!!!_marques_de_dos_aguas.jpg',
    video: 'videos/parada_16.mp4',
  },
  // ‚Üê Parada 25 (Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica) (356, 357) //
  {
    tipo: "parada",
    id: "P-25",
    parada: 25,
    nombre: "Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica)",
    coordenadas: { lat: 39.47276, lng: -0.37467 },
    imagen: 'fotos_Av1/20!!!!_marques_de_dos_aguas.jpg',
  },
  // ‚Üê tramo 16 (Palacio del Marqu√©s ‚Üí Mercado Central) (358, 359, 401) //
  {
    tipo: "tramo",
    id: "TR-16",
    tramo: 16,
    nombre: "Palacio del Marqu√©s ‚Üí Mercado Central",
    inicio: { lat: 39.47276, lng: -0.37467 },
    waypoints: [
      { lat: 39.47315, lng: -0.37608 },
      { lat: 39.47261, lng: -0.37654 },
      { lat: 39.47225, lng: -0.37686 },
      { lat: 39.47265, lng: -0.37725 }
    ],
    fin: { lat: 39.47377, lng: -0.37832 },
    imagen: 'fotos_Av1/21_mercado_central.jpg',
    video: 'videos/tramo_16.mp4',
  },
  // ‚Üê Parada 26 (Mercado central) (701, 24-D, 361, 362, 363, 364) Reto 23 //
  {
    tipo: "parada",
    id: "P-26",
    parada: 26,
    nombre: "Mercado central",
    coordenadas: { lat: 39.47377, lng: -0.37832 },
    imagen: 'fotos_Av1/21_mercado_central.jpg',
  },
  // ‚Üê tramo 17 (Mercado Central ‚Üí Iglesia Santos Juanes) (274, 27-C) //
  {
    tipo: "tramo",
    id: "TR-17",
    tramo: 17,
    nombre: "Mercado Central ‚Üí Iglesia de los Santos Juanes",
    inicio: { lat: 39.47377, lng: -0.37832 },
    waypoints: [],
    fin: { lat: 39.47425, lng: -0.37895 },
    imagen: 'fotos_Av1/22_iglesia_san_juan_del_mercado.jpg',
    video: 'videos/tramo_17.mp4',
  },
  // ‚Üê Parada 27 (Iglesia de los Santos Juanes) (365, 366) Reto 24 //
  {
    tipo: "parada",
    id: "P-27",
    parada: 27,
    nombre: "Iglesia de los Santos Juanes reto 24",
    coordenadas: { lat: 39.47425, lng: -0.37895 },
    imagen: 'fotos_Av1/22_iglesia_san_juan_del_mercado.jpg',
  },
  // ‚Üê Parada 28 (Iglesia de los Santos Juanes) (367) Reto 25 //
  {
    tipo: "parada",
    id: "P-28",
    parada: 28,
    nombre: "Iglesia de los Santos Juanes reto 25",
    coordenadas: { lat: 39.47425, lng: -0.37895 },
    imagen: 'fotos_Av1/22_iglesia_san_juan_del_mercado.jpg',
  },
  // ‚Üê tramo 18 (Iglesia Santos Juanes ‚Üí Lonja) (368, 369, 28, 370, 371, 372, 373, 374, 375, 376, 377) //
  {
    tipo: "tramo",
    id: "TR-18",
    tramo: 18,
    nombre: "Iglesia Santos Juanes ‚Üí Lonja de Val√®ncia (Mercado de la Seda)",
    inicio: { lat: 39.47425, lng: -0.37895 },
    waypoints: [],
    fin: { lat: 39.47426, lng: -0.37862 },
    imagen: 'fotos_Av1/23_lonja.jpg',
    video: 'videos/parada_19.mp4',
  },
  // ‚Üê Parada 29 (Lonja Puerta de Los Pecados barquero) (378, 379) 26 Puzzle Lonja, Reto 27 //
  {
    tipo: "parada",
    id: "P-29",
    parada: 29,
    nombre: "Lonja Puerta de Los Pecados barquero",
    coordenadas: { lat: 39.4742, lng: -0.37851 },
    imagen: 'fotos_Av1/23_lonja.jpg',
  },
  // ‚Üê Parada 30 (Lonja Puerta de Los Pecados √°rbol muerto) (380, 381) Reto 28 //
  {
    tipo: "parada",
    id: "P-30",
    parada: 30,
    nombre: "Lonja Puerta de Los Pecados √°rbol muerto",
    coordenadas: { lat: 39.4742, lng: -0.37851 },
    imagen: 'fotos_Av1/23_lonja.jpg',
  },
  // ‚Üê tramo 19 (Lonja G√°rgolas) (383) //
  {
    tipo: "tramo",
    id: "TR-19",
    tramo: 19,
    nombre: "Lonja G√°rgolas",
    inicio: { lat: 39.4742, lng: -0.37851 },
    waypoints: [],
    fin: { lat: 39.4742, lng: -0.37881 },
    imagen: 'fotos_Av1/23_lonja.jpg',
    video: 'videos/tramo_19.mp4',
  },
  // ‚Üê Parada 31 (Lonja G√°rgolas √°ngel vasija) (384) Reto 29 //
  {
    tipo: "parada",
    id: "P-31",
    parada: 31,
    nombre: "Lonja G√°rgolas √°ngel vasija",
    coordenadas: { lat: 39.4742, lng: -0.37881 },
    imagen: 'fotos_Av1/23_lonja.jpg',
  },
  // ‚Üê Parada 32 (Lonja G√°rgolas barbudo y le√≥n) (385) Reto 30 //
  {
    tipo: "parada",
    id: "P-32",
    parada: 32,
    nombre: "Lonja G√°rgolas barbudo y le√≥n",
    coordenadas: { lat: 39.4742, lng: -0.37881 },
    imagen: 'fotos_Av1/23_lonja.jpg',
  },
  // ‚Üê Parada 33 (Lonja G√°rgolas fornicador ventana) (386) Reto 31 //
  {
    tipo: "parada",
    id: "P-33",
    parada: 33,
    nombre: "Lonja G√°rgolas fornicador ventana",
    coordenadas: { lat: 39.47439, lng: -0.37887 },
    imagen: 'fotos_Av1/23_lonja.jpg',
  },
  // ‚Üê tramo 20 (Lonja ‚Üí Plaza del Doctor Collado) (388, 389, 390, 391, 392) //
  {
    tipo: "tramo",
    id: "TR-20",
    tramo: 20,
    nombre: "Lonja ‚Üí Plaza del Doctor Collado",
    inicio: { lat: 39.47426, lng: -0.37862 },
    waypoints: [
      { lat: 39.47445, lng: -0.37889 },
      { lat: 39.47459, lng: -0.37868 },
      { lat: 39.47475, lng: -0.37842 },
      { lat: 39.47436, lng: -0.37799 }
    ],
    fin: { lat: 39.47444, lng: -0.3779 },
    imagen: 'fotos_Av1/24_lonja2.jpg',
    video: 'videos/tramo_20.mp4',
  },
  // ‚Üê tramo 21 (Plaza del Doctor Collado ‚Üí Plaza del Negrito) (333, 397, 41, 398, 198, 671, 522, 32-C) //
  {
    tipo: "tramo",
    id: "TR-21",
    tramo: 21,
    nombre: "Plaza del Doctor Collado ‚Üí Plaza del Negrito (Fuente del Negrito)",
    inicio: { lat: 39.47444, lng: -0.3779 },
    waypoints: [
      { lat: 39.47473, lng: -0.37763 },
      { lat: 39.47493, lng: -0.37761 },
      { lat: 39.47559, lng: -0.37772 }
    ],
    fin: { lat: 39.47611, lng: -0.37741 },
    imagen: 'fotos_Av1/25_fuente_del_negrito.jpg',
    video: 'videos/parada_21.mp4',
  },
  // ‚Üê Parada 34 (Fuente del Negrito) (382, 501) Reto 32 //
  {
    tipo: "parada",
    id: "P-34",
    parada: 34,
    nombre: "Fuente del Negrito",
    coordenadas: { lat: 39.47611, lng: -0.37741 },
    imagen: 'fotos_Av1/25_fuente_del_negrito.jpg',
  },
  // ‚Üê tramo 22 (Plaza del Negrito ‚Üí Calle Caballeros) (33-B, 486, 480-B) //
  {
    tipo: "tramo",
    id: "TR-22",
    tramo: 22,
    nombre: "Plaza del Negrito ‚Üí Calle Caballeros",
    inicio: { lat: 39.47611, lng: -0.37741 },
    waypoints: [
      { lat: 39.47663, lng: -0.3773 },
      { lat: 39.47661, lng: -0.37685 }
    ],
    fin: { lat: 39.47668, lng: -0.37671 },
    imagen: 'fotos_Av1/26_palau_de_la_generalitat.jpg',
    video: 'videos/parada_22.mp4',
  },
  // ‚Üê Parada 35 (Palau de la Generalitat) (481-B, 482-B, 2-D) //
  {
    tipo: "parada",
    id: "P-35",
    parada: 35,
    nombre: "Palau de la Generalitat",
    coordenadas: { lat: 39.47668, lng: -0.37671 },
    imagen: 'fotos_Av1/26_palau_de_la_generalitat.jpg',
  },
  // ‚Üê tramo 23 (Palacio de la Generalitat ‚Üí Calle de los Serranos - FINAL) //
  {
    tipo: "tramo",
    id: "TR-23",
    tramo: 23,
    nombre: "Palacio de la Generalitat ‚Üí Calle de los Serranos (FINAL)",
    inicio: { lat: 39.47668, lng: -0.37671 },
    waypoints: [
      { lat: 39.47661, lng: -0.37685 },
      { lat: 39.47687, lng: -0.37686 }
    ],
    fin: { lat: 39.47773, lng: -0.37671 },
    imagen: 'fotos_Av1/00_torres_de_serranos_back.jpg',
    video: 'videos/parada_24.mp4',
  },
  // ‚Üê Parada 36 (Torres de Serranos Final) (audio despedida) //
  {
    tipo: "parada",
    id: "P-36",
    parada: 36,
    nombre: "Torres de Serranos Final",
    coordenadas: { lat: 39.47773, lng: -0.37671 },
    imagen: 'fotos_Av1/00_torres_de_serranos_back.jpg',
  }
];

        // ================== SISTEMA DE MENSAJER√çA ==================
        const Mensajes = {
            // Tipos de mensajes est√°ndar
            TIPOS: {
                // Mensajes del hijo al padre
                ESTADO: 'estado',
                NAVEGACION: 'navegacion',
                ERROR: 'error',
                CONFIRMACION: 'confirmacion',
                SOLICITUD: 'solicitud',
                
                // Mensajes del padre al hijo
                ACCION: 'accion',
                ACTUALIZACION_ESTADO: 'actualizacion_estado',
                RESPUESTA: 'respuesta',
                
                // Compatibilidad con sistema existente
                SINCRONIZAR_ESTADO: 'sincronizarEstado',
                SINCRONIZAR_BRUJULA: 'sincronizarBrujula'
            },
            
            // Creador de mensajes estandarizado
            crear(tipo, datos = {}, idMensaje = null) {
                return {
                    tipo,
                    origen: 'hijo2',
                    destino: 'padre',
                    id: idMensaje || `msg_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                    timestamp: Date.now(),
                    datos: { ...datos }
                };
            },
            
            // Verificar si un mensaje es v√°lido
            esValido(mensaje) {
                return mensaje && 
                       typeof mensaje === 'object' &&
                       mensaje.tipo &&
                       mensaje.timestamp &&
                       mensaje.origen;
            },
            
            // Manejadores de mensajes
            manejadores: new Map(),
            
            // Registrar manejador para un tipo de mensaje
            registrarManejador(tipo, callback) {
                if (!this.manejadores.has(tipo)) {
                    this.manejadores.set(tipo, new Set());
                }
                this.manejadores.get(tipo).add(callback);
                return () => this.manejadores.get(tipo)?.delete(callback);
            },
            
            // Procesar mensaje entrante
            procesarMensaje(mensaje, event) {
                if (!this.esValido(mensaje)) {
                    console.warn('Mensaje recibido no v√°lido:', mensaje);
                    return;
                }
                
                const manejadores = this.manejadores.get(mensaje.tipo) || [];
                manejadores.forEach(manejador => {
                    try {
                        manejador(mensaje, event);
                    } catch (error) {
                        console.error(`Error en manejador para mensaje ${mensaje.tipo}:`, error);
                        this.enviarError(
                            'ERROR_MANEJADOR', 
                            `Error procesando mensaje ${mensaje.tipo}: ${error.message}`,
                            mensaje.id
                        );
                    }
                });
            },
            
            // Enviar mensaje al padre
            enviar(tipo, datos = {}) {
                const mensaje = this.crear(tipo, datos);
                window.parent.postMessage(mensaje, '*');
                console.log('Mensaje enviado al padre:', tipo, datos);
                return mensaje.id;
            },
            
            // Enviar error al padre
            enviarError(codigo, mensaje, idMensajeOriginal = null) {
                return this.enviar(this.TIPOS.ERROR, {
                    codigo,
                    mensaje,
                    idMensajeOriginal
                });
            },
            
            // Enviar confirmaci√≥n de recepci√≥n
            enviarConfirmacion(idMensajeOriginal, datos = {}) {
                return this.enviar(this.TIPOS.CONFIRMACION, {
                    ...datos,
                    idMensajeOriginal
                });
            },
            
            // Enviar actualizaci√≥n de estado
            enviarEstado(estado, datosAdicionales = {}) {
                return this.enviar(this.TIPOS.ESTADO, {
                    ...estado,
                    ...datosAdicionales
                });
            },
            
            // Enviar solicitud al padre
            enviarSolicitud(accion, datos = {}) {
                return this.enviar(this.TIPOS.SOLICITUD, {
                    accion,
                    ...datos
                });
            },
            
            // Inicializar el sistema de mensajer√≠a
            inicializar() {
                // Configurar manejador de mensajes global
                window.addEventListener('message', (event) => {
                    const timestampRecepcion = Date.now();
                    const mensaje = event.data;
                    
                    // Validar que el mensaje sea un objeto
                    if (!mensaje || typeof mensaje !== 'object') {
                        console.warn('Mensaje recibido no es un objeto:', mensaje);
                        return;
                    }
                    
                    // Verificar si el mensaje est√° destinado a este iframe
                    if (mensaje.destino && mensaje.destino !== 'hijo2' && mensaje.destino !== 'todos') {
                        console.log(`Mensaje ignorado (destinado a '${mensaje.destino}')`, mensaje);
                        return;
                    }
                    
                    // Calcular retraso del mensaje
                    const retraso = mensaje.timestamp ? timestampRecepcion - mensaje.timestamp : 0;
                    
                    // Log de recepci√≥n detallado
                    console.group(`üì® HIJO 2: Mensaje recibido [${mensaje.id || 'sin-id'}]`);
                    console.log('üìã Informaci√≥n del mensaje:', {
                        tipo: mensaje.tipo || 'sin-tipo',
                        origen: mensaje.origen || 'desconocido',
                        timestamp: mensaje.timestamp || 'no-especificado',
                        timestampRecepcion,
                        retraso: `${retraso}ms`,
                        id: mensaje.id || 'sin-id'
                    });
                    console.log('üì¶ Contenido del mensaje:', mensaje);
                    
                    try {
                        // Procesar el mensaje
                        this.procesarMensaje(mensaje, event);
                        
                        // Enviar confirmaci√≥n de recepci√≥n si el mensaje tiene ID
                        if (mensaje.id) {
                            this.enviarConfirmacion(mensaje.id, {
                                recibido: true,
                                procesado: true,
                                timestampProcesado: Date.now()
                            });
                        }
                    } catch (error) {
                        console.error('‚ùå Error procesando mensaje:', error);
                        
                        // Enviar confirmaci√≥n de error si el mensaje tiene ID
                        if (mensaje.id) {
                            this.enviarError('ERROR_PROCESAMIENTO', 
                                `Error procesando mensaje: ${error.message}`, 
                                mensaje.id,
                                { stack: error.stack }
                            );
                        }
                    } finally {
                        console.groupEnd();
                    }
                });
                
                // Notificar al padre que el componente est√° listo
                const mensajeInicio = this.crear('inicio', {
                    estado: 'listo',
                    componente: 'hijo2',
                    version: '1.0.0',
                    capacidades: ['navegacion', 'gps', 'seguimiento_ruta'],
                    timestamp: Date.now()
                });
                
                // Enviar con reintentos
                this.enviarConReintentos(mensajeInicio, 3, 1000)
                    .then(() => console.log('‚úÖ Notificaci√≥n de inicio enviada correctamente'))
                    .catch(error => console.error('‚ùå Error enviando notificaci√≥n de inicio:', error));
                
                console.log('Sistema de mensajer√≠a inicializado');
            },
            
            // Funci√≥n para enviar un mensaje con reintentos
            async enviarConReintentos(mensaje, maxReintentos = 3, tiempoEspera = 1000) {
                let ultimoError;
                
                for (let intento = 1; intento <= maxReintentos; intento++) {
                    try {
                        // Agregar informaci√≥n de intento al mensaje
                        const mensajeConIntento = {
                            ...mensaje,
                            intento,
                            maxReintentos,
                            timestampUltimoIntento: Date.now()
                        };
                        
                        console.log(`üì§ Intento ${intento}/${maxReintentos} de env√≠o:`, mensajeConIntento);
                        
                        // Crear una promesa que se resuelva cuando recibamos confirmaci√≥n
                        return await new Promise((resolve, reject) => {
                            // Configurar temporizador de espera
                            const timeoutId = setTimeout(() => {
                                const error = new Error(`Timeout de ${tiempoEspera}ms excedido`);
                                error.codigo = 'TIMEOUT';
                                reject(error);
                            }, tiempoEspera);
                            
                            // Manejador temporal para confirmaci√≥n
                            const manejarConfirmacion = (event) => {
                                const respuesta = event.data;
                                
                                // Verificar si es una respuesta a nuestro mensaje
                                if (respuesta && respuesta.idMensajeOriginal === mensaje.id) {
                                    // Limpiar el manejador
                                    window.removeEventListener('message', manejarConfirmacion);
                                    clearTimeout(timeoutId);
                                    
                                    if (respuesta.exito !== false) {
                                        console.log(`‚úÖ Confirmaci√≥n recibida para mensaje ${mensaje.id}`, respuesta);
                                        resolve(respuesta);
                                    } else {
                                        const error = new Error(respuesta.error || 'Error en la confirmaci√≥n');
                                        error.respuesta = respuesta;
                                        reject(error);
                                    }
                                }
                            };
                            
                            // Escuchar la confirmaci√≥n
                            window.addEventListener('message', manejarConfirmacion);
                            
                            // Enviar el mensaje
                            window.parent.postMessage(mensajeConIntento, '*');
                        });
                        
                    } catch (error) {
                        ultimoError = error;
                        console.warn(`‚ö†Ô∏è Intento ${intento} fallido:`, error.message);
                        
                        // Esperar antes de reintentar (excepto en el √∫ltimo intento)
                        if (intento < maxReintentos) {
                            await new Promise(resolve => setTimeout(resolve, tiempoEspera * intento));
                        }
                    }
                }
                
                // Si llegamos aqu√≠, todos los intentos fallaron
                throw new Error(`No se pudo enviar el mensaje despu√©s de ${maxReintentos} intentos: ${ultimoError?.message}`);
            }
        };
        
        // Inicializar el sistema de mensajer√≠a cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            Mensajes.inicializar();
        });
        
        // ================== MANEJO DE ESTADO ==================
        class EstadoNavegacion {
            constructor() {
                this.ubicacion = null;
                this.paradaActual = 0;
                this.estado = 'inactivo'; // 'inactivo' | 'navegando' | 'en_parada'
                this.modoCasa = false;
                this.suscriptores = new Set();
                this.ultimaActualizacion = Date.now();
            }
            
            actualizar(nuevoEstado) {
                Object.assign(this, {
                    ...nuevoEstado,
                    ultimaActualizacion: Date.now()
                });
                this.notificarCambios();
                this.notificarEstadoAlPadre();
            }
            
            suscribir(callback) {
                this.suscriptores.add(callback);
                return () => this.suscriptores.delete(callback);
            }
            
            notificarCambios() {
                const estadoActual = this.obtenerEstado();
                this.suscriptores.forEach(cb => cb(estadoActual));
            }
            
            obtenerEstado() {
                return {
                    ubicacion: this.ubicacion,
                    paradaActual: this.paradaActual,
                    estado: this.estado,
                    modoCasa: this.modoCasa,
                    ultimaActualizacion: this.ultimaActualizacion
                };
            }
            
            notificarEstadoAlPadre() {
                Mensajes.enviarEstado(this.obtenerEstado());
            }
        }

        // Inicializar estado
        const estadoNavegacion = new EstadoNavegacion();
        
        // Variables globales (compatibilidad)
        let ubicacionActual = null;
        let paradaActual = 0; // Empezamos en parada 0 (inicio)
        let tramoActual = null;
        let watchId = null;
        let modoCasa = false;
        let estadoNavegacion = 'inicio'; // 'inicio', 'navegando', 'llegada'
        let paradaDestino = 1; // Pr√≥xima parada objetivo
        
        // Variables para navegaci√≥n en tiempo real
        let orientacionActual = 0; // Heading del dispositivo en grados
        let polylineActual = null; // Coordenadas de la ruta actual
        let posicionEnRuta = 0; // Progreso en la ruta (0-1)
        
        // Array de coordenadas de paradas y tramos (definido al principio del archivo)
        
        // Funci√≥n auxiliar para encontrar una parada por su ID
        function encontrarParadaPorId(id) {
            return COORDENADAS_PARADAS.find(item => 
                (item.tipo === 'parada' || item.tipo === 'inicio' || item.tipo === 'fin') && 
                `P-${item.parada}` === id
            );
        }
        
        // Funci√≥n auxiliar para encontrar un tramo por su ID
        function encontrarTramoPorId(id) {
            return COORDENADAS_PARADAS.find(item => 
                item.tipo === 'tramo' && 
                `TR-${item.tramo}` === id
            );
        }
        let watchOrientacionId = null; // ID para el listener de orientaci√≥n

        // Variables para la barra de progreso
        let totalTripTime = 330; // 5:30 en segundos por defecto
        let tripElapsedTime = 0;
        let tripProgressInterval;
        let isDraggingProgress = false;

        // Referencias a elementos DOM
        const btnGps = document.getElementById('btn-gps');
        const btnImagen = document.getElementById('btn-imagen');
        const btnVideo = document.getElementById('btn-video');
        const status = document.getElementById('status');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const elapsedTimeSpan = document.getElementById('elapsedTime');
        const totalTimeSpan = document.getElementById('totalTime');

        // ================ FUNCIONES DE BARRA DE PROGRESO ================
        
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function updateTripProgressBar() {
            if (totalTripTime > 0) {
                const progress = (tripElapsedTime / totalTripTime) * 100;
                progressBar.style.width = `${progress}%`;
                elapsedTimeSpan.textContent = formatTime(tripElapsedTime);
            }
        }

        function startTripProgressSimulation() {
            clearInterval(tripProgressInterval);
            tripProgressInterval = setInterval(() => {
                if (!isDraggingProgress && tripElapsedTime < totalTripTime) {
                    tripElapsedTime++;
                    updateTripProgressBar();
                } else if (tripElapsedTime >= totalTripTime) {
                    clearInterval(tripProgressInterval);
                }
            }, 1000);
        }

        function resetTripProgress() {
            clearInterval(tripProgressInterval);
            tripElapsedTime = 0;
            progressBar.style.width = '0%';
            elapsedTimeSpan.textContent = '00:00';
            updateTripProgressBar();
        }

        // ================== FUNCIONES DE UTILIDAD ==================
        function calcularDistancia(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Radio de la Tierra en metros
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // === FUNCIONES DE NAVEGACI√ìN EN TIEMPO REAL ===
        
        function calcularBearing(lat1, lng1, lat2, lng2) {
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const lat1Rad = lat1 * Math.PI / 180;
            const lat2Rad = lat2 * Math.PI / 180;
            
            const y = Math.sin(dLng) * Math.cos(lat2Rad);
            const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - 
                     Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);
            
            let bearing = Math.atan2(y, x) * 180 / Math.PI;
            return (bearing + 360) % 360; // Normalizar a 0-360
        }
        
        function calcularBoundingBoxPolyline(puntos, margen = 0.001) {
            if (!puntos || puntos.length === 0) return null;
            
            // Encontrar l√≠mites geogr√°ficos
            const lats = puntos.map(p => p.lat);
            const lngs = puntos.map(p => p.lng);
            
            const bounds = {
                norte: Math.max(...lats),
                sur: Math.min(...lats),
                este: Math.max(...lngs),
                oeste: Math.min(...lngs)
            };
            
            // Agregar margen para visualizaci√≥n c√≥moda
            const boundingBox = {
                norte: bounds.norte + margen,
                sur: bounds.sur - margen,
                este: bounds.este + margen,
                oeste: bounds.oeste - margen
            };
            
            // Calcular centro y dimensiones
            const centro = {
                lat: (boundingBox.norte + boundingBox.sur) / 2,
                lng: (boundingBox.este + boundingBox.oeste) / 2
            };
            
            const dimensiones = {
                latSpan: boundingBox.norte - boundingBox.sur,
                lngSpan: boundingBox.este - boundingBox.oeste
            };
            
            return {
                bounds: boundingBox,
                centro: centro,
                dimensiones: dimensiones,
                puntos: puntos.length
            };
        }
        
        function iniciarSeguimientoOrientacion() {
            // Intentar usar DeviceOrientationEvent (m√°s preciso)
            if (window.DeviceOrientationEvent) {
                // Solicitar permisos en iOS 13+
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') {
                                iniciarListenerOrientacion();
                            } else {
                                console.warn('Permisos de orientaci√≥n denegados');
                                usarOrientacionAlternativa();
                            }
                        })
                        .catch(error => {
                            console.error('Error solicitando permisos:', error);
                            usarOrientacionAlternativa();
                        });
                } else {
                    // Android y navegadores que no requieren permisos
                    iniciarListenerOrientacion();
                }
            } else {
                usarOrientacionAlternativa();
            }
        }
        
        function iniciarListenerOrientacion() {
            window.addEventListener('deviceorientationabsolute', manejarOrientacion);
            window.addEventListener('deviceorientation', manejarOrientacion);
        }
        
        function manejarOrientacion(event) {
            if (event.alpha !== null) {
                // event.alpha es el heading en grados (0-360)
                orientacionActual = event.alpha;
                
                // Actualizar flecha en tiempo real si estamos navegando
                if (estadoNavegacion === 'navegando' && ubicacionActual) {
                    actualizarFlechaNavegacion();
                }
            }
        }
        
        function usarOrientacionAlternativa() {
            // Fallback: calcular orientaci√≥n basada en movimiento GPS
            console.log('Usando orientaci√≥n basada en movimiento GPS');
        }
        
        function detenerSeguimientoOrientacion() {
            window.removeEventListener('deviceorientationabsolute', manejarOrientacion);
            window.removeEventListener('deviceorientation', manejarOrientacion);
        }
        
        function calcularPosicionEnPolyline(ubicacion, polyline) {
            if (!polyline || polyline.length < 2) return { progreso: 0, puntoMasCercano: null };
            
            let distanciaMinima = Infinity;
            let indiceMasCercano = 0;
            let puntoMasCercano = null;
            let progresoTotal = 0;
            let distanciaAcumulada = 0;
            
            // Calcular distancia total de la polyline
            let distanciaTotal = 0;
            for (let i = 0; i < polyline.length - 1; i++) {
                distanciaTotal += calcularDistancia(
                    polyline[i].lat, polyline[i].lng,
                    polyline[i + 1].lat, polyline[i + 1].lng
                );
            }
            
            // Encontrar el punto m√°s cercano en la polyline
            for (let i = 0; i < polyline.length - 1; i++) {
                const puntoProyectado = proyectarPuntoEnSegmento(
                    ubicacion, polyline[i], polyline[i + 1]
                );
                
                const distancia = calcularDistancia(
                    ubicacion.lat, ubicacion.lng,
                    puntoProyectado.lat, puntoProyectado.lng
                );
                
                if (distancia < distanciaMinima) {
                    distanciaMinima = distancia;
                    indiceMasCercano = i;
                    puntoMasCercano = puntoProyectado;
                    
                    // Calcular progreso hasta este punto
                    distanciaAcumulada = 0;
                    for (let j = 0; j < i; j++) {
                        distanciaAcumulada += calcularDistancia(
                            polyline[j].lat, polyline[j].lng,
                            polyline[j + 1].lat, polyline[j + 1].lng
                        );
                    }
                    
                    // A√±adir distancia parcial en el segmento actual
                    distanciaAcumulada += calcularDistancia(
                        polyline[i].lat, polyline[i].lng,
                        puntoProyectado.lat, puntoProyectado.lng
                    );
                    
                    progresoTotal = distanciaAcumulada / distanciaTotal;
                }
            }
            
            return {
                progreso: Math.max(0, Math.min(1, progresoTotal)),
                puntoMasCercano: puntoMasCercano,
                distanciaMinima: distanciaMinima,
                indiceSegmento: indiceMasCercano
            };
        }
        
        function proyectarPuntoEnSegmento(punto, segmentoInicio, segmentoFin) {
            const A = punto.lat - segmentoInicio.lat;
            const B = punto.lng - segmentoInicio.lng;
            const C = segmentoFin.lat - segmentoInicio.lat;
            const D = segmentoFin.lng - segmentoInicio.lng;
            
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            
            if (lenSq === 0) return segmentoInicio;
            
            let param = dot / lenSq;
            param = Math.max(0, Math.min(1, param));
            
            return {
                lat: segmentoInicio.lat + param * C,
                lng: segmentoInicio.lng + param * D
            };
        }
        
        function actualizarFlechaNavegacion() {
            if (!ubicacionActual || !polylineActual || estadoNavegacion !== 'navegando') return;
            
            // Calcular posici√≥n en la polyline
            const posicionInfo = calcularPosicionEnPolyline(ubicacionActual, polylineActual);
            posicionEnRuta = posicionInfo.progreso;
            
            // Calcular direcci√≥n hacia el siguiente punto
            let direccionObjetivo = orientacionActual;
            if (posicionInfo.indiceSegmento < polylineActual.length - 1) {
                const siguientePunto = polylineActual[posicionInfo.indiceSegmento + 1];
                direccionObjetivo = calcularBearing(
                    ubicacionActual.lat, ubicacionActual.lng,
                    siguientePunto.lat, siguientePunto.lng
                );
            }
            
            // Enviar actualizaci√≥n al padre para mostrar flecha
            enviarMensajeAlPadre({
                tipo: 'actualizar-flecha-navegacion',
                ubicacion: ubicacionActual,
                orientacionDispositivo: orientacionActual,
                direccionObjetivo: direccionObjetivo,
                progresoRuta: posicionInfo.progreso,
                puntoEnPolyline: posicionInfo.puntoMasCercano,
                distanciaAPolyline: posicionInfo.distanciaMinima
            });
        }

        function actualizarStatus(mensaje, loading = false) {
            // Enviar mensaje al padre para mostrar en ventana flotante
            window.parent.postMessage({
                tipo: 'statusMensaje',
                mensaje: mensaje,
                loading: loading
            }, '*');
            
            console.log(`üì± HIJO 2: Status enviado al padre - ${mensaje} ${loading ? '(loading)' : ''}`);
        }

        // ================== FUNCIONES GPS MEJORADAS ==================
        
        // NUEVA: Verificar llegada a paradas (corregida)
        function verificarLlegadaAParada() {
            if (modoCasa || !ubicacionActual) return;
            if (paradaActual > 36) return;
            
            // Verificar si estamos navegando hacia una parada destino
            const paradaObjetivo = estadoNavegacion === 'navegando' ? paradaDestino : paradaActual;
            const paradaInfo = COORDENADAS_PARADAS.find(p => p.parada === paradaObjetivo);
            
            if (!paradaInfo) return;
            
            let coordenadasParada = paradaInfo.coordenadas ? paradaInfo.coordenadas : { lat: paradaInfo.lat, lng: paradaInfo.lng };
            const distancia = calcularDistancia(ubicacionActual.lat, ubicacionActual.lng, coordenadasParada.lat, coordenadasParada.lng);
            const RADIO_LLEGADA = 50;
            
            if (distancia <= RADIO_LLEGADA) {
                if (estadoNavegacion === 'navegando' && paradaObjetivo === paradaDestino) {
                    // Llegamos a la parada destino
                    paradaActual = paradaDestino;
                    paradaDestino = paradaActual + 1;
                    
                    // Procesar llegada con el nuevo flujo
                    procesarLlegadaAParada();
                    
                    // Mensaje al padre (mantener compatibilidad)
                    enviarMensajeAlPadre({ 
                        tipo: 'ya-estoy-aqui', 
                        parada: paradaActual,
                        estadoNavegacion: 'llegada'
                    });
                    
                    // Informar cambio de estado (nuevo sistema)
                    informarCambioEstado('llegada-detectada', {
                        distancia: distancia,
                        paradaInfo: paradaInfo
                    });
                } else if (estadoNavegacion === 'inicio') {
                    // Estamos en la parada inicial
                    actualizarStatus(`üè† En parada ${paradaActual}: ${paradaInfo.nombre || 'Torres de Serranos'}`);
                }
            } else {
                if (estadoNavegacion === 'navegando') {
                    actualizarStatus(`üó∫Ô∏è Navegando hacia parada ${paradaDestino}: ${Math.round(distancia)}m restantes`);
                } else {
                    actualizarStatus(`Distancia a parada ${paradaActual}: ${Math.round(distancia)}m`);
                }
            }
        }

        // NUEVA: Verificar ubicaci√≥n en tramos
        function verificarUbicacionEnTramo() {
            if (modoCasa || !ubicacionActual) return;
            
            // Buscar tramos cercanos
            const tramosEncontrados = [];
            
            COORDENADAS_PARADAS.forEach(elemento => {
                if (elemento.tipo === 'tramo') {
                    // Verificar distancia al inicio del tramo
                    if (elemento.inicio) {
                        const distanciaInicio = calcularDistancia(
                            ubicacionActual.lat, ubicacionActual.lng,
                            elemento.inicio.lat, elemento.inicio.lng
                        );
                        
                        if (distanciaInicio <= 30) { // 30m para tramos
                            tramosEncontrados.push({
                                elemento: elemento,
                                distancia: distanciaInicio,
                                punto: 'inicio'
                            });
                        }
                    }
                    
                    // Verificar distancia al final del tramo
                    if (elemento.fin) {
                        const distanciaFin = calcularDistancia(
                            ubicacionActual.lat, ubicacionActual.lng,
                            elemento.fin.lat, elemento.fin.lng
                        );
                        
                        if (distanciaFin <= 30) { // 30m para tramos
                            tramosEncontrados.push({
                                elemento: elemento,
                                distancia: distanciaFin,
                                punto: 'fin'
                            });
                        }
                    }
                    
                    // Verificar waypoints si existen
                    if (elemento.waypoints && elemento.waypoints.length > 0) {
                        elemento.waypoints.forEach((waypoint, index) => {
                            const distanciaWaypoint = calcularDistancia(
                                ubicacionActual.lat, ubicacionActual.lng,
                                waypoint.lat, waypoint.lng
                            );
                            
                            if (distanciaWaypoint <= 25) { // 25m para waypoints
                                tramosEncontrados.push({
                                    elemento: elemento,
                                    distancia: distanciaWaypoint,
                                    punto: `waypoint_${index}`
                                });
                            }
                        });
                    }
                }
            });
            
            // Si encontramos tramos, mostrar informaci√≥n
            if (tramosEncontrados.length > 0) {
                const tramoMasCercano = tramosEncontrados.reduce((prev, current) => 
                    prev.distancia < current.distancia ? prev : current
                );
                
                const tramo = tramoMasCercano.elemento;
                const distancia = Math.round(tramoMasCercano.distancia);
                
                tramoActual = tramo.tramo;
                actualizarStatus(`En tramo ${tramo.tramo}: ${tramo.nombre} (${distancia}m)`);
                
                // Notificar al padre sobre el tramo
                enviarMensajeAlPadre({
                    tipo: 'en-tramo',
                    tramo: tramo.tramo,
                    nombre: tramo.nombre,
                    distancia: distancia,
                    punto: tramoMasCercano.punto
                });
            } else {
                tramoActual = null;
            }
        }

        // MEJORADA: Verificar tanto paradas como tramos
        function verificarUbicacionCompleta() {
            if (modoCasa || !ubicacionActual) return;
            
            // Primero verificar paradas (prioridad)
            verificarLlegadaAParada();
            
            // Si no estamos en una parada, verificar tramos
            const paradaDestino = COORDENADAS_PARADAS.find(p => p.parada === paradaActual);
            if (paradaDestino) {
                let coordenadasParada;
                if (paradaDestino.coordenadas) {
                    coordenadasParada = paradaDestino.coordenadas;
                } else {
                    coordenadasParada = { lat: paradaDestino.lat, lng: paradaDestino.lng };
                }
                
                const distanciaAParada = calcularDistancia(
                    ubicacionActual.lat, ubicacionActual.lng,
                    coordenadasParada.lat, coordenadasParada.lng
                );
                
                // Si estamos lejos de la parada, verificar tramos
                if (distanciaAParada > 50) {
                    verificarUbicacionEnTramo();
                }
            }
        }

        // Resto de funciones GPS (iniciarGPS, detenerGPS, etc.)
        function iniciarGPS() {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                actualizarStatus('GPS requiere HTTPS en producci√≥n');
                return;
            }

            if (!navigator.geolocation) {
                actualizarStatus('GPS no disponible en este dispositivo');
                return;
            }

            actualizarStatus('Obteniendo ubicaci√≥n GPS...', true);
            
            resetTripProgress();
            totalTimeSpan.textContent = formatTime(totalTripTime);
            startTripProgressSimulation();

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    ubicacionActual = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // Actualizar flecha de navegaci√≥n si estamos navegando
                    if (estadoNavegacion === 'navegando') {
                        actualizarFlechaNavegacion();
                    }
                    
                    enviarMensajeAlPadre({
                        tipo: 'actualizarUbicacionMapa',
                        lat: ubicacionActual.lat,
                        lng: ubicacionActual.lng
                    });

                    actualizarStatus(`GPS activo - Precisi√≥n: ${Math.round(position.coords.accuracy)}m`);
                    
                    // Informar estado GPS al padre
                    informarEstadoGPS('activo', {
                        precision: Math.round(position.coords.accuracy),
                        coordenadas: ubicacionActual
                    });
                    
                    verificarUbicacionCompleta(); // ‚Üê MEJORADO: verificar paradas y tramos
                },
                (error) => {
                    console.error('Error GPS:', error);
                    let mensajeError = 'Error al obtener ubicaci√≥n GPS';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            mensajeError = 'Permisos GPS denegados. Act√≠valos en configuraci√≥n.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            mensajeError = 'Ubicaci√≥n GPS no disponible';
                            break;
                        case error.TIMEOUT:
                            mensajeError = 'Tiempo de espera GPS agotado';
                            break;
                    }
                    
                    actualizarStatus(mensajeError);
                    
                    setTimeout(() => {
                        if (!ubicacionActual) {
                            actualizarStatus('Activando modo sin GPS...');
                            activarModoCasa();
                        }
                    }, 3000);
                },
                options
            );

            // Seguimiento continuo
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    ubicacionActual = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    enviarMensajeAlPadre({
                        tipo: 'actualizarUbicacionMapa',
                        lat: ubicacionActual.lat,
                        lng: ubicacionActual.lng
                    });

                    verificarUbicacionCompleta(); // ‚Üê MEJORADO: verificar paradas y tramos
                },
                (error) => {
                    console.error('Error GPS tracking:', error);
                    if (!ubicacionActual) {
                        let mensajeError = 'Error en seguimiento GPS';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                mensajeError = 'Permisos GPS revocados';
                                activarModoCasa();
                                break;
                            case error.POSITION_UNAVAILABLE:
                                mensajeError = 'GPS temporalmente no disponible';
                                break;
                            case error.TIMEOUT:
                                mensajeError = 'Conexi√≥n GPS lenta';
                                break;
                        }
                        
                        actualizarStatus(mensajeError);
                    }
                },
                options
            );
        }

        function detenerGPS() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            ubicacionActual = null;
            tramoActual = null;
            
            clearInterval(tripProgressInterval);
            resetTripProgress();
            
            actualizarStatus('GPS desactivado');
        }

        // Funciones de botones y comunicaci√≥n con transiciones suaves
        function activarBoton(boton) {
            // Agregar clase de transici√≥n temporal
            boton.classList.add('transitioning');
            
            // Peque√±o delay para mostrar el color intermedio
            setTimeout(() => {
                boton.classList.remove('disabled');
                boton.classList.remove('transitioning');
                boton.classList.add('activo');
            }, 150);
        }

        function desactivarBoton(boton) {
            // Agregar clase de transici√≥n temporal
            boton.classList.add('transitioning');
            
            // Peque√±o delay para mostrar el color intermedio
            setTimeout(() => {
                boton.classList.add('disabled');
                boton.classList.remove('transitioning');
                boton.classList.remove('activo');
            }, 150);
        }

        function activarTodosBotones() {
            if (modoCasa) {
                activarBoton(btnImagen);
                activarBoton(btnVideo);
                actualizarStatus('Modo Casa - Botones imagen y video activados');
            } else {
                activarBoton(btnGps);
                activarBoton(btnImagen);
                activarBoton(btnVideo);
                actualizarStatus('Todos los botones activados');
            }
        }

        function desactivarTodosBotones() {
            desactivarBoton(btnGps);
            desactivarBoton(btnImagen);
            desactivarBoton(btnVideo);
        }

        /*
        === TIPOS DE MENSAJES QUE HIJO 2 ENV√çA AL PADRE ===
        
        1. ESTADOS DE NAVEGACI√ìN:
           - 'cambio-estado-navegacion': { estado: 'inicio'|'navegando'|'llegada'|'llegada-detectada' }
           
        2. INTERACCIONES USUARIO:
           - 'interaccion-usuario': { boton: 'gps'|'imagen'|'video', accion: string }
           
        3. ESTADO GPS:
           - 'estado-gps': { estadoGPS: 'activo'|'error'|'desactivado', precision: number }
           
        4. NAVEGACI√ìN TIEMPO REAL:
           - 'actualizar-flecha-navegacion': { ubicacion, orientacionDispositivo, direccionObjetivo }
           
        5. MAPA Y VISUALIZACI√ìN:
           - 'mostrar-chincheta-actual': { parada, color, coordenadas }
           - 'mostrar-ruta-navegacion': { tramo, polyline, chinchetas, zoomAutomatico }
           - 'cambiar-chincheta-color': { parada, colorAnterior, colorNuevo }
           - 'limpiar-polyline-navegacion'
           - 'ocultar-flecha-navegacion'
           
        5.1. ZOOM AUTOM√ÅTICO NAVEGACI√ìN:
           - zoomAutomatico: { tipo: 'bounding-box-polyline', puntos, margen, transicion, duracion, incluirChinchetas }
           
        6. CONTENIDO MULTIMEDIA:
           - 'mostrar-imagen': { parada, imagenSrc, modoCasa }
           - 'mostrar-video': { parada, videoSrc, autoplay, modoCasa }
           - 'mostrar-video-con-zoom-secuencial': { parada, videoSrc, coordenadasZoom, secuencia, sincronizarConBarraProgreso }
           
        7. COMPATIBILIDAD (LEGACY):
           - 'ya-estoy-aqui': { parada, estadoNavegacion }
           - 'actualizarUbicacionMapa': { lat, lng }
           - 'mostrar-navegacion-gps': { paradaActual, coordenadasDestino, ubicacionUsuario }
        */
        
        /**
         * Funci√≥n de compatibilidad para enviar mensajes al padre
         * @param {Object} mensaje - El mensaje a enviar
         * @deprecated Usar Mensajes.enviar() en su lugar
         */
        function enviarMensajeAlPadre(mensaje) {
            try {
                // Si el mensaje ya est√° en el nuevo formato, enviarlo directamente
                if (mensaje.tipo && mensaje.origen === 'hijo2') {
                    window.parent.postMessage(mensaje, '*');
                    return;
                }
                
                // Convertir mensajes antiguos al nuevo formato
                const tipo = mensaje.tipo || mensaje.type || 'desconocido';
                const datos = { ...mensaje };
                delete datos.tipo;
                delete datos.type;
                
                // Enviar usando el nuevo sistema
                Mensajes.enviar(tipo, datos);
            } catch (error) {
                console.error('Error enviando mensaje al padre:', error);
                Mensajes.enviarError('ERROR_ENVIO', `Error enviando mensaje: ${error.message}`);
            }
        }

        function activarModoCasa() {
            modoCasa = true;
            detenerGPS();
            desactivarBoton(btnGps);
            activarBoton(btnImagen);
            activarBoton(btnVideo);
            clearInterval(tripProgressInterval);
            resetTripProgress();
            actualizarStatus('Modo Casa activado - GPS desactivado');
        }

        function activarModoAventura() {
            modoCasa = false;
            if (ubicacionActual) {
                verificarUbicacionCompleta();
            } else {
                desactivarTodosBotones();
            }
            actualizarStatus('Modo Aventura activado - GPS disponible');
        }

        // === FLUJO DE NAVEGACI√ìN COMPLETO ===
        
        function iniciarEstadoInicial() {
            paradaActual = 0;
            paradaDestino = 1;
            estadoNavegacion = 'inicio';
            
            // GPS siempre activado por defecto
            if (!ubicacionActual) {
                iniciarGPS();
            }
            
            // Activar botones GPS, foto y video para parada actual
            activarTodosBotones();
            
            // Mostrar chincheta verde en parada actual (0)
            enviarMensajeAlPadre({
                tipo: 'mostrar-chincheta-actual',
                parada: paradaActual,
                color: 'verde',
                coordenadas: COORDENADAS_PARADAS.find(p => p.parada === paradaActual)
            });
            
            // Informar al padre que estamos en estado inicial
            informarCambioEstado('inicio', {
                paradaInfo: COORDENADAS_PARADAS.find(p => p.parada === paradaActual)
            });
            
            actualizarStatus(`üè† Parada ${paradaActual}: Torres de Serranos (Inicio) - Botones activos`);
        }
        
        function iniciarNavegacionAProximaParada() {
            if (paradaDestino > 36) {
                actualizarStatus('‚úÖ ¬°Tour completado! Has visitado todas las paradas.');
                return;
            }
            
            estadoNavegacion = 'navegando';
            
            // Encontrar el tramo correspondiente
            const tramoNavegacion = COORDENADAS_PARADAS.find(t => 
                t.tipo === 'tramo' && t.tramo === paradaActual
            );
            
            if (tramoNavegacion) {
                // Guardar polyline actual para seguimiento en tiempo real
                polylineActual = [tramoNavegacion.inicio, ...tramoNavegacion.waypoints, tramoNavegacion.fin];
                
                // Iniciar seguimiento de orientaci√≥n
                iniciarSeguimientoOrientacion();
                
                // Mostrar ruta completa en el mapa del padre
                enviarMensajeAlPadre({
                    tipo: 'mostrar-ruta-navegacion',
                    paradaOrigen: paradaActual,
                    paradaDestino: paradaDestino,
                    tramo: tramoNavegacion,
                    chincheta: {
                        actual: { parada: paradaActual, color: 'verde' },
                        destino: { parada: paradaDestino, color: 'rojo' }
                    },
                    polyline: {
                        coordenadas: polylineActual,
                        color: 'azul',
                        grosor: 6
                    },
                    zoomAutomatico: {
                        tipo: 'bounding-box-polyline',
                        puntos: polylineActual,
                        margen: 0.001, // Margen en grados para visualizaci√≥n c√≥moda
                        transicion: 'suave',
                        duracion: 1500, // 1.5 segundos
                        incluirChinchetas: true
                    },
                    iniciarSeguimientoTiempoReal: true
                });
            }
            
            // Informar al padre que iniciamos navegaci√≥n
            informarCambioEstado('navegando', {
                tramo: tramoNavegacion,
                polyline: polylineActual
            });
            
            actualizarStatus(`üó∫Ô∏è Navegando hacia parada ${paradaDestino} - Sigue la ruta azul`);
        }
        
        function informarCambioEstado(estado, datos = {}) {
            // Hijo 2 solo informa estados, no controla otros hijos
            const mensaje = {
                tipo: 'cambio-estado-navegacion',
                estado: estado,
                parada: paradaActual,
                paradaDestino: paradaDestino,
                ubicacion: ubicacionActual,
                timestamp: Date.now(),
                ...datos
            };
            
            enviarMensajeAlPadre(mensaje);
            
            // Log para debugging
            console.log(`[Hijo 2] Informando estado: ${estado}`, mensaje);
        }
        
        function informarInteraccionUsuario(tipoBoton, datos = {}) {
            // Informar cuando el usuario interact√∫a con botones
            const mensaje = {
                tipo: 'interaccion-usuario',
                boton: tipoBoton,
                parada: paradaActual,
                ubicacion: ubicacionActual,
                timestamp: Date.now(),
                ...datos
            };
            
            enviarMensajeAlPadre(mensaje);
            console.log(`[Hijo 2] Interacci√≥n usuario: ${tipoBoton}`, mensaje);
        }
        
        function informarEstadoGPS(estado, datos = {}) {
            // Informar cambios en el estado del GPS
            const mensaje = {
                tipo: 'estado-gps',
                estadoGPS: estado,
                ubicacion: ubicacionActual,
                timestamp: Date.now(),
                ...datos
            };
            
            enviarMensajeAlPadre(mensaje);
            console.log(`[Hijo 2] Estado GPS: ${estado}`, mensaje);
        }
        
        function procesarLlegadaAParada() {
            estadoNavegacion = 'llegada';
            
            // Detener seguimiento en tiempo real
            detenerSeguimientoOrientacion();
            polylineActual = null;
            posicionEnRuta = 0;
            
            // Cambiar chincheta roja a verde
            enviarMensajeAlPadre({
                tipo: 'cambiar-chincheta-color',
                parada: paradaActual,
                colorAnterior: 'rojo',
                colorNuevo: 'verde'
            });
            
            // Limpiar polyline de navegaci√≥n y flecha
            enviarMensajeAlPadre({
                tipo: 'limpiar-polyline-navegacion'
            });
            
            enviarMensajeAlPadre({
                tipo: 'ocultar-flecha-navegacion'
            });
            
            // Informar al padre que llegamos a la parada
            informarCambioEstado('llegada', {
                paradaInfo: COORDENADAS_PARADAS.find(p => p.parada === paradaActual)
            });
            
            // Activar todos los botones para la parada actual
            activarTodosBotones();
            
            actualizarStatus(`‚úÖ ¬°Llegaste a parada ${paradaActual}! El padre coordinar√° audio y retos`);
        }

        // Funci√≥n de prueba para demostrar las transiciones suaves
        function probarTransicionesBotones() {
            actualizarStatus('üé® Probando transiciones suaves de botones...');
            
            // Secuencia de prueba de transiciones
            const secuenciaPrueba = [
                { tiempo: 0, accion: () => {
                    actualizarStatus('üî¥ Desactivando todos los botones...');
                    desactivarTodosBotones();
                }},
                { tiempo: 1000, accion: () => {
                    actualizarStatus('üü¢ Activando bot√≥n GPS...');
                    activarBoton(btnGps);
                }},
                { tiempo: 2000, accion: () => {
                    actualizarStatus('üü¢ Activando bot√≥n Imagen...');
                    activarBoton(btnImagen);
                }},
                { tiempo: 3000, accion: () => {
                    actualizarStatus('üü¢ Activando bot√≥n Video...');
                    activarBoton(btnVideo);
                }},
                { tiempo: 4500, accion: () => {
                    actualizarStatus('üî¥ Desactivando bot√≥n GPS...');
                    desactivarBoton(btnGps);
                }},
                { tiempo: 5500, accion: () => {
                    actualizarStatus('üî¥ Desactivando bot√≥n Imagen...');
                    desactivarBoton(btnImagen);
                }},
                { tiempo: 6500, accion: () => {
                    actualizarStatus('üî¥ Desactivando bot√≥n Video...');
                    desactivarBoton(btnVideo);
                }},
                { tiempo: 8000, accion: () => {
                    actualizarStatus('üü¢ Activando todos los botones...');
                    activarTodosBotones();
                }},
                { tiempo: 10000, accion: () => {
                    actualizarStatus('‚úÖ Prueba de transiciones completada!');
                }}
            ];
            
            // Ejecutar secuencia de prueba
            secuenciaPrueba.forEach(paso => {
                setTimeout(paso.accion, paso.tiempo);
            });
        }
        
        // Funci√≥n de prueba para el flujo de navegaci√≥n completo
        function probarFlujoNavegacion() {
            actualizarStatus('üó∫Ô∏è Probando flujo completo de navegaci√≥n...');
            
            const secuenciaNavegacion = [
                { tiempo: 0, accion: () => {
                    actualizarStatus('üè† 1. Iniciando estado inicial (Parada 0)');
                    iniciarEstadoInicial();
                }},
                { tiempo: 2000, accion: () => {
                    actualizarStatus('üó∫Ô∏è 2. Iniciando navegaci√≥n hacia parada 1 (con zoom autom√°tico)');
                    iniciarNavegacionAProximaParada();
                }},
                { tiempo: 4000, accion: () => {
                    actualizarStatus('üìç 3. Simulando llegada a parada 1');
                    // Simular llegada
                    estadoNavegacion = 'navegando';
                    paradaDestino = 1;
                    paradaActual = 1;
                    paradaDestino = 2;
                    procesarLlegadaAParada();
                }},
                { tiempo: 6000, accion: () => {
                    actualizarStatus('üó∫Ô∏è 4. Navegando hacia parada 2');
                    iniciarNavegacionAProximaParada();
                }},
                { tiempo: 8000, accion: () => {
                    actualizarStatus('üìç 5. Simulando llegada a parada 2');
                    estadoNavegacion = 'navegando';
                    paradaDestino = 2;
                    paradaActual = 2;
                    paradaDestino = 3;
                    procesarLlegadaAParada();
                }},
                { tiempo: 10000, accion: () => {
                    actualizarStatus('‚úÖ Prueba de flujo de navegaci√≥n completada!');
                    // Resetear al estado inicial
                    setTimeout(() => {
                        iniciarEstadoInicial();
                    }, 2000);
                }}
            ];
            
            // Ejecutar secuencia de navegaci√≥n
            secuenciaNavegacion.forEach(paso => {
                setTimeout(paso.accion, paso.tiempo);
            });
        }
        
        // Funci√≥n de prueba para video con zoom secuencial
        function probarVideoConZoom() {
            actualizarStatus('üé¨ Probando video con zoom secuencial...');
            
            // Simular coordenadas de prueba
            const coordenadasPrueba = {
                lat: 39.47773,
                lng: -0.37671
            };
            
            const videoSrcPrueba = 'videos/parada_0.mp4';
            
            // Simular el mensaje que enviar√≠a el bot√≥n de video
            const mensajePrueba = {
                tipo: 'mostrar-video-con-zoom-secuencial',
                parada: paradaActual,
                videoSrc: videoSrcPrueba,
                coordenadasZoom: coordenadasPrueba,
                secuencia: {
                    paso1: { accion: 'zoom', duracion: 1000 },
                    paso2: { accion: 'mostrar-video', ventana: '70%' }
                },
                sincronizarConBarraProgreso: true,
                modoCasa: modoCasa
            };
            
            // Ejecutar la secuencia
            actualizarStatus('üîç Paso 1: Iniciando zoom hacia coordenadas...');
            
            setTimeout(() => {
                // Simular que el padre procesa el mensaje
                window.dispatchEvent(new MessageEvent('message', {
                    data: mensajePrueba
                }));
            }, 500);
            
            // Mostrar instrucciones
            setTimeout(() => {
                actualizarStatus('üé¨ Prueba completa: Zoom ‚Üí Video flotante ‚Üí Control con barra');
            }, 3000);
        }

        // Manejador simple para los botones
        function manejarClicBoton(id) {
            if (modoCasa) return;
            
            const btn = document.getElementById(id);
            if (!btn) return;
            
            // Efecto visual al hacer clic
            btn.style.transform = 'scale(0.9)';
            setTimeout(() => { btn.style.transform = 'scale(1)'; }, 100);
            
            // Handle button clicks
            if (id === 'btn-punto') {
                // Get the current stop or default to 0 (Torres de Serranos) if adventure hasn't started
                const paradaActual = window.paradaActual !== undefined ? window.paradaActual : 0;
                const paradaInfo = COORDENADAS_PARADAS.find(p => p.parada === paradaActual);
                const siguienteParada = COORDENADAS_PARADAS.find(p => p.parada === (paradaActual + 1));
                
                // Prepare data to send to parent
                const datos = {
                    tipo: 'mostrarUbicacionYProximoPunto',
                    paradaActual: paradaActual,
                    nombreParadaActual: paradaInfo ? paradaInfo.nombre : 'Inicio',
                    coordenadasParadaActual: paradaInfo ? (paradaInfo.coordenadas || paradaInfo) : null,
                    esPrimeraVez: window.paradaActual === undefined
                };
                
                // Add next stop info if available
                if (siguienteParada) {
                    datos.siguienteParada = siguienteParada.parada;
                    datos.nombreSiguienteParada = siguienteParada.nombre;
                    datos.coordenadasSiguienteParada = siguienteParada.coordenadas || siguienteParada;
                }
                
                // Notify parent to show the location and next point
                enviarMensajeAlPadre(datos);
                
                // If this is the first time, set to stop 0 (Torres de Serranos)
                if (window.paradaActual === undefined) {
                    window.paradaActual = 0;
                    console.log('Aventura iniciada en parada 0 - Torres de Serranos');
                    
                    // Also update the parent about the adventure start
                    enviarMensajeAlPadre({
                        tipo: 'inicioAventura',
                        paradaActual: 0,
                        nombreParada: 'Torres de Serranos (start)'
                    });
                } else {
                    console.log(`Mostrando ubicaci√≥n actual: Parada ${paradaActual}`);
                }
                
                // If we have GPS location, include it
                if (ubicacionActual) {
                    enviarMensajeAlPadre({
                        tipo: 'actualizarUbicacionUsuario',
                        coordenadas: ubicacionActual,
                        timestamp: new Date().toISOString()
                    });
                }
                
            } else if (id === 'btn-ruta') {
                // Map button - Show full route
                window.open('Av1_mapa_completo.html', '_blank');
                
            } else if (id === 'btn-brujula') {
                // Compass button - Show map image
                window.open('mapas/Av1_mapa.jpg', '_blank');
            }
        }
        
        // Asignar manejadores de eventos a los botones
        document.getElementById('btn-punto').addEventListener('click', () => manejarClicBoton('btn-punto'));
        document.getElementById('btn-ruta').addEventListener('click', () => manejarClicBoton('btn-ruta'));
        document.getElementById('btn-brujula').addEventListener('click', () => manejarClicBoton('btn-brujula'));
        
        // Funci√≥n para sincronizar el estado de la br√∫jula cuando se recibe un mensaje del padre
        function sincronizarEstadoBrujula(activada) {
            const btnBrujula = document.getElementById('btn-brujula');
            if (!btnBrujula) return;
            
            const brujulaActivada = activada === true;
            btnBrujula.classList.toggle('active', brujulaActivada);
            
            if (brujulaActivada) {
                btnBrujula.style.background = 'linear-gradient(135deg, #ffc107, #ff9800)';
                btnBrujula.style.boxShadow = '0 0 15px rgba(255, 193, 7, 0.8)';
            } else {
                btnBrujula.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                btnBrujula.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            }
        }

        // Event listeners b√°sicos
        btnGps.addEventListener('click', () => {
            if (btnGps.classList.contains('disabled') || modoCasa) return;
            
            // Informar interacci√≥n al padre
            informarInteraccionUsuario('gps', {
                accion: !ubicacionActual ? 'iniciar-gps' : 'mostrar-navegacion'
            });
            
            if (!ubicacionActual) {
                iniciarGPS();
            } else {
                const paradaDestino = COORDENADAS_PARADAS.find(p => p.parada === paradaActual);
                if (paradaDestino) {
                    enviarMensajeAlPadre({
                        tipo: 'mostrar-navegacion-gps',
                        paradaActual: paradaActual,
                        coordenadasDestino: paradaDestino,
                        ubicacionUsuario: ubicacionActual
                    });
                }
            }
        });

        btnImagen.addEventListener('click', () => {
            if (btnImagen.classList.contains('disabled')) return;
            
            const paradaInfo = COORDENADAS_PARADAS.find(p => p.parada === paradaActual);
            
            // Informar interacci√≥n al padre
            informarInteraccionUsuario('imagen', {
                paradaInfo: paradaInfo,
                tieneImagen: !!(paradaInfo && paradaInfo.imagen)
            });
            
            if (paradaInfo && paradaInfo.imagen) {
                enviarMensajeAlPadre({
                    tipo: 'mostrar-imagen',
                    parada: paradaActual,
                    imagenSrc: paradaInfo.imagen,
                    paradaNombre: paradaInfo.nombre,
                    modoCasa: modoCasa
                });
            }
        });

        btnVideo.addEventListener('click', () => {
            if (btnVideo.classList.contains('disabled')) return;
            
            const paradaInfo = COORDENADAS_PARADAS.find(p => p.parada === paradaActual);
            
            // Informar interacci√≥n al padre
            informarInteraccionUsuario('video', {
                paradaInfo: paradaInfo,
                tieneVideo: !!(paradaInfo && paradaInfo.video)
            });
            
            if (paradaInfo && paradaInfo.video) {
                // Obtener coordenadas de inicio para el zoom
                const coordenadasZoom = paradaInfo.coordenadas || 
                                       { lat: paradaInfo.lat, lng: paradaInfo.lng } || 
                                       ubicacionActual;
                
                enviarMensajeAlPadre({
                    tipo: 'mostrar-video-con-zoom-secuencial',
                    parada: paradaActual,
                    videoSrc: paradaInfo.video,
                    coordenadasZoom: coordenadasZoom,
                    secuencia: {
                        paso1: { accion: 'zoom', duracion: 1000 },
                        paso2: { accion: 'mostrar-video', ventana: '70%' }
                    },
                    sincronizarConBarraProgreso: true,
                    modoCasa: modoCasa
                });
            }
        });



        // === FUNCIONES DE SIMULACI√ìN DE ZOOM Y VIDEO (TEMPORAL) ===
        
        function simularZoomNavegacion(mensaje) {
            const polyline = mensaje.polyline.coordenadas;
            const zoomConfig = mensaje.zoomAutomatico;
            
            // Calcular bounding box de la polyline
            const boundingBox = calcularBoundingBoxPolyline(polyline, zoomConfig.margen);
            
            if (!boundingBox) {
                actualizarStatus('‚ùå Error: No se pudo calcular bounding box');
                return;
            }
            
            // Simular zoom hacia el bounding box
            actualizarStatus(`üîç Zoom navegaci√≥n: Centro ${boundingBox.centro.lat.toFixed(4)}, ${boundingBox.centro.lng.toFixed(4)}`);
            
            // Mostrar informaci√≥n del zoom
            setTimeout(() => {
                actualizarStatus(`üó∫Ô∏è Ruta visible: ${boundingBox.puntos} puntos, ${Math.round(boundingBox.dimensiones.latSpan * 111000)}m span`);
            }, 500);
            
            // Simular finalizaci√≥n del zoom
            setTimeout(() => {
                actualizarStatus(`‚úÖ Zoom completado - Ruta completa visible desde ${mensaje.paradaOrigen} ‚Üí ${mensaje.paradaDestino}`);
                
                // Simular dibujo de elementos en el mapa
                simularElementosNavegacion(mensaje);
            }, zoomConfig.duracion || 1500);
        }
        
        function simularElementosNavegacion(mensaje) {
            const elementos = [];
            
            // Chincheta verde (origen)
            elementos.push(`üü¢ Chincheta verde: Parada ${mensaje.paradaOrigen}`);
            
            // Polyline azul
            elementos.push(`üîµ Polyline azul: ${mensaje.polyline.coordenadas.length} puntos, ${mensaje.polyline.grosor}px`);
            
            // Chincheta roja (destino)
            elementos.push(`üî¥ Chincheta roja: Parada ${mensaje.paradaDestino}`);
            
            // Mostrar elementos progresivamente
            elementos.forEach((elemento, index) => {
                setTimeout(() => {
                    actualizarStatus(elemento);
                }, index * 300);
            });
            
            // Mensaje final
            setTimeout(() => {
                actualizarStatus(`üéØ Navegaci√≥n activa: Sigue la ruta azul hacia parada ${mensaje.paradaDestino}`);
            }, elementos.length * 300 + 500);
        }
        
        // === FUNCIONES DE SIMULACI√ìN DE VIDEO (TEMPORAL) ===
        
        function simularZoomYVideo(coordenadas, videoSrc, duracionZoom = 1000) {
            // Simular zoom in del mapa
            actualizarStatus(`üîç Zoom in hacia coordenadas: ${coordenadas.lat.toFixed(4)}, ${coordenadas.lng.toFixed(4)}`);
            
            // Simular animaci√≥n de zoom
            setTimeout(() => {
                actualizarStatus(`üé¨ Zoom completado. Mostrando video: ${videoSrc}`);
                mostrarVentanaVideoFlotante(videoSrc);
            }, duracionZoom);
        }
        
        function mostrarVentanaVideoFlotante(videoSrc) {
            // Crear ventana flotante de video (70% pantalla)
            const ventanaVideo = document.createElement('div');
            ventanaVideo.id = 'ventana-video-flotante';
            ventanaVideo.style.cssText = `
                position: fixed;
                top: 15%;
                left: 15%;
                width: 70%;
                height: 70%;
                background: rgba(0,0,0,0.9);
                border-radius: 10px;
                z-index: 1000;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            `;
            
            const video = document.createElement('video');
            video.src = videoSrc;
            video.controls = false; // Sin controles, usamos barra de progreso
            video.style.cssText = `
                width: 90%;
                height: 80%;
                border-radius: 5px;
            `;
            
            const botonCerrar = document.createElement('button');
            botonCerrar.innerHTML = '‚úï';
            botonCerrar.style.cssText = `
                position: absolute;
                top: 10px;
                right: 15px;
                background: rgba(255,255,255,0.8);
                border: none;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                font-size: 16px;
                cursor: pointer;
                z-index: 1001;
            `;
            
            botonCerrar.addEventListener('click', () => {
                cerrarVentanaVideo();
            });
            
            const infoVideo = document.createElement('div');
            infoVideo.style.cssText = `
                color: white;
                margin-top: 10px;
                text-align: center;
                font-size: 14px;
            `;
            infoVideo.innerHTML = `
                üé¨ Video de parada ${paradaActual}<br>
                üîÑ Usa la barra de progreso para controlar el video
            `;
            
            ventanaVideo.appendChild(botonCerrar);
            ventanaVideo.appendChild(video);
            ventanaVideo.appendChild(infoVideo);
            
            document.body.appendChild(ventanaVideo);
            
            // Sincronizar con barra de progreso
            sincronizarVideoConBarraProgreso(video);
            
            actualizarStatus(`üé¨ Video flotante activo - Usa barra de progreso para controlar`);
        }
        
        function cerrarVentanaVideo() {
            const ventana = document.getElementById('ventana-video-flotante');
            if (ventana) {
                ventana.remove();
                actualizarStatus(`üìµ Video cerrado`);
            }
        }
        
        function sincronizarVideoConBarraProgreso(videoElement) {
            // Sincronizar video con la barra de progreso del viaje
            const barraProgreso = document.getElementById('progressBar');
            const contenedorProgreso = document.getElementById('progressContainer');
            
            if (!barraProgreso || !contenedorProgreso) return;
            
            // Listener para cuando se arrastra la barra
            contenedorProgreso.addEventListener('click', (e) => {
                if (!videoElement) return;
                
                const rect = contenedorProgreso.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const porcentaje = clickX / rect.width;
                
                // Calcular posici√≥n en el video
                const duracionVideo = videoElement.duration || 60; // Fallback 60 segundos
                const tiempoVideo = porcentaje * duracionVideo;
                
                videoElement.currentTime = tiempoVideo;
                
                actualizarStatus(`üé¨ Video: ${Math.round(tiempoVideo)}s / ${Math.round(duracionVideo)}s`);
            });
            
            // Actualizar barra cuando el video progresa
            videoElement.addEventListener('timeupdate', () => {
                if (videoElement.duration) {
                    const progreso = (videoElement.currentTime / videoElement.duration) * 100;
                    barraProgreso.style.width = `${progreso}%`;
                }
            });
        }
        
        // Esquemas de validaci√≥n para los mensajes
        const esquemasMensajes = {
            habilitarControles: {
                camposRequeridos: [],
                descripcion: 'Habilitar controles de la interfaz',
                validar: (datos) => {
                    // No se requieren datos adicionales
                    return { valido: true };
                }
            },
            deshabilitarControles: {
                camposRequeridos: [],
                descripcion: 'Deshabilitar controles de la interfaz',
                validar: (datos) => {
                    // No se requieren datos adicionales
                    return { valido: true };
                }
            },
            actualizarEstadoNavegacion: {
                camposRequeridos: ['estado'],
                descripcion: 'Actualizar el estado de navegaci√≥n',
                validar: (datos) => {
                    if (!datos.estado || typeof datos.estado !== 'object') {
                        return { 
                            valido: false, 
                            error: 'El campo estado es requerido y debe ser un objeto' 
                        };
                    }
                    return { valido: true };
                }
            }
        };

        // Funci√≥n para validar un mensaje seg√∫n su esquema
        function validarMensaje(tipo, datos = {}) {
            const esquema = esquemasMensajes[tipo];
            
            // Verificar si el tipo de mensaje es conocido
            if (!esquema) {
                return {
                    valido: false,
                    error: `Tipo de mensaje '${tipo}' no reconocido`
                };
            }
            
            // Verificar campos requeridos
            for (const campo of esquema.camposRequeridos) {
                if (!(campo in datos)) {
                    return {
                        valido: false,
                        error: `Campo requerido faltante: '${campo}'`
                    };
                }
            }
            
            // Validaci√≥n personalizada si existe
            if (typeof esquema.validar === 'function') {
                return esquema.validar(datos);
            }
            
            return { valido: true };
        }

        // Funci√≥n para confirmar la recepci√≥n de un mensaje
        function confirmarRecepcion(idMensaje, exito = true, datosAdicionales = {}) {
            const respuesta = {
                type: 'confirmacionRecepcion',
                idMensaje,
                timestamp: Date.now(),
                exito,
                origen: 'hijo2',
                ...datosAdicionales
            };
            
            console.log(`üì§ HIJO 2: Enviando confirmaci√≥n de recepci√≥n para mensaje ${idMensaje}`, respuesta);
            window.parent.postMessage(respuesta, '*');
            return respuesta;
        }

        // Funci√≥n para manejar mensajes espec√≠ficos del hijo5-casa
        function manejarMensajeEspecifico(tipo, datos = {}, idMensaje = null) {
            console.log(`üì® HIJO 2: Procesando mensaje de tipo '${tipo}'`, { datos, idMensaje });
            
            // Validar el mensaje
            const validacion = validarMensaje(tipo, datos);
            
            if (!validacion.valido) {
                console.error(`‚ùå HIJO 2: Error de validaci√≥n en mensaje '${tipo}':`, validacion.error);
                
                // Enviar confirmaci√≥n de error si hay un ID de mensaje
                if (idMensaje) {
                    confirmarRecepcion(idMensaje, false, { 
                        error: validacion.error,
                        tipoError: 'validacion'
                    });
                }
                
                return { exito: false, error: validacion.error };
            }
            
            try {
                let resultado = null;
                
                // Procesar el mensaje seg√∫n su tipo
                switch(tipo) {
                    case 'habilitarControles':
                        console.log('üîì HIJO 2: Habilitando controles');
                        activarTodosBotones();
                        resultado = { exito: true };
                        break;
                        
                    case 'deshabilitarControles':
                        console.log('üîí HIJO 2: Deshabilitando controles');
                        desactivarTodosBotones();
                        resultado = { exito: true };
                        break;
                        
                    case 'actualizarEstadoNavegacion':
                        console.log('üîÑ HIJO 2: Actualizando estado de navegaci√≥n', datos.estado);
                        manejarSincronizacionEstado(datos.estado);
                        resultado = { 
                            exito: true, 
                            estadoActual: estadoNavegacion.obtenerEstado() 
                        };
                        break;
                        
                    default:
                        const error = `Tipo de mensaje no manejado: '${tipo}'`;
                        console.warn(`‚ö†Ô∏è HIJO 2: ${error}`);
                        resultado = { 
                            exito: false, 
                            error 
                        };
                }
                
                // Enviar confirmaci√≥n de recepci√≥n si hay un ID de mensaje
                if (idMensaje) {
                    confirmarRecepcion(idMensaje, resultado.exito, resultado);
                }
                
                return resultado;
                
            } catch (error) {
                console.error(`‚ùå HIJO 2: Error al procesar mensaje '${tipo}':`, error);
                
                // Enviar confirmaci√≥n de error si hay un ID de mensaje
                if (idMensaje) {
                    confirmarRecepcion(idMensaje, false, { 
                        error: error.message,
                        tipoError: 'procesamiento',
                        stack: error.stack
                    });
                }
                
                return { 
                    exito: false, 
                    error: `Error al procesar el mensaje: ${error.message}` 
                };
            }
        }
        
        // Funci√≥n para manejar mensajes legacy (formato antiguo)
        function manejarMensajeLegacy(tipo, datos = {}) {
            console.warn(`‚ö†Ô∏è HIJO 2: Uso de mensaje legacy '${tipo}'. Se recomienda actualizar al nuevo formato estructurado.`);
            
            try {
                switch(tipo) {
                    case 'habilitarControles':
                        console.log('üîì HIJO 2: Habilitando controles (legacy)');
                        activarTodosBotones();
                        break;
                        
                    case 'deshabilitarControles':
                        console.log('üîí HIJO 2: Deshabilitando controles (legacy)');
                        desactivarTodosBotones();
                        break;
                        
                    default:
                        console.warn(`‚ö†Ô∏è HIJO 2: Tipo de mensaje legacy no reconocido: '${tipo}'`, datos);
                }
            } catch (error) {
                console.error('‚ùå HIJO 2: Error al procesar mensaje legacy:', error, { tipo, datos });
            }
        }
        
        // Funci√≥n para manejar la sincronizaci√≥n de estado con el padre
        function manejarSincronizacionEstado(estado) {
            console.log('Recibido estado del padre:', estado);
            
            // Actualizar el estado de navegaci√≥n con los datos recibidos
            const actualizaciones = {};
            
            // Actualizar estado de la br√∫jula si est√° presente
            if (typeof estado.br√∫julaActivada === 'boolean') {
                sincronizarEstadoBrujula(estado.br√∫julaActivada);
            }
            
            // Actualizar modo de operaci√≥n (casa/aventura)
            if (estado.modo === 'casa' || estado.modo === 'aventura') {
                actualizaciones.modoCasa = estado.modo === 'casa';
                
                // Actualizar estado de los botones seg√∫n el modo
                if (actualizaciones.modoCasa) {
                    activarModoCasa();
                } else {
                    activarModoAventura();
                }
                
                console.log('Modo actualizado a:', estado.modo);
                console.log('[Hijo2] Datos compartidos actualizados:', estado.datosCompartidos);
            }
        }
        
        // ID del iframe para verificaci√≥n
        const IFRAME_ID = 'hijo2';
        
        // ================== MANEJADORES DE MENSAJES ==================
        Mensajes.registrarManejador(Mensajes.TIPOS.ACTUALIZACION_ESTADO, (mensaje) => {
            // Verificar que el mensaje sea para este iframe
            if (mensaje.para && mensaje.para !== IFRAME_ID && mensaje.para !== 'todos') {
                return; // No es para este iframe
            }
            // Manejar actualizaciones de estado del padre
            if (mensaje.datos.estado) {
                manejarSincronizacionEstado(mensaje.datos.estado);
            }
        });

        // Manejador para mensajes de sincronizaci√≥n de estado (compatibilidad)
        Mensajes.registrarManejador(Mensajes.TIPOS.SINCRONIZAR_ESTADO, (mensaje) => {
            if (mensaje.estado) {
                manejarSincronizacionEstado(mensaje.estado);
            }
        });

        // Manejador para sincronizaci√≥n de br√∫jula
        Mensajes.registrarManejador(Mensajes.TIPOS.SINCRONIZAR_BRUJULA, (mensaje) => {
            if (typeof mensaje.activada === 'boolean') {
                sincronizarEstadoBrujula(mensaje.activada);
            }
        });

        // Manejador para el estado del GPS
        Mensajes.registrarManejador('GPS_STATE_CHANGE', (mensaje) => {
            console.log('Estado del GPS recibido en hijo2:', mensaje.gpsOn ? 'ACTIVADO' : 'DESACTIVADO');
            
            // Obtener referencias a los botones
            const btnGps = document.getElementById('btn-gps');
            const btnImagen = document.getElementById('btn-imagen');
            const btnVideo = document.getElementById('btn-video');
            const btnPunto = document.getElementById('btn-punto');
            
            // Verificar que los botones existan
            if (!btnGps || !btnImagen || !btnVideo || !btnPunto) {
                console.error('No se encontraron todos los botones necesarios');
                return;
            }
            
            // Actualizar el estado de los botones seg√∫n el estado del GPS
            if (mensaje.gpsOn) {
                // GPS ACTIVADO: Deshabilitar botones de GPS, Imagen y Video; habilitar Punto
                btnGps.classList.add('disabled');
                btnImagen.classList.add('disabled');
                btnVideo.classList.add('disabled');
                btnPunto.classList.remove('disabled');
                console.log('Botones actualizados: GPS ON - Punto habilitado, otros deshabilitados');
            } else {
                // GPS DESACTIVADO: Habilitar botones de GPS, Imagen y Video; deshabilitar Punto
                btnGps.classList.remove('disabled');
                btnImagen.classList.remove('disabled');
                btnVideo.classList.remove('disabled');
                btnPunto.classList.add('disabled');
                console.log('Botones actualizados: GPS OFF - Punto deshabilitado, otros habilitados');
            }
            
            // Actualizar el estado local
            modoCasa = !mensaje.gpsOn; // modoCasa es true cuando el GPS est√° apagado
        });

        // Manejador para mensajes espec√≠ficos de hijo5-casa
        Mensajes.registrarManejador('mensaje-para-hijo2', (mensaje) => {
            console.log('üì® HIJO 2: Mensaje espec√≠fico para este hijo:', mensaje);
            
            // Si el mensaje tiene un campo 'datos', es el nuevo formato
            if (mensaje.datos) {
                manejarMensajeEspecifico(mensaje.datos.tipo, mensaje.datos);
            } else {
                // Formato antiguo (legacy)
                manejarMensajeLegacy(mensaje.tipo, mensaje);
            }
        });
        
        // Manejador para acciones del padre
        Mensajes.registrarManejador(Mensajes.TIPOS.ACCION, (mensaje) => {
            const { accion, datos } = mensaje.datos || {};
            
            switch(accion) {
                case 'iniciar-estado-inicial':
                    iniciarEstadoInicial();
                    break;
                    
                case 'iniciar-navegacion':
                    iniciarNavegacionAProximaParada();
                    break;
                    
                case 'cambiar-modo':
                    if (datos?.modo === 'casa') {
                        activarModoCasa();
                    } else if (datos?.modo === 'aventura') {
                        activarModoAventura();
                    }
                    break;
                    
                case 'actualizar-parada-destino':
                    if (datos?.parada) {
                        paradaDestino = datos.parada;
                        estadoNavegacion.actualizar({ paradaActual: paradaDestino });
                        actualizarStatus(`üéØ Nuevo destino: Parada ${paradaDestino}`);
                        
                        // Notificar al padre del cambio de destino
                        Mensajes.enviarEstado({
                            estado: 'destino_actualizado',
                            paradaActual: paradaDestino
                        });
                    }
                    break;
                    
                case 'forzar-llegada':
                    if (datos?.parada) {
                        paradaActual = datos.parada;
                        estadoNavegacion.actualizar({ 
                            paradaActual,
                            estado: 'en_parada' 
                        });
                        procesarLlegadaAParada();
                        
                        // Notificar al padre de la llegada forzada
                        Mensajes.enviarEstado({
                            estado: 'llegada_forzada',
                            paradaActual
                        });
                    }
                    break;
                    
                case 'mostrar-video-con-zoom-secuencial':
                    if (datos?.coordenadasZoom && datos?.videoSrc) {
                        simularZoomYVideo(
                            datos.coordenadasZoom,
                            datos.videoSrc,
                            datos.secuencia?.paso1?.duracion || 1000
                        );
                    }
                    break;
                    
                case 'mostrar-ruta-navegacion':
                    simularZoomNavegacion(datos || {});
                    break;
                    
                default:
                    console.warn('Acci√≥n no reconocida:', accion, datos);
                    Mensajes.enviarError('ACCION_NO_RECONOCIDA', `Acci√≥n no reconocida: ${accion}`);
            }
            
            // Enviar confirmaci√≥n de recepci√≥n
            Mensajes.enviarConfirmacion(mensaje.id, { accion });
        });

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            // Iniciar en estado inicial por defecto
            iniciarEstadoInicial();
            
            totalTimeSpan.textContent = formatTime(totalTripTime);
            resetTripProgress();
        });

    </script>
</body>
</html>
