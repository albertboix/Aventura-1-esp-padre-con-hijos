<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Botones y Coordenadas GPS</title>
    <script type="module">
      // Importar las funciones necesarias del módulo de mensajería
      import { 
        enviarMensaje, 
        inicializarMensajeria as inicializarMensajeriaModulo, 
        TIPOS_MENSAJE as TIPOS_MSG 
      } from './js/mensajeria.js';
      
      // Hacer las funciones disponibles globalmente
      window.Mensajeria = { enviarMensaje, inicializarMensajeria: inicializarMensajeriaModulo };
      window.TIPOS_MENSAJE = TIPOS_MSG;
      
      // ================== INICIALIZACIÓN DE MENSAJERÍA MEJORADA ==================
      
      // Estado global de la aplicación
      const estadoApp = {
        mensajeriaInicializada: false,
        reconectando: false,
        ultimoError: null,
        controlesHabilitados: true,  // Por defecto, los controles están habilitados
        modoActual: 'casa',         // Modo de navegación actual
        motivoDeshabilitado: '',     // Razón por la que los controles están deshabilitados
        configuracion: {
          maxReintentos: 5,
          delayReconexion: 5000,
          timeoutMensajes: 10000,
          version: '2.0.0'
        },
        // Método para reiniciar el estado de la aplicación
        reiniciar() {
          this.mensajeriaInicializada = false;
          this.reconectando = false;
          this.ultimoError = null;
          this.controlesHabilitados = true;
          this.modoActual = 'casa';
          this.motivoDeshabilitado = '';
        }
      };
      
      // Hacer el estado accesible globalmente
      window.estadoApp = estadoApp;
      
      // Constantes de mensajería como respaldo
      const TIPOS_MENSAJE = {
        SISTEMA: 'sistema',
        INICIALIZACION: 'inicializacion',
        CONFIGURACION: 'configuracion',
        ESTADO: 'estado',
        ERROR: 'error',
        NAVEGACION: 'navegacion',
        AUDIO: 'audio',
        RETO: 'reto',
        CONFIRMACION: 'confirmacion',
        CONTROLES_HABILITADOS: 'sistema:controles_habilitados',
        CONTROLES_DESHABILITADOS: 'sistema:controles_deshabilitados',
        CAMBIO_MODO: 'sistema:cambio_modo',
        HABILITAR_CONTROLES: 'sistema:habilitar_controles',
        DESHABILITAR_CONTROLES: 'sistema:deshabilitar_controles'
      };
      
      // Hacer las constantes accesibles globalmente
      window.TIPOS_MENSAJE = TIPOS_MENSAJE;

      /**
       * Inicializa el sistema de mensajería con manejo mejorado de errores y reintentos
       * @returns {Promise<boolean>} True si la inicialización fue exitosa
       */
      const inicializarMensajeria = async function() {
        const ID_APLICACION = 'hijo2';
        const MAX_REINTENTOS = estadoApp.configuracion.maxReintentos || 5;
        const DELAY_BASE = estadoApp.configuracion.delayReconexion || 2000;
        
        // Función para notificar error al padre
        const notificarErrorAlPadre = (error) => {
          if (!window.parent || window.parent === window) return;
          
          try {
            window.parent.postMessage({
              tipo: 'sistema:error',
              origen: ID_APLICACION,
              error: {
                mensaje: error.message,
                stack: error.stack,
                codigo: error.code || 'ERROR_DESCONOCIDO',
                timestamp: new Date().toISOString()
              },
              intento: estadoApp.reintentos + 1,
              maxReintentos: MAX_REINTENTOS,
              estado: 'error'
            }, '*');
          } catch (e) {
            console.error(`[${ID_APLICACION}] Error al notificar error al padre:`, e);
          }
        };
        // Función para programar reintento
        const programarReintento = () => {
          if (estadoApp.reintentos >= MAX_REINTENTOS) {
            console.error(`[${ID_APLICACION}] Se alcanzó el número máximo de reintentos (${MAX_REINTENTOS})`);
            estadoApp.reconectando = false;
            return false;
          }
          
          const delay = Math.min(DELAY_BASE * Math.pow(2, estadoApp.reintentos), 30000); // Backoff exponencial con máximo 30s
          const jitter = Math.random() * 1000; // Jitter de hasta 1s para evitar picos de reintentos
          const tiempoEspera = Math.floor(delay + jitter);
          
          estadoApp.reconectando = true;
          estadoApp.reintentos++;
          
          console.log(`[${ID_APLICACION}] Programando reintento ${estadoApp.reintentos}/${MAX_REINTENTOS} en ${tiempoEspera}ms...`);
          
          setTimeout(() => {
            console.log(`[${ID_APLICACION}] Iniciando reintento ${estadoApp.reintentos}/${MAX_REINTENTOS}...`);
            inicializarMensajeria().catch(console.error);
          }, tiempoEspera);
          
          return true;
        };
        
        try {
          console.log(`[${ID_APLICACION}] Iniciando sistema de mensajería (intento ${estadoApp.reintentos + 1}/${MAX_REINTENTOS})...`);
          
          // 1. Verificar si ya está cargado el módulo
          if (window.Mensajeria && estadoApp.mensajeriaInicializada) {
            console.log(`[${ID_APLICACION}] Módulo de mensajería ya cargado y listo`);
            return true;
          }
          
          // 2. Importar dinámicamente el módulo de mensajería
          console.log(`[${ID_APLICACION}] Importando módulo de mensajería...`);
          const moduloMensajeria = await import('./js/mensajeria.js');
          
          if (!moduloMensajeria) {
            throw new Error('No se pudo cargar el módulo de mensajería');
          }
          
          // 3. Hacer el módulo globalmente disponible
          window.Mensajeria = moduloMensajeria.default || moduloMensajeria;
          
          // 5. Asegurar que TIPOS_MENSAJE esté disponible globalmente
          window.TIPOS_MENSAJE = window.Mensajeria.TIPOS_MENSAJE || {
            // Tipos básicos
            SISTEMA: 'sistema',
            INICIALIZACION: 'inicializacion',
            CONFIGURACION: 'configuracion',
            ESTADO: 'estado',
            ERROR: 'error',
            NAVEGACION: 'navegacion',
            AUDIO: 'audio',
            RETO: 'reto',
            CONFIRMACION: 'confirmacion',
            
            // Controles
            CONTROLES_HABILITADOS: 'sistema:controles_habilitados',
            CONTROLES_DESHABILITADOS: 'sistema:controles_deshabilitados',
            
            // Eventos del sistema
            CAMBIO_MODO: 'sistema:cambio_modo',
            HABILITAR_CONTROLES: 'sistema:habilitar_controles',
            DESHABILITAR_CONTROLES: 'sistema:deshabilitar_controles',
            
            // Navegación
            INICIAR_NAVEGACION: 'navegacion:iniciar',
            DETENER_NAVEGACION: 'navegacion:detener',
            LLEGADA_DESTINO: 'navegacion:llegada_destino',
            
            // Audio
            REPRODUCIR_AUDIO: 'audio:reproducir',
            PAUSAR_AUDIO: 'audio:pausar',
            DETENER_AUDIO: 'audio:detener',
            
            // Retos
            INICIAR_RETO: 'reto:iniciar',
            COMPLETAR_RETO: 'reto:completar',
            FALLAR_RETO: 'reto:fallar'
          };
          
          // Hacer una copia local para usar en este ámbito
          const TIPOS_MENSAJE = window.TIPOS_MENSAJE;
          
          // 6. Configuración de la mensajería
          const configuracion = {
            iframeId: 'hijo2',
            logLevel: 2, // DEBUG
            debug: true,
            dominioPermitido: window.parent?.location?.origin || '*',
            maxRetries: 3,
            retryDelay: 1000,
            timeout: estadoApp.configuracion.timeoutMensajes || 10000,
            mensajeTtl: 10 * 60 * 1000,  // 10 minutos
            version: estadoApp.configuracion.version || '1.0.0',
            habilitarMetricas: true,
            confirmacionesHabilitadas: true,
            // Configuración adicional para manejo de reconexión
            onError: (error) => {
              console.error(`[${ID_APLICACION}] Error en la conexión de mensajería:`, error);
              if (!estadoApp.reconectando) {
                programarReintento();
              }
            },
            onReconnect: (intento) => {
              console.log(`[${ID_APLICACION}] Reconectando... (intento ${intento})`);
            }
          };
          
          // 7. Inicializar la mensajería
          console.log(`[${ID_APLICACION}] Inicializando mensajería con configuración:`, configuracion);
          
          try {
            await window.Mensajeria.inicializarMensajeria(configuracion);
            
            // 8. Configurar manejadores de mensajes
            if (typeof configurarManejadoresMensajes === 'function') {
              configurarManejadoresMensajes();
            } else {
              console.warn(`[${ID_APLICACION}] La función configurarManejadoresMensajes no está definida`);
            }
            
            // 9. Configurar sistema de reconexión
            if (typeof configurarSistemaReconexion === 'function') {
              configurarSistemaReconexion();
            } else {
              console.warn(`[${ID_APLICACION}] La función configurarSistemaReconexion no está definida`);
            }
            
            // 10. Notificar al padre que estamos listos
            if (typeof notificarInicializacion === 'function') {
              await notificarInicializacion();
            } else {
              console.warn(`[${ID_APLICACION}] La función notificarInicializacion no está definida`);
            }
            
            // 11. Actualizar estado
            estadoApp.mensajeriaInicializada = true;
            estadoApp.reconectando = false;
            estadoApp.reintentos = 0;
            estadoApp.ultimoError = null;
            
            // 12. Notificar al padre que la mensajería está lista
            if (window.parent && window.parent !== window) {
              try {
                window.parent.postMessage({
                  tipo: TIPOS_MENSAJE.INICIALIZACION,
                  origen: ID_APLICACION,
                  estado: 'listo',
                  timestamp: Date.now(),
                  version: estadoApp.configuracion.version || '1.0.0',
                  detalles: {
                    mensajeria: 'inicializada',
                    controles: estadoApp.controlesHabilitados ? 'habilitados' : 'deshabilitados',
                    modo: estadoApp.modoActual || 'desconocido',
                    reconexiones: estadoApp.reintentos
                  }
                }, '*');
                console.log(`[${ID_APLICACION}] ✅ Sistema de mensajería inicializado correctamente`);
              } catch (error) {
                console.error(`[${ID_APLICACION}] Error al notificar al padre:`, error);
              }
            } else {
              console.warn(`[${ID_APLICACION}] No se pudo notificar al padre: window.parent no disponible`);
            }
            
            return true;
          } catch (error) {
            console.error(`[${ID_APLICACION}] Error al inicializar la mensajería:`, error);
            estadoApp.ultimoError = error;
            estadoApp.mensajeriaInicializada = false;
            
            // Notificar al padre sobre el error
            notificarErrorAlPadre(error);
            
            // Mostrar error al usuario
            if (typeof mostrarError === 'function') {
              mostrarError('Error en el sistema de mensajería. Reconectando...', 'error');
            }
            
            // Intentar reconexión automática
            if (!programarReintento()) {
              // Si no se pudo programar el reintento (porque se alcanzó el máximo)
              const mensajeFinal = `No se pudo conectar después de ${MAX_REINTENTOS} intentos. Por favor, recargue la página.`;
              console.error(`[${ID_APLICACION}] ${mensajeFinal}`);
              
              if (typeof mostrarError === 'function') {
                mostrarError(mensajeFinal, 'error', 0); // 0 = mostrar permanentemente
              }
              
              // Notificar al padre sobre el fallo final
              if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                  tipo: 'sistema:error_fatal',
                  origen: ID_APLICACION,
                  error: {
                    mensaje: 'Fallo en la inicialización de la mensajería',
                    intentos: estadoApp.reintentos,
                    ultimoError: error.message,
                    timestamp: new Date().toISOString()
                  },
                  estado: 'error_fatal',
                  requiereRecarga: true
                }, '*');
              }
            }
            
            throw error; // Relanzar el error para que sea manejado por el bloque catch externo si es necesario
          }
        } catch (error) {
          // Manejo detallado de errores
          const errorMsg = `[${ID_APLICACION}] ❌ Error en inicialización: ${error.message || 'Error desconocido'}`;
          console.error(errorMsg, error);
          
          // Actualizar estado
          estadoApp.ultimoError = error;
          estadoApp.mensajeriaInicializada = false;
          
          // Notificar al padre sobre el error
          notificarErrorAlPadre(error);
          
          // Mostrar error al usuario
          if (typeof mostrarError === 'function') {
            mostrarError('Error en el sistema de mensajería. Reconectando...', 'error');
          }
          
          // Intentar reconexión automática
          if (!programarReintento()) {
            // Si no se pudo programar el reintento (porque se alcanzó el máximo)
            const mensajeFinal = `No se pudo conectar después de ${MAX_REINTENTOS} intentos. Por favor, recargue la página.`;
            console.error(`[${ID_APLICACION}] ${mensajeFinal}`);
            
            if (typeof mostrarError === 'function') {
              mostrarError(mensajeFinal, 'error', 0); // 0 = mostrar permanentemente
            }
            
            // Notificar al padre sobre el fallo final
            if (window.parent && window.parent !== window) {
              window.parent.postMessage({
                tipo: 'sistema:error_fatal',
                origen: ID_APLICACION,
                error: {
                  mensaje: 'Fallo en la inicialización de la mensajería',
                  intentos: estadoApp.reintentos,
                  ultimoError: error.message,
                  timestamp: new Date().toISOString()
                },
                estado: 'error_fatal',
                requiereRecarga: true
              }, '*');
            }
          }
      }
      
      // Cargar el módulo de mensajería con manejo de errores
      async function cargarModuloMensajeria() {
        try {
          const modulo = await import('./js/mensajeria.js');
          console.log('[HIJO2] Módulo de mensajería cargado correctamente');
          return modulo;
        } catch (error) {
          console.error('[HIJO2] Error al cargar el módulo de mensajería:', error);
          throw new Error('No se pudo cargar el módulo de mensajería. Verifica la ruta del archivo.');
        }
      }
      
      // Función para configurar manejadores de mensajes de forma robusta
      function configurarManejadoresMensajes() {
        try {
          const { TIPOS_MENSAJE, LOG_LEVELS } = window.Mensajeria;
          
          // Validar que los tipos de mensaje estén definidos
          if (!TIPOS_MENSAJE || typeof TIPOS_MENSAJE !== 'object') {
            throw new Error('TIPOS_MENSAJE no está definido o no es un objeto');
          }

          // Registrar manejadores de mensajes
          const manejadores = {
            // Mensaje de inicialización del padre
            [TIPOS_MENSAJE.INICIALIZACION]: manejarInicializacion,
            
            // Mensajes de control - UNIFICADOS CON EL PADRE
            'habilitar_controles': manejarHabilitarControles,
            'deshabilitar_controles': manejarDeshabilitarControles,
            'sistema:controles_habilitados': manejarControlesHabilitados,
            'sistema:controles_deshabilitados': manejarControlesDeshabilitados,
            
            // Confirmación de mensajes
            [TIPOS_MENSAJE.CONFIRMACION]: manejarConfirmacion,
            
            // Actualizaciones de estado
            [TIPOS_MENSAJE.ACTUALIZAR_ESTADO]: manejarActualizacionEstado,
            
            // Mensajes de navegación
            [TIPOS_MENSAJE.NAVEGACION_INICIAR]: manejarIniciarNavegacion,
            [TIPOS_MENSAJE.NAVEGACION_DETENER]: manejarDetenerNavegacion,
            
            // Mensajes de GPS
            [TIPOS_MENSAJE.GPS_ACTUALIZACION]: manejarActualizacionGPS,
            
            // Mensajes de error
            [TIPOS_MENSAJE.ERROR]: manejarError
          };

          // Registrar todos los manejadores
          const manejadoresRegistrados = registrarControladores(manejadores);
          
          console.log(`[HIJO2] ✅ ${manejadoresRegistrados} manejadores configurados correctamente`);
          return manejadoresRegistrados;
          
        } catch (error) {
          console.error('[HIJO2] ❌ Error en configuración de manejadores:', error);
          throw error; // Relanzar para manejo superior
        }
      }
      
      // Manejar habilitación de controles
        async function manejarHabilitarControles(mensaje) {
            console.log('[HIJO2] Solicitando habilitar controles', mensaje);
            
            try {
                // Validar mensaje
                if (!mensaje || typeof mensaje !== 'object') {
                    throw new Error('Mensaje inválido');
                }
                
                const { modo = 'casa', motivo = 'sin_especificar', forzar = false } = mensaje.datos || {};
                
                // Si ya están habilitados y no se fuerza el cambio
                if (estadoApp.controlesHabilitados && !forzar) {
                    console.log(`[HIJO2] Los controles ya están habilitados en modo ${estadoApp.modoActual}`, { motivo });
                    return false;
                }
                
                // Actualizar estado local
                estadoApp.controlesHabilitados = true;
                estadoApp.modoActual = modo;
                estadoApp.motivoDeshabilitado = '';
                
                // Actualizar interfaz
                document.body.classList.remove('controles-deshabilitados');
                
                // Actualizar botones
                actualizarEstadoBotones();
                
                // Notificar al padre
                try {
                    await enviarMensajeAlPadre('sistema:controles_habilitados', { 
                        modo,
                        motivo,
                        timestamp: Date.now(),
                        origen: 'hijo2',
                        forzado: forzar
                    });
                    console.log(`[HIJO2] Controles habilitados (modo: ${modo}, motivo: ${motivo})`);
                } catch (error) {
                    console.error('[HIJO2] Error al notificar habilitación de controles:', error);
                    // No relanzar el error para no interrumpir el flujo
                }
                
                return true;
                
            } catch (error) {
                console.error('[HIJO2] Error al habilitar controles:', error);
                
                // Notificar al padre sobre el error
                try {
                    await enviarMensajeAlPadre('sistema:error_controles', {
                        accion: 'habilitar',
                        error: error.message || 'Error desconocido',
                        timestamp: Date.now(),
                        origen: 'hijo2'
                    });
                } catch (err) {
                    console.error('[HIJO2] Error al notificar error de habilitación:', err);
                }
                
                throw error;
            }
        }
        
        // Manejar deshabilitación de controles
        async function manejarDeshabilitarControles(mensaje) {
            console.log('[HIJO2] Solicitando deshabilitar controles', mensaje);
            
            try {
                // Validar mensaje
                if (!mensaje || typeof mensaje !== 'object') {
                    throw new Error('Mensaje inválido');
                }
                
                const { motivo = 'sin_especificar', forzar = false } = mensaje.datos || {};
                
                // Si ya están deshabilitados y no se fuerza el cambio
                if (!estadoApp.controlesHabilitados && !forzar) {
                    console.log(`[HIJO2] Los controles ya están deshabilitados`, { motivo: estadoApp.motivoDeshabilitado });
                    return false;
                }
                
                // Actualizar estado local
                estadoApp.controlesHabilitados = false;
                estadoApp.motivoDeshabilitado = motivo;
                
                // Actualizar interfaz
                document.body.classList.add('controles-deshabilitados');
                
                // Actualizar botones
                actualizarEstadoBotones();
                
                // Notificar al padre
                try {
                    await enviarMensajeAlPadre('sistema:controles_deshabilitados', { 
                        motivo,
                        timestamp: Date.now(),
                        origen: 'hijo2',
                        forzado: forzar
                    });
                    console.log(`[HIJO2] Controles deshabilitados (motivo: ${motivo})`);
                } catch (error) {
                    console.error('[HIJO2] Error al notificar deshabilitación de controles:', error);
                    // No relanzar el error para no interrumpir el flujo
                }
                
                return true;
                
            } catch (error) {
                console.error('[HIJO2] Error al deshabilitar controles:', error);
                
                // Notificar al padre sobre el error
                try {
                    await enviarMensajeAlPadre('sistema:error_controles', {
                        accion: 'deshabilitar',
                        error: error.message || 'Error desconocido',
                        timestamp: Date.now(),
                        origen: 'hijo2',
                        motivo: mensaje?.datos?.motivo || 'sin_especificar'
                    });
                } catch (err) {
                    console.error('[HIJO2] Error al notificar error de deshabilitación:', err);
                }
                
                throw error;
            }
        }
        
        // Manejar mensaje de controles habilitados
        function manejarControlesHabilitados(mensaje) {
            console.log('[HIJO2] Recibido mensaje de controles habilitados:', mensaje);
            const { modo = 'casa', motivo = 'sin_especificar' } = mensaje.datos || {};
            
            // Si ya están habilitados, no hacer nada
            if (estadoApp.controlesHabilitados) {
                console.log('[HIJO2] Los controles ya están habilitados, ignorando mensaje');
                return false;
            }
            
            // Actualizar estado local
            estadoApp.controlesHabilitados = true;
            estadoApp.modoActual = modo;
            estadoApp.motivoDeshabilitado = '';
            
            // Actualizar interfaz
            document.body.classList.remove('controles-deshabilitados');
            
            // Actualizar botones
            actualizarEstadoBotones();
            
            console.log(`[HIJO2] Controles habilitados (modo: ${modo}, motivo: ${motivo})`);
            return true;
        }
        
        // Manejar mensaje de controles deshabilitados
        function manejarControlesDeshabilitados(mensaje) {
            console.log('[HIJO2] Recibido mensaje de controles deshabilitados:', mensaje);
            const { motivo = 'sin_especificar' } = mensaje.datos || {};
            
            // Actualizar estado local
            estadoApp.controlesHabilitados = false;
            estadoApp.motivoDeshabilitado = motivo;
            
            // Actualizar interfaz
            document.body.classList.add('controles-deshabilitados');
            
            // Actualizar botones
            actualizarEstadoBotones();
            
            console.log(`[HIJO2] Controles deshabilitados (motivo: ${motivo})`);
            return true;
        }
        
        // Actualiza el estado visual de los botones según el estado de los controles
        function actualizarEstadoBotones() {
            try {
                // Obtener todos los botones de navegación
                const botonesNavegacion = document.querySelectorAll('.boton-navegacion, .control-navegacion');
                
                // Si los controles están deshabilitados
                if (!estadoApp.controlesHabilitados) {
                    botonesNavegacion.forEach(boton => {
                        boton.disabled = true;
                        boton.classList.add('deshabilitado');
                        
                        // Agregar tooltip con el motivo si está disponible
                        if (estadoApp.motivoDeshabilitado) {
                            boton.title = `Controles deshabilitados: ${estadoApp.motivoDeshabilitado}`;
                        }
                    });
                } else {
                    // Si los controles están habilitados
                    botonesNavegacion.forEach(boton => {
                        boton.disabled = false;
                        boton.classList.remove('deshabilitado');
                        
                        // Limpiar tooltip si existe
                        if (boton.title && boton.title.includes('Controles deshabilitados')) {
                            boton.title = '';
                        }
                    });
                }
                
                console.log('[HIJO2] Estado de botones actualizado', { 
                    habilitados: estadoApp.controlesHabilitados,
                    motivo: estadoApp.motivoDeshabilitado || 'N/A'
                });
                
                return true;
                
            } catch (error) {
                console.error('[HIJO2] Error al actualizar estado de botones:', error);
                return false;
            }
        }
      
      // La función manejarConfirmacion ha sido movida a una versión más completa más abajo
      // Busca 'Función para manejar la confirmación de mensajes con reintenos' para ver la implementación
      
      // Manejador de confirmaciones (versión antigua eliminada - ver implementación actual más abajo)
      
      // Manejador principal de mensajes de navegación
      async function manejarMensajeNavegacion(mensaje) {
        console.log('[HIJO2] Mensaje de navegación recibido:', mensaje);
        
        // Validar estructura del mensaje
        if (!mensaje || typeof mensaje !== 'object') {
          throw new Error('Mensaje de navegación inválido');
        }
        
        const { accion, datos } = mensaje.datos || {};
        const { TIPOS_MENSAJE } = window.Mensajeria || {};
        
        try {
          // Validar acción
          if (!accion) {
            throw new Error('Acción no especificada en el mensaje de navegación');
          }
          
          // Registrar recepción del mensaje
          console.log(`[HIJO2] Procesando acción de navegación: ${accion}`, datos);
          
          // Manejar según el tipo de acción
          switch (accion) {
            case 'iniciar':
              return await manejarInicioNavegacion(datos);
              
            case 'detener':
              return await manejarDetenerNavegacion(datos);
              
            case 'actualizar':
              return await manejarActualizacionNavegacion(datos);
              
            case 'cancelar':
              return await manejarCancelarNavegacion(datos);
              
            case 'pausar':
              return await manejarPausarNavegacion(datos);
              
            case 'reanudar':
              return await manejarReanudarNavegacion(datos);
              
            default:
              console.warn('[HIJO2] Acción de navegación no reconocida:', accion);
              throw new Error(`Acción de navegación no reconocida: ${accion}`);
          }
          
        } catch (error) {
          console.error('[HIJO2] Error al procesar mensaje de navegación:', error);
          
          // Notificar al padre sobre el error
          if (window.Mensajeria && TIPOS_MENSAJE) {
            await window.Mensajeria.enviarMensaje(
              'padre',
              TIPOS_MENSAJE.ERROR,
              {
                tipo: 'error_navegacion',
                accion,
                error: error.message || 'Error desconocido',
                timestamp: Date.now()
              },
              { esperarConfirmacion: false }
            ).catch(console.error);
          }
          
          // Relanzar el error para que el sistema de mensajería lo maneje
          throw error;
        }
      }
      
      // Manejador para habilitar controles
      async function manejarHabilitarControles(mensaje) {
        console.log('[HIJO2] Solicitando habilitar controles', mensaje);
        
        try {
          // Validar mensaje
          if (!mensaje || typeof mensaje !== 'object' || !mensaje.datos) {
            throw new Error('Mensaje de habilitación de controles inválido');
          }
          
          const { controles = [], razon = 'no especificada', temporal = false } = mensaje.datos;
          const resultados = { habilitados: [], noEncontrados: [] };
          
          console.log(`[HIJO2] Procesando habilitación de controles. Razón: ${razon}`, {
            totalControles: Array.isArray(controles) ? controles.length : 'todos',
            temporal
          });
          
          // Función para habilitar un control individual
          const habilitarControl = (idControl) => {
            const elemento = document.getElementById(idControl);
            if (elemento) {
              elemento.disabled = false;
              elemento.classList.remove('disabled');
              
              // Añadir clase temporal si es necesario
              if (temporal) {
                elemento.classList.add('temporal');
              } else {
                elemento.classList.remove('temporal');
              }
              
              resultados.habilitados.push(idControl);
              return true;
            }
            return false;
          };
          
          // Procesar habilitación
          if (!Array.isArray(controles) || controles.length === 0) {
            // Habilitar todos los controles de navegación
            document.querySelectorAll('.boton-navegacion').forEach(boton => {
              if (habilitarControl(boton.id)) {
                console.log(`[HIJO2] Control habilitado: ${boton.id}`);
              }
            });
          } else {
            // Habilitar solo los controles especificados
            controles.forEach(idControl => {
              if (habilitarControl(idControl)) {
                console.log(`[HIJO2] Control habilitado: ${idControl}`);
              } else {
                console.warn(`[HIJO2] No se encontró el control: ${idControl}`);
                resultados.noEncontrados.push(idControl);
              }
            });
          }
          
          // Notificar al padre sobre el resultado
          if (window.Mensajeria) {
            await window.Mensajeria.enviarMensaje(
              'padre',
              'sistema:controles_habilitados',
              {
                timestamp: Date.now(),
                totalHabilitados: resultados.habilitados.length,
                noEncontrados: resultados.noEncontrados,
                razon,
                temporal
              },
              { esperarConfirmacion: false }
            ).catch(console.error);
          }
          
          console.log('[HIJO2] Proceso de habilitación de controles completado', resultados);
          return { 
            exito: true, 
            resultados 
          };
          
        } catch (error) {
          console.error('[HIJO2] Error al habilitar controles:', error);
          
          // Notificar al padre sobre el error
          if (window.Mensajeria) {
            await window.Mensajeria.enviarMensaje(
              'padre',
              'sistema:error_controles',
              {
                error: error.message || 'Error desconocido al habilitar controles',
                accion: 'habilitar',
                timestamp: Date.now()
              },
              { esperarConfirmacion: false }
            ).catch(console.error);
          }
          
          throw error;
        }
      }
      
      // Esquema de validación para mensajes de confirmación
      const esquemaConfirmacion = {
        camposRequeridos: ['idMensaje', 'estado'],
        tipos: {
          idMensaje: 'string',
          estado: 'string',
          timestamp: 'string',
          detalles: 'object',
          tipo: 'string'
        },
        valoresPermitidos: {
          estado: ['confirmado', 'error', 'procesando', 'rechazado', 'pendiente']
        },
        mensajesError: {
          idMensaje: 'ID de mensaje no válido',
          estado: 'Estado de confirmación no válido',
          camposRequeridos: 'Faltan campos requeridos en el mensaje de confirmación'
        }
      };

      // Función para validar un mensaje de confirmación
      function validarMensajeConfirmacion(datos) {
        // Verificar campos requeridos
        const faltantes = esquemaConfirmacion.camposRequeridos.filter(
          campo => datos[campo] === undefined || datos[campo] === null || datos[campo] === ''
        );

        if (faltantes.length > 0) {
          throw new Error(
            `${esquemaConfirmacion.mensajesError.camposRequeridos}: ${faltantes.join(', ')}`
          );
        }

        // Verificar tipos de datos
        Object.entries(esquemaConfirmacion.tipos).forEach(([campo, tipo]) => {
          if (datos[campo] !== undefined && typeof datos[campo] !== tipo) {
            throw new Error(`Tipo de dato inválido para ${campo}. Se esperaba ${tipo}`);
          }
        });

        // Verificar valores permitidos
        if (esquemaConfirmacion.valoresPermitidos.estado && 
            !esquemaConfirmacion.valoresPermitidos.estado.includes(datos.estado)) {
          throw new Error(`Estado de confirmación no válido: ${datos.estado}`);
        }

        return true;
      }

      // Función para manejar la confirmación de mensajes con reintentos
      async function manejarConfirmacion(mensaje, intento = 1, maxIntentos = 3) {
        const ID_TRANSACCION = `confirm-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        
        const log = (nivel, mensaje, datos = {}) => {
          const timestamp = new Date().toISOString();
          console[nivel](`[${timestamp}] [${ID_TRANSACCION}] ${mensaje}`, datos);
        };

        try {
          log('info', 'Iniciando procesamiento de confirmación', { intento });
          
          // Validar estructura básica del mensaje
          if (!mensaje || typeof mensaje !== 'object' || !mensaje.datos) {
            throw new Error('Estructura de mensaje de confirmación inválida');
          }

          const { idMensaje, estado, timestamp = new Date().toISOString(), detalles = {}, tipo } = mensaje.datos;
          
          // Validar el esquema del mensaje
          try {
            validarMensajeConfirmacion({ idMensaje, estado, timestamp, detalles, tipo });
          } catch (error) {
            throw new Error(`Validación fallida: ${error.message}`);
          }

          log('info', 'Mensaje de confirmación validado', { idMensaje, estado, tipo });
          
          // Registrar la confirmación en el sistema de mensajería
          if (window.Mensajeria?.registrarConfirmacion) {
            try {
              await window.Mensajeria.registrarConfirmacion(idMensaje, {
                estado,
                timestamp,
                detalles,
                tipo
              });
              log('info', 'Confirmación registrada exitosamente');
            } catch (error) {
              log('error', 'Error al registrar confirmación', { error: error.message });
              throw new Error(`Error al registrar confirmación: ${error.message}`);
            }
          } else {
            log('warn', 'Sistema de mensajería no disponible para registrar confirmación');
          }

          // Manejar diferentes tipos de confirmaciones
          if (tipo) {
            log('debug', `Procesando confirmación de tipo: ${tipo}`);
            // Aquí podrías agregar lógica específica para diferentes tipos de confirmaciones
          }

          // Notificar al padre que la confirmación fue procesada
          if (window.Mensajeria?.enviarMensaje) {
            try {
              await window.Mensajeria.enviarMensaje(
                'padre',
                'confirmacion-procesada',
                {
                  idMensaje,
                  estado: 'procesado',
                  timestamp: new Date().toISOString(),
                  detalles: {
                    origen: 'hijo2',
                    transaccion: ID_TRANSACCION
                  }
                },
                { maxRetries: 2, retryDelay: 500 }
              );
              log('info', 'Notificación de confirmación procesada enviada al padre');
            } catch (error) {
              log('error', 'Error al notificar al padre', { error: error.message });
              // No relanzamos el error para no marcar la confirmación como fallida
            }
          }

          return {
            estado: 'procesado',
            idMensaje,
            timestamp: new Date().toISOString(),
            transaccion: ID_TRANSACCION
          };
          
        } catch (error) {
          log('error', 'Error al procesar confirmación', { 
            error: error.message,
            intento,
            maxIntentos 
          });

          // Reintentar si no hemos alcanzado el máximo de intentos
          if (intento < maxIntentos) {
            const tiempoEspera = Math.min(1000 * Math.pow(2, intento - 1), 10000);
            log('info', `Reintentando en ${tiempoEspera}ms...`, { intento: intento + 1 });
            
            await new Promise(resolve => setTimeout(resolve, tiempoEspera));
            return manejarConfirmacion(mensaje, intento + 1, maxIntentos);
          }

          // Notificar el error al padre
          if (window.Mensajeria?.enviarMensaje) {
            try {
              await window.Mensajeria.enviarMensaje(
                'padre',
                'error-procesar-confirmacion',
                {
                  error: error.message || 'Error desconocido al procesar confirmación',
                  mensajeOriginal: mensaje,
                  timestamp: new Date().toISOString(),
                  intentos: intento,
                  transaccion: ID_TRANSACCION
                },
                { maxRetries: 2, retryDelay: 500 }
              );
            } catch (notifyError) {
              log('error', 'Error al notificar error al padre', { error: notifyError.message });
            }
          }

          // Lanzar el error para que el sistema de mensajería lo maneje
          throw new Error(`Error después de ${intento} intentos: ${error.message}`);
        }
      }
      
      // Función auxiliar para notificar cambios de estado
      async function notificarCambioEstado(estado, datos = {}) {
        try {
          await window.Mensajeria.enviarMensaje(
            'padre',
            'cambio-estado',
            {
              estado,
              timestamp: new Date().toISOString(),
              ...datos
            }
          );
        } catch (error) {
          console.error(`[HIJO2] Error al notificar cambio de estado (${estado}):`, error);
        }
      }
      
      // Hacer las funciones disponibles globalmente para compatibilidad
      window.inicializarMensajeria = inicializarMensajeriaModulo;
      window.TIPOS_MENSAJE = TIPOS_MSG;
      window.enableControls = enableControls;
      window.disableControls = disableControls;
      
      // Inicializar la mensajería cuando el DOM esté listo
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializarMensajeria);
      } else {
        // Si el DOM ya está listo, inicializar inmediatamente
        setTimeout(inicializarMensajeria, 100);
      }
      window.manejarMensajeEntrante = manejarMensajeEntrante;
    </script>
    <style>
        :root {
            /* Variables de diseño para botones */
            --btn-size: 60px;
            --icon-size: 1.5em;
        }

        body {
            margin: 0;
            padding: 5px;
            background: transparent;
            font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif; /* IGUALADO: Misma fuente elegante que hijo3 */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        /* Contenedor principal con la forma trapezoidal (ancho arriba, estrecho abajo) */
        .container {
            width: 290px; /* AJUSTADO: Reducido de 340px a 290px, igualado con hijo3 */
            height: 155px; /* Altura aumentada para incluir márgenes */
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.13);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            padding: 5px 8px;
            box-sizing: border-box;
            margin: 5px 0;
            clip-path: polygon(0% 0%, 100% 0%, 92% 100%, 8% 100%);
        }

        /* Contenedor de botones de navegación */
        .nav-buttons-container {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .nav-button {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            color: white;
            font-size: var(--icon-size);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                       transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                       box-shadow 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* Los botones de Ruta y Brújula siempre permanecen verdes */
        #btn-ruta, #btn-brujula {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
        }
        
        /* Estado inicial del botón Punto de Interés (verde) */
        #btn-punto {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .nav-button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .botones-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin: 2px 0;
        }

        .boton {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            font-size: var(--icon-size);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                       background 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                       transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                       box-shadow 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            flex-shrink: 0;
        }
        
        /* Button states */
        /* Red gradient for disabled/initial state */
        .boton,
        .boton.disabled {
            background: linear-gradient(135deg, #dc3545, #c82333) !important;
        }
        
        /* Green gradient for active/enabled state */
        .boton:not(.disabled) {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
        }

        .boton.activo {
            background: linear-gradient(135deg, #28a745, #20c997);
            box-shadow: 0 3px 8px rgba(40, 167, 69, 0.3);
        }

        .boton:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }

        .boton.activo:hover {
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .boton:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.1s ease;
        }

        .boton.disabled {
            background: linear-gradient(135deg, #dc3545, #c82333);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .boton.activo {
            animation: subtle-pulse 2s infinite;
        }

        @keyframes subtle-pulse {
            0%, 100% { box-shadow: 0 3px 8px rgba(40, 167, 69, 0.3); }
            50% { box-shadow: 0 3px 8px rgba(40, 167, 69, 0.5); }
        }

        .boton.transitioning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);
        }

        .boton.disabled:hover {
            transform: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
        }

        /* Estilos para los iconos */
        .icon-gps {
            font-size: var(--icon-size);
        }
        
        .icon-imagen {
            font-size: var(--icon-size);
        }
        
        .icon-video {
            font-size: var(--icon-size);
        }

        .status {
            margin: 2px 0;
            padding: 3px;
            background: white;
            border-radius: 5px;
            font-size: 10px;
            text-align: center;
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 90%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .gps-icon {
            width: 16px;
            height: 16px;
            margin-right: 5px;
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @media (max-width: 500px) {
            body { padding: 2px; }
            .container {
                width: 98vw;
                height: 155px;
            }
            .progress-container { margin: 1px 0; }
            .time-display { margin: 1px 0; }
            .botones-row { gap: 8px; margin: 1px 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-buttons-container">
            <button id="btn-punto" class="nav-button" title="Punto de interés">📍</button>
            <button id="btn-ruta" class="nav-button" title="Ver ruta">🗺️</button>
            <button id="btn-brujula" class="nav-button" title="Brújula">🧭</button>
        </div>
        <div class="botones-row">
            <button id="btn-gps" class="boton">
                <span class="icon-gps">🛰️</span>
            </button>
            <button id="btn-imagen" class="boton">
                <span class="icon-imagen">📸</span>
            </button>
            <button id="btn-video" class="boton">
                <span class="icon-video">📽️</span>
            </button>
        </div>

        <div class="status" id="status" style="display: none;">
            <!-- Mensaje flotante ahora será manejado por el padre -->
        </div>
    </div>

    <script>
        // ================== COORDENADAS DE LAS PARADAS ==================
       
          const COORDENADAS_PARADAS = [
    {
        id: 'P-0',
        tipo: "inicio",
        parada: 0, // ← Parada 0 – INICIO (223, 226, 228, 229) reto 2 //
        nombre: "Torres de Serranos (start)",
        coordenadas: { lat: 39.47876, lng: -0.37626 },
        imagen: 'fotos_Av1/00_torres_de_serranos_back.jpg',
        video: 'videos/parada_0.mp4',
    },
    {
        id: 'TR-1',
        tipo: "tramo",
        tramo: 1, // ← tramo 1 (Torres de Serranos → Plaza de la crida) (2, 126,) //
        nombre: "Torres de Serranos → Plaza de la crida (Puente de Serranos)",
        inicio: { lat: 39.47876, lng: -0.37626 },
        waypoints: [
            { lat: 39.47905, lng: -0.37613 },
            { lat: 39.47933, lng: -0.37647 },
            { lat: 39.47943, lng: -0.37636 }
        ],
        fin: { lat: 39.47959, lng: -0.37583 },
        imagen: 'fotos_Av1/01_torres_de_serranos_front.jpg',
        video: 'videos/tramo_1.mp4',
    },
    {
        id: 'P-1',
        tipo: "parada",
        parada: 1, // ← Parada 1 - Plaza de la crida (Puente de Serranos) (233) Reto 3 //
        nombre: "Plaza de la crida (Puente de Serranos)",
        coordenadas: { lat: 39.47959, lng: -0.37583 },
        imagen: 'fotos_Av1/01_torres_de_serranos_front.jpg',
    },
    {
        id: 'TR-2',
        tipo: "tramo",
        tramo: 2, // ← tramo 2 (Plaza de la crida → Calle Muro de Santa Ana) (81) //
        nombre: "Plaza de la crida → Calle Muro de Santa Ana",
        inicio: { lat: 39.47959, lng: -0.37583 },
        waypoints: [
            { lat: 39.47939, lng: -0.3752 },
            { lat: 39.47902, lng: -0.37465 },
            { lat: 39.47866, lng: -0.3747 }
        ],
        fin: { lat: 39.47866, lng: -0.3747 },
        imagen: 'muro de Santa ana.jpg',
        video: 'videos/tramo 2_2.mp4',
    },
    {
        id: 'P-2',
        tipo: "parada",
        parada: 2, // ← Parada 2 (Calle Muro de Santa Ana) (68) Reto 4 //
        nombre: "Calle Muro de Santa Ana",
        coordenadas: { lat: 39.47866, lng: -0.3747 },
        imagen: 'muro de Santa ana.jpg',
    },
    {
        id: 'TR-3',
        tipo: "tramo",
        tramo: 3, // ← tramo 3 (Calle Muro de Santa Ana → Palacio de los Borgia) (52) //
        nombre: "Calle Muro de Santa Ana → Palacio de los Borgia",
        inicio: { lat: 39.47866, lng: -0.3747 },
        waypoints: [],
        fin: { lat: 39.47768, lng: -0.3749 },
        imagen: 'fotos_Av1/02_cortes_valencianas.jpg',
        video: 'videos/tramo_3.mp4',
    },
    {
        id: 'P-3',
        tipo: "parada",
        parada: 3, // ← Parada 3 (Iglesia de San Lorenzo) (686, 682-B, 462, 683, 684) Reto 5 //
        nombre: "Iglesia de San Lorenzo",
        coordenadas: { lat: 39.47768, lng: -0.3749 },
        imagen: 'fotos_Av1/03_iglesia_de_san_lorenzo.jpg',
    },
    {
        id: 'TR-4',
        tipo: "tramo",
        tramo: 4, // ← tramo 4 (Iglesia de San Lorenzo → Plaza de la Virgen) (465-B) //
        nombre: "Iglesia de San Lorenzo → Plaza de la Virgen",
        inicio: { lat: 39.47768, lng: -0.3749 },
        waypoints: [],
        fin: { lat: 39.47656, lng: -0.37529 },
        imagen: 'fotos_Av1/04_plaza_de_la_virgen.jpg',
        video: 'videos/tramo_4.mp4',
    },
    {
        id: 'P-4',
        tipo: "parada",
        parada: 4, // ← Parada 4 (Plaza de la Virgen) (466, 467) Reto 6 //
        nombre: "Plaza de la Virgen Reto 6",
        coordenadas: { lat: 39.47656, lng: -0.37529 },
        imagen: 'fotos_Av1/04_plaza_de_la_virgen.jpg',
    },
    {
        id: 'P-5',
        tipo: "parada",
        parada: 5, // ← Parada 5 (Plaza de la Virgen) (468) Reto 7, 8 Puzzle plaza de la virgen //
        nombre: "Plaza de la Virgen Reto 7",
        coordenadas: { lat: 39.47656, lng: -0.37529 },
        imagen: 'fotos_Av1/04_plaza_de_la_virgen.jpg',
    },
    {
        id: 'TR-5',
        tipo: "tramo",
        tramo: 5, // ← tramo 5 (Plaza de la Virgen → Plaza de la Almoína) (477-B, 479, 141, 83, 8-C) //
        nombre: "Plaza de la Virgen → Plaza de la Almoína",
        inicio: { lat: 39.47656, lng: -0.37529 },
        waypoints: [
            { lat: 39.4766, lng: -0.37473 },
            { lat: 39.47656, lng: -0.37453 },
            { lat: 39.47606, lng: -0.3746 }
        ],
        fin: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/05_plaza_de_la_almoina.jpg',
        video: 'videos/tramo_5.mp4',
    },
    {
        id: 'P-6',
        tipo: "parada",
        parada: 6, // ← Parada 6 (Panel cerámico muro Catedral) (434, 440, 441, 442) Reto 9 //
        nombre: "Panel cerámico muro Catedral",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/06_panel_ceramico_muro_norte_catedral.jpg',
    },
    {
        id: 'P-7',
        tipo: "parada",
        parada: 7, // ← Parada 7 (Capilla exterior catedral) (443, 444, 445) Reto 10 //
        nombre: "Capilla exterior catedral Reto 10",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/07!!!_capilla_exterior_catedral.jpg',
    },
    {
        id: 'P-8',
        tipo: "parada",
        parada: 8, // ← Parada 8 (Capilla exterior catedral) (445) Reto 11 //
        nombre: "Capilla exterior catedral Reto 11",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/07!!!_capilla_exterior_catedral.jpg',
    },
    {
        id: 'P-9',
        tipo: "parada",
        parada: 9, // ← Parada 9 (Arco Novo Catedral y Puerta Negra Basílica) (446, 355, 447, 11-B, 451, 452) //
        nombre: "Arco Novo Catedral y Puerta Negra Basílica",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/08_arco_novo_catedral.jpg',
        imagen2: 'fotos_Av1/09_puerta_negra_relieve_basilica.jpg',
    },
    // PARADA 10
    {
        id: 'P-10',
        tipo: "parada",
        parada: 10,
        nombre: "Casa del Punt de Gantxo",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/10_casa_del_punt_de_gantxo.jpg',
    },
    {
        id: 'TR-6',
        tipo: "tramo",
        tramo: 6, // ← tramo 6 (Plaza de la Almoína → Plaza Decimo Junio Bruto) (457, 10-B) //
        nombre: "Plaza de la Almoína → Plaza Decimo Junio Bruto (Museo Arqueológico de la Almoína)",
        inicio: { lat: 39.47594, lng: -0.37474 },
        waypoints: [],
        fin: { lat: 39.4762, lng: -0.37412 },
        imagen: 'fotos_Av1/05_plaza_de_la_almoina.jpg',
        video: 'videos/tramo_6.mp4',
    },
    {
        id: 'P-11',
        tipo: "parada",
        parada: 11, // ← Parada 11 (Museo arqueológico La Almoína) (458) Reto 13 //
        nombre: "Museo arqueológico La Almoína",
        coordenadas: { lat: 39.4762, lng: -0.37412 },
        imagen: 'fotos_Av1/27_museo_la_almoina.jpg',
    },
    {
        id: 'P-12',
        tipo: "parada",
        parada: 12, // ← Parada 12 (Museo arqueológico La Almoína) (459, 460, 461) //
        nombre: "Museo arqueológico La Almoína",
        coordenadas: { lat: 39.4762, lng: -0.37412 },
        imagen: 'fotos_Av1/27_museo_la_almoina.jpg',
    },
    {
        id: 'P-13',
        tipo: "parada",
        parada: 13, // ← Parada 13 (Vista de la Catedral, Cimborrio) (8-C, 464) Reto14 //
        nombre: "Vista de la Catedral, Cimborrio",
        coordenadas: { lat: 39.4762, lng: -0.37412 },
        imagen: 'fotos_Av1/05_plaza_de_la_almoina.jpg',
    },
    {
        id: 'TR-7',
        tipo: "tramo",
        tramo: 7, // ← tramo 7 (Museo arqueológico La Almoína → Palacio Arzobispal) (85) //
        nombre: "Museo arqueológico La Almoína → Palacio Arzobispal",
        inicio: { lat: 39.47611, lng: -0.37478 },
        waypoints: [
            { lat: 39.47604, lng: -0.37442 },
            { lat: 39.47584, lng: -0.37443 },
            { lat: 39.47561, lng: -0.37451 }
        ],
        fin: { lat: 39.4755, lng: -0.37436 },
        imagen: 'fotos_Av1/11_palacio_arzobispal.jpg',
        video: 'videos/parada_8.mp4',
    },
    {
        id: 'P-14',
        tipo: "parada",
        parada: 14, // ← Parada 14 (Palacio Arzobispal y Puerta Románica de la Catedral) (673, 86, 426-B, 141, 437, 438) Reto 15 //
        nombre: "Palacio Arzobispal y Puerta Románica de la Catedral",
        coordenadas: { lat: 39.4755, lng: -0.37436 },
        imagen: 'fotos_Av1/12_puerta_romanica_catedral.jpg',
    },
    {
        id: 'P-15',
        tipo: "parada",
        parada: 15, // ← Parada 15 (Puerta Románica de la Catedral) (439) //
        nombre: "Puerta Románica de la Catedral",
        coordenadas: { lat: 39.47561, lng: -0.37465 },
        imagen: 'fotos_Av1/12_puerta_romanica_catedral.jpg',
    },
    {
        id: 'TR-8',
        tipo: "tramo",
        tramo: 8, // ← tramo 8 (Puerta Románica de la Catedral → Plaza del Ayuntamiento) (125) //
        nombre: "Puerta Románica de la Catedral → Plaza del Ayuntamiento",
        inicio: { lat: 39.47561, lng: -0.37465 },
        waypoints: [
            { lat: 39.4756, lng: -0.37466 },
            { lat: 39.47514, lng: -0.37494 },
            { lat: 39.47447, lng: -0.3754 },
            { lat: 39.47378, lng: -0.3756 },
            { lat: 39.47212, lng: -0.37676 }
        ],
        fin: { lat: 39.47056, lng: -0.37677 },
        imagen: 'fotos_Av1/13_plaza_del_ayuntamiento.jpg',
        video: 'videos/tramo_8.mp4',
    },
    {
        id: 'P-16',
        tipo: "parada",
        parada: 16, // ← Parada 16 (Plaza del Ayuntamiento) (13-B, 263, 332, 14-C) //
        nombre: "Plaza del Ayuntamiento",
        coordenadas: { lat: 39.47056, lng: -0.37677 },
        imagen: 'fotos_Av1/13_plaza_del_ayuntamiento.jpg',
    },
    {
        id: 'TR-9',
        tipo: "tramo",
        tramo: 9, // ← tramo 9 (Plaza del Ayuntamiento → Edificio del Ayuntamiento) (334, 335) //
        nombre: "Plaza del Ayuntamiento → Edificio del Ayuntamiento de València",
        inicio: { lat: 39.47056, lng: -0.37677 },
        waypoints: [],
        fin: { lat: 39.46971, lng: -0.37693 },
        imagen: 'fotos_Av1/14_ayuntamiento.jpg',
        video: 'videos/tramo_9.mp4',
    },
    {
        id: 'P-17',
        tipo: "parada",
        parada: 17, // ← Parada 17 (Edificio del Ayuntamiento) (336, 337, 338) Reto 16 //
        nombre: "Edificio del Ayuntamiento",
        coordenadas: { lat: 39.46971, lng: -0.37693 },
        imagen: 'fotos_Av1/14_ayuntamiento.jpg',
    },
    {
        id: 'P-18',
        tipo: "parada",
        parada: 18, // ← Parada 18 (Edificio del Ayuntamiento) (339, 340, 341, 54) //
        nombre: "Edificio del Ayuntamiento",
        coordenadas: { lat: 39.46971, lng: -0.37693 },
        imagen: 'fotos_Av1/14_ayuntamiento.jpg',
    },
    {
        id: 'TR-10',
        tipo: "tramo",
        tramo: 10, // ← tramo 10 (Edificio del Ayuntamiento → Estación del Norte) (87, 15-C) //
        nombre: "Edificio del Ayuntamiento → Estación del Norte",
        inicio: { lat: 39.46971, lng: -0.37693 },
        waypoints: [
            { lat: 39.46795, lng: -0.37701 }
        ],
        fin: { lat: 39.46722, lng: -0.37702 },
        imagen: 'fotos_Av1/15_plaza_de_toros_y_estacion_del_norte.jpg',
        video: 'videos/tramo_10.mp4',
    },
    {
        id: 'P-19',
        tipo: "parada",
        parada: 19, // ← Parada 19 (Estación del Norte) (326) Reto 17, 18 Puzzle Estación del Norte//
        nombre: "Estación del Norte",
        coordenadas: { lat: 39.46722, lng: -0.37702 },
        imagen: 'fotos_Av1/15_plaza_de_toros_y_estacion_del_norte.jpg',
    },
    {
        id: 'TR-11',
        tipo: "tramo",
        tramo: 11, // ← tramo 11 (Estación del Norte → Plaza de Toros) (20-C, 323-B, 88) //
        nombre: "Estación del Norte → Plaza de Toros de València",
        inicio: { lat: 39.46722, lng: -0.37702 },
        waypoints: [],
        fin: { lat: 39.46709, lng: -0.37595 },
        imagen: 'fotos_Av1/15_plaza_de_toros_y_estacion_del_norte.jpg',
        video: 'videos/tramo_11.mp4',
    },
    {
        id: 'TR-12',
        tipo: "tramo",
        tramo: 12, // ← Tramo 12 (Plaza de Toros → Casa estilo Árabe) (89, 3-D) //
        nombre: "Plaza de Toros → Casa estilo Árabe",
        inicio: { lat: 39.46709, lng: -0.37595 },
        waypoints: [
            { lat: 39.46714, lng: -0.37498 }
        ],
        fin: { lat: 39.46753, lng: -0.37511 },
        imagen: 'fotos_Av1/16!!!!_casa_estilo_arabe.jpg',
        video: 'videos/parada_13.mp4',
    },
    {
        id: 'P-20',
        tipo: "parada",
        parada: 20, // ← Parada 20 (Casa estilo Árabe) (99) Reto 19 //
        nombre: "Casa estilo Árabe",
        coordenadas: { lat: 39.46753, lng: -0.37511 },
        imagen: 'fotos_Av1/16!!!!_casa_estilo_arabe.jpg',
    },
    {
        id: 'P-21',
        tipo: "parada",
        parada: 21, // ← Parada 21 (Casa estilo Árabe, mitad Aventura) (100) //
        nombre: "Casa estilo Árabe, mitad Aventura",
        coordenadas: { lat: 39.46753, lng: -0.37511 },
        imagen: 'fotos_Av1/16!!!!_casa_estilo_arabe.jpg',
    },
    {
        id: 'TR-13',
        tipo: "tramo",
        tramo: 13, // ← tramo 13 (Casa estilo Árabe → Palacio de Comunicaciones) (21-B) //
        nombre: "Casa estilo Árabe → Palacio de Comunicaciones (Correos)",
        inicio: { lat: 39.46753, lng: -0.37511 },
        waypoints: [],
        fin: { lat: 39.46942, lng: -0.37559 },
        imagen: 'fotos_Av1/17_correos.jpg',
        video: 'videos/tramo_13.mp4',
    },
    {
        id: 'P-22',
        tipo: "parada",
        parada: 22, // ← Parada 22 (Palacio de Comunicaciones) (21-C) //
        nombre: "Palacio de Comunicaciones: Correos",
        coordenadas: { lat: 39.46942, lng: -0.37559 },
        imagen: 'fotos_Av1/17_correos.jpg',
    },
    {
        id: 'P-23',
        tipo: "parada",
        parada: 23, // ← Parada 23 (Edificio Suay) (22-C) //
        nombre: "Edificio Suay",
        coordenadas: { lat: 39.46942, lng: -0.37559 },
        imagen: 'fotos_Av1/18_edificio_suay.jpg',
    },
    {
        id: 'TR-14',
        tipo: "tramo",
        tramo: 14, // ← tramo 14 (Palacio de Comunicaciones → Banco de València) (90) //
        nombre: "Palacio de Comunicaciones → Banco de València",
        inicio: { lat: 39.46942, lng: -0.37559 },
        waypoints: [
            { lat: 39.4699, lng: -0.37573 },
            { lat: 39.4703, lng: -0.3759 },
            { lat: 39.47039, lng: -0.37505 },
            { lat: 39.47043, lng: -0.37427 }
        ],
        fin: { lat: 39.47061, lng: -0.37408 },
        imagen: 'fotos_Av1/19_banco_de_valencia.jpg',
        video: 'videos/tramo_14.mp4',
    },
    {
        id: 'P-24',
        tipo: "parada",
        parada: 24, // ← Parada 24 (Banco de Valencia) (23-C) //
        nombre: "Banco de Valencia",
        coordenadas: { lat: 39.47061, lng: -0.37408 },
        imagen: 'fotos_Av1/19_banco_de_valencia.jpg',
    },
    {
        id: 'TR-15',
        tipo: "tramo",
        tramo: 15, // ← tramo 15 (Banco de València → Palacio del Marqués de Dos Aguas) (91) //
        nombre: "Banco de València → Palacio del Marqués de Dos Aguas (Museo Nacional de Cerámica)",
        inicio: { lat: 39.47061, lng: -0.37408 },
        waypoints: [
            { lat: 39.47119, lng: -0.37423 },
            { lat: 39.47214, lng: -0.37446 },
            { lat: 39.47275, lng: -0.37445 }
        ],
        fin: { lat: 39.47276, lng: -0.37467 },
        imagen: 'fotos_Av1/20!!!!_ marques_de_dos aguas.jpg',
        video: 'videos/parada_16.mp4',
    },
    {
        id: 'P-25',
        tipo: "parada",
        parada: 25, // ← Parada 25 (Palacio del Marqués de Dos Aguas) (24-C, 25-C, 26-C, 27-C, 28-C, 29-C, 30-C, 31-C, 32-C, 33-C, 34-C, 35-C) //
        nombre: "Palacio del Marqués de Dos Aguas (Museo Nacional de Cerámica)",
        coordenadas: { lat: 39.47276, lng: -0.37467 },
        imagen: 'fotos_Av1/20!!!!_ marques_de_dos aguas.jpg',
    },
    {
        id: 'TR-16',
        tipo: "tramo",
        tramo: 16, // ← tramo 16 (Palacio del Marqués → Mercado Central) (92, 93) //
        nombre: "Palacio del Marqués → Mercado Central",
        inicio: { lat: 39.47276, lng: -0.37467 },
        waypoints: [
            { lat: 39.47315, lng: -0.37608 },
            { lat: 39.47261, lng: -0.37654 },
            { lat: 39.47225, lng: -0.37686 },
            { lat: 39.47265, lng: -0.37725 }
        ],
        fin: { lat: 39.47377, lng: -0.37832 },
        imagen: 'fotos_Av1/21_mercado_central.jpg',
        video: 'videos/tramo_16.mp4',
    },
    {
        id: 'P-26',
        tipo: "parada",
        parada: 26, // ← Parada 26 (Mercado central) (36-C, 37-C, 38-C, 39-C, 40-C, 41-C, 42-C, 43-C) //
        nombre: "Mercado central",
        coordenadas: { lat: 39.47377, lng: -0.37832 },
        imagen: 'fotos_Av1/21_mercado_central.jpg',
    },
    {
        id: 'TR-17',
        tipo: "tramo",
        tramo: 17, // ← tramo 17 (Mercado Central → Iglesia de los Santos Juanes) (94) //
        nombre: "Mercado Central → Iglesia de los Santos Juanes",
        inicio: { lat: 39.47377, lng: -0.37832 },
        waypoints: [],
        fin: { lat: 39.47425, lng: -0.37895 },
        imagen: 'fotos_Av1/22_iglesia_san_juan_del_mercado.jpg',
        video: 'videos/tramo_17.mp4',
    },
    {
        id: 'P-27',
        tipo: "parada",
        parada: 27, // ← Parada 27 (Iglesia de los Santos Juanes) (44-C, 45-C, 46-C, 47-C, 48-C, 49-C, 50-C, 51-C, 52-C, 53-C, 54-C, 55-C, 56-C, 57-C, 58-C) //
        nombre: "Iglesia de los Santos Juanes reto 24",
        coordenadas: { lat: 39.47425, lng: -0.37895 },
        imagen: 'fotos_Av1/22_iglesia_san_juan_del_mercado.jpg',
    },
    {
        id: 'P-28',
        tipo: "parada",
        parada: 28, // ← Parada 28 (Iglesia de los Santos Juanes) (59-C) Reto 25 //
        nombre: "Iglesia de los Santos Juanes reto 25",
        coordenadas: { lat: 39.47425, lng: -0.37895 },
        imagen: 'fotos_Av1/22_iglesia_san_juan_del_mercado.jpg',
    },
    {
        id: 'TR-18',
        tipo: "tramo",
        tramo: 18, // ← tramo 18 (Iglesia Santos Juanes → Lonja de València) (95) //
        nombre: "Iglesia Santos Juanes → Lonja de València (Mercado de la Seda)",
        inicio: { lat: 39.47425, lng: -0.37895 },
        waypoints: [],
        fin: { lat: 39.47426, lng: -0.37862 },
        imagen: 'fotos_Av1/23_lonja.jpg',
        video: 'videos/parada_19.mp4',
    },
    {
        id: 'P-29',
        tipo: "parada",
        parada: 29, // ← Parada 29 (Lonja Puerta de Los Pecados barquero) (60-C) //
        nombre: "Lonja Puerta de Los Pecados barquero",
        coordenadas: { lat: 39.4742, lng: -0.37851 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        id: 'P-30',
        tipo: "parada",
        parada: 30, // ← Parada 30 (Lonja Puerta de Los Pecados árbol muerto) (60-C) //
        nombre: "Lonja Puerta de Los Pecados árbol muerto",
        coordenadas: { lat: 39.4742, lng: -0.37851 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        id: 'TR-19',
        tipo: "tramo",
        tramo: 19, // ← tramo 19 (Lonja Gárgolas) (96) //
        nombre: "Lonja Gárgolas",
        inicio: { lat: 39.4742, lng: -0.37851 },
        waypoints: [],
        fin: { lat: 39.4742, lng: -0.37881 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        id: 'P-31',
        tipo: "parada",
        parada: 31, // ← Parada 31 (Lonja Gárgolas ángel vasija) (61-C) //
        nombre: "Lonja Gárgolas ángel vasija",
        coordenadas: { lat: 39.4742, lng: -0.37881 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        id: 'P-32',
        tipo: "parada",
        parada: 32, // ← Parada 32 (Lonja Gárgolas barbudo y león) (61-C) //
        nombre: "Lonja Gárgolas barbudo y león",
        coordenadas: { lat: 39.4742, lng: -0.37881 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        id: 'P-33',
        tipo: "parada",
        parada: 33, // ← Parada 33 (Lonja Gárgolas fornicador ventana) (61-C) //
        nombre: "Lonja Gárgolas fornicador ventana",
        coordenadas: { lat: 39.47439, lng: -0.37887 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        id: 'TR-20',
        tipo: "tramo",
        tramo: 20, // ← tramo 20 (Lonja → Plaza del Doctor Collado) (97) //
        nombre: "Lonja → Plaza del Doctor Collado",
        inicio: { lat: 39.47426, lng: -0.37862 },
        waypoints: [
            { lat: 39.47445, lng: -0.37889 },
            { lat: 39.47459, lng: -0.37868 },
            { lat: 39.47475, lng: -0.37842 },
            { lat: 39.47436, lng: -0.37799 }
        ],
        fin: { lat: 39.47444, lng: -0.3779 },
        imagen: 'fotos_Av1/24_lonja2.jpg',
        video: 'videos/tramo_20.mp4',
    },
    {
        id: 'TR-21',
        tipo: "tramo",
        tramo: 21, // ← tramo 21 (Plaza del Doctor Collado → Plaza del Negrito) (333, 397, 41, 398, 198, 671, 522, 32-C) //
        nombre: "Plaza del Doctor Collado → Plaza del Negrito (Fuente del Negrito)",
        inicio: { lat: 39.47444, lng: -0.3779 },
        waypoints: [
            { lat: 39.47473, lng: -0.37763 },
            { lat: 39.47493, lng: -0.37761 },
            { lat: 39.47559, lng: -0.37772 }
        ],
        fin: { lat: 39.47611, lng: -0.37741 },
        imagen: 'fotos_Av1/25_fuente_del_negrito.jpg',
        video: 'videos/parada_21.mp4',
    },
    {
        id: 'P-34',
        tipo: "parada",
        parada: 34, // ← Parada 34 (Fuente del Negrito) (382, 501) Reto 32 //
        nombre: "Fuente del Negrito",
        coordenadas: { lat: 39.47611, lng: -0.37741 },
        imagen: 'fotos_Av1/25_fuente_del_negrito.jpg',
    },
    {
        id: 'TR-22',
        tipo: "tramo",
        tramo: 22, // ← tramo 22 (Plaza del Negrito → Calle Caballeros) (33-B, 486, 480-B) //
        nombre: "Plaza del Negrito → Calle Caballeros",
        inicio: { lat: 39.47611, lng: -0.37741 },
        waypoints: [
            { lat: 39.47663, lng: -0.3773 },
            { lat: 39.47661, lng: -0.37685 }
        ],
        fin: { lat: 39.47668, lng: -0.37671 },
        imagen: 'fotos_Av1/26_palau_de_la_generalitat.jpg',
        video: 'videos/parada_22.mp4',
    },
    {
        id: 'P-35',
        tipo: "parada",
        parada: 35, // ← Parada 35 (Palau de la Generalitat) (481-B, 482-B, 2-D) //
        nombre: "Palau de la Generalitat",
        coordenadas: { lat: 39.47668, lng: -0.37671 },
        imagen: 'fotos_Av1/26_palau_de_la_generalitat.jpg',
    },
    {
        id: 'TR-23',
        tipo: "tramo",
        tramo: 23, // ← tramo 23 (Palacio de la Generalitat → Calle de los Serranos - FINAL) //
        nombre: "Palacio de la Generalitat → Calle de los Serranos (FINAL)",
        inicio: { lat: 39.47668, lng: -0.37671 },
        waypoints: [
            { lat: 39.47661, lng: -0.37685 },
            { lat: 39.47687, lng: -0.37686 }
        ],
        fin: { lat: 39.47773, lng: -0.37671 },
        imagen: 'fotos_Av1/00_torres_de_serranos_back.jpg',
        video: 'videos/parada_24.mp4',
    },
    {
        id: 'P-36',
        tipo: "parada",
        parada: 36, // ← Parada 36 (Torres de Serranos Final) (audio despedida) //
        nombre: "Torres de Serranos Final",
        coordenadas: { lat: 39.47773, lng: -0.37671 },
    }
];

        // ================== SISTEMA DE MENSAJERÍA ==================
        // Ahora usando mensajeria.js para toda la comunicación
        
        // Variables globales para el botón de punto
        // Estas variables están definidas en otra parte del código
        // puntoDestino: Almacena el punto de destino actual (coordenadas y metadatos)
        // marcadorDestino: Referencia al marcador de destino en el mapa
        // polylineNavegacion: Referencia a la línea de navegación en el mapa
        // RADIO_LLEGADA: Radio en metros para considerar que se ha llegado al destino (50m)
        let intervaloVerificacionDestino = null; // Referencia al intervalo de verificación de llegada
        
        /**
         * Maneja los mensajes de destino recibidos del padre
         * @param {Object} mensaje - El mensaje recibido
         */
        function manejarMensajeDestino(mensaje) {
            console.log('[NAVEGACION] Mensaje de destino recibido:', mensaje);
            
            // Verificar si es una respuesta a una solicitud de destino
            if (mensaje.tipo === window.Mensajeria.TIPOS_MENSAJE.NAVEGACION || 
                (mensaje.datos && mensaje.datos.accion === 'establecer_destino')) {
                
                const datosDestino = mensaje.datos || {};
                
                // Verificar si hay coordenadas válidas
                if (typeof datosDestino.lat === 'number' && typeof datosDestino.lng === 'number') {
                    // Habilitar el botón de punto si estaba deshabilitado
                    const btnPunto = document.getElementById('btn-punto');
                    if (btnPunto && btnPunto.classList.contains('disabled')) {
                        btnPunto.classList.remove('disabled');
                        btnPunto.title = 'Activar navegación al punto de interés';
                    }
                    
                    // Iniciar la navegación al destino
                    const exito = iniciarNavegacionADestino({
                        lat: datosDestino.lat,
                        lng: datosDestino.lng,
                        nombre: datosDestino.nombre || 'Punto de interés',
                        descripcion: datosDestino.descripcion || ''
                    });
                    
                    if (exito) {
                        // Notificar al usuario
                        actualizarStatus(`Destino establecido: ${datosDestino.nombre || 'Punto de interés'}`, 'exito');
                        // Confirmar al padre que el destino se estableció correctamente
                        window.Mensajeria.enviarMensaje('padre', 'destino-establecido', {
                            exito: true,
                            idDestino: datosDestino.id,
                            nombre: datosDestino.nombre,
                            timestamp: new Date().toISOString()
                        });
                    } else {
                        actualizarStatus('Error: No se pudo establecer el destino', 'error');
                        window.Mensajeria.enviarMensaje('padre', 'error-destino', {
                            error: 'No se pudo establecer el destino',
                            idDestino: datosDestino.id,
                            timestamp: new Date().toISOString()
                        });
                    }
                } else {
                    console.error('[NAVEGACION] Coordenadas de destino inválidas en el mensaje', datosDestino);
                    actualizarStatus('Error: Coordenadas de destino inválidas', 'error');
                    
                    // Notificar al padre del error
                    window.Mensajeria.enviarMensaje('padre', 'error-destino', {
                        error: 'Coordenadas de destino inválidas',
                        idDestino: datosDestino.id,
                        timestamp: new Date().toISOString()
                    });
                }
            } 
            // Manejar cancelación de destino
            else if (mensaje.tipo === 'CANCELAR_NAVEGACION' || 
                    (mensaje.datos && mensaje.datos.accion === 'cancelar_navegacion')) {
                
                // Simular clic en el botón de punto para cancelar la navegación
                const btnPunto = document.getElementById('btn-punto');
                if (btnPunto && btnPunto.classList.contains('activo')) {
                    btnPunto.click();
                    
                    // Notificar al padre que la navegación fue cancelada
                    window.Mensajeria.enviarMensaje('padre', 'navegacion-cancelada', {
                        timestamp: new Date().toISOString(),
                        idDestino: puntoDestino?.id
                    });
                }
                
                actualizarStatus('Navegación cancelada', 'info');
            }
            // Manejar solicitud de estado actual
            else if (mensaje.tipo === 'SOLICITUD_ESTADO_NAVEGACION') {
                const estado = {
                    tipo: 'ESTADO_NAVEGACION',
                    navegacionActiva: puntoDestino !== null,
                    destino: puntoDestino,
                    timestamp: new Date().toISOString()
                };
                
                // Enviar estado actual al padre usando el sistema de mensajería
                window.Mensajeria.enviarMensaje(
                    'padre',
                    window.Mensajeria.TIPOS_MENSAJE.NAVEGACION,
                    estado
                );
            }
        }
        
        /**
         * Inicia la navegación hacia un destino específico
         * @param {Object} destino - Objeto con las coordenadas del destino y metadatos
         * @param {number} destino.lat - Latitud del destino
         * @param {number} destino.lng - Longitud del destino
         * @param {string} [destino.nombre] - Nombre opcional del destino
         * @param {string} [destino.descripcion] - Descripción opcional del destino
         * @returns {boolean} - True si se pudo iniciar la navegación, false en caso contrario
         */
        function iniciarNavegacionADestino(destino) {
            if (!destino || typeof destino.lat !== 'number' || typeof destino.lng !== 'number') {
                console.error('[NAVEGACION] Coordenadas de destino inválidas', destino);
                actualizarStatus('Error: Coordenadas de destino inválidas', 'error');
                
                // Notificar al padre del error
                window.Mensajeria.enviarMensaje('padre', 'error-destino', {
                    error: 'Coordenadas de destino inválidas',
                    destino: {
                        lat: destino?.lat,
                        lng: destino?.lng,
                        nombre: destino?.nombre
                    },
                    timestamp: new Date().toISOString()
                });
                
                return false;
            }
            
            console.log(`[NAVEGACION] Iniciando navegación hacia destino:`, destino);
            
            try {
                // Notificar al padre que se está iniciando la navegación
                window.Mensajeria.enviarMensaje(
                    'padre',
                    'inicio-navegacion',
                    {
                        destino: {
                            lat: destino.lat,
                            lng: destino.lng,
                            nombre: destino.nombre || 'Destino',
                            descripcion: destino.descripcion || ''
                        },
                        timestamp: new Date().toISOString()
                    },
                    {
                        maxRetries: 3,
                        timeout: 2000
                    }
                );
                
                // Almacenar el destino actual
                puntoDestino = {
                    id: destino.id || `destino-${Date.now()}`,
                    lat: destino.lat,
                    lng: destino.lng,
                    nombre: destino.nombre || 'Destino',
                    descripcion: destino.descripcion || '',
                    timestamp: new Date().toISOString()
                };
                
                // Crear marcador en el destino si no existe
                if (typeof crearMarcador === 'function') {
                    if (marcadorDestino) {
                        // Actualizar posición del marcador existente
                        if (typeof actualizarPosicionMarcador === 'function') {
                            actualizarPosicionMarcador(marcadorDestino, puntoDestino.lat, puntoDestino.lng);
                        }
                    } else {
                        // Crear nuevo marcador
                        marcadorDestino = crearMarcador({
                            lat: puntoDestino.lat,
                            lng: puntoDestino.lng,
                            titulo: puntoDestino.nombre,
                            color: '#ff0000', // Rojo para el destino
                            icono: 'flag',
                            hacerClickable: false
                        });
                    }
                }
                
                // Actualizar el estado del botón de punto
                const btnPunto = document.getElementById('btn-punto');
                if (btnPunto) {
                    btnPunto.classList.add('activo');
                    btnPunto.title = 'Desactivar navegación al punto de interés';
                    
                    // Deshabilitar otros botones mientras la navegación está activa
                    document.querySelectorAll('.boton:not(#btn-punto)').forEach(btn => {
                        btn.disabled = true;
                        btn.classList.add('disabled');
                    });
                }
                
                // Iniciar el seguimiento de la posición
                if (typeof iniciarGPS === 'function') {
                    iniciarGPS();
                }
                
                // Iniciar verificación de llegada al destino
                iniciarVerificacionDestino();
                
                // Notificar al padre que la navegación se inició correctamente
                window.Mensajeria.enviarMensaje('padre', 'navegacion-iniciada', {
                    idDestino: puntoDestino.id,
                    nombre: puntoDestino.nombre,
                    coordenadas: {
                        lat: puntoDestino.lat,
                        lng: puntoDestino.lng
                    },
                    timestamp: new Date().toISOString()
                });
                
                return true;
                
            } catch (error) {
                console.error('[NAVEGACION] Error al iniciar la navegación:', error);
                actualizarStatus('Error al iniciar la navegación', 'error');
                
                // Notificar al padre del error
                window.Mensajeria.enviarMensaje('padre', 'error-navegacion', {
                    error: error.message || 'Error desconocido al iniciar navegación',
                    destino: {
                        lat: destino.lat,
                        lng: destino.lng,
                        nombre: destino.nombre
                    },
                    timestamp: new Date().toISOString()
                });
                
                return false;
            }
            
            // Iniciar la verificación periódica de llegada al destino
            iniciarVerificacionDestino();
            
            // Si hay una ubicación actual, actualizar la polilínea
            if (ubicacionActual) {
                actualizarPolilineaNavegacion(ubicacionActual.lat, ubicacionActual.lng);
            }
            
            // Notificar al usuario
            actualizarStatus(`Navegando hacia: ${puntoDestino.nombre}`, 'info');
            
            return true;
        }
        
        /**
         * Verifica si el usuario ha llegado al destino basado en su ubicación actual
         * @param {Object} ubicacionActual - Objeto con latitud y longitud actuales
         * @returns {boolean} - True si el usuario ha llegado al destino, false en caso contrario
         */
        // Función unificada para verificar si se ha llegado al destino
        function verificarLlegadaADestino(ubicacionActual) {
            // Validación de parámetros
            if (!puntoDestino || !ubicacionActual || !ubicacionActual.lat || !ubicacionActual.lng) {
                console.error('[NAVEGACION] Datos de ubicación o destino no válidos');
                return false;
            }
            
            // Obtener coordenadas del destino (compatible con ambas versiones)
            const destinoLat = puntoDestino.lat || (puntoDestino.coordenadas?.lat);
            const destinoLng = puntoDestino.lng || (puntoDestino.coordenadas?.lng);
            
            if (!destinoLat || !destinoLng) {
                console.error('[NAVEGACION] Coordenadas de destino no válidas');
                return false;
            }
            
            // Calcular distancia al destino
            const distancia = calcularDistancia(
                ubicacionActual.lat, 
                ubicacionActual.lng,
                destinoLat,
                destinoLng
            );
            
            console.log(`[NAVEGACION] Distancia al destino: ${distancia.toFixed(2)} metros`);
            
            // Verificar si se ha llegado al destino (dentro del radio de llegada)
            if (distancia <= RADIO_LLEGADA) {
                const nombreDestino = puntoDestino.nombre || `Destino ${puntoDestino.id || ''}`.trim();
                console.log(`[NAVEGACION] ¡Llegada al destino! (${nombreDestino})`);
                
                // Notificar al padre usando la función centralizada
                if (window.Mensajeria?.enviarMensaje) {
                    window.Mensajeria.enviarMensaje(
                        'padre',
                        window.Mensajeria.TIPOS_MENSAJE.NAVEGACION,
                        {
                            tipo: 'llegada-parada',
                            parada: {
                                id: puntoDestino.id || 'desconocido',
                                nombre: nombreDestino,
                                lat: destinoLat,
                                lng: destinoLng
                            },
                            distancia: distancia,
                            timestamp: Date.now()
                        }
                    );
                } else if (window.parent) {
                    // Fallback para compatibilidad
                    window.parent.postMessage({
                        tipo: 'llegada-parada',
                        origen: 'hijo2',
                        datos: {
                            parada: {
                                id: puntoDestino.id || 'desconocido',
                                nombre: puntoDestino.nombre || 'Destino',
                                lat: puntoDestino.lat,
                                lng: puntoDestino.lng
                            },
                            distancia: distancia,
                            timestamp: Date.now()
                        }
                    }, '*');
                }
                
                // Limpiar la navegación actual
                limpiarNavegacion();
                
                // Limpiar marcadores y polilínea si existen
                if (marcadorDestino) {
                    map.removeLayer(marcadorDestino);
                    marcadorDestino = null;
                }
                
                if (polylineNavegacion) {
                    map.removeLayer(polylineNavegacion);
                    polylineNavegacion = null;
                }
                
                // Actualizar estado visual
                actualizarEstadoBotonPunto();
                
                // Mostrar mensaje al usuario
                actualizarStatus(`¡Has llegado a ${puntoDestino.nombre || 'tu destino'}!`, 'exito');
                
                // Limpiar referencia al punto de destino
                puntoDestino = null;
                
                return true;
            }
            
            // Actualizar la distancia en el título del botón
            const btnPunto = document.getElementById('btn-punto');
            if (btnPunto) {
                const distanciaKm = (distancia / 1000).toFixed(2);
                btnPunto.title = `Navegando a ${puntoDestino.nombre || 'destino'} (${distanciaKm} km)`;
            }
            
            return false;     
        }
        
        /**
         * Inicia la verificación periódica de llegada al destino
         */
        function iniciarVerificacionDestino() {
            // Limpiar cualquier intervalo existente
            if (intervaloVerificacionDestino) {
                clearInterval(intervaloVerificacionDestino);
            }
            
            // Verificar cada 3 segundos
            intervaloVerificacionDestino = setInterval(() => {
                if (ubicacionActual && puntoDestino) {
                    // Verificar si hemos llegado al destino
                    const distancia = calcularDistancia(
                        ubicacionActual.lat, 
                        ubicacionActual.lng,
                        puntoDestino.lat,
                        puntoDestino.lng
                    );
                    
                    // Actualizar la distancia en el título del botón
                    const btnPunto = document.getElementById('btn-punto');
                    if (btnPunto) {
                        btnPunto.title = `Navegando a ${puntoDestino.nombre} (${distancia.toFixed(0)} m)`;
                    }
                    
                    // Verificar si hemos llegado al destino
                    if (distancia <= RADIO_LLEGADA) {
                        verificarLlegadaADestino(ubicacionActual);
                    }
                }
            }, 3000); // Verificar cada 3 segundos
            
            console.log('[NAVEGACION] Iniciando verificación de llegada al destino');
        }
        
        /**
         * Actualiza la polilínea de navegación entre la ubicación actual y el destino
         * @param {number} lat - Latitud actual
         * @param {number} lng - Longitud actual
         */
        function actualizarPolilineaNavegacion(lat, lng) {
            if (!puntoDestino) return;
            
            const puntos = [
                [lat, lng],
                [puntoDestino.lat, puntoDestino.lng]
            ];
            
            // Crear o actualizar la polilínea
            if (typeof crearPolilinea === 'function') {
                if (polylineNavegacion) {
                    // Actualizar puntos de la polilínea existente
                    if (typeof actualizarPuntosPolilinea === 'function') {
                        actualizarPuntosPolilinea(polylineNavegacion, puntos);
                    }
                } else {
                    // Crear nueva polilínea
                    polylineNavegacion = crearPolilinea({
                        puntos: puntos,
                        color: '#3388ff', // Azul para la ruta
                        peso: 5,
                        opacidad: 0.7,
                        lineaDiscontinua: true
                    });
                }
            }
            
            // Actualizar la distancia restante en el título del botón
            const distancia = calcularDistancia(lat, lng, puntoDestino.lat, puntoDestino.lng);
            const btnPunto = document.getElementById('btn-punto');
            if (btnPunto) {
                btnPunto.title = `Navegando a ${puntoDestino.nombre} (${distancia.toFixed(0)} m)`;
            }
        }
        
        /**
         * Muestra un mensaje de estado al usuario, tanto en la interfaz como en la consola
         * @param {string} mensaje - El mensaje a mostrar
         * @param {string|Object} [opciones] - Puede ser un string con el tipo de mensaje o un objeto de opciones
         * @param {string} [opciones.tipo='info'] - Tipo de mensaje: 'info', 'exito', 'error', 'advertencia'
         * @param {number} [opciones.tiempoVisible=5000] - Tiempo en ms que el mensaje será visible (0 para permanente)
         * @param {boolean} [opciones.loading=false] - Si es true, indica que se está realizando una operación de carga
         * @param {boolean} [opciones.notificarPadre=true] - Si es true, notifica al iframe padre
         * @example
         * // Uso básico con tipo como string
         * actualizarStatus('Operación exitosa', 'exito');
         * 
         * // Uso con objeto de opciones
         * actualizarStatus('Cargando datos...', {
         *   tipo: 'info',
         *   loading: true,
         *   tiempoVisible: 0 // Mensaje permanente hasta la próxima actualización
         * });
         */
        function actualizarStatus(mensaje, opciones = {}) {
            // Manejar opciones como string (backward compatibility)
            const tipo = typeof opciones === 'string' ? opciones : (opciones.tipo || 'info');
            const tiempoVisible = typeof opciones === 'object' ? (opciones.tiempoVisible || 5000) : 5000;
            const loading = typeof opciones === 'object' ? (opciones.loading || false) : false;
            const notificarPadre = typeof opciones === 'object' ? (opciones.notificarPadre !== false) : true;
            
            // Log del mensaje
            console.log(`[ESTADO] ${mensaje}${loading ? ' (cargando...)' : ''}`);
            
            // Notificar al padre si está configurado
            if (notificarPadre && window.parent) {
                try {
                    window.parent.postMessage({
                        tipo: 'statusMensaje',
                        mensaje: mensaje,
                        loading: loading
                    }, '*');
                    console.log(`📱 HIJO 2: Status enviado al padre - ${mensaje}${loading ? ' (loading)' : ''}`);
                } catch (error) {
                    console.error('Error al notificar al padre:', error);
                }
            }
            
            // Buscar el elemento de estado o crearlo si no existe
            let estadoElemento = document.getElementById('estado-navegacion');
            
            if (!estadoElemento) {
                estadoElemento = document.createElement('div');
                estadoElemento.id = 'estado-navegacion';
                estadoElemento.style.position = 'fixed';
                estadoElemento.style.bottom = '20px';
                estadoElemento.style.left = '50%';
                estadoElemento.style.transform = 'translateX(-50%)';
                estadoElemento.style.padding = '10px 20px';
                estadoElemento.style.borderRadius = '20px';
                estadoElemento.style.color = 'white';
                estadoElemento.style.fontWeight = 'bold';
                estadoElemento.style.zIndex = '1000';
                estadoElemento.style.transition = 'opacity 0.5s ease-in-out';
                estadoElemento.style.opacity = '0';
                estadoElemento.style.pointerEvents = 'none';
                
                document.body.appendChild(estadoElemento);
                
                // Forzar reflow para que la transición funcione
                void estadoElemento.offsetWidth;
            }
            
            // Establecer el mensaje y el estilo según el tipo
            estadoElemento.textContent = mensaje;
            
            // Establecer color de fondo según el tipo
            switch (tipo) {
                case 'exito':
                    estadoElemento.style.backgroundColor = 'rgba(40, 167, 69, 0.9)';
                    break;
                case 'error':
                    estadoElemento.style.backgroundColor = 'rgba(220, 53, 69, 0.9)';
                    break;
                case 'advertencia':
                    estadoElemento.style.backgroundColor = 'rgba(255, 193, 7, 0.9)';
                    break;
                case 'info':
                default:
                    estadoElemento.style.backgroundColor = 'rgba(23, 162, 184, 0.9)';
            }
            
            // Mostrar el mensaje con animación
            estadoElemento.style.opacity = '1';
            
            // Ocultar el mensaje después del tiempo especificado
            if (tiempoVisible > 0) {
                // Limpiar cualquier timeout existente
                if (estadoElemento.timeoutId) {
                    clearTimeout(estadoElemento.timeoutId);
                }
                
                // Establecer un nuevo timeout
                estadoElemento.timeoutId = setTimeout(() => {
                    estadoElemento.style.opacity = '0';
                }, tiempoVisible);
            }
        }
        
        /**
         * Calcula la distancia en metros entre dos puntos geográficos usando la fórmula del haversine
         * @param {number} lat1 - Latitud del primer punto
         */
        function calcularDistancia(lat1, lng1, lat2, lng2) {
            // Validar parámetros
            if (typeof lat1 !== 'number' || typeof lng1 !== 'number' || 
                typeof lat2 !== 'number' || typeof lng2 !== 'number') {
                console.error('[NAVEGACION] Coordenadas inválidas para calcular distancia');
                return Infinity;
            }
            
            // Radio de la Tierra en metros
            const R = 6371000;
            
            // Convertir grados a radianes
            const radLat1 = lat1 * Math.PI / 180;
            const radLat2 = lat2 * Math.PI / 180;
            const deltaLat = (lat2 - lat1) * Math.PI / 180;
            const deltaLng = (lng2 - lng1) * Math.PI / 180;
            
            // Fórmula del haversine
            const a = 
                Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
                Math.cos(radLat1) * Math.cos(radLat2) *
                Math.sin(deltaLng / 2) * Math.sin(deltaLng / 2);
                
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            
            // Distancia en metros
            return R * c;
        }
        
        /**
         * Manejador de mensajes del padre
         * @param {string} tipo - Tipo de mensaje
         * @param {Object} datos - Datos del mensaje
         * @param {MessageEvent} event - Evento de mensaje
         */
        function manejarMensajesPadre(tipo, datos, event) {
            console.log(`[HIJO2] Mensaje recibido del padre - Tipo: ${tipo}`, datos);
            
            // Verificar si el mensaje es válido
            if (!tipo) {
                console.warn('[HIJO2] Mensaje sin tipo recibido', { datos, event });
                return;
            }
            
            try {
                // Usar el sistema de mensajería si está disponible
                if (window.Mensajeria && window.Mensajeria.manejarMensajeEntrante) {
                    // Convertir a formato de mensajería si es necesario
                    const mensaje = {
                        origen: 'padre',
                        destino: 'hijo2',
                        tipo: tipo,
                        datos: datos || {},
                        timestamp: Date.now()
                    };
                    
                    // Procesar mensajes de navegación con el manejador específico
                    if (tipo === 'DESTINO_ESTABLECIDO' || 
                        tipo === 'CANCELAR_NAVEGACION' || 
                        tipo === 'SOLICITUD_ESTADO_NAVEGACION' ||
                        (datos && (datos.accion === 'establecer_destino' || datos.accion === 'cancelar_navegacion'))) {
                        
                        console.log('[NAVEGACION] Redirigiendo mensaje al manejador de navegación:', tipo);
                        manejarMensajeDestino(mensaje);
                        return;
                    }
                    
                    // Procesar otros mensajes a través del sistema de mensajería
                    window.Mensajeria.manejarMensajeEntrante({ data: mensaje });
                } else {
                    // Manejo de mensajes sin el sistema de mensajería (compatibilidad)
                    console.warn('[HIJO2] Sistema de mensajería no disponible, usando manejo directo');
                    
                    // Manejar tipos de mensajes comunes
                    switch (tipo) {
                        case 'cambio_modo':
                            if (datos && typeof datos.modo === 'string') {
                                manejarCambioModo(datos.modo, true);
                            }
                            break;
                            
                        case 'habilitar_controles':
                            if (window.enableControls) {
                                window.enableControls(datos.modo || 'aventura');
                            }
                            break;
                            
                        case 'deshabilitar_controles':
                            if (window.disableControls) {
                                window.disableControls(datos.motivo || 'desconocido');
                            }
                            break;
                            
                        // Manejar mensajes de navegación
                        case 'DESTINO_ESTABLECIDO':
                        case 'CANCELAR_NAVEGACION':
                        case 'SOLICITUD_ESTADO_NAVEGACION':
                            console.log('[NAVEGACION] Procesando mensaje de navegación sin mensajería:', tipo);
                            manejarMensajeDestino({ tipo, datos: datos || {} });
                            break;
                            
                        default:
                            // Verificar si es un mensaje de acción de navegación
                            if (datos && (datos.accion === 'establecer_destino' || datos.accion === 'cancelar_navegacion')) {
                                console.log('[NAVEGACION] Procesando acción de navegación sin mensajería:', datos.accion);
                                manejarMensajeDestino({ tipo, datos });
                            } else {
                                console.log(`[HIJO2] Tipo de mensaje no manejado: ${tipo}`, datos);
                            }
                    }
                }
            } catch (error) {
                console.error('[HIJO2] Error al procesar mensaje del padre:', error, { tipo, datos });
            }
        }
        
        /**
         * Maneja los clics en los botones de la interfaz
         * @param {string} id - ID del botón que se ha pulsado
         */
        /**
         * Maneja el clic en el botón de punto de interés
         * - Si hay un destino activo, centra el mapa en él
         * - Si no hay destino, solicita uno al padre
         */
        function manejarClicBotonPunto() {
            const btnPunto = document.getElementById('btn-punto');
            if (!btnPunto) return;
            
            // Si hay un destino activo, centrar en él
            if (puntoDestino) {
                map.flyTo([puntoDestino.coordenadas.lat, puntoDestino.coordenadas.lng], 18);
                return;
            }
            
            // Si no hay un destino establecido, solicitamos uno al padre
            console.log('[BOTON PUNTO] Solicitando punto de destino al padre...');
            
            // Notificar al padre que necesitamos un punto de destino
            if (window.Mensajeria && window.Mensajeria.enviarMensaje) {
                window.Mensajeria.enviarMensaje(
                    'padre',
                    'SOLICITAR_DESTINO',
                    { timestamp: Date.now() }
                );
                
                // Deshabilitar temporalmente el botón hasta que recibamos una respuesta
                btnPunto.classList.add('disabled');
                btnPunto.title = 'Esperando confirmación...';
                
                // Establecer un timeout para volver a habilitar el botón si no hay respuesta
                setTimeout(() => {
                    if (!puntoDestino && btnPunto.classList.contains('disabled')) {
                        btnPunto.classList.remove('disabled');
                        btnPunto.title = 'No se pudo obtener el destino. Intente de nuevo.';
                        console.warn('No se recibió respuesta del padre al solicitar destino');
                    }
                }, 5000); // 5 segundos de timeout
            } else {
                console.error('No se pudo enviar la solicitud de destino: Mensajería no disponible');
                btnPunto.title = 'Error: No se pudo conectar con el sistema';
            }
        }
        
        /**
         * Limpia el destino de navegación actual
         * Elimina marcadores, polilíneas y restablece el estado
         */
        function limpiarDestinoNavegacion() {
            const btnPunto = document.getElementById('btn-punto');
            if (!btnPunto) return;
            
            // Limpiar el destino actual
            if (marcadorDestino) {
                // Eliminar marcador del mapa (si existe esta función)
                if (typeof eliminarMarcador === 'function') {
                    eliminarMarcador(marcadorDestino);
                }
                marcadorDestino = null;
            }
            
            // Eliminar polilínea de navegación (si existe)
            if (polylineNavegacion) {
                if (typeof eliminarPolilinea === 'function') {
                    eliminarPolilinea(polylineNavegacion);
                }
                polylineNavegacion = null;
            }
            
            // Restablecer el estado del botón
            btnPunto.classList.remove('activo');
            btnPunto.title = 'Activar navegación al punto de interés';
            puntoDestino = null;
            
            // Habilitar otros botones
            document.querySelectorAll('.boton:not(#btn-punto)').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('disabled');
            });
            
            console.log('[NAVEGACION] Navegación desactivada');
        }
        
        function manejarClicBoton(id) {
            console.log(`[BOTON] Clic en botón: ${id}`);
            
            // Verificar si el botón está deshabilitado
            const boton = document.getElementById(id);
            if (boton.classList.contains('disabled')) {
                console.log(`[BOTON] El botón ${id} está deshabilitado`);
                return;
            }
            
            switch (id) {
                case 'btn-punto':
                    manejarClicBotonPunto();
                    break;
                    
                case 'btn-ruta':
                    // Lógica para el botón de ruta
                    console.log('Mostrar ruta');
                    break;
                    
                case 'btn-brujula':
                    // Lógica para el botón de brújula
                    console.log('Activar/desactivar brújula');
                    break;
                    
                case 'btn-gps':
                    // Lógica para el botón de GPS
                    console.log('Activar/desactivar GPS');
                    break;
                    
                case 'btn-imagen':
                    // Lógica para el botón de imagen
                    console.log('Mostrar imagen');
                    break;
                    
                case 'btn-video':
                    // Lógica para el botón de video
                    console.log('Reproducir video');
                    break;
                    
                default:
                    console.warn(`[BOTON] ID de botón no reconocido: ${id}`);
            }
        }
        

        /**
         * Actualiza el estado visual del botón de punto según el estado de navegación
         */
        function actualizarEstadoBotonPunto() {
            const btnPunto = document.getElementById('btn-punto');
            if (!btnPunto) return;
            
            if (puntoDestino) {
                // Activar botón (verde degradado)
                actualizarEstadoBoton(btnPunto, true, 'Navegando hacia el destino');
                
                // Deshabilitar otros botones
                ['btn-gps', 'btn-imagen', 'btn-video'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) actualizarEstadoBoton(btn, false, '');
                });
            } else {
                // Desactivar botón (rojo degradado)
                actualizarEstadoBoton(btnPunto, false, 'Punto de interés');
                
                // Habilitar otros botones si estamos en una parada
                if (paradaActual) {
                    actualizarEstadoBoton(document.getElementById('btn-gps'), true, '');
                    actualizarEstadoBotonesMultimedia(); // Actualiza estado de botones de multimedia
                }
            }
        }
        
        /**
         * Establece un nuevo destino para la navegación
         * @param {Object} coordenadas - Coordenadas del destino {lat, lng}
         * @param {string} idDestino - Identificador único del destino (ej: 'P-1')
         */
        function establecerDestino(coordenadas, idDestino) {
            // Limpiar estado anterior
            if (marcadorDestino) {
                map.removeLayer(marcadorDestino);
                marcadorDestino = null;
            }
            
            if (polylineNavegacion) {
                map.removeLayer(polylineNavegacion);
                polylineNavegacion = null;
            }
            
            // Establecer nuevo destino
            puntoDestino = {
                coordenadas: coordenadas,
                id: idDestino,
                timestamp: Date.now()
            };
            
            // Crear marcador de destino (bandera roja)
            marcadorDestino = L.marker([coordenadas.lat, coordenadas.lng], {
                icon: L.divIcon({
                    className: 'marcador-destino',
                    html: '🏁',
                    iconSize: [30, 42],
                    iconAnchor: [15, 42]
                })
            }).addTo(map);
            
            // Actualizar estado del botón
            actualizarEstadoBotonPunto();
            
            // Iniciar seguimiento de posición si no está activo
            if (!seguimientoGPS) {
                iniciarSeguimientoGPS();
            }
            
            // Centrar en la posición actual si es posible
            if (ubicacionActual) {
                actualizarUbicacionEnMapa(ubicacionActual);
            }
            
            console.log(`[NAVEGACION] Nuevo destino establecido: ${idDestino}`, coordenadas);
        }
        
        /**
         * Verifica si se ha llegado al destino actual
         */
        // Función verificarLlegadaADestino duplicada eliminada - Ver implementación mejorada más arriba
        
        /**
         * Actualiza la línea de navegación entre la posición actual y el destino
         */
        function actualizarPolylineNavegacion() {
            if (!puntoDestino || !ubicacionActual) return;
            
            const puntos = [
                [ubicacionActual.lat, ubicacionActual.lng],
                [puntoDestino.coordenadas.lat, puntoDestino.coordenadas.lng]
            ];
            
            if (polylineNavegacion) {
                polylineNavegacion.setLatLngs(puntos);
            } else {
                polylineNavegacion = L.polyline(puntos, {
                    color: '#007bff',
                    weight: 6,
                    opacity: 0.8,
                    lineJoin: 'round'
                }).addTo(map);
            }
        }
        
        // NOTA: La inicialización ya está hecha en inicializarMensajeria() arriba
        // Esta sección está comentada para evitar duplicados
        /*
        // Inicializar la mensajería cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Registrar manejador para cambio de modo
                if (window.Mensajeria && typeof window.Mensajeria.registrarControlador === 'function') {
                    window.Mensajeria.registrarControlador('sistema:cambio_modo', manejarMensajeCambioModo);
                    console.log('[HIJO2] Manejador de cambio de modo registrado');
                } else {
                    console.warn('[HIJO2] No se pudo registrar el manejador de cambio de modo: Mensajeria no disponible');
                }
                
                // Inicializar mensajería
                await Mensajeria.inicializar();
                
                // Registrar manejador de mensajes del padre
                Mensajeria.registrarControlador('*', manejarMensajesPadre);
                
                // Notificar al padre que el componente está listo
                await Mensajeria.enviarMensaje('padre', 'inicio', {
                    estado: 'listo',
                    componente: 'hijo2',
                    version: '1.0.0',
                    capacidades: ['navegacion', 'gps', 'seguimiento_ruta']
                });
                
                console.log('[HIJO2] Mensajería inicializada correctamente');
            } catch (error) {
                console.error('[HIJO2] Error al inicializar la mensajería:', error);
            }
        });
        */
        
        // ================== MANEJO DE ESTADO ==================
        // Clase EstadoNavegacion - Definición centralizada
        class EstadoNavegacion {
            constructor() {
                this.estado = {
                    modo: 'inactivo', // 'inactivo', 'navegando', 'enParada', 'completo'
                    paradaActual: null,
                    paradaAnterior: null,
                    paradaSiguiente: null,
                    progreso: 0,
                    tiempoEstimado: 0,
                    distancia: 0,
                    ruta: [],
                    ultimaUbicacion: null,
                    ultimaActualizacion: null,
                    gpsActivo: false,
                    bruselasActivo: false,
                    controlesHabilitados: true
                };
                this.suscriptores = [];
            }

            actualizar(nuevoEstado) {
                this.estado = { ...this.estado, ...nuevoEstado };
                this.estado.ultimaActualizacion = new Date().toISOString();
                this.notificarCambios();
                this.notificarEstadoAlPadre();
            }

            suscribir(callback) {
                if (typeof callback === 'function') {
                    this.suscriptores.push(callback);
                }
                return () => this.suscriptores = this.suscriptores.filter(cb => cb !== callback);
            }

            notificarCambios() {
                this.suscriptores.forEach(callback => callback(this.estado));
            }

            obtenerEstado() {
                return { ...this.estado };
            }

            notificarEstadoAlPadre() {
                // Usar el sistema de mensajería centralizado si está disponible
                if (typeof Mensajeria !== 'undefined' && typeof Mensajeria.enviarMensaje === 'function') {
                    Mensajeria.enviarMensaje('padre', 'estadoNavegacion', this.obtenerEstado())
                        .catch(error => {
                            console.error('Error al notificar estado de navegación:', error);
                        });
                } else if (window.parent !== window) {
                    // Fallback al método antiguo solo si es necesario
                    window.parent.postMessage({
                        tipo: 'estadoNavegacion',
                        estado: this.obtenerEstado(),
                        origen: 'hijo2',
                        timestamp: new Date().toISOString()
                    }, '*');
                }
            }
        }
        // Estado de navegación
        let orientacionActual = 0; // Heading del dispositivo en grados
        let polylineActual = null; // Coordenadas de la ruta actual
        let posicionEnRuta = 0; // Progreso en la ruta (0-1)
        
        // Estado del botón de punto
        // Las variables puntoDestino, marcadorDestino, polylineNavegacion y RADIO_LLEGADA
        // ya están definidas anteriormente en el archivo
        
        // Array de coordenadas de paradas y tramos (definido al principio del archivo)
        
        // Función auxiliar para encontrar una parada por su ID
        function encontrarParadaPorId(id) {
            return COORDENADAS_PARADAS.find(item => 
                (item.tipo === 'parada' || item.tipo === 'inicio' || item.tipo === 'fin') && 
                `P-${item.parada}` === id
            );
        }
        
        // Función auxiliar para encontrar un tramo por su ID
        function encontrarTramoPorId(id) {
            return COORDENADAS_PARADAS.find(item => 
                item.tipo === 'tramo' && 
                `TR-${item.tramo}` === id
            );
        }
        let watchOrientacionId = null; // ID para el listener de orientación

        // Referencias a elementos DOM
        const btnGps = document.getElementById('btn-gps');
        const btnImagen = document.getElementById('btn-imagen');
        const btnVideo = document.getElementById('btn-video');
        const status = document.getElementById('status');

        // ================== FUNCIONES DE UTILIDAD ==================
        // Función calcularDistancia duplicada eliminada - Ver implementación mejorada más arriba
        
        // === FUNCIONES DE NAVEGACIÓN EN TIEMPO REAL ===
        
        function calcularBearing(lat1, lng1, lat2, lng2) {
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const lat1Rad = lat1 * Math.PI / 180;
            const lat2Rad = lat2 * Math.PI / 180;
            
            const y = Math.sin(dLng) * Math.cos(lat2Rad);
            const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - 
                     Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);
            
            let bearing = Math.atan2(y, x) * 180 / Math.PI;
            return (bearing + 360) % 360; // Normalizar a 0-360
        }
        
        function calcularBoundingBoxPolyline(puntos, margen = 0.001) {
            if (!puntos || puntos.length === 0) return null;
            
            // Encontrar límites geográficos
            const lats = puntos.map(p => p.lat);
            const lngs = puntos.map(p => p.lng);
            
            const bounds = {
                norte: Math.max(...lats),
                sur: Math.min(...lats),
                este: Math.max(...lngs),
                oeste: Math.min(...lngs)
            };
            
            // Agregar margen para visualización cómoda
            const boundingBox = {
                norte: bounds.norte + margen,
                sur: bounds.sur - margen,
                este: bounds.este + margen,
                oeste: bounds.oeste - margen
            };
            
            // Calcular centro y dimensiones
            const centro = {
                lat: (boundingBox.norte + boundingBox.sur) / 2,
                lng: (boundingBox.este + boundingBox.oeste) / 2
            };
            
            const dimensiones = {
                latSpan: boundingBox.norte - boundingBox.sur,
                lngSpan: boundingBox.este - boundingBox.oeste
            };
            
            return {
                bounds: boundingBox,
                centro: centro,
                dimensiones: dimensiones,
                puntos: puntos.length
            };
        }
        
        function iniciarSeguimientoOrientacion() {
            // Intentar usar DeviceOrientationEvent (más preciso)
            if (window.DeviceOrientationEvent) {
                // Solicitar permisos en iOS 13+
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') {
                                iniciarListenerOrientacion();
                            } else {
                                console.warn('Permisos de orientación denegados');
                                usarOrientacionAlternativa();
                            }
                        })
                        .catch(error => {
                            console.error('Error solicitando permisos:', error);
                            usarOrientacionAlternativa();
                        });
                } else {
                    // Android y navegadores que no requieren permisos
                    iniciarListenerOrientacion();
                }
            } else {
                usarOrientacionAlternativa();
            }
        }
        
        function iniciarListenerOrientacion() {
            window.addEventListener('deviceorientationabsolute', manejarOrientacion);
            window.addEventListener('deviceorientation', manejarOrientacion);
        }
        
        function manejarOrientacion(event) {
            if (event.alpha !== null) {
                // event.alpha es el heading en grados (0-360)
                orientacionActual = event.alpha;
                
                // Actualizar flecha en tiempo real si estamos navegando
                if (estadoNavegacion === 'navegando' && ubicacionActual) {
                    actualizarFlechaNavegacion();
                }
            }
        }
        
        function usarOrientacionAlternativa() {
            // Fallback: calcular orientación basada en movimiento GPS
            console.log('Usando orientación basada en movimiento GPS');
        }
        
        function detenerSeguimientoOrientacion() {
            window.removeEventListener('deviceorientationabsolute', manejarOrientacion);
            window.removeEventListener('deviceorientation', manejarOrientacion);
        }
        
        function calcularPosicionEnPolyline(ubicacion, polyline) {
            if (!polyline || polyline.length < 2) return { progreso: 0, puntoMasCercano: null };
            
            let distanciaMinima = Infinity;
            let indiceMasCercano = 0;
            let puntoMasCercano = null;
            let progresoTotal = 0;
            let distanciaAcumulada = 0;
            
            // Calcular distancia total de la polyline
            let distanciaTotal = 0;
            for (let i = 0; i < polyline.length - 1; i++) {
                distanciaTotal += calcularDistancia(
                    polyline[i].lat, polyline[i].lng,
                    polyline[i + 1].lat, polyline[i + 1].lng
                );
            }
            
            // Encontrar el punto más cercano en la polyline
            for (let i = 0; i < polyline.length - 1; i++) {
                const puntoProyectado = proyectarPuntoEnSegmento(
                    ubicacion, polyline[i], polyline[i + 1]
                );
                
                const distancia = calcularDistancia(
                    ubicacion.lat, ubicacion.lng,
                    puntoProyectado.lat, puntoProyectado.lng
                );
                
                if (distancia < distanciaMinima) {
                    distanciaMinima = distancia;
                    indiceMasCercano = i;
                    puntoMasCercano = puntoProyectado;
                    
                    // Calcular progreso hasta este punto
                    distanciaAcumulada = 0;
                    for (let j = 0; j < i; j++) {
                        distanciaAcumulada += calcularDistancia(
                            polyline[j].lat, polyline[j].lng,
                            polyline[j + 1].lat, polyline[j + 1].lng
                        );
                    }
                    
                    // Añadir distancia parcial en el segmento actual
                    distanciaAcumulada += calcularDistancia(
                        polyline[i].lat, polyline[i].lng,
                        puntoProyectado.lat, puntoProyectado.lng
                    );
                    
                    progresoTotal = distanciaAcumulada / distanciaTotal;
                }
            }
            
            return {
                progreso: Math.max(0, Math.min(1, progresoTotal)),
                puntoMasCercano: puntoMasCercano,
                distanciaMinima: distanciaMinima,
                indiceSegmento: indiceMasCercano
            };
        }
        
        function proyectarPuntoEnSegmento(punto, segmentoInicio, segmentoFin) {
            const A = punto.lat - segmentoInicio.lat;
            const B = punto.lng - segmentoInicio.lng;
            const C = segmentoFin.lat - segmentoInicio.lat;
            const D = segmentoFin.lng - segmentoInicio.lng;
            
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            
            if (lenSq === 0) return segmentoInicio;
            
            let param = dot / lenSq;
            param = Math.max(0, Math.min(1, param));
            
            return {
                lat: segmentoInicio.lat + param * C,
                lng: segmentoInicio.lng + param * D
            };
        }
        
        function actualizarFlechaNavegacion() {
            if (!ubicacionActual || !polylineActual || estadoNavegacion !== 'navegando') return;
            
            // Calcular posición en la polyline
            const posicionInfo = calcularPosicionEnPolyline(ubicacionActual, polylineActual);
            posicionEnRuta = posicionInfo.progreso;
            
            // Calcular dirección hacia el siguiente punto
            let direccionObjetivo = orientacionActual;
            if (posicionInfo.indiceSegmento < polylineActual.length - 1) {
                const siguientePunto = polylineActual[posicionInfo.indiceSegmento + 1];
                direccionObjetivo = calcularBearing(
                    ubicacionActual.lat, ubicacionActual.lng,
                    siguientePunto.lat, siguientePunto.lng
                );
            }
            
            // Enviar actualización al padre para mostrar flecha
            enviarMensajeAlPadre({
                tipo: 'actualizar-flecha-navegacion',
                ubicacion: ubicacionActual,
                orientacionDispositivo: orientacionActual,
                direccionObjetivo: direccionObjetivo,
                progresoRuta: posicionInfo.progreso,
                puntoEnPolyline: posicionInfo.puntoMasCercano,
                distanciaAPolyline: posicionInfo.distanciaMinima
            });
        }

        // Función actualizarStatus duplicada eliminada - Ver implementación mejorada más arriba

        // ================== MANEJO DE CAMBIO DE MODO ==================
        
        /**
         * Maneja el cambio de modo de la aplicación (casa/aventura)
         * @param {string} modo - Nuevo modo ('casa' o 'aventura')
         * @param {boolean} [habilitar=true] - Si se deben habilitar los controles
         * @param {Object} opciones - Opciones adicionales
         * @param {string} [opciones.motivo='cambio_modo'] - Razón del cambio
         * @param {boolean} [opciones.forzar=false] - Forzar el cambio
         * @param {boolean} [opciones.notificarPadre=true] - Si se debe notificar al padre
         * @param {boolean} [opciones.actualizarInterfaz=true] - Si se debe actualizar la interfaz
         * @returns {Promise<Object>} - Resultado con estado, mensaje y datos relevantes
         */
        async function manejarCambioModo(modo, habilitar = true, { 
            motivo = 'cambio_modo', 
            forzar = false, 
            notificarPadre = true,
            actualizarInterfaz = true
        } = {}) {
            // Generar un ID único para esta transacción
            const ID_TRANSACCION = `cambio-mod-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            
            // Función de utilidad para registrar mensajes de log
            const log = (nivel, mensaje, datos = {}) => {
                const timestamp = new Date().toISOString();
                const prefijo = `[${timestamp}] [HIJO2] [${ID_TRANSACCION}]`;
                const mensajeCompleto = `${prefijo} ${mensaje}`;
                
                // Registrar en consola
                console[nivel](mensajeCompleto, datos);
                
                // Opcional: Registrar en un array de logs para depuración
                if (!window._logs) window._logs = [];
                window._logs.push({ nivel, mensaje, datos, timestamp, id: ID_TRANSACCION });
                if (window._logs.length > 100) window._logs.shift(); // Limitar el tamaño
            };
            
            try {
                log('info', `Iniciando cambio de modo a ${modo}`, { 
                    habilitar, 
                    motivo, 
                    forzar,
                    notificarPadre,
                    estadoActual: window.estadoNavegacion?.obtenerEstado?.()
                });
                
                // Validar el modo
                if (modo !== 'casa' && modo !== 'aventura') {
                    const error = new Error(`Modo no válido: ${modo}. Debe ser 'casa' o 'aventura'`);
                    error.codigo = 'MODO_NO_VALIDO';
                    error.datos = { modoRecibido: modo, modosValidos: ['casa', 'aventura'] };
                    throw error;
                }
                
                // Obtener el estado actual
                const estadoActual = window.estadoNavegacion?.obtenerEstado?.() || {};
                const modoAnterior = estadoActual.modo || 'casa';
                
                // Verificar si es necesario hacer algún cambio
                if (modoAnterior === modo && !forzar) {
                    log('debug', 'El modo no ha cambiado y no se forzó el cambio');
                    return {
                        estado: 'ok',
                        mensaje: 'El modo no ha cambiado',
                        modo,
                        modoAnterior,
                        cambiado: false,
                        timestamp: new Date().toISOString(),
                        idTransaccion: ID_TRANSACCION
                    };
                }
                
                // 1. Actualizar el estado de navegación
                if (window.estadoNavegacion) {
                    window.estadoNavegacion.actualizar({ 
                        modo,
                        ultimaActualizacion: new Date().toISOString()
                    });
                }
                
                // 2. Actualizar controles según el modo
                try {
                    if (modo === 'casa') {
                        // Deshabilitar GPS y limpiar navegación en modo casa
                        detenerGPS();
                        limpiarDestinoNavegacion();
                        
                        // Actualizar estado de los botones
                        actualizarEstadoBotonesModo('casa');
                        
                        log('debug', 'Modo casa activado - GPS desactivado');
                    } else {
                        // Modo aventura - habilitar controles
                        actualizarEstadoBotonesModo('aventura');
                        log('debug', 'Modo aventura activado - Controles habilitados');
                    }
                } catch (error) {
                    log('error', 'Error al actualizar controles', { 
                        error: error.message,
                        stack: error.stack,
                        motivo
                    });
                    
                    // Si no es un error crítico, continuar
                    if (!forzar) throw error;
                    log('warn', 'Continuando a pesar del error (modo forzado)');
                }
                
                // 3. Notificar al padre si es necesario
                if (notificarPadre) {
                    try {
                        log('debug', 'Notificando cambio de modo al padre...');
                        await window.Mensajeria?.enviarMensaje?.('padre', 'sistema:cambio_modo', { 
                            modo, 
                            habilitado: habilitar, 
                            motivo,
                            timestamp: new Date().toISOString(),
                            idTransaccion: ID_TRANSACCION,
                            desdeHijo: 'hijo2'
                        });
                        log('debug', 'Notificación al padre completada');
                    } catch (error) {
                        log('error', 'Error al notificar el cambio de modo al padre', {
                            error: error.message,
                            stack: error.stack,
                            motivo
                        });
                        
                        // Si es crítico, revertir el cambio
                        if (!forzar) {
                            // Revertir cambios en caso de error
                            if (window.estadoNavegacion) {
                                window.estadoNavegacion.actualizar({ 
                                    modo: modoAnterior,
                                    ultimaActualizacion: new Date().toISOString()
                                });
                            }
                            throw error;
                        }
                        log('warn', 'Continuando a pesar del error (modo forzado)');
                    }
                }
                
                // 4. Actualizar la interfaz si es necesario
                if (actualizarInterfaz) {
                    try {
                        log('debug', 'Actualizando interfaz...');
                        actualizarEstadoBotones();
                        
                        // Actualizar estado de navegación si es necesario
                        if (modo === 'casa') {
                            actualizarStatus('Modo Casa activado - GPS desactivado');
                        } else {
                            actualizarStatus('Modo Aventura activado - GPS disponible');
                        }
                        
                        log('debug', 'Interfaz actualizada');
                    } catch (error) {
                        log('error', 'Error al actualizar la interfaz', {
                            error: error.message,
                            stack: error.stack
                        });
                        // No lanzar el error, ya que el cambio de modo fue exitoso
                    }
                }
                
                // 5. Preparar resultado exitoso
                const resultado = {
                    estado: 'ok',
                    mensaje: `Modo cambiado a ${modo} exitosamente`,
                    modo,
                    modoAnterior,
                    habilitado: habilitar,
                    motivo,
                    cambiado: true,
                    timestamp: new Date().toISOString(),
                    idTransaccion: ID_TRANSACCION
                };
                
                log('info', 'Cambio de modo completado exitosamente', resultado);
                return resultado;
                
            } catch (error) {
                // Manejo de errores
                const errorInfo = {
                    codigo: error.codigo || 'ERROR_DESCONOCIDO',
                    mensaje: error.message,
                    stack: error.stack,
                    datos: error.datos || {},
                    modoSolicitado: modo,
                    modoAnterior: window.estadoNavegacion?.obtenerEstado?.()?.modo || 'desconocido',
                    timestamp: new Date().toISOString(),
                    idTransaccion: ID_TRANSACCION
                };
                
                log('error', `Error al cambiar el modo a ${modo}`, errorInfo);
                
                // Notificar al padre del error
                if (notificarPadre) {
                    try {
                        await window.Mensajeria?.enviarMensaje?.('padre', 'sistema:error', {
                            tipo: 'cambio_modo_error',
                            error: errorInfo,
                            origen: 'hijo2',
                            idTransaccion: ID_TRANSACCION
                        });
                    } catch (e) {
                        console.error('Error al notificar error al padre:', e);
                    }
                }
                
                // Relanzar el error para que el llamador pueda manejarlo
                throw error;
            }
        }

        // ================== FUNCIONES GPS MEJORADAS ==================
        
        // NUEVA: Verificar llegada a paradas (corregida)
        function verificarLlegadaAParada() {
            if (modoCasa || !ubicacionActual) return;
            if (paradaActual > 36) return;
            
            // Verificar si estamos navegando hacia una parada destino
            const paradaObjetivo = estadoNavegacion === 'navegando' ? paradaDestino : paradaActual;
            const paradaInfo = COORDENADAS_PARADAS.find(p => p.parada === paradaObjetivo);
            
            if (!paradaInfo) return;
            
            let coordenadasParada = paradaInfo.coordenadas ? paradaInfo.coordenadas : { lat: paradaInfo.lat, lng: paradaInfo.lng };
            const distancia = calcularDistancia(ubicacionActual.lat, ubicacionActual.lng, coordenadasParada.lat, coordenadasParada.lng);
            const RADIO_LLEGADA = 50;
            
            if (distancia <= RADIO_LLEGADA) {
                if (estadoNavegacion === 'navegando' && paradaObjetivo === paradaDestino) {
                    // Llegamos a la parada destino
                    paradaActual = paradaDestino;
                    paradaDestino = paradaActual + 1;
                    
                    // Procesar llegada con el nuevo flujo
                    procesarLlegadaAParada();
                    
                    // Mensaje al padre (mantener compatibilidad)
                    enviarMensajeAlPadre({ 
                        tipo: 'ya-estoy-aqui', 
                        parada: paradaActual,
                        estadoNavegacion: 'llegada'
                    });
                    
                    // Informar cambio de estado (nuevo sistema)
                    informarCambioEstado('llegada-detectada', {
                        distancia: distancia,
                        paradaInfo: paradaInfo
                    });
                } else if (estadoNavegacion === 'inicio') {
                    // Estamos en la parada inicial
                    actualizarStatus(`🏠 En parada ${paradaActual}: ${paradaInfo.nombre || 'Torres de Serranos'}`);
                }
            } else {
                if (estadoNavegacion === 'navegando') {
                    actualizarStatus(`🗺️ Navegando hacia parada ${paradaDestino}: ${Math.round(distancia)}m restantes`);
                } else {
                }
            }
        }
        
        function verificarUbicacionEnTramo() {
            if (modoCasa || !ubicacionActual) {
                // Si no hay ubicación o estamos en modo casa, limpiar el intervalo de la flecha
                if (intervaloFlecha) {
                    clearInterval(intervaloFlecha);
                    intervaloFlecha = null;
                    enviarMensajeAlPadre({ tipo: 'ocultar-flecha-navegacion' });
                }
                return;
            }
            
            // Buscar tramos cercanos
            const tramosEncontrados = [];
            
            COORDENADAS_PARADAS.forEach(elemento => {
                if (elemento.tipo === 'tramo') {
                    // Verificar distancia al inicio del tramo
                    if (elemento.inicio) {
                        const distanciaInicio = calcularDistancia(
                            ubicacionActual.lat, ubicacionActual.lng,
                            elemento.inicio.lat, elemento.inicio.lng
                        );
                        
                        if (distanciaInicio <= 30) { // 30m para tramos
                            tramosEncontrados.push({
                                elemento: elemento,
                                distancia: distanciaInicio,
                                punto: 'inicio',
                                coordenadas: elemento.inicio
                            });
                        }
                    }
                    
                    // Verificar distancia al final del tramo
                    if (elemento.fin) {
                        const distanciaFin = calcularDistancia(
                            ubicacionActual.lat, ubicacionActual.lng,
                            elemento.fin.lat, elemento.fin.lng
                        );
                        
                        if (distanciaFin <= 30) { // 30m para tramos
                            tramosEncontrados.push({
                                elemento: elemento,
                                distancia: distanciaFin,
                                punto: 'fin',
                                coordenadas: elemento.fin
                            });
                        }
                    }
                    
                    // Verificar waypoints si existen
                    if (elemento.waypoints && elemento.waypoints.length > 0) {
                        elemento.waypoints.forEach((waypoint, index) => {
                            const distanciaWaypoint = calcularDistancia(
                                ubicacionActual.lat, ubicacionActual.lng,
                                waypoint.lat, waypoint.lng
                            );
                            
                            if (distanciaWaypoint <= 25) { // 25m para waypoints
                                tramosEncontrados.push({
                                    elemento: elemento,
                                    distancia: distanciaWaypoint,
                                    punto: `waypoint_${index}`,
                                    coordenadas: waypoint
                                });
                            }
                        });
                    }
                }
            });
            
            // Si encontramos tramos y el GPS está activo, manejamos la flecha de navegación
            if (tramosEncontrados.length > 0) {
                const tramoMasCercano = tramosEncontrados.reduce((prev, current) => 
                    prev.distancia < current.distancia ? prev : current
                );
                
                const tramo = tramoMasCercano.elemento;
                const distancia = Math.round(tramoMasCercano.distancia);
                const esNuevoTramo = !tramoActual || tramoActual !== tramo.tramo;
                
                tramoActual = tramo.tramo;
                actualizarStatus(`En tramo ${tramo.tramo}: ${tramo.nombre} (${distancia}m)`);
                
                // Configuramos la polyline para el tramo actual si está disponible
                if (tramo.polyline && tramo.polyline.length > 0) {
                    polylineActual = tramo.polyline;
                    
                    // Solo actualizamos la flecha si el GPS está activo
                    if (watchId !== null && !btnGps.classList.contains('disabled')) {
                        // Si es un nuevo tramo o no hay intervalo, lo configuramos
                        if (esNuevoTramo || !intervaloFlecha) {
                            // Limpiar intervalo existente si lo hay
                            if (intervaloFlecha) {
                                clearInterval(intervaloFlecha);
                            }
                            
                            // Configurar nuevo intervalo para actualizar la flecha
                            intervaloFlecha = setInterval(() => {
                                if (ubicacionActual && polylineActual && estadoNavegacion === 'navegando') {
                                    actualizarFlechaNavegacion();
                                }
                            }, 5000); // Actualizar cada 5 segundos
                            
                            // Llamar inmediatamente
                            actualizarFlechaNavegacion();
                        }
                        
                        // Notificar al padre sobre el tramo actual
                        enviarMensajeAlPadre({
                            tipo: 'en-tramo',
                            tramo: tramo.tramo,
                            nombre: tramo.nombre,
                            distancia: distancia,
                            punto: tramoMasCercano.punto,
                            coordenadas: tramoMasCercano.coordenadas,
                            mostrarFlecha: true
                        });
                    } else if (intervaloFlecha) {
                        // Si el GPS está desactivado pero hay un intervalo activo, lo limpiamos
                        clearInterval(intervaloFlecha);
                        intervaloFlecha = null;
                        
                        // Notificar al padre para ocultar la flecha
                        enviarMensajeAlPadre({
                            tipo: 'ocultar-flecha-navegacion'
                        });
                    }
                }
            } else if (tramoActual) {
                // Si hay un tramo actual pero ya no estamos cerca de él
                tramoActual = null;
                
                // Limpiar la flecha de navegación si existe
                if (intervaloFlecha) {
                    clearInterval(intervaloFlecha);
                    intervaloFlecha = null;
                    
                    // Notificar al padre para ocultar la flecha
                    enviarMensajeAlPadre({
                        tipo: 'ocultar-flecha-navegacion'
                    });
                }
            }
        }

        /**
         * Detiene el seguimiento GPS y limpia todos los recursos asociados.
         * También notifica al padre sobre el cambio de estado.
         */
        function detenerGPS() {
            if (!gpsActivo) return;
            
            console.log('Deteniendo seguimiento GPS...');
            
            // 1. Detener el watch de posición si existe
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            // 2. Detener el intervalo de verificación de llegada si existe
            if (intervaloVerificacion) {
                clearInterval(intervaloVerificacion);
                intervaloVerificacion = null;
            }
            
            // 3. Detener el seguimiento de orientación
            detenerSeguimientoOrientacion();
            
            // 4. Limpiar marcadores y polilíneas
            if (marcadorPosicion) {
                map.removeLayer(marcadorPosicion);
                marcadorPosicion = null;
            }
            
            if (marcadorDestino) {
                map.removeLayer(marcadorDestino);
                marcadorDestino = null;
            }
            
            if (polilineaNavegacion) {
                map.removeLayer(polilineaNavegacion);
                polilineaNavegacion = null;
            }
            
            if (flechaNavegacion) {
                map.removeLayer(flechaNavegacion);
                flechaNavegacion = null;
            }
            
            // 5. Limpiar el círculo de precisión
            if (circuloPrecision) {
                map.removeLayer(circuloPrecision);
                circuloPrecision = null;
            }
            
            // 6. Limpiar intervalos adicionales
            if (intervaloGPS) {
                clearInterval(intervaloGPS);
                intervaloGPS = null;
            }
            
            if (intervaloFlecha) {
                clearInterval(intervaloFlecha);
                intervaloFlecha = null;
                
                // Notificar al padre para ocultar la flecha usando el sistema de mensajería
                if (window.Mensajeria?.enviarMensaje) {
                    window.Mensajeria.enviarMensaje(
                        'padre',
                        window.Mensajeria.TIPOS_MENSAJE.NAVEGACION,
                        {
                            tipo: 'ocultar-flecha-navegacion',
                            timestamp: Date.now()
                        }
                    );
                } else if (window.parent) {
                    // Fallback para compatibilidad
                    window.parent.postMessage({
                        tipo: 'ocultar-flecha-navegacion',
                        origen: 'hijo2',
                        timestamp: Date.now()
                    }, '*');
                }
            }
            
            // 7. Limpiar las referencias
            paradaActual = null;
            tramoActual = null;
            
            // 8. Restablecer el estado
            gpsActivo = false;
            
            // 9. Actualizar la interfaz
            actualizarEstadoGPS('desactivado');
            
            // 10. Actualizar el botón de GPS
            const btnGps = document.getElementById('btn-gps');
            if (btnGps) {
                btnGps.classList.remove('active');
                btnGps.innerHTML = '<i class="fas fa-location-arrow"></i>';
                btnGps.title = 'Activar GPS';
                btnGps.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                btnGps.classList.remove('disabled');
                btnGps.removeAttribute('disabled');
            }
            
            // 11. Desactivar otros botones
            desactivarBoton(document.getElementById('btn-punto'));
            desactivarBoton(document.getElementById('btn-ruta'));
            
            // 12. Notificar al padre que el GPS se ha desactivado
            informarEstadoGPS('desactivado');
            
            // 13. Restablecer el modo de navegación si está activo
            if (modoNavegacion) {
                modoNavegacion = false;
                informarCambioEstado('navegacion', { activa: false });
            }
            
            // 14. Limpiar intervalos adicionales
            clearInterval(tripProgressInterval);
            if (typeof resetTripProgress === 'function') {
                resetTripProgress();
            }
            
            // 15. Notificar al padre que se ha detenido la navegación
            if (puntoDestino) {
                if (window.Mensajeria?.enviarMensaje) {
                    window.Mensajeria.enviarMensaje(
                        'padre',
                        window.Mensajeria.TIPOS_MENSAJE.NAVEGACION,
                        {
                            tipo: 'fin-navegacion',
                            motivo: 'usuario_detuvo',
                            destino: {
                                id: puntoDestino.id || 'desconocido',
                                nombre: puntoDestino.nombre || 'Destino',
                                lat: puntoDestino.lat,
                                lng: puntoDestino.lng
                            },
                            timestamp: Date.now()
                        }
                    );
                } else if (window.parent) {
                    // Fallback para compatibilidad
                    window.parent.postMessage({
                        tipo: 'fin-navegacion',
                        origen: 'hijo2',
                        datos: {
                            motivo: 'usuario_detuvo',
                            destino: {
                                id: puntoDestino.id || 'desconocido',
                                nombre: puntoDestino.nombre || 'Destino',
                                lat: puntoDestino.lat,
                                lng: puntoDestino.lng
                            },
                            timestamp: Date.now()
                        }
                    }, '*');
                }
            }
            
            // 16. Actualizar estado y notificar
            actualizarEstadoBotonPunto();
            actualizarStatus('Navegación detenida');
            
            console.log('Seguimiento GPS detenido');
        }

        /**
         * Actualiza el estado de todos los botones de la interfaz
         * centralizando la lógica de activación/desactivación
         */
        function actualizarEstadoBotones() {
            const estado = estadoNavegacion.obtenerEstado();
            
            // Actualizar estado de los botones de multimedia
            actualizarEstadoBotonesMultimedia();
            
            // Actualizar estado del botón de punto
            actualizarEstadoBotonPunto();
            
            // Actualizar estado del botón GPS
            actualizarEstadoBoton(
                document.getElementById('btn-gps'),
                estado.gpsActivo,
                estado.gpsActivo ? 'Desactivar GPS' : 'Activar GPS'
            );
            
            // Actualizar botones de navegación
            const btnRuta = document.getElementById('btn-ruta');
            const btnBrujula = document.getElementById('btn-brujula');
            
            if (btnRuta) {
                actualizarEstadoBoton(
                    btnRuta,
                    true,
                    'Ver ruta en el mapa'
                );
            }
            
            if (btnBrujula) {
                actualizarEstadoBoton(
                    btnBrujula,
                    true,
                    'Activar/desactivar brújula'
                );
            }
        }

        /*
        === TIPOS DE MENSAJES QUE HIJO 2 ENVÍA AL PADRE ===
        
        1. ESTADOS DE NAVEGACIÓN:
           - 'cambio-estado-navegacion': { estado: 'inicio'|'navegando'|'llegada'|'llegada-detectada' }
           
        2. INTERACCIONES USUARIO:
           - 'interaccion-usuario': { boton: 'gps'|'imagen'|'video', accion: string }
           
        3. ESTADO GPS:
           - 'estado-gps': { estadoGPS: 'activo'|'error'|'desactivado', precision: number }
           
        4. NAVEGACIÓN TIEMPO REAL:
           - 'actualizar-flecha-navegacion': { ubicacion, orientacionDispositivo, direccionObjetivo }
           
        5. MAPA Y VISUALIZACIÓN:
           - 'mostrar-chincheta-actual': { parada, color, coordenadas }
           - 'mostrar-ruta-navegacion': { tramo, polyline, chinchetas, zoomAutomatico }
           - 'cambiar-chincheta-color': { parada, colorAnterior, colorNuevo }
           - 'limpiar-polyline-navegacion'
           - 'ocultar-flecha-navegacion'
        */
        
        // NOTA: La función enviarMensajeAlPadre ha sido eliminada. 
        // Usar Mensajeria.enviarMensaje('padre', tipo, datos) en su lugar.

        /**
         * Actualiza el estado de todos los botones de la interfaz
         * centralizando la lógica de activación/desactivación
         */
        function actualizarEstadoBotonesModo(modo) {
            const estado = estadoNavegacion.obtenerEstado();
            
            // Actualizar estado de los botones de multimedia
            actualizarEstadoBotonesMultimedia();
            
            // Actualizar estado del botón de punto
            actualizarEstadoBotonPunto();
            
            // Actualizar estado del botón GPS
            actualizarEstadoBoton(
                document.getElementById('btn-gps'),
                modo === 'aventura' && estado.gpsActivo,
                modo === 'aventura' ? 'Desactivar GPS' : 'Activar GPS'
            );
            
            // Actualizar botones de navegación
            const btnRuta = document.getElementById('btn-ruta');
            const btnBrujula = document.getElementById('btn-brujula');
            
            if (btnRuta) {
                actualizarEstadoBoton(
                    btnRuta,
                    true,
                    'Ver ruta en el mapa'
                );
            }
            
            if (btnBrujula) {
                actualizarEstadoBoton(
                    btnBrujula,
                    true,
                    'Activar/desactivar brújula'
                );
            }
        }

        // === FLUJO DE NAVEGACIÓN COMPLETO ===
        
        function iniciarEstadoInicial() {
            paradaActual = 0;
            paradaDestino = 1;
            estadoNavegacion = 'inicio';
            
            // GPS siempre activado por defecto
            if (!ubicacionActual) {
                iniciarGPS();
            } else {
                // Si ya tenemos ubicación, actualizar el estado de los botones
                actualizarEstadoBotones();
            }
            
            // Mostrar chincheta verde en parada actual (0)
            enviarMensajeAlPadre({
                tipo: 'mostrar-chincheta-actual',
                parada: paradaActual,
                color: 'verde',
                coordenadas: COORDENADAS_PARADAS.find(p => p.parada === paradaActual)
            });
            
            // Informar al padre que estamos en estado inicial
            informarCambioEstado('inicio', {
                paradaInfo: COORDENADAS_PARADAS.find(p => p.parada === paradaActual)
            });
            
            actualizarStatus(`🏠 Parada ${paradaActual}: Torres de Serranos (Inicio) - Botones activos`);
        }
        
        function iniciarNavegacionAProximaParada() {
            if (paradaDestino > 36) {
                actualizarStatus('✅ ¡Tour completado! Has visitado todas las paradas.');
                return;
            }
            
            estadoNavegacion = 'navegando';
            
            // Encontrar el tramo correspondiente
            const tramoNavegacion = COORDENADAS_PARADAS.find(t => 
                t.tipo === 'tramo' && t.tramo === paradaActual
            );
            
            if (tramoNavegacion) {
                // Guardar polyline actual para seguimiento en tiempo real
                polylineActual = [tramoNavegacion.inicio, ...tramoNavegacion.waypoints, tramoNavegacion.fin];
                
                // Iniciar seguimiento de orientación
                iniciarSeguimientoOrientacion();
                
                // Mostrar ruta completa en el mapa del padre
                enviarMensajeAlPadre({
                    tipo: 'mostrar-ruta-navegacion',
                    paradaOrigen: paradaActual,
                    paradaDestino: paradaDestino,
                    tramo: tramoNavegacion,
                    chincheta: {
                        actual: { parada: paradaActual, color: 'verde' },
                        destino: { parada: paradaDestino, color: 'rojo' }
                    },
                    polyline: {
                        coordenadas: polylineActual,
                        color: 'azul',
                        grosor: 6
                    },
                    zoomAutomatico: {
                        tipo: 'bounding-box-polyline',
                        puntos: polylineActual,
                        margen: 0.001, // Margen en grados para visualización cómoda
                        transicion: 'suave',
                        duracion: 1500, // 1.5 segundos
                        incluirChinchetas: true
                    },
                    iniciarSeguimientoTiempoReal: true
                });
            }
            
            // Informar al padre que iniciamos navegación
            informarCambioEstado('navegando', {
                tramo: tramoNavegacion,
                polyline: polylineActual
            });
            
            actualizarStatus(`🗺️ Navegando hacia parada ${paradaDestino} - Sigue la ruta azul`);
        }
        
        function informarCambioEstado(estado, datos = {}) {
            // Hijo 2 solo informa estados, no controla otros hijos
            const mensaje = {
                tipo: 'cambio-estado-navegacion',
                estado: estado,
                parada: paradaActual,
                paradaDestino: paradaDestino,
                ubicacion: ubicacionActual,
                timestamp: Date.now(),
                ...datos
            };
            
            enviarMensajeAlPadre(mensaje);
            
            // Log para debugging
            console.log(`[Hijo 2] Informando estado: ${estado}`, mensaje);
        }
        
        function informarInteraccionUsuario(tipoBoton, datos = {}) {
            // Informar cuando el usuario interactúa con botones
            const mensaje = {
                tipo: 'interaccion-usuario',
                boton: tipoBoton,
                parada: paradaActual,
                ubicacion: ubicacionActual,
                timestamp: Date.now(),
                ...datos
            };
            
            enviarMensajeAlPadre(mensaje);
            console.log(`[Hijo 2] Interacción usuario: ${tipoBoton}`, mensaje);
        }
        
        function informarEstadoGPS(estado, datos = {}) {
            // Informar cambios en el estado del GPS
            const mensaje = {
                tipo: 'estado-gps',
                estadoGPS: estado,
                ubicacion: ubicacionActual,
                timestamp: Date.now(),
                ...datos
            };
            
            enviarMensajeAlPadre(mensaje);
            console.log(`[Hijo 2] Estado GPS: ${estado}`, mensaje);
        }
        
        function procesarLlegadaAParada() {
            estadoNavegacion = 'llegada';
            
            // Detener seguimiento en tiempo real
            detenerSeguimientoOrientacion();
            polylineActual = null;
            posicionEnRuta = 0;
            
            // Cambiar chincheta roja a verde
            enviarMensajeAlPadre({
                tipo: 'cambiar-chincheta-color',
                parada: paradaActual,
                colorAnterior: 'rojo',
                colorNuevo: 'verde'
            });
            
            // Limpiar polyline de navegación y flecha
            enviarMensajeAlPadre({
                tipo: 'limpiar-polyline-navegacion'
            });
            
            enviarMensajeAlPadre({
                tipo: 'ocultar-flecha-navegacion'
            });
            
            // Informar al padre que llegamos a la parada
            informarCambioEstado('llegada', {
                paradaInfo: COORDENADAS_PARADAS.find(p => p.parada === paradaActual)
            });
            
            // Activar todos los botones para la parada actual
            activarTodosBotones();
            
            actualizarStatus(`✅ ¡Llegaste a parada ${paradaActual}! El padre coordinará audio y retos`);
        }

        // Manejador para los botones de la interfaz
        function manejarClicBoton(id) {
            // Verificar si el botón está deshabilitado
            const btn = document.getElementById(id);
            if (!btn || btn.classList.contains('disabled')) return;
            
            // Efecto visual al hacer clic
            btn.style.transform = 'scale(0.9)';
            setTimeout(() => { btn.style.transform = 'scale(1)'; }, 100);
            
            // Manejar clic según el botón
            switch(id) {
                case 'btn-punto':
                    if (!ubicacionActual) return; // No hacer nada si no hay ubicación
                    
                    // Obtener la parada actual o comenzar desde P-0 si es la primera vez
                    let paradaActual = estadoNavegacion.obtenerEstado().paradaActual;
                    let siguienteParada = null;
                    
                    if (!paradaActual) {
                        // Primera vez - comenzar desde P-0 (Torres de Serranos)
                        siguienteParada = COORDENADAS_PARADAS.find(p => p.id === 'P-0');
                        estadoNavegacion.actualizar({ paradaActual: 'P-0' });
                        console.log('Comenzando aventura desde P-0 (Torres de Serranos)');
                    } else {
                        // Buscar siguiente parada en el array
                        const indiceActual = COORDENADAS_PARADAS.findIndex(p => p.id === paradaActual);
                        if (indiceActual < COORDENADAS_PARADAS.length - 1) {
                            siguienteParada = COORDENADAS_PARADAS[indiceActual + 1];
                            console.log(`Siguiente parada: ${siguienteParada.id} - ${siguienteParada.nombre}`);
                        } else {
                            console.log('¡Has llegado al final del recorrido!');
                            return;
                        }
                    }

                    if (siguienteParada) {
                        // 1. Mostrar marcadores (chincheta verde en ubicación actual, roja en siguiente parada)
                        Mensajes.enviar('mostrarMarcadores', {
                            origen: {
                                lat: ubicacionActual.lat,
                                lng: ubicacionActual.lng,
                                titulo: '',  // Texto vacío para eliminar 'Tu ubicación'
                                color: 'green',
                                id: 'ubicacion_actual',
                                icono: 'pin'
                            },
                            destino: {
                                lat: siguienteParada.coordenadas.lat,
                                lng: siguienteParada.coordenadas.lng,
                                titulo: siguienteParada.nombre,
                                color: 'red',
                                id: siguienteParada.id,
                                icono: 'flag'
                            },
                            zoom: 16 // Nivel de zoom para mostrar ambos puntos
                        });

                        // 2. Dibujar línea discontinua verde de 6px entre los puntos
                        Mensajes.enviar('dibujarRuta', {
                            puntos: [ubicacionActual, siguienteParada.coordenadas],
                            color: '#00FF00', // Azul
                            grosor: 6, // 6px de ancho
                            opacidad: 0.8,
                            lineJoin: 'round',
                            lineCap: 'round'
                        });

                        // 3. Iniciar actualización de flecha de dirección cada 7 segundos
                        if (intervaloFlecha) {
                            clearInterval(intervaloFlecha);
                        }
                        intervaloFlecha = setInterval(actualizarFlechaNavegacion, 7000);
                        actualizarFlechaNavegacion(); // Llamar inmediatamente

                        // 4. Actualizar el título del botón para mostrar la distancia
                        actualizarDistanciaObjetivo(ubicacionActual, siguienteParada.coordenadas);

                        // 5. Verificar si estamos a menos de 50m del objetivo
                        const distancia = calcularDistancia(
                            ubicacionActual.lat,
                            ubicacionActual.lng,
                            siguienteParada.coordenadas.lat,
                            siguienteParada.coordenadas.lng
                        );

                        console.log(`Distancia al objetivo: ${distancia.toFixed(2)} metros`);

                        if (distancia <= 50) {
                            console.log('¡Estás a menos de 50m del objetivo!');
                            
                            // 6. Hacer parpadear la chincheta verde 3 veces en amarillo
                            Mensajes.enviar('animarMarcador', {
                                id: siguienteParada.id,
                                animacion: 'parpadeo',
                                veces: 3,
                                colorInicial: 'green',
                                colorFinal: 'yellow',
                                duracion: 1000, // 1 segundo por parpadeo
                                alTerminar: () => {
                                    // Una vez terminada la animación, dejar fijo en verde
                                    Mensajes.enviar('actualizarMarcador', {
                                        id: siguienteParada.id,
                                        color: 'green',
                                        titulo: `Llegada: ${siguienteParada.nombre}`,
                                        icono: 'check'
                                    });
                                    
                                    // Actualizar estado para indicar que se alcanzó el objetivo
                                    estadoNavegacion.actualizar({ objetivoAlcanzado: true });
                                    
                                    // Actualizar estado de los botones
                                    actualizarEstadoBotonesModo('aventura');
                                },
                                veces: 3,
                                colorInicial: 'green',
                                colorFinal: 'yellow'
                            });

                            // 7. Después de la animación (3 segundos):
                            //    - Chincheta se queda fija en verde
                            //    - Botón Punto de Interés se pone rojo y se desactiva
                            //    - Se activan los botones GPS, Imagen y Video (si aplica)
                            setTimeout(() => {
                                // Chincheta fija en verde
                                Mensajes.enviar('actualizarMarcador', {
                                    id: siguienteParada.id,
                                    color: 'green',
                                    titulo: `Llegada: ${siguienteParada.nombre}`,
                                    icono: 'check'
                                });

                                // Desactivar botón Punto de Interés (rojo y deshabilitado)
                                const btnPunto = document.getElementById('btn-punto');
                                if (btnPunto) {
                                    btnPunto.classList.add('disabled');
                                    btnPunto.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                                    btnPunto.title = 'Punto de interés alcanzado';
                                }

                                // Activar botones GPS, Imagen y Video (si es un tramo)
                                const btnGps = document.getElementById('btn-gps');
                                const btnImagen = document.getElementById('btn-imagen');
                                const btnVideo = document.getElementById('btn-video');
                                
                                if (btnGps) {
                                    btnGps.classList.remove('disabled');
                                    btnGps.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                                    btnGps.title = 'Iniciar navegación GPS';
                                }
                                
                                if (btnImagen && siguienteParada.imagen) {
                                    btnImagen.classList.remove('disabled');
                                    btnImagen.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                                    btnImagen.title = 'Ver imagen de la ubicación';
                                }
                                
                                if (btnVideo && siguienteParada.id.startsWith('TR-') && siguienteParada.video) {
                                    btnVideo.classList.remove('disabled');
                                    btnVideo.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                                    btnVideo.title = 'Ver video del tramo';
                                }

                                // Actualizar el estado de navegación
                                estadoNavegacion.actualizar({ 
                                    paradaActual: siguienteParada.id,
                                    objetivoAlcanzado: true 
                                });

                            }, 3000); // 3 segundos para la animación (3 parpadeos de 1s)
                        }
                    }
                    break;
                    
                case 'btn-ruta':
                    // Botón de ruta - Mostrar ruta completa en nueva pestaña
                    // Siempre activo con estilo verde, sin interacción con el padre
                    window.open('Av1_mapa_completo.html', '_blank');
                    break;
                    
                case 'btn-brujula':
                    // Botón de brújula - Mostrar imagen del mapa en nueva pestaña
                    // Siempre activo con estilo verde, sin interacción con el padre
                    window.open('mapas/Av1_mapa.jpg', '_blank');
                    break;
                    
                case 'btn-gps':
                    if (!ubicacionActual) {
                        // Iniciar navegación GPS
                        if (ubicacionActual) {
                            const siguienteParada = COORDENADAS_PARADAS.find(p => p.parada === (window.paradaActual + 1));
                            
                            if (siguienteParada) {
                                // Preparar waypoints para la ruta (si existen)
                                let waypoints = [];
                                if (siguienteParada.waypoints && siguienteParada.waypoints.length > 0) {
                                    waypoints = siguienteParada.waypoints.map(wp => ({
                                        lat: wp.lat,
                                        lng: wp.lng
                                    }));
                                }
                                
                                // Mostrar ruta con polyline azul de 6px
                                Mensajes.enviar('mostrarRuta', {
                                    origen: ubicacionActual,
                                    destino: siguienteParada.coordenadas || siguienteParada,
                                    waypoints: waypoints,
                                    opciones: {
                                        color: '#007bff', // Azul
                                        peso: 6, // 6px de ancho
                                        opacidad: 0.8,
                                        lineJoin: 'round',
                                        lineCap: 'round'
                                    },
                                    marcadores: {
                                        inicio: {
                                            color: 'green',
                                            texto: 'Tú estás aquí'
                                        },
                                        fin: {
                                            color: 'red',
                                            texto: siguienteParada.nombre || 'Siguiente punto',
                                            cambiarAVerde: true // La chincheta se pondrá verde al llegar
                                        }
                                    },
                                    mostrarFlecha: true
                                });
                                
                                // Iniciar seguimiento GPS
                                iniciarGPS();
                            }
                        }
                    }
                    break;
                    
                case 'btn-imagen':
                    // Mostrar imagen de la parada/tramo actual
                    if (paradaActual) {
                        // Enviar mensaje con información completa de la parada/tramo
                        Mensajes.enviar('mostrarImagen', {
                            id: paradaActual.id, // ID único de la parada/tramo
                            tipo: paradaActual.tipo, // 'parada', 'tramo', etc.
                            src: paradaActual.imagen || '',
                            titulo: paradaActual.nombre || 'Imagen de la ubicación',
                            descripcion: paradaActual.descripcion || '',
                            modo: 'aventura'
                        });
                        
                        // Actualizar estado para indicar que se mostró la imagen
                        actualizarStatus(`Mostrando imagen: ${paradaActual.nombre || 'Ubicación actual'}`);
                    } else {
                        // Enviar mensaje con información estática de las paradas/tramos
                        Mensajes.enviar('mostrarInfoEstatica', {
                            paradas: COORDENADAS_PARADAS.filter(p => p.completada)
                        });
                    }
                    break;
                    
                case 'btn-video':
                    // Verificar si se puede mostrar el reproductor de video
                    if (paradaActual && paradaActual.id && paradaActual.id.startsWith('TR-')) {
                        // Efecto de zoom antes de mostrar el reproductor de video
                        Mensajes.enviar('zoomSecuencial', {
                            coordenadas: paradaActual.coordenadas || paradaActual,
                            zoomInicial: 16, // Zoom máximo (como si fuera desde el aire)
                            zoomFinal: 25,   // Zoom normal
                            duracion: 3000,  // 3 segundos de animación
                            callback: {
                                tipo: 'mostrarVideo',
                                datos: {
                                    id: paradaActual.id, // ID único del video
                                    src: paradaActual.video || '', // Puede estar vacío
                                    modo: 'aventura',
                                    // Permitir que el reproductor gestione su propia reproducción
                                    mostrarControles: true, // Habilitar controles nativos
                                    autoplay: false, // No reproducir automáticamente
                                    mensajeSinVideo: !paradaActual.video ? 'No hay un video disponible para esta ubicación.' : undefined
                                },
                                onError: {
                                    tipo: 'error',
                                    mensaje: 'No se pudo cargar el video. Por favor, inténtalo de nuevo más tarde.'
                                }
                            }
                        });
                        
                        // Actualizar estado
                        actualizarStatus(paradaActual.video 
                            ? 'Listo para reproducir el video'
                            : 'No hay video disponible para esta ubicación');
                    }
                    break;
            }
        }
        
        // Asignar manejadores de eventos a los botones de navegación
        document.getElementById('btn-punto').addEventListener('click', () => manejarClicBoton('btn-punto'));
        document.getElementById('btn-ruta').addEventListener('click', () => manejarClicBoton('btn-ruta'));
        document.getElementById('btn-brujula').addEventListener('click', () => manejarClicBoton('btn-brujula'));
        document.getElementById('btn-gps').addEventListener('click', () => manejarClicBoton('btn-gps'));
        document.getElementById('btn-imagen').addEventListener('click', () => manejarClicBoton('btn-imagen'));
        document.getElementById('btn-video').addEventListener('click', () => manejarClicBoton('btn-video'));
        
        // Función para sincronizar el estado de la brújula cuando se recibe un mensaje del padre
        function sincronizarEstadoBrujula(activada) {
            const btnBrujula = document.getElementById('btn-brujula');
            if (!btnBrujula) return;
            
            const brujulaActivada = activada === true;
            btnBrujula.classList.toggle('active', brujulaActivada);
            
            if (brujulaActivada) {
                btnBrujula.style.background = 'linear-gradient(135deg, #ffc107, #ff9800)';
                btnBrujula.style.boxShadow = '0 0 15px rgba(255, 193, 7, 0.8)';
            } else {
                btnBrujula.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                btnBrujula.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            }
        }

        // Event listeners básicos
        btnGps.addEventListener('click', () => {
            if (btnGps.classList.contains('disabled')) return;
            
            // Informar interacción al padre
            informarInteraccionUsuario('gps', {
                accion: !ubicacionActual ? 'iniciar-gps' : 'mostrar-navegacion'
            });
            
            if (!ubicacionActual) {
                iniciarGPS();
            } else {
                const paradaDestino = COORDENADAS_PARADAS.find(p => p.parada === paradaActual);
                if (paradaDestino) {
                    enviarMensajeAlPadre({
                        tipo: 'mostrar-navegacion-gps',
                        paradaActual: paradaActual,
                        coordenadasDestino: paradaDestino,
                        ubicacionUsuario: ubicacionActual
                    });
                }
            }
        });

        // El manejo del botón de imagen ahora se realiza únicamente a través de manejarClicBoton
        // para evitar conflictos y mantener la lógica centralizada

        btnVideo.addEventListener('click', () => {
            if (btnVideo.classList.contains('disabled')) return;
            
            const paradaInfo = COORDENADAS_PARADAS.find(p => p.parada === paradaActual);
            
            // Informar interacción al padre
            informarInteraccionUsuario('video', {
                paradaInfo: paradaInfo,
                tieneVideo: !!(paradaInfo && paradaInfo.video)
            });
            
            if (paradaInfo && paradaInfo.video) {
                // Obtener coordenadas de inicio para el zoom
                const coordenadasZoom = paradaInfo.coordenadas || 
                                       { lat: paradaInfo.lat, lng: paradaInfo.lng } || 
                                       ubicacionActual;
                
                enviarMensajeAlPadre({
                    tipo: 'mostrar-video-con-zoom-secuencial',
                    parada: paradaActual,
                    videoSrc: paradaInfo.video,
                    coordenadasZoom: coordenadasZoom,
                    secuencia: {
                        paso1: { accion: 'zoom', duracion: 1000 },
                        paso2: { accion: 'mostrar-video', ventana: '70%' }
                    },
                    sincronizarConBarraProgreso: true
                });
            }
        });

        // === FUNCIONES DE SIMULACIÓN DE ZOOM Y VIDEO (TEMPORAL) ===
        
        function simularZoomNavegacion(mensaje) {
            const polyline = mensaje.polyline.coordenadas;
            const zoomConfig = mensaje.zoomAutomatico;
            
            // Calcular bounding box de la polyline
            const boundingBox = calcularBoundingBoxPolyline(polyline, zoomConfig.margen);
            
            if (!boundingBox) {
                actualizarStatus('❌ Error: No se pudo calcular bounding box');
                return;
            }
            
            // Simular zoom hacia el bounding box
            actualizarStatus(`🔍 Zoom navegación: Centro ${boundingBox.centro.lat.toFixed(4)}, ${boundingBox.centro.lng.toFixed(4)}`);
            
            // Mostrar información del zoom
            setTimeout(() => {
                actualizarStatus(`🗺️ Ruta visible: ${boundingBox.puntos} puntos, ${Math.round(boundingBox.dimensiones.latSpan * 111000)}m span`);
            }, 500);
            
            // Simular finalización del zoom
            setTimeout(() => {
                actualizarStatus(`✅ Zoom completado - Ruta completa visible desde ${mensaje.paradaOrigen} → ${mensaje.paradaDestino}`);
                
                // Simular dibujo de elementos en el mapa
                simularElementosNavegacion(mensaje);
            }, zoomConfig.duracion || 1500);
        }
        
        function simularElementosNavegacion(mensaje) {
            const elementos = [];
            
            // Chincheta verde (origen)
            elementos.push(`🟢 Chincheta verde: Parada ${mensaje.paradaOrigen}`);
            
            // Polyline azul
            elementos.push(`🔵 Polyline azul: ${mensaje.polyline.coordenadas.length} puntos, ${mensaje.polyline.grosor}px`);
            
            // Chincheta roja (destino)
            elementos.push(`🔴 Chincheta roja: Parada ${mensaje.paradaDestino}`);
            
            // Mostrar elementos progresivamente
            elementos.forEach((elemento, index) => {
                setTimeout(() => {
                    actualizarStatus(elemento);
                }, index * 300);
            });
            
            // Mensaje final
            setTimeout(() => {
                actualizarStatus(`🎯 Navegación activa: Sigue la ruta azul hacia parada ${mensaje.paradaDestino}`);
            }, elementos.length * 300 + 500);
        }
        
        // === FUNCIONES DE SIMULACIÓN DE VIDEO (TEMPORAL) ===
        
        function simularZoomYVideo(coordenadas, videoSrc, duracionZoom = 1000) {
            // Simular zoom in del mapa
            actualizarStatus(`🔍 Zoom in hacia coordenadas: ${coordenadas.lat.toFixed(4)}, ${coordenadas.lng.toFixed(4)}`);
            
            // Simular animación de zoom
            setTimeout(() => {
                actualizarStatus(`🎬 Zoom completado. Mostrando video: ${videoSrc}`);
                mostrarVentanaVideoFlotante(videoSrc);
            }, duracionZoom);
        }
        
        function mostrarVentanaVideoFlotante(videoSrc) {
            // Crear ventana flotante de video (70% pantalla)
            const ventanaVideo = document.createElement('div');
            ventanaVideo.id = 'ventana-video-flotante';
            ventanaVideo.style.cssText = `
                position: fixed;
                top: 15%;
                left: 15%;
                width: 70%;
                height: 70%;
                background: rgba(0,0,0,0.9);
                border-radius: 10px;
                z-index: 1000;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            `;
            
            const video = document.createElement('video');
            video.src = videoSrc;
            video.controls = false; // Sin controles, usamos barra de progreso
            video.style.cssText = `
                width: 90%;
                height: 80%;
                border-radius: 5px;
            `;
            
            const botonCerrar = document.createElement('button');
            botonCerrar.innerHTML = '✕';
            botonCerrar.style.cssText = `
                position: absolute;
                top: 10px;
                right: 15px;
                background: rgba(255,255,255,0.8);
                border: none;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                font-size: 16px;
                cursor: pointer;
                z-index: 1001;
            `;
            
            botonCerrar.addEventListener('click', () => {
                cerrarVentanaVideo();
            });
            
            const infoVideo = document.createElement('div');
            infoVideo.style.cssText = `
                color: white;
                margin-top: 10px;
                text-align: center;
                font-size: 14px;
            `;
            infoVideo.innerHTML = `
                🎬 Video de parada ${paradaActual}<br>
                🔄 Usa la barra de progreso para controlar el video
            `;
            
            ventanaVideo.appendChild(botonCerrar);
            ventanaVideo.appendChild(video);
            ventanaVideo.appendChild(infoVideo);
            
            document.body.appendChild(ventanaVideo);
            
            // Sincronizar con barra de progreso
            sincronizarVideoConBarraProgreso(video);
            
            actualizarStatus(`🎬 Video flotante activo - Usa barra de progreso para controlar`);
        }
        
        function cerrarVentanaVideo() {
            const ventana = document.getElementById('ventana-video-flotante');
            if (ventana) {
                ventana.remove();
                actualizarStatus(`📵 Video cerrado`);
            }
        }
        
        function sincronizarVideoConBarraProgreso(videoElement) {
            // Sincronizar video con la barra de progreso del viaje
            const barraProgreso = document.getElementById('progressBar');
            const contenedorProgreso = document.getElementById('progressContainer');
            
            if (!barraProgreso || !contenedorProgreso) return;
            
            // Listener para cuando se arrastra la barra
            contenedorProgreso.addEventListener('click', (e) => {
                if (!videoElement) return;
                
                const rect = contenedorProgreso.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const porcentaje = clickX / rect.width;
                
                // Calcular posición en el video
                const duracionVideo = videoElement.duration || 60; // Fallback 60 segundos
                const tiempoVideo = porcentaje * duracionVideo;
                
                videoElement.currentTime = tiempoVideo;
                
                actualizarStatus(`🎬 Video: ${Math.round(tiempoVideo)}s / ${Math.round(duracionVideo)}s`);
            });
            
            // Actualizar barra cuando el video progresa
            videoElement.addEventListener('timeupdate', () => {
                if (videoElement.duration) {
                    const progreso = (videoElement.currentTime / videoElement.duration) * 100;
                    barraProgreso.style.width = `${progreso}%`;
                }
            });
        }
        
        // Esquemas de validación para los mensajes
        const esquemasMensajes = {
            habilitarControles: {
                camposRequeridos: [],
                descripcion: 'Habilitar controles de la interfaz',
                validar: function(datos) {
                    return { valido: true };
                }
            },
            deshabilitarControles: {
                camposRequeridos: [],
                descripcion: 'Deshabilitar controles de la interfaz',
                validar: function(datos) {
                    return { valido: true };
                }
            },
            actualizarEstadoNavegacion: {
                camposRequeridos: ['estado'],
                descripcion: 'Actualizar el estado de navegación',
                validar: function(datos) {
                    if (!datos.estado) {
                        return { 
                            valido: false, 
                            error: 'El campo "estado" es requerido' 
                        };
                    }
                    return { valido: true };
                }
            },
            mostrarVideo: {
                camposRequeridos: ['url', 'id'],
                descripcion: 'Mostrar un video en la interfaz',
                validar: function(datos) {
                    if (!datos.url) {
                        return { 
                            valido: false, 
                            error: 'El campo "url" es requerido para mostrar un video' 
                        };
                    }
                    if (!datos.id) {
                        return { 
                            valido: false, 
                            error: 'El campo "id" es requerido para identificar el video' 
                        };
                    }
                    return { valido: true };
                }
            },
            mostrarImagen: {
                camposRequeridos: ['url', 'id'],
                descripcion: 'Mostrar una imagen en la interfaz',
                validar: function(datos) {
                    if (!datos.url) {
                        return { 
                            valido: false, 
                            error: 'El campo "url" es requerido para mostrar una imagen' 
                        };
                    }
                    if (!datos.id) {
                        return { 
                            valido: false, 
                            error: 'El campo "id" es requerido para identificar la imagen' 
                        };
                    }
                    return { valido: true };
                }
            }
        };

        // Función para validar un mensaje según su esquema
        function validarMensaje(tipo, datos = {}) {
            const esquema = esquemasMensajes[tipo];
            
            // Verificar si el tipo de mensaje es conocido
            if (!esquema) {
                return {
                    valido: false,
                    error: `Tipo de mensaje '${tipo}' no reconocido`
                };
            }
            
            // Verificar campos requeridos
            for (const campo of esquema.camposRequeridos) {
                if (!(campo in datos)) {
                    return {
                        valido: false,
                        error: `Campo requerido faltante: '${campo}'`
                    };
                }
            }
            
            // Validación personalizada si existe
            if (typeof esquema.validar === 'function') {
                return esquema.validar(datos);
            }
            
            return { valido: true };
        }

        // Función para confirmar la recepción de un mensaje
        function confirmarRecepcion(idMensaje, exito = true, datosAdicionales = {}) {
            const respuesta = {
                type: 'confirmacionRecepcion',
                idMensaje,
                timestamp: Date.now(),
                exito,
                origen: 'hijo2',
                ...datosAdicionales
            };
            
            console.log(`📤 HIJO 2: Enviando confirmación de recepción para mensaje ${idMensaje}`, respuesta);
            window.parent.postMessage(respuesta, '*');
            return respuesta;
        }

        // Función para manejar mensajes específicos del padre
        function manejarMensajeEspecifico(tipo, datos = {}, idMensaje = null) {
            // Si el mensaje es para reanudar la navegación
            if (tipo === 'reanudarNavegacion') {
                const btnGps = document.getElementById('btn-gps');
                const estado = estadoNavegacion.obtenerEstado();
                
                if (btnGps) {
                    // Habilitar el botón GPS
                    btnGps.classList.remove('disabled');
                    btnGps.removeAttribute('disabled');
                    btnGps.title = 'Activar seguimiento GPS';
                    btnGps.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                    
                    // Si hay datos de la siguiente parada, actualizar el estado
                    if (datos.siguienteParada) {
                        estadoNavegacion.actualizar({ 
                            paradaActual: datos.siguienteParada.id,
                            estado: 'navegando'
                        });
                        
                        // Mostrar la siguiente parada en el mapa
                        if (estado.ubicacionActual) {
                            Mensajes.enviar('mostrarMarcadores', {
                                origen: {
                                    lat: estado.ubicacionActual.lat,
                                    lng: estado.ubicacionActual.lng,
                                    titulo: 'Tu ubicación',
                                    color: 'red',
                                    id: 'ubicacion_actual',
                                    icono: 'pin'
                                },
                                destino: {
                                    lat: datos.siguienteParada.coordenadas.lat,
                                    lng: datos.siguienteParada.coordenadas.lng,
                                    titulo: datos.siguienteParada.nombre,
                                    color: 'green',
                                    id: datos.siguienteParada.id,
                                    icono: 'flag'
                                },
                                zoom: 16
                            });
                        }
                    }
                    
                    actualizarStatus('Listo para continuar la navegación');
                }
                return true;
            }
            console.log(`📨 HIJO 2: Procesando mensaje de tipo '${tipo}'`, { datos, idMensaje });
            
            // Validar el mensaje
            const validacion = validarMensaje(tipo, datos);
            
            if (!validacion.valido) {
                console.error(`❌ HIJO 2: Error de validación en mensaje '${tipo}':`, validacion.error);
                
                // Enviar confirmación de error si hay un ID de mensaje
                if (idMensaje) {
                    confirmarRecepcion(idMensaje, false, { 
                        error: validacion.error,
                        tipoError: 'validacion'
                    });
                }
                
                return { exito: false, error: validacion.error };
            }
            
            try {
                let resultado = null;
                
                // Procesar el mensaje según su tipo
                switch(tipo) {
                    case 'habilitarControles':
                        console.log('🔓 HIJO 2: Habilitando controles');
                        activarTodosBotones();
                        resultado = { exito: true };
                        break;
                        
                    case 'deshabilitarControles':
                        console.log('🔒 HIJO 2: Deshabilitando controles');
                        desactivarTodosBotones();
                        resultado = { exito: true };
                        break;
                        
                    case 'actualizarEstadoNavegacion':
                        console.log('🔄 HIJO 2: Actualizando estado de navegación', datos.estado);
                        manejarSincronizacionEstado(datos.estado);
                        resultado = { 
                            exito: true, 
                            estadoActual: estadoNavegacion.obtenerEstado() 
                        };
                        break;
                        
                    case 'mostrarVideo':
                        console.log('🎬 HIJO 2: Mostrando video', { id: datos.id, url: datos.url });
                        try {
                            // Mostrar el video utilizando la función existente
                            mostrarVentanaVideoFlotante(datos.url);
                            
                            // Actualizar el estado con el ID del video actual
                            estadoNavegacion.actualizar({ 
                                contenidoActual: { 
                                    tipo: 'video', 
                                    id: datos.id,
                                    url: datos.url 
                                } 
                            });
                            
                            // Confirmar que se mostró el video
                            resultado = { 
                                exito: true, 
                                mensaje: `Video ${datos.id} mostrado correctamente` 
                            };
                            
                            // Notificar al padre que se mostró el video
                            informarInteraccionUsuario('video', { 
                                accion: 'mostrado', 
                                id: datos.id,
                                url: datos.url 
                            });
                        } catch (error) {
                            console.error('❌ Error al mostrar el video:', error);
                            throw new Error(`No se pudo mostrar el video: ${error.message}`);
                        }
                        break;
                        
                    case 'mostrarImagen':
                        console.log('🖼️ HIJO 2: Mostrando imagen', { id: datos.id, url: datos.url });
                        try {
                            // Crear o actualizar el contenedor de imagen
                            let contenedorImagen = document.getElementById('contenedor-imagen');
                            if (!contenedorImagen) {
                                contenedorImagen = document.createElement('div');
                                contenedorImagen.id = 'contenedor-imagen';
                                contenedorImagen.style.cssText = `
                                    position: fixed;
                                    top: 50%;
                                    left: 50%;
                                    transform: translate(-50%, -50%);
                                    z-index: 1000;
                                    max-width: 90%;
                                    max-height: 90%;
                                    text-align: center;
                                `;
                                document.body.appendChild(contenedorImagen);
                            }
                            
                            // Establecer la imagen
                            contenedorImagen.innerHTML = `
                                <img 
                                    src="${datos.url}" 
                                    alt="Imagen ${datos.id}" 
                                    style="max-width: 100%; max-height: 80vh; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);"
                                >
                                <div style="margin-top: 10px; color: white; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px;">
                                    Imagen: ${datos.id}
                                </div>
                            `;
                            
                            // Actualizar el estado con el ID de la imagen actual
                            estadoNavegacion.actualizar({ 
                                contenidoActual: { 
                                    tipo: 'imagen', 
                                    id: datos.id,
                                    url: datos.url 
                                } 
                            });
                            
                            // Confirmar que se mostró la imagen
                            resultado = { 
                                exito: true, 
                                mensaje: `Imagen ${datos.id} mostrada correctamente` 
                            };
                            
                            // Notificar al padre que se mostró la imagen
                            informarInteraccionUsuario('imagen', { 
                                accion: 'mostrada', 
                                id: datos.id,
                                url: datos.url 
                            });
                        } catch (error) {
                            console.error('❌ Error al mostrar la imagen:', error);
                            throw new Error(`No se pudo mostrar la imagen: ${error.message}`);
                        }
                        break;
                        
                    default:
                        const error = `Tipo de mensaje no manejado: '${tipo}'`;
                        console.warn(`⚠️ HIJO 2: ${error}`);
                        resultado = { 
                            exito: false, 
                            error 
                        };
                }
                
                // Enviar confirmación de recepción si hay un ID de mensaje
                if (idMensaje) {
                    confirmarRecepcion(idMensaje, resultado.exito, resultado);
                }
                
                return resultado;
                
            } catch (error) {
                console.error(`❌ HIJO 2: Error al procesar mensaje '${tipo}':`, error);
                
                // Enviar confirmación de error si hay un ID de mensaje
                if (idMensaje) {
                    confirmarRecepcion(idMensaje, false, { 
                        error: error.message,
                        tipoError: 'procesamiento',
                        stack: error.stack
                    });
                }
                
                return { 
                    exito: false, 
                    error: `Error al procesar el mensaje: ${error.message}` 
                };
            }
        }
        
        // Función para manejar mensajes legacy (formato antiguo)
        function manejarMensajeLegacy(tipo, datos = {}) {
            console.warn(`⚠️ HIJO 2: Uso de mensaje legacy '${tipo}'. Se recomienda actualizar al nuevo formato estructurado.`);
            
            try {
                switch(tipo) {
                    case 'habilitarControles':
                        console.log('🔓 HIJO 2: Habilitando controles (legacy)');
                        activarTodosBotones();
                        break;
                        
                    case 'deshabilitarControles':
                        console.log('🔒 HIJO 2: Deshabilitando controles (legacy)');
                        desactivarTodosBotones();
                        break;
                        
                    default:
                        console.warn(`⚠️ HIJO 2: Tipo de mensaje legacy no reconocido: '${tipo}'`, datos);
                }
            } catch (error) {
                console.error('❌ HIJO 2: Error al procesar mensaje legacy:', error, { tipo, datos });
            }
        }
        
        // Función para manejar la sincronización de estado con el padre
        function manejarSincronizacionEstado(estado) {
            console.log('Recibido estado del padre:', estado);
            
            // Actualizar el estado de navegación con los datos recibidos
            const actualizaciones = {};
            
            // Actualizar estado de la brújula si está presente
            if (typeof estado.brújulaActivada === 'boolean') {
                sincronizarEstadoBrujula(estado.brújulaActivada);
            }
            
            // Actualizar modo de operación (casa/aventura)
            if (estado.modo === 'casa' || estado.modo === 'aventura') {
                actualizaciones.modoCasa = estado.modo === 'casa';
                
                // Actualizar estado de los botones según el modo
                if (actualizaciones.modoCasa) {
                    activarModoCasa();
                } else {
                    activarModoAventura();
                }
                
                console.log('Modo actualizado a:', estado.modo);
                console.log('[Hijo2] Datos compartidos actualizados:', estado.datosCompartidos);
            }
        }
        
        // ID del iframe para verificación
        const IFRAME_ID = 'hijo2';
        
        // Función auxiliar para actualizar el estado de un botón
        function actualizarEstadoBoton(boton, activo, mensaje) {
            if (!boton) return;
            
            if (activo) {
                boton.classList.remove('disabled');
                boton.removeAttribute('disabled');
                boton.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
            } else {
                boton.classList.add('disabled');
                boton.setAttribute('disabled', 'true');
                boton.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
            }
            
            if (mensaje) {
                boton.title = mensaje;
            }
        }
        
        // Función auxiliar para obtener mensajes de tooltip consistentes
        function obtenerMensajeTooltip(tipo, estado, parada) {
            if (tipo === 'video') {
                if (!estado.gpsActivo) return 'Activa el GPS para ver el video del tramo';
                if (!parada?.id) return 'No hay un tramo activo para mostrar el video';
                if (!parada.id.startsWith('TR-')) return 'El video solo está disponible para tramos (TR-), no para paradas';
                return `Ver video: ${parada.nombre || 'Tramo actual'}`;
            } else { // imagen
                if (modoCasa) return 'Ver imagen de la ubicación';
                if (!estado.gpsActivo) return 'Activa el GPS para ver la imagen del punto';
                return parada ? `Ver imagen: ${parada.nombre || 'Punto actual'}` : 'No hay un punto activo para mostrar la imagen';
            }
        }
        
        // Función para actualizar el estado de los botones de multimedia
        function actualizarEstadoBotonesMultimedia() {
            const btnImagen = document.getElementById('btn-imagen');
            const btnVideo = document.getElementById('btn-video');
            const estado = estadoNavegacion.obtenerEstado();
            const paradaActual = estado.paradaActual ? COORDENADAS_PARADAS.find(p => p.id === estado.paradaActual) : null;
            const esTramo = paradaActual?.id?.startsWith('TR-');
            
            // --- Botón Imagen (📸) ---
            const imagenActiva = modoCasa || (estado.gpsActivo && paradaActual);
            actualizarEstadoBoton(
                btnImagen, 
                imagenActiva, 
                obtenerMensajeTooltip('imagen', estado, paradaActual)
            );
            
            // --- Botón Video (📽️) ---
            if (btnVideo) {
                // Mostrar solo si es un tramo
                btnVideo.style.display = esTramo ? 'block' : 'none';
                
                const videoActivo = modoCasa || (estado.gpsActivo && esTramo);
                actualizarEstadoBoton(
                    btnVideo,
                    videoActivo,
                    obtenerMensajeTooltip('video', estado, paradaActual)
                );
            }
        }
        
        // Función para manejar el clic en el botón GPS
        function manejarClicGps() {
            if (modoCasa) {
                // En modo casa, el botón está controlado por el padre
                Mensajes.enviar('gpsClick');
                return;
            }
            
            const btnGps = document.getElementById('btn-gps');
            if (!btnGps || btnGps.classList.contains('disabled')) {
                return; // No hacer nada si el botón está deshabilitado
            }
            
            console.log('Iniciando navegación GPS...');
            
            // Verificar si el GPS ya está activo (botón verde)
            const gpsActivo = btnGps.style.background.includes('#28a745');
            
            if (gpsActivo) {
                // Si el GPS ya está activo, desactivarlo
                console.log('Desactivando seguimiento GPS...');
                detenerGPS();
                
                // Cambiar a rojo degradado
                btnGps.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                btnGps.title = 'Activar seguimiento GPS';
                actualizarStatus('Seguimiento GPS desactivado');
                return;
            }
            
            // Si el GPS no está activo, activarlo (cambiar a verde)
            console.log('Activando seguimiento GPS...');
            btnGps.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
            btnGps.title = 'Navegación GPS activa';
            
            // Iniciar la navegación GPS desde P-0 si no hay parada actual
            const estado = estadoNavegacion.obtenerEstado();
            if (!estado.paradaActual || estado.paradaActual === '') {
                const primeraParada = COORDENADAS_PARADAS.find(p => p.id === 'P-0');
                if (primeraParada) {
                    estadoNavegacion.actualizar({ paradaActual: 'P-0' });
                    
                    // Mostrar marcadores y ruta
                    Mensajes.enviar('mostrarMarcadores', {
                        origen: {
                            lat: estado.ubicacionActual?.lat || 0,
                            lng: estado.ubicacionActual?.lng || 0,
                            titulo: 'Tu ubicación',
                            color: 'red',
                            id: 'ubicacion_actual',
                            icono: 'pin'
                        },
                        destino: {
                            lat: primeraParada.coordenadas.lat,
                            lng: primeraParada.coordenadas.lng,
                            titulo: primeraParada.nombre,
                            color: 'green',
                            id: 'P-0',
                            icono: 'flag'
                        },
                        zoom: 16
                    });
                    
                    // Actualizar estado del botón GPS
                    btnGps.title = 'Navegación GPS activa';
                    btnGps.style.animation = ''; // Detener animación de parpadeo
                    
                    // Iniciar actualización periódica de la posición
                    iniciarSeguimientoGPS();
                }
            } else {
                // Si ya hay una parada actual, continuar con la navegación
                iniciarSeguimientoGPS();
            }
        }
        
        // Función para iniciar el seguimiento GPS
        function iniciarSeguimientoGPS() {
            // Detener cualquier intervalo existente
            if (intervaloGPS) {
                clearInterval(intervaloGPS);
            }
            
            // Iniciar actualización periódica cada 7 segundos
            intervaloGPS = setInterval(() => {
                const estado = estadoNavegacion.obtenerEstado();
                const paradaActual = COORDENADAS_PARADAS.find(p => p.id === estado.paradaActual);
                
                if (paradaActual && estado.ubicacionActual) {
                    // Actualizar la posición en el mapa
                    Mensajes.enviar('actualizarPosicion', {
                        id: 'ubicacion_actual',
                        lat: estado.ubicacionActual.lat,
                        lng: estado.ubicacionActual.lng,
                        titulo: 'Tu ubicación',
                        color: 'red',
                        icono: 'pin',
                        mostrarCirculo: true,
                        radioCirculo: 40 // Radio de 40m para el círculo de precisión
                    });
                    
                    // Actualizar flecha de dirección
                    actualizarFlechaNavegacion();
                    
                    // Verificar si hemos llegado al destino
                    const distancia = calcularDistancia(
                        estado.ubicacionActual.lat,
                        estado.ubicacionActual.lng,
                        paradaActual.coordenadas.lat,
                        paradaActual.coordenadas.lng
                    );
                    
                    if (distancia <= 50) {
                        // Hemos llegado a la parada
                        clearInterval(intervaloGPS);
                        manejarLlegadaAParada(paradaActual);
                    }
                }
            }, 7000); // Actualizar cada 7 segundos
        }
        
        // Función para detener el seguimiento GPS
        // Implementación consolidada en la función detenerGPS() ubicada más arriba (línea ~3187)
        // Esta función ha sido eliminada para evitar duplicación de código
        
        // Función para manejar la llegada a una parada
        function manejarLlegadaAParada(parada) {
            console.log(`¡Llegada a ${parada.nombre}!`);
            
            // Detener el seguimiento GPS y deshabilitar el botón
            detenerGPS();
            
            // Obtener referencia al botón GPS
            const btnGps = document.getElementById('btn-gps');
            
            // Actualizar el estado visual del botón GPS
            if (btnGps) {
                btnGps.style.background = 'linear-gradient(135deg, #6c757d, #5a6268)';
                btnGps.title = 'Esperando confirmación del padre...';
                btnGps.classList.add('disabled');
                btnGps.setAttribute('disabled', 'true');
            }
            
            // Hacer parpadear la chincheta de destino
            Mensajes.enviar('animarMarcador', {
                id: parada.id,
                animacion: 'parpadeo',
                veces: 3,
                colorInicial: 'green',
                colorFinal: 'yellow',
                duracion: 1000 // 1 segundo por parpadeo
            });
            
            // Después de la animación, actualizar el estado
            setTimeout(() => {
                // Actualizar la chincheta a verde fijo
                Mensajes.enviar('actualizarMarcador', {
                    id: parada.id,
                    color: 'green',
                    titulo: `Llegada: ${parada.nombre}`,
                    icono: 'check'
                });
                
                // Enviar mensaje al padre
                Mensajes.enviar('llegadaParada', {
                    id: parada.id,
                    nombre: parada.nombre,
                    tipo: parada.id.startsWith('P-') ? 'parada' : 'tramo'
                });
                
                // Activar botones correspondientes
                const btnImagen = document.getElementById('btn-imagen');
                const btnVideo = document.getElementById('btn-video');
                
                if (btnImagen && parada.imagen) {
                    btnImagen.classList.remove('disabled');
                    btnImagen.removeAttribute('disabled');
                    btnImagen.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                    btnImagen.title = 'Ver imagen del punto';
                }
                
                if (btnVideo && parada.id.startsWith('TR-') && parada.video) {
                    btnVideo.style.display = 'block';
                    btnVideo.classList.remove('disabled');
                    btnVideo.removeAttribute('disabled');
                    btnVideo.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                    btnVideo.title = 'Ver video del tramo';
                }
                
                // No configuramos la siguiente parada aquí, esperamos la confirmación del padre
                // El padre debe enviar un mensaje 'reanudarNavegacion' con la siguiente parada
                
                // Enviar mensaje al padre con información sobre la parada actual y la siguiente
                const indiceActual = COORDENADAS_PARADAS.findIndex(p => p.id === parada.id);
                if (indiceActual < COORDENADAS_PARADAS.length - 1) {
                    const siguienteParada = COORDENADAS_PARADAS[indiceActual + 1];
                    
                    // Informar al padre sobre la llegada y la siguiente parada
                    Mensajes.enviar('llegadaParadaCompleta', {
                        paradaActual: parada,
                        siguienteParada: siguienteParada,
                        haySiguiente: true
                    });
                } else {
                    // Última parada del recorrido
                    Mensajes.enviar('llegadaParadaCompleta', {
                        paradaActual: parada,
                        siguienteParada: null,
                        haySiguiente: false
                    });
                    
                    // Notificar que se ha completado el recorrido
                    console.log('¡Recorrido completado!');
                    Mensajes.enviar('recorridoCompletado');
                }
                
            }, 3000); // 3 segundos para la animación
        }
        
        /**
         * Actualiza el estado visual y funcional de los botones según el modo de operación.
         * Utiliza un esquema de colores consistente:
         * - Verde (#28a745 a #20c997): Botón activo y disponible
         * - Rojo (#dc3545 a #c82333): Botón inactivo o deshabilitado
         * 
         * @param {string} modo - El modo de operación: 'casa' o 'aventura'
         */
        function actualizarEstadoBotonesModo(modo) {
            // Referencias a los elementos del DOM
            const btnPunto = document.getElementById('btn-punto');
            const btnRuta = document.getElementById('btn-ruta');
            const btnBrujula = document.getElementById('btn-brujula');
            const btnGps = document.getElementById('btn-gps');
            const btnImagen = document.getElementById('btn-imagen');
            const btnVideo = document.getElementById('btn-video');
            
            // Estado inicial: todos los botones desactivados (rojo)
            [btnPunto, btnRuta, btnBrujula, btnGps, btnImagen, btnVideo].forEach(btn => {
                if (btn) {
                    btn.classList.add('disabled');
                    btn.setAttribute('disabled', 'true');
                    btn.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                }
            });
            
            // Obtener el estado actual de navegación
            const estado = estadoNavegacion.obtenerEstado();
            const paradaActual = estado.paradaActual ? COORDENADAS_PARADAS.find(p => p.id === estado.paradaActual) : null;
            
            if (modo === 'casa') {
                // MODO CASA (DEMO): 
                // - Botones de navegación y multimedia activos (verde)
                // - Botón Punto de Interés desactivado (rojo)
                [btnRuta, btnBrujula, btnGps, btnImagen, btnVideo].forEach(btn => {
                    if (btn) {
                        btn.classList.remove('disabled');
                        btn.removeAttribute('disabled');
                        btn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                    }
                });
                
                // Punto de Interés siempre desactivado en modo casa
                // Se muestra en rojo para indicar que no está disponible en este modo
                if (btnPunto) {
                    btnPunto.classList.add('disabled');
                    btnPunto.setAttribute('disabled', 'true');
                    btnPunto.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                    btnPunto.title = 'No disponible en modo demo';
                }
            } else {
                // MODO AVENTURA (NAVEGACIÓN REAL):
                // - Botones de Ruta y Brújula siempre activos (verde)
                // - Punto de Interés activo hasta alcanzar el objetivo
                // - Botones de multimedia se activan al alcanzar el objetivo
                
                // Botones que siempre están activos en modo aventura
                [btnRuta, btnBrujula].forEach(btn => {
                    if (btn) {
                        btn.classList.remove('disabled');
                        btn.removeAttribute('disabled');
                        btn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                    }
                });
                
                // Manejo del botón Punto de Interés en modo aventura
                if (btnPunto) {
                    if (estado.objetivoAlcanzado) {
                        // OBJETIVO ALCANZADO (a menos de 50m):
                        // - Desactivar botón Punto de Interés (rojo)
                        // - Activar botones de multimedia (verde)
                        btnPunto.classList.add('disabled');
                        btnPunto.setAttribute('disabled', 'true');
                        btnPunto.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                        btnPunto.title = 'Punto alcanzado';
                        
                        // Activar botón GPS (si existe)
                        if (btnGps) {
                            btnGps.classList.remove('disabled');
                            btnGps.removeAttribute('disabled');
                            btnGps.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                            btnGps.title = 'Ver en mapa';
                        }
                        
                        // Activar botón de Imagen (si hay imagen disponible)
                        if (btnImagen && paradaActual && paradaActual.imagen) {
                            btnImagen.classList.remove('disabled');
                            btnImagen.removeAttribute('disabled');
                            btnImagen.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                            btnImagen.title = 'Ver imagen del punto de interés';
                        }
                        
                        // Activar botón de Video (solo para tramos TR-*)
                        if (btnVideo && paradaActual && paradaActual.id && paradaActual.id.startsWith('TR-')) {
                            btnVideo.classList.remove('disabled');
                            btnVideo.removeAttribute('disabled');
                            btnVideo.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                            btnVideo.title = 'Ver video del tramo';
                        }
                    } else {
                        // OBJETIVO NO ALCANZADO (a más de 50m):
                        // - Activar botón Punto de Interés (verde)
                        // - Desactivar botones de multimedia (rojo)
                        btnPunto.classList.remove('disabled');
                        btnPunto.removeAttribute('disabled');
                        btnPunto.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                        btnPunto.title = 'Seleccionar punto de interés';
                        
                        // Desactivar botón GPS (rojo)
                        if (btnGps) {
                            btnGps.classList.add('disabled');
                            btnGps.setAttribute('disabled', 'true');
                            btnGps.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                            btnGps.title = 'Actívalo al llegar al punto de interés';
                        }
                        
                        // Desactivar botón de Imagen (rojo)
                        if (btnImagen) {
                            btnImagen.classList.add('disabled');
                            btnImagen.setAttribute('disabled', 'true');
                            btnImagen.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                            btnImagen.title = 'Actívalo al llegar al punto de interés';
                        }
                        
                        // Desactivar botón de Video (rojo)
                        if (btnVideo) {
                            btnVideo.classList.add('disabled');
                            btnVideo.setAttribute('disabled', 'true');
                            btnVideo.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                            btnVideo.title = 'Actívalo al llegar al punto de interés';
                        }
                    }
                }
                
                // Botones GPS, Imagen y Video se manejan según la lógica de navegación
                if (estado.objetivoAlcanzado) {
                    // Habilitar botón GPS si hay un objetivo alcanzado
                    if (btnGps) {
                        btnGps.classList.remove('disabled');
                        btnGps.removeAttribute('disabled');
                        btnGps.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                    }
                    
                    // Habilitar botón de imagen si hay una imagen disponible
                    if (btnImagen && paradaActual && paradaActual.imagen) {
                        btnImagen.classList.remove('disabled');
                        btnImagen.removeAttribute('disabled');
                        btnImagen.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                        btnImagen.title = 'Ver imagen del punto';
                    }
                    
                    // Habilitar botón de video si hay un video disponible
                    if (btnVideo && paradaActual && paradaActual.video) {
                        btnVideo.classList.remove('disabled');
                        btnVideo.removeAttribute('disabled');
                        btnVideo.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                        btnVideo.title = 'Ver video del punto';
                    }
                } else {
                    // Si no hay objetivo alcanzado, deshabilitar botones multimedia
                    if (btnGps) {
                        btnGps.classList.add('disabled');
                        btnGps.setAttribute('disabled', 'true');
                        btnGps.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                    }
                    
                    if (btnImagen) {
                        btnImagen.classList.add('disabled');
                        btnImagen.setAttribute('disabled', 'true');
                        btnImagen.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                    }
                    
                    if (btnVideo) {
                        btnVideo.classList.add('disabled');
                        btnVideo.setAttribute('disabled', 'true');
                        btnVideo.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                    }
                }
                
                // --- Botón Brújula (🧭) ---
                // Siempre activo en modo aventura
                if (btnBrujula) {
                    btnBrujula.classList.remove('disabled');
                    btnBrujula.removeAttribute('disabled');
                    btnBrujula.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                    btnBrujula.title = 'Ver mapa de navegación';
                }
                
                // --- Botón Ruta (🗺️) ---
                // Siempre activo en modo aventura
                if (btnRuta) {
                    btnRuta.classList.remove('disabled');
                    btnRuta.removeAttribute('disabled');
                    btnRuta.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                    btnRuta.title = 'Ver ruta completa';
                }
                
                // --- Botón GPS (🛰️) ---
                if (btnGps) {
                    if (modo === 'casa') {
                        // Modo Casa: Inactivo (rojo opaco)
                        gpsActivo = false;
                        btnGps.classList.add('disabled');
                        btnGps.setAttribute('disabled', 'true');
                        btnGps.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                        btnGps.style.opacity = '0.5';
                        btnGps.title = 'No disponible en modo casa';
                    } else {
                        // Modo Aventura: Inactivo (rojo) hasta estar a 50m del objetivo
                        gpsActivo = false;
                        btnGps.classList.add('disabled');
                        btnGps.setAttribute('disabled', 'true');
                        btnGps.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                        btnGps.title = 'Actívalo al llegar al punto de interés';
                    }
                }
            }
            
            // --- Botón Imagen (📸) ---
            if (btnImagen) {
                if (modoCasa) {
                    // Modo Casa: Activo si hay imagen
                    const tieneImagen = paradaActual && (paradaActual.imagen || (paradaActual.id && COORDENADAS_PARADAS.find(p => p.id === paradaActual.id && p.imagen)));
                    if (tieneImagen) {
                        btnImagen.classList.remove('disabled');
                        btnImagen.removeAttribute('disabled');
                        btnImagen.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                        btnImagen.title = 'Ver imagen de la ubicación';
                    } else {
                        btnImagen.classList.add('disabled');
                        btnImagen.setAttribute('disabled', 'true');
                        btnImagen.style.background = 'linear-gradient(135deg, #6c757d, #5a6268)';
                        btnImagen.title = 'No hay imagen disponible';
                    }
                } else {
                    // Modo Aventura: Inactivo hasta activar GPS
                    btnImagen.classList.add('disabled');
                    btnImagen.setAttribute('disabled', 'true');
                    btnImagen.style.background = 'linear-gradient(135deg, #6c757d, #5a6268)';
                    btnImagen.title = 'Actívalo al llegar al punto de interés';
                }
            }
            
            // --- Botón Video (📽️) ---
            // Solo visible en tramos (TR-)
            if (btnVideo) {
                const esTramo = paradaActual && paradaActual.id && paradaActual.id.startsWith('TR-');
                
                if (!esTramo) {
                    // Ocultar botón si no es un tramo
                    btnVideo.style.display = 'none';
                } else {
                    btnVideo.style.display = 'block';
                    
                    if (modoCasa) {
                        // Modo Casa: Activo si es un tramo
                        btnVideo.classList.remove('disabled');
                        btnVideo.removeAttribute('disabled');
                        btnVideo.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                        btnVideo.title = 'Ver video del tramo';
                    } else {
                        // Modo Aventura: Inactivo hasta activar GPS
                        btnVideo.classList.add('disabled');
                        btnVideo.setAttribute('disabled', 'true');
                        btnVideo.style.background = 'linear-gradient(135deg, #6c757d, #5a6268)';
                        btnVideo.title = 'Actívalo al llegar al punto de interés';
                    }
                }
            }
            
            // --- Botones de navegación (siempre activos) ---
            [btnRuta, btnBrujula].forEach(btn => {
                if (btn) {
                    btn.classList.remove('disabled');
                    btn.removeAttribute('disabled');
                    btn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                }
            });
            
            // Actualizar estado de los botones de multimedia
            actualizarEstadoBotonesMultimedia();
            
            console.log(`🔄 Botones actualizados para modo: ${modo} (GPS: ${gpsActivo ? 'activo' : 'inactivo'})`);
        }
        
        // ================== MANEJADORES DE MENSAJES ==================
        
        // ================== CONTROL DE MODO ==================
        let modoActual = 'aventura'; // 'aventura' o 'casa'
        let controlesHabilitados = false; // Estado actual de los controles
        
        /**
         * Habilita los controles según el modo especificado
         * @param {string} modo - 'casa' o 'aventura'
         */
        function enableControls(modo = 'casa') {
            console.log(`🔓 HIJO 2: Habilitando controles en modo ${modo}`);
            modoActual = modo;
            controlesHabilitados = true;
            actualizarInterfazSegunModo();
            
            // Notificar al padre
            if (window.Mensajes && typeof Mensajes.enviar === 'function') {
                Mensajes.enviar('SISTEMA.CONTROL', {
                    accion: 'controlesHabilitados',
                    modo: modo,
                    timestamp: Date.now()
                });
            }
        }
        
        /**
         * Deshabilita los controles con un motivo específico
         * @param {string} motivo - Razón de la deshabilitación
         */
        function disableControls(motivo = 'desconocido') {
            console.log(`🔒 HIJO 2: Deshabilitando controles (${motivo})`);
            controlesHabilitados = false;
            actualizarInterfazSegunModo();
            
            // Notificar al padre
            if (window.Mensajes && typeof Mensajes.enviar === 'function') {
                Mensajes.enviar('SISTEMA.CONTROL', {
                    accion: 'controlesDeshabilitados',
                    motivo: motivo,
                    timestamp: Date.now()
                });
            }
        }
        
        /**
         * Actualiza la interfaz según el modo actual
         */
        function actualizarInterfazSegunModo() {
            const botones = document.querySelectorAll('.nav-button, .boton-accion');
            const esModoCasa = modoActual === 'casa';
            
            botones.forEach(boton => {
                // Los botones de ruta y brújula siempre están habilitados
                if (boton.id === 'btn-ruta' || boton.id === 'btn-brujula') {
                    boton.disabled = false;
                    boton.classList.add('enabled');
                    boton.style.opacity = '1';
                    boton.style.pointerEvents = 'auto';
                    boton.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                    return;
                }
                
                if (controlesHabilitados && esModoCasa) {
                    // Modo casa: controles habilitados (verde)
                    boton.disabled = false;
                    boton.classList.add('enabled');
                    boton.style.opacity = '1';
                    boton.style.pointerEvents = 'auto';
                    boton.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                } else {
                    // Modo aventura o controles deshabilitados (rojo)
                    boton.disabled = true;
                    boton.classList.remove('enabled');
                    boton.style.opacity = '0.6';
                    boton.style.pointerEvents = 'none';
                    boton.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                }
            });
            
            console.log(`🔄 HIJO 2: Interfaz actualizada para modo ${modoActual} - Controles ${controlesHabilitados ? 'habilitados' : 'deshabilitados'}`);
        }
        
        /**
         * Maneja el cambio de modo (casa/aventura)
         * @param {string} modo - 'casa' o 'aventura'
         * @param {boolean} habilitar - Si es true, habilita los controles
         */
        function manejarCambioModo(modo, habilitar = false) {
            console.log(`🔄 HIJO 2: Cambiando a modo ${modo} - Habilitar: ${habilitar}`);
            
            // Validar el modo
            if (modo !== 'casa' && modo !== 'aventura') {
                console.error(`❌ HIJO 2: Modo no válido: ${modo}`);
                return;
            }
            
            // Actualizar el modo
            modoActual = modo;
            
            // Actualizar controles según corresponda
            if (habilitar) {
                enableControls(modo);
            } else {
                disableControls(`Modo ${modo} sin habilitación explícita`);
            }
            
            // Notificar al padre
            if (window.Mensajes && typeof Mensajes.enviar === 'function') {
                Mensajes.enviar('SISTEMA.CONFIGURACION', {
                    estado: 'modoCambiado',
                    modo: modo,
                    habilitado: habilitar,
                    timestamp: Date.now()
                });
            }
        }
        
        // Inicializar el sistema de mensajería
        let mensajeria;
        
        // Asegurar que enableControls esté disponible globalmente
        if (typeof enableControls === 'undefined') {
            console.warn('enableControls no está definido, usando implementación de respaldo');
            window.enableControls = function(modo = 'casa') {
                console.log(`[RESPALDO] Habilitando controles para modo: ${modo}`);
                // Implementación básica de respaldo
                const botones = document.querySelectorAll('.nav-button, .boton');
                botones.forEach(boton => {
                    boton.classList.remove('disabled');
                    boton.disabled = false;
                });
                return true;
            };
        }
        
        // Configurar manejadores de mensajes cuando el módulo esté listo
        async function configurarMensajeria() {
            try {
                // Función segura para manejar mensajes
                const manejarMensajeSeguro = (event) => {
                    try {
                        // Verificar si el mensaje es válido
                        if (!event || !event.data) {
                            console.warn('Mensaje recibido sin datos', event);
                            return;
                        }

                        // Verificar si el mensaje es del tipo esperado
                        const mensaje = event.data;
                        if (typeof mensaje !== 'object' || mensaje === null) {
                            console.warn('Mensaje no es un objeto:', mensaje);
                            return;
                        }

                        // Verificar si hay un manejador para este tipo de mensaje
                        if (typeof window.manejarMensajeEntrante === 'function') {
                            window.manejarMensajeEntrante(event);
                        } else if (Mensajes && typeof Mensajes.procesarMensaje === 'function') {
                            Mensajes.procesarMensaje(mensaje, event);
                        } else {
                            console.warn('No hay manejador de mensajes disponible:', mensaje);
                        }
                    } catch (error) {
                        console.error('Error al procesar mensaje:', error, event);
                    }
                };

                // Inicializar mensajería
                try {
                    const moduloMensajeria = await import('./js/mensajeria.js');
                    mensajeria = moduloMensajeria.default || moduloMensajeria;
                    
                    if (!mensajeria || typeof mensajeria.inicializarMensajeria !== 'function') {
                        throw new Error('La API de mensajería no es válida');
                    }
                    
                    // Configurar mensajería
                    await mensajeria.inicializarMensajeria({
                        iframeId: 'hijo2',
                        logLevel: mensajeria.LOG_LEVELS.DEBUG,
                        debug: true
                    });
                    
                    console.log('[HIJO2] Mensajería inicializada correctamente');
                    
                    // Configurar manejador de mensajes seguro
                    window.addEventListener('message', manejarMensajeSeguro);
                } catch (error) {
                    console.error('[HIJO2] Error al inicializar la mensajería:', error);
                    throw error;
                }
                
                // Manejar mensaje de cambio de modo (casa/aventura)
                mensajeria.registrarControlador(mensajeria.TIPOS_MENSAJE.NAVEGACION.CAMBIO_MODO, (mensaje) => {
                    const { modo, gpsActivo, habilitarControles } = mensaje.datos || {};
                    console.log(`🔄 [mensajeria] Recibido cambio de modo: ${modo}, GPS activo: ${gpsActivo}, Habilitar controles: ${habilitarControles}`);
                    
                    // Manejar el cambio de modo con el nuevo sistema
                    manejarCambioModo(modo, habilitarControles);
                    
                    // Mantener compatibilidad con el sistema antiguo
                    modoCasa = modo === 'casa';
                    
                    // Actualizar botones según el modo
                    actualizarEstadoBotonesModo(modo);
                    
                    // Si es modo aventura y el GPS está activo, asegurarse de que el botón de ubicación esté activo
                    if (modo === 'aventura' && gpsActivo) {
                        const btnPunto = document.getElementById('btn-punto');
                        if (btnPunto) {
                            btnPunto.classList.remove('disabled');
                            btnPunto.removeAttribute('disabled');
                            btnPunto.setAttribute('title', 'Seguimiento de ubicación activo');
                        }
                    }
                });
                
                // Manejar mensaje de bloqueo/desbloqueo de controles
                mensajeria.registrarControlador(mensajeria.TIPOS_MENSAJE.SISTEMA.BLOQUEAR_CONTROLES, (mensaje) => {
                    const { bloquear } = mensaje.datos || {};
                    console.log(`🔒 [mensajeria] ${bloquear ? 'Bloqueando' : 'Desbloqueando'} controles`);
                    
                    const controles = [
                        'btn-punto', 'btn-imagen', 'btn-video', 'btn-ruta', 'btn-brujula'
                    ];
                    
                    controles.forEach(id => {
                        const control = document.getElementById(id);
                        if (control) {
                            if (bloquear) {
                                control.classList.add('disabled');
                                control.setAttribute('disabled', 'true');
                            } else {
                                control.classList.remove('disabled');
                                control.removeAttribute('disabled');
                                
                                // Actualizar estado visual según el modo actual
                                if (id === 'btn-punto' && !modoCasa) {
                                    control.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                                } else if (id === 'btn-imagen' || id === 'btn-video') {
                                    // Los botones de multimedia se actualizarán según el estado del GPS
                                    actualizarEstadoBotonesMultimedia();
                                }
                            }
                        }
                    });
                });
                
                // Manejar confirmación de reproducción de video
                mensajeria.registrarControlador(mensajeria.TIPOS_MENSAJE.MULTIMEDIA.VIDEO_INICIADO, (mensaje) => {
                    console.log('✅ [mensajeria] Reproducción de video confirmada', mensaje.datos);
                    // Aquí podrías actualizar la interfaz si es necesario
                });

                // Manejar error en reproducción de video
                mensajeria.registrarControlador(mensajeria.TIPOS_MENSAJE.ERROR.REPRODUCCION_VIDEO, (mensaje) => {
                    console.error('❌ [mensajeria] Error al reproducir el video:', mensaje.datos);
                    // Mostrar mensaje de error al usuario
                    actualizarStatus('Error al reproducir el video', true);
                });

                // Manejar confirmación de visualización de imagen
                mensajeria.registrarControlador(mensajeria.TIPOS_MENSAJE.MULTIMEDIA.IMAGEN_MOSTRADA, (mensaje) => {
                    console.log('🖼️ [mensajeria] Imagen mostrada correctamente', mensaje.datos);
                    // Aquí podrías actualizar la interfaz si es necesario
                });

                // Manejar error al mostrar imagen
                mensajeria.registrarControlador(mensajeria.TIPOS_MENSAJE.ERROR.MOSTRAR_IMAGEN, (mensaje) => {
                    console.error('❌ [mensajeria] Error al mostrar la imagen:', mensaje.datos);
                    // Mostrar mensaje de error al usuario
                    actualizarStatus('Error al cargar la imagen', true);
                });
                
                // Manejador para actualizaciones de estado
                mensajeria.registrarControlador(mensajeria.TIPOS_MENSAJE.ESTADO.ACTUALIZAR, (mensaje) => {
                    // Verificar que el mensaje sea para este iframe
                    if (mensaje.para && mensaje.para !== 'hijo2' && mensaje.para !== 'todos') {
                        return; // No es para este iframe
                    }
                    // Manejar actualizaciones de estado del padre
                    if (mensaje.datos.estado) {
                        manejarSincronizacionEstado(mensaje.datos.estado);
                    }
                });

                // Manejador para sincronización de brújula
                mensajeria.registrarControlador(mensajeria.TIPOS_MENSAJE.NAVEGACION.ACTUALIZAR_BRUJULA, (mensaje) => {
                    if (typeof mensaje.datos.activada === 'boolean') {
                        sincronizarEstadoBrujula(mensaje.datos.activada);
                    }
                });

                // Manejador para el estado del GPS
                mensajeria.registrarControlador(mensajeria.TIPOS_MENSAJE.NAVEGACION.ACTUALIZAR_UBICACION, (mensaje) => {
                    if (mensaje.datos.gpsOn !== undefined) {
                        console.log('[mensajeria] Estado del GPS recibido:', mensaje.datos.gpsOn ? 'ACTIVADO' : 'DESACTIVADO');
                        
                        // Obtener referencias a los botones
                        const btnGps = document.getElementById('btn-gps');
                        const btnImagen = document.getElementById('btn-imagen');
                        const btnVideo = document.getElementById('btn-video');
                        const btnPunto = document.getElementById('btn-punto');
                        
                        // Verificar que los botones existan
                        if (!btnGps || !btnImagen || !btnVideo || !btnPunto) {
                            console.error('[mensajeria] No se encontraron todos los botones necesarios');
                            return;
                        }
                        
                        // Actualizar el estado de los botones según el estado del GPS
                        if (mensaje.datos.gpsOn) {
                            // GPS ACTIVADO: Deshabilitar botones de GPS, Imagen y Video; habilitar Punto
                            btnGps.classList.add('disabled');
                            btnImagen.classList.add('disabled');
                            btnVideo.classList.add('disabled');
                            btnPunto.classList.remove('disabled');
                            console.log('[mensajeria] Botones actualizados: GPS ON - Punto habilitado, otros deshabilitados');
                        } else {
                            // GPS DESACTIVADO: Habilitar botones de GPS, Imagen y Video; deshabilitar Punto
                            btnGps.classList.remove('disabled');
                            btnImagen.classList.remove('disabled');
                            btnVideo.classList.remove('disabled');
                            btnPunto.classList.add('disabled');
                            console.log('[mensajeria] Botones actualizados: GPS OFF - Punto deshabilitado, otros habilitados');
                        }
                        
                        // Actualizar el estado local
                        modoCasa = !mensaje.datos.gpsOn; // modoCasa es true cuando el GPS está apagado
                    }
                });

                // Manejador para mensajes específicos de hijo5-casa
                mensajeria.registrarControlador('mensaje-para-hijo2', (mensaje) => {
                    console.log('📨 [mensajeria] Mensaje específico para este hijo:', mensaje);
                    
                    // Si el mensaje tiene un campo 'datos', es el nuevo formato
                    if (mensaje.datos) {
                        manejarMensajeEspecifico(mensaje.datos.tipo, mensaje.datos);
                    } else {
                        // Formato antiguo (legacy)
                        manejarMensajeLegacy(mensaje.tipo, mensaje);
                    }
                });
                
                // Manejador para acciones del padre
                mensajeria.registrarControlador(mensajeria.TIPOS_MENSAJE.NAVEGACION.ACCION, (mensaje) => {
                    const { accion, datos } = mensaje.datos || {};
                    
                    switch(accion) {
                        case 'iniciar-estado-inicial':
                            iniciarEstadoInicial();
                            break;
                            
                        case 'iniciar-navegacion':
                            iniciarNavegacionAProximaParada();
                            break;
                            
                        case 'cambiar-modo':
                            if (datos?.modo) {
                                // Usar el nuevo sistema de manejo de modos
                                const habilitar = datos.habilitarControles || false;
                                manejarCambioModo(datos.modo, habilitar);
                                
                                // Mantener compatibilidad con el sistema antiguo
                                if (datos.modo === 'casa') {
                                    activarModoCasa();
                                } else if (datos.modo === 'aventura') {
                                    activarModoAventura();
                                }
                            }
                            break;
                            
                        case 'actualizar-parada-destino':
                            if (datos?.parada) {
                                paradaDestino = datos.parada;
                                estadoNavegacion.actualizar({ paradaActual: paradaDestino });
                                actualizarStatus(`🎯 Nuevo destino: Parada ${paradaDestino}`);
                                
                                // Notificar al padre del cambio de destino
                                mensajeria.enviarMensaje(mensajeria.TIPOS_MENSAJE.ESTADO.ACTUALIZAR, {
                                    estado: 'destino_actualizado',
                                    paradaActual: paradaDestino
                                });
                            }
                            break;
                            
                        case 'forzar-llegada':
                            if (datos?.parada) {
                                paradaActual = datos.parada;
                                estadoNavegacion.actualizar({ 
                                    paradaActual,
                                    estado: 'en_parada' 
                                });
                                procesarLlegadaAParada();
                                
                                // Notificar al padre de la llegada forzada
                                mensajeria.enviarMensaje(mensajeria.TIPOS_MENSAJE.ESTADO.ACTUALIZAR, {
                                    estado: 'llegada_forzada',
                                    paradaActual: paradaActual
                                });
                            }
                            break;
                            
                        case 'mostrar-video-con-zoom-secuencial':
                            if (datos?.coordenadasZoom && datos?.videoSrc) {
                                simularZoomYVideo(
                                    datos.coordenadasZoom,
                                    datos.videoSrc,
                                    datos.secuencia?.paso1?.duracion || 1000
                                );
                            }
                            break;
                            
                        case 'mostrar-ruta-navegacion':
                            simularZoomNavegacion(datos || {});
                            break;
                            
                        default:
                            console.warn('[mensajeria] Acción no reconocida:', accion, datos);
                            mensajeria.enviarMensaje(mensajeria.TIPOS_MENSAJE.SISTEMA.ERROR, {
                                codigo: 'ACCION_NO_RECONOCIDA',
                                mensaje: `Acción no reconocida: ${accion}`,
                                idMensajeOriginal: mensaje.id
                            });
                    }
                    
                    // Enviar confirmación de recepción
                    mensajeria.enviarMensaje(mensajeria.TIPOS_MENSAJE.SISTEMA.CONFIRMACION, {
                        idMensajeOriginal: mensaje.id,
                        accion: accion
                    });
                });
                
                console.log('[mensajeria] Manejadores configurados correctamente');
                return Promise.resolve();
            } catch (error) {
                console.error('[mensajeria] Error al configurar los manejadores:', error);
                return Promise.reject(error);
            }
        }

        // Función para verificar si todos los elementos necesarios están listos
        function verificarElementosListos() {
            const elementosNecesarios = [
                { id: 'btn-punto', nombre: 'Botón Punto' },
                { id: 'btn-ruta', nombre: 'Botón Ruta' },
                { id: 'btn-brujula', nombre: 'Botón Brújula' },
                { id: 'btn-gps', nombre: 'Botón GPS' }
            ];

            let todosListos = true;
            elementosNecesarios.forEach(item => {
                const elemento = document.getElementById(item.id);
                if (!elemento) {
                    console.error(`Elemento no encontrado: ${item.nombre} (${item.id})`);
                    todosListos = false;
                }
            });

            return todosListos;
        }

        // Inicialización mejorada
        function inicializarAplicacion() {
            console.log('Iniciando configuración de la aplicación...');
            
            // Verificar elementos del DOM
            if (!verificarElementosListos()) {
                console.warn('Algunos elementos no se encontraron, continuando con la inicialización...');
            }

            // Configurar la mensajería
            return configurarMensajeria()
                .then(() => {
                    console.log('Mensajería configurada, iniciando estado inicial...');
                    
                    // Iniciar en estado inicial por defecto
                    if (typeof iniciarEstadoInicial === 'function') {
                        iniciarEstadoInicial();
                    } else {
                        console.error('La función iniciarEstadoInicial no está definida');
                    }
                    
                    // Inicializar la barra de progreso si los elementos existen
                    if (totalTimeSpan) {
                        totalTimeSpan.textContent = formatTime(totalTripTime);
                    }
                    
                    if (typeof resetTripProgress === 'function') {
                        resetTripProgress();
                    }
                    
                    console.log('[APP] Aplicación inicializada correctamente');
                    
                    // Notificar al padre que la aplicación está lista usando el sistema de mensajería
                    if (window.parent !== window && typeof Mensajeria !== 'undefined' && typeof Mensajeria.enviarMensaje === 'function') {
                        Mensajeria.enviarMensaje('padre', 'app:ready', {
                            origen: 'hijo2',
                            timestamp: new Date().toISOString()
                        }).then(() => {
                            console.log('✅ Notificación de aplicación lista enviada correctamente');
                        }).catch(error => {
                            console.error('❌ Error al notificar que la aplicación está lista:', error);
                        });
                    } else if (window.parent !== window) {
                        console.warn('⚠️ No se pudo notificar al padre: el sistema de mensajería no está disponible');
                    }
                    
                    return Promise.resolve();
                })
                .catch(error => {
                    console.error('[ERROR] Error al inicializar la aplicación:', error);
                    
                    // Intentar una recuperación básica
                    try {
                        // Habilitar controles básicos aunque falle la mensajería
                        if (typeof enableControls === 'function') {
                            enableControls('aventura');
                        }
                    } catch (e) {
                        console.error('Error en la recuperación:', e);
                    }
                    
                    return Promise.reject(error);
                });
        }
        
        // Iniciar la aplicación cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarAplicacion);
        } else {
            inicializarAplicacion();
        }
        
        // Cerrar la función inicializarAplicacion
        }
    </script>
</head>

</body>
</html>
