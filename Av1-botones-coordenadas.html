<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Av1-botones-coordenadas-(hijo2)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: sans-serif;
        }

        /* Contenedor de botones */
        .button-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 65px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 5px;
            box-sizing: border-box;
            z-index: 1000;
        }

        /* Estilo base de los botones */
        .nav-button {
            position: relative;
            border: none;
            color: white;
            text-align: center;
            text-decoration: none;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            height: 50px;
            width: 16%; /* Ajustado para 6 botones */
            clip-path: polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%);
            transition: background-color 0.3s, transform 0.1s;
            background: linear-gradient(to bottom, #2ecc71, #27ae60); /* Verde degradado */
        }

        /* Colores específicos de cada botón - Eliminados para usar el nuevo sistema de habilitado/deshabilitado */

        /* Estados de los botones */
        .nav-button:active {
            transform: scale(0.95);
        }
        .nav-button.active {
            box-shadow: 0 0 15px 3px #fff; /* Resplandor blanco cuando está activo */
        }
        .nav-button.disabled,
        .nav-button:disabled {
            background: linear-gradient(to bottom, #e74c3c, #c0392b) !important; /* Rojo degradado */
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Estilos para el cambio de modo - Simplificados */
        .modo-aventura #btn-gps.active {
            /* En modo aventura y activo, el botón GPS se pone de un color especial */
            background: #1abc9c !important; /* Turquesa, mantenemos para estado activo especial */
        }

        /* Estilos para deshabilitar toda la UI */
        body.controles-deshabilitados .button-container {
            pointer-events: none;
            opacity: 0.6;
        }

        /* Estilos del Modal para imagen/video */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .modal-content {
            position: relative;
            background-color: #111;
            padding: 20px;
            border-radius: 5px;
            max-width: 90%;
            max-height: 90%;
            text-align: center;
        }
        .modal-close {
            position: absolute;
            top: -10px;
            right: -10px;
            color: #fff;
            background-color: #e74c3c;
            font-size: 25px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            line-height: 35px;
            text-align: center;
        }
        .modal-title {
            color: white;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        .media-container img, .media-container video {
            max-width: 100%;
            max-height: 70vh;
            border: 2px solid #fff;
        }
    </style>
</head>
<body class="modo-casa">

    <div class="button-container">
        <a href="#" id="btn-punto" class="nav-button"><i class="fas fa-map-marker-alt"></i></a>
        <a href="mapas/Av1_mapa.jpg" id="btn-mapa" class="nav-button" target="_blank"><i class="fas fa-map"></i></a>
        <a href="mapas/Av1_mapa.jpg" id="btn-brujula" class="nav-button" target="_blank"><i class="fas fa-compass"></i></a>
        <a href="#" id="btn-gps" class="nav-button"><i class="fas fa-directions"></i></a>
        <a href="#" id="btn-imagen" class="nav-button"><i class="fas fa-image"></i></a>
        <a href="#" id="btn-video" class="nav-button"><i class="fas fa-video"></i></a>
    </div>

    <div id="modal-medios" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h3 id="modal-title" class="modal-title"></h3>
            <div class="media-container"></div>
        </div>
    </div>

    <script type="module">
import { logger, configurarUtils, crearObjetoError } from './js/utils.js';
configurarUtils({ iframeId: 'hijo2', debug: true });

        // =================================================================================
        // 1. IMPORTACIONES Y CONFIGURACIÓN ÚNICA
        // =================================================================================
        // Importar el sistema de mensajería centralizado
        import { 
            inicializarMensajeria,
            registrarControlador,
            enviarMensaje,
            TIPOS_MENSAJE
        } from './js/mensajeria.js';

        const NAV_MSG = TIPOS_MENSAJE.NAVEGACION;
        const SISTEMA_MSG = TIPOS_MENSAJE.SISTEMA;

        // Configuración
        const CONFIG = {
            ID_APLICACION: 'av1-coordenadas',
            IFRAME_ID: 'hijo2',
            DEBUG: true,
            LOG_LEVEL: 1, // 0: debug, 1: info, 2: warn, 3: error
            NAVEGACION: {
                RADIO_LLEGADA: 15, // metros
            },
            REINTENTOS: {
                MAXIMOS: 3,
                TIEMPO_ESPERA: 1000,
                FACTOR: 2
            }
        };

        // Configuración de mensajería
        const CONFIG_MENSAJERIA = {
            iframeId: CONFIG.IFRAME_ID,
            debug: CONFIG.DEBUG,
            logLevel: CONFIG.LOG_LEVEL,
            reintentos: CONFIG.REINTENTOS
        };

        // =================================================================================
        // 2. ESTADO GLOBAL ÚNICO DE LA APLICACIÓN
        // =================================================================================
        const estadoApp = {
            inicializado: false,
            mensajeriaInicializada: false,
            modo: 'casa', // 'casa' o 'aventura'
            paradas: [],
            navegacion: {
                activa: false,
                destinoActual: null,
                ultimaUbicacion: null, // {lat, lng}
                puntoActual: null, // El objeto de parada/tramo actual
            },
            controlesHabilitados: true,
            elementosDOM: {
                btnPunto: document.getElementById('btn-punto'),
                btnMapa: document.getElementById('btn-mapa'),
                btnBrujula: document.getElementById('btn-brujula'),
                btnGps: document.getElementById('btn-gps'),
                btnImagen: document.getElementById('btn-imagen'),
                btnVideo: document.getElementById('btn-video'),
                modal: document.getElementById('modal-medios'),
                modalTitle: document.getElementById('modal-title'),
                modalMediaContainer: document.querySelector('.media-container'),
                modalClose: document.querySelector('.modal-close'),
            }
        };

     // ================== COORDENADAS DE LAS PARADAS ==================
       
          const COORDENADAS_PARADAS = [
    { id: 'P-0', tipo: "inicio", parada: 0, nombre: "Torres de Serranos (start)", coordenadas: { lat: 39.47876, lng: -0.37626 }, imagen: 'fotos_Av1/00_torres_de_serranos_back.jpg', video: 'videos/parada_0.mp4' },
    { id: 'TR-1', tipo: "tramo", tramo: 1, nombre: "Torres de Serranos → Plaza de la crida (Puente de Serranos)", inicio: { lat: 39.47876, lng: -0.37626 }, waypoints: [ { lat: 39.47905, lng: -0.37613 }, { lat: 39.47933, lng: -0.37647 }, { lat: 39.47943, lng: -0.37636 } ], fin: { lat: 39.47959, lng: -0.37583 }, imagen: 'fotos_Av1/01_torres_de_serranos_front.jpg', video: 'videos/tramo_1.mp4' },
    { id: 'P-1', tipo: "parada", parada: 1, nombre: "Plaza de la crida (Puente de Serranos)", coordenadas: { lat: 39.47959, lng: -0.37583 }, imagen: 'fotos_Av1/01_torres_de_serranos_front.jpg' },
    { id: 'TR-2', tipo: "tramo", tramo: 2, nombre: "Plaza de la crida → Calle Muro de Santa Ana", inicio: { lat: 39.47959, lng: -0.37583 }, waypoints: [ { lat: 39.47939, lng: -0.3752 }, { lat: 39.47902, lng: -0.37465 }, { lat: 39.47866, lng: -0.3747 } ], fin: { lat: 39.47866, lng: -0.3747 }, imagen: 'muro de Santa ana.jpg', video: 'videos/tramo 2_2.mp4' },
    { id: 'P-2', tipo: "parada", parada: 2, nombre: "Calle Muro de Santa Ana", coordenadas: { lat: 39.47866, lng: -0.3747 }, imagen: 'muro de Santa ana.jpg' },
    { id: 'TR-3', tipo: "tramo", tramo: 3, nombre: "Calle Muro de Santa Ana → Palacio de los Borgia", inicio: { lat: 39.47866, lng: -0.3747 }, waypoints: [], fin: { lat: 39.47768, lng: -0.3749 }, imagen: 'fotos_Av1/02_cortes_valencianas.jpg', video: 'videos/tramo_3.mp4' },
    { id: 'P-3', tipo: "parada", parada: 3, nombre: "Iglesia de San Lorenzo", coordenadas: { lat: 39.47768, lng: -0.3749 }, imagen: 'fotos_Av1/03_iglesia_de_san_lorenzo.jpg' },
    { id: 'TR-4', tipo: "tramo", tramo: 4, nombre: "Iglesia de San Lorenzo → Plaza de la Virgen", inicio: { lat: 39.47768, lng: -0.3749 }, waypoints: [], fin: { lat: 39.47656, lng: -0.37529 }, imagen: 'fotos_Av1/04_plaza_de_la_virgen.jpg', video: 'videos/tramo_4.mp4' },
    { id: 'P-4', tipo: "parada", parada: 4, nombre: "Plaza de la Virgen Reto 6", coordenadas: { lat: 39.47656, lng: -0.37529 }, imagen: 'fotos_Av1/04_plaza_de_la_virgen.jpg' },
    { id: 'P-5', tipo: "parada", parada: 5, nombre: "Plaza de la Virgen Reto 7", coordenadas: { lat: 39.47656, lng: -0.37529 }, imagen: 'fotos_Av1/04_plaza_de_la_virgen.jpg' },
    { id: 'TR-5', tipo: "tramo", tramo: 5, nombre: "Plaza de la Virgen → Plaza de la Almoína", inicio: { lat: 39.47656, lng: -0.37529 }, waypoints: [ { lat: 39.4766, lng: -0.37473 }, { lat: 39.47656, lng: -0.37453 }, { lat: 39.47606, lng: -0.3746 } ], fin: { lat: 39.47604, lng: -0.37451 }, imagen: 'fotos_Av1/05_plaza_de_la_almoina.jpg', video: 'videos/tramo_5.mp4' },
    { id: 'P-6', tipo: "parada", parada: 6, nombre: "Panel cerámico muro Catedral", coordenadas: { lat: 39.47604, lng: -0.37451 }, imagen: 'fotos_Av1/06_panel_ceramico_muro_norte_catedral.jpg' },
    { id: 'P-7', tipo: "parada", parada: 7, nombre: "Capilla exterior catedral Reto 10", coordenadas: { lat: 39.47604, lng: -0.37451 }, imagen: 'fotos_Av1/07!!!_capilla_exterior_catedral.jpg' },
    { id: 'P-8', tipo: "parada", parada: 8, nombre: "Capilla exterior catedral Reto 11", coordenadas: { lat: 39.47604, lng: -0.37451 }, imagen: 'fotos_Av1/07!!!_capilla_exterior_catedral.jpg' },
    { id: 'P-9', tipo: "parada", parada: 9, nombre: "Arco Novo Catedral y Puerta Negra Basílica", coordenadas: { lat: 39.47604, lng: -0.37451 }, imagen: 'fotos_Av1/08_arco_novo_catedral.jpg', imagen2: 'fotos_Av1/09_puerta_negra_relieve_basilica.jpg' },
    { id: 'P-10', tipo: "parada", parada: 10, nombre: "Casa del Punt de Gantxo", coordenadas: { lat: 39.47604, lng: -0.37451 }, imagen: 'fotos_Av1/10_casa_del_punt_de_gantxo.jpg' },
    { id: 'TR-6', tipo: "tramo", tramo: 6, nombre: "Plaza de la Almoína → Plaza Decimo Junio Bruto (Museo Arqueológico de la Almoína)", inicio: { lat: 39.47594, lng: -0.37474 }, waypoints: [], fin: { lat: 39.4762, lng: -0.37412 }, imagen: 'fotos_Av1/05_plaza_de_la_almoina.jpg', video: 'videos/tramo_6.mp4' },
    { id: 'P-11', tipo: "parada", parada: 11, nombre: "Museo arqueológico La Almoína", coordenadas: { lat: 39.4762, lng: -0.37412 }, imagen: 'fotos_Av1/27_museo_la_almoina.jpg' },
    { id: 'P-12', tipo: "parada", parada: 12, nombre: "Museo arqueológico La Almoína", coordenadas: { lat: 39.4762, lng: -0.37412 }, imagen: 'fotos_Av1/27_museo_la_almoina.jpg' },
    { id: 'P-13', tipo: "parada", parada: 13, nombre: "Vista de la Catedral, Cimborrio", coordenadas: { lat: 39.4762, lng: -0.37412 }, imagen: 'fotos_Av1/05_plaza_de_la_almoina.jpg' },
    { id: 'TR-7', tipo: "tramo", tramo: 7, nombre: "Museo arqueológico La Almoína → Palacio Arzobispal", inicio: { lat: 39.47611, lng: -0.37478 }, waypoints: [ { lat: 39.47604, lng: -0.37442 }, { lat: 39.47584, lng: -0.37443 }, { lat: 39.47561, lng: -0.37451 } ], fin: { lat: 39.4755, lng: -0.37436 }, imagen: 'fotos_Av1/11_palacio_arzobispal.jpg', video: 'videos/parada_8.mp4' },
    { id: 'P-14', tipo: "parada", parada: 14, nombre: "Palacio Arzobispal y Puerta Románica de la Catedral", coordenadas: { lat: 39.4755, lng: -0.37436 }, imagen: 'fotos_Av1/12_puerta_romanica_catedral.jpg' },
    { id: 'P-15', tipo: "parada", parada: 15, nombre: "Puerta Románica de la Catedral", coordenadas: { lat: 39.47561, lng: -0.37465 }, imagen: 'fotos_Av1/12_puerta_romanica_catedral.jpg' },
    { id: 'TR-8', tipo: "tramo", tramo: 8, nombre: "Puerta Románica de la Catedral → Plaza del Ayuntamiento", inicio: { lat: 39.47561, lng: -0.37465 }, waypoints: [ { lat: 39.4756, lng: -0.37466 }, { lat: 39.47514, lng: -0.37494 }, { lat: 39.47447, lng: -0.3754 }, { lat: 39.47378, lng: -0.3756 }, { lat: 39.47212, lng: -0.37676 } ], fin: { lat: 39.47056, lng: -0.37677 }, imagen: 'fotos_Av1/13_plaza_del_ayuntamiento.jpg', video: 'videos/tramo_8.mp4' },
    { id: 'P-16', tipo: "parada", parada: 16, nombre: "Plaza del Ayuntamiento", coordenadas: { lat: 39.47056, lng: -0.37677 }, imagen: 'fotos_Av1/13_plaza_del_ayuntamiento.jpg' },
    { id: 'TR-9', tipo: "tramo", tramo: 9, nombre: "Plaza del Ayuntamiento → Edificio del Ayuntamiento de València", inicio: { lat: 39.47056, lng: -0.37677 }, waypoints: [], fin: { lat: 39.46971, lng: -0.37693 }, imagen: 'fotos_Av1/14_ayuntamiento.jpg', video: 'videos/tramo_9.mp4' },
    { id: 'P-17', tipo: "parada", parada: 17, nombre: "Edificio del Ayuntamiento", coordenadas: { lat: 39.46971, lng: -0.37693 }, imagen: 'fotos_Av1/14_ayuntamiento.jpg' },
    { id: 'P-18', tipo: "parada", parada: 18, nombre: "Edificio del Ayuntamiento", coordenadas: { lat: 39.46971, lng: -0.37693 }, imagen: 'fotos_Av1/14_ayuntamiento.jpg' },
    { id: 'TR-10', tipo: "tramo", tramo: 10, nombre: "Edificio del Ayuntamiento → Estación del Norte", inicio: { lat: 39.46971, lng: -0.37693 }, waypoints: [ { lat: 39.46795, lng: -0.37701 } ], fin: { lat: 39.46722, lng: -0.37702 }, imagen: 'fotos_Av1/15_plaza_de_toros_y_estacion_del_norte.jpg', video: 'videos/tramo_10.mp4' },
    { id: 'P-19', tipo: "parada", parada: 19, nombre: "Estación del Norte", coordenadas: { lat: 39.46722, lng: -0.37702 }, imagen: 'fotos_Av1/15_plaza_de_toros_y_estacion_del_norte.jpg' },
    { id: 'TR-11', tipo: "tramo", tramo: 11, nombre: "Estación del Norte → Plaza de Toros de València", inicio: { lat: 39.46722, lng: -0.37702 }, waypoints: [], fin: { lat: 39.46709, lng: -0.37595 }, imagen: 'fotos_Av1/15_plaza_de_toros_y_estacion_del_norte.jpg', video: 'videos/tramo_11.mp4' },
    { id: 'TR-12', tipo: "tramo", tramo: 12, nombre: "Plaza de Toros → Casa estilo Árabe", inicio: { lat: 39.46709, lng: -0.37595 }, waypoints: [ { lat: 39.46714, lng: -0.37498 } ], fin: { lat: 39.46753, lng: -0.37511 }, imagen: 'fotos_Av1/16!!!!_casa_estilo_arabe.jpg', video: 'videos/parada_13.mp4' },
    { id: 'P-20', tipo: "parada", parada: 20, nombre: "Casa estilo Árabe", coordenadas: { lat: 39.46753, lng: -0.37511 }, imagen: 'fotos_Av1/16!!!!_casa_estilo_arabe.jpg' },
    { id: 'P-21', tipo: "parada", parada: 21, nombre: "Casa estilo Árabe, mitad Aventura", coordenadas: { lat: 39.46753, lng: -0.37511 }, imagen: 'fotos_Av1/16!!!!_casa_estilo_arabe.jpg' },
    { id: 'TR-13', tipo: "tramo", tramo: 13, nombre: "Casa estilo Árabe → Palacio de Comunicaciones (Correos)", inicio: { lat: 39.46753, lng: -0.37511 }, waypoints: [], fin: { lat: 39.46942, lng: -0.37559 }, imagen: 'fotos_Av1/17_correos.jpg', video: 'videos/tramo_13.mp4' },
    { id: 'P-22', tipo: "parada", parada: 23, nombre: "Edificio Suay", coordenadas: { lat: 39.46942, lng: -0.37559 }, imagen: 'fotos_Av1/18_edificio_suay.jpg' },
    { id: 'TR-14', tipo: "tramo", tramo: 14, nombre: "Palacio de Comunicaciones → Banco de València", inicio: { lat: 39.46942, lng: -0.37559 }, waypoints: [ { lat: 39.4699, lng: -0.37573 }, { lat: 39.4703, lng: -0.3759 }, { lat: 39.47039, lng: -0.37505 }, { lat: 39.47043, lng: -0.37427 } ], fin: { lat: 39.47061, lng: -0.37408 }, imagen: 'fotos_Av1/19_banco_de_valencia.jpg', video: 'videos/tramo_14.mp4' },
    { id: 'P-24', tipo: "parada", parada: 24, nombre: "Banco de Valencia", coordenadas: { lat: 39.47061, lng: -0.37408 }, imagen: 'fotos_Av1/19_banco_de_valencia.jpg' },
    { id: 'TR-15', tipo: "tramo", tramo: 15, nombre: "Banco de València → Palacio del Marqués de Dos Aguas (Museo Nacional de Cerámica)", inicio: { lat: 39.47061, lng: -0.37408 }, waypoints: [ { lat: 39.47119, lng: -0.37423 }, { lat: 39.47214, lng: -0.37446 }, { lat: 39.47275, lng: -0.37445 } ], fin: { lat: 39.47276, lng: -0.37467 }, imagen: 'fotos_Av1/20!!!!_ marques_de_dos aguas.jpg', video: 'videos/parada_16.mp4' },
    { id: 'P-25', tipo: "parada", parada: 25, nombre: "Palacio del Marqués de Dos Aguas (Museo Nacional de Cerámica)", coordenadas: { lat: 39.47276, lng: -0.37467 }, imagen: 'fotos_Av1/20!!!!_ marques_de_dos aguas.jpg' },
    { id: 'TR-16', tipo: "tramo", tramo: 16, nombre: "Palacio del Marqués → Mercado Central", inicio: { lat: 39.47276, lng: -0.37467 }, waypoints: [ { lat: 39.47315, lng: -0.37608 }, { lat: 39.47261, lng: -0.37654 }, { lat: 39.47225, lng: -0.37686 }, { lat: 39.47265, lng: -0.37725 } ], fin: { lat: 39.47377, lng: -0.37832 }, imagen: 'fotos_Av1/21_mercado_central.jpg', video: 'videos/tramo_16.mp4' },
    { id: 'P-26', tipo: "parada", parada: 26, nombre: "Mercado central", coordenadas: { lat: 39.47377, lng: -0.37832 }, imagen: 'fotos_Av1/21_mercado_central.jpg' },
    { id: 'TR-17', tipo: "tramo", tramo: 17, nombre: "Mercado Central → Iglesia de los Santos Juanes", inicio: { lat: 39.47377, lng: -0.37832 }, waypoints: [], fin: { lat: 39.47425, lng: -0.37895 }, imagen: 'fotos_Av1/22_iglesia_san_juan_del_mercado.jpg', video: 'videos/tramo_17.mp4' },
    { id: 'P-27', tipo: "parada", parada: 27, nombre: "Iglesia de los Santos Juanes reto 24", coordenadas: { lat: 39.47425, lng: -0.37895 }, imagen: 'fotos_Av1/22_iglesia_san_juan_del_mercado.jpg' },
    { id: 'P-28', tipo: "parada", parada: 28, nombre: "Iglesia de los Santos Juanes reto 25", coordenadas: { lat: 39.47425, lng: -0.37895 }, imagen: 'fotos_Av1/22_iglesia_san_juan_del_mercado.jpg' },
    { id: 'TR-18', tipo: "tramo", tramo: 18, nombre: "Iglesia Santos Juanes → Lonja de València (Mercado de la Seda)", inicio: { lat: 39.47425, lng: -0.37895 }, waypoints: [], fin: { lat: 39.47426, lng: -0.37862 }, imagen: 'fotos_Av1/23_lonja.jpg', video: 'videos/parada_19.mp4' },
    { id: 'P-29', tipo: "parada", parada: 29, nombre: "Lonja Puerta de Los Pecados barquero", coordenadas: { lat: 39.4742, lng: -0.37851 }, imagen: 'fotos_Av1/23_lonja.jpg' },
    { id: 'P-30', tipo: "parada", parada: 30, nombre: "Lonja Puerta de Los Pecados árbol muerto", coordenadas: { lat: 39.4742, lng: -0.37851 }, imagen: 'fotos_Av1/23_lonja.jpg' },
    { id: 'TR-19', tipo: "tramo", tramo: 19, nombre: "Lonja Gárgolas", inicio: { lat: 39.4742, lng: -0.37851 }, waypoints: [], fin: { lat: 39.4742, lng: -0.37881 }, imagen: 'fotos_Av1/23_lonja.jpg' },
    { id: 'P-31', tipo: "parada", parada: 31, nombre: "Lonja Gárgolas ángel vasija", coordenadas: { lat: 39.4742, lng: -0.37881 }, imagen: 'fotos_Av1/23_lonja.jpg' },
    { id: 'P-32', tipo: "parada", parada: 32, nombre: "Lonja Gárgolas barbudo y león", coordenadas: { lat: 39.4742, lng: -0.37881 }, imagen: 'fotos_Av1/23_lonja.jpg' },
    { id: 'P-33', tipo: "parada", parada: 33, nombre: "Lonja Gárgolas fornicador ventana", coordenadas: { lat: 39.47439, lng: -0.37887 }, imagen: 'fotos_Av1/23_lonja.jpg' },
    { id: 'TR-20', tipo: "tramo", tramo: 20, nombre: "Lonja → Plaza del Doctor Collado", inicio: { lat: 39.47426, lng: -0.37862 }, waypoints: [ { lat: 39.47445, lng: -0.37889 }, { lat: 39.47459, lng: -0.37868 }, { lat: 39.47475, lng: -0.37842 }, { lat: 39.47436, lng: -0.37799 } ], fin: { lat: 39.47444, lng: -0.3779 }, imagen: 'fotos_Av1/24_lonja2.jpg', video: 'videos/tramo_20.mp4' },
    { id: 'TR-21', tipo: "tramo", tramo: 21, nombre: "Plaza del Doctor Collado → Plaza del Negrito (Fuente del Negrito)", inicio: { lat: 39.47444, lng: -0.3779 }, waypoints: [ { lat: 39.47473, lng: -0.37763 }, { lat: 39.47493, lng: -0.37761 }, { lat: 39.47559, lng: -0.37772 } ], fin: { lat: 39.47611, lng: -0.37741 }, imagen: 'fotos_Av1/25_fuente_del_negrito.jpg', video: 'videos/parada_21.mp4' },
    { id: 'P-34', tipo: "parada", parada: 34, nombre: "Fuente del Negrito", coordenadas: { lat: 39.47611, lng: -0.37741 }, imagen: 'fotos_Av1/25_fuente_del_negrito.jpg' },
    { id: 'TR-22', tipo: "tramo", tramo: 22, nombre: "Plaza del Negrito → Calle Caballeros", inicio: { lat: 39.47611, lng: -0.37741 }, waypoints: [ { lat: 39.47663, lng: -0.3773 }, { lat: 39.47661, lng: -0.37685 } ], fin: { lat: 39.47668, lng: -0.37671 }, imagen: 'fotos_Av1/26_palau_de_la_generalitat.jpg', video: 'videos/parada_22.mp4' },
    { id: 'P-35', tipo: "parada", parada: 35, nombre: "Palau de la Generalitat", coordenadas: { lat: 39.47668, lng: -0.37671 }, imagen: 'fotos_Av1/26_palau_de_la_generalitat.jpg' },
    { id: 'TR-23', tipo: "tramo", tramo: 23, nombre: "Palacio de la Generalitat → Calle de los Serranos (FINAL)", inicio: { lat: 39.47668, lng: -0.37671 }, waypoints: [ { lat: 39.47661, lng: -0.37685 }, { lat: 39.47687, lng: -0.37686 } ], fin: { lat: 39.47773, lng: -0.37671 }, imagen: 'fotos_Av1/00_torres_de_serranos_back.jpg', video: 'videos/parada_24.mp4' },
    { id: 'P-36', tipo: "parada", parada: 36, nombre: "Torres de Serranos Final", coordenadas: { lat: 39.47773, lng: -0.37671 }, imagen: 'fotos_Av1/00_torres_de_serranos_back.jpg' }
];

        estadoApp.paradas = COORDENADAS_PARADAS;

        // =================================================================================
        // 4. FUNCIONES DE LÓGICA Y UTILIDADES
        // =================================================================================

        function habilitarControles(habilitar) {
            estadoApp.controlesHabilitados = habilitar;
            document.body.classList.toggle('controles-deshabilitados', !habilitar);
            logger.info(`Controles ${habilitar ? 'habilitados' : 'deshabilitados'}`);
        }

        function actualizarInterfazModo(modo) {
            logger.info(`[MODO] Actualizando interfaz a modo: ${modo}`);
            document.body.classList.remove('modo-casa', 'modo-aventura');
            document.body.classList.add(`modo-${modo}`);
            actualizarEstadoBtnImagen();
        }

        function mostrarMedioEnModal(tipo) {
            const { modal, modalTitle, modalMediaContainer } = estadoApp.elementosDOM;
            const elementoActual = estadoApp.navegacion.puntoActual;

            modalTitle.textContent = elementoActual ? elementoActual.nombre : '';
            modalMediaContainer.innerHTML = ''; // Limpiar contenido anterior

            if (tipo === 'imagen') {
                if (elementoActual && elementoActual.imagen) {
                    const img = document.createElement('img');
                    img.src = elementoActual.imagen;
                    img.alt = `Imagen de ${elementoActual.nombre}`;
                    modalMediaContainer.appendChild(img);
                }
                // Si no hay imagen, solo muestra el modal vacío con el título
            } else if (tipo === 'video') {
                let mostrarVideo = false;
                if (elementoActual && elementoActual.tipo === 'tramo') {
                    // Mostrar video solo si es tramo y modo casa o aventura
                    if (estadoApp.modo === 'casa' || estadoApp.modo === 'aventura') {
                        mostrarVideo = true;
                    }
                }
                if (mostrarVideo && elementoActual.video) {
                    const video = document.createElement('video');
                    video.src = elementoActual.video;
                    video.controls = true;
                    video.autoplay = true;
                    modalMediaContainer.appendChild(video);
                }
                // Si no hay video o no es tramo, solo muestra el modal vacío con el título
            }

            modal.style.display = 'flex';
        }

        function actualizarEstadoBtnPunto() {
            const btnPunto = estadoApp.elementosDOM.btnPunto;
            const ubicacion = estadoApp.navegacion.ultimaUbicacion;
            const punto = estadoApp.navegacion.puntoActual;
            if (!btnPunto || !ubicacion || !punto) {
                btnPunto.disabled = true;
                btnPunto.classList.add('disabled');
                return;
            }
            // Obtener coordenadas destino
            let destinoCoords = punto.coordenadas;
            if (!destinoCoords && punto.inicio) destinoCoords = punto.inicio;
            if (!destinoCoords) {
                btnPunto.disabled = true;
                btnPunto.classList.add('disabled');
                return;
            }
            // Calcular distancia
            const R = 6371000;
            const toRad = deg => deg * Math.PI / 180;
            const dLat = toRad(destinoCoords.lat - ubicacion.lat);
            const dLng = toRad(destinoCoords.lng - ubicacion.lng);
            const a = Math.sin(dLat/2)**2 + Math.cos(toRad(ubicacion.lat)) * Math.cos(toRad(destinoCoords.lat)) * Math.sin(dLng/2)**2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distancia = R * c;
            // Habilitar/deshabilitar según distancia
            if (distancia > 30) {
                btnPunto.disabled = false;
                btnPunto.classList.remove('disabled');
            } else {
                btnPunto.disabled = true;
                btnPunto.classList.add('disabled');
            }
        }

        function actualizarEstadoBtnImagen() {
            const btnImagen = estadoApp.elementosDOM.btnImagen;
            const modo = estadoApp.modo;
            const btnPunto = estadoApp.elementosDOM.btnPunto;
            // Habilitado si:
            // - Estamos en modo casa
            // - O el botón de parada está habilitado (puede solicitar próxima parada)
            if (modo === 'casa' || (btnPunto && !btnPunto.disabled)) {
                btnImagen.disabled = false;
                btnImagen.classList.remove('disabled');
            } else {
                btnImagen.disabled = true;
                btnImagen.classList.add('disabled');
            }
        }

        let indiceActual = 0; // Índice del punto actual en el array

        function actualizarEstadoBtnGps() {
            const btnGps = estadoApp.elementosDOM.btnGps;
            // Habilitado solo si controles están habilitados, modo aventura y usuario está a menos de 30m del punto actual
            const ubicacion = estadoApp.navegacion.ultimaUbicacion;
            const punto = estadoApp.navegacion.puntoActual;
            let habilitado = false;
            if (estadoApp.modo === 'aventura' && estadoApp.controlesHabilitados && ubicacion && punto) {
                let destinoCoords = punto.coordenadas || punto.inicio;
                if (destinoCoords) {
                    const R = 6371000;
                    const toRad = deg => deg * Math.PI / 180;
                    const dLat = toRad(destinoCoords.lat - ubicacion.lat);
                    const dLng = toRad(destinoCoords.lng - ubicacion.lng);
                    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(ubicacion.lat)) * Math.cos(toRad(destinoCoords.lat)) * Math.sin(dLng/2)**2;
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    const distancia = R * c;
                    habilitado = distancia <= 30;
                }
            }
            btnGps.disabled = !habilitado;
            btnGps.classList.toggle('active', habilitado);
        }

        // =================================================================================
        // 5. MANEJADORES DE EVENTOS DE BOTONES
        // =================================================================================

        async function manejarClickPunto() {
            if (!estadoApp.controlesHabilitados) return;
            logger.info("Botón 'Punto de Interés' presionado.");
            
            if (!estadoApp.navegacion.ultimaUbicacion) {
                logger.warn("No se puede solicitar destino sin una ubicación actual del usuario.");
                // Opcional: Pedir al padre que inicie el GPS para obtener ubicación
                return;
            }

            try {
                await enviarMensaje('padre', TIPOS_MENSAJE.NAVEGACION.ESTABLECER_DESTINO, {
                    ubicacionActual: estadoApp.navegacion.ultimaUbicacion
                });
                logger.info("Solicitud de destino enviada al padre con ubicación actual.");
            } catch (error) {
                logger.error("Error al enviar solicitud de destino:", error);
            }
        }

        async function manejarClickGps() {
            // Solo avanza si está habilitado
            if (estadoApp.elementosDOM.btnGps.disabled) return;
            // Avanzar al siguiente punto del array
            if (indiceActual < estadoApp.paradas.length - 1) {
                indiceActual++;
                const siguientePunto = estadoApp.paradas[indiceActual];
                estadoApp.navegacion.puntoActual = siguientePunto;
                // Notificar al padre para orquestar navegación/audio/retos
                await enviarMensaje('padre', TIPOS_MENSAJE.NAVEGACION.CAMBIO_PARADA, {
                    puntoId: siguientePunto.id,
                    index: indiceActual
                });
                logger.info(`Avanzando al siguiente punto: ${siguientePunto.nombre}`);
                actualizarEstadoBtnGps();
                actualizarEstadoBtnPunto();
            }
        }

        // =================================================================================
        // 6. MANEJADORES DE MENSAJES DEL PADRE
        // =================================================================================

        /**
         * Maneja el cambio de modo (casa/aventura)
         * @param {Object} mensaje - Mensaje con los datos del cambio de modo
         * @returns {Promise<Object>} Resultado de la operación
         */
        async function manejarCambioModo(mensaje) {
            try {
                const { modo, gpsActivo, origen, razon } = mensaje.datos || {};
                
                // Validar el mensaje recibido
                if (!modo || !origen) {
                    const errorMsg = 'Mensaje de cambio de modo inválido: falta modo u origen';
                    logger.error(errorMsg, mensaje);
                    await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.ERROR, {
                        codigo: 'ERROR_CAMBIO_MODO_INVALIDO',
                        mensaje: errorMsg,
                        origen: 'hijo2',
                        timestamp: Date.now()
                    });
                    return { exito: false, error: errorMsg };
                }
                
                logger.info(`Cambiando a modo: ${modo}${razon ? ` (${razon})` : ''}`, { origen });
                
                // Actualizar el estado local
                estadoApp.modo = modo;
                // Encender/apagar GPS según el modo
                if (gpsActivo) {
                    // Activar GPS
                    estadoApp.navegacion.activa = true;
                    logger.info('GPS ACTIVADO (modo aventura)');
                } else {
                    // Desactivar GPS
                    estadoApp.navegacion.activa = false;
                    logger.info('GPS DESACTIVADO (modo casa)');
                }
                document.body.classList.toggle('modo-aventura', modo === 'aventura');
                document.body.classList.toggle('modo-casa', modo === 'casa');
                
                // Actualizar la interfaz
                actualizarInterfazModo(modo);

                if (modo === 'aventura') {
                    // Lógica específica del modo aventura
                    estadoApp.navegacion.activa = true;
                    estadoApp.elementosDOM.btnGps.classList.add('active');
                    
                    // Notificar al padre que el cambio de modo se completó
                    await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.INICIALIZACION_COMPLETADA, {
                        idIframe: 'hijo2',
                        estado: 'listo',
                        timestamp: Date.now()
                    });
                    
                    // Iniciar navegación si es necesario
                    await enviarMensaje('padre', TIPOS_MENSAJE.NAVEGACION.INICIAR, {
                        destinoId: 'hijo2',
                        timestamp: Date.now()
                    }).catch(error => {
                        logger.error('Error al iniciar navegación:', error);
                        throw error;
                    });
                } else if (modo === 'casa') {
                    // Lógica específica del modo casa
                    estadoApp.navegacion.activa = false;
                    estadoApp.elementosDOM.btnGps.classList.remove('active');
                    await enviarMensaje('padre', TIPOS_MENSAJE.NAVEGACION.DETENER, { 
                        motivo: 'cambio_a_modo_casa',
                        timestamp: Date.now()
                    }).catch(error => logger.error('Error al detener navegación:', error));
                }
                
                return { exito: true, modoActual: estadoApp.modo };
            } catch (error) {
                logger.error('Error en manejarCambioModo:', error);
                await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.ERROR, {
                    codigo: 'ERROR_MANEJO_CAMBIO_MODO',
                    mensaje: error.message,
                    origen: 'hijo2',
                    timestamp: Date.now(),
                    stack: error.stack
                });
                return { exito: false, error: error.message };
            }
        }

        function manejarActualizacionUbicacion(mensaje) {
            const { lat, lng } = mensaje.datos;
            estadoApp.navegacion.ultimaUbicacion = { lat, lng };
            logger.debug("Ubicación actual actualizada:", estadoApp.navegacion.ultimaUbicacion);
            actualizarEstadoBtnPunto();
            actualizarEstadoBtnGps();
            return { exito: true };
        }

        function manejarCambioPuntoActual(mensaje) {
            const { puntoId, index } = mensaje.datos;
            indiceActual = typeof index === 'number' ? index : 0;
            estadoApp.navegacion.puntoActual = estadoApp.paradas[indiceActual];
            logger.info("Punto actual de navegación actualizado:", estadoApp.navegacion.puntoActual?.nombre);
            actualizarEstadoBtnPunto();
            actualizarEstadoBtnGps();
            actualizarEstadoBtnImagen();
            return { exito: true };
        }

        /**
         * Maneja las solicitudes de datos de una parada específica.
         * @param {object} mensaje - El mensaje con el ID de la parada solicitada.
         * @returns {object} La información completa de la parada o un error.
         */
        function manejarSolicitudDatosParada(mensaje) {
            const { puntoId } = mensaje.datos;
            logger.info(`Recibida solicitud de datos para el punto: ${puntoId}`);
            const punto = COORDENADAS_PARADAS.find(p => p.id === puntoId);

            if (punto) {
                logger.info(`Enviando datos para: ${punto.nombre}`);
                return { exito: true, datosPunto: punto };
            } else {
                logger.error(`No se encontraron datos para el punto con id: ${puntoId}`);
                return { exito: false, error: `Punto no encontrado: ${puntoId}` };
            }
        }

        function registrarManejadoresMensajes() {
            logger.info('Registrando manejadores de mensajes...');
            
            registrarControlador(SISTEMA_MSG.CAMBIO_MODO, manejarCambioModo);
            registrarControlador(TIPOS_MENSAJE.UI.HABILITAR_CONTROLES, () => habilitarControles(true)); 
            registrarControlador(TIPOS_MENSAJE.UI.DESHABILITAR_CONTROLES, () => habilitarControles(false)); 
            registrarControlador(TIPOS_MENSAJE.GPS.ACTUALIZAR, manejarActualizacionUbicacion);
            registrarControlador(NAV_MSG.CAMBIO_PARADA, manejarCambioPuntoActual);
            registrarControlador(TIPOS_MENSAJE.DATOS.SOLICITAR_PARADA, manejarSolicitudDatosParada);
            
            logger.info('Manejadores registrados.');
        }

        // =================================================================================
        // 7. INICIALIZACIÓN
        // =================================================================================

        function configurarEventosUI() {
            const { btnPunto, btnGps, btnImagen, btnVideo, modal, modalClose } = estadoApp.elementosDOM;

            btnPunto.addEventListener('click', (e) => { e.preventDefault(); manejarClickPunto(); });
            btnGps.addEventListener('click', (e) => { e.preventDefault(); manejarClickGps(); });
            btnImagen.addEventListener('click', (e) => { e.preventDefault(); mostrarMedioEnModal('imagen'); });
            btnVideo.addEventListener('click', (e) => { e.preventDefault(); mostrarMedioEnModal('video'); });

            modalClose.addEventListener('click', () => {
                modal.style.display = 'none';
                const videoEl = modal.querySelector('video');
                if (videoEl) videoEl.pause();
            });

            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    const videoEl = modal.querySelector('video');
                    if (videoEl) videoEl.pause();
                }
            });
            
            logger.info('Eventos de UI configurados.');
        }

        async function inicializar() {
            if (estadoApp.inicializado) {
                logger.warn('Intento de reinicializar la aplicación.');
                return;
            }
            logger.info('🚀 Iniciando inicialización de la aplicación...');

            try {
                await inicializarMensajeria(CONFIG_MENSAJERIA);    
                estadoApp.mensajeriaInicializada = true;
                logger.info('✅ Sistema de mensajería inicializado.');

                registrarManejadoresMensajes();
                
                configurarEventosUI();
                actualizarInterfazModo(estadoApp.modo);
                habilitarControles(estadoApp.controlesHabilitados);

                await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.INICIALIZACION_COMPLETADA, {
                    componente: CONFIG.IFRAME_ID,
                    estado: 'listo'
                });

                estadoApp.inicializado = true;
                logger.info('✨ Aplicación inicializada correctamente.');

            } catch (error) {
                logger.error('❌ Error fatal durante la inicialización:', error);
                document.body.innerHTML = `<div style="color:red; background:white; padding:20px; border: 2px solid red;">Error Crítico: ${error.message}.</div>`;
            }
        }

        // Punto de entrada único
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializar);
        } else {
            inicializar();
        }

        // Exponer funciones de mensajería al ámbito global
        window.registrarControlador = registrarControlador;
        window.TIPOS_MENSAJE = TIPOS_MENSAJE;
        window.enviarMensaje = enviarMensaje;
    </script>
</body>
</html>
