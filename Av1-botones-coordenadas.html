<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Av1-botones-coordenadas-(hijo2)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            /* Variables de dise√±o para botones */
            --btn-size: 60px;
            --icon-size: 1.5em;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: transparent;
        }

        /* Contenedor principal con forma trapezoidal */
        .container {
            width: 290px;
            height: 100px; /* Reducida la altura al eliminar la barra de progreso */
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.13);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            padding: 5px 8px 5px 8px;
            box-sizing: border-box;
            margin: 5px 0;
            clip-path: polygon(0% 0%, 100% 0%, 92% 100%, 8% 100%);
        }

        .botones-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin: 2px 0;
        }

        .boton {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%; /* C√çRCULO */
            border: none;
            background: linear-gradient(135deg, #dc3545, #c82333); /* Rojo por defecto */
            color: white;
            font-size: var(--icon-size);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            flex-shrink: 0;
        }

        .boton.activo {
            background: linear-gradient(135deg, #28a745, #1e7e34); /* Verde cuando est√° activo */
        }

        .boton:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .boton:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .boton.disabled {
            background: linear-gradient(135deg, #dc3545, #c82333);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .boton.disabled:hover {
            transform: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
        }

        /* Control individual del tama√±o de iconos */
        .icon-gps {
            font-size: var(--icon-size);
        }

        .icon-imagen {
            font-size: var(--icon-size);
        }

        .icon-video {
            font-size: var(--icon-size);
        }

        .status {
            margin: 2px 0;
            padding: 3px;
            background: white;
            border-radius: 5px;
            font-size: 10px;
            text-align: center;
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 90%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .gps-icon {
            width: 16px;
            height: 16px;
            margin-right: 5px;
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Media queries para m√≥viles */
        @media (max-width: 500px) {
            body {
                padding: 2px;
            }
            
            .container {
                width: 98vw;
                height: 100px;
            }
            
            .botones-row {
                gap: 8px;
                margin: 1px 0;
            }
        }

        /* Mantenemos algunos estilos originales para compatibilidad */
        body.controles-deshabilitados .container {
            pointer-events: none;
            opacity: 0.6;
        }

        /* Estilos para el cambio de modo - Simplificados */
        .modo-aventura #btn-gps.activo {
            background: #1abc9c !important; /* Color especial para modo aventura */
        }

        /* Estilos del Modal para imagen/video */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .modal-content {
            position: relative;
            background-color: #111;
            padding: 20px;
            border-radius: 5px;
            max-width: 90%;
            max-height: 90%;
            text-align: center;
        }
        .modal-close {
            position: absolute;
            top: -10px;
            right: -10px;
            color: #fff;
            background-color: #e74c3c;
            font-size: 25px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            line-height: 35px;
            text-align: center;
        }
        .modal-title {
            color: white;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        .media-container img, .media-container video {
            max-width: 100%;
            max-height: 70vh;
            border: 2px solid #fff;
        }
    </style>
</head>
<body class="modo-casa">
    <div class="container">
        <div class="botones-row">
            <button id="btn-gps" class="boton disabled">
                <span class="icon-gps">üõ∞Ô∏è</span>
            </button>
            <button id="btn-imagen" class="boton disabled">
                <span class="icon-imagen">üì∏</span>
            </button>
            <button id="btn-video" class="boton disabled">
                <span class="icon-video">üìΩÔ∏è</span>
            </button>
        </div>
        <div class="status" id="status">Esperando activaci√≥n...</div>
    </div>

    <div id="modal-medios" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h3 id="modal-title" class="modal-title"></h3>
            <div class="media-container"></div>
        </div>
    </div>

    <script type="module">
        // =================================================================================
        // 1. IMPORTACIONES Y CONFIGURACI√ìN
        // =================================================================================
        import { inicializarMensajeria, registrarControlador, enviarMensaje } from './js/mensajeria.js';
        import { TIPOS_MENSAJE } from './js/constants.js';
        import logger from './js/logger.js';

        const IFRAME_ID = 'hijo2';
        // ================== COORDENADAS DE LAS PARADAS ==================
       
        const COORDENADAS_PARADAS = [
    {
        id: 'P-0',
        tipo: "inicio",
        parada: 0, // ‚Üê Parada 0 ‚Äì INICIO (223, 226, 228, 229) reto 2 //
        nombre: "Torres de Serranos (start)",
        coordenadas: { lat: 39.47876, lng: -0.37626 },
        imagen: 'fotos_Av1/00_torres_de_serranos_back.jpg',
        video: 'videos/parada_0.mp4',
    },
    {
        id: 'TR-1',
        tipo: "tramo",
        tramo: 1, // ‚Üê tramo 1 (Torres de Serranos ‚Üí Plaza de la crida) (2, 126,) //
        nombre: "Torres de Serranos ‚Üí Plaza de la crida (Puente de Serranos)",
        inicio: { lat: 39.47876, lng: -0.37626 },
        waypoints: [
            { lat: 39.47905, lng: -0.37613 },
            { lat: 39.47933, lng: -0.37647 },
            { lat: 39.47943, lng: -0.37636 }
        ],
        fin: { lat: 39.47959, lng: -0.37583 },
        imagen: 'fotos_Av1/01_torres_de_serranos_front.jpg',
        video: 'videos/tramo_1.mp4',
    },
    {
        id: 'P-1',
        tipo: "parada",
        parada: 1, // ‚Üê Parada 1 - Plaza de la crida (Puente de Serranos) (233) Reto 3 //
        nombre: "Plaza de la crida (Puente de Serranos)",
        coordenadas: { lat: 39.47959, lng: -0.37583 },
        imagen: 'fotos_Av1/01_torres_de_serranos_front.jpg',
    },
    {
        id: 'TR-2',
        tipo: "tramo",
        tramo: 2, // ‚Üê tramo 2 (Plaza de la crida ‚Üí Calle Muro de Santa Ana) (81) //
        nombre: "Plaza de la crida ‚Üí Calle Muro de Santa Ana",
        inicio: { lat: 39.47959, lng: -0.37583 },
        waypoints: [
            { lat: 39.47939, lng: -0.3752 },
            { lat: 39.47902, lng: -0.37465 },
            { lat: 39.47866, lng: -0.3747 }
        ],
        fin: { lat: 39.47866, lng: -0.3747 },
        imagen: 'muro de Santa ana.jpg',
        video: 'videos/tramo 2_2.mp4',
    },
    {
        id: 'P-2',
        tipo: "parada",
        parada: 2, // ‚Üê Parada 2 (Calle Muro de Santa Ana) (68) Reto 4 //
        nombre: "Calle Muro de Santa Ana",
        coordenadas: { lat: 39.47866, lng: -0.3747 },
        imagen: 'muro de Santa ana.jpg',
    },
    {
        id: 'TR-3',
        tipo: "tramo",
        tramo: 3, // ‚Üê tramo 3 (Calle Muro de Santa Ana ‚Üí Palacio de los Borgia) (52) //
        nombre: "Calle Muro de Santa Ana ‚Üí Palacio de los Borgia",
        inicio: { lat: 39.47866, lng: -0.3747 },
        waypoints: [],
        fin: { lat: 39.47768, lng: -0.3749 },
        imagen: 'fotos_Av1/02_cortes_valencianas.jpg',
        video: 'videos/tramo_3.mp4',
    },
    {
        id: 'P-3',
        tipo: "parada",
        parada: 3, // ‚Üê Parada 3 (Iglesia de San Lorenzo) (686, 682-B, 462, 683, 684) Reto 5 //
        nombre: "Iglesia de San Lorenzo",
        coordenadas: { lat: 39.47768, lng: -0.3749 },
        imagen: 'fotos_Av1/03_iglesia_de_san_lorenzo.jpg',
    },
    {
        id: 'TR-4',
        tipo: "tramo",
        tramo: 4, // ‚Üê tramo 4 (Iglesia de San Lorenzo ‚Üí Plaza de la Virgen) (465-B) //
        nombre: "Iglesia de San Lorenzo ‚Üí Plaza de la Virgen",
        inicio: { lat: 39.47768, lng: -0.3749 },
        waypoints: [],
        fin: { lat: 39.47656, lng: -0.37529 },
        imagen: 'fotos_Av1/04_plaza_de_la_virgen.jpg',
        video: 'videos/tramo_4.mp4',
    },
    {
        id: 'P-4',
        tipo: "parada",
        parada: 4, // ‚Üê Parada 4 (Plaza de la Virgen) (466, 467) Reto 6 //
        nombre: "Plaza de la Virgen Reto 6",
        coordenadas: { lat: 39.47656, lng: -0.37529 },
        imagen: 'fotos_Av1/04_plaza_de_la_virgen.jpg',
    },
    {
        id: 'P-5',
        tipo: "parada",
        parada: 5, // ‚Üê Parada 5 (Plaza de la Virgen) (468) Reto 7, 8 Puzzle plaza de la virgen //
        nombre: "Plaza de la Virgen Reto 7",
        coordenadas: { lat: 39.47656, lng: -0.37529 },
        imagen: 'fotos_Av1/04_plaza_de_la_virgen.jpg',
    },
    {
        id: 'TR-5',
        tipo: "tramo",
        tramo: 5, // ‚Üê tramo 5 (Plaza de la Virgen ‚Üí Plaza de la Almo√≠na) (477-B, 479, 141, 83, 8-C) //
        nombre: "Plaza de la Virgen ‚Üí Plaza de la Almo√≠na",
        inicio: { lat: 39.47656, lng: -0.37529 },
        waypoints: [
            { lat: 39.4766, lng: -0.37473 },
            { lat: 39.47656, lng: -0.37453 },
            { lat: 39.47606, lng: -0.3746 }
        ],
        fin: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/05_plaza_de_la_almoina.jpg',
        video: 'videos/tramo_5.mp4',
    },
    {
        id: 'P-6',
        tipo: "parada",
        parada: 6, // ‚Üê Parada 6 (Panel cer√°mico muro Catedral) (434, 440, 441, 442) Reto 9 //
        nombre: "Panel cer√°mico muro Catedral",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/06_panel_ceramico_muro_norte_catedral.jpg',
    },
    {
        id: 'P-7',
        tipo: "parada",
        parada: 7, // ‚Üê Parada 7 (Capilla exterior catedral) (443, 444, 445) Reto 10 //
        nombre: "Capilla exterior catedral Reto 10",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/07!!!_capilla_exterior_catedral.jpg',
    },
    {
        id: 'P-8',
        tipo: "parada",
        parada: 8, // ‚Üê Parada 8 (Capilla exterior catedral) (445) Reto 11 //
        nombre: "Capilla exterior catedral Reto 11",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/07!!!_capilla_exterior_catedral.jpg',
    },
    {
        id: 'P-9',
        tipo: "parada",
        parada: 9, // ‚Üê Parada 9 (Arco Novo Catedral y Puerta Negra Bas√≠lica) (446, 355, 447, 11-B, 451, 452) //
        nombre: "Arco Novo Catedral y Puerta Negra Bas√≠lica",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/08_arco_novo_catedral.jpg',
        imagen2: 'fotos_Av1/09_puerta_negra_relieve_basilica.jpg',
    },
    // PARADA 10
    {
        id: 'P-10',
        tipo: "parada",
        parada: 10,
        nombre: "Casa del Punt de Gantxo",
        coordenadas: { lat: 39.47604, lng: -0.37451 },
        imagen: 'fotos_Av1/10_casa_del_punt_de_gantxo.jpg',
    },
    {
        id: 'TR-6',
        tipo: "tramo",
        tramo: 6, // ‚Üê tramo 6 (Plaza de la Almo√≠na ‚Üí Plaza Decimo Junio Bruto) (457, 10-B) //
        nombre: "Plaza de la Almo√≠na ‚Üí Plaza Decimo Junio Bruto (Museo Arqueol√≥gico de la Almo√≠na)",
        inicio: { lat: 39.47594, lng: -0.37474 },
        waypoints: [],
        fin: { lat: 39.4762, lng: -0.37412 },
        imagen: 'fotos_Av1/05_plaza_de_la_almoina.jpg',
        video: 'videos/tramo_6.mp4',
    },
    {
        id: 'P-11',
        tipo: "parada",
        parada: 11, // ‚Üê Parada 11 (Museo arqueol√≥gico La Almo√≠na) (458) Reto 13 //
        nombre: "Museo arqueol√≥gico La Almo√≠na",
        coordenadas: { lat: 39.4762, lng: -0.37412 },
        imagen: 'fotos_Av1/27_museo_la_almoina.jpg',
    },
    {
        id: 'P-12',
        tipo: "parada",
        parada: 12, // ‚Üê Parada 12 (Museo arqueol√≥gico La Almo√≠na) (459, 460, 461) //
        nombre: "Museo arqueol√≥gico La Almo√≠na",
        coordenadas: { lat: 39.4762, lng: -0.37412 },
        imagen: 'fotos_Av1/27_museo_la_almoina.jpg',
    },
    {
        id: 'P-13',
        tipo: "parada",
        parada: 13, // ‚Üê Parada 13 (Vista de la Catedral, Cimborrio) (8-C, 464) Reto14 //
        nombre: "Vista de la Catedral, Cimborrio",
        coordenadas: { lat: 39.4762, lng: -0.37412 },
        imagen: 'fotos_Av1/05_plaza_de_la_almoina.jpg',
    },
    {
        id: 'TR-7',
        tipo: "tramo",
        tramo: 7, // ‚Üê tramo 7 (Museo arqueol√≥gico La Almo√≠na ‚Üí Palacio Arzobispal) (85) //
        nombre: "Museo arqueol√≥gico La Almo√≠na ‚Üí Palacio Arzobispal",
        inicio: { lat: 39.47611, lng: -0.37478 },
        waypoints: [
            { lat: 39.47604, lng: -0.37442 },
            { lat: 39.47584, lng: -0.37443 },
            { lat: 39.47561, lng: -0.37451 }
        ],
        fin: { lat: 39.4755, lng: -0.37436 },
        imagen: 'fotos_Av1/11_palacio_arzobispal.jpg',
        video: 'videos/parada_8.mp4',
    },
    {
        id: 'P-14',
        tipo: "parada",
        parada: 14, // ‚Üê Parada 14 (Palacio Arzobispal y Puerta Rom√°nica de la Catedral) (673, 86, 426-B, 141, 437, 438) Reto 15 //
        nombre: "Palacio Arzobispal y Puerta Rom√°nica de la Catedral",
        coordenadas: { lat: 39.4755, lng: -0.37436 },
        imagen: 'fotos_Av1/12_puerta_romanica_catedral.jpg',
    },
    {
        id: 'P-15',
        tipo: "parada",
        parada: 15, // ‚Üê Parada 15 (Puerta Rom√°nica de la Catedral) (439) //
        nombre: "Puerta Rom√°nica de la Catedral",
        coordenadas: { lat: 39.47561, lng: -0.37465 },
        imagen: 'fotos_Av1/12_puerta_romanica_catedral.jpg',
    },
    {
        id: 'TR-8',
        tipo: "tramo",
        tramo: 8, // ‚Üê tramo 8 (Puerta Rom√°nica de la Catedral ‚Üí Plaza del Ayuntamiento) (125) //
        nombre: "Puerta Rom√°nica de la Catedral ‚Üí Plaza del Ayuntamiento",
        inicio: { lat: 39.47561, lng: -0.37465 },
        waypoints: [
            { lat: 39.4756, lng: -0.37466 },
            { lat: 39.47514, lng: -0.37494 },
            { lat: 39.47447, lng: -0.3754 },
            { lat: 39.47378, lng: -0.3756 },
            { lat: 39.47212, lng: -0.37676 }
        ],
        fin: { lat: 39.47056, lng: -0.37677 },
        imagen: 'fotos_Av1/13_plaza_del_ayuntamiento.jpg',
        video: 'videos/tramo_8.mp4',
    },
    {
        id: 'P-16',
        tipo: "parada",
        parada: 16, // ‚Üê Parada 16 (Plaza del Ayuntamiento) (13-B, 263, 332, 14-C) //
        nombre: "Plaza del Ayuntamiento",
        coordenadas: { lat: 39.47056, lng: -0.37677 },
        imagen: 'fotos_Av1/13_plaza_del_ayuntamiento.jpg',
    },
    {
        id: 'TR-9',
        tipo: "tramo",
        tramo: 9, // ‚Üê tramo 9 (Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento) (334, 335) //
        nombre: "Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento de Val√®ncia",
        inicio: { lat: 39.47056, lng: -0.37677 },
        waypoints: [],
        fin: { lat: 39.46971, lng: -0.37693 },
        imagen: 'fotos_Av1/14_ayuntamiento.jpg',
        video: 'videos/tramo_9.mp4',
    },
    {
        id: 'P-17',
        tipo: "parada",
        parada: 17, // ‚Üê Parada 17 (Edificio del Ayuntamiento) (336, 337, 338) Reto 16 //
        nombre: "Edificio del Ayuntamiento",
        coordenadas: { lat: 39.46971, lng: -0.37693 },
        imagen: 'fotos_Av1/14_ayuntamiento.jpg',
    },
    {
        id: 'P-18',
        tipo: "parada",
        parada: 18, // ‚Üê Parada 18 (Edificio del Ayuntamiento) (339, 340, 341, 54) //
        nombre: "Edificio del Ayuntamiento",
        coordenadas: { lat: 39.46971, lng: -0.37693 },
        imagen: 'fotos_Av1/14_ayuntamiento.jpg',
    },
    {
        id: 'TR-10',
        tipo: "tramo",
        tramo: 10, // ‚Üê tramo 10 (Edificio del Ayuntamiento ‚Üí Estaci√≥n del Norte) (87, 15-C) //
        nombre: "Edificio del Ayuntamiento ‚Üí Estaci√≥n del Norte",
        inicio: { lat: 39.46971, lng: -0.37693 },
        waypoints: [
            { lat: 39.46795, lng: -0.37701 }
        ],
        fin: { lat: 39.46722, lng: -0.37702 },
        imagen: 'fotos_Av1/15_plaza_de_toros_y_estacion_del_norte.jpg',
        video: 'videos/tramo_10.mp4',
    },
    {
        id: 'P-19',
        tipo: "parada",
        parada: 19, // ‚Üê Parada 19 (Estaci√≥n del Norte) (326) Reto 17, 18 Puzzle Estaci√≥n del Norte//
        nombre: "Estaci√≥n del Norte",
        coordenadas: { lat: 39.46722, lng: -0.37702 },
        imagen: 'fotos_Av1/15_plaza_de_toros_y_estacion_del_norte.jpg',
    },
    {
        id: 'TR-11',
        tipo: "tramo",
        tramo: 11, // ‚Üê tramo 11 (Estaci√≥n del Norte ‚Üí Plaza de Toros) (20-C, 323-B, 88) //
        nombre: "Estaci√≥n del Norte ‚Üí Plaza de Toros de Val√®ncia",
        inicio: { lat: 39.46722, lng: -0.37702 },
        waypoints: [],
        fin: { lat: 39.46709, lng: -0.37595 },
        imagen: 'fotos_Av1/15_plaza_de_toros_y_estacion_del_norte.jpg',
        video: 'videos/tramo_11.mp4',
    },
    {
        id: 'TR-12',
        tipo: "tramo",
        tramo: 12, // ‚Üê Tramo 12 (Plaza de Toros ‚Üí Casa estilo √Årabe) (89, 3-D) //
        nombre: "Plaza de Toros ‚Üí Casa estilo √Årabe",
        inicio: { lat: 39.46709, lng: -0.37595 },
        waypoints: [
            { lat: 39.46714, lng: -0.37498 }
        ],
        fin: { lat: 39.46753, lng: -0.37511 },
        imagen: 'fotos_Av1/16!!!!_casa_estilo_arabe.jpg',
        video: 'videos/parada_13.mp4',
    },
    {
        id: 'P-20',
        tipo: "parada",
        parada: 20, // ‚Üê Parada 20 (Casa estilo √Årabe) (99) Reto 19 //
        nombre: "Casa estilo √Årabe",
        coordenadas: { lat: 39.46753, lng: -0.37511 },
        imagen: 'fotos_Av1/16!!!!_casa_estilo_arabe.jpg',
    },
    {
        id: 'P-21',
        tipo: "parada",
        parada: 21, // ‚Üê Parada 21 (Casa estilo √Årabe, mitad Aventura) (100) //
        nombre: "Casa estilo √Årabe, mitad Aventura",
        coordenadas: { lat: 39.46753, lng: -0.37511 },
        imagen: 'fotos_Av1/16!!!!_casa_estilo_arabe.jpg',
    },
    {
        id: 'TR-13',
        tipo: "tramo",
        tramo: 13, // ‚Üê tramo 13 (Casa estilo √Årabe ‚Üí Palacio de Comunicaciones) (21-B) //
        nombre: "Casa estilo √Årabe ‚Üí Palacio de Comunicaciones (Correos)",
        inicio: { lat: 39.46753, lng: -0.37511 },
        waypoints: [],
        fin: { lat: 39.46942, lng: -0.37559 },
        imagen: 'fotos_Av1/17_correos.jpg',
        video: 'videos/tramo_13.mp4',
    },
    {
        id: 'P-22',
        tipo: "parada",
        parada: 22, // ‚Üê Parada 22 (Palacio de Comunicaciones) (21-C) //
        nombre: "Palacio de Comunicaciones: Correos",
        coordenadas: { lat: 39.46942, lng: -0.37559 },
        imagen: 'fotos_Av1/17_correos.jpg',
    },
    {
        id: 'P-23',
        tipo: "parada",
        parada: 23, // ‚Üê Parada 23 (Edificio Suay) (22-C) //
        nombre: "Edificio Suay",
        coordenadas: { lat: 39.46942, lng: -0.37559 },
        imagen: 'fotos_Av1/18_edificio_suay.jpg',
    },
    {
        id: 'TR-14',
        tipo: "tramo",
        tramo: 14, // ‚Üê tramo 14 (Palacio de Comunicaciones ‚Üí Banco de Val√®ncia) (90) //
        nombre: "Palacio de Comunicaciones ‚Üí Banco de Val√®ncia",
        inicio: { lat: 39.46942, lng: -0.37559 },
        waypoints: [
            { lat: 39.4699, lng: -0.37573 },
            { lat: 39.4703, lng: -0.3759 },
            { lat: 39.47039, lng: -0.37505 },
            { lat: 39.47043, lng: -0.37427 }
        ],
        fin: { lat: 39.47061, lng: -0.37408 },
        imagen: 'fotos_Av1/19_banco_de_valencia.jpg',
        video: 'videos/tramo_14.mp4',
    },
    {
        id: 'P-24',
        tipo: "parada",
        parada: 24, // ‚Üê Parada 24 (Banco de Valencia) (23-C) //
        nombre: "Banco de Valencia",
        coordenadas: { lat: 39.47061, lng: -0.37408 },
        imagen: 'fotos_Av1/19_banco_de_valencia.jpg',
    },
    {
        id: 'TR-15',
        tipo: "tramo",
        tramo: 15, // ‚Üê tramo 15 (Banco de Val√®ncia ‚Üí Palacio del Marqu√©s de Dos Aguas) (91) //
        nombre: "Banco de Val√®ncia ‚Üí Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica)",
        inicio: { lat: 39.47061, lng: -0.37408 },
        waypoints: [
            { lat: 39.47119, lng: -0.37423 },
            { lat: 39.47214, lng: -0.37446 },
            { lat: 39.47275, lng: -0.37445 }
        ],
        fin: { lat: 39.47276, lng: -0.37467 },
        imagen: 'fotos_Av1/20!!!!_ marques_de_dos aguas.jpg',
        video: 'videos/parada_16.mp4',
    },
    {
        id: 'P-25',
        tipo: "parada",
        parada: 25, // ‚Üê Parada 25 (Palacio del Marqu√©s de Dos Aguas) (24-C, 25-C, 26-C, 27-C, 28-C, 29-C, 30-C, 31-C, 32-C, 33-C, 34-C, 35-C) //
        nombre: "Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica)",
        coordenadas: { lat: 39.47276, lng: -0.37467 },
        imagen: 'fotos_Av1/20!!!!_ marques_de_dos aguas.jpg',
    },
    {
        id: 'TR-16',
        tipo: "tramo",
        tramo: 16, // ‚Üê tramo 16 (Palacio del Marqu√©s ‚Üí Mercado Central) (92, 93) //
        nombre: "Palacio del Marqu√©s ‚Üí Mercado Central",
        inicio: { lat: 39.47276, lng: -0.37467 },
        waypoints: [
            { lat: 39.47315, lng: -0.37608 },
            { lat: 39.47261, lng: -0.37654 },
            { lat: 39.47225, lng: -0.37686 },
            { lat: 39.47265, lng: -0.37725 }
        ],
        fin: { lat: 39.47377, lng: -0.37832 },
        imagen: 'fotos_Av1/21_mercado_central.jpg',
        video: 'videos/tramo_16.mp4',
    },
    {
        id: 'P-26',
        tipo: "parada",
        parada: 26, // ‚Üê Parada 26 (Mercado central) (36-C, 37-C, 38-C, 39-C, 40-C, 41-C, 42-C, 43-C) //
        nombre: "Mercado central",
        coordenadas: { lat: 39.47377, lng: -0.37832 },
        imagen: 'fotos_Av1/21_mercado_central.jpg',
    },
    {
        id: 'TR-17',
        tipo: "tramo",
        tramo: 17, // ‚Üê tramo 17 (Mercado Central ‚Üí Iglesia de los Santos Juanes) (94) //
        nombre: "Mercado Central ‚Üí Iglesia de los Santos Juanes",
        inicio: { lat: 39.47377, lng: -0.37832 },
        waypoints: [],
        fin: { lat: 39.47425, lng: -0.37895 },
        imagen: 'fotos_Av1/22_iglesia_san_juan_del_mercado.jpg',
        video: 'videos/tramo_17.mp4',
    },
    {
        id: 'P-27',
        tipo: "parada",
        parada: 27, // ‚Üê Parada 27 (Iglesia de los Santos Juanes) (44-C, 45-C, 46-C, 47-C, 48-C, 49-C, 50-C, 51-C, 52-C, 53-C, 54-C, 55-C, 56-C, 57-C, 58-C) //
        nombre: "Iglesia de los Santos Juanes reto 24",
        coordenadas: { lat: 39.47425, lng: -0.37895 },
        imagen: 'fotos_Av1/22_iglesia_san_juan_del_mercado.jpg',
    },
    {
        id: 'P-28',
        tipo: "parada",
        parada: 28, // ‚Üê Parada 28 (Iglesia de los Santos Juanes) (59-C) Reto 25 //
        nombre: "Iglesia de los Santos Juanes reto 25",
        coordenadas: { lat: 39.47425, lng: -0.37895 },
        imagen: 'fotos_Av1/22_iglesia_san_juan_del_mercado.jpg',
    },
    {
        id: 'TR-18',
        tipo: "tramo",
        tramo: 18, // ‚Üê tramo 18 (Iglesia Santos Juanes ‚Üí Lonja de Val√®ncia) (95) //
        nombre: "Iglesia Santos Juanes ‚Üí Lonja de Val√®ncia (Mercado de la Seda)",
        inicio: { lat: 39.47425, lng: -0.37895 },
        waypoints: [],
        fin: { lat: 39.47426, lng: -0.37862 },
        imagen: 'fotos_Av1/23_lonja.jpg',
        video: 'videos/parada_19.mp4',
    },
    {
        id: 'P-29',
        tipo: "parada",
        parada: 29, // ‚Üê Parada 29 (Lonja Puerta de Los Pecados barquero) (60-C) //
        nombre: "Lonja Puerta de Los Pecados barquero",
        coordenadas: { lat: 39.4742, lng: -0.37851 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        id: 'P-30',
        tipo: "parada",
        parada: 30, // ‚Üê Parada 30 (Lonja Puerta de Los Pecados √°rbol muerto) (60-C) //
        nombre: "Lonja Puerta de Los Pecados √°rbol muerto",
        coordenadas: { lat: 39.4742, lng: -0.37851 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        id: 'TR-19',
        tipo: "tramo",
        tramo: 19, // ‚Üê tramo 19 (Lonja G√°rgolas) (96) //
        nombre: "Lonja G√°rgolas",
        inicio: { lat: 39.4742, lng: -0.37851 },
        waypoints: [],
        fin: { lat: 39.4742, lng: -0.37881 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        id: 'P-31',
        tipo: "parada",
        parada: 31, // ‚Üê Parada 31 (Lonja G√°rgolas √°ngel vasija) (61-C) //
        nombre: "Lonja G√°rgolas √°ngel vasija",
        coordenadas: { lat: 39.4742, lng: -0.37881 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        id: 'P-32',
        tipo: "parada",
        parada: 32, // ‚Üê Parada 32 (Lonja G√°rgolas barbudo y le√≥n) (61-C) //
        nombre: "Lonja G√°rgolas barbudo y le√≥n",
        coordenadas: { lat: 39.4742, lng: -0.37881 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        id: 'P-33',
        tipo: "parada",
        parada: 33, // ‚Üê Parada 33 (Lonja G√°rgolas fornicador ventana) (61-C) //
        nombre: "Lonja G√°rgolas fornicador ventana",
        coordenadas: { lat: 39.47439, lng: -0.37887 },
        imagen: 'fotos_Av1/23_lonja.jpg',
    },
    {
        id: 'TR-20',
        tipo: "tramo",
        tramo: 20, // ‚Üê tramo 20 (Lonja ‚Üí Plaza del Doctor Collado) (97) //
        nombre: "Lonja ‚Üí Plaza del Doctor Collado",
        inicio: { lat: 39.47426, lng: -0.37862 },
        waypoints: [
            { lat: 39.47445, lng: -0.37889 },
            { lat: 39.47459, lng: -0.37868 },
            { lat: 39.47475, lng: -0.37842 },
            { lat: 39.47436, lng: -0.37799 }
        ],
        fin: { lat: 39.47444, lng: -0.3779 },
        imagen: 'fotos_Av1/24_lonja2.jpg',
        video: 'videos/tramo_20.mp4',
    },
    {
        id: 'TR-21',
        tipo: "tramo",
        tramo: 21, // ‚Üê tramo 21 (Plaza del Doctor Collado ‚Üí Plaza del Negrito) (333, 397, 41, 398, 198, 671, 522, 32-C) //
        nombre: "Plaza del Doctor Collado ‚Üí Plaza del Negrito (Fuente del Negrito)",
        inicio: { lat: 39.47444, lng: -0.3779 },
        waypoints: [
            { lat: 39.47473, lng: -0.37763 },
            { lat: 39.47493, lng: -0.37761 },
            { lat: 39.47559, lng: -0.37772 }
        ],
        fin: { lat: 39.47611, lng: -0.37741 },
        imagen: 'fotos_Av1/25_fuente_del_negrito.jpg',
        video: 'videos/parada_21.mp4',
    },
    {
        id: 'P-34',
        tipo: "parada",
        parada: 34, // ‚Üê Parada 34 (Fuente del Negrito) (382, 501) Reto 32 //
        nombre: "Fuente del Negrito",
        coordenadas: { lat: 39.47611, lng: -0.37741 },
        imagen: 'fotos_Av1/25_fuente_del_negrito.jpg',
    },
    {
        id: 'TR-22',
        tipo: "tramo",
        tramo: 22, // ‚Üê tramo 22 (Plaza del Negrito ‚Üí Calle Caballeros) (33-B, 486, 480-B) //
        nombre: "Plaza del Negrito ‚Üí Calle Caballeros",
        inicio: { lat: 39.47611, lng: -0.37741 },
        waypoints: [
            { lat: 39.47663, lng: -0.3773 },
            { lat: 39.47661, lng: -0.37685 }
        ],
        fin: { lat: 39.47668, lng: -0.37671 },
        imagen: 'fotos_Av1/26_palau_de_la_generalitat.jpg',
        video: 'videos/parada_22.mp4',
    },
    {
        id: 'P-35',
        tipo: "parada",
        parada: 35, // ‚Üê Parada 35 (Palau de la Generalitat) (481-B, 482-B, 2-D) //
        nombre: "Palau de la Generalitat",
        coordenadas: { lat: 39.47668, lng: -0.37671 },
        imagen: 'fotos_Av1/26_palau_de_la_generalitat.jpg',
    },
    {
        id: 'TR-23',
        tipo: "tramo",
        tramo: 23, // ‚Üê tramo 23 (Palacio de la Generalitat ‚Üí Calle de los Serranos - FINAL) //
        nombre: "Palacio de la Generalitat ‚Üí Calle de los Serranos (FINAL)",
        inicio: { lat: 39.47668, lng: -0.37671 },
        waypoints: [
            { lat: 39.47661, lng: -0.37685 },
            { lat: 39.47687, lng: -0.37686 }
        ],
        fin: { lat: 39.47773, lng: -0.37671 },
        imagen: 'fotos_Av1/00_torres_de_serranos_back.jpg',
        video: 'videos/parada_24.mp4',
    },
    {
        id: 'P-36',
        tipo: "parada",
        parada: 36, // ‚Üê Parada 36 (Torres de Serranos Final) (audio despedida) //
        nombre: "Torres de Serranos Final",
        coordenadas: { lat: 39.47773, lng: -0.37671 },
        imagen: 'fotos_Av1/00_torres_de_serranos_back.jpg',
    }
];

        // =================================================================================
        // 2. ESTADO DEL COMPONENTE
        // =================================================================================
        const estadoComponente = {
            puntoActual: null,
            controlesHabilitados: true,
            elementosDOM: {},
            // Estado del modo
            modoCasa: false
        };

        // =================================================================================
        // 3. L√ìGICA DE LA INTERFAZ
        // =================================================================================
        function actualizarInterfaz() {
            const { puntoActual } = estadoComponente;
            const { btnGps, btnImagen, btnVideo } = estadoComponente.elementosDOM;

            document.body.classList.toggle('controles-deshabilitados', !estadoComponente.controlesHabilitados);
            document.body.classList.toggle('modo-casa', estadoComponente.modoCasa);
            document.body.classList.toggle('modo-aventura', !estadoComponente.modoCasa);

            if (!puntoActual) {
                // Deshabilitar todos los botones si no hay punto actual
                desactivarTodosLosBottones();
                return;
            }

            // Habilitar/deshabilitar botones de media
            if (estadoComponente.modoCasa) {
                // En modo casa, solo activar imagen y video
                activarBoton(btnImagen);
                activarBoton(btnVideo);
                desactivarBoton(btnGps);
            } else {
                // En modo aventura, activar seg√∫n la disponibilidad de media
                btnGps.classList.toggle('disabled', false);
                activarBoton(btnGps);
                btnImagen.classList.toggle('disabled', !puntoActual.imagen);
                btnVideo.classList.toggle('disabled', !puntoActual.video);
            }
        }

        function activarBoton(boton) {
            boton.classList.remove('disabled');
            boton.classList.add('activo');
        }

        function desactivarBoton(boton) {
            boton.classList.add('disabled');
            boton.classList.remove('activo');
        }

        function desactivarTodosLosBottones() {
            Object.values(estadoComponente.elementosDOM).forEach(btn => {
                if (btn && btn.classList) desactivarBoton(btn);
            });
        }

        function mostrarMedio(tipo) {
            if (!estadoComponente.puntoActual) return;
            
            const src = (tipo === 'imagen') ? estadoComponente.puntoActual.imagen : estadoComponente.puntoActual.video;
            if (src) {
                enviarMensaje('padre', TIPOS_MENSAJE.UI.MODAL, {
                    tipo,
                    src,
                    titulo: estadoComponente.puntoActual.nombre
                });
            }
        }

        function actualizarStatus(mensaje, cargando = false) {
            const status = document.getElementById('status');
            if (status) {
                status.textContent = mensaje;
                status.classList.toggle('loading', cargando);
                status.style.display = mensaje ? 'flex' : 'none';
            }
        }
        
        // =================================================================================
        // 4. MANEJADORES DE EVENTOS Y MENSAJES
        // =================================================================================
        function manejarClickGps() {
            if (estadoComponente.modoCasa) {
                actualizarStatus('GPS desactivado en modo casa');
                return;
            }
            
            enviarMensaje('padre', TIPOS_MENSAJE.NAVEGACION.SOLICITAR_DESTINO, { accion: 'siguiente' });
        }

        function manejarCambioModo(mensaje) {
            const modo = mensaje.datos.modo;
            estadoComponente.modoCasa = modo === 'casa';
            actualizarInterfaz();
        }

        function manejarCambioParada(mensaje) {
            estadoComponente.puntoActual = mensaje.datos.punto;
            actualizarInterfaz();
        }

        // Exponer COORDENADAS_PARADAS al objeto window para que otros componentes puedan acceder a ellas
        window.COORDENADAS_PARADAS = COORDENADAS_PARADAS;
        
        // Tambi√©n crear una versi√≥n simplificada sin coordenadas, im√°genes ni videos
        window.puntosRuta = COORDENADAS_PARADAS.map(p => {
            return {
                id: p.id,
                tipo: p.tipo,
                parada: p.parada,
                tramo: p.tramo,
                nombre: p.nombre
            };
        });
        
        // Manejar solicitudes de paradas de otros componentes
        function manejarSolicitudParadas(mensaje) {
            logger.info('Recibida solicitud de paradas desde:', mensaje.origen || 'desconocido');
            
            // Responder con las paradas en formato simplificado
            return {
                paradas: window.puntosRuta,
                timestamp: new Date().toISOString(),
                total: window.puntosRuta.length
            };
        }

        // =================================================================================
        // 5. INICIALIZACI√ìN
        // =================================================================================
        async function inicializar() {
            logger.configure({ iframeId: IFRAME_ID, debug: true });
            await inicializarMensajeria({ iframeId: IFRAME_ID });

            estadoComponente.elementosDOM = {
                btnGps: document.getElementById('btn-gps'),
                btnImagen: document.getElementById('btn-imagen'),
                btnVideo: document.getElementById('btn-video')
            };

            // Configurar eventos de botones
            estadoComponente.elementosDOM.btnGps.addEventListener('click', manejarClickGps);
            estadoComponente.elementosDOM.btnImagen.addEventListener('click', () => mostrarMedio('imagen'));
            estadoComponente.elementosDOM.btnVideo.addEventListener('click', () => mostrarMedio('video'));

            // Registrar manejadores de mensajes
            registrarControlador(TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, manejarCambioModo);
            registrarControlador(TIPOS_MENSAJE.NAVEGACION.CAMBIO_PARADA, manejarCambioParada);
            registrarControlador(TIPOS_MENSAJE.DATOS.SOLICITAR_PARADAS, manejarSolicitudParadas);

            // Notificar al padre que estamos listos
            await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.COMPONENTE_LISTO, { componente: IFRAME_ID });
            actualizarStatus('Listo para navegar');
            logger.info('Componente de coordenadas inicializado con nuevo dise√±o.');
        }

        inicializar().catch(error => {
            logger.error('Error fatal en inicializaci√≥n de coordenadas:', error);
            actualizarStatus('Error al inicializar componente');
        });
    </script>
</body>
</html>
