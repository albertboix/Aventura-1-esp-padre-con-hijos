<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPS Casa ON/OFF</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      background: transparent;
      font-family: sans-serif;
      user-select: none;
      overflow: visible;
      position: relative;
    }
    #contenedor-flex {
      display: flex;
      flex-direction: column;
      width: 100vw;
      height: 100vh;
      box-sizing: border-box;
    }
    /* Contenedor principal del botÃ³n y paradas */
    #zona-boton-casa {
      position: absolute;
      top: 0;
      right: 0;
      z-index: 10001;
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      justify-content: flex-end;
      pointer-events: auto;
      height: 40px; /* Aumenta la altura para el botÃ³n */
      box-sizing: border-box;
      background: transparent;
      padding: 0;
      margin: 0;
      width: 80%;
    }
    
    /* Estilos del botÃ³n casa */
    :root {
      --emoji-size: 35px;
      --label-size: 25px;
    }
    
    /* Estilos base del botÃ³n */
    #gps-casa-btn {
      /* TamaÃ±o y posiciÃ³n */
      width: 40px;
      height: 40px;
      min-width: 40px; /* Evita que el botÃ³n se encoja */
      min-height: 40px; /* Asegura una altura mÃ­nima */
      border-radius: 1px;
      border: 1px solid #fff;
      
      /* Colores */
      background-color: #f44336; /* Rojo por defecto (OFF) */
      color: white;
      
      /* Flexbox para centrar contenido */
      display: flex !important; /* Forzar display flex */
      align-items: center;
      justify-content: center;
      
      /* Efectos visuales */
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      
      /* Espaciado y posiciÃ³n */
      padding: 0;
      margin: 0 0 0 10px;
      position: relative;
      z-index: 10002;
      
      /* Interactividad */
      cursor: pointer;
      -webkit-tap-highlight-color: transparent; /* Elimina el resaltado en mÃ³viles */
      
      /* Asegurar que el botÃ³n estÃ© por encima de otros elementos */
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      
      /* Debug */
      /* border: 1px solid red; */
    }
    
    /* Estados del botÃ³n GPS */
    #gps-casa-btn.on {
      background-color: #4CAF50 !important; /* Verde cuando estÃ¡ activo (ON) */
      border: 1px solid #45a049 !important;
    }
    
    #gps-casa-btn.off {
      background-color: #f44336 !important; /* Rojo cuando estÃ¡ inactivo (OFF) */
      border: 1px solid #d32f2f !important;
    }
    
    /* Estilo base del botÃ³n */
    #gps-casa-btn {
      background-color: #f44336; /* Color por defecto (rojo) */
      border: 1px solid #d32f2f;
      color: white;
      padding: 8px 16px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s, border-color 0.3s;
    }
    
    /* Efecto hover para mejor feedback */
    #gps-casa-btn:hover {
      opacity: 0.9;
      transform: scale(1.05);
    }
    
    #gps-casa-btn:active {
      transform: scale(0.95);
    }
    
    .button-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      line-height: 1;
    }
    
    .satellite-emoji {
      font-size: var(--emoji-size);
      line-height: 1;
      margin-bottom: 2px;
      display: block;
    }
    
    #gps-casa-btn .gps-label {
      font-size: var(--label-size);
      font-weight: bold;
      line-height: 1;
      margin: 0;
      padding: 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Asegurar que el icono estÃ© correctamente posicionado */
    #gps-casa-btn i {
      font-size: 8px;
      line-height: 1;
      display: block;
    }
    
    /* Ventana de paradas */
    #paradas-window {
      position: relative;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      display: none;
      flex-direction: column;
      padding: 10px;
      margin-left: 10px;
      border: 1px solid #e0e0e0;
      max-width: 300px;
      min-width: 250px;
      z-index: 10003;
    }
    
    #paradas-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 5px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    #paradas-header button {
      background: none;
      border: none;
      cursor: pointer;
      color: #666;
      font-size: 16px;
    }
    
    #paradas-list {
      max-height: 200px;
      overflow-y: auto;
    }
    
    /* Estilo personalizado para la barra de desplazamiento */
    #paradas-window::-webkit-scrollbar {
      height: 4px;
    }
    
    #paradas-window::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 2px;
    }
    
    #paradas-window::-webkit-scrollbar-thumb {
      background-color: #aaa;
      border-radius: 4px;
    }
    
    /* Estilos para los botones de parada */
    .parada-btn, .tramo-btn {
      display: block;
      width: 100%;
      padding: 8px 12px;
      margin: 4px 0;
      border: none;
      border-radius: 4px;
      color: white;
      font-weight: bold;
      font-size: 14px;
      text-align: left;
      cursor: pointer;
      transition: background-color 0.2s;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .parada-btn {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
    }
    
    .tramo-btn {
      background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
    }
    
    .parada-btn.activa, .tramo-btn.activa {
      transform: scale(1.1);
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    
    .parada-btn:hover, .tramo-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    #paradas-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 15px;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }
    
    #paradas-list {
      display: flex;
      flex-direction: row; /* Asegura disposiciÃ³n en fila */
      flex-wrap: nowrap; /* Evita saltos de lÃ­nea */
      padding: 8px;
      overflow-x: auto; /* Scroll horizontal */
      overflow-y: hidden; /* Oculta scroll vertical */
      flex: 1;
      gap: 8px;
      align-items: center;
      white-space: nowrap; /* Evita saltos de lÃ­nea en el texto */
      -webkit-overflow-scrolling: touch; /* Mejora el scroll en dispositivos tÃ¡ctiles */
    }
    .parada-tramo-btn {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 4px 8px;
      margin: 0 3px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      flex: 0 0 auto; /* Evita que los botones se encojan */
      font-size: 12px;
      display: inline-flex; /* Mejor alineaciÃ³n en fila */
      align-items: center; /* Centra verticalmente el contenido */
      white-space: nowrap; /* Evita saltos de lÃ­nea en el texto */
      white-space: nowrap;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 70px;
      min-width: 140px;
      position: relative;
      overflow: hidden;
    }
    
    .parada-btn {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      border: none !important;
    }
    
    .tramo-btn {
      background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
      color: white;
      border: none !important;
    }
    
    .inicio-btn {
      background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
      color: white;
      border: none !important;
    }
    
    .parada-tramo-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    
    .parada-tramo-btn.actual {
      border: 2px solid #ffd700 !important;
      box-shadow: 0 0 0 2px #ffd700, 0 0 15px rgba(255, 215, 0, 0.7) !important;
      transform: scale(1.05);
      font-weight: bold;
      z-index: 2;
      position: relative;
    }
    
    .btn-icon {
      font-size: 1.5em;
      margin-bottom: 4px;
    }
    
    .btn-title {
      font-weight: 600;
      font-size: 0.95em;
      margin-bottom: 2px;
    }
    
    .btn-desc {
      font-size: 0.75em;
      opacity: 0.9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 130px;
    }
    .tramo-btn {
      background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
      color: white;
      border: none;
    }
    
    /* Ajustes para el botÃ³n de cerrar */
    #cerrar-paradas {
      position: absolute;
      top: 5px;
      right: 5px;
      z-index: 2;
      background: rgba(255,255,255,0.9);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .parada-btn:hover {
      background: linear-gradient(90deg, #0056b3 0%, #00aaff 100%); 
      color: #e0ffe0;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .tramo-btn:hover {
      background: linear-gradient(90deg, #7d3c98 0%, #8e44ad 100%);
      color: #f0f0f0;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .parada-btn.actual, .tramo-btn.actual {
      border: 2px solid #155724;
      box-shadow: 0 0 0 2px #28a745;
      z-index: 2;
    }
    .parada-btn.actual {
      background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
    }
    .tramo-btn.actual {
      background: linear-gradient(90deg, #9b59b6 0%, #8e44ad 100%);
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 0.75em;
      font-weight: bold;
      margin-right: 6px;
      min-width: 22px;
      text-align: center;
    }
    .badge-parada {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    .badge-tramo {
      background: rgba(255,255,255,0.3);
      color: white;
    }
    @media (max-width: 300px) {
      #gps-casa-btn { 
        width: 62px; 
        height: 62px; 
      }
      #zona-boton-casa { 
        height: 70px;
      }
      #paradas-window { 
        width: 40vw; 
      }
    }
  </style>
</head>
<body>
  <!-- Contenedor de controles -->
  <div id="zona-boton-casa">
    <!-- BotÃ³n GPS -->
    <button id="gps-casa-btn" class="on" title="Activar GPS">
      <div class="button-content">
        <span class="satellite-emoji">ðŸ“¡</span>
        <span class="gps-label">ON</span>
      </div>
    </button>
    
    <!-- Ventana de paradas (inicialmente oculta) -->
    <div id="paradas-window">
      <div id="paradas-header">
        <span id="estado-modo">Seleccionar parada</span>
        <button id="cerrar-paradas" title="Cerrar"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="paradas-list">
        <!-- Las paradas se cargarÃ¡n aquÃ­ dinÃ¡micamente -->
      </div>
    </div>
  </div>

  <script>
    // ================== ARRAY DE PARADAS Y TRAMOS ==================
    // Estructura unificada que combina paradas y tramos en orden secuencial
    const puntosRuta = [
      {
        tipo: "inicio",
        id: "P-0",
        parada: 0,
        nombre: "Torres de Serranos (start)",
      },
      {
        tipo: "tramo",
        id: "TR-1",
        tramo: 1,
        nombre: "Torres de Serranos â†’ Plaza de la crida (Puente de Serranos)",
      },
      {
        tipo: "parada",
        id: "P-1",
        parada: 1,
        nombre: "Plaza de la crida (Puente de Serranos)",
      },
      {
        tipo: "tramo",
        id: "TR-2",
        tramo: 2,
        nombre: "Plaza de la crida â†’ Calle Muro de Santa Ana",
      },
      {
        tipo: "parada",
        id: "P-2",
        parada: 2,
        nombre: "Calle Muro de Santa Ana",
      },
      {
        tipo: "tramo",
        id: "TR-3",
        tramo: 3,
        nombre: "Calle Muro de Santa Ana â†’ Palacio de los Borgia",
      },
      {
        tipo: "parada",
        id: "P-3",
        parada: 3,
        nombre: "Iglesia de San Lorenzo",
      },
      {
        tipo: "tramo",
        id: "TR-4",
        tramo: 4,
        nombre: "Iglesia de San Lorenzo â†’ Plaza de la Virgen",
      },
      {
        tipo: "parada",
        id: "P-4",
        parada: 4,
        nombre: "Plaza de la Virgen Reto 6",
      },
      {
        tipo: "parada",
        id: "P-5",
        parada: 5,
        nombre: "Plaza de la Virgen Reto 7",
      },
      {
        tipo: "tramo",
        id: "TR-5",
        tramo: 5,
        nombre: "Plaza de la Virgen â†’ Plaza de la AlmoÃ­na",
      },
      {
        tipo: "parada",
        id: "P-6",
        parada: 6,
        nombre: "Panel cerÃ¡mico muro Catedral",
      },
      {
        tipo: "parada",
        id: "P-7",
        parada: 7,
        nombre: "Capilla exterior catedral Reto 10",
      },
      {
        tipo: "parada",
        id: "P-8",
        parada: 8,
        nombre: "Capilla exterior catedral Reto 11",
      },
      {
        tipo: "parada",
        id: "P-9",
        parada: 9,
        nombre: "Arco Novo Catedral y Puerta Negra BasÃ­lica",
      },
      {
        tipo: "parada",
        id: "P-10",
        parada: 10,
        nombre: "Casa del Punt de Gantxo",
      },
      {
        tipo: "tramo",
        id: "TR-6",
        tramo: 6,
        nombre: "Plaza de la AlmoÃ­na â†’ Plaza Decimo Junio Bruto (Museo ArqueolÃ³gico de la AlmoÃ­na)",
      },
      {
        tipo: "parada",
        id: "P-11",
        parada: 11,
        nombre: "Museo arqueolÃ³gico La AlmoÃ­na",
      },
      {
        tipo: "parada",
        id: "P-12",
        parada: 12,
        nombre: "Museo arqueolÃ³gico La AlmoÃ­na",
      },
      {
        tipo: "parada",
        id: "P-13",
        parada: 13,
        nombre: "Vista de la Catedral, Cimborrio",
      },
      {
        tipo: "tramo",
        id: "TR-7",
        tramo: 7,
        nombre: "Museo arqueolÃ³gico La AlmoÃ­na â†’ Palacio Arzobispal",
      },
      {
        tipo: "parada",
        id: "P-14",
        parada: 14,
        nombre: "Palacio Arzobispal y Puerta RomÃ¡nica de la Catedral",
      },
      {
        tipo: "parada",
        id: "P-15",
        parada: 15,
        nombre: "Puerta RomÃ¡nica de la Catedral",
      },
      {
        tipo: "tramo",
        id: "TR-8",
        tramo: 8,
        nombre: "Puerta RomÃ¡nica de la Catedral â†’ Plaza del Ayuntamiento",
      },
      {
        tipo: "parada",
        id: "P-16",
        parada: 16,
        nombre: "Plaza del Ayuntamiento",
      },
      {
        tipo: "tramo",
        id: "TR-9",
        tramo: 9,
        nombre: "Plaza del Ayuntamiento â†’ Edificio del Ayuntamiento de ValÃ¨ncia",
      },
      {
        tipo: "parada",
        id: "P-17",
        parada: 17,
        nombre: "Edificio del Ayuntamiento",
      },
      {
        tipo: "parada",
        id: "P-18",
        parada: 18,
        nombre: "Edificio del Ayuntamiento",
      },
      {
        tipo: "tramo",
        id: "TR-10",
        tramo: 10,
        nombre: "Edificio del Ayuntamiento â†’ EstaciÃ³n del Norte",
      },
      {
        tipo: "parada",
        id: "P-19",
        parada: 19,
        nombre: "EstaciÃ³n del Norte",
      },
      {
        tipo: "tramo",
        id: "TR-11",
        tramo: 11,
        nombre: "EstaciÃ³n del Norte â†’ Plaza de Toros de ValÃ¨ncia",
      },
      {
        tipo: "tramo",
        id: "TR-12",
        tramo: 12,
        nombre: "Plaza de Toros â†’ Casa estilo Ãrabe",
      },
      {
        tipo: "parada",
        id: "P-20",
        parada: 20,
        nombre: "Casa estilo Ãrabe",
      },
      {
        tipo: "parada",
        id: "P-21",
        parada: 21,
        nombre: "Casa estilo Ãrabe, mitad Aventura",
      },
      {
        tipo: "tramo",
        id: "TR-13",
        tramo: 13,
        nombre: "Casa estilo Ãrabe â†’ Palacio de Comunicaciones (Correos)",
      },
      {
        tipo: "parada",
        id: "P-22",
        parada: 22,
        nombre: "Palacio de Comunicaciones: Correos",
      },
      {
        tipo: "parada",
        id: "P-23",
        parada: 23,
        nombre: "Edificio Suay",
      },
      {
        tipo: "tramo",
        id: "TR-14",
        tramo: 14,
        nombre: "Palacio de Comunicaciones â†’ Banco de ValÃ¨ncia",
      },
      {
        tipo: "parada",
        id: "P-24",
        parada: 24,
        nombre: "Banco de Valencia",
      },
      {
        tipo: "tramo",
        id: "TR-15",
        tramo: 15,
        nombre: "Banco de ValÃ¨ncia â†’ Palacio del MarquÃ©s de Dos Aguas (Museo Nacional de CerÃ¡mica)",
      },
      {
        tipo: "parada",
        id: "P-25",
        parada: 25,
        nombre: "Palacio del MarquÃ©s de Dos Aguas (Museo Nacional de CerÃ¡mica)",
      },
      {
        tipo: "tramo",
        id: "TR-16",
        tramo: 16,
        nombre: "Palacio del MarquÃ©s â†’ Mercado Central",
      },
      {
        tipo: "parada",
        id: "P-26",
        parada: 26,
        nombre: "Mercado central",
      },
      {
        tipo: "tramo",
        id: "TR-17",
        tramo: 17,
        nombre: "Mercado Central â†’ Lonja de la Seda",
      },
      {
        tipo: "parada",
        id: "P-27",
        parada: 27,
        nombre: "Lonja de la Seda",
      },
      {
        tipo: "tramo",
        id: "TR-18",
        tramo: 18,
        nombre: "Lonja de la Seda â†’ Plaza Redonda",
      },
      {
        tipo: "parada",
        id: "P-28",
        parada: 28,
        nombre: "Plaza Redonda",
      },
      {
        tipo: "tramo",
        id: "TR-19",
        tramo: 19,
        nombre: "Plaza Redonda â†’ Iglesia de los Santos Juanes",
      },
      {
        tipo: "parada",
        id: "P-29",
        parada: 29,
        nombre: "Iglesia de los Santos Juanes",
      },
      {
        tipo: "tramo",
        id: "TR-20",
        tramo: 20,
        nombre: "Iglesia de los Santos Juanes â†’ Mercado Central",
      },
      {
        tipo: "tramo",
        id: "TR-21",
        tramo: 21,
        nombre: "Mercado Central â†’ Palacio de la Generalitat",
      },
      {
        tipo: "parada",
        id: "P-30",
        parada: 30,
        nombre: "Palau de la Generalitat",
      },
      {
        tipo: "tramo",
        id: "TR-22",
        tramo: 22,
        nombre: "Palacio de la Generalitat â†’ Torres de Serranos (Final)",
      },
      {
        tipo: "parada",
        id: "P-31",
        parada: 31,
        nombre: "Torres de Serranos (Final)",
      }
    ];

    // Variables para rastrear el estado local
    let gpsOn = true; // Estado del GPS (true = encendido/aventura, false = apagado/casa)
    let modoCasa = !gpsOn; // Modo casa activo (inverso a gpsOn)
    let paradas = [];
    let tramos = [];
    let watchId = null; // Para el seguimiento de la geolocalizaciÃ³n
    let paradaActual = -1;
    let tramoActual = -1;
    
    // Estado local sincronizado con el padre
    let estadoLocal = {
        modo: modoCasa ? 'casa' : 'aventura',
        puntoActual: null,
        ultimaActualizacion: 0
    };
    
    // Referencia al iframe padre
    const padre = window.parent;
    
    // Referencia al elemento de estado del modo
    let estadoModo = document.getElementById('estado-modo');

    // ================ FUNCIONES DE REGISTRO ================
    
    /**
     * Registra un mensaje de depuraciÃ³n con formato consistente
     * @param {string} mensaje - Mensaje a registrar
     * @param {string} tipo - Tipo de mensaje (info, warn, error, debug)
     * @param {*} [datos] - Datos adicionales para registrar
     */
    function log(mensaje, tipo = 'info', datos) {
        const timestamp = new Date().toISOString();
        const prefijo = `[${timestamp}] HIJO5-CASA:`;
        const mensajeFormateado = `${prefijo} ${mensaje}`;
        
        // Usar el mÃ©todo de consola apropiado segÃºn el tipo
        switch(tipo.toLowerCase()) {
            case 'warn':
                console.warn(mensajeFormateado, datos || '');
                break;
            case 'error':
                console.error(mensajeFormateado, datos || '');
                break;
            case 'debug':
                console.debug(mensajeFormateado, datos || '');
                break;
            default: // info
                console.log(mensajeFormateado, datos || '');
        }
    }
    
    // ================ FUNCIONES AUXILIARES ================
    
    // Cache para elementos DOM frecuentemente accedidos
    const domCache = {
        gpsBtn: null,
        gpsLabel: null,
        estadoModo: null,
        paradasWindow: null,
        listaParadas: null,
        cerrarParadas: null
    };
    
    /**
     * Inicializa la cachÃ© de elementos DOM
     */
    function inicializarCacheDOM() {
        console.log('ðŸ”„ HIJO5: Inicializando cachÃ© del DOM...');
        
        // Forzar la bÃºsqueda de elementos cada vez para asegurar que los tenemos
        domCache.gpsBtn = document.getElementById('gps-casa-btn');
        domCache.gpsLabel = document.querySelector('#gps-casa-btn .gps-label');
        domCache.estadoModo = document.getElementById('estado-modo');
        domCache.paradasWindow = document.getElementById('paradas-window');
        domCache.listaParadas = document.getElementById('paradas-list');
        domCache.cerrarParadas = document.getElementById('cerrar-paradas');
        
        console.log('âœ… HIJO5: CachÃ© del DOM inicializada', {
            gpsBtn: !!domCache.gpsBtn,
            gpsLabel: !!domCache.gpsLabel,
            estadoModo: !!domCache.estadoModo,
            paradasWindow: !!domCache.paradasWindow,
            listaParadas: !!domCache.listaParadas,
            cerrarParadas: !!domCache.cerrarParadas
        });
        
        // Configurar manejador de eventos para el botÃ³n de cerrar
        if (domCache.cerrarParadas && !domCache.cerrarParadas._hasEventListener) {
            domCache.cerrarParadas.addEventListener('click', function() {
                console.log('ðŸ”„ HIJO5: Cerrando ventana de paradas');
                ocultarParadas();
            });
            domCache.cerrarParadas._hasEventListener = true;
        }
    }
    
    /**
     * Actualiza los elementos de la interfaz de usuario segÃºn el estado actual.
     */
    function actualizarInterfazUsuario() {
        // Reinicializar cachÃ© DOM
        domCache.gpsBtn = null;
        domCache.gpsLabel = null;
        inicializarCacheDOM();
        if (domCache.gpsBtn) {
            // Eliminar clases previas
            domCache.gpsBtn.classList.remove('on', 'activo');
            // Aplicar clase segÃºn estado
            if (gpsOn) {
                domCache.gpsBtn.classList.add('on');
                domCache.gpsBtn.classList.add('activo');
                domCache.gpsBtn.title = 'Desactivar GPS (Modo Aventura)';
            } else {
                domCache.gpsBtn.title = 'Activar GPS (Modo Casa)';
            }
            // Actualizar etiqueta
            const gpsLabel = domCache.gpsBtn.querySelector('.gps-label');
            if (gpsLabel) {
                gpsLabel.textContent = gpsOn ? 'ON' : 'OFF';
            }
        }
        actualizarIndicadorModo();
        if (domCache.gpsBtn) void domCache.gpsBtn.offsetHeight;
    }
    
    /**
     * Obtiene el punto actual (parada o tramo) basado en el estado actual.
     * @returns {Object|null} Punto actual o null si no hay ninguno.
     */
    function obtenerPuntoActual() {
        if (paradaActual >= 0) {
            return { tipo: 'parada', id: paradaActual };
        } else if (tramoActual >= 0) {
            return { tipo: 'tramo', id: tramoActual };
        }
        return null;
    }
    
    /**
     * Notifica al componente padre sobre el cambio de estado.
     * @param {Object|null} puntoActual - Punto actual (parada o tramo).
     * @param {string} modo - Modo actual ('casa' o 'aventura').
     */
    function notificarCambioEstado(puntoActual, modo) {
        const mensajePadre = {
            type: 'actualizarModo',
            modo: modo,
            origen: 'hijo5-casa',
            timestamp: Date.now(),
            puntoActual: puntoActual
        };
        
        console.log('ðŸ“¤ HIJO5-CASA: Notificando cambio de estado al padre:', mensajePadre);
        window.parent.postMessage(mensajePadre, '*');
    }
    
    /**
     * EnvÃ­a un mensaje al padre u otros iframes hijos de manera optimizada
     * @param {Object} config - ConfiguraciÃ³n del mensaje
     * @param {string} config.tipo - Tipo de mensaje
     * @param {string} [config.destino] - Destino del mensaje ('padre' o ID del hijo)
     * @param {Object} [config.datos] - Datos adicionales del mensaje
     * @param {boolean} [config.esMensajeParaHijo] - Si es un mensaje para un hijo especÃ­fico
     */
    function enviarMensaje({ tipo, destino = 'padre', datos = {}, esMensajeParaHijo = false }) {
        const mensaje = {
            tipo: esMensajeParaHijo ? `mensaje-para-${destino}` : tipo,
            origen: 'hijo5-casa',
            timestamp: Date.now(),
            ...(esMensajeParaHijo ? { mensaje: { ...datos, origen: 'hijo5-casa' } } : datos)
        };
        
        log(`Enviando mensaje a ${destino}: ${tipo}`, 'debug', mensaje);
        window.parent.postMessage(mensaje, '*');
    }
    
    /**
     * Maneja la lÃ³gica especÃ­fica para el modo Casa (GPS desactivado).
     * @param {Object|null} puntoActual - Punto actual (parada o tramo).
     */
    function manejarModoCasa(puntoActual) {
        log('Activando modo Casa - Configurando modo simulaciÃ³n', 'info');
        
        // Usar requestAnimationFrame para mejor rendimiento en actualizaciones de UI
        requestAnimationFrame(() => {
            // Si hay un punto actual, notificar a los componentes
            if (puntoActual) {
                // Usar find con una funciÃ³n de bÃºsqueda optimizada
                const punto = puntosRuta.find(p => {
                    if (p.tipo === 'parada' && puntoActual.tipo === 'parada') {
                        return p.parada === puntoActual.id;
                    } else if (p.tipo === 'tramo' && puntoActual.tipo === 'tramo') {
                        return p.tramo === puntoActual.id;
                    }
                    return false;
                });
                
                if (punto) {
                    log(`Notificando punto actual a los componentes: ${punto.tipo} ${punto.tipo === 'parada' ? punto.parada : punto.tramo}`, 'debug', punto);
                    
                    // Determinar coordenadas de manera eficiente
                    let coords;
                    if (punto.tipo === 'parada') {
                        coords = punto.coordenadas || { lat: 39.4699, lng: -0.3763 };
                    } else {
                        coords = punto.inicio || 
                                (punto.waypoints?.[0]) || 
                                { lat: 39.4699, lng: -0.3763 };
                    }
                    
                    // Notificar al hijo 2 (mapa) sobre la ubicaciÃ³n simulada
                    enviarMensaje({
                        destino: 'hijo2',
                        tipo: 'simularUbicacion',
                        datos: {
                            coordenadas: coords,
                            [punto.tipo + 'Id']: punto[punto.tipo === 'parada' ? 'parada' : 'tramo'],
                            modoCasa: true
                        },
                        esMensajeParaHijo: true
                    });
                    
                    // Si es una parada, notificar al hijo 3 (audio) y 4 (retos)
                    if (punto.tipo === 'parada' && punto.audio) {
                        enviarMensaje({
                            destino: 'hijo3',
                            tipo: 'cargarAudio',
                            datos: {
                                type: 'cargarAudio',
                                src: punto.audio,
                                paradaId: punto.parada,
                                autoplay: false
                            },
                            esMensajeParaHijo: true
                        });
                        
                        if (punto.reto) {
                            enviarMensaje({
                                destino: 'hijo4',
                                tipo: 'mostrarReto',
                                datos: {
                                    type: 'mostrarReto',
                                    paradaId: punto.parada,
                                    modoCasa: true
                                },
                                esMensajeParaHijo: true
                            });
                        }
                    } 
                    // Si es un tramo, notificar al hijo 3 (video) si hay video
                    else if (punto.tipo === 'tramo' && punto.video) {
                        enviarMensaje({
                            destino: 'hijo3',
                            tipo: 'cargarVideo',
                            datos: {
                                type: 'cargarVideo',
                                src: punto.video,
                                tramoId: punto.tramo,
                                autoplay: false
                            },
                            esMensajeParaHijo: true
                        });
                    }
                }
            }
            
            // Mostrar la ventana de selecciÃ³n de paradas/tramos
            mostrarParadasYTramos();
        });
    }
    
    /**
     * Maneja la lÃ³gica especÃ­fica para el modo Aventura (GPS activado).
     */
    function manejarModoAventura() {
        log('Activando modo Aventura - Usando GPS en tiempo real', 'info');
        
        // Usar requestAnimationFrame para mejor rendimiento en actualizaciones de UI
        requestAnimationFrame(() => {
            try {
                // Notificar al hijo 2 (mapa) para que use el GPS real
                enviarMensaje({
                    destino: 'hijo2',
                    tipo: 'iniciarGPS',
                    datos: {
                        type: 'iniciarGPS',
                        motivo: 'modo_aventura_activado'
                    },
                    esMensajeParaHijo: true
                });
                
                // Ocultar la ventana de paradas/tramos
                ocultarParadas();
            } catch (error) {
                log(`Error al activar modo Aventura: ${error.message}`, 'error', error);
            }
        });
    }
    
    // ================ FUNCIONES PRINCIPALES ================
    
    /**
     * Gestiona el estado del GPS y alterna entre los modos Aventura (GPS activado) y Casa (GPS desactivado).
     * Actualiza la interfaz de usuario, sincroniza el estado con el componente padre y notifica a los
     * componentes hijos segÃºn el modo activado.
     * 
     * @param {boolean} on - True para activar el modo Aventura (GPS activado), false para modo Casa (GPS desactivado).
     */
    function setGpsState(on) {
        console.log(`ðŸ”„ HIJO5-CASA: Iniciando cambio de estado - Modo actual: ${on ? 'Aventura' : 'Casa'}`);
        
        // Actualizar estado local independientemente de si ha cambiado
        // para asegurar que la interfaz se actualice
        gpsOn = on;
        modoCasa = !on;
        
        // Actualizar estado local sincronizado
        const modo = modoCasa ? 'casa' : 'aventura';
        estadoLocal.modo = modo;
        estadoLocal.ultimaActualizacion = Date.now();
        
        // Actualizar interfaz de usuario
        actualizarInterfazUsuario();
        
        // Obtener el punto actual (parada o tramo)
        const puntoActual = obtenerPuntoActual();
        
        // Notificar al padre sobre el cambio de estado
        notificarCambioEstado(puntoActual, modo);
        
        // Enviar mensaje al padre para sincronizar con otros iframes
        const mensajeSincronizacion = {
            type: 'sincronizarEstado',
            estado: {
                modo: modo,
                puntoActual: puntoActual,
                timestamp: Date.now()
            },
            origen: 'hijo5-casa'
        };
        
        window.parent.postMessage(mensajeSincronizacion, '*');
        
        // Manejar la lÃ³gica especÃ­fica del modo
        if (modoCasa) {
            console.log('ðŸ  HIJO5-CASA: Activando modo Casa (GPS OFF)');
            manejarModoCasa(puntoActual);
            
            // Notificar a los demÃ¡s iframes que estamos en modo casa
            enviarMensajeAHijo('hijo2', 'cambioModo', { modo: 'casa' });
            enviarMensajeAHijo('hijo3', 'cambioModo', { modo: 'casa' });
            enviarMensajeAHijo('hijo4', 'cambioModo', { modo: 'casa' });
            
            // Mostrar paradas despuÃ©s de un pequeÃ±o retraso para asegurar que el DOM estÃ© actualizado
            setTimeout(() => {
                mostrarParadasYTramos();
            }, 50);
        } else {
            console.log('ðŸŒ HIJO5-CASA: Activando modo Aventura (GPS ON)');
            
            // Notificar a los demÃ¡s iframes que volvemos al modo aventura
            enviarMensajeAHijo('hijo2', 'cambioModo', { modo: 'aventura' });
            enviarMensajeAHijo('hijo3', 'cambioModo', { modo: 'aventura' });
            enviarMensajeAHijo('hijo4', 'cambioModo', { modo: 'aventura' });
            
            manejarModoAventura();
            ocultarParadas();
        }
        
        // Forzar actualizaciÃ³n visual
        if (document.body) {
            document.body.style.display = 'none';
            document.body.offsetHeight; // Trigger reflow
            document.body.style.display = '';
        }
        
        console.log(`âœ… HIJO5-CASA: Cambio de estado completado - Modo: ${modo}, GPS: ${on ? 'ON' : 'OFF'}`);
        
        // Notificar al padre sobre el cambio de estado del GPS
        window.parent.postMessage({
            type: 'gpsStateChanged',
            enabled: on,
            modo: modo,
            timestamp: Date.now()
        }, '*');
    }
    
    function actualizarIndicadorModo() {
      const estadoModo = document.getElementById('estado-modo');
      if (estadoModo) {
        estadoModo.textContent = `Modo: ${modoCasa ? 'Casa' : 'Aventura'}`;
        estadoModo.style.background = modoCasa ? '#ffe0e0' : '#e0f7fa';
        estadoModo.style.color = modoCasa ? '#c62828' : '#00695c';
      }
    }

    // Mostrar/ocultar ventana de paradas y tramos
    function mostrarParadas() {
      if (!gpsOn) {
        document.getElementById('paradas-window').style.display = 'flex';
        renderParadas();
      }
    }
    
    function ocultarParadas() {
      document.getElementById('paradas-window').style.display = 'none';
    }
    
    function renderParadas() {
      console.log('Renderizando paradas...');
      const lista = document.getElementById('paradas-list');
      if (!lista) {
        console.error('No se encontrÃ³ el elemento paradas-list');
        return;
      }
      
      // Asegurarse de que el array de paradas estÃ© inicializado
      if (!Array.isArray(paradas) || paradas.length === 0) {
        console.log('Inicializando puntos de ruta...');
        inicializarPuntosRuta();
        
        // Si despuÃ©s de inicializar sigue vacÃ­o, mostrar mensaje
        if (!Array.isArray(paradas) || paradas.length === 0) {
          console.error('No se pudieron cargar las paradas');
          lista.innerHTML = '<div style="padding: 10px; color: #666;">No hay paradas disponibles</div>';
          return;
        }
      }
      
      console.log(`Mostrando ${paradas.length} paradas`);
      
      // Crear un contenedor para las paradas
      const contenedor = document.createElement('div');
      contenedor.style.overflowY = 'auto';
      contenedor.style.maxHeight = '300px';
      contenedor.style.padding = '10px';
      
      // Agregar cada parada al contenedor
      paradas.forEach((parada, index) => {
        if (!parada || !parada.nombre) return; // Saltar elementos invÃ¡lidos
        
        const elementoParada = document.createElement('div');
        elementoParada.textContent = `${index + 1}. ${parada.nombre}`;
        elementoParada.style.padding = '8px 12px';
        elementoParada.style.margin = '4px 0';
        elementoParada.style.borderRadius = '4px';
        elementoParada.style.backgroundColor = index === paradaActual ? '#e3f2fd' : '#f5f5f5';
        elementoParada.style.color = index === paradaActual ? '#0d47a1' : '#333';
        elementoParada.style.cursor = 'pointer';
        elementoParada.style.transition = 'all 0.2s';
        
        // Resaltar al pasar el ratÃ³n
        elementoParada.onmouseover = () => {
          elementoParada.style.backgroundColor = index === paradaActual ? '#bbdefb' : '#e0e0e0';
        };
        
        elementoParada.onmouseout = () => {
          elementoParada.style.backgroundColor = index === paradaActual ? '#e3f2fd' : '#f5f5f5';
        };
        
        // Manejar clic en la parada
        elementoParada.onclick = () => {
          console.log(`Parada seleccionada: ${index + 1} - ${parada.nombre}`);
          paradaActual = index;
          renderParadas(); // Volver a renderizar para actualizar la selecciÃ³n
          
          // Notificar al padre sobre la parada seleccionada
          if (window.parent) {
            window.parent.postMessage({
              type: 'paradaSeleccionada',
              parada: index,
              nombre: parada.nombre,
              origen: 'hijo5-casa',
              timestamp: Date.now()
            }, '*');
          }
        };
        
        contenedor.appendChild(elementoParada);
      });
      
      // Vaciar la lista y agregar el contenedor
      lista.innerHTML = '';
      lista.appendChild(contenedor);
      
      console.log(`Renderizadas ${paradas.length} paradas`);
    }
    
    function mostrarParadasYTramos() {
      console.log('ðŸ”„ HIJO5: Intentando mostrar paradas y tramos...');
      
      // Forzar la reinicializaciÃ³n de la cachÃ© del DOM
      domCache.paradasWindow = null;
      inicializarCacheDOM();
      
      if (!domCache.paradasWindow) {
        console.error('âŒ HIJO5: No se encontrÃ³ el elemento paradas-window en el DOM');
        
        // Intentar encontrar el elemento manualmente
        const paradasWindow = document.getElementById('paradas-window');
        if (paradasWindow) {
          console.log('âœ… HIJO5: Elemento paradas-window encontrado manualmente');
          domCache.paradasWindow = paradasWindow;
          domCache.listaParadas = document.getElementById('paradas-list');
        } else {
          console.error('âŒ HIJO5: No se pudo encontrar el elemento paradas-window en el DOM');
          return;
        }
      }
      
      if (!gpsOn) {
        console.log('ðŸ”„ HIJO5: Mostrando ventana de paradas...');
        
        try {
          // Asegurarse de que el contenedor sea visible
          domCache.paradasWindow.style.display = 'flex';
          
          // Forzar un reflow para asegurar que el navegador registre el cambio
          void domCache.paradasWindow.offsetHeight;
          
          // Renderizar las paradas
          renderParadasYTramos();
          
          console.log('âœ… HIJO5: Ventana de paradas y tramos mostrada correctamente');
          
          // Notificar al padre para expandir el iframe
          try {
            window.parent.postMessage({ 
              type: 'expandirIframe',
              origen: 'hijo5-casa',
              width: '250px',
              debug: 'ExpansiÃ³n para mostrar paradas y tramos',
              timestamp: Date.now()
            }, '*');
            console.log('ðŸ“¤ HIJO5: Mensaje de expansiÃ³n enviado al padre');
          } catch (error) {
            console.error('âŒ HIJO5: Error al enviar mensaje al padre:', error);
          }
        } catch (error) {
          console.error('âŒ HIJO5: Error al mostrar paradas:', error);
        }
      } else {
        console.log('âš ï¸ HIJO5: No se puede mostrar - GPS estÃ¡ ON');
      }
    }
    
    function ocultarParadas() {
      console.log('ðŸ”„ HIJO5: Ocultando ventana de paradas...');
      
      // Asegurarse de que la cachÃ© estÃ© inicializada
      inicializarCacheDOM();
      
      if (domCache.paradasWindow) {
        domCache.paradasWindow.style.display = 'none';
        console.log('âœ… HIJO5: Ventana de paradas ocultada');
        
        // Notificar al padre para contraer el iframe
        try {
          window.parent.postMessage({ 
            type: 'contraerIframe',
            origen: 'hijo5-casa',
            width: '100px',
            debug: 'ContracciÃ³n despuÃ©s de ocultar paradas',
            timestamp: Date.now()
          }, '*');
          console.log('ðŸ“¤ HIJO5: Mensaje de contracciÃ³n enviado al padre');
        } catch (error) {
          console.error('âŒ HIJO5: Error al enviar mensaje de contracciÃ³n al padre:', error);
        }
      } else {
        console.error('âŒ HIJO5: No se pudo ocultar la ventana de paradas - Elemento no encontrado');
      }
    }

    // Inicializar las listas de paradas y tramos desde la estructura unificada
    function inicializarPuntosRuta() {
      paradas = [];
      tramos = [];
      
      puntosRuta.forEach((punto, index) => {
        if (punto.tipo === 'parada' || punto.tipo === 'inicio') {
          paradas.push({
            id: punto.parada,
            nombre: punto.nombre,
            coordenadas: punto.coordenadas,
            imagen: punto.imagen,
            audio: punto.audio || `audio/parada_${punto.parada}.mp3`,
            esInicio: punto.tipo === 'inicio'
          });
        } else if (punto.tipo === 'tramo') {
          tramos.push({
            id: punto.tramo,
            nombre: punto.nombre,
            inicio: punto.inicio,
            fin: punto.fin,
            waypoints: punto.waypoints || [],
            imagen: punto.imagen,
            video: punto.video,
            origen: puntosRuta[index - 1].parada, // La parada anterior
            destino: puntosRuta[index + 1].parada  // La siguiente parada
          });
        }
      });
    }

    // Renderiza la lista de paradas y tramos
    function renderParadasYTramos() {
      const lista = document.getElementById('paradas-list');
      if (!lista) {
        console.error('âŒ HIJO5: No se encontrÃ³ el elemento paradas-list');
        return;
      }
      
      // Limpiar la lista
      lista.innerHTML = '';
      
      // Ordenar los puntos por el nÃºmero de parada o tramo
      const puntosOrdenados = [...puntosRuta].sort((a, b) => {
        const numA = a.parada !== undefined ? a.parada : a.tramo;
        const numB = b.parada !== undefined ? b.parada : b.tramo;
        return numA - numB;
      });
      
      // Recorrer la estructura ordenada de puntos de ruta
      puntosOrdenados.forEach((punto) => {
        const btn = document.createElement('button');
        btn.className = 'parada-tramo-btn';
        
        // Determinar si es parada o tramo
        const esParada = punto.tipo === 'parada' || punto.tipo === 'inicio';
        const esInicio = punto.tipo === 'inicio';
        const esActual = (esParada && punto.parada === paradaActual) || 
                        (!esParada && punto.tramo === tramoActual);
        
        // AÃ±adir clase 'actual' si es el punto actual
        if (esActual) {
          btn.classList.add('actual');
        }
        
        // AÃ±adir clase especÃ­fica para parada o tramo
        if (esParada) {
          btn.classList.add('parada-btn');
          if (esInicio) {
            btn.classList.add('inicio-btn');
          }
        } else {
          btn.classList.add('tramo-btn');
        }
        
        // Crear el contenido del botÃ³n
        const numero = esParada ? punto.parada : punto.tramo;
        const icono = esParada ? 
          (esInicio ? 'ðŸ' : 'ðŸ“') : 
          'ðŸ›£ï¸';
        const titulo = esParada ? 
          (esInicio ? 'Inicio' : `Parada ${numero}`) : 
          `Tramo ${numero}`;
          
        btn.innerHTML = `
          <span class="btn-icon">${icono}</span>
          <span class="btn-title">${titulo}</span>
          <span class="btn-desc">${punto.nombre}</span>
        `;
        
        // Manejar clic en el botÃ³n
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          
          if (esParada) {
            // Es una parada
            paradaActual = punto.parada;
            tramoActual = -1;
            console.log(`Seleccionada parada P${punto.parada}: ${punto.nombre}`);
          } else {
            // Es un tramo
            tramoActual = punto.tramo;
            paradaActual = -1;
            console.log(`Seleccionado tramo T${punto.tramo}: ${punto.nombre}`);
          }
          
          // Notificar al padre
          window.parent.postMessage({
            type: 'actualizarPuntoActual',
            origen: 'hijo5-casa',
            puntoActual: {
              tipo: esParada ? 'parada' : 'tramo',
              id: esParada ? `P-${punto.parada}` : `TR-${punto.tramo}`,
              numero: esParada ? punto.parada : punto.tramo,
              nombre: punto.nombre,
              coordenadas: punto.coordenadas,
              audio: punto.audio,
              video: punto.video,
              imagen: punto.imagen
            },
            modo: 'casa',
            gpsActivo: false
          }, '*');
          
          // Actualizar la vista
          renderParadasYTramos();
        });
        
        lista.appendChild(btn);
      });
    }

    // ================ FUNCIONES DE CONTROL ================
    
    /**
     * Desbloquea las funcionalidades del modo Casa
     */
    function desbloquearFuncionalidades() {
        log('Iniciando desbloqueo de funcionalidades - Modo Casa', 'debug');
        
        // Usar requestAnimationFrame para mejor rendimiento en actualizaciones de UI
        requestAnimationFrame(() => {
            try {
                // Activar botones de imagen y video en hijo 2 (NO GPS)
                enviarMensaje({
                    destino: 'hijo2',
                    tipo: 'activar-modo-casa-botones',
                    datos: {},
                    esMensajeParaHijo: true
                });
                
                // Habilitar controles de audio en hijo 3
                enviarMensaje({
                    destino: 'hijo3',
                    tipo: 'enableControls',
                    datos: {
                        type: 'enableControls',
                        enabled: true
                    },
                    esMensajeParaHijo: true
                });
                
                // Desbloquear botÃ³n retos en hijo 4
                enviarMensaje({
                    destino: 'hijo4',
                    tipo: 'enableRetos',
                    datos: {
                        type: 'enableRetos',
                        enabled: true
                    },
                    esMensajeParaHijo: true
                });
                
                log('Funcionalidades desbloqueadas - Modo Casa activado', 'debug');
            } catch (error) {
                log(`Error al desbloquear funcionalidades: ${error.message}`, 'error', error);
            }
        });
    }
    
    /**
     * Restaura las restricciones del modo Aventura
     */
    function restaurarRestriccionesAventura() {
        log('Restaurando restricciones - Modo Aventura', 'debug');
        
        // Usar requestAnimationFrame para mejor rendimiento en actualizaciones de UI
        requestAnimationFrame(() => {
            try {
                // Desactivar todos los botones en hijo 2
                enviarMensaje({
                    destino: 'hijo2',
                    tipo: 'desactivar-todos-botones',
                    datos: {},
                    esMensajeParaHijo: true
                });
                
                // Bloquear controles de audio en hijo 3
                enviarMensaje({
                    destino: 'hijo3',
                    tipo: 'disableControls',
                    datos: {
                        type: 'disableControls',
                        enabled: false
                    },
                    esMensajeParaHijo: true
                });
                
                // Bloquear botÃ³n retos en hijo 4
                enviarMensaje({
                    destino: 'hijo4',
                    tipo: 'disableRetos',
                    datos: {
                        type: 'disableRetos',
                        enabled: false
                    },
                    esMensajeParaHijo: true
                });
                
                log('Restricciones restauradas - Modo Aventura activado', 'debug');
            } catch (error) {
                log(`Error al restaurar restricciones: ${error.message}`, 'error', error);
            }
        });
    }

    // ================ COMUNICACIÃ“N CON EL HIJO 2 ================
    
    // FunciÃ³n para enviar mensajes al hijo2
    function enviarMensajeAHijo2(mensaje) {
        const mensajeCompleto = {
            type: 'mensaje-para-hijo2',
            origen: 'hijo5-casa',
            destino: 'padre',
            timestamp: Date.now(),
            datos: {
                ...mensaje,
                origen: 'hijo5-casa',
                timestamp: Date.now()
            }
        };
        console.log('ðŸ“¤ HIJO5: Enviando mensaje a hijo2:', mensajeCompleto);
        window.parent.postMessage(mensajeCompleto, '*');
    }
    
    // FunciÃ³n para solicitar el estado actual al hijo2
    function solicitarEstadoAHijo2() {
        enviarMensajeAHijo2({
            type: 'solicitar-estado-modo'
        });
    }
    
    // FunciÃ³n para enviar mensajes a cualquier iframe hijo
    function enviarMensajeAHijo(hijo, tipo, datos = {}) {
        const mensaje = {
            type: `mensaje-para-${hijo}`,
            origen: 'hijo5-casa',
            destino: 'padre',
            timestamp: Date.now(),
            datos: {
                type: tipo,
                origen: 'hijo5-casa',
                timestamp: Date.now(),
                ...datos
            }
        };
        console.log(`ðŸ“¤ HIJO5: Enviando mensaje a ${hijo} (${tipo}):`, mensaje);
        window.parent.postMessage(mensaje, '*');
    }
    
    // FunciÃ³n para solicitar sincronizaciÃ³n con el padre
    function sincronizarConPadre() {
        console.log('ðŸ”„ HIJO5: Solicitando sincronizaciÃ³n con el padre...');
        
        const estadoActual = {
            modo: modoCasa ? 'casa' : 'aventura',
            gpsActivo: !modoCasa,
            puntoActual: obtenerPuntoActual()
        };
        
        // Usar la funciÃ³n enviarMensaje para garantizar consistencia
        enviarMensaje({
            tipo: 'sincronizarEstado',
            destino: 'padre',
            datos: {
                type: 'solicitudSincronizacion',
                timestamp: Date.now(),
                estado: estadoActual
            }
        });
        
        console.log('âœ… HIJO5: Mensaje de sincronizaciÃ³n enviado al padre:', estadoActual);
        
        // TambiÃ©n notificar a los otros hijos del cambio de estado
        notificarCambioEstado(estadoActual.puntoActual, estadoActual.modo);
    }
    
    /**
     * Manejador de mensajes entrantes optimizado
     * @param {MessageEvent} event - Evento de mensaje recibido
     * @param {MessageEvent} event - Evento de mensaje recibido
     */
    const manejarMensaje = (event) => {
        const { data } = event;
        
        // ValidaciÃ³n bÃ¡sica del mensaje
        if (!data || !data.tipo) {
            return; // Ignorar mensajes sin tipo
        }
        
        // Usar requestIdleCallback para manejar mensajes de baja prioridad
        const procesarMensaje = (deadline) => {
            try {
                // Manejar mensajes crÃ­ticos de inmediato
                if (data.tipo === 'sincronizarEstado' || data.tipo === 'actualizar-estado-hijo5') {
                    manejarSincronizacionEstado(data, 'padre');
                    return;
                }
                
                // Para mensajes menos crÃ­ticos, verificar si hay tiempo en el frame actual
                if (deadline.timeRemaining() > 2) {
                    switch(data.tipo) {
                        case 'ACTUALIZAR_ESTADO':
                            log('Actualizando estado de navegaciÃ³n', 'debug', data);
                            if (data.paradaActual !== undefined) {
                                paradaActual = data.paradaActual;
                                tramoActual = -1;
                                renderParadasYTramos();
                            }
                            if (data.tramoActual !== undefined) {
                                tramoActual = data.tramoActual;
                                paradaActual = -1;
                                renderParadasYTramos();
                            }
                            break;
                            
                        case 'cambiar-modo':
                            log(`Cambiando modo a: ${data.modo}`, 'debug');
                            setGpsState(data.modo === 'aventura');
                            break;
                            
                        case 'seleccionar-parada':
                            log(`Seleccionando parada: ${data.paradaId}`, 'debug');
                            // AquÃ­ irÃ­a la lÃ³gica para seleccionar una parada
                            break;
                            
                        case 'seleccionar-tramo':
                            log(`Seleccionando tramo: ${data.tramoId}`, 'debug');
                            // AquÃ­ irÃ­a la lÃ³gica para seleccionar un tramo
                            break;
                            
                        default:
                            log(`Mensaje no manejado: ${data.tipo}`, 'warn', data);
                    }
                } else {
                    // Si no hay tiempo suficiente, programar para el siguiente frame
                    requestIdleCallback(procesarMensaje, { timeout: 100 });
                    return;
                }
            } catch (error) {
                log(`Error al procesar mensaje: ${error.message}`, 'error', {
                    mensaje: data,
                    error: error.stack
                });
            }
        };
        
        // Registrar el mensaje recibido para depuraciÃ³n
        log(`Mensaje recibido: ${data.tipo}`, 'debug', data);
        
        // Programar el manejo del mensaje
        requestIdleCallback(procesarMensaje, { timeout: 100 });
    };
    
    // Registrar el manejador de mensajes con opciones de rendimiento
    const opcionesEvento = { passive: true };
    window.addEventListener('message', manejarMensaje, opcionesEvento);
    
    // Sincronizar estado inicial
    const estadoActual = {
        modo: modoCasa ? 'casa' : 'aventura',
        gpsActivo: !modoCasa,
        puntoActual: obtenerPuntoActual()
    };
    
    // Usar la funciÃ³n enviarMensaje para garantizar consistencia
    enviarMensaje({
        tipo: 'sincronizarEstado',
        destino: 'padre',
        datos: {
            type: 'solicitudSincronizacion',
            timestamp: Date.now(),
            estado: estadoActual
        }
    });
    
    console.log('âœ… HIJO5: Mensaje de sincronizaciÃ³n enviado al padre:', estadoActual);
    
    // TambiÃ©n notificar a los otros hijos del cambio de estado
    notificarCambioEstado(estadoActual.puntoActual, estadoActual.modo);

    // Cerrar ventana de paradas
    document.getElementById('cerrar-paradas').onclick = function() {
      ocultarParadas();
      window.parent.postMessage({ 
        type: 'cerrarParadas',
        origen: 'hijo5-casa'
      }, '*');
    };

    // ================ MANEJO DE MENSAJES ================
    
    // FunciÃ³n para manejar la sincronizaciÃ³n de estado con el padre
    function manejarSincronizacionEstado(data, origen) {
      console.log('ðŸ“¥ HIJO5-CASA: Sincronizando estado con el padre:', data);
      
      // Si el mensaje viene directamente con puntoActual (sin estado.estado)
      if (data.puntoActual) {
        const puntoActual = data.puntoActual;
        
        // Actualizar estado local
        if (puntoActual.tipo === 'parada') {
          paradaActual = puntoActual.id;
          tramoActual = -1;
        } else if (puntoActual.tipo === 'tramo') {
          tramoActual = puntoActual.id;
          paradaActual = -1;
        }
        
        // Actualizar estado local sincronizado
        estadoLocal.puntoActual = puntoActual;
        estadoLocal.ultimaActualizacion = data.timestamp || Date.now();
        
        // Si estamos en modo casa, simular la ubicaciÃ³n
        if (modoCasa && puntoActual) {
          const punto = puntosRuta.find(p => 
            (p.tipo === puntoActual.tipo && 
             ((p.tipo === 'parada' && p.parada === puntoActual.id) || 
              (p.tipo === 'tramo' && p.tramo === puntoActual.id)))
          );
          
          if (punto) {
            const coords = punto.tipo === 'parada' ? 
              punto.coordenadas : 
              (punto.inicio || (punto.waypoints && punto.waypoints[0]) || { lat: 39.4699, lng: -0.3763 });
            
            console.log(`ðŸ  HIJO5-CASA: Simulando ubicaciÃ³n para ${punto.tipo} ${punto.tipo === 'parada' ? punto.parada : punto.tramo}`, coords);
            
            // Notificar al hijo 2 (mapa) sobre la ubicaciÃ³n simulada
            window.parent.postMessage({
              tipo: 'mensaje-para-hijo2',
              origen: 'hijo5-casa',
              mensaje: {
                type: 'simularUbicacion',
                coordenadas: coords,
                [punto.tipo + 'Id']: punto.tipo === 'parada' ? punto.parada : punto.tramo,
                modoCasa: true,
                origen: 'hijo5-casa',
                timestamp: estadoLocal.ultimaActualizacion
              }
            }, '*');
            
            // Si es una parada, notificar al hijo 3 (audio) y 4 (retos)
            if (punto.tipo === 'parada' && punto.audio) {
              window.parent.postMessage({
                tipo: 'mensaje-para-hijo3',
                origen: 'hijo5-casa',
                mensaje: {
                  type: 'cargarAudio',
                  src: punto.audio,
                  paradaId: punto.parada,
                  autoplay: true,
                  origen: 'hijo5-casa',
                  timestamp: estadoLocal.ultimaActualizacion
                }
              }, '*');
              
              if (punto.reto) {
                window.parent.postMessage({
                  tipo: 'mensaje-para-hijo4',
                  origen: 'hijo5-casa',
                  mensaje: {
                    type: 'mostrarReto',
                    paradaId: punto.parada,
                    modoCasa: true,
                    origen: 'hijo5-casa',
                    timestamp: estadoLocal.ultimaActualizacion
                  }
                }, '*');
              }
            } 
            // Si es un tramo, notificar al hijo 3 (video) si hay video
            else if (punto.tipo === 'tramo' && punto.video) {
              window.parent.postMessage({
                tipo: 'mensaje-para-hijo3',
                origen: 'hijo5-casa',
                mensaje: {
                  type: 'cargarVideo',
                  src: punto.video,
                  tramoId: punto.tramo,
                  autoplay: true,
                  origen: 'hijo5-casa',
                  timestamp: estadoLocal.ultimaActualizacion
                }
              }, '*');
            }
          }
        }
        
        // Actualizar la vista
        renderParadasYTramos();
      }
      // Manejar mensajes con formato de estado.estado
      else if (data.estado) {
        // Actualizar modo (casa/aventura) - Solo si el mensaje no viene del propio hijo5-casa
        // y no estamos en medio de un cambio de estado manual
        if (data.estado.modo && 
            (data.estado.modo === 'casa' || data.estado.modo === 'aventura') && 
            data.origen !== 'hijo5-casa' &&
            !document.body.classList.contains('cambiando-estado')) {
          const nuevoModo = data.estado.modo === 'casa';
          if (modoCasa !== nuevoModo) {
            console.log(`ðŸ”„ HIJO5-CASA: Actualizando modo a ${nuevoModo ? 'casa' : 'aventura'} (solicitado por ${data.origen || 'desconocido'})`);
            modoCasa = nuevoModo;
            // No llamar a setGpsState aquÃ­ para evitar bucles, solo actualizar el estado local
            gpsOn = !nuevoModo;
            // Actualizar la interfaz de usuario directamente
            actualizarInterfazUsuario();
            
            // Mostrar u ocultar paradas segÃºn el modo
            if (nuevoModo) {
              mostrarParadasYTramos();
            } else {
              ocultarParadas();
            }
          }
        }
        
        // Actualizar punto actual (parada o tramo)
        if (data.estado.puntoActual) {
          if (data.estado.puntoActual.tipo === 'parada' && data.estado.puntoActual.id !== undefined) {
            paradaActual = data.estado.puntoActual.id;
            tramoActual = -1;
          } else if (data.estado.puntoActual.tipo === 'tramo' && data.estado.puntoActual.id !== undefined) {
            tramoActual = data.estado.puntoActual.id;
            paradaActual = -1;
          }
          
          // Actualizar UI si es necesario
          if (document.getElementById('paradas-window').style.display === 'flex') {
            renderParadasYTramos();
          }
        }
      }
    }
    
    window.addEventListener('message', (event) => {
      const data = event.data;
      if (!data) return;
      
      console.log('[Hijo5] Mensaje recibido:', data);
      
      // Manejar mensajes de sincronizaciÃ³n de estado
      if (data.type === 'sincronizarEstado' && data.estado) {
        manejarSincronizacionEstado(data, data.origen || 'desconocido');
        return;
      }
      
      // Mensajes del padre
      if (data.tipo === 'gpsStatus' || data.type === 'gpsStatus') {
        const gpsActivo = data.estadoGPS === 'activo' || data.on === true;
        setGpsState(gpsActivo);
        
        if (gpsActivo) {
          ocultarParadas();
          // Notificar al padre que el modo aventura estÃ¡ activo
          window.parent.postMessage({
            tipo: 'ACTUALIZAR_ESTADO_GPS',
            estadoGPS: 'activo',
            timestamp: Date.now()
          }, '*');
        } else {
          mostrarParadasYTramos();
          // Notificar al padre que el modo casa estÃ¡ activo
          window.parent.postMessage({
            tipo: 'ACTUALIZAR_ESTADO_GPS',
            estadoGPS: 'inactivo',
            timestamp: Date.now()
          }, '*');
        }
      }
      
      // Mensajes del hijo 2
      if (data.tipo === 'confirmacion-modo-casa' && data.activo && !modoCasa) {
        modoCasa = true;
        setGpsState(false);
        mostrarParadasYTramos();
        
        // Notificar al padre sobre el cambio de estado
        window.parent.postMessage({
          tipo: 'ACTUALIZAR_ESTADO_GPS',
          estadoGPS: 'inactivo',
          timestamp: Date.now()
        }, '*');
      }
      
      if (data.tipo === 'confirmacion-modo-aventura' && data.activo && modoCasa) {
        modoCasa = false;
        setGpsState(true);
        ocultarParadas();
        
        // Notificar al padre sobre el cambio de estado
        window.parent.postMessage({
          tipo: 'ACTUALIZAR_ESTADO_GPS',
          estadoGPS: 'activo',
          timestamp: Date.now()
        }, '*');
      }
      
      if (data.tipo === 'estado-modo-actual' || data.tipo === 'ACTUALIZAR_UI') {
        modoCasa = data.modoCasa || data.gpsActivo === false;
        paradaActual = data.paradaActual || paradaActual || 0;
        tramoActual = data.tramoActual || tramoActual || -1;
        
        setGpsState(!modoCasa);
        
        if (modoCasa && document.getElementById('paradas-window').style.display === 'flex') {
          renderParadasYTramos();
        } else if (!modoCasa) {
          ocultarParadas();
        }
        
        if (modoCasa) {
          desbloquearFuncionalidades();
        }
      }
      
      if (data.tipo === 'cambio-parada-actual' || data.tipo === 'PARADA_SELECCIONADA') {
        const nuevaParada = data.parada || data.paradaIndex;
        if (nuevaParada !== undefined && nuevaParada !== paradaActual) {
          paradaActual = nuevaParada;
          tramoActual = -1;
          
          // Actualizar la interfaz de usuario
          if (document.getElementById('paradas-window').style.display === 'flex') {
            renderParadasYTramos();
          }
          
          // Notificar al padre sobre la nueva parada seleccionada
          window.parent.postMessage({
            tipo: 'PARADA_SELECCIONADA',
            paradaIndex: paradaActual,
            timestamp: Date.now()
          }, '*');
        }
      }
      
      if (data.tipo === 'cambio-tramo-actual' || data.tipo === 'TRAMO_SELECCIONADO') {
        const nuevoTramo = data.tramo || data.tramoIndex;
        if (nuevoTramo !== undefined && nuevoTramo !== tramoActual) {
          tramoActual = nuevoTramo;
          paradaActual = -1;
          
          // Actualizar la interfaz de usuario
          if (document.getElementById('paradas-window').style.display === 'flex') {
            renderParadasYTramos();
          }
          
          // Notificar al padre sobre el nuevo tramo seleccionado
          window.parent.postMessage({
            tipo: 'TRAMO_SELECCIONADO',
            tramoIndex: tramoActual,
            timestamp: Date.now()
          }, '*');
        }
      }
    });
    
    function setGpsState(on) {
      console.log('ðŸŽ¯ HIJO5: setGpsState llamado con on =', on);
      
      try {
        // Actualizar estado global
        gpsOn = on;
        modoCasa = !on;
        
        // Obtener referencias a los elementos del DOM
        const gpsBtn = document.getElementById('gps-casa-btn');
        if (!gpsBtn) {
          console.error('âŒ HIJO5: No se encontrÃ³ el botÃ³n de GPS en el DOM');
          return;
        }
        
        // Asegurar que el botÃ³n tenga el tamaÃ±o correcto
        gpsBtn.style.width = '30px';
        gpsBtn.style.height = '30px';
        gpsBtn.style.minWidth = '30px';
        gpsBtn.style.minHeight = '30px';
        
        // Asegurarse de que el botÃ³n tenga la estructura necesaria
        if (!gpsBtn.querySelector('.button-content')) {
          console.log('ðŸ”¨ Reconstruyendo estructura del botÃ³n...');
          gpsBtn.innerHTML = `
            <div class="button-content">
              <span class="satellite-emoji">ðŸ“¡</span>
              <span class="gps-label">${on ? 'ON' : 'OFF'}</span>
            </div>
          `;
        }
        
        const labelElement = gpsBtn.querySelector('.gps-label');
        const emojiElement = gpsBtn.querySelector('.satellite-emoji');
        const paradasWindow = document.getElementById('paradas-window');
        
        // Aplicar estilos directamente para asegurar que se vean
        gpsBtn.style.display = 'flex';
        gpsBtn.style.justifyContent = 'center';
        gpsBtn.style.alignItems = 'center';
        gpsBtn.style.backgroundColor = on ? '#4CAF50' : '#f44336';
        
        // Actualizar etiqueta
        if (labelElement) {
          labelElement.textContent = on ? 'ON' : 'OFF';
        }
        
        // Actualizar emoji
        if (emojiElement) {
          emojiElement.textContent = 'ðŸ“¡';
        }
        
        // Manejar el estado del GPS
        if (on) {
          // GPS Activado
          gpsBtn.title = 'Desactivar GPS';
          
          // Detener cualquier seguimiento anterior
          if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
          }
          
          // Iniciar nuevo seguimiento
          if ('geolocation' in navigator) {
            const options = {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0
            };
            
            watchId = navigator.geolocation.watchPosition(
              (position) => {
                console.log('ðŸ“ PosiciÃ³n obtenida:', position.coords);
                // Notificar al padre sobre la nueva posiciÃ³n
                if (window.parent) {
                  window.parent.postMessage({
                    type: 'GPS_POSITION',
                    coords: position.coords,
                    timestamp: position.timestamp,
                    origen: 'hijo5-casa'
                  }, '*');
                }
              },
              (error) => {
                console.error('âŒ Error de geolocalizaciÃ³n:', error);
                // Manejar errores
                if (error.code === error.PERMISSION_DENIED) {
                  console.warn('Permiso de ubicaciÃ³n denegado');
                } else if (error.code === error.POSITION_UNAVAILABLE) {
                  console.warn('UbicaciÃ³n no disponible');
                } else if (error.code === error.TIMEOUT) {
                  console.warn('Tiempo de espera agotado');
                }
              },
              options
            );
          } else {
            console.warn('GeolocalizaciÃ³n no soportada en este navegador');
          }
          
          // Ocultar ventana de paradas
          if (paradasWindow) {
            paradasWindow.style.display = 'none';
          }
          
        } else {
          // GPS Desactivado
          gpsBtn.title = 'Activar GPS';
          
          // Detener seguimiento de ubicaciÃ³n
          if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
          }
          
          // Mostrar ventana de paradas
          if (paradasWindow) {
            paradasWindow.style.display = 'block';
          }
        }
        
        // Notificar al hijo2 para que actualice el estado del botÃ³n
        if (window.parent) {
          const mensajeHijo2 = {
            tipo: 'mensaje-para-hijo2',
            mensaje: {
              type: 'actualizarEstadoGPS',
              gpsActivo: on,
              timestamp: Date.now()
            }
          };
          
          console.log('ðŸ“¤ Enviando mensaje a hijo2:', mensajeHijo2);
          window.parent.postMessage(mensajeHijo2, '*');
        }
        
        // Actualizar el estado en el almacenamiento local
        try {
          localStorage.setItem('gpsState', JSON.stringify(gpsOn));
          console.log('ðŸ’¾ Estado del GPS guardado en localStorage:', gpsOn);
        } catch (e) {
          console.warn('âš ï¸ No se pudo guardar el estado del GPS en localStorage:', e);
        }
        
        // Forzar actualizaciÃ³n de estilos
        gpsBtn.style.transform = 'translateZ(0)';
        
        console.log('âœ… setGpsState completado para estado:', on);
        
      } catch (error) {
        console.error('âŒ Error en setGpsState:', error);
        
        // Intentar recuperar el estado del botÃ³n
        const gpsBtn = document.getElementById('gps-casa-btn');
        if (gpsBtn) {
          console.log('ðŸ” Estado actual del botÃ³n:', {
            classList: [...gpsBtn.classList],
            style: gpsBtn.style.cssText,
            innerHTML: gpsBtn.innerHTML
          });
          
          // Intentar restaurar el estado visual
          gpsBtn.style.backgroundColor = gpsOn ? '#4CAF50' : '#f44336';
          const label = gpsBtn.querySelector('.gps-label');
          if (label) {
            label.textContent = gpsOn ? 'ON' : 'OFF';
          }
        }
      }
    }
    
    // ================ INICIALIZACIÃ“N ================
    
    // FunciÃ³n para manejar el clic en el botÃ³n GPS
    function handleGpsButtonClick(event) {
      try {
        // Prevenir el comportamiento por defecto y la propagaciÃ³n
        if (event && typeof event.preventDefault === 'function') {
          event.preventDefault();
        }
        if (event && typeof event.stopPropagation === 'function') {
          event.stopPropagation();
        }
        
        // Invertir el estado actual del GPS
        const nuevoEstado = !gpsOn;
        console.log(`ðŸŽ¯ HIJO5: BotÃ³n clickeado - Cambiando a modo ${nuevoEstado ? 'Aventura' : 'Casa'} (GPS: ${nuevoEstado ? 'ON' : 'OFF'})`);
        
        // Actualizar el estado local
        gpsOn = nuevoEstado;
        modoCasa = !nuevoEstado;
        
        // Actualizar la interfaz y manejar la lÃ³gica de GPS
        setGpsState(nuevoEstado);
        
        // Si se estÃ¡ desactivando el GPS, asegurarse de que se muestre la ventana de paradas
        if (!nuevoEstado) {
          const paradasWindow = document.getElementById('paradas-window');
          if (paradasWindow) {
            paradasWindow.style.display = 'block';
          }
        } else {
          // Si se estÃ¡ activando el GPS, asegurarse de que se oculte la ventana de paradas
          const paradasWindow = document.getElementById('paradas-window');
          if (paradasWindow) {
            paradasWindow.style.display = 'none';
          }
        }
        
        // Notificar al padre sobre el cambio de modo
        if (window.parent && window.parent.postMessage) {
          try {
            window.parent.postMessage({
              type: 'SET_GPS_STATE',
              gpsOn: nuevoEstado,
              origen: 'hijo5-casa',
              modo: nuevoEstado ? 'aventura' : 'casa',
              timestamp: Date.now()
            }, '*');
            console.log('ðŸ“¤ NotificaciÃ³n de cambio de estado enviada al padre');
          } catch (e) {
            console.error('âŒ Error al notificar al padre:', e);
          }
        }
        
        // Actualizar el estado en el almacenamiento local (solo una vez)
        try {
          localStorage.setItem('gpsState', JSON.stringify(nuevoEstado));
          console.log('ðŸ’¾ Estado del GPS guardado en localStorage:', nuevoEstado);
        } catch (e) {
          console.warn('No se pudo guardar el estado del GPS en localStorage:', e);
        }
        
      } catch (error) {
        console.error('âŒ Error en handleGpsButtonClick:', error);
        // Intentar recuperar el estado del botÃ³n en caso de error
        try {
          const gpsBtn = document.getElementById('gps-casa-btn');
          if (gpsBtn) {
            gpsBtn.style.backgroundColor = gpsOn ? '#4CAF50' : '#f44336';
            const label = gpsBtn.querySelector('.gps-label');
            if (label) {
              label.textContent = gpsOn ? 'ON' : 'OFF';
            }
          }
        } catch (e) {
          console.error('No se pudo restaurar el estado del botÃ³n:', e);
        }
      }
    }
    
    // FunciÃ³n para inicializar el botÃ³n GPS
    function inicializarBotonGPS() {
      console.log('ðŸ”§ Inicializando botÃ³n GPS...');
      
      // Obtener el botÃ³n
      const gpsBtn = document.getElementById('gps-casa-btn');
      if (!gpsBtn) {
        console.error('âŒ No se encontrÃ³ el botÃ³n GPS en el DOM');
        return false;
      }
      
      // Asegurar que el botÃ³n tenga el tamaÃ±o correcto
      gpsBtn.style.width = '30px';
      gpsBtn.style.height = '30px';
      gpsBtn.style.minWidth = '30px';
      gpsBtn.style.minHeight = '30px';
      gpsBtn.style.padding = '0';
      gpsBtn.style.margin = '0 0 0 0px';
      
      // Crear estructura HTML del botÃ³n
      const buttonHTML = `
        <div class="button-content" style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%;">
          <span class="satellite-emoji" style="font-size: 25px; line-height: 1;">ðŸ“¡</span>
          <span class="gps-label" style="font-size: 20px; line-height: 2; margin-top: 1px;">${gpsOn ? 'ON' : 'OFF'}</span>
        </div>
      `;
      
      // Aplicar HTML y estilos al botÃ³n
      gpsBtn.innerHTML = buttonHTML;
      
      // Establecer atributos y estilos directamente
      gpsBtn.className = 'gps-button';
      gpsBtn.title = gpsOn ? 'Desactivar GPS' : 'Activar GPS';
      
      // Estilos en lÃ­nea para asegurar que se apliquen
      Object.assign(gpsBtn.style, {
        display: 'flex',
        justifyContent: 'center',
        alignItems: 'center',
        width: '30px',
        height: '30px',
        borderRadius: '4px',
        border: '1px solid #fff',
        backgroundColor: gpsOn ? '#4CAF50' : '#f44336',
        color: 'white',
        cursor: 'pointer',
        boxShadow: '0 2px 5px rgba(0, 0, 0, 0.3)',
        transition: 'all 0.3s ease',
        padding: '0',
        margin: '0 0 0 10px',
        position: 'relative',
        zIndex: '10002',
        pointerEvents: 'auto',
        WebkitTapHighlightColor: 'transparent',
        transform: 'translateZ(0)'
      });
      
      // Manejar eventos
      gpsBtn.removeEventListener('click', handleGpsButtonClick);
      gpsBtn.addEventListener('click', handleGpsButtonClick, { passive: true });
      
      console.log('âœ… BotÃ³n GPS inicializado correctamente en estado:', gpsOn ? 'ON' : 'OFF');
      return true;
    }
    
    // FunciÃ³n para inicializar la aplicaciÃ³n
    function inicializarAplicacion() {
      console.log('ðŸ”„ HIJO5: Inicializando aplicaciÃ³n...');
      
      // Inicializar la estructura de datos
      if (typeof inicializarPuntosRuta === 'function') {
        inicializarPuntosRuta();
      } else {
        console.warn('âš ï¸ La funciÃ³n inicializarPuntosRuta no estÃ¡ definida');
      }
      
      if (typeof actualizarIndicadorModo === 'function') {
        actualizarIndicadorModo();
      } else {
        console.warn('âš ï¸ La funciÃ³n actualizarIndicadorModo no estÃ¡ definida');
      }
      
      // Establecer el estado inicial del botÃ³n
      try {
        const savedState = localStorage.getItem('gpsState');
        if (savedState !== null) {
          gpsOn = JSON.parse(savedState);
          modoCasa = !gpsOn;
          console.log('ðŸ” Estado del GPS cargado desde localStorage:', gpsOn);
        } else {
          gpsOn = false;
          modoCasa = true;
          console.log('ðŸ” Estado del GPS no encontrado, usando valor por defecto (OFF)');
        }
      } catch (e) {
        console.warn('Error al cargar el estado del GPS, usando valor por defecto (OFF):', e);
        gpsOn = false;
        modoCasa = true;
      }
      
      // Inicializar el botÃ³n GPS
      if (inicializarBotonGPS()) {
        // Configurar el estado inicial del botÃ³n
        setGpsState(gpsOn);
        
        // Notificar al padre que estamos listos
        if (window.parent) {
          window.parent.postMessage({
            type: 'HIJO5_LISTO',
            origen: 'hijo5-casa',
            gpsActivo: gpsOn,
            timestamp: Date.now()
          }, '*');
        }
      } else {
        console.error('âŒ No se pudo inicializar el botÃ³n GPS');
      }
    }
    
    // Esperar a que el DOM estÃ© completamente cargado
    document.addEventListener('DOMContentLoaded', () => {
      // Inicializar la aplicaciÃ³n
      inicializarAplicacion();
      
      // Asegurarse de que la ventana de paradas estÃ© visible si estamos en modo casa
      if (modoCasa) {
        const paradasWindow = document.getElementById('paradas-window');
        if (paradasWindow) {
          paradasWindow.style.display = 'block';
        }
      }
      
      // Agregar event listener al botÃ³n de cerrar paradas
      const cerrarParadas = document.getElementById('cerrar-paradas');
      if (cerrarParadas) {
        cerrarParadas.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const paradasWindow = document.getElementById('paradas-window');
          if (paradasWindow) {
            paradasWindow.style.display = 'none';
          }
        });
      }
      
      // Evento click en el botÃ³n principal
      document.getElementById('gps-casa-btn').addEventListener('click', function() {
        // Alternar estado del GPS
        gpsOn = !gpsOn;
        modoCasa = !gpsOn;
        
        // Actualizar el botÃ³n
        const btn = this;
        if (gpsOn) {
          btn.classList.remove('off');
          btn.classList.add('on');
          btn.style.backgroundColor = '#4CAF50'; // Verde cuando estÃ¡ activo
          
          // Actualizar etiqueta
          const label = btn.querySelector('.gps-label');
          if (label) label.textContent = 'ON';
          
          // Ocultar paradas
          ocultarParadas();
          
          // Notificar al padre
          if (window.parent) {
            window.parent.postMessage({
              type: 'cambioModo',
              modo: 'aventura',
              origen: 'hijo5-casa',
              timestamp: Date.now()
            }, '*');
          }
          
          // Manejar modo aventura
          manejarModoAventura();
        } else {
          btn.classList.remove('on');
          btn.classList.add('off');
          btn.style.backgroundColor = '#f44336'; // Rojo cuando estÃ¡ inactivo
          
          // Actualizar etiqueta
          const label = btn.querySelector('.gps-label');
          if (label) label.textContent = 'OFF';
          
          // Mostrar paradas
          mostrarParadas();
          
          // Notificar al padre
          if (window.parent) {
            window.parent.postMessage({
              type: 'cambioModo',
              modo: 'casa',
              origen: 'hijo5-casa',
              timestamp: Date.now()
            }, '*');
          }
          
          // Manejar modo casa
          manejarModoCasa(obtenerPuntoActual());
        }
        
        // Notificar al padre
        window.parent.postMessage({
          type: 'cambioModo',
          modo: gpsOn ? 'aventura' : 'casa',
          origen: 'hijo5-casa',
          timestamp: Date.now()
        }, '*');
        
        sincronizarConPadre();
      });
      
      // Notificar al padre que estamos listos
      if (window.parent) {
        window.parent.postMessage({
          type: 'hijo5Ready',
          origen: 'hijo5-casa',
          modo: gpsOn ? 'aventura' : 'casa',
          gpsActivo: gpsOn,
          timestamp: Date.now()
        }, '*');
      }
      
      console.log(`âœ… HIJO5: InicializaciÃ³n completada en modo ${gpsOn ? 'Aventura (GPS ON)' : 'Casa (GPS OFF)'}`);
      
      // Solicitar estado al hijo 2 despuÃ©s de un breve delay
      if (typeof solicitarEstadoAHijo2 === 'function' && typeof sincronizarConPadre === 'function') {
        setTimeout(() => {
          solicitarEstadoAHijo2();
          sincronizarConPadre();
        }, 1000);
      } else {
        console.warn('âš ï¸ Algunas funciones de sincronizaciÃ³n no estÃ¡n definidas');
      }
    });
  </script>
</body>
</html>
