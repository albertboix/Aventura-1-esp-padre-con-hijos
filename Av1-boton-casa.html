<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hijo5-casa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
    /* Contenedor principal */
    #zona-boton-casa {
      position: relative;
      width: 100%;
      height: 60px;
    }
    
    /* Botón GPS: estilo actualizado with emoji de satélite y etiqueta ON/OFF */
    #gps-casa-btn {
      position: absolute;
      top: 5px;
      left: 5px;
      width: 50px;
      height: 50px;
      min-width: 50px;
      min-height: 50px;
      border-radius: 4px;
      border: 1px solid #fff;
      background-color: #f44336;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      padding: 0;
      margin: 0 0 0 10px;
      z-index: 10002;
      cursor: pointer;
      font-size: 16px;
    }
    
    #gps-casa-btn.on {
      background-color: #4CAF50 !important;
      border: 1px solid #45a049 !important;
    }
    
    #gps-casa-btn.off {
      background-color: #f44336 !important;
      border: 1px solid #d32f2f !important;
    }
    
    #gps-casa-btn:hover {
      opacity: 0.95;
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    #gps-casa-btn:hover .satellite-emoji {
      transform: rotate(15deg);
    }
    
    #gps-casa-btn:active {
      transform: scale(0.95);
    }
    
    .button-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      line-height: 1;
      gap: 2px;
    }
    
    .satellite-emoji {
      font-size: 28px;
      line-height: 1;
      display: block;
      transition: transform 0.3s ease;
    }
    
    .gps-label {
      font-size: 20px;
      font-weight: bold;
      line-height: 1;
      margin: 0;
      padding: 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .gps-label {
      font-size: 20px;
      font-weight: bold;
      line-height: 1;
      margin: 0;
      padding: 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Ventana de paradas compacta y horizontal */
    #paradas-window {
      position: absolute;
      top: 0;
      left: 75px;
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      padding: 2px;
      border: 1px solid #e0e0e0;
      width: auto; /* Permite que la ventana se adapte al contenido */
      min-width: 220px;
      max-width: 340px;
      z-index: 10003;
      height: 54px;
      overflow: hidden;
    }
    
    /* Scroll horizontal dedicado a los botones */
    #lista-paradas {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      padding: 4px;
      overflow-x: auto;
      overflow-y: hidden;
      gap: 4px;
      align-items: center;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
      height: 44px;
      min-height: 44px;
      max-height: 44px;
      scrollbar-width: thin;
      scrollbar-color: #c1c1c1 #f1f1f1;
    }
    #lista-paradas::-webkit-scrollbar {
      height: 8px;
    }
    #lista-paradas::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }
    #lista-paradas::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    /* Botones compactos y poco intrusivos */
    .parada-tramo-btn {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 4px 8px;
      margin: 0 2px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      flex: 0 0 auto;
      font-size: 12px;
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      justify-content: flex-start;
      min-width: 120px;
      max-width: 180px;
      min-height: 36px;
      height: 36px;
      gap: 4px;
      overflow: hidden;
    }
    .parada-btn {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      border: none !important;
    }
    
    .tramo-btn {
      background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
      color: white;
      border: none !important;
    }
    
    .inicio-btn {
      background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
      color: white;
      border: none !important;
    }
    
    .parada-tramo-btn.actual {
      border: 2px solid #ffd700 !important;
      box-shadow: 0 0 0 2px #ffd700, 0 0 15px rgba(255,215,0,0.7) !important;
      transform: scale(1.05);
      font-weight: bold;
      z-index: 2;
      position: relative;
    }
    
    .btn-icon {
      font-size: 1.2em;
      flex-shrink: 0;
      margin-right: 2px;
    }
    
    .btn-title {
      font-weight: 600;
      white-space: nowrap;
      font-size: 0.93em;
      margin-bottom: 0;
    }
    
    .btn-desc {
      font-size: 0.82em;
      opacity: 0.9;
      white-space: normal; /* Asegura que NO sea nowrap */
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 90px;
      font-weight: 500;
      line-height: 1.1;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      text-align: left;
      max-height: 2.2em;
      line-clamp: 2;
      box-orient: vertical;
      display: box;
    }
    
    /* Modificar estas clases para usar con #lista-paradas */
    #paradas-window.visible {
        display: flex !important;
        width: 90% !important;
        max-width: 1000px !important;
        opacity: 1 !important;
        height: 120px !important;
    }
    
    #paradas-window.hidden {
        display: none !important;
    }
    
    /* Estilos para efectos visuales de selección */
    .parada-tramo-btn.seleccionando {
      transform: scale(0.95);
      opacity: 0.8;
      box-shadow: 0 0 5px rgba(0,0,0,0.3) !important;
    }

    .parada-tramo-btn.seleccionado {
      animation: pulse 1s;
    }

    #gps-casa-btn.pulsando {
      transform: scale(0.95);
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
    }

    /* Estilo para el feedback de error */
    #gps-casa-btn.error {
      animation: shake 0.5s;
      background-color: #ff0000 !important;
    }

    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }

    #estado-carga {
        display: none !important;
    }

    /* Responsividad móvil para la ventana de paradas y botones */
    @media (max-width: 600px) {
      #paradas-window {
        left: 0 !important;
        right: 0 !important;
        min-width: 0 !important;
        max-width: 100vw !important;
        width: 100vw !important;
        border-radius: 0 0 20px 20px !important;
        height: 60px !important;
        padding: 2px 0 !important;
      }
      #lista-paradas {
        min-width: 0 !important;
        max-width: 100vw !important;
        width: 100vw !important;
        gap: 2px !important;
        padding: 2px 2px 2px 2px !important;
        height: 48px !important;
        min-height: 48px !important;
        max-height: 48px !important;
      }
      .parada-tramo-btn {
        min-width: 90px !important;
        max-width: 120px !important;
        font-size: 11px !important;
        padding: 2px 4px !important;
        height: 32px !important;
        min-height: 32px !important;
        gap: 2px !important;
      }
      .btn-desc {
        max-width: 60px !important;
        font-size: 0.75em !important;
      }
    }
    </style>
    <script type="module">
    // Importar módulos primero (before everything else)
    import { TIPOS_MENSAJE, MODOS } from './js/constants.js';
    import { CONFIG } from './js/config.js';
    import logger from './js/logger.js';
    import { 
        inicializarMensajeria,
        registrarControlador, 
        enviarMensaje 
    } from './js/mensajeria.js';
    
    // Configuración de mensajería
    const CONFIG_MENSAJERIA = {
        iframeId: 'hijo5-casa',
        debug: true,
        logLevel: 0, // DEBUG level for troubleshooting
        reintentos: {
            maximos: 3,
            tiempoEspera: 1000,
            factor: 2
        }
    };
    
    // Array definido de paradas y tramos con sus respectivos padreid
    const puntosRuta = [
      { tipo: "inicio", parada: 0, nombre: "Torres de Serranos (start)", padreid: "padre-P-0" },
      { tipo: "tramo", tramo: 1, nombre: "Torres de Serranos → Plaza de la crida (Puente de Serranos)", padreid: "padre-TR-1" },
      { tipo: "parada", parada: 1, nombre: "Plaza de la crida (Puente de Serranos)", padreid: "padre-P-1" },
      { tipo: "tramo", tramo: 2, nombre: "Plaza de la crida → Calle Muro de Santa Ana", padreid: "padre-TR-2" },
      { tipo: "parada", parada: 2, nombre: "Calle Muro de Santa Ana", padreid: "padre-P-2" },
      { tipo: "tramo", tramo: 3, nombre: "Calle Muro de Santa Ana → Palacio de los Borgia", padreid: "padre-TR-3" },
      { tipo: "parada", parada: 3, nombre: "Iglesia de San Lorenzo", padreid: "padre-P-3" },
      { tipo: "tramo", tramo: 4, nombre: "Iglesia de San Lorenzo → Plaza de la Virgen", padreid: "padre-TR-4" },
      { tipo: "parada", parada: 4, nombre: "Plaza de la Virgen Reto 6", padreid: "padre-P-4" },
      { tipo: "parada", parada: 5, nombre: "Plaza de la Virgen Reto 7", padreid: "padre-P-5" },
      { tipo: "tramo", tramo: 5, nombre: "Plaza de la Virgen → Plaza de la Almoína", padreid: "padre-TR-5" },
      { tipo: "parada", parada: 6, nombre: "Panel cerámico muro Catedral", padreid: "padre-P-6" },
      { tipo: "parada", parada: 7, nombre: "Capilla exterior catedral Reto 10", padreid: "padre-P-7" },
      { tipo: "parada", parada: 8, nombre: "Capilla exterior catedral Reto 11", padreid: "padre-P-8" },
      { tipo: "parada", parada: 9, nombre: "Arco Novo Catedral y Puerta Negra Basílica", padreid: "padre-P-9" },
      { tipo: "parada", parada: 10, nombre: "Casa del Punt de Gantxo", padreid: "padre-P-10" },
      { tipo: "tramo", tramo: 6, nombre: "Plaza de la Almoína → Plaza Decimo Junio Bruto (Museo Arqueológico de la Almoína)", padreid: "padre-TR-6" },
      { tipo: "parada", parada: 11, nombre: "Museo arqueológico La Almoína", padreid: "padre-P-11" },
      { tipo: "parada", parada: 12, nombre: "Museo arqueológico La Almoína", padreid: "padre-P-12" },
      { tipo: "parada", parada: 13, nombre: "Vista de la Catedral, Cimborrio", padreid: "padre-P-13" },
      { tipo: "tramo", tramo: 7, nombre: "Museo arqueológico La Almoína → Palacio Arzobispal", padreid: "padre-TR-7" },
      { tipo: "parada", parada: 14, nombre: "Palacio Arzobispal y Puerta Románica de la Catedral", padreid: "padre-P-14" },
      { tipo: "parada", parada: 15, nombre: "Puerta Románica de la Catedral", padreid: "padre-P-15" },
      { tipo: "tramo", tramo: 8, nombre: "Puerta Románica de la Catedral → Plaza del Ayuntamiento", padreid: "padre-TR-8" },
      { tipo: "parada", parada: 16, nombre: "Plaza del Ayuntamiento", padreid: "padre-P-16" },
      { tipo: "tramo", tramo: 9, nombre: "Plaza del Ayuntamiento → Edificio del Ayuntamiento de València", padreid: "padre-TR-9" },
      { tipo: "parada", parada: 17, nombre: "Edificio del Ayuntamiento", padreid: "padre-P-17" },
      { tipo: "parada", parada: 18, nombre: "Edificio del Ayuntamiento", padreid: "padre-P-18" },
      { tipo: "tramo", tramo: 10, nombre: "Edificio del Ayuntamiento → Estación del Norte", padreid: "padre-TR-10" },
      { tipo: "parada", parada: 19, nombre: "Estación del Norte", padreid: "padre-P-19" },
      { tipo: "tramo", tramo: 11, nombre: "Estación del Norte → Plaza de Toros de València", padreid: "padre-TR-11" },
      { tipo: "tramo", tramo: 12, nombre: "Plaza de Toros → Casa estilo Árabe", padreid: "padre-TR-12" },
      { tipo: "parada", parada: 20, nombre: "Casa estilo Árabe", padreid: "padre-P-20" },
      { tipo: "parada", parada: 21, nombre: "Casa estilo Árabe, mitad Aventura", padreid: "padre-P-21" },
      { tipo: "tramo", tramo: 13, nombre: "Casa estilo Árabe → Palacio de Comunicaciones (Correos)", padreid: "padre-TR-13" },
      { tipo: "parada", parada: 22, nombre: "Palacio de Comunicaciones: Correos", padreid: "padre-P-22" },
      { tipo: "parada", parada: 23, nombre: "Edificio Suay", padreid: "padre-P-23" },
      { tipo: "tramo", tramo: 14, nombre: "Palacio de Comunicaciones → Banco de València", padreid: "padre-TR-14" },
      { tipo: "parada", parada: 24, nombre: "Banco de Valencia", padreid: "padre-P-24" },
      { tipo: "tramo", tramo: 15, nombre: "Banco de València → Palacio del Marqués de Dos Aguas (Museo Nacional de Cerámica)", padreid: "padre-TR-15" },
      { tipo: "parada", parada: 25, nombre: "Palacio del Marqués de Dos Aguas (Museo Nacional de Cerámica)", padreid: "padre-P-25" },
      { tipo: "tramo", tramo: 16, nombre: "Palacio del Marqués → Mercado Central", padreid: "padre-TR-16" },
      { tipo: "parada", parada: 26, nombre: "Mercado central", padreid: "padre-P-26" },
      { tipo: "tramo", tramo: 17, nombre: "Mercado Central → Lonja de la Seda", padreid: "padre-TR-17" },
      { tipo: "parada", parada: 27, nombre: "Lonja de la Seda", padreid: "padre-P-27" },
      { tipo: "tramo", tramo: 18, nombre: "Lonja de la Seda → Plaza Redonda", padreid: "padre-TR-18" },
      { tipo: "parada", parada: 28, nombre: "Plaza Redonda", padreid: "padre-P-28" },
      { tipo: "tramo", tramo: 19, nombre: "Plaza Redonda → Iglesia de los Santos Juanes", padreid: "padre-TR-19" },
      { tipo: "parada", parada: 29, nombre: "Iglesia de los Santos Juanes", padreid: "padre-P-29" },
      { tipo: "tramo", tramo: 20, nombre: "Iglesia de los Santos Juanes → Mercado Central", padreid: "padre-TR-20" },
      { tipo: "tramo", tramo: 21, nombre: "Mercado Central → Palacio de la Generalitat", padreid: "padre-TR-21" },
      { tipo: "parada", parada: 30, nombre: "Palau de la Generalitat", padreid: "padre-P-30" },
      { tipo: "tramo", tramo: 22, nombre: "Palacio de la Generalitat → Torres de Serranos (Final)", padreid: "padre-TR-22" },
      { tipo: "parada", parada: 31, nombre: "Torres de Serranos (Final)", padreid: "padre-P-31" }
    ];
    
    // Exponer puntosRuta para que sea accesible desde el padre
    window.puntosRuta = puntosRuta;
    
    // Estado del componente
    const estado = {
        inicializado: false,
        inicializando: false,
        modo: 'casa', // Default mode
        gpsActivo: false,
        error: null,
        watchId: null,
        paradaActual: -1,
        tramoActual: -1,
        paradas: puntosRuta, // Inicializamos con el array local como fallback
        cargandoParadas: false,
        intentosParadas: 0
    };
    
    // Make available globally for debugging
    window.estadoComponente = estado;
    window.TIPOS_MENSAJE = TIPOS_MENSAJE;
    
    // Función para actualizar la interfaz según el modo
    function actualizarInterfaz(modo) {
        console.log(`Actualizando interfaz a modo: ${modo}`);
        const botonCasa = document.getElementById('gps-casa-btn');
        const label = botonCasa.querySelector('.gps-label');
        const paradasWindow = document.getElementById('paradas-window');
        
        if (!botonCasa) {
            console.warn('No se encontró el botón de casa');
            return;
        }
        
        const gpsActivo = modo === 'aventura';
        
        if (modo === 'casa') {
            // Cambios visuales para modo casa (botón ROJO, mostrar paradas)
            if (paradasWindow) paradasWindow.classList.remove('hidden');
            if (paradasWindow) paradasWindow.classList.add('visible');
            botonCasa.classList.remove('on');
            botonCasa.classList.add('off');
            botonCasa.title = 'Activar GPS (Cambiar a modo Aventura)';
            label.textContent = 'OFF';
            
            // NUEVO: Renderizar la lista de paradas en modo casa
            renderizarListaParadas();
        } else {
            // Cambios visuales para modo aventura (botón VERDE, ocultar paradas)
            if (paradasWindow) paradasWindow.classList.remove('visible');
            if (paradasWindow) paradasWindow.classList.add('hidden');
            botonCasa.classList.remove('off');
            botonCasa.classList.add('on');
            botonCasa.title = 'Desactivar GPS (Cambiar a modo Casa)';
            label.textContent = 'ON';
        }
        
        estado.modo = modo;
        estado.gpsActivo = gpsActivo;
        console.log(`Interfaz actualizada. Modo: ${modo}, GPS: ${estado.gpsActivo ? 'ACTIVADO' : 'DESACTIVADO'}`);
        
        // Gestionar GPS real
        manejarCambioGPS(gpsActivo);
    }
    
    // Función para manejar la activación/desactivación del GPS
    function manejarCambioGPS(activar) {
        if (activar) {
            if (estado.watchId !== null) {
                navigator.geolocation.clearWatch(estado.watchId);
                estado.watchId = null;
            }
            
            if ('geolocation' in navigator) {
                estado.watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const coords = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        
                        console.log('Posición GPS obtenida:', coords);
                        
                        // Notificar al padre la posición actual
                        enviarMensaje('padre', TIPOS_MENSAJE.NAVEGACION.ACTUALIZAR_POSICION, {
                            coordenadas: coords,
                            timestamp: new Date().toISOString()
                        }).catch(err => console.error('Error al enviar posición:', err));
                    },
                    (err) => {
                        console.warn(`ERROR GPS (${err.code}): ${err.message}`);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
                console.log('GPS activado correctamente');
            } else {
                console.error('Geolocation no está soportada en este navegador');
            }
        } else {
            if (estado.watchId !== null) {
                navigator.geolocation.clearWatch(estado.watchId);
                estado.watchId = null;
                console.log('GPS desactivado');
            }
        }
    }
    
    // Función para manejar el cambio de modo - DEFINICIÓN ÚNICA
    async function manejarClickCambioModo() {
        try {
            // Toggle mode
            const nuevoModo = estado.modo === 'casa' ? 'aventura' : 'casa';
            console.log(`🔄 [CASA] Cambiando de modo ${estado.modo} a ${nuevoModo}`);
            
            // Actualizar la interfaz primero para feedback inmediato
            actualizarInterfaz(nuevoModo);
            
            // Enviar el mensaje al padre con el formato exacto esperado
            console.log(`📤 [CASA] Enviando mensaje SISTEMA.CAMBIO_MODO al padre...`);
            await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, { 
                modo: nuevoModo, 
                origen: 'hijo5-casa',
                timestamp: new Date().toISOString()
            });
            
            console.log(`✅ [CASA] Mensaje de cambio a modo ${nuevoModo} enviado correctamente`);
            
            // Actualizar estado interno
            estado.modo = nuevoModo;
            
            // Renderizar lista de paradas si estamos en modo casa
            if (nuevoModo === 'casa') {
                console.log('🏠 [CASA] Mostrando lista de paradas para exploración libre');
                renderizarListaParadas();
            } else {
                console.log('🧭 [CASA] Ocultando lista de paradas en modo aventura');
                // Ocultar la lista de paradas en modo aventura
                const paradasWindow = document.getElementById('paradas-window');
                if (paradasWindow) {
                    paradasWindow.classList.remove('visible');
                    paradasWindow.classList.add('hidden');
                }
            }
        } catch (error) {
            console.error('❌ [CASA] Error al cambiar el modo:', error);
            // Feedback visual del error
            const boton = document.getElementById('gps-casa-btn');
            if (boton) {
                boton.classList.add('error');
                setTimeout(() => boton.classList.remove('error'), 500);
            }
            alert('No se pudo cambiar de modo. Intente de nuevo.');
        }
    }// IMPORTANTE: Exponer la función manejarClickCambioModo al objeto window
    window.manejarClickCambioModo = manejarClickCambioModo;
    console.log('Función manejarClickCambioModo expuesta al window');

    // ========================================
    // MANEJADORES DE MENSAJES
    // ========================================

    // Manejador para recibir cambios de modo desde el padre
    function manejarCambioModo(mensaje) {
        const { modo } = mensaje.datos || {};
        if (!modo) return;
        
        console.log(`Recibido cambio de modo desde ${mensaje.origen || 'origen desconocido'}: ${modo}`);
        
        // Solo actualizar si el modo es diferente
        if (modo !== estado.modo) {
            actualizarInterfaz(modo);
        }
    }
    
    /**
     * Maneja la recepción de datos de paradas desde el padre
     * @param {Object} mensaje - Mensaje con los datos de paradas
     */
    function manejarRecepcionParadas(mensaje) {
        try {
            console.log('Recibiendo datos de paradas:', mensaje);
            const { aventuraParadas, paradas } = mensaje.datos || {};

            // Soporta ambos formatos: aventuraParadas (preferido) o paradas
            const nuevasParadas = Array.isArray(aventuraParadas) ? aventuraParadas
                            : Array.isArray(paradas) ? paradas
                            : null;

            if (!nuevasParadas) {
                console.warn('Mensaje de paradas recibido sin datos válidos');
                return { exito: false, error: 'Formato de datos inválido' };
            }

            // Actualizar array de paradas local
            estado.paradas = nuevasParadas;

            // Actualizar UI con las nuevas paradas
            renderizarListaParadas();

            console.log(`Datos de ${nuevasParadas.length} paradas cargados correctamente`);
            return {
                exito: true,
                paradasCargadas: nuevasParadas.length
            };
        } catch (error) {
            console.error('Error al procesar datos de paradas:', error);
            return {
                exito: false,
                error: error.message
            };
        }
    }

    // Función para renderizar la lista de paradas
    function renderizarListaParadas() {
        const listaParadasContainer = document.getElementById('lista-paradas');
        if (!listaParadasContainer) return;

        // Asegura que el contenedor tenga scroll horizontal y esté vacío antes de renderizar
        listaParadasContainer.style.overflowX = 'auto';
        listaParadasContainer.style.overflowY = 'hidden';
        listaParadasContainer.innerHTML = '';

        // Si ya estamos cargando paradas, no hacemos nada
        if (estado.cargandoParadas) {
            console.log('Ya hay una solicitud de paradas en curso');
            return;
        }
        
        // Usar paradas del estado si ya las tenemos y son válidas
        if (estado.paradas && estado.paradas.length > 0) {
            console.log('Usando paradas del estado interno', estado.paradas);
            renderizarBotonesParadas(listaParadasContainer, estado.paradas);
            return;
        }
        
        // Usar el array local como fallback inmediato
        estado.paradas = puntosRuta;
        renderizarBotonesParadas(listaParadasContainer, puntosRuta);
        
        // Aun así, solicitar datos actualizados de paradas al padre
        console.log('Solicitando paradas actualizadas al padre...');
        
        // Indicar que estamos cargando paradas
        estado.cargandoParadas = true;
        estado.intentosParadas++;
        
        // Solicitar paradas con timeout para evitar esperas infinitas
        const timeout = new Promise((_, reject) => {
            setTimeout(() => reject(new Error('Timeout al solicitar paradas')), 5000);
        });
        
        Promise.race([
            enviarMensaje('padre', TIPOS_MENSAJE.DATOS.SOLICITAR_PARADAS, {
                origen: 'hijo5-casa',
                timestamp: new Date().toISOString(),
                version: '1.0'
            }),
            timeout
        ])
        .then(response => {
            estado.cargandoParadas = false;
            console.log('Paradas recibidas:', response);
            
            // Si se recibió respuesta con paradas, guardarlas y renderizarlas
            if (response && response.paradas && response.paradas.length > 0) {
                estado.paradas = response.paradas; // Guardar en el estado
                renderizarBotonesParadas(listaParadasContainer, estado.paradas);
            }
        })
        .catch(err => {
            estado.cargandoParadas = false;
            console.error('Error al solicitar paradas:', err);
            // Ya tenemos las paradas locales renderizadas, así que no hay problema
        });
    }
    
    // Nueva función para renderizar botones con mejor formato
    function renderizarBotonesParadas(container, paradas) {
        container.innerHTML = '';
        if (!paradas || paradas.length === 0) {
            container.innerHTML = '<div class="sin-paradas">No hay paradas disponibles</div>';
            return;
        }
        paradas.forEach((p, idx) => {
            const btn = document.createElement('button');
            const esParada = p.tipo === 'parada' || p.tipo === 'inicio';
            const esInicio = p.tipo === 'inicio';
            const esActual = (esParada && p.parada === estado.paradaActual) || (!esParada && p.tramo === estado.tramoActual);
            btn.className = 'parada-tramo-btn';
            if (esParada) btn.classList.add('parada-btn');
            if (esInicio) btn.classList.add('inicio-btn');
            if (!esParada) btn.classList.add('tramo-btn');
            if (esActual) btn.classList.add('actual');
            const numero = esParada ? p.parada : p.tramo;
            const icono = esParada ? (esInicio ? '🏁' : '📍') : '🛣️';
            const titulo = esParada ? (esInicio ? 'Inicio' : `Parada ${numero}`) : `Tramo ${numero}`;
            btn.innerHTML = `
              <span class="btn-icon">${icono}</span>
              <span class="btn-title">${titulo}</span>
              <span class="btn-desc">${p.nombre}</span>
            `;
            btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const parada_id = p.parada_id || (p.tipo === 'parada' ? `P-${p.parada}` : (p.tipo === 'inicio' ? `P-${p.parada}` : undefined));
                const tramo_id = p.tramo_id || (p.tipo === 'tramo' ? `TR-${p.tramo}` : undefined);
                await enviarMensaje('padre', TIPOS_MENSAJE.NAVEGACION.CAMBIO_PARADA, { punto: { parada_id, tramo_id } });
            });
            container.appendChild(btn);
        });
    }
    
    // Función para mostrar estado de carga
    function mostrarEstadoCarga(cargando, mensaje = '', esError = false) {
        // Si no existe, crear el elemento de estado
        let estadoElement = document.getElementById('estado-carga');
        if (!estadoElement) {
            estadoElement = document.createElement('div');
            estadoElement.id = 'estado-carga';
            estadoElement.style.cssText = `
                position: fixed; 
                bottom: 10px; 
                left: 50%; 
                transform: translateX(-50%);
                background: rgba(0,0,0,0.7);
                color: white;
                padding: 8px 15px;
                border-radius: 20px;
                font-size: 14px;
                z-index: 10000;
                display: none;
            `;
            document.body.appendChild(estadoElement);
        }
        
        if (cargando) {
            estadoElement.textContent = mensaje || 'Cargando...';
            estadoElement.style.display = 'block';
            estadoElement.style.backgroundColor = 'rgba(0,0,0,0.7)';
        } else if (mensaje) {
            estadoElement.textContent = mensaje;
            estadoElement.style.backgroundColor = esError ? 'rgba(220,53,69,0.9)' : 'rgba(40,167,69,0.9)';
            estadoElement.style.display = 'block';
            setTimeout(() => {
                estadoElement.style.display = 'none';
            }, 3000);
        } else {
            estadoElement.style.display = 'none';
        }
    }
    
    // Inicializa el componente
    async function inicializar() {
        if (estado.inicializado || estado.inicializando) {
            console.log('El componente ya está inicializado o inicializándose');
            return;
        }
        
        estado.inicializando = true;
        console.log('Inicializando componente boton-casa...');
        
        try {
            // Intentar cargar estado guardado de localStorage
            try {
                const savedState = localStorage.getItem('gpsState');
                if (savedState !== null) {
                    estado.gpsActivo = JSON.parse(savedState);
                    estado.modo = estado.gpsActivo ? 'aventura' : 'casa';
                }
            } catch (e) {
                console.warn('Error al cargar estado desde localStorage:', e);
            }
            
            // Mostrar indicador de carga
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) loadingIndicator.style.display = 'flex';
            
            // Inicializar mensajería
            console.log('Inicializando mensajería...');
            await inicializarMensajeria(CONFIG_MENSAJERIA);
            console.log('Mensajería inicializada correctamente');
            
            // Registrar manejadores para los diferentes tipos de mensajes que pueden contener paradas
            registrarControlador(TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, manejarCambioModo);
            registrarControlador(TIPOS_MENSAJE.DATOS.PARADAS, manejarRecepcionParadas);
            registrarControlador(TIPOS_MENSAJE.SISTEMA.ESTADO, manejarEstadoSistema);

            // Registrar para diferentes formatos de datos de paradas
            if (TIPOS_MENSAJE.DATOS.COORDENADAS_PARADAS) {
                registrarControlador(TIPOS_MENSAJE.DATOS.COORDENADAS_PARADAS, manejarRecepcionParadas);
            }
            if (TIPOS_MENSAJE.DATOS.PUNTOS) {
                registrarControlador(TIPOS_MENSAJE.DATOS.PUNTOS, manejarRecepcionParadas);
            }
            if (TIPOS_MENSAJE.DATOS.PUNTOS_RUTA) {
                registrarControlador(TIPOS_MENSAJE.DATOS.PUNTOS_RUTA, manejarRecepcionParadas);
            }
            if (TIPOS_MENSAJE.NAVEGACION.PARADAS) {
                registrarControlador(TIPOS_MENSAJE.NAVEGACION.PARADAS, manejarRecepcionParadas);
            }
            
            console.log('Manejadores registrados');
            
            // Notificar al padre que estamos listos
            await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.COMPONENTE_LISTO, {
                componente: 'hijo5-casa',
                estado: 'listo',
                modo: estado.modo,
                gpsActivo: estado.gpsActivo,
                timestamp: new Date().toISOString(),
                version: '1.0'
            });
            
            // Actualizar estado
            estado.inicializado = true;
            estado.inicializando = false;
            
            // Ocultar indicador de carga
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            
            // Inicializar interfaz
            actualizarInterfaz(estado.modo);
            
            // Ya tenemos las paradas locales, no necesitamos esperar al padre
            console.log('Componente boton-casa inicializado correctamente');
            
        } catch (error) {
            estado.inicializando = false;
            estado.error = error;
            console.error('Error al inicializar componente:', error);
            
            // Notificar al padre el error
            try {
                await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.ERROR, {
                    tipo: 'inicializacion',
                    mensaje: error.message,
                    stack: error.stack,
                    origen: 'hijo5-casa',
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                });
            } catch (e) {
                console.error('Error al notificar error al padre:', e);
            }
            
            // Ocultar indicador de carga
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) loadingIndicator.style.display = 'none';
        }
    }

    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializar);
    } else {
        inicializar().catch(console.error);
    }
    // Función para solicitar información detallada de una parada/tramo al padre
    async function solicitarInfoParadaOTramo({ parada_id, tramo_id }) {
        try {
            const respuesta = await enviarMensaje('padre', TIPOS_MENSAJE.DATOS.SOLICITAR_PARADA, { parada_id, tramo_id });
            if (respuesta && respuesta.parada) {
                // Aquí puedes usar la información recibida (respuesta.parada)
                console.log('Información recibida del padre:', respuesta.parada);
                // Ejemplo: podrías mostrar un modal, actualizar la UI, etc.
            } else {
                console.warn('No se encontró información para la parada/tramo:', parada_id || tramo_id, respuesta?.error);
            }
        } catch (error) {
            console.error('Error al solicitar información al padre:', error);
        }
    }
    </script>
</head>
<body>
  <!-- Loading indicator -->
  <div id="loading-indicator" style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      display: none; /* Hidden by default */
  ">
      <div style="
          background: white;
          padding: 20px;
          border-radius: 8px;
          text-align: center;
      ">
          <div class="spinner"></div>
          <p>Cargando aplicación...</p>
      </div>
  </div>

  <div id="zona-boton-casa" role="region" aria-label="Control de navegación">
    <button id="gps-casa-btn" class="off" title="Activar GPS (Cambiar a modo Aventura)">
      <div class="button-content">
        <span class="satellite-emoji">📡</span>
        <span class="gps-label">OFF</span>
      </div>
    </button>
    <div id="paradas-window" class="hidden">
      <div id="lista-paradas"></div>
    </div>
  </div>
  
  <script>
    // Configurar el botón de GPS
    document.getElementById('gps-casa-btn').addEventListener('click', function() {
      // La lógica de cambio de modo se maneja en el módulo principal
      try {
        // Asegurarnos de que el evento de clic se maneje correctamente y con mejor feedback visual
        this.classList.add('pulsando');
        setTimeout(() => this.classList.remove('pulsando'), 300);
        
        // Llamar a la función de cambio de modo
        if (window.manejarClickCambioModo) {
          window.manejarClickCambioModo();
          // Log para diagnóstico
          console.log('✅ [CASA] Cambio de modo solicitado correctamente');
        } else {
          console.warn('⚠️ [CASA] manejarClickCambioModo no está disponible');
          alert('Error: No se puede cambiar de modo en este momento');
        }
      } catch (e) {
        console.error('❌ [CASA] Error al manejar clic de cambio de modo:', e);
        alert('Error al cambiar de modo: ' + e.message);
      }
    });
    
    // Manejador global de errores no capturados
    window.addEventListener('error', function(event) {
      const error = event.error || new Error(event.message);
      const errorMsg = 'Error no manejado';
      const errorDetails = error instanceof Error ? error.message : String(error);
      
      // Usar logger si está disponible, si no usar console
      const logError = window.logger ? window.logger.error : console.error;
      logError(errorMsg, error);
      
      // Mostrar mensaje de error al usuario
      try {
        const errorContainer = document.createElement('div');
        errorContainer.style.cssText = [
          'position: fixed;',
          'top: 0;',
          'left: 0;',
          'right: 0;',
          'background: #ff4444;',
          'color: white;',
          'padding: 1rem;',
          'z-index: 10000;',
          'text-align: center;',
          'font-family: Arial, sans-serif;'
        ].join(' ');
        
        errorContainer.textContent = `${errorMsg}: ${errorDetails}`;
        document.body.prepend(errorContainer);
      } catch (e) {
        if (window.logger) {
          logger.error('No se pudo mostrar el mensaje de error:', e);
        } else {
          console.error('No se pudo mostrar el mensaje de error:', e);
        }
      }
    });
  </script>
</body>
</html>
