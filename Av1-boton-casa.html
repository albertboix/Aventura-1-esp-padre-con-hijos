<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPS Casa ON/OFF</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    html, body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      background: transparent;
      font-family: sans-serif;
      user-select: none;
      overflow: hidden;
    }
    #contenedor-flex {
      display: flex;
      flex-direction: column;
      width: 100vw;
      height: 100vh;
      box-sizing: border-box;
    }
    #zona-boton-casa {
      height: 99px; /* 75px botón + 12px top + 12px bottom (ajusta si hace falta) */
      flex-shrink: 0;
      display: flex;
      align-items: flex-start;
    }
    #gps-casa-btn {
      margin-left: 12px;
      margin-top: 12px;
      width: 75px; height: 75px; background: white;
      border-radius: 18px; box-shadow: 0 2px 12px rgba(0,0,0,0.13);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      cursor: pointer; z-index: 10001; border: 2px solid #eee;
      transition: box-shadow 0.2s; padding: 0; gap: 2px;
    }
    #gps-casa-btn .casa-icon {
      font-size: 2.3em; margin-bottom: 2px; transition: color 0.2s;
    }
    #gps-casa-btn .gps-label {
      font-size: 1.1em; font-weight: bold; letter-spacing: 1px; margin-top: 0;
      transition: color 0.2s; user-select: none;
    }
    #gps-casa-btn.on .casa-icon, #gps-casa-btn.on .gps-label { color: #e53935; }
    #gps-casa-btn.off .casa-icon, #gps-casa-btn.off .gps-label { color: #43a047; }
    #paradas-window {
      flex: 1 1 auto;
      position: relative;
      background: white;
      border-radius: 5px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.13);
      z-index: 10002;
      display: none;
      flex-direction: column;
      padding: 2px 4px 4px 4px;
      border: 1px solid #ddd;
      animation: fadeIn 0.18s;
      width: 100%;
      box-sizing: border-box;
      min-height: 0;
      min-width: 0;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px);} to { opacity: 1; transform: translateY(0);} }
    #paradas-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;
      width: 100%;
      box-sizing: border-box;
    }
    #estado-modo {
      font-size: 0.9em;
      color: #666;
      background: #f0f0f0;
      padding: 3px 8px;
      border-radius: 12px;
      margin-right: auto;
    }
    #cerrar-paradas {
      background: none; border: none; font-size: 1.3em; color: #888; cursor: pointer;
      padding: 2px 8px 2px 2px; border-radius: 6px; transition: background 0.15s;
    }
    #cerrar-paradas:hover { background: #eee; color: #e53935; }
    #paradas-list {
      display: flex; flex-direction: column; gap: 4px; overflow-y: auto; max-height: 100%;
      min-height: 0; padding-right: 0; width: 100%; box-sizing: border-box;
      flex: 1 1 auto;
    }
    .parada-btn {
      background: linear-gradient(90deg, #007aff 0%, #00c6ff 100%);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 6px 5px;
      font-size: 1em;
      cursor: pointer;
      text-align: left;
      transition: background 0.18s, color 0.18s;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
      font-family: inherit;
      word-break: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      line-height: 1.2;
      width: 100%;
      display: block;
      box-sizing: border-box;
    }
    .parada-btn:hover {
      background: linear-gradient(90deg, #0056b3 0%, #00aaff 100%); color: #e0ffe0;
    }
    .parada-btn.actual {
      background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
      border: 2px solid #155724;
    }
    @media (max-width: 300px) {
      #gps-casa-btn { width: 62px; height: 62px; }
      #zona-boton-casa { height: 70px; }
      #paradas-window { width: 40vw; }
    }
  </style>
</head>
<body>
  <div id="contenedor-flex">
    <div id="zona-boton-casa">
      <div id="gps-casa-btn" class="on" title="Activar GPS">
        <span class="casa-icon"><i class="fa-solid fa-house"></i></span>
        <span class="gps-label">ON</span>
      </div>
    </div>
    <div id="paradas-window">
      <div id="paradas-header">
        <span id="estado-modo">Modo: Aventura</span>
        <button id="cerrar-paradas" title="Cerrar paradas"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="paradas-list"></div>
    </div>
  </div>
  <script>
    // Lista de paradas (con coordenadas)
    const paradas = [
      { nombre: "Torres de Serranos (start)", lat: 39.47876, lng: -0.37626 },
      { nombre: "Puente de Serranos – Plaza de la crida", lat: 39.47959, lng: -0.37583 },
      { nombre: "Cortes Valencianas (Palacio de los Borgia)", lat: 39.47785, lng: -0.37485 },
      { nombre: "Plaza de la Virgen", lat: 39.47656, lng: -0.37529 },
      { nombre: "Plaza de la Almoína", lat: 39.47604, lng: -0.37451 },
      { nombre: "Catedral de València", lat: 39.47594, lng: -0.37474 },
      { nombre: "Plaza decimo Juno Bruto (Museo Arqueológico de la Almoína)", lat: 39.4762, lng: -0.37412 },
      { nombre: "Basílica de València", lat: 39.47611, lng: -0.37478 },
      { nombre: "Palacio Arzobispal", lat: 39.4755, lng: -0.37436 },
      { nombre: "Plaza del Ayuntamiento", lat: 39.47056, lng: -0.37677 },
      { nombre: "Edificio del Ayuntamiento de València", lat: 39.46971, lng: -0.37693 },
      { nombre: "Estación de Ferrocarril (Estación del Norte)", lat: 39.46722, lng: -0.37702 },
      { nombre: "Plaza de Toros de València", lat: 39.46709, lng: -0.37595 },
      { nombre: "Casa estilo Árabe", lat: 39.46753, lng: -0.37511 },
      { nombre: "Palacio de Comunicaciones (Correos)", lat: 39.46942, lng: -0.37559 },
      { nombre: "Antigua sede del Banco de València", lat: 39.47061, lng: -0.37408 },
      { nombre: "Palacio del Marqués de Dos Aguas (Museo Nacional de Crámica)", lat: 39.47276, lng: -0.37467 },
      { nombre: "Mercado Central", lat: 39.47377, lng: -0.37832 },
      { nombre: "San Juan del Mercado (Iglesia de los Santos Juanes)", lat: 39.47425, lng: -0.37895 },
      { nombre: "Lonja de València (Mercado de la Seda)", lat: 39.47426, lng: -0.37862 },
      { nombre: "Plaza del Doctor Collado", lat: 39.47444, lng: -0.3779 },
      { nombre: "Plaza del Negrito (Fuente del Negrito)", lat: 39.47611, lng: -0.37741 },
      { nombre: "Calle Caballeros", lat: 39.47663, lng: -0.3773 },
      { nombre: "Palacio de la Generalitat", lat: 39.47668, lng: -0.37671 },
      { nombre: "Calle de los Serranos (end)", lat: 39.47773, lng: -0.37671 }
    ];

    // Estado GPS: true = ON (aventura), false = OFF (casa)
    let gpsOn = true;
    let modoCasa = false; // Estado del modo actual
    let paradaActual = 0; // Parada actual del hijo 2
    let estadoModo = document.getElementById('estado-modo');

    // ================ FUNCIONES PRINCIPALES ================
    
    // Cambia el estado del botón y la etiqueta
    function setGpsState(on) {
      gpsOn = on;
      modoCasa = !on; // ON = aventura (false), OFF = casa (true)
      
      const btn = document.getElementById('gps-casa-btn');
      btn.className = on ? 'on' : 'off';
      btn.querySelector('.gps-label').textContent = on ? 'ON' : 'OFF';
      
      // Actualizar indicador de modo
      actualizarIndicadorModo();
      
      // Comunicar cambio de modo al hijo 2
      if (modoCasa) {
        enviarMensajeAHijo2({
          tipo: 'boton-casa-activado',
          modoCasa: true
        });
      } else {
        enviarMensajeAHijo2({
          tipo: 'boton-casa-desactivado',
          modoCasa: false
        });
      }
    }
    
    function actualizarIndicadorModo() {
      estadoModo.textContent = `Modo: ${modoCasa ? 'Casa' : 'Aventura'}`;
      estadoModo.style.background = modoCasa ? '#ffe0e0' : '#e0f7fa';
      estadoModo.style.color = modoCasa ? '#c62828' : '#00695c';
    }

    // Mostrar/ocultar ventana de paradas
    function mostrarParadas() {
      if (!gpsOn) {
        document.getElementById('paradas-window').style.display = 'flex';
        renderParadas();
      }
    }
    
    function ocultarParadas() {
      document.getElementById('paradas-window').style.display = 'none';
    }

    // Renderiza la lista de paradas con indicador de parada actual
    function renderParadas() {
      const lista = document.getElementById('paradas-list');
      lista.innerHTML = '';
      paradas.forEach((p, i) => {
        const btn = document.createElement('button');
        btn.className = 'parada-btn';
        if (i === paradaActual) {
          btn.classList.add('actual');
        }
        btn.textContent = `${i + 1}. ${p.nombre}`;
        btn.onclick = () => {
          // Seleccionar parada y actualizar parada actual
          paradaActual = i;
          window.parent.postMessage({ 
            type: 'seleccionParada', 
            index: i, 
            lat: p.lat, 
            lng: p.lng 
          }, '*');
          
          // Notificar al hijo 2 del cambio de parada
          enviarMensajeAHijo2({
            tipo: 'cambio-parada-actual',
            parada: i
          });
          
          // Re-renderizar para actualizar el indicador
          renderParadas();
        };
        lista.appendChild(btn);
      });
    }

    // ================ COMUNICACIÓN CON EL HIJO 2 ================
    
    function enviarMensajeAHijo2(mensaje) {
      // Enviar mensaje específicamente al hijo 2 a través del padre
      window.parent.postMessage({
        tipo: 'mensaje-para-hijo2',
        mensaje: mensaje
      }, '*');
    }
    
    function solicitarEstadoAHijo2() {
      enviarMensajeAHijo2({
        tipo: 'solicitar-estado-modo'
      });
    }

    // ================ EVENTOS ================
    
    // Click en el botón principal
    document.getElementById('gps-casa-btn').onclick = function() {
      if (gpsOn) {
        // Cambia a OFF (modo casa) y muestra paradas
        setGpsState(false);
        mostrarParadas();
        window.parent.postMessage({ type: 'gpsStatus', on: false }, '*');
      } else {
        // Cambia a ON (modo aventura) y oculta paradas
        setGpsState(true);
        ocultarParadas();
        window.parent.postMessage({ type: 'gpsStatus', on: true }, '*');
      }
    };

    // Cerrar ventana de paradas
    document.getElementById('cerrar-paradas').onclick = function() {
      ocultarParadas();
      window.parent.postMessage({ type: 'cerrarParadas' }, '*');
    };

    // ================ COMUNICACIÓN CON EL PADRE Y HIJO 2 ================
    
    window.addEventListener('message', (event) => {
      const data = event.data;
      
      // ========== MENSAJES DEL PADRE ==========
      
      // Permite al padre forzar el estado GPS
      if (data && data.type === 'gpsStatus') {
        setGpsState(!!data.on);
        if (!data.on) mostrarParadas();
        else ocultarParadas();
      }
      
      // ========== MENSAJES DEL HIJO 2 ==========
      
      // El hijo 2 confirma que activó modo casa
      if (data && data.tipo === 'confirmacion-modo-casa') {
        if (data.activo && !modoCasa) {
          // Sincronizar estado si no estamos en modo casa
          setGpsState(false);
          mostrarParadas();
        }
      }
      
      // El hijo 2 confirma que activó modo aventura
      if (data && data.tipo === 'confirmacion-modo-aventura') {
        if (data.activo && modoCasa) {
          // Sincronizar estado si estamos en modo casa
          setGpsState(true);
          ocultarParadas();
        }
      }
      
      // El hijo 2 nos envía su estado actual
      if (data && data.tipo === 'estado-modo-actual') {
        modoCasa = data.modoCasa;
        paradaActual = data.paradaActual || 0;
        
        // Sincronizar estado del botón
        setGpsState(!modoCasa);
        
        // Actualizar interfaz
        if (modoCasa && document.getElementById('paradas-window').style.display === 'flex') {
          renderParadas();
        }
      }
      
      // El hijo 2 cambió de parada
      if (data && data.tipo === 'cambio-parada-actual') {
        paradaActual = data.parada;
        
        // Si la ventana de paradas está abierta, re-renderizar
        if (document.getElementById('paradas-window').style.display === 'flex') {
          renderParadas();
        }
      }
    });
    
    // ================ INICIALIZACIÓN ================
    
    // Al cargar, solicitar estado actual del hijo 2
    document.addEventListener('DOMContentLoaded', () => {
      // Inicializar interfaz
      actualizarIndicadorModo();
      
      // Solicitar estado al hijo 2 después de un breve delay
      setTimeout(() => {
        solicitarEstadoAHijo2();
      }, 1000);
    });
  </script>
</body>
</html>
