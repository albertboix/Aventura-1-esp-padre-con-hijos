<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPS Casa ON/OFF</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    html, body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      background: transparent;
      font-family: sans-serif;
      user-select: none;
      overflow: hidden;
    }
    #contenedor-flex {
      display: flex;
      flex-direction: column;
      width: 100vw;
      height: 100vh;
      box-sizing: border-box;
    }
    #zona-boton-casa {
      height: 99px;
      flex-shrink: 0;
      display: flex;
      align-items: flex-start;
    }
    #gps-casa-btn {
      margin-left: 12px;
      margin-top: 12px;
      width: 75px; 
      height: 75px; 
      background: white;
      border-radius: 18px; 
      box-shadow: 0 2px 12px rgba(0,0,0,0.13);
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center;
      cursor: pointer; 
      z-index: 10001; 
      border: 2px solid #eee;
      transition: box-shadow 0.2s; 
      padding: 0; 
      gap: 2px;
    }
    #gps-casa-btn .casa-icon {
      font-size: 2.3em; 
      margin-bottom: 2px; 
      transition: color 0.2s;
    }
    #gps-casa-btn .gps-label {
      font-size: 1.1em; 
      font-weight: bold; 
      letter-spacing: 1px; 
      margin-top: 0;
      transition: color 0.2s; 
      user-select: none;
    }
    #gps-casa-btn.on .casa-icon, 
    #gps-casa-btn.on .gps-label { 
      color: #e53935; 
    }
    #gps-casa-btn.off .casa-icon, 
    #gps-casa-btn.off .gps-label { 
      color: #43a047; 
    }
    #paradas-window {
      flex: 1 1 auto;
      position: relative;
      background: white;
      border-radius: 5px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.13);
      z-index: 10002;
      display: none;
      flex-direction: column;
      padding: 2px 2px 4px 2px;
      border: 1px solid #ddd;
      animation: fadeIn 0.18s;
      width: 100%;
      box-sizing: border-box;
      min-height: 0;
      min-width: 0;
      margin-right: 2px;
    }
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(-10px);} 
      to { opacity: 1; transform: translateY(0);} 
    }
    #paradas-header {
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 6px;
      width: 100%;
      box-sizing: border-box;
    }
    #estado-modo {
      font-size: 0.9em;
      color: #666;
      background: #f0f0f0;
      padding: 3px 8px;
      border-radius: 12px;
      margin-right: auto;
    }
    #cerrar-paradas {
      background: none; 
      border: none; 
      font-size: 1.3em; 
      color: #888; 
      cursor: pointer;
      padding: 2px 8px 2px 2px; 
      border-radius: 6px; 
      transition: background 0.15s;
    }
    #cerrar-paradas:hover { 
      background: #eee; 
      color: #e53935; 
    }
    #paradas-list {
      display: flex; 
      flex-direction: column; 
      gap: 4px; 
      overflow-y: auto; 
      max-height: 100%;
      min-height: 0; 
      padding-right: 0; 
      width: 100%; 
      box-sizing: border-box;
      flex: 1 1 auto;
    }
    .parada-btn, .tramo-btn {
      background: linear-gradient(90deg, #007aff 0%, #00c6ff 100%);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 6px 5px;
      font-size: 1em;
      cursor: pointer;
      text-align: left;
      transition: all 0.18s;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
      font-family: inherit;
      word-break: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      line-height: 1.2;
      width: 100%;
      display: block;
      box-sizing: border-box;
      position: relative;
      padding-left: 10px;
    }
    .tramo-btn {
      background: linear-gradient(90deg, #8e44ad 0%, #9b59b6 100%);
    }
    .parada-btn:hover {
      background: linear-gradient(90deg, #0056b3 0%, #00aaff 100%); 
      color: #e0ffe0;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .tramo-btn:hover {
      background: linear-gradient(90deg, #7d3c98 0%, #8e44ad 100%);
      color: #f0f0f0;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .parada-btn.actual, .tramo-btn.actual {
      border: 2px solid #155724;
      box-shadow: 0 0 0 2px #28a745;
      z-index: 2;
    }
    .parada-btn.actual {
      background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
    }
    .tramo-btn.actual {
      background: linear-gradient(90deg, #9b59b6 0%, #8e44ad 100%);
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 0.75em;
      font-weight: bold;
      margin-right: 6px;
      min-width: 22px;
      text-align: center;
    }
    .badge-parada {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    .badge-tramo {
      background: rgba(255,255,255,0.3);
      color: white;
    }
    @media (max-width: 300px) {
      #gps-casa-btn { 
        width: 62px; 
        height: 62px; 
      }
      #zona-boton-casa { 
        height: 70px;
      }
      #paradas-window { 
        width: 40vw; 
      }
    }
  </style>
</head>
<body>
  <div id="contenedor-flex">
    <div id="zona-boton-casa">
      <div id="gps-casa-btn" class="on" title="Activar GPS">
        <span class="casa-icon"><i class="fa-solid fa-house"></i></span>
        <span class="gps-label">ON</span>
      </div>
    </div>
    <div id="paradas-window">
      <div id="paradas-header">
        <span id="estado-modo">Modo: Aventura</span>
        <button id="cerrar-paradas" title="Cerrar paradas"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="paradas-list"></div>
    </div>
  </div>

  <script>
    // ================== ARRAY DE PARADAS Y TRAMOS ==================
    // Estructura unificada que combina paradas y tramos en orden secuencial
    const puntosRuta = [
      {
        tipo: "inicio",
        parada: 0,
        nombre: "Torres de Serranos (start)",
      },
      {
        tipo: "tramo",
        tramo: 1,
        nombre: "Torres de Serranos → Plaza de la crida (Puente de Serranos)",
      },
      {
        tipo: "parada",
        parada: 1,
        nombre: "Plaza de la crida (Puente de Serranos)",
      },
      {
        tipo: "tramo",
        tramo: 2,
        nombre: "Plaza de la crida → Calle Muro de Santa Ana",
      },
      {
        tipo: "parada",
        parada: 2,
        nombre: "Calle Muro de Santa Ana",
      },
      {
        tipo: "tramo",
        tramo: 3,
        nombre: "Calle Muro de Santa Ana → Palacio de los Borgia",
      },
      {
        tipo: "parada",
        parada: 3,
        nombre: "Iglesia de San Lorenzo",
      },
      {
        tipo: "tramo",
        tramo: 4,
        nombre: "Iglesia de San Lorenzo → Plaza de la Virgen",
      },
      {
        tipo: "parada",
        parada: 4,
        nombre: "Plaza de la Virgen Reto 6",
      },
      {
        tipo: "parada",
        parada: 5,
        nombre: "Plaza de la Virgen Reto 7",
      },
      {
        tipo: "tramo",
        tramo: 5,
        nombre: "Plaza de la Virgen → Plaza de la Almoína",
      },
      {
        tipo: "parada",
        parada: 6,
        nombre: "Panel cerámico muro Catedral",
      },
      {
        tipo: "parada",
        parada: 7,
        nombre: "Capilla exterior catedral Reto 10",
      },
      {
        tipo: "parada",
        parada: 8,
        nombre: "Capilla exterior catedral Reto 11",
      },
      {
        tipo: "parada",
        parada: 9,
        nombre: "Arco Novo Catedral y Puerta Negra Basílica",
      },
      {
        tipo: "parada",
        parada: 10,
        nombre: "Casa del Punt de Gantxo",
      },
      {
        tipo: "tramo",
        tramo: 6,
        nombre: "Plaza de la Almoína → Plaza Decimo Junio Bruto (Museo Arqueológico de la Almoína)",
      },
      {
        tipo: "parada",
        parada: 11,
        nombre: "Museo arqueológico La Almoína",
      },
      {
        tipo: "parada",
        parada: 12,
        nombre: "Museo arqueológico La Almoína",
      },
      {
        tipo: "parada",
        parada: 13,
        nombre: "Vista de la Catedral, Cimborrio",
      },
      {
        tipo: "tramo",
        tramo: 7,
        nombre: "Museo arqueológico La Almoína → Palacio Arzobispal",
      },
      {
        tipo: "parada",
        parada: 14,
        nombre: "Palacio Arzobispal y Puerta Románica de la Catedral",
      },
      {
        tipo: "parada",
        parada: 15,
        nombre: "Puerta Románica de la Catedral",
      },
      {
        tipo: "tramo",
        tramo: 8,
        nombre: "Puerta Románica de la Catedral → Plaza del Ayuntamiento",
      },
      {
        tipo: "parada",
        parada: 16,
        nombre: "Plaza del Ayuntamiento",
      },
      {
        tipo: "tramo",
        tramo: 9,
        nombre: "Plaza del Ayuntamiento → Edificio del Ayuntamiento de València",
      },
      {
        tipo: "parada",
        parada: 17,
        nombre: "Edificio del Ayuntamiento",
      },
      {
        tipo: "parada",
        parada: 18,
        nombre: "Edificio del Ayuntamiento",
      },
      {
        tipo: "tramo",
        tramo: 10,
        nombre: "Edificio del Ayuntamiento → Estación del Norte",
      },
      {
        tipo: "parada",
        parada: 19,
        nombre: "Estación del Norte",
      },
      {
        tipo: "tramo",
        tramo: 11,
        nombre: "Estación del Norte → Plaza de Toros de València",
      },
      {
        tipo: "tramo",
        tramo: 12,
        nombre: "Plaza de Toros → Casa estilo Árabe",
      },
      {
        tipo: "parada",
        parada: 20,
        nombre: "Casa estilo Árabe",
      },
      {
        tipo: "parada",
        parada: 21,
        nombre: "Casa estilo Árabe, mitad Aventura",
      },
      {
        tipo: "tramo",
        tramo: 13,
        nombre: "Casa estilo Árabe → Palacio de Comunicaciones (Correos)",
      },
      {
        tipo: "parada",
        parada: 22,
        nombre: "Palacio de Comunicaciones: Correos",
      },
      {
        tipo: "parada",
        parada: 23,
        nombre: "Edificio Suay",
      },
      {
        tipo: "tramo",
        tramo: 14,
        nombre: "Palacio de Comunicaciones → Banco de València",
      },
      {
        tipo: "parada",
        parada: 24,
        nombre: "Banco de Valencia",
      },
      {
        tipo: "tramo",
        tramo: 15,
        nombre: "Banco de València → Palacio del Marqués de Dos Aguas (Museo Nacional de Cerámica)",
      },
      {
        tipo: "parada",
        parada: 25,
        nombre: "Palacio del Marqués de Dos Aguas (Museo Nacional de Cerámica)",
      },
      {
        tipo: "tramo",
        tramo: 16,
        nombre: "Palacio del Marqués → Mercado Central",
      },
      {
        tipo: "parada",
        parada: 26,
        nombre: "Mercado central",
      },
      {
        tipo: "tramo",
        tramo: 17,
        nombre: "Mercado Central → Lonja de la Seda",
      },
      {
        tipo: "parada",
        parada: 27,
        nombre: "Lonja de la Seda",
      },
      {
        tipo: "tramo",
        tramo: 18,
        nombre: "Lonja de la Seda → Plaza Redonda",
      },
      {
        tipo: "parada",
        parada: 28,
        nombre: "Plaza Redonda",
      },
      {
        tipo: "tramo",
        tramo: 19,
        nombre: "Plaza Redonda → Iglesia de los Santos Juanes",
      },
      {
        tipo: "parada",
        parada: 29,
        nombre: "Iglesia de los Santos Juanes",
      },
      {
        tipo: "tramo",
        tramo: 20,
        nombre: "Iglesia de los Santos Juanes → Mercado Central",
      },
      {
        tipo: "tramo",
        tramo: 21,
        nombre: "Mercado Central → Palacio de la Generalitat",
      },
      {
        tipo: "parada",
        parada: 30,
        nombre: "Palau de la Generalitat",
      },
      {
        tipo: "tramo",
        tramo: 22,
        nombre: "Palacio de la Generalitat → Torres de Serranos (Final)",
      },
      {
        tipo: "parada",
        parada: 31,
        nombre: "Torres de Serranos (Final)",
      }
    ];

    // Variables para rastrear el estado local
    let paradas = [];
    let tramos = [];
    let modoCasa = true; // Iniciar en modo casa por defecto
    let paradaActual = -1;
    let tramoActual = -1;
    
    // Estado local sincronizado con el padre
    let estadoLocal = {
        modo: 'casa',
        puntoActual: null,
        ultimaActualizacion: 0
    };
    
    // Referencia al iframe padre
    const padre = window.parent;

    // Estado GPS: true = ON (aventura), false = OFF (casa)
    let gpsOn = true;
    let estadoModo = document.getElementById('estado-modo');

    // ================ FUNCIONES PRINCIPALES ================
    
    // Cambia el estado del botón y la etiqueta, y sincroniza con el estado global
    function setGpsState(on) {
        console.log(`🔄 HIJO 5: setGpsState(${on}) - Estado actual: gpsOn=${gpsOn}, modoCasa=${modoCasa}`);
        
        // Si el estado no ha cambiado, no hacer nada
        if (gpsOn === on) {
            console.log('🔄 El estado del GPS no ha cambiado, ignorando...');
            return;
        }
        
        // Actualizar estado local
        gpsOn = on;
        modoCasa = !on;
        
        // Actualizar estado local sincronizado
        estadoLocal.modo = modoCasa ? 'casa' : 'aventura';
        estadoLocal.ultimaActualizacion = Date.now();
        
        // Actualizar UI
        const btn = document.getElementById('gps-casa-btn');
        if (btn) {
            btn.className = on ? 'on' : 'off';
            const label = btn.querySelector('.gps-label');
            if (label) {
                label.textContent = on ? 'ON' : 'OFF';
            }
            btn.title = on ? 'Desactivar GPS' : 'Activar GPS';
        }
        
        // Actualizar indicador de modo
        actualizarIndicadorModo();
        
        // Obtener el punto actual (parada o tramo)
        let puntoActual = null;
        if (paradaActual >= 0) {
            puntoActual = { tipo: 'parada', id: paradaActual };
        } else if (tramoActual >= 0) {
            puntoActual = { tipo: 'tramo', id: tramoActual };
        }
        
        // Notificar al padre sobre el cambio de estado
        const mensajePadre = {
            type: 'actualizarModo',
            modo: estadoLocal.modo,
            origen: 'hijo5',
            timestamp: estadoLocal.ultimaActualizacion,
            puntoActual: puntoActual
        };
        
        console.log('📤 HIJO 5: Notificando cambio de estado al padre:', mensajePadre);
        window.parent.postMessage(mensajePadre, '*');
        
        if (modoCasa) {
            console.log('🏠 Modo casa activado - Configurando modo simulación');
            
            // Si hay un punto actual, notificar a los componentes
            if (puntoActual) {
                const punto = puntosRuta.find(p => 
                    (p.tipo === 'parada' && p.parada === puntoActual.id) || 
                    (p.tipo === 'tramo' && p.tramo === puntoActual.id)
                );
                
                if (punto) {
                    console.log(`🏠 Notificando punto actual a los componentes:`, punto);
                    
                    // Notificar al hijo 2 (mapa) sobre la ubicación simulada
                    const coords = punto.tipo === 'parada' ? 
                        punto.coordenadas : 
                        (punto.inicio || (punto.waypoints && punto.waypoints[0]) || { lat: 39.4699, lng: -0.3763 });
                    
                    window.parent.postMessage({
                        tipo: 'mensaje-para-hijo2',
                        mensaje: {
                            type: 'simularUbicacion',
                            coordenadas: coords,
                            [punto.tipo + 'Id']: punto.tipo === 'parada' ? punto.parada : punto.tramo,
                            modoCasa: true
                        }
                    }, '*');
                    
                    // Si es una parada, notificar al hijo 3 (audio) y 4 (retos)
                    if (punto.tipo === 'parada' && punto.audio) {
                        window.parent.postMessage({
                            tipo: 'mensaje-para-hijo3',
                            mensaje: {
                                type: 'cargarAudio',
                                src: punto.audio,
                                paradaId: punto.parada,
                                autoplay: true
                            }
                        }, '*');
                        
                        if (punto.reto) {
                            window.parent.postMessage({
                                tipo: 'mensaje-para-hijo4',
                                mensaje: {
                                    type: 'mostrarReto',
                                    paradaId: punto.parada,
                                    modoCasa: true
                                }
                            }, '*');
                        }
                    } 
                    // Si es un tramo, notificar al hijo 3 (video) si hay video
                    else if (punto.tipo === 'tramo' && punto.video) {
                        window.parent.postMessage({
                            tipo: 'mensaje-para-hijo3',
                            mensaje: {
                                type: 'cargarVideo',
                                src: punto.video,
                                tramoId: punto.tramo,
                                autoplay: true
                            }
                        }, '*');
                    }
                }
            }
            
            // Mostrar la ventana de selección de paradas/tramos
            mostrarParadasYTramos();
        } else {
            console.log('🌍 Modo GPS activado - Reanudando seguimiento de ubicación');
            // Notificar al hijo 2 (botones) para reanudar el seguimiento GPS
            window.parent.postMessage({
                tipo: 'mensaje-para-hijo2',
                mensaje: {
                    type: 'iniciarGPS',
                    motivo: 'modo_aventura_activado'
                }
            }, '*');
            
            // Ocultar la ventana de selección de paradas/tramos
            ocultarParadas();
        }
        
        console.log(`✅ HIJO 5: setGpsState completado - Nuevo estado: gpsOn=${gpsOn}, modoCasa=${modoCasa}`);
    }
    
    function actualizarIndicadorModo() {
      estadoModo.textContent = `Modo: ${modoCasa ? 'Casa' : 'Aventura'}`;
      estadoModo.style.background = modoCasa ? '#ffe0e0' : '#e0f7fa';
      estadoModo.style.color = modoCasa ? '#c62828' : '#00695c';
    }

    // Mostrar/ocultar ventana de paradas y tramos
    function mostrarParadasYTramos() {
      console.log(`📋 HIJO 5: Mostrar paradas y tramos - gpsOn: ${gpsOn}, modoCasa: ${modoCasa}`);
      if (!gpsOn) {
        document.getElementById('paradas-window').style.display = 'flex';
        renderParadasYTramos();
        console.log('✅ HIJO 5: Ventana de paradas y tramos mostrada');
        
        window.parent.postMessage({ 
          type: 'expandirIframe', 
          width: '250px',
          debug: 'Expansión para mostrar paradas y tramos'
        }, '*');
      } else {
        console.log('⚠️ HIJO 5: No se puede mostrar - GPS está ON');
      }
    }
    
    function ocultarParadas() {
      console.log('❌ HIJO 5: Ocultando ventana de paradas y tramos');
      document.getElementById('paradas-window').style.display = 'none';
      
      window.parent.postMessage({ 
        type: 'contraerIframe', 
        width: '80px',
        debug: 'Contraer ventana de paradas'
      }, '*');
    }

    // Inicializar las listas de paradas y tramos desde la estructura unificada
    function inicializarPuntosRuta() {
      paradas = [];
      tramos = [];
      
      puntosRuta.forEach((punto, index) => {
        if (punto.tipo === 'parada' || punto.tipo === 'inicio') {
          paradas.push({
            id: punto.parada,
            nombre: punto.nombre,
            coordenadas: punto.coordenadas,
            imagen: punto.imagen,
            audio: punto.audio || `audio/parada_${punto.parada}.mp3`,
            esInicio: punto.tipo === 'inicio'
          });
        } else if (punto.tipo === 'tramo') {
          tramos.push({
            id: punto.tramo,
            nombre: punto.nombre,
            inicio: punto.inicio,
            fin: punto.fin,
            waypoints: punto.waypoints || [],
            imagen: punto.imagen,
            video: punto.video,
            origen: puntosRuta[index - 1].parada, // La parada anterior
            destino: puntosRuta[index + 1].parada  // La siguiente parada
          });
        }
      });
    }

    // Renderiza la lista de paradas y tramos
    function renderParadasYTramos() {
      const lista = document.getElementById('paradas-list');
      lista.innerHTML = '';
      
      // Recorrer la estructura unificada de puntos de ruta
      puntosRuta.forEach((punto, index) => {
        if (punto.tipo === 'parada' || punto.tipo === 'inicio') {
          // Crear botón para parada
          const btn = document.createElement('button');
          btn.className = 'parada-btn';
          
          // Resaltar si es la parada actual
          if (punto.parada === paradaActual && tramoActual === -1) {
            btn.classList.add('actual');
          }
          
          // Construir el contenido del botón
          btn.innerHTML = `
            <span class="badge badge-parada">P${punto.parada}</span>
            ${punto.nombre}
          `;
          
          // Manejar clic en la parada
          btn.onclick = () => {
            // Actualizar estado local
            paradaActual = punto.parada;
            tramoActual = -1;
            
            // Actualizar estado local sincronizado
            estadoLocal.puntoActual = { 
              tipo: 'parada', 
              id: paradaActual,
              datos: punto
            };
            estadoLocal.ultimaActualizacion = Date.now();
            
            // Notificar al padre sobre el cambio de punto actual
            const mensajePadre = {
              type: 'actualizarPuntoActual',
              puntoActual: estadoLocal.puntoActual,
              origen: 'hijo5',
              timestamp: estadoLocal.ultimaActualizacion
            };
            
            console.log('📤 HIJO 5: Notificando cambio de parada al padre:', mensajePadre);
            padre.postMessage(mensajePadre, '*');
            
            // Actualizar UI
            renderParadasYTramos();
            
            // Si el GPS está apagado, simular que estamos en la ubicación seleccionada
            if (modoCasa) {
              // Notificar al hijo 2 (botones) para desbloquear funcionalidades
              window.parent.postMessage({
                tipo: 'mensaje-para-hijo2',
                mensaje: {
                  type: 'simularUbicacion',
                  coordenadas: punto.coordenadas,
                  paradaId: punto.parada,
                  modoCasa: true
                }
              }, '*');
              
              // Notificar al hijo 3 (audio) para cargar el audio de la parada
              if (punto.audio) {
                window.parent.postMessage({
                  tipo: 'mensaje-para-hijo3',
                  mensaje: {
                    type: 'cargarAudio',
                    src: punto.audio,
                    paradaId: punto.parada,
                    autoplay: true
                  }
                }, '*');
              }
              
              // Notificar al hijo 4 (retos) para mostrar el reto correspondiente
              window.parent.postMessage({
                tipo: 'mensaje-para-hijo4',
                mensaje: {
                  type: 'mostrarReto',
                  paradaId: punto.parada,
                  modoCasa: true
                }
              }, '*');
            } else {
              // Si el GPS está activo, comportamiento normal
              if (punto.audio) {
                const mensajeAudio = {
                  tipo: 'mensaje-para-hijo3',
                  mensaje: {
                    type: 'cargarAudio',
                    src: punto.audio,
                    paradaId: punto.parada
                  }
                };
                window.parent.postMessage(mensajeAudio, '*');
                
                // Reproducir automáticamente
                setTimeout(() => {
                  window.parent.postMessage({
                    tipo: 'mensaje-para-hijo3',
                    mensaje: { type: 'play' }
                  }, '*');
                }, 300);
              }
              
              // Mostrar reto correspondiente
              window.parent.postMessage({
                tipo: 'mensaje-para-hijo4',
                mensaje: {
                  type: 'mostrarReto',
                  paradaId: punto.parada
                }
              }, '*');
            }
            
            // Actualizar la vista
            renderParadasYTramos();
          };
          
          lista.appendChild(btn);
          
        } else if (punto.tipo === 'tramo') {
          // Crear botón para tramo
          const tramoBtn = document.createElement('button');
          tramoBtn.className = 'tramo-btn';
          
          // Resaltar si es el tramo actual
          if (punto.tramo === tramoActual) {
            tramoBtn.classList.add('actual');
          }
          
          // Construir el contenido del botón de tramo
          tramoBtn.innerHTML = `
            <span class="badge badge-tramo">T${punto.tramo}</span>
            ${punto.nombre}
          `;
          
          // Manejar clic en el tramo
          tramoBtn.onclick = () => {
            // Actualizar estado local
            tramoActual = punto.tramo;
            paradaActual = -1;
            
            // Actualizar estado local sincronizado
            estadoLocal.puntoActual = { 
              tipo: 'tramo', 
              id: tramoActual,
              datos: punto
            };
            estadoLocal.ultimaActualizacion = Date.now();
            
            // Notificar al padre sobre el cambio de punto actual
            const mensajePadre = {
              type: 'actualizarPuntoActual',
              puntoActual: estadoLocal.puntoActual,
              origen: 'hijo5',
              timestamp: estadoLocal.ultimaActualizacion
            };
            
            console.log('📤 HIJO 5: Notificando cambio de tramo al padre:', mensajePadre);
            padre.postMessage(mensajePadre, '*');
            
            // Notificar al hijo 2 (mapa) a través del padre
            window.parent.postMessage({
              tipo: 'mensaje-para-hijo2',
              mensaje: {
                type: 'seleccionarTramo',
                tramoId: punto.tramo,
                inicio: punto.inicio,
                fin: punto.fin,
                waypoints: punto.waypoints,
                modoCasa: modoCasa,
                timestamp: Date.now()
              }
            }, '*');
            
            // Si el GPS está apagado, simular que estamos en el inicio del tramo
            if (modoCasa) {
              // Notificar al hijo 2 (botones) para desbloquear funcionalidades
              window.parent.postMessage({
                tipo: 'mensaje-para-hijo2',
                mensaje: {
                  type: 'simularUbicacion',
                  coordenadas: punto.inicio, // Usar las coordenadas de inicio del tramo
                  tramoId: punto.tramo,
                  modoCasa: true
                }
              }, '*');
              
              // Si hay video, notificar al reproductor de video
              if (punto.video) {
                window.parent.postMessage({
                  tipo: 'mensaje-para-hijo3',
                  mensaje: {
                    type: 'cargarVideo',
                    src: punto.video,
                    tramoId: punto.tramo,
                    autoplay: true
                  }
                }, '*');
              }
              
              // Si hay imagen, notificar al visor de imágenes
              if (punto.imagen) {
                window.parent.postMessage({
                  tipo: 'mensaje-para-hijo4',
                  mensaje: {
                    type: 'mostrarImagen',
                    src: punto.imagen,
                    tramoId: punto.tramo
                  }
                }, '*');
              }
            }
            
            // Actualizar la vista
            renderParadasYTramos();
          };
          
          lista.appendChild(tramoBtn);
        }
      });
    }

    // ================ FUNCIONES DE CONTROL ================
    
    function desbloquearFuncionalidades() {
      console.log('🔓 INICIANDO DESBLOQUEO DE FUNCIONALIDADES - MODO CASA');
      
      // Activar botones de imagen y video en hijo 2 (NO GPS)
      enviarMensajeAHijo2({
        tipo: 'activar-modo-casa-botones'
      });
      
      // Habilitar controles de audio en hijo 3
      const mensajeAudio = {
        tipo: 'mensaje-para-hijo3',
        mensaje: {
          type: 'enableControls',
          enabled: true
        }
      };
      window.parent.postMessage(mensajeAudio, '*');
      
      // Desbloquear botón retos en hijo 4
      const mensajeRetos = {
        tipo: 'mensaje-para-hijo4',
        mensaje: {
          type: 'enableRetos',
          enabled: true
        }
      };
      window.parent.postMessage(mensajeRetos, '*');
      
      console.log('🔓 Funcionalidades desbloqueadas - Modo Casa activado');
    }
    
    function restaurarRestriccionesAventura() {
      console.log('🔒 RESTAURANDO RESTRICCIONES - MODO AVENTURA');
      
      // Desactivar todos los botones en hijo 2
      enviarMensajeAHijo2({
        tipo: 'desactivar-todos-botones'
      });
      
      // Bloquear controles de audio en hijo 3
      const mensajeAudio = {
        tipo: 'mensaje-para-hijo3',
        mensaje: {
          type: 'disableControls',
          enabled: false
        }
      };
      window.parent.postMessage(mensajeAudio, '*');
      
      // Bloquear botón retos en hijo 4
      const mensajeRetos = {
        tipo: 'mensaje-para-hijo4',
        mensaje: {
          type: 'disableRetos',
          enabled: false
        }
      };
      window.parent.postMessage(mensajeRetos, '*');
      
      console.log('🔒 Restricciones restauradas - Modo Aventura activado');
    }

    // ================ COMUNICACIÓN CON EL HIJO 2 ================
    
    function enviarMensajeAHijo2(mensaje) {
      window.parent.postMessage({
        tipo: 'mensaje-para-hijo2',
        mensaje: mensaje
      }, '*');
    }
    
    function solicitarEstadoAHijo2() {
      enviarMensajeAHijo2({
        tipo: 'solicitar-estado-modo'
      });
    }

    // ================ SISTEMA DE MENSAJERÍA SIMPLIFICADO ================
    
    // Función para enviar mensajes al padre
    function enviarAlPadre(tipo, datos = {}) {
        const mensaje = {
            tipo,
            origen: 'hijo5',
            timestamp: Date.now(),
            ...datos
        };
        console.log('HIJO5: Enviando al padre:', mensaje);
        window.parent.postMessage(mensaje, '*');
    }
    
    // Función para solicitar sincronización
    function sincronizarConPadre() {
        console.log('HIJO5: Solicitando sincronización...');
        enviarAlPadre('sincronizar');
    }
    
    // Manejador de mensajes entrantes
    window.addEventListener('message', function(event) {
        // Para depuración
        console.log('📨 HIJO 5: Mensaje recibido:', event.data);
        
        const mensaje = event.data;
        if (!mensaje) return;
        
        // Verificar si el mensaje es para este iframe
        if (mensaje.destino === 'hijo5') {
            console.log('📩 HIJO 5: Mensaje dirigido a este iframe');
            const datos = mensaje.mensaje || {};
            
            // Manejar mensajes de sincronización
            if (mensaje.type === 'sincronizarEstado' || 
                mensaje.type === 'actualizarModo' || 
                mensaje.type === 'actualizarPuntoActual') {
                manejarSincronizacionEstado(mensaje, 'padre');
                return;
            }
            
            // Manejar mensajes específicos para este hijo
            if (datos.type === 'actualizarEstadoGPS') {
                console.log('🔄 HIJO 5: Actualizando estado GPS a', datos.estadoGPS);
                if (datos.estadoGPS === 'apagado') {
                    setGpsState(false);
                } else if (datos.estadoGPS === 'encendido') {
                    setGpsState(true);
                }
                return;
            }
            
            // Actualizar estado de navegación
            if (datos.type === 'ACTUALIZAR_ESTADO') {
                console.log('📍 HIJO 5: Actualizando estado de navegación:', datos);
                if (datos.paradaActual !== undefined) {
                    paradaActual = datos.paradaActual;
                    tramoActual = -1;
                    renderParadasYTramos();
                }
                if (datos.tramoActual !== undefined) {
                    tramoActual = datos.tramoActual;
                    paradaActual = -1;
                    renderParadasYTramos();
                }
                return;
            }
            
            // Sincronizar estado inicial
            if (datos.type === 'sincronizarEstado') {
                console.log('🔄 HIJO 5: Sincronizando estado con el padre');
                const estado = {
                    modoCasa: modoCasa,
                    gpsOn: gpsOn,
                    paradaActual: paradaActual,
                    tramoActual: tramoActual
                };
                window.parent.postMessage({
                    tipo: 'respuesta-sincronizacion-hijo5',
                    estado: estado
                }, '*');
                return;
            }
            
            console.log('⚠️ HIJO 5: Tipo de mensaje no manejado:', datos.type);
        }
    });
    
    // ================ EVENTOS ================
    
    // Click en el botón principal
    document.getElementById('gps-casa-btn').onclick = function() {
      const nuevoModo = gpsOn ? 'fuera' : 'casa';
      console.log(`🎯 HIJO5: Cambiando a modo ${nuevoModo}`);
      
      // Cambiar el estado visual del botón
      if (nuevoModo === 'casa') {
        // Cambiar a modo casa (GPS OFF)
        setGpsState(false);
        mostrarParadasYTramos();
      } else {
        // Cambiar a modo aventura (GPS ON)
        setGpsState(true);
        ocultarParadas();
      }
      
      // Notificar al padre sobre el cambio de modo
      enviarAlPadre('cambiarModo', { 
        modo: nuevoModo,
        timestamp: Date.now()
      });
      
      // Sincronizar el estado después del cambio
      setTimeout(sincronizarConPadre, 100);
    };
    
    // Sincronizar con el padre cuando se carga la página
    window.addEventListener('load', function() {
      console.log('HIJO5: Cargado, solicitando sincronización...');
      // Esperar un momento para asegurar que el padre esté listo
      setTimeout(sincronizarConPadre, 1000);
    });

    // Cerrar ventana de paradas
    document.getElementById('cerrar-paradas').onclick = function() {
      ocultarParadas();
      window.parent.postMessage({ type: 'cerrarParadas' }, '*');
    };

    // ================ MANEJO DE MENSAJES ================
    
    // Función para manejar la sincronización de estado con el padre
    function manejarSincronizacionEstado(data, origen) {
      console.log('📥 HIJO 5: Sincronizando estado con el padre:', data);
      
      // Si el mensaje viene directamente con puntoActual (sin estado.estado)
      if (data.puntoActual) {
        const puntoActual = data.puntoActual;
        
        // Actualizar estado local
        if (puntoActual.tipo === 'parada') {
          paradaActual = puntoActual.id;
          tramoActual = -1;
        } else if (puntoActual.tipo === 'tramo') {
          tramoActual = puntoActual.id;
          paradaActual = -1;
        }
        
        // Actualizar estado local sincronizado
        estadoLocal.puntoActual = puntoActual;
        estadoLocal.ultimaActualizacion = data.timestamp || Date.now();
        
        // Si estamos en modo casa, simular la ubicación
        if (modoCasa && puntoActual) {
          const punto = puntosRuta.find(p => 
            (p.tipo === puntoActual.tipo && 
             ((p.tipo === 'parada' && p.parada === puntoActual.id) || 
              (p.tipo === 'tramo' && p.tramo === puntoActual.id)))
          );
          
          if (punto) {
            const coords = punto.tipo === 'parada' ? 
              punto.coordenadas : 
              (punto.inicio || (punto.waypoints && punto.waypoints[0]) || { lat: 39.4699, lng: -0.3763 });
            
            console.log(`🏠 HIJO 5: Simulando ubicación para ${punto.tipo} ${punto.tipo === 'parada' ? punto.parada : punto.tramo}`, coords);
            
            // Notificar al hijo 2 (mapa) sobre la ubicación simulada
            window.parent.postMessage({
              tipo: 'mensaje-para-hijo2',
              mensaje: {
                type: 'simularUbicacion',
                coordenadas: coords,
                [punto.tipo + 'Id']: punto.tipo === 'parada' ? punto.parada : punto.tramo,
                modoCasa: true,
                origen: 'sincronizacion',
                timestamp: estadoLocal.ultimaActualizacion
              }
            }, '*');
            
            // Si es una parada, notificar al hijo 3 (audio) y 4 (retos)
            if (punto.tipo === 'parada' && punto.audio) {
              window.parent.postMessage({
                tipo: 'mensaje-para-hijo3',
                mensaje: {
                  type: 'cargarAudio',
                  src: punto.audio,
                  paradaId: punto.parada,
                  autoplay: true,
                  origen: 'sincronizacion',
                  timestamp: estadoLocal.ultimaActualizacion
                }
              }, '*');
              
              if (punto.reto) {
                window.parent.postMessage({
                  tipo: 'mensaje-para-hijo4',
                  mensaje: {
                    type: 'mostrarReto',
                    paradaId: punto.parada,
                    modoCasa: true,
                    origen: 'sincronizacion',
                    timestamp: estadoLocal.ultimaActualizacion
                  }
                }, '*');
              }
            } 
            // Si es un tramo, notificar al hijo 3 (video) si hay video
            else if (punto.tipo === 'tramo' && punto.video) {
              window.parent.postMessage({
                tipo: 'mensaje-para-hijo3',
                mensaje: {
                  type: 'cargarVideo',
                  src: punto.video,
                  tramoId: punto.tramo,
                  autoplay: true,
                  origen: 'sincronizacion',
                  timestamp: estadoLocal.ultimaActualizacion
                }
              }, '*');
            }
          }
        }
        
        // Actualizar la vista
        renderParadasYTramos();
      }
      // Manejar mensajes con formato de estado.estado
      else if (data.estado) {
        // Actualizar modo (casa/aventura)
        if (data.estado.modo && (data.estado.modo === 'casa' || data.estado.modo === 'aventura')) {
          const nuevoModo = data.estado.modo === 'casa';
          if (modoCasa !== nuevoModo) {
            modoCasa = nuevoModo;
            setGpsState(!nuevoModo);
          }
        }
        
        // Actualizar punto actual (parada o tramo)
        if (data.estado.puntoActual) {
          if (data.estado.puntoActual.tipo === 'parada' && data.estado.puntoActual.id !== undefined) {
            paradaActual = data.estado.puntoActual.id;
            tramoActual = -1;
          } else if (data.estado.puntoActual.tipo === 'tramo' && data.estado.puntoActual.id !== undefined) {
            tramoActual = data.estado.puntoActual.id;
            paradaActual = -1;
          }
          
          // Actualizar UI si es necesario
          if (document.getElementById('paradas-window').style.display === 'flex') {
            renderParadasYTramos();
          }
        }
      }
    }
    
    window.addEventListener('message', (event) => {
      const data = event.data;
      if (!data) return;
      
      console.log('[Hijo5] Mensaje recibido:', data);
      
      // Manejar mensajes de sincronización de estado
      if (data.type === 'sincronizarEstado' && data.estado) {
        manejarSincronizacionEstado(data, data.origen || 'desconocido');
        return;
      }
      
      // Mensajes del padre
      if (data.tipo === 'gpsStatus' || data.type === 'gpsStatus') {
        const gpsActivo = data.estadoGPS === 'activo' || data.on === true;
        setGpsState(gpsActivo);
        
        if (gpsActivo) {
          ocultarParadas();
          // Notificar al padre que el modo aventura está activo
          window.parent.postMessage({
            tipo: 'ACTUALIZAR_ESTADO_GPS',
            estadoGPS: 'activo',
            timestamp: Date.now()
          }, '*');
        } else {
          mostrarParadasYTramos();
          // Notificar al padre que el modo casa está activo
          window.parent.postMessage({
            tipo: 'ACTUALIZAR_ESTADO_GPS',
            estadoGPS: 'inactivo',
            timestamp: Date.now()
          }, '*');
        }
      }
      
      // Mensajes del hijo 2
      if (data.tipo === 'confirmacion-modo-casa' && data.activo && !modoCasa) {
        modoCasa = true;
        setGpsState(false);
        mostrarParadasYTramos();
        
        // Notificar al padre sobre el cambio de estado
        window.parent.postMessage({
          tipo: 'ACTUALIZAR_ESTADO_GPS',
          estadoGPS: 'inactivo',
          timestamp: Date.now()
        }, '*');
      }
      
      if (data.tipo === 'confirmacion-modo-aventura' && data.activo && modoCasa) {
        modoCasa = false;
        setGpsState(true);
        ocultarParadas();
        
        // Notificar al padre sobre el cambio de estado
        window.parent.postMessage({
          tipo: 'ACTUALIZAR_ESTADO_GPS',
          estadoGPS: 'activo',
          timestamp: Date.now()
        }, '*');
      }
      
      if (data.tipo === 'estado-modo-actual' || data.tipo === 'ACTUALIZAR_UI') {
        modoCasa = data.modoCasa || data.gpsActivo === false;
        paradaActual = data.paradaActual || paradaActual || 0;
        tramoActual = data.tramoActual || tramoActual || -1;
        
        setGpsState(!modoCasa);
        
        if (modoCasa && document.getElementById('paradas-window').style.display === 'flex') {
          renderParadasYTramos();
        } else if (!modoCasa) {
          ocultarParadas();
        }
        
        if (modoCasa) {
          desbloquearFuncionalidades();
        }
      }
      
      if (data.tipo === 'cambio-parada-actual' || data.tipo === 'PARADA_SELECCIONADA') {
        const nuevaParada = data.parada || data.paradaIndex;
        if (nuevaParada !== undefined && nuevaParada !== paradaActual) {
          paradaActual = nuevaParada;
          tramoActual = -1;
          
          // Actualizar la interfaz de usuario
          if (document.getElementById('paradas-window').style.display === 'flex') {
            renderParadasYTramos();
          }
          
          // Notificar al padre sobre la nueva parada seleccionada
          window.parent.postMessage({
            tipo: 'PARADA_SELECCIONADA',
            paradaIndex: paradaActual,
            timestamp: Date.now()
          }, '*');
        }
      }
      
      if (data.tipo === 'cambio-tramo-actual' || data.tipo === 'TRAMO_SELECCIONADO') {
        const nuevoTramo = data.tramo || data.tramoIndex;
        if (nuevoTramo !== undefined && nuevoTramo !== tramoActual) {
          tramoActual = nuevoTramo;
          paradaActual = -1;
          
          // Actualizar la interfaz de usuario
          if (document.getElementById('paradas-window').style.display === 'flex') {
            renderParadasYTramos();
          }
          
          // Notificar al padre sobre el nuevo tramo seleccionado
          window.parent.postMessage({
            tipo: 'TRAMO_SELECCIONADO',
            tramoIndex: tramoActual,
            timestamp: Date.now()
          }, '*');
        }
      }
    });
    
    // ================ INICIALIZACIÓN ================
    
    document.addEventListener('DOMContentLoaded', () => {
      // Inicializar la estructura de datos
      inicializarPuntosRuta();
      actualizarIndicadorModo();
      
      // Solicitar estado al hijo 2 después de un breve delay
      setTimeout(() => {
        solicitarEstadoAHijo2();
      }, 1000);
    });
  </script>
</body>
</html>
