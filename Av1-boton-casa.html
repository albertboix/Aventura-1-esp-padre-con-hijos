<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPS Casa ON/OFF</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    html, body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      background: transparent;
      font-family: sans-serif;
      user-select: none;
      overflow: hidden;
    }
    #contenedor-flex {
      display: flex;
      flex-direction: column;
      width: 100vw;
      height: 100vh;
      box-sizing: border-box;
    }
    #zona-boton-casa {
      height: 99px; /* 75px bot√≥n + 12px top + 12px bottom (ajusta si hace falta) */
      flex-shrink: 0;
      display: flex;
      align-items: flex-start;
    }
    #gps-casa-btn {
      margin-left: 12px;
      margin-top: 12px;
      width: 75px; height: 75px; background: white;
      border-radius: 18px; box-shadow: 0 2px 12px rgba(0,0,0,0.13);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      cursor: pointer; z-index: 10001; border: 2px solid #eee;
      transition: box-shadow 0.2s; padding: 0; gap: 2px;
    }
    #gps-casa-btn .casa-icon {
      font-size: 2.3em; margin-bottom: 2px; transition: color 0.2s;
    }
    #gps-casa-btn .gps-label {
      font-size: 1.1em; font-weight: bold; letter-spacing: 1px; margin-top: 0;
      transition: color 0.2s; user-select: none;
    }
    #gps-casa-btn.on .casa-icon, #gps-casa-btn.on .gps-label { color: #e53935; }
    #gps-casa-btn.off .casa-icon, #gps-casa-btn.off .gps-label { color: #43a047; }
    #paradas-window {
      flex: 1 1 auto;
      position: relative;
      background: white;
      border-radius: 5px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.13);
      z-index: 10002;
      display: none;
      flex-direction: column;
      padding: 2px 4px 4px 4px;
      border: 1px solid #ddd;
      animation: fadeIn 0.18s;
      width: 100%;
      box-sizing: border-box;
      min-height: 0;
      min-width: 0;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px);} to { opacity: 1; transform: translateY(0);} }
    #paradas-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;
      width: 100%;
      box-sizing: border-box;
    }
    #estado-modo {
      font-size: 0.9em;
      color: #666;
      background: #f0f0f0;
      padding: 3px 8px;
      border-radius: 12px;
      margin-right: auto;
    }
    #cerrar-paradas {
      background: none; border: none; font-size: 1.3em; color: #888; cursor: pointer;
      padding: 2px 8px 2px 2px; border-radius: 6px; transition: background 0.15s;
    }
    #cerrar-paradas:hover { background: #eee; color: #e53935; }
    #paradas-list {
      display: flex; flex-direction: column; gap: 4px; overflow-y: auto; max-height: 100%;
      min-height: 0; padding-right: 0; width: 100%; box-sizing: border-box;
      flex: 1 1 auto;
    }
    .parada-btn {
      background: linear-gradient(90deg, #007aff 0%, #00c6ff 100%);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 6px 5px;
      font-size: 1em;
      cursor: pointer;
      text-align: left;
      transition: background 0.18s, color 0.18s;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
      font-family: inherit;
      word-break: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      line-height: 1.2;
      width: 100%;
      display: block;
      box-sizing: border-box;
    }
    .parada-btn:hover {
      background: linear-gradient(90deg, #0056b3 0%, #00aaff 100%); color: #e0ffe0;
    }
    .parada-btn.actual {
      background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
      border: 2px solid #155724;
    }
    @media (max-width: 300px) {
      #gps-casa-btn { width: 62px; height: 62px; }
      #zona-boton-casa { height: 70px; }
      #paradas-window { width: 40vw; }
    }
  </style>
</head>
<body>
  <div id="contenedor-flex">
    <div id="zona-boton-casa">
      <div id="gps-casa-btn" class="on" title="Activar GPS">
        <span class="casa-icon"><i class="fa-solid fa-house"></i></span>
        <span class="gps-label">ON</span>
      </div>
    </div>
    <div id="paradas-window">
      <div id="paradas-header">
        <span id="estado-modo">Modo: Aventura</span>
        <button id="cerrar-paradas" title="Cerrar paradas"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="paradas-list"></div>
    </div>
  </div>
  <script>
    // ================== ARRAY DE 25 PARADAS SINCRONIZADO ==================
    // Este array debe coincidir exactamente con el del padre e hijo 2
    const paradas = [
      { nombre: "Torres de Serranos (start)", lat: 39.47876, lng: -0.37626 },
      { nombre: "Torres de Serranos ‚Üí Plaza de la crida (Puente de Serranos)", lat: 39.47959, lng: -0.37583 },
      { nombre: "Plaza de la crida ‚Üí Palacio de los Borgia (Cortes Valencianas)", lat: 39.47785, lng: -0.37485 },
      { nombre: "Palacio de los Borgia ‚Üí Plaza de la Virgen", lat: 39.47656, lng: -0.37529 },
      { nombre: "Plaza de la Virgen ‚Üí Plaza de la Almo√≠na", lat: 39.47604, lng: -0.37451 },
      { nombre: "Plaza de la Almo√≠na ‚Üí Catedral de Val√®ncia", lat: 39.47594, lng: -0.37474 },
      { nombre: "Catedral ‚Üí Plaza Decimo Junio Bruto (Museo Arqueol√≥gico de la Almo√≠na)", lat: 39.4762, lng: -0.37412 },
      { nombre: "Plaza Decimo Junio Bruto ‚Üí Bas√≠lica de Val√®ncia", lat: 39.47611, lng: -0.37478 },
      { nombre: "Bas√≠lica ‚Üí Palacio Arzobispal", lat: 39.4755, lng: -0.37436 },
      { nombre: "Palacio Arzobispal ‚Üí Plaza del Ayuntamiento", lat: 39.47056, lng: -0.37677 },
      { nombre: "Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento de Val√®ncia", lat: 39.46971, lng: -0.37693 },
      { nombre: "Edificio del Ayuntamiento ‚Üí Estaci√≥n del Norte", lat: 39.46722, lng: -0.37702 },
      { nombre: "Estaci√≥n del Norte ‚Üí Plaza de Toros de Val√®ncia", lat: 39.46709, lng: -0.37595 },
      { nombre: "Plaza de Toros ‚Üí Casa estilo √Årabe", lat: 39.46753, lng: -0.37511 },
      { nombre: "Casa estilo √Årabe ‚Üí Palacio de Comunicaciones (Correos)", lat: 39.46942, lng: -0.37559 },
      { nombre: "Palacio de Comunicaciones ‚Üí Banco de Val√®ncia", lat: 39.47061, lng: -0.37408 },
      { nombre: "Banco de Val√®ncia ‚Üí Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica)", lat: 39.47276, lng: -0.37467 },
      { nombre: "Palacio del Marqu√©s ‚Üí Mercado Central", lat: 39.47377, lng: -0.37832 },
      { nombre: "Mercado Central ‚Üí Iglesia de los Santos Juanes", lat: 39.47425, lng: -0.37895 },
      { nombre: "Iglesia Santos Juanes ‚Üí Lonja de Val√®ncia (Mercado de la Seda)", lat: 39.47426, lng: -0.37862 },
      { nombre: "Lonja ‚Üí Plaza del Doctor Collado", lat: 39.47444, lng: -0.3779 },
      { nombre: "Plaza del Doctor Collado ‚Üí Plaza del Negrito (Fuente del Negrito)", lat: 39.47611, lng: -0.37741 },
      { nombre: "Plaza del Negrito ‚Üí Calle Caballeros", lat: 39.47663, lng: -0.3773 },
      { nombre: "Calle Caballeros ‚Üí Palacio de la Generalitat", lat: 39.47668, lng: -0.37671 },
      { nombre: "Palacio de la Generalitat ‚Üí Calle de los Serranos (FINAL)", lat: 39.47773, lng: -0.37671 }
    ];

    // Estado GPS: true = ON (aventura), false = OFF (casa)
    let gpsOn = true;
    let modoCasa = false; // Estado del modo actual
    let paradaActual = 0; // Parada actual del hijo 2
    let estadoModo = document.getElementById('estado-modo');

    // ================ FUNCIONES PRINCIPALES ================
    
    // Cambia el estado del bot√≥n y la etiqueta
    function setGpsState(on) {
      gpsOn = on;
      modoCasa = !on; // ON = aventura (false), OFF = casa (true)
      
      const btn = document.getElementById('gps-casa-btn');
      btn.className = on ? 'on' : 'off';
      btn.querySelector('.gps-label').textContent = on ? 'ON' : 'OFF';
      
      // Actualizar indicador de modo
      actualizarIndicadorModo();
      
      // Comunicar cambio de modo al hijo 2
      if (modoCasa) {
        enviarMensajeAHijo2({
          tipo: 'boton-casa-activado',
          modoCasa: true
        });
        
        // NUEVO: Desbloquear botones cuando se activa modo casa (OFF)
        desbloquearFuncionalidades();
      } else {
        enviarMensajeAHijo2({
          tipo: 'boton-casa-desactivado',
          modoCasa: false
        });
        
        // NUEVO: Restaurar restricciones cuando se activa modo aventura (ON)
        restaurarRestriccionesAventura();
      }
    }
    
    function actualizarIndicadorModo() {
      estadoModo.textContent = `Modo: ${modoCasa ? 'Casa' : 'Aventura'}`;
      estadoModo.style.background = modoCasa ? '#ffe0e0' : '#e0f7fa';
      estadoModo.style.color = modoCasa ? '#c62828' : '#00695c';
    }

    // Mostrar/ocultar ventana de paradas
    function mostrarParadas() {
      console.log(`üìã HIJO 5: mostrarParadas() - gpsOn: ${gpsOn}, modoCasa: ${modoCasa}`);
      if (!gpsOn) {
        document.getElementById('paradas-window').style.display = 'flex';
        renderParadas();
        console.log('‚úÖ HIJO 5: Ventana de paradas mostrada');
        
        // NUEVO: Forzar expansi√≥n del iframe desde el hijo
        console.log('üìê HIJO 5: Solicitando expansi√≥n del iframe al padre');
        window.parent.postMessage({ 
          type: 'expandirIframe', 
          width: '220px',
          debug: 'Expansi√≥n solicitada desde mostrarParadas()' 
        }, '*');
      } else {
        console.log('‚ö†Ô∏è HIJO 5: No se puede mostrar paradas - GPS est√° ON');
      }
    }
    
    function ocultarParadas() {
      console.log('‚ùå HIJO 5: Ocultando ventana de paradas');
      document.getElementById('paradas-window').style.display = 'none';
      
      // NUEVO: Solicitar contracci√≥n del iframe al padre
      console.log('üìê HIJO 5: Solicitando contracci√≥n del iframe al padre');
      window.parent.postMessage({ 
        type: 'contraerIframe', 
        width: '80px',
        debug: 'Contracci√≥n solicitada desde ocultarParadas()' 
      }, '*');
    }

    // Renderiza la lista de paradas con indicador de parada actual (numeraci√≥n 0-24)
    function renderParadas() {
      const lista = document.getElementById('paradas-list');
      lista.innerHTML = '';
      paradas.forEach((p, i) => {
        const btn = document.createElement('button');
        btn.className = 'parada-btn';
        if (i === paradaActual) {
          btn.classList.add('actual');
        }
        // ACTUALIZADO: Usar numeraci√≥n 0-24 para coincidir con padre e hijo 2
        btn.textContent = `${i}. ${p.nombre}`;
        btn.onclick = () => {
          // Seleccionar parada y actualizar parada actual
          paradaActual = i;
          window.parent.postMessage({ 
            type: 'seleccionParada', 
            index: i, 
            lat: p.lat, 
            lng: p.lng 
          }, '*');
          
          // Notificar al hijo 2 del cambio de parada
          enviarMensajeAHijo2({
            tipo: 'cambio-parada-actual',
            parada: i
          });
          
          // Re-renderizar para actualizar el indicador
          renderParadas();
        };
        lista.appendChild(btn);
      });
    }

    // ================ FUNCIONES DE CONTROL DE FUNCIONALIDADES ================
    
    function desbloquearFuncionalidades() {
      console.log('üîì INICIANDO DESBLOQUEO DE FUNCIONALIDADES - MODO CASA');
      
      // Activar botones de imagen y video en hijo 2 (usando mensajes existentes)
      enviarMensajeAHijo2({
        tipo: 'activar-boton-imagen'
      });
      console.log('üì§ Enviado a Hijo 2: activar bot√≥n imagen');
      
      enviarMensajeAHijo2({
        tipo: 'activar-boton-video'
      });
      console.log('üì§ Enviado a Hijo 2: activar bot√≥n video');
      
      // Activar todos los botones en hijo 2
      enviarMensajeAHijo2({
        tipo: 'activar-todos-botones'
      });
      console.log('üì§ Enviado a Hijo 2: activar todos botones');
      
      // Desbloquear controles de audio en hijo 3 (play/pausa)
      window.parent.postMessage({
        tipo: 'mensaje-para-hijo3',
        mensaje: {
          type: 'enableControls', // Usando convenci√≥n type en lugar de tipo
          enabled: true
        }
      }, '*');
      console.log('üì§ Enviado a Hijo 3: habilitar controles');
      
      // Desbloquear bot√≥n retos en hijo 4
      window.parent.postMessage({
        tipo: 'mensaje-para-hijo4',
        mensaje: {
          type: 'enableRetos', // Usando convenci√≥n type en lugar de tipo
          enabled: true
        }
      }, '*');
      console.log('üì§ Enviado a Hijo 4: habilitar retos');
      
      console.log('üîì Funcionalidades desbloqueadas - Modo Casa activado');
    }
    
    function restaurarRestriccionesAventura() {
      console.log('üîí INICIANDO BLOQUEO DE FUNCIONALIDADES - MODO AVENTURA');
      
      // Desactivar todos los botones en hijo 2 (usando mensaje existente)
      enviarMensajeAHijo2({
        tipo: 'desactivar-todos-botones'
      });
      console.log('üì§ Enviado a Hijo 2: desactivar todos botones');
      
      // Bloquear controles de audio en hijo 3
      window.parent.postMessage({
        tipo: 'mensaje-para-hijo3',
        mensaje: {
          type: 'disableControls', // Usando convenci√≥n type en lugar de tipo
          enabled: false
        }
      }, '*');
      console.log('üì§ Enviado a Hijo 3: deshabilitar controles');
      
      // Bloquear bot√≥n retos en hijo 4
      window.parent.postMessage({
        tipo: 'mensaje-para-hijo4',
        mensaje: {
          type: 'disableRetos', // Usando convenci√≥n type en lugar de tipo
          enabled: false
        }
      }, '*');
      console.log('üì§ Enviado a Hijo 4: deshabilitar retos');
      
      console.log('üîí Restricciones restauradas - Modo Aventura activado');
    }

    // ================ COMUNICACI√ìN CON EL HIJO 2 ================
    
    function enviarMensajeAHijo2(mensaje) {
      // Enviar mensaje espec√≠ficamente al hijo 2 a trav√©s del padre
      window.parent.postMessage({
        tipo: 'mensaje-para-hijo2',
        mensaje: mensaje
      }, '*');
    }
    
    function solicitarEstadoAHijo2() {
      enviarMensajeAHijo2({
        tipo: 'solicitar-estado-modo'
      });
    }

    // ================ EVENTOS ================
    
    // Click en el bot√≥n principal
    document.getElementById('gps-casa-btn').onclick = function() {
      console.log(`üéØ HIJO 5: Click detectado - Estado actual GPS: ${gpsOn ? 'ON' : 'OFF'}`);
      console.log(`üéØ HIJO 5: Estado modo casa: ${modoCasa}`);
      
      if (gpsOn) {
        // Cambia a OFF (modo casa) y muestra paradas
        console.log('üè† HIJO 5: Cambiando a modo OFF (casa)');
        setGpsState(false);
        
        // Dar tiempo a setGpsState para actualizar variables
        setTimeout(() => {
          console.log(`üîç HIJO 5: Despu√©s de setGpsState - gpsOn: ${gpsOn}, modoCasa: ${modoCasa}`);
          mostrarParadas();
        }, 50);
        
        window.parent.postMessage({ type: 'gpsStatus', on: false }, '*');
        console.log('üì§ HIJO 5: Mensaje gpsStatus OFF enviado al padre');
      } else {
        // Cambia a ON (modo aventura) y oculta paradas
        console.log('üó∫Ô∏è HIJO 5: Cambiando a modo ON (aventura)');
        setGpsState(true);
        
        // Dar tiempo a setGpsState para actualizar variables
        setTimeout(() => {
          console.log(`üîç HIJO 5: Despu√©s de setGpsState - gpsOn: ${gpsOn}, modoCasa: ${modoCasa}`);
          ocultarParadas();
        }, 50);
        
        window.parent.postMessage({ type: 'gpsStatus', on: true }, '*');
        console.log('üì§ HIJO 5: Mensaje gpsStatus ON enviado al padre');
      }
    };

    // Cerrar ventana de paradas
    document.getElementById('cerrar-paradas').onclick = function() {
      ocultarParadas();
      window.parent.postMessage({ type: 'cerrarParadas' }, '*');
    };

    // ================ COMUNICACI√ìN CON EL PADRE Y HIJO 2 ================
    
    window.addEventListener('message', (event) => {
      const data = event.data;
      
      // ========== MENSAJES DEL PADRE ==========
      
      // Permite al padre forzar el estado GPS
      if (data && data.type === 'gpsStatus') {
        setGpsState(!!data.on);
        if (!data.on) mostrarParadas();
        else ocultarParadas();
      }
      
      // ========== MENSAJES DEL HIJO 2 ==========
      
      // El hijo 2 confirma que activ√≥ modo casa
      if (data && data.tipo === 'confirmacion-modo-casa') {
        if (data.activo && !modoCasa) {
          // Sincronizar estado si no estamos en modo casa
          setGpsState(false);
          mostrarParadas();
        }
      }
      
      // El hijo 2 confirma que activ√≥ modo aventura
      if (data && data.tipo === 'confirmacion-modo-aventura') {
        if (data.activo && modoCasa) {
          // Sincronizar estado si estamos en modo casa
          setGpsState(true);
          ocultarParadas();
        }
      }
      
      // El hijo 2 nos env√≠a su estado actual
      if (data && data.tipo === 'estado-modo-actual') {
        modoCasa = data.modoCasa;
        paradaActual = data.paradaActual || 0;
        
        // Sincronizar estado del bot√≥n
        setGpsState(!modoCasa);
        
        // Actualizar interfaz
        if (modoCasa && document.getElementById('paradas-window').style.display === 'flex') {
          renderParadas();
        }
        
        // Si estamos en modo casa, aplicar funcionalidades desbloqueadas
        if (modoCasa) {
          desbloquearFuncionalidades();
        }
      }
      
      // El hijo 2 cambi√≥ de parada
      if (data && data.tipo === 'cambio-parada-actual') {
        paradaActual = data.parada;
        
        // Si la ventana de paradas est√° abierta, re-renderizar
        if (document.getElementById('paradas-window').style.display === 'flex') {
          renderParadas();
        }
      }
    });
    
    // ================ INICIALIZACI√ìN ================
    
    // Al cargar, solicitar estado actual del hijo 2
    document.addEventListener('DOMContentLoaded', () => {
      // Inicializar interfaz
      actualizarIndicadorModo();
      
      // Solicitar estado al hijo 2 despu√©s de un breve delay
      setTimeout(() => {
        solicitarEstadoAHijo2();
      }, 1000);
    });
  </script>
</body>
</html>
