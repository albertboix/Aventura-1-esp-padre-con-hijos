<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hijo5-casa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
    /* Contenedor principal */
    #zona-boton-casa {
      position: relative;
      width: 100%;
      height: 60px;
    }
    
    /* Botón GPS: estilo actualizado with satellite emoji */
    #gps-casa-btn {
      position: absolute;
      top: 5px;
      left: 5px;
      width: 50px;
      height: 50px;
      min-width: 50px;
      min-height: 50px;
      border-radius: 4px;
      border: 1px solid #fff;
      background-color: #f44336;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      padding: 0;
      margin: 0 0 0 10px;
      position: relative;
      z-index: 10002;
      cursor: pointer;
      font-size: 16px;
    }
    #gps-casa-btn.on {
      background-color: #4CAF50 !important;
      border: 1px solid #45a049 !important;
    }
    #gps-casa-btn.off {
      background-color: #f44336 !important;
      border: 1px solid #d32f2f !important;
    }
    #gps-casa-btn:hover {
      opacity: 0.9;
      transform: scale(1.05);
    }
    #gps-casa-btn:active {
      transform: scale(0.95);
    }
    .button-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      line-height: 1;
    }
    .satellite-emoji {
      font-size: 35px;
      line-height: 1;
      margin-bottom: 2px;
      display: block;
    }
    .gps-label {
      font-size: 20px;
      font-weight: bold;
      line-height: 1;
      margin: 0;
      padding: 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Ventana de paradas: diseño actualizado */
    #paradas-window {
      position: absolute;
      top: 0;
      left: 75px; 
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      display: none;
      flex-direction: column;
      padding: 2px;
      border: 1px solid #e0e0e0;
      max-width: 300px;
      min-width: 250px;
      z-index: 10003;
      height: 50px;
      overflow: hidden;
    }
    
    #paradas-window.visible {
      display: flex !important;
    }
    #paradas-window.hidden {
      display: none !important;
    }
    
    #paradas-list {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      padding: 4px;
      overflow-x: auto;
      overflow-y: hidden;
      flex: 1;
      gap: 4px;
      align-items: center;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
    }
    
    .parada-tramo-btn {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 4px 8px;
      margin: 0 3px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      flex: 0 0 auto;
      font-size: 12px;
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      justify-content: flex-start;
      min-height: 40px;
      height: auto;
      min-width: 140px;
      position: relative;
      overflow: hidden;
      gap: 4px;
    }
    
    .parada-btn {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      border: none !important;
    }
    
    .tramo-btn {
      background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
      color: white;
      border: none !important;
    }
    
    .inicio-btn {
      background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
      color: white;
      border: none !important;
    }
    
    .parada-tramo-btn.actual {
      border: 2px solid #ffd700 !important;
      box-shadow: 0 0 0 2px #ffd700, 0 0 15px rgba(255, 215, 0, 0.7) !important;
      transform: scale(1.05);
      font-weight: bold;
      z-index: 2;
      position: relative;
    }
    
    .btn-icon {
      font-size: 1.5em;
      flex-shrink: 0;
    }
    
    .btn-title {
      font-weight: 600;
      white-space: nowrap;
      font-size: 0.95em;
      margin-bottom: 2px;
    }
    
    .btn-desc {
      font-size: 0.85em;
      opacity: 0.9;
      white-space: normal;
      /* Change overflow to hidden - required for line-clamp to work */
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 130px;
      font-weight: 500;
      line-height: 1.2;
      /* Standard display setup for line clamping */
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: horizontal;
      /* For non-webkit browsers - fallback */
      max-height: 2.4em; /* line-height * number of lines */
      text-align: left;
      position: relative;
    }
    
    /* Add additional fallback for older browsers */
    @supports (-webkit-line-clamp: 2) {
      .btn-desc {
        overflow: hidden;
        text-overflow: ellipsis;
      }
    }
    
    /* Additional fallback for Firefox */
    @supports not (-webkit-line-clamp: 2) {
      .btn-desc:after {
        content: "...";
        position: absolute;
        right: 0;
        bottom: 0;
        background: linear-gradient(to right, rgba(255, 255, 255, 0), white 50%);
        padding-left: 20px;
      }
    }
    
    /* Loading indicator styles */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #09f;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    </style>
    <script type="module">
    // Importar módulos primero (before everything else)
    import { TIPOS_MENSAJE, MODOS } from './js/constants.js';
    import { CONFIG } from './js/config.js';
    import logger from './js/logger.js';
    import { 
        inicializarMensajeria,
        registrarControlador, 
        enviarMensaje 
    } from './js/mensajeria.js';
    
    // Configuración de mensajería
    const CONFIG_MENSAJERIA = {
        iframeId: 'hijo5-casa',
        debug: true,
        logLevel: 0, // DEBUG level for troubleshooting
        reintentos: {
            maximos: 3,
            tiempoEspera: 1000,
            factor: 2
        }
    };
    
    // Estado del componente
    const estado = {
        inicializado: false,
        inicializando: false,
        modo: 'casa', // Default mode
        gpsActivo: false,
        error: null,
        watchId: null,
        paradaActual: -1,
        tramoActual: -1
    };
    
    // Make available globally for debugging
    window.estadoComponente = estado;
    window.TIPOS_MENSAJE = TIPOS_MENSAJE;
    
    // Función para actualizar la interfaz según el modo
    function actualizarInterfaz(modo) {
        console.log(`Actualizando interfaz a modo: ${modo}`);
        const botonCasa = document.getElementById('gps-casa-btn');
        const label = botonCasa.querySelector('.gps-label');
        const paradasWindow = document.getElementById('paradas-window');
        
        if (!botonCasa) {
            console.warn('No se encontró el botón de casa');
            return;
        }
        
        const gpsActivo = modo === 'aventura';
        
        if (modo === 'casa') {
            // Cambios visuales para modo casa (botón verde, mostrar paradas)
            if (paradasWindow) paradasWindow.classList.remove('hidden');
            if (paradasWindow) paradasWindow.classList.add('visible');
            botonCasa.classList.remove('off');
            botonCasa.classList.add('on');
            botonCasa.title = 'Activar GPS (Cambiar a modo Aventura)';
            label.textContent = 'ON';
            
            // NUEVO: Renderizar la lista de paradas en modo casa
            renderizarListaParadas();
        } else {
            // Cambios visuales para modo aventura (botón rojo, ocultar paradas)
            if (paradasWindow) paradasWindow.classList.remove('visible');
            if (paradasWindow) paradasWindow.classList.add('hidden');
            botonCasa.classList.remove('on');
            botonCasa.classList.add('off');
            botonCasa.title = 'Desactivar GPS (Cambiar a modo Casa)';
            label.textContent = 'OFF';
        }
        
        estado.modo = modo;
        estado.gpsActivo = gpsActivo;
        console.log(`Interfaz actualizada. Modo: ${modo}, GPS: ${estado.gpsActivo ? 'ACTIVADO' : 'DESACTIVADO'}`);
        
        // Gestionar GPS real
        manejarCambioGPS(gpsActivo);
    }
    
    // Función para manejar la activación/desactivación del GPS
    function manejarCambioGPS(activar) {
        if (activar) {
            if (estado.watchId !== null) {
                navigator.geolocation.clearWatch(estado.watchId);
                estado.watchId = null;
            }
            
            if ('geolocation' in navigator) {
                estado.watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const coords = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        
                        console.log('Posición GPS obtenida:', coords);
                        
                        // Notificar al padre la posición actual
                        enviarMensaje('padre', TIPOS_MENSAJE.NAVEGACION.ACTUALIZAR_POSICION, {
                            coordenadas: coords,
                            timestamp: new Date().toISOString()
                        }).catch(err => console.error('Error al enviar posición:', err));
                    },
                    (err) => {
                        console.warn(`ERROR GPS (${err.code}): ${err.message}`);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
                console.log('GPS activado correctamente');
            } else {
                console.error('Geolocation no está soportada en este navegador');
            }
        } else {
            if (estado.watchId !== null) {
                navigator.geolocation.clearWatch(estado.watchId);
                estado.watchId = null;
                console.log('GPS desactivado');
            }
        }
    }
    
    // Función para manejar el cambio de modo
    async function manejarClickCambioModo() {
        try {
            // Toggle mode
            const nuevoModo = estado.modo === 'casa' ? 'aventura' : 'casa';
            console.log(`Cambiando de modo ${estado.modo} a ${nuevoModo}`);
            
            // Actualizar la interfaz primero para feedback inmediato
            actualizarInterfaz(nuevoModo);
            
            // Enviar el mensaje al padre
            await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, { 
                modo: nuevoModo, 
                origen: 'hijo5-casa',
                timestamp: new Date().toISOString()
            });
            
            console.log(`Mensaje de cambio a modo ${nuevoModo} enviado correctamente`);
            
            // Guardar en localStorage para persistencia
            try {
                localStorage.setItem('gpsState', JSON.stringify(estado.gpsActivo));
            } catch (e) {
                console.error('Error al guardar en localStorage:', e);
            }
        } catch (error) {
            console.error('Error al cambiar el modo:', error);
            // Revertir cambios en la interfaz en caso de error
            actualizarInterfaz(estado.modo);
        }
    }
    
    // IMPORTANTE: Exponer la función al objeto window para que el script inline pueda accederla
    window.manejarClickCambioModo = manejarClickCambioModo;
    
    // Función para manejar el cambio de modo
    async function manejarClickCambioModo() {
        try {
            // Toggle mode
            const nuevoModo = estado.modo === 'casa' ? 'aventura' : 'casa';
            console.log(`Cambiando de modo ${estado.modo} a ${nuevoModo}`);
            
            // Actualizar la interfaz primero para feedback inmediato
            actualizarInterfaz(nuevoModo);
            
            // Enviar el mensaje al padre
            await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, { 
                modo: nuevoModo, 
                origen: 'hijo5-casa',
                timestamp: new Date().toISOString()
            });
            
            console.log(`Mensaje de cambio a modo ${nuevoModo} enviado correctamente`);
            
            // Guardar en localStorage para persistencia
            try {
                localStorage.setItem('gpsState', JSON.stringify(estado.gpsActivo));
            } catch (e) {
                console.error('Error al guardar en localStorage:', e);
            }
        } catch (error) {
            console.error('Error al cambiar el modo:', error);
            // Revertir cambios en la interfaz en caso de error
            actualizarInterfaz(estado.modo);
        }
    }
    
    // IMPORTANTE: Exponer la función al objeto window para que el script inline pueda accederla
    window.manejarClickCambioModo = manejarClickCambioModo;
    
    // Función para manejar el cambio de modo
    async function manejarClickCambioModo() {
        try {
            // Toggle mode
            const nuevoModo = estado.modo === 'casa' ? 'aventura' : 'casa';
            console.log(`Cambiando de modo ${estado.modo} a ${nuevoModo}`);
            
            // Actualizar la interfaz primero para feedback inmediato
            actualizarInterfaz(nuevoModo);
            
            // Enviar el mensaje al padre
            await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, { 
                modo: nuevoModo, 
                origen: 'hijo5-casa',
                timestamp: new Date().toISOString()
            });
            
            console.log(`Mensaje de cambio a modo ${nuevoModo} enviado correctamente`);
            
            // Guardar en localStorage para persistencia
            try {
                localStorage.setItem('gpsState', JSON.stringify(estado.gpsActivo));
            } catch (e) {
                console.error('Error al guardar en localStorage:', e);
            }
        } catch (error) {
            console.error('Error al cambiar el modo:', error);
            // Revertir cambios en la interfaz en caso de error
            actualizarInterfaz(estado.modo);
        }
    }
    
    // IMPORTANTE: Exponer la función al objeto window para que el script inline pueda accederla
    window.manejarClickCambioModo = manejarClickCambioModo;
    
    // Manejador para recibir cambios de modo desde el padre
    function manejarCambioModo(mensaje) {
        const { modo } = mensaje.datos || {};
        if (!modo) return;
        
        console.log(`Recibido cambio de modo desde ${mensaje.origen || 'origen desconocido'}: ${modo}`);
        
        // Solo actualizar si el modo es diferente
        if (modo !== estado.modo) {
            actualizarInterfaz(modo);
        }
    }
    
    // Renderizar la lista solo en modo casa
    function renderizarListaParadas() {
        const listaParadasContainer = document.getElementById('paradas-list');
        if (!listaParadasContainer) return;
        
        console.log('Renderizando lista de paradas...');
        
        // Solicitar datos de paradas al padre si no están disponibles
        if (!window.estadoApp || !window.estadoApp.paradas || window.estadoApp.paradas.length === 0) {
            console.log('Solicitando paradas al padre...');
            // Primero mostrar mensaje de carga
            listaParadasContainer.innerHTML = '<div class="cargando">Cargando paradas...</div>';
            listaParadasContainer.style.display = 'flex';
            
            // Solicitar paradas
            enviarMensaje('padre', TIPOS_MENSAJE.DATOS.SOLICITAR_PARADAS, {})
                .then(response => {
                    console.log('Paradas recibidas:', response);
                    // Si se recibió respuesta con paradas, renderizarlas
                    if (response && response.paradas) {
                        renderizarBotonesParadas(listaParadasContainer, response.paradas);
                    } else {
                        listaParadasContainer.innerHTML = 'No hay paradas disponibles';
                    }
                })
                .catch(err => {
                    console.error('Error al solicitar paradas:', err);
                    listaParadasContainer.innerHTML = 'Error al cargar paradas';
                });
        } else {
            // Renderizar directamente si ya tenemos paradas
            renderizarBotonesParadas(listaParadasContainer, window.estadoApp.paradas);
        }
    }
    
    // Nueva función para renderizar botones con mejor formato
    function renderizarBotonesParadas(container, paradas) {
        container.innerHTML = '';
        
        if (!paradas || paradas.length === 0) {
            container.innerHTML = '<div class="sin-paradas">No hay paradas disponibles</div>';
            return;
        }
        
        paradas.forEach((p, idx) => {
            // Crear botón con más información
            const btn = document.createElement('button');
            const esParada = p.tipo === 'parada' || p.tipo === 'inicio';
            const esInicio = p.tipo === 'inicio';
            const esActual = (esParada && p.parada === estado.paradaActual) || 
                             (!esParada && p.tramo === estado.tramoActual);
            
            btn.className = `parada-tramo-btn`;
            if (esActual) btn.classList.add('actual');
            if (esParada && esInicio) btn.classList.add('inicio-btn');
            else if (esParada) btn.classList.add('parada-btn');
            else btn.classList.add('tramo-btn');
            
            // Crear contenido del botón con icono y texto
            const numero = esParada ? p.parada || idx : p.tramo || idx;
            const icono = esParada ? (esInicio ? '🏁' : '📍') : '🛣️';
            const titulo = esParada ? (esInicio ? 'Inicio' : `Parada ${numero}`) : `Tramo ${numero}`;
            
            btn.innerHTML = `
                <span class="btn-icon">${icono}</span>
                <div>
                    <div class="btn-title">${titulo}</div>
                    <div class="btn-desc">${p.nombre || 'Sin nombre'}</div>
                </div>
            `;
            
            // Añadir evento de clic
            btn.onclick = () => {
                if (esParada) {
                    estado.paradaActual = numero;
                    estado.tramoActual = -1;
                } else {
                    estado.tramoActual = numero;
                    estado.paradaActual = -1;
                }
                
                console.log(`Seleccionado: ${esParada ? 'Parada' : 'Tramo'} ${numero} - ${p.nombre}`);
                
                // Renderizar nuevamente para actualizar la parada actual
                renderizarBotonesParadas(container, paradas);
                
                // Enviar mensaje de cambio de parada/tramo
                enviarMensaje('padre', TIPOS_MENSAJE.NAVEGACION.CAMBIO_PARADA, {
                    punto: {
                        tipo: esParada ? 'parada' : 'tramo',
                        id: esParada ? `P-${numero}` : `TR-${numero}`,
                        parada: esParada ? numero : undefined,
                        tramo: !esParada ? numero : undefined,
                        nombre: p.nombre
                    }
                });
            };
            
            container.appendChild(btn);
        });
        
        container.style.display = 'flex';
    }
    
    // Inicializa el componente
    async function inicializar() {
        if (estado.inicializado || estado.inicializando) {
            console.log('El componente ya está inicializado o inicializándose');
            return;
        }
        
        estado.inicializando = true;
        console.log('Inicializando componente boton-casa...');
        
        try {
            // Intentar cargar estado guardado de localStorage
            try {
                const savedState = localStorage.getItem('gpsState');
                if (savedState !== null) {
                    estado.gpsActivo = JSON.parse(savedState);
                    estado.modo = estado.gpsActivo ? 'aventura' : 'casa';
                }
            } catch (e) {
                console.warn('Error al cargar estado desde localStorage:', e);
            }
            
            // Mostrar indicador de carga
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) loadingIndicator.style.display = 'flex';
            
            // Inicializar mensajería
            console.log('Inicializando mensajería...');
            await inicializarMensajeria(CONFIG_MENSAJERIA);
            console.log('Mensajería inicializada correctamente');
            
            // Registrar manejadores
            registrarControlador(TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, manejarCambioModo);
            console.log('Manejadores registrados');
            
            // Notificar al padre que estamos listos
            await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.COMPONENTE_LISTO, {
                componente: 'hijo5-casa',
                estado: 'listo',
                modo: estado.modo,
                gpsActivo: estado.gpsActivo,
                timestamp: new Date().toISOString()
            });
            
            // Actualizar estado
            estado.inicializado = true;
            estado.inicializando = false;
            
            // Ocultar indicador de carga
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            
            // Inicializar interfaz
            actualizarInterfaz(estado.modo);
            
            console.log('Componente boton-casa inicializado correctamente');
            
        } catch (error) {
            estado.inicializando = false;
            estado.error = error;
            console.error('Error al inicializar componente:', error);
            
            // Notificar al padre el error
            try {
                await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.ERROR, {
                    tipo: 'inicializacion',
                    mensaje: error.message,
                    stack: error.stack,
                    origen: 'hijo5-casa',
                    timestamp: new Date().toISOString()
                });
            } catch (e) {
                console.error('Error al notificar error al padre:', e);
            }
            
            // Ocultar indicador de carga
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) loadingIndicator.style.display = 'none';
        }
    }

    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializar);
    } else {
        inicializar().catch(console.error);
    }
    </script>
</head>
<body>
  <!-- Loading indicator -->
  <div id="loading-indicator" style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      display: none; /* Hidden by default */
  ">
      <div style="
          background: white;
          padding: 20px;
          border-radius: 8px;
          text-align: center;
      ">
          <div class="spinner"></div>
          <p>Cargando aplicación...</p>
      </div>
  </div>

  <div id="zona-boton-casa" role="region" aria-label="Control de navegación">
    <button id="gps-casa-btn" class="on" title="Activar GPS (Cambiar a modo Aventura)">
      <div class="button-content">
        <span class="satellite-emoji">📡</span>
        <span class="gps-label">ON</span>
      </div>
    </button>
    <div id="paradas-window">
        <div id="paradas-list"></div>
    </div>
  </div>
  
  <script>
    // Configurar el botón de GPS
    document.getElementById('gps-casa-btn').addEventListener('click', async function() {
      // La lógica de cambio de modo se maneja en el módulo principal
      try {
        if (window.manejarClickCambioModo) {
          await window.manejarClickCambioModo();
        } else {
          console.warn('manejarClickCambioModo no está disponible');
        }
      } catch (e) {
        console.error('Error al manejar clic de cambio de modo:', e);
      }
    });
    
    // Manejador global de errores no capturados
    window.addEventListener('error', function(event) {
      const error = event.error || new Error(event.message);
      const errorMsg = 'Error no manejado';
      const errorDetails = error instanceof Error ? error.message : String(error);
      
      // Usar logger si está disponible, si no usar console
      const logError = window.logger ? window.logger.error : console.error;
      logError(errorMsg, error);
      
      // Mostrar mensaje de error al usuario
      try {
        const errorContainer = document.createElement('div');
        errorContainer.style.cssText = [
          'position: fixed;',
          'top: 0;',
          'left: 0;',
          'right: 0;',
          'background: #ff4444;',
          'color: white;',
          'padding: 1rem;',
          'z-index: 10000;',
          'text-align: center;',
          'font-family: Arial, sans-serif;'
        ].join(' ');
        
        errorContainer.textContent = `${errorMsg}: ${errorDetails}`;
        document.body.prepend(errorContainer);
      } catch (e) {
        if (window.logger) {
          logger.error('No se pudo mostrar el mensaje de error:', e);
        } else {
          console.error('No se pudo mostrar el mensaje de error:', e);
        }
      }
    });
  </script>
</body>
</html>
