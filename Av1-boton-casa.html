<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Panel de control de GPS para la ruta turística">
    <title>Boton-casa (hijo5-casa)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Estilos existentes */
        #zona-boton-casa {
            box-sizing: border-box;
            position: relative;
            width: 100%;
            min-height: 70px;
            height: auto;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tramo-btn {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
            color: white;
            border: none !important;
        }
        
        /* Agrega aquí el resto de tus estilos */
    </style>
    <style>
    /* Contenedor principal */
    #zona-boton-casa {
        box-sizing: border-box;
        position: relative;
        width: 100%;
        min-height: 70px; /* Cambiado a min-height para que pueda crecer si es necesario */
        height: auto;
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 10px;
        padding: 10px; /* Añadido padding arriba y abajo */
        background-color: #f5f5f5;
        border-bottom: 1px solid #ddd;
        overflow: hidden;
    }
    
    /* Botón GPS: estilo actualizado with emoji de satélite y etiqueta ON/OFF */
    .boton-parada, .boton-tramo, .parada-tramo-btn {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-width: 90px;
        min-height: 50px;
        height: auto;
        margin: 0;
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        background: #2196F3;
        color: white;
        font-size: 12px;
        font-weight: bold;
        text-align: center;
        text-decoration: none;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease;
        white-space: normal;
        word-break: break-word;
        box-sizing: border-box;
        flex-shrink: 0;
    }
    
    #gps-casa-btn.on {
      background-color: #4CAF50 !important;
      border: 1px solid #45a049 !important;
    }
    
    #gps-casa-btn.off {
      background-color: #f44336 !important;
      border: 1px solid #d32f2f !important;
    }
    
    #gps-casa-btn:hover {
      opacity: 0.95;
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    #gps-casa-btn:hover .satellite-emoji {
      transform: rotate(15deg);
    }
    
    #gps-casa-btn:active {
      transform: scale(0.95);
    }
    
    .button-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      line-height: 1;
      gap: 2px;
    }
    
    .satellite-emoji {
      font-size: 28px;
      line-height: 1;
      display: block;
      transition: transform 0.3s ease;
    }
    
    .gps-label {
      font-size: 20px;
      font-weight: bold;
      line-height: 1;
      margin: 0;
      padding: 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Ventana de paradas compacta y horizontal */
    #paradas-window {
        position: relative;
        flex: 1;
        height: 100%;
        background: transparent;
        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 0;
        margin: 0;
        border: none;
        box-shadow: none;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
    }
    
    /* Scroll horizontal dedicado a los botones */
    #lista-paradas {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        padding: 0 10px;
        overflow-x: auto;
        overflow-y: hidden;
        gap: 8px;
        align-items: center;
        height: 100%;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: #c1c1c1 #f1f1f1;
    }
    #lista-paradas::-webkit-scrollbar {
      height: 9px; /* Barra de scroll de 8px */
    }
    #lista-paradas::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }
    #lista-paradas::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    /* Botones de parada y tramo */
    .parada-tramo-btn {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 4px 8px;
      margin: 0;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      flex: 0 0 auto;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 120px;
      max-width: 180px;
      min-height: 36px;
      height: 36px;
      gap: 4px;
      overflow: hidden;
    }
    .parada-btn {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      border: none !important;
    }
    
    .tramo-btn {
      background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
      color: white;
      border: none !important;
    }
    
    .inicio-btn {
      background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
      color: white;
      border: none !important;
    }
    
    .parada-tramo-btn.actual {
      border: 2px solid #ffd700 !important;
      box-shadow: 0 0 0 2px #ffd700, 0 0 15px rgba(255, 215, 0, 0.7) !important;
      transform: scale(1.05);
      font-weight: bold;
      z-index: 2;
      position: relative;
    }
    
    .btn-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      width: 100%;
      gap: 4px;
    }
    .btn-icon {
      font-size: 1.2em;
      flex-shrink: 0;
      margin-right: 2px;
    }
    .btn-title {
      font-weight: 600;
      white-space: nowrap;
      font-size: 0.93em;
      margin-bottom: 0;
    }
    .btn-desc {
      font-size: 0.82em;
      opacity: 0.9;
      white-space: normal;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 90px;
      font-weight: 500;
      line-height: 1.1;
      text-align: center;
      max-height: 2.2em;
      display: block;
      margin-top: 2px;
    }
    
    /* Modificar estas clases para usar con #lista-paradas */
    #paradas-window.visible {
        display: flex !important;
        width: 90% !important;
        max-width: 1000px !important;
        opacity: 1 !important;
        height: 47px !important; /* Ajusta para que no crezca verticalmente */
    }
    
    #paradas-window.hidden {
        display: none !important;
    }
    
    /* Estilos para efectos visuales de selección */
    .parada-tramo-btn.seleccionando {
      transform: scale(0.95);
      opacity: 0.8;
      box-shadow: 0 0 5px rgba(0,0,0,0.3) !important;
    }

    .parada-tramo-btn.seleccionado {
      animation: pulse 1s;
    }

    #gps-casa-btn.pulsando {
      transform: scale(0.95);
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
    }

    /* Estilo para el feedback de error */
    #gps-casa-btn.error {
      animation: shake 0.5s;
      background-color: #ff0000 !important;
    }

    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }

    /* Add styles for the loading state display */
    #estado-carga {
        display: none;
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: bold;
        z-index: 9999;
        max-width: 80%;
        text-align: center;
    }
    
    #estado-carga.info {
        background-color: #2196F3;
        color: white;
    }
    
    #estado-carga.error {
        background-color: #F44336;
        color: white;
    }
    
    #estado-carga.success {
        background-color: #4CAF50;
        color: white;
    }
    
    /* Responsividad móvil para la ventana de paradas y botones */
    @media (max-width: 600px) {
      #paradas-window {
        left: 0 !important;
        right: 0 !important;
        min-width: 0 !important;
        max-width: 100vw !important;
        width: 100vw !important;
        border-radius: 0 0 20px 20px !important;
        height: 47px !important; /* Igual que en escritorio */
        padding: 1px 0 !important;
        top: 1px !important;
      }
      #lista-paradas {
        min-width: 0 !important;
        max-width: 100vw !important;
        width: 100vw !important;
        gap: 1px !important;
        padding: 0 2px 0 2px !important;
        height: 36px !important;
        min-height: 36px !important;
        max-height: 36px !important;
      }
      .parada-tramo-btn {
        min-width: 90px !important;
        max-width: 120px !important;
        font-size: 11px !important;
        padding: 2px 4px !important;
        height: 36px !important;
        min-height: 36px !important;
        gap: 2px !important;
      }
      .btn-desc {
        max-width: 60px !important;
        font-size: 0.75em !important;
      }
    }
    </style>
    <script type="module">
    // Importar módulos necesarios
    import { 
        inicializarMensajeria, 
        enviarMensaje, 
        registrarControlador, 
        enviarACK, 
        enviarNACK
        // Remove or comment out the enviarMensajeConACK import until it's properly exported
        // enviarMensajeConACK 
    } from './js/mensajeria.js';
    import { modoHandler } from './js/modo-handler.js';
    import { TIPOS_MENSAJE } from './js/constants.js';
    import logger from './js/logger.js';
    
    // Configuración del componente
    const COMPONENTE_ID = 'hijo5-casa';
    const IFRAME_ID = 'hijo5-casa';
    
    // Estado del componente
    const estado = {
        inicializado: false,
        inicializando: false,
        gpsActivo: false,
        modo: 'casa',
        aventuraParadas: [], // Array de paradas recibidas del padre (para sincronización)
        paradasMapeadas: {} // Mapeo entre IDs locales y IDs del padre
    };
    
    // Configuración para la mensajería
    const CONFIG_MENSAJERIA = {
        id: COMPONENTE_ID,
        debug: true
    };
    
    // Array local de paradas y tramos con IDs únicos de hijo5-casa
    const puntosRuta = [
        { tipo: "inicio", parada: 0, nombre: "Torres de Serranos (start)" },
        { tipo: "tramo", tramo: 1, nombre: "Torres de Serranos → Plaza de la crida (Puente de Serranos)" },
        { tipo: "parada", parada: 1, nombre: "Plaza de la crida (Puente de Serranos)" },
        { tipo: "tramo", tramo: 2, nombre: "Plaza de la crida → Calle Muro de Santa Ana" },
        { tipo: "parada", parada: 2, nombre: "Calle Muro de Santa Ana" },
        { tipo: "tramo", tramo: 3, nombre: "Calle Muro de Santa Ana → Palacio de los Borgia" },
        { tipo: "parada", parada: 3, nombre: "Iglesia de San Lorenzo" },
        { tipo: "tramo", tramo: 4, nombre: "Iglesia de San Lorenzo → Plaza de la Virgen" },
        { tipo: "parada", parada: 4, nombre: "Plaza de la Virgen Reto 6" },
        { tipo: "parada", parada: 5, nombre: "Plaza de la Virgen Reto 7" },
        { tipo: "tramo", tramo: 5, nombre: "Plaza de la Virgen → Plaza de la Almoína" },
        { tipo: "parada", parada: 6, nombre: "Panel cerámico muro Catedral" },
        { tipo: "parada", parada: 7, nombre: "Capilla exterior catedral Reto 10" },
        { tipo: "parada", parada: 8, nombre: "Capilla exterior catedral Reto 11" },
        { tipo: "parada", parada: 9, nombre: "Arco Novo Catedral y Puerta Negra Basílica" },
        { tipo: "parada", parada: 10, nombre: "Casa del Punt de Gantxo" },
        { tipo: "tramo", tramo: 6, nombre: "Plaza de la Almoína → Plaza Decimo Junio Bruto (Museo Arqueológico de la Almoína)" },
        { tipo: "parada", parada: 11, nombre: "Museo arqueológico La Almoína" },
        { tipo: "parada", parada: 12, nombre: "Museo arqueológico La Almoína" },
        { tipo: "parada", parada: 13, nombre: "Vista de la Catedral, Cimborrio" },
        { tipo: "tramo", tramo: 7, nombre: "Museo arqueológico La Almoína → Palacio Arzobispal" },
        { tipo: "parada", parada: 14, nombre: "Palacio Arzobispal y Puerta Románica de la Catedral" },
        { tipo: "parada", parada: 15, nombre: "Puerta Románica de la Catedral" },
        { tipo: "tramo", tramo: 8, nombre: "Puerta Románica de la Catedral → Plaza del Ayuntamiento" },
        { tipo: "parada", parada: 16, nombre: "Plaza del Ayuntamiento" },
        { tipo: "tramo", tramo: 9, nombre: "Plaza del Ayuntamiento → Edificio del Ayuntamiento de València" },
        { tipo: "parada", parada: 17, nombre: "Edificio del Ayuntamiento" },
        { tipo: "parada", parada: 18, nombre: "Edificio del Ayuntamiento" },
        { tipo: "tramo", tramo: 10, nombre: "Edificio del Ayuntamiento → Estación del Norte" },
        { tipo: "parada", parada: 19, nombre: "Estación del Norte" },
        { tipo: "tramo", tramo: 11, nombre: "Estación del Norte → Plaza de Toros de València" },
        { tipo: "tramo", tramo: 12, nombre: "Plaza de Toros → Casa estilo Árabe" },
        { tipo: "parada", parada: 20, nombre: "Casa estilo Árabe" },
        { tipo: "parada", parada: 21, nombre: "Casa estilo Árabe, mitad Aventura" },
        { tipo: "tramo", tramo: 13, nombre: "Casa estilo Árabe → Palacio de Comunicaciones (Correos)" },
        { tipo: "parada", parada: 22, nombre: "Palacio de Comunicaciones: Correos" },
        { tipo: "parada", parada: 23, nombre: "Edificio Suay" },
        { tipo: "tramo", tramo: 14, nombre: "Palacio de Comunicaciones → Banco de València" },
        { tipo: "parada", parada: 24, nombre: "Banco de Valencia" },
        { tipo: "tramo", tramo: 15, nombre: "Banco de València → Palacio del Marqués de Dos Aguas (Museo Nacional de Cerámica)" },
        { tipo: "parada", parada: 25, nombre: "Palacio del Marqués de Dos Aguas (Museo Nacional de Cerámica)" },
        { tipo: "tramo", tramo: 16, nombre: "Palacio del Marqués → Mercado Central" },
        { tipo: "parada", parada: 26, nombre: "Mercado central" },
        { tipo: "tramo", tramo: 17, nombre: "Mercado Central → Lonja de la Seda" },
        { tipo: "parada", parada: 27, nombre: "Lonja de la Seda" },
        { tipo: "tramo", tramo: 18, nombre: "Lonja de la Seda → Plaza Redonda" },
        { tipo: "parada", parada: 28, nombre: "Plaza Redonda" },
        { tipo: "tramo", tramo: 19, nombre: "Plaza Redonda → Iglesia de los Santos Juanes" },
        { tipo: "parada", parada: 29, nombre: "Iglesia de los Santos Juanes" },
        { tipo: "tramo", tramo: 20, nombre: "Iglesia de los Santos Juanes → Mercado Central" },
        { tipo: "tramo", tramo: 21, nombre: "Mercado Central → Palacio de la Generalitat" },
        { tipo: "parada", parada: 30, nombre: "Palau de la Generalitat" },
        { tipo: "tramo", tramo: 22, nombre: "Palacio de la Generalitat → Torres de Serranos (Final)" },
        { tipo: "parada", parada: 31, nombre: "Torres de Serranos (Final)" }
    ];
    
    // Inicialización única del componente
    let _initializationPromise = null;
    let _initialized = false;
    
    /**
     * Muestra u oculta el indicador de carga
     * @param {boolean} cargando - Si es true, muestra el indicador; si es false, lo oculta
     * @param {string} [mensaje=''] - Mensaje opcional a mostrar
     * @param {boolean} [esError=false] - Indica si es un mensaje de error
     */
    function mostrarEstadoCarga(cargando, mensaje = '', esError = false) {
        try {
            // Si no existe, crear el elemento de estado
            let estadoElement = document.getElementById('estado-carga');
            if (!estadoElement) {
                estadoElement = document.createElement('div');
                estadoElement.id = 'estado-carga';
                estadoElement.style.cssText = `
                    position: fixed; 
                    bottom: 10px; 
                    left: 50%; 
                    transform: translateX(-50%);
                    background: rgba(0,0,0,0.7);
                    color: white;
                    padding: 8px 15px;
                    border-radius: 20px;
                    font-size: 14px;
                    z-index: 10000;
                    display: none;
                `;
                document.body.appendChild(estadoElement);
            }
            
            if (cargando) {
                estadoElement.textContent = mensaje || 'Cargando...';
                estadoElement.style.display = 'block';
                estadoElement.style.backgroundColor = 'rgba(0,0,0,0.7)';
            } else if (mensaje) {
                estadoElement.textContent = mensaje;
                estadoElement.style.backgroundColor = esError ? 'rgba(220,53,69,0.9)' : 'rgba(40,167,69,0.9)';
                estadoElement.style.display = 'block';
                setTimeout(() => {
                    estadoElement.style.display = 'none';
                }, 3000);
            } else {
                estadoElement.style.display = 'none';
            }
        } catch (error) {
            console.error('Error en mostrarEstadoCarga:', error);
        }
    }
    
    /**
     * Muestra un mensaje de error en la interfaz
     * @param {string} mensaje - Mensaje de error a mostrar
     * @param {Error} [error] - Objeto de error opcional
     */
    function mostrarError(mensaje, error) {
        try {
            console.error(mensaje, error || '');
            mostrarEstadoCarga(false, `Error: ${mensaje}`, true);
            
            // Mostrar notificación de error si está disponible
            if (window.parent) {
                if (window.parent.mostrarNotificacion) {
                    window.parent.mostrarNotificacion({
                        tipo: 'error',
                        mensaje: mensaje,
                        duracion: 5000
                    });
                } else if (window.parent.window?.mostrarNotificacion) {
                    window.parent.window.mostrarNotificacion({
                        tipo: 'error',
                        mensaje: mensaje,
                        duracion: 5000
                    });
                } else {
                    console.warn('No se pudo mostrar notificación: mostrarNotificacion no encontrado');
                }
            }
        } catch (err) {
            console.error('Error en mostrarError:', err);
        }
    }
    
    /**
     * Actualiza la interfaz de usuario según el modo actual
     * @param {string} modo - El modo actual ('casa' o 'aventura')
     * @returns {void}
     */
    function actualizarInterfaz(modo) {
        try {
            console.log(`🔄 [CASA] Actualizando interfaz para modo: ${modo}`);
            
            // Actualizar el botón GPS
            const gpsBtn = document.getElementById('gps-casa-btn');
            if (gpsBtn) {
                const estaActivo = modo === 'aventura';
                gpsBtn.classList.toggle('on', estaActivo);
                gpsBtn.classList.toggle('off', !estaActivo);
                
                const label = gpsBtn.querySelector('.gps-label');
                if (label) {
                    label.textContent = estaActivo ? 'ON' : 'OFF';
                }
                console.log(`✅ [CASA] Estado del botón GPS actualizado: ${estaActivo ? 'ACTIVO' : 'INACTIVO'}`);
            } else {
                console.warn('⚠️ [CASA] No se encontró el botón GPS para actualizar');
            }
            
            // Actualizar la visibilidad de la ventana de paradas
            const paradasWindow = document.getElementById('paradas-window');
            if (paradasWindow) {
                if (modo === 'casa') {
                    paradasWindow.classList.remove('hidden');
                    paradasWindow.classList.add('visible');
                    console.log('🏠 [CASA] Mostrando ventana de paradas');
                } else {
                    paradasWindow.classList.remove('visible');
                    paradasWindow.classList.add('hidden');
                    console.log('🌍 [CASA] Ocultando ventana de paradas');
                }
            }
            
            // Notificar al sistema que la interfaz se ha actualizado
            if (window.enviarMensaje) {
                window.enviarMensaje('padre', 'UI.ACTUALIZACION', {
                    componente: COMPONENTE_ID,
                    modo: modo,
                    timestamp: new Date().toISOString()
                });
            }
        } catch (error) {
            console.error('❌ [CASA] Error al actualizar la interfaz:', error);
            mostrarError('Error al actualizar la interfaz', error);
        }
    }
    
    /**
     * Alias de actualizarInterfaz para mantener compatibilidad con código existente
     */
    function actualizarInterfazModo(modo) {
        return actualizarInterfaz(modo);
    }
    
    /**
     * Solicita los datos de paradas al componente padre para sincronización
     * @returns {Promise<Array>} Array de paradas del padre
     */
    async function solicitarParadasDelPadre() {
        try {
            if (!enviarMensaje || !TIPOS_MENSAJE?.DATOS?.SOLICITAR_PARADAS) {
                throw new Error('No se puede solicitar paradas: enviarMensaje o TIPOS_MENSAJE no disponible');
            }
            
            console.log('📤 Solicitando datos de paradas al padre para sincronización...');
            
            // Set a timeout for the request
            const timeoutPromise = new Promise(resolve => setTimeout(() => {
                resolve({ timeout: true });
            }, 3000));
            
            const responsePromise = enviarMensaje('padre', TIPOS_MENSAJE.DATOS.SOLICITAR_PARADAS, {
                componente: COMPONENTE_ID,
                timestamp: new Date().toISOString()
            });
            
            // Use race to handle potential timeouts
            const respuesta = await Promise.race([responsePromise, timeoutPromise]);
            
            // Check for timeout
            if (respuesta && respuesta.timeout) {
                console.warn('⚠️ Timeout al solicitar datos de paradas, usando datos locales');
                return usarParadasLocales();
            }
            
            // Check if response is valid and contains data
            if (respuesta && respuesta.datos && Array.isArray(respuesta.datos)) {
                estado.aventuraParadas = respuesta.datos;
                console.log(`📥 Recibidos ${estado.aventuraParadas.length} datos de paradas del padre`);
                
                // Create ID mapping for communication
                crearMapeoIDs();
                
                return estado.aventuraParadas;
            } else if (respuesta && respuesta.exito && Array.isArray(respuesta.datos)) {
                // Alternative response format with 'exito' field
                estado.aventuraParadas = respuesta.datos;
                console.log(`📥 Recibidos ${estado.aventuraParadas.length} datos de paradas del padre (formato alternativo)`);
                
                crearMapeoIDs();
                
                return estado.aventuraParadas;
            } else {
                console.warn('⚠️ La respuesta no contiene datos de paradas válidos:', respuesta);
                return usarParadasLocales();
            }
        } catch (error) {
            console.error('❌ Error al solicitar datos de paradas:', error);
            return usarParadasLocales();
        }
    }
    
    /**
     * Usa el array local de paradas como fallback cuando no se pueden obtener datos del padre
     * @returns {Array} Array de paradas locales convertido al formato del padre
     */
    function usarParadasLocales() {
        console.log('📋 Usando paradas locales como fallback');
        
        // Convert local paradas to the format expected in the app
        const paradasConvertidas = puntosRuta.map(punto => {
            if (punto.tipo === 'parada') {
                return {
                    padreid: `padre-P-${punto.parada}`,
                    tipo: "parada",
                    parada_id: `P-${punto.parada}`,
                    audio_id: `audio-P-${punto.parada}`,
                    nombre: punto.nombre || `Parada ${punto.parada}`
                };
            } else if (punto.tipo === 'tramo') {
                return {
                    padreid: `padre-TR-${punto.tramo}`,
                    tipo: "tramo",
                    tramo_id: `TR-${punto.tramo}`,
                    audio_id: `audio-TR-${punto.tramo}`,
                    nombre: punto.nombre || `Tramo ${punto.tramo}`
                };
            } else if (punto.tipo === 'inicio') {
                return {
                    padreid: "padre-P-0",
                    tipo: "inicio",
                    parada_id: 'P-0',
                    audio_id: "audio-P-0",
                    nombre: punto.nombre || "Inicio"
                };
            }
        });
        
        estado.aventuraParadas = paradasConvertidas;
        console.log(`📥 Generados ${paradasConvertidas.length} datos de paradas locales`);
        
        // Crear mapeo de IDs
        crearMapeoIDs();
        
        return paradasConvertidas;
    }
    
    /**
     * Crea un mapeo entre los IDs locales de hijo5-casa y los IDs del padre
     */
    function crearMapeoIDs() {
        try {
            const mapeo = {};
            
            // Mapear paradas
            puntosRuta.forEach(punto => {
                if (punto.tipo === "parada" && punto.parada !== undefined) {
                    // Buscar el ID correspondiente en los datos del padre
                    const paradaPadre = estado.aventuraParadas.find(p => 
                        p.tipo === "parada" && 
                        String(p.parada_id).endsWith(`-${punto.parada}`) // P-1, P-2, etc.
                    );
                    
                    if (paradaPadre) {
                        mapeo[`parada-${punto.parada}`] = paradaPadre.parada_id;
                        console.log(`Mapeo: parada local ${punto.parada} → ID padre ${paradaPadre.parada_id}`);
                    }
                } 
                else if (punto.tipo === "tramo" && punto.tramo !== undefined) {
                    // Buscar el ID correspondiente en los datos del padre
                    const tramoPadre = estado.aventuraParadas.find(t => 
                        t.tipo === "tramo" && 
                        String(t.tramo_id).endsWith(`-${punto.tramo}`) // TR-1, TR-2, etc.
                    );
                    
                    if (tramoPadre) {
                        mapeo[`tramo-${punto.tramo}`] = tramoPadre.tramo_id;
                        console.log(`Mapeo: tramo local ${punto.tramo} → ID padre ${tramoPadre.tramo_id}`);
                    }
                }
            });
            
            estado.paradasMapeadas = mapeo;
            console.log('✅ Mapeo de IDs completado:', mapeo);
            
        } catch (error) {
            console.error('❌ Error al crear mapeo de IDs:', error);
        }
    }
    
    /**
     * Genera y muestra los botones de paradas en la interfaz basados en el array local
     * @returns {void}
     */
    function generarBotonesParadas() {
        try {
            const paradasList = document.getElementById('lista-paradas');
            if (!paradasList) {
                console.warn('❌ No se encontró el contenedor de paradas');
                return;
            }
            
            // Limpiar contenedor
            paradasList.innerHTML = '';
            
            // Generar botones a partir del array LOCAL de paradas y tramos
            puntosRuta.forEach((punto, index) => {
                // Crear el botón
                const btn = document.createElement('button');
                btn.className = `parada-tramo-btn ${punto.tipo === 'parada' ? 'parada-btn' : punto.tipo === 'tramo' ? 'tramo-btn' : 'inicio-btn'}`;
                
                // ID único para el botón basado en el ID local
                const idLocal = punto.tipo === 'parada' ? punto.parada : punto.tipo === 'tramo' ? punto.tramo : 0;
                const btnId = `btn-${punto.tipo}-${idLocal}`;
                btn.id = btnId;
                
                // Contenido del botón
                let titulo = '';
                let icono = '';
                
                if (punto.tipo === 'parada') {
                    titulo = `Parada ${punto.parada}`;
                    icono = '<i class="fas fa-map-marker-alt"></i>';
                } else if (punto.tipo === 'tramo') {
                    titulo = `Tramo ${punto.tramo}`;
                    icono = '<i class="fas fa-road"></i>';
                } else if (punto.tipo === 'inicio') {
                    titulo = 'Inicio';
                    icono = '<i class="fas fa-flag-checkered"></i>';
                }
                
                // Estructura HTML del botón
                btn.innerHTML = `
                    <div class="btn-row">
                        <span class="btn-icon">${icono}</span>
                        <span class="btn-title">${titulo}</span>
                    </div>
                    <span class="btn-desc">${punto.nombre || ''}</span>
                `;
                
                // Eventos para el botón
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    
                    try {
                        // Efecto visual de selección
                        btn.classList.add('seleccionando');
                        
                        // Obtener el ID correspondiente del padre usando el mapeo
                        let idPadre = null;
                        if (punto.tipo === 'parada') {
                            idPadre = estado.paradasMapeadas[`parada-${punto.parada}`] || `P-${punto.parada}`;
                        } else if (punto.tipo === 'tramo') {
                            idPadre = estado.paradasMapeadas[`tramo-${punto.tramo}`] || `TR-${punto.tramo}`;
                        }
                        
                        // Validar que idPadre no sea null o undefined
                        if (!idPadre) {
                          throw new Error(`ID para ${punto.tipo} #${punto.parada || punto.tramo} no encontrado`);
                        }
                        
                        // Verificar que el tipo de mensaje existe
                        if (!TIPOS_MENSAJE || !TIPOS_MENSAJE.NAVEGACION || !TIPOS_MENSAJE.NAVEGACION.CAMBIO_PARADA) {
                          throw new Error('TIPOS_MENSAJE.NAVEGACION.CAMBIO_PARADA no está definido');
                        }

                        // Preparar mensaje con el ID del PADRE, no el local
                        const mensaje = {
                            punto: punto.tipo === 'parada' 
                                ? { parada_id: idPadre } 
                                : { tramo_id: idPadre },
                            timestamp: Date.now(),
                            origen: COMPONENTE_ID,
                            idLocal: punto.tipo === 'parada' ? punto.parada : punto.tramo
                        };
                        
                        console.log(`🔄 Enviando cambio de ${punto.tipo}: Local=${idLocal}, Padre=${idPadre}`);
                        
                        // Enviar mensaje al padre que coordinará con los otros hijos
                        const respuesta = await enviarMensaje('padre', TIPOS_MENSAJE.NAVEGACION.CAMBIO_PARADA, mensaje);
                        console.log('✅ Respuesta recibida:', respuesta);
                        
                        // Actualizar UI
                        btn.classList.remove('seleccionando');
                        btn.classList.add('seleccionado');
                        
                        // Quitar la clase 'seleccionado' después de la animación
                        setTimeout(() => {
                            btn.classList.remove('seleccionado');
                        }, 1000);
                        
                    } catch (error) {
                        console.error('❌ Error al enviar cambio de parada/tramo:', error);
                        btn.classList.remove('seleccionando');
                        
                        // Mostrar error visual
                        btn.classList.add('error');
                        setTimeout(() => {
                            btn.classList.remove('error');
                        }, 1000);
                    }
                });
                
                // Añadir el botón al contenedor
                paradasList.appendChild(btn);
            });
            
            console.log(`✅ Generados ${puntosRuta.length} botones de paradas y tramos`);
            
        } catch (error) {
            console.error('❌ Error al generar botones de paradas:', error);
        }
    }
    
    /**
     * Cambia el modo entre casa y aventura
     */
    async function manejarClickCambioModo() {
        try {
            // Obtener el modo actual
            const modoActual = modoHandler.obtenerModoActual() || 'casa';
            
            // Cambiar al modo opuesto
            const nuevoModo = modoActual === 'casa' ? 'aventura' : 'casa';
            
            // Actualizar el estado
            await modoHandler.cambiarModo(nuevoModo);
            
            // Guardar en localStorage
            try {
                localStorage.setItem('gpsState', JSON.stringify(nuevoModo === 'aventura'));
            } catch (e) {
                console.warn('No se pudo guardar el estado en localStorage:', e);
            }
            
            return nuevoModo;
        } catch (error) {
            console.error('Error al cambiar el modo:', error);
            throw error;
        }
    }
    
    /**
     * Maneja el evento de clic en el botón GPS
     */
    async function manejarClickGPS(event) {
        try {
            event?.preventDefault?.();
            event?.stopPropagation?.();
            
            const gpsBtn = event.currentTarget;
            
            // Mostrar estado de carga
            mostrarEstadoCarga(true, 'Cambiando modo...');
            
            // Obtener el modo actual
            const modoActual = modoHandler.obtenerModoActual() || 'casa';
            console.log('🔘 [CASA] Modo actual:', modoActual);
            
            // Determinar el nuevo modo
            const nuevoModo = modoActual === 'casa' ? 'aventura' : 'casa';
            console.log('🔄 [CASA] Cambiando a modo:', nuevoModo);
            
            // Actualizar el modo
            if (modoHandler?.cambiarModo) {
                await modoHandler.cambiarModo(nuevoModo);
            }
            
            // Notificar al padre del cambio de modo
            if (window.parent) {
                try {
                    if (enviarMensaje && TIPOS_MENSAJE?.SISTEMA?.CAMBIO_MODO) {
                        await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, {
                            modo: nuevoModo,
                            origen: IFRAME_ID,
                            timestamp: new Date().toISOString()
                        });
                        console.log('📤 [CASA] Notificación de cambio de modo enviada');
                    } else {
                        console.warn('⚠️ [CASA] No se pudo notificar al padre: enviarMensaje o TIPOS_MENSAJE no disponible');
                    }
                } catch (error) {
                    console.error('❌ [CASA] Error al notificar al padre:', error);
                    throw error;
                }
            }
            
            // Actualizar la interfaz
            actualizarInterfaz(nuevoModo);
            
            // Ocultar estado de carga
            mostrarEstadoCarga(false);
            
        } catch (error) {
            console.error('❌ [CASA] Error en manejarClickGPS:', error);
            mostrarError('Error al cambiar el modo', error);
        }
    }
    
    /**
     * Maneja el cambio de modo desde mensaje externo
     */
    function manejarCambioModo(mensaje) {
        try {
            const { modo } = mensaje.datos || {};
            if (!modo) {
                logger.warn('[CASA] No se especificó un modo en el mensaje');
                return { estado: 'error', mensaje: 'Modo no especificado' };
            }
            
            logger.info(`[CASA] Cambiando a modo: ${modo} (mensaje recibido)`);
            
            // Actualizar el modo usando el modoHandler
            modoHandler.cambiarModo(modo, COMPONENTE_ID);
            
            // Actualizar la interfaz
            actualizarInterfaz(modo);
            
            return { estado: 'ok', modo: modo };
        } catch (error) {
            logger.error('[CASA] Error al cambiar de modo:', error);
            return { 
                estado: 'error', 
                mensaje: 'Error al cambiar de modo',
                error: error.message 
            };
        }
    }
    
    /**
     * Maneja la recepción de datos de paradas
     */
    function manejarRecepcionParadas(mensaje) {
        try {
            const datos = mensaje.datos || {};
            logger.info(`[${COMPONENTE_ID}] Recibidos datos de paradas:`, datos);
            
            if (datos && Array.isArray(datos)) {
                estado.aventuraParadas = datos;
                
                // Actualizar mapeo de IDs
                crearMapeoIDs();
            }
            
            return { estado: 'ok', recibido: true };
        } catch (error) {
            logger.error(`[${COMPONENTE_ID}] Error al procesar paradas:`, error);
            return { 
                estado: 'error', 
                mensaje: 'Error al procesar datos de paradas',
                error: error.message 
            };
        }
    }
    
    /**
     * Configura los manejadores de eventos del componente
     */
    function configurarManejadores() {
        try {
            console.log('🔧 [CASA] Configurando manejadores...');
            
            // Configurar el botón de GPS
            const gpsBtn = document.getElementById('gps-casa-btn');
            if (gpsBtn) {
                // Clonar el botón para limpiar manejadores anteriores
                const newGpsBtn = gpsBtn.cloneNode(true);
                gpsBtn.parentNode.replaceChild(newGpsBtn, gpsBtn);
                
                // Agregar el manejador de clic
                newGpsBtn.addEventListener('click', manejarClickGPS);
                console.log('✅ [CASA] Manejador de GPS configurado correctamente');
                
                // Configurar estado inicial del botón
                const modoActual = modoHandler?.obtenerModoActual?.() || 'casa';
                const estaActivo = modoActual === 'aventura';
                newGpsBtn.classList.toggle('on', estaActivo);
                newGpsBtn.classList.toggle('off', !estaActivo);
                
                const label = newGpsBtn.querySelector('.gps-label');
                if (label) {
                    label.textContent = estaActivo ? 'ON' : 'OFF';
                }
            } else {
                console.warn('⚠️ [CASA] No se encontró el botón de GPS');
            }
            
            // Devolver los datos de inicialización
            return {
                componente: COMPONENTE_ID,
                modo: modoHandler?.obtenerModoActual?.() || 'casa',
                timestamp: new Date().toISOString(),
                origen: IFRAME_ID
            };
            
        } catch (error) {
            console.error('❌ [CASA] Error al configurar manejadores:', error);
            mostrarError('Error al configurar manejadores', error);
            throw error;
        }
    }
    
    /**
     * Función de inicialización principal del componente
     */
    async function inicializar() {
        // Si ya está inicializado, devolver una promesa resuelta
        if (_initialized) {
            return Promise.resolve();
        }
        
        // Si ya se está inicializando, devolver la promesa existente
        if (_initializationPromise) {
            return _initializationPromise;
        }
        
        _initializationPromise = (async () => {
            try {
                estado.inicializando = true;
                console.log('Inicializando componente boton-casa...');
                
                // Intentar cargar estado guardado de localStorage
                try {
                    const savedState = localStorage.getItem('gpsState');
                    if (savedState !== null) {
                        estado.gpsActivo = JSON.parse(savedState);
                        estado.modo = estado.gpsActivo ? 'aventura' : 'casa';
                    }
                } catch (e) {
                    console.warn('Error al cargar estado desde localStorage:', e);
                }
                
                // Inicializar mensajería
                console.log('Inicializando mensajería...');
                await inicializarMensajeria(CONFIG_MENSAJERIA);
                console.log('Mensajería inicializada correctamente');
                
                // Inicializar el modoHandler
                modoHandler.suscribir(COMPONENTE_ID, (nuevoModo) => {
                    logger.info(`[${COMPONENTE_ID}] Recibido cambio de modo a: ${nuevoModo}`);
                    actualizarInterfazModo(nuevoModo);
                });

                // Registrar manejadores para los diferentes tipos de mensajes
                if (!TIPOS_MENSAJE) {
                    throw new Error('TIPOS_MENSAJE no está definido');
                }

                // Registrar controladores
                registrarControlador('CONTROL.CAMBIAR_MODO', manejarCambioModo);
                
                if (TIPOS_MENSAJE?.CONTROL?.CAMBIAR_MODO) {
                    registrarControlador(TIPOS_MENSAJE.CONTROL.CAMBIAR_MODO, manejarCambioModo);
                }

                // Registrar más controladores...
                if (TIPOS_MENSAJE?.SISTEMA?.CAMBIO_MODO) {
                    registrarControlador(TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, manejarCambioModo);
                }
                
                // Registrar controladores para datos de paradas
                const tiposMensajeParadas = [
                    { tipo: TIPOS_MENSAJE?.DATOS?.ENVIAR_PARADAS, nombre: 'DATOS.ENVIAR_PARADAS' },
                    { tipo: TIPOS_MENSAJE?.DATOS?.COORDENADAS_PARADAS, nombre: 'DATOS.COORDENADAS_PARADAS' },
                    { tipo: TIPOS_MENSAJE?.DATOS?.PUNTOS, nombre: 'DATOS.PUNTOS' },
                    { tipo: TIPOS_MENSAJE?.DATOS?.PUNTOS_RUTA, nombre: 'DATOS.PUNTOS_RUTA' },
                    { tipo: TIPOS_MENSAJE?.NAVEGACION?.PARADAS, nombre: 'NAVEGACION.PARADAS' }
                ].filter(item => item.tipo);
                
                tiposMensajeParadas.forEach(({ tipo, nombre }) => {
                    try {
                        registrarControlador(tipo, manejarRecepcionParadas);
                        logger.debug(`[${COMPONENTE_ID}] Registrado controlador para ${nombre}`);
                    } catch (error) {
                        logger.error(`[${COMPONENTE_ID}] Error al registrar controlador para ${nombre}:`, error);
                    }
                });
                
                // Configurar manejadores de eventos DOM
                configurarManejadores();
                
                // Solicitar datos de paradas al padre para sincronización
                await solicitarParadasDelPadre();
                
                // Generar botones de paradas basados en el array LOCAL
                generarBotonesParadas();
                
                // Actualizar interfaz inicialmente según el estado
                actualizarInterfaz(estado.modo);
                
                // Notificar que el componente está listo
                if (enviarMensaje && TIPOS_MENSAJE?.SISTEMA?.COMPONENTE_LISTO) {
                    await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.COMPONENTE_LISTO, {
                        componente: COMPONENTE_ID,
                        modo: modoHandler.obtenerModoActual(),
                        timestamp: new Date().toISOString()
                    });
                }
                
                _initialized = true;
                estado.inicializado = true;
                
                return {
                    componente: COMPONENTE_ID,
                    modo: estado.modo,
                    paradasLocales: puntosRuta.length,
                    paradasPadre: estado.aventuraParadas.length,
                    timestamp: new Date().toISOString()
                };
                
            } catch (error) {
                console.error('Error en la inicialización:', error);
                mostrarEstadoCarga(false, 'Error en la inicialización: ' + (error.message || 'Error desconocido'), true);
                throw error;
            } finally {
                estado.inicializando = false;
            }
        })();
        
        return _initializationPromise;
    }
    
    // Inicializar cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', inicializar);
    </script>
</head>
<body>
    <div id="zona-boton-casa">
        <button id="gps-casa-btn" class="off">
            <div class="button-content">
                <span class="satellite-emoji">🛰️</span>
                <span class="gps-label">OFF</span>
            </div>
        </button>
        <div id="paradas-window" class="visible">
            <div id="lista-paradas">
                <!-- Los botones de paradas se generan dinámicamente -->
            </div>
        </div>
    </div>
    <div id="estado-carga"></div>
</body>
</html>
