<!DOCTYPE html>
<html lang="es">
<head>
    <script type="module">
      try {
        const moduloMensajeria = await import('./js/mensajeria.js');
        window.Mensajeria = moduloMensajeria.default || moduloMensajeria;
        if (window.Mensajeria && typeof window.Mensajeria.inicializarMensajeria === 'function') {
          window.Mensajeria.inicializarMensajeria({
            iframeId: 'hijo5-casa',
            logLevel: 1,
            debug: true
          });

          // ================== MANEJADORES DE MENSAJES ==================
          // 1. Inicializaci√≥n (confirmaci√≥n al padre)
          Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.INICIALIZACION, function(mensaje) {
            console.log('[HIJO5] Confirmando inicializaci√≥n al padre');
            
            // Notificar al padre que est√° listo
            Mensajeria.enviarMensajeConReintenos(
              'padre',
              Mensajeria.TIPOS_MENSAJE.INICIALIZACION,
              { 
                estado: 'listo', 
                timestamp: Date.now(),
                modo: gpsOn ? 'aventura' : 'casa'
              }
            );
          });

          // 2. Cambio de modo (desde padre u otro hijo)
          Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.CAMBIO_MODO, function(mensaje) {
            console.log('[HIJO5] Cambio de modo recibido:', mensaje.datos);
            const nuevoModo = mensaje.datos.modo || 'aventura';
            
            // Actualizar el estado del GPS seg√∫n el modo
            if (nuevoModo === 'casa') {
              gpsOn = false;
              modoCasa = true;
              detenerSeguimientoGPS();
            } else {
              gpsOn = true;
              modoCasa = false;
              iniciarSeguimientoGPS();
            }
            
            // Actualizar la interfaz
            actualizarBotonGPS();
            
            // Notificar al padre del cambio de estado
            Mensajeria.enviarMensajeConReintenos(
              'padre',
              Mensajeria.TIPOS_MENSAJE.CAMBIO_MODO,
              { 
                modo: nuevoModo,
                gpsActivo: gpsOn,
                timestamp: Date.now()
              }
            );
          });

          // 3. Notificaciones de estado (desde otros hijos)
          Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.ESTADO, function(mensaje) {
            console.log('[HIJO5] Notificaci√≥n de estado recibida:', mensaje.datos);
            // Procesar notificaciones de estado si es necesario
          });

          // 4. Confirmaciones
          Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.CONFIRMACION, function(mensaje) {
            console.log('[HIJO5] Confirmaci√≥n recibida:', mensaje);
            // Procesar confirmaciones si es necesario
          });

          // 5. Manejar mensajes de error
          Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.ERROR, function(mensaje) {
            console.error('[HIJO5] Error recibido:', mensaje.datos);
            // Mostrar el error en la interfaz si es necesario
            if (mensaje.datos && mensaje.datos.mensaje) {
              mostrarError(mensaje.datos.mensaje);
            }
          });

          // 6. Notificar al padre que est√° listo
          Mensajeria.enviarMensajeConReintenos(
            'padre',
            Mensajeria.TIPOS_MENSAJE.INICIALIZACION,
            { 
              estado: 'listo', 
              timestamp: Date.now(),
              modo: gpsOn ? 'aventura' : 'casa'
            }
          );
        }
      } catch (e) {
        console.error('No se pudo cargar mensajeria.js', e);
      }
    </script>
  </head>
  <body>
    <style>
    /* Contenedor principal */
    #zona-boton-casa {
      position: relative;
      width: 100%;
      height: 60px;
    }
    
    /* Bot√≥n GPS: medidas y estilos del primer c√≥digo */
    #gps-casa-btn {
      position: absolute;
      top: 5px;
      left: 5px;
      width: 50px;
      height: 50px;
      min-width: 50px;
      min-height: 50px;
      border-radius: 4px;
      border: 1px solid #fff;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      padding: 0;
      margin: 0 0 0 10px;
      position: relative;
      z-index: 10002;
      cursor: pointer;
      font-size: 16px;
      /* Estado inicial (OFF) */
      background-color: #f44336;
      border-color: #d32f2f;
    }
    
    /* Estado ON - Verde */
    #gps-casa-btn.on {
      background-color: #4CAF50 !important;
      border-color: #45a049 !important;
    }
    
    /* Estado OFF - Rojo */
    #gps-casa-btn.off {
      background-color: #f44336 !important;
      border-color: #d32f2f !important;
    }
    #gps-casa-btn:hover {
      opacity: 0.9;
      transform: scale(1.05);
    }
    #gps-casa-btn:active {
      transform: scale(0.95);
    }
    .button-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      line-height: 1;
    }
    .satellite-emoji {
      font-size: 35px;
      line-height: 1;
      margin-bottom: 2px;
      display: block;
    }
    .gps-label {
      font-size: 20px;
      font-weight: bold;
      line-height: 1;
      margin: 0;
      padding: 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    /* Ventana de paradas: est√©tica y medidas del segundo c√≥digo */
    #paradas-window {
      position: absolute;
      top: 0;
      left: 75px; 
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      display: none; /* Se controla desde JavaScript */
      padding: 0;
      border: 1px solid #e0e0e0;
      max-width: 300px;
      min-width: 250px;
      z-index: 10003;
      height: 60px; /* Altura total: 50px bot√≥n + 10px margen inferior */
      overflow: visible;
      padding-bottom: 1px; /* 1px de espacio debajo de la barra */
      /* Asegurar que no haya transiciones que interfieran */
      transition: none !important;
      /* Asegurar que no haya estilos en l√≠nea que sobrescriban */
      opacity: 1 !important;
      visibility: visible !important;
    }
    /* Clase para mostrar/ocultar la ventana */
    #paradas-window.visible {
      display: flex !important;
    }
    #paradas-window.hidden {
      display: none !important;
    }
    #paradas-list {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      padding: 8px 12px;
      margin: 0;
      overflow-x: auto;
      overflow-y: hidden;
      height: 100%;
      box-sizing: border-box;
      align-items: center;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
      gap: 8px;
      scrollbar-width: thin;
      scrollbar-color: #888 #f1f1f1;
      align-content: center;
    }
    
    /* Estilo para la barra de desplazamiento en WebKit (Chrome, Safari) */
    #paradas-list::-webkit-scrollbar {
      height: 5px;
    }
    
    #paradas-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    #paradas-list::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 3px;
    }
    
    #paradas-list::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    /* Hide scrollbar for Webkit browsers */
    #paradas-list::-webkit-scrollbar {
      display: none;
    }
    .parada-tramo-btn {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 4px 8px;
      margin: 0 2px;
      cursor: pointer;
      font-size: 14px;
      display: inline-block;
      height: 50px;
      white-space: nowrap;
      width: auto;
      min-width: max-content;
    }
    
    .btn-content {
      display: inline-block;
      white-space: nowrap;
    }
    
    .btn-icon {
      margin-right: 4px;
    }
    .parada-btn {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      min-width: max-content;
      padding: 4px 8px;
      border: none !important;
    }
    .tramo-btn {
      background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
      color: white;
      border: none !important;
    }
    .inicio-btn {
      background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
      color: white;
      border: none !important;
    }
    .parada-tramo-btn.actual {
      border: 2px solid #ffd700 !important;
      box-shadow: 0 0 0 2px #ffd700, 0 0 15px rgba(255, 215, 0, 0.7) !important;
      transform: scale(1.05);
      font-weight: bold;
      z-index: 2;
      position: relative;
    }
    .btn-icon {
      font-size: 1.5em;
      flex-shrink: 0;
    }
    .btn-title {
      font-weight: 600;
      white-space: nowrap;
      font-size: 0.95em;
      margin-bottom: 2px;
    }
    .btn-desc {
      font-size: 0.85em;
      opacity: 0.9;
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      max-width: 130px;
      font-weight: 500;
      line-height: 1.2;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2; /* Standard property */
      -webkit-box-orient: vertical;
      text-align: left;
      position: relative;
    }
    
    /* Fallback for Firefox */
    @supports (-moz-appearance: none) {
      .btn-desc {
        display: -moz-box;
        -moz-box-orient: vertical;
      }
    }
    
    /* Estilos para la ventana de paradas */
    #paradas-window {
      position: absolute;
      top: 0;
      left: 60px; /* Alinear con el borde derecho del bot√≥n */
      width: 300px; /* Ancho fijo para la ventana */
      background: white;
      border: 1px solid #ddd;
      border-radius: 0 4px 4px 0;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
      max-height: 400px;
      overflow-y: auto;
      display: none; /* Inicialmente oculto */
    }
    
    #paradas-list {
      padding: 10px;
    }
    
    /* Asegurar que el contenedor principal tenga posici√≥n relativa */
    #zona-boton-casa {
      position: relative;
      display: inline-block;
    }
    
    .parada-tramo-btn {
      display: block;
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      text-align: left;
      border: 1px solid #eee;
      border-radius: 4px;
      background-color: white;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .parada-tramo-btn:hover {
      background-color: #f5f5f5;
    }
    
    .parada-btn {
      border-left: 4px solid #4CAF50;
    }
    
    .tramo-btn {
      border-left: 4px solid #2196F3;
    }
    
    .inicio-btn {
      border-left: 4px solid #FF9800;
    }
    
    .actual {
      font-weight: bold;
      background-color: #e3f2fd;
    }
    
    .badge {
      float: right;
      background-color: #4CAF50;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 0.8em;
    }
  </style>
</head>
<body>
  <div id="zona-boton-casa">
    <button id="gps-casa-btn" class="on" title="Activar GPS">
      <div class="button-content">
        <span class="satellite-emoji">üì°</span>
        <span class="gps-label">ON</span>
      </div>
    </button>
    <div id="paradas-container" class="paradas-container">
      <!-- Las paradas y tramos se agregar√°n aqu√≠ din√°micamente -->
    </div>
    <div id="paradas-window">
      <div id="paradas-list"></div>
    </div>
  </div>
  <script>
    // Manejador de errores global
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('Error global detectado:', {message, source, lineno, colno, error});
      return true; // Previene el manejador de errores por defecto
    };

    // ================== DECLARACIONES INICIALES ==================
    // Variables globales
    let gpsOn = true;  // Estado del GPS (true = activo, false = inactivo)
    let modoCasa = !gpsOn;  // Modo casa (cuando el GPS est√° inactivo)
    let paradaActual = -1;  // Parada actual seleccionada
    let tramoActual = -1;   // Tramo actual seleccionado
    let watchId = null;     // ID del watcher de geolocalizaci√≥n
    let controlesHabilitados = true;  // Estado de los controles
    let motivoDeshabilitado = '';     // Raz√≥n por la que est√°n deshabilitados los controles

    // ================== FUNCIONES DE CONTROL ==================
    function enableControls(modo = 'casa', { motivo = 'sin_especificar', forzar = false } = {}) {
        console.log(`üîì Habilitando controles en modo ${modo} (${motivo})`);
        modoCasa = modo === 'casa';

        // Actualizar estado del bot√≥n GPS
        const gpsBtn = document.getElementById('gps-casa-btn');
        if (gpsBtn) {
            gpsBtn.disabled = false;
            gpsBtn.classList.toggle('on', modo === 'aventura');
            gpsBtn.classList.toggle('off', modo !== 'aventura');
            gpsBtn.title = modo === 'aventura' ? 'GPS Activado' : 'GPS Desactivado';
        }

        // Notificar al padre
        window.parent.postMessage({
            tipo: 'cambiarModo',
            modo: modo,
            timestamp: new Date().toISOString()
        }, '*');
    }

    // ================== FUNCIONES DE UTILIDAD ==================

    /**
     * Registra un mensaje en la consola si el modo debug est√° activado
     * @param {string} mensaje - Mensaje a registrar
     * @param {string} [tipo='log'] - Tipo de log (log, warn, error, info)
     */
    function log(mensaje, tipo = 'log') {
      if (!CONFIG.debug) return;
      const prefijo = `${CONFIG.logPrefix} [${new Date().toISOString()}]`;
      if (typeof console[tipo] === 'function') {
        console[tipo](`${prefijo} ${mensaje}`);
      } else {
        console.log(`${prefijo} [${tipo.toUpperCase()}] ${mensaje}`);
      }
    }

    /**
     * Muestra un mensaje de error en la interfaz
     * @param {string} mensaje - Mensaje de error a mostrar
     */
    function mostrarError(mensaje) {
      log(`ERROR: ${mensaje}`, 'error');
      // Aqu√≠ podr√≠as implementar l√≥gica para mostrar el error en la UI
    }

    // ================== FUNCIONES DE CONTROL ==================

    /**
     * Habilita los controles de la aplicaci√≥n
     * @param {string} modo - Modo de operaci√≥n ('casa' o 'aventura')
     * @param {Object} opciones - Opciones adicionales
     * @param {string} [opciones.motivo] - Raz√≥n del cambio
     * @param {boolean} [opciones.forzar] - Forzar la operaci√≥n
     */
    function enableControls(modo = CONFIG.defaultMode, { motivo = 'sin_especificar', forzar = false } = {}) {
      if (modo !== 'casa' && modo !== 'aventura') {
        console.error(`Modo no v√°lido: ${modo}`);
        return false;
      }

      if (controlesHabilitados && !forzar) {
        console.log(`Los controles ya est√°n habilitados en modo ${modo}.`, { motivo });
        return false;
      }

      console.log(`Habilitando controles en modo ${modo}. Motivo: ${motivo}`);
      controlesHabilitados = true;
      motivoDeshabilitado = '';
      gpsActivo = (modo === 'aventura');

      // Actualizar la interfaz
      actualizarBotonGPS();

      // Notificar el cambio de modo
      if (window.Mensajeria) {
        Mensajeria.enviarMensajeConReintenos(
          'padre',
          'sistema:configuracion',
          { modo, habilitado: true, motivo }
        ).catch(console.error);
      }

      return true;
    }

    /**
     * Deshabilita los controles de la aplicaci√≥n
     * @param {string} motivo - Raz√≥n por la que se deshabilitan los controles
     * @returns {boolean} - True si se deshabilitaron los controles, false si ya estaban deshabilitados
     */
    function disableControls(motivo = 'sin_especificar') {
      if (!controlesHabilitados) {
        console.log('Los controles ya est√°n deshabilitados.', { motivo: motivoDeshabilitado });
        return false;
      }

      console.log(`Deshabilitando controles. Motivo: ${motivo}`);
      controlesHabilitados = false;
      motivoDeshabilitado = motivo;

      // Detener el seguimiento GPS si est√° activo
      if (gpsActivo) {
        gpsActivo = false;
        detenerSeguimientoGPS();
        actualizarBotonGPS();
      }

      return true;
    }

    // Array completo de paradas y tramos
    const puntosRuta = [
      { tipo: "inicio", parada: 0, nombre: "Torres de Serranos (start)" },
      { tipo: "tramo", tramo: 1, nombre: "Torres de Serranos ‚Üí Plaza de la crida (Puente de Serranos)" },
      { tipo: "parada", parada: 1, nombre: "Plaza de la crida (Puente de Serranos)" },
      { tipo: "tramo", tramo: 2, nombre: "Plaza de la crida ‚Üí Calle Muro de Santa Ana" },
      { tipo: "parada", parada: 2, nombre: "Calle Muro de Santa Ana" },
      { tipo: "tramo", tramo: 3, nombre: "Calle Muro de Santa Ana ‚Üí Palacio de los Borgia" },
      { tipo: "parada", parada: 3, nombre: "Iglesia de San Lorenzo" },
      { tipo: "tramo", tramo: 4, nombre: "Iglesia de San Lorenzo ‚Üí Plaza de la Virgen" },
      { tipo: "parada", parada: 4, nombre: "Plaza de la Virgen Reto 6" },
      { tipo: "parada", parada: 5, nombre: "Plaza de la Virgen Reto 7" },
      { tipo: "tramo", tramo: 5, nombre: "Plaza de la Virgen ‚Üí Plaza de la Almo√≠na" },
      { tipo: "parada", parada: 6, nombre: "Panel cer√°mico muro Catedral" },
      { tipo: "parada", parada: 7, nombre: "Capilla exterior catedral Reto 10" },
      { tipo: "parada", parada: 8, nombre: "Capilla exterior catedral Reto 11" },
      { tipo: "parada", parada: 9, nombre: "Arco Novo Catedral y Puerta Negra Bas√≠lica" },
      { tipo: "parada", parada: 10, nombre: "Casa del Punt de Gantxo" },
      { tipo: "tramo", tramo: 6, nombre: "Plaza de la Almo√≠na ‚Üí Plaza Decimo Junio Bruto (Museo Arqueol√≥gico de la Almo√≠na)" },
      { tipo: "parada", parada: 11, nombre: "Museo arqueol√≥gico La Almo√≠na" },
      { tipo: "parada", parada: 12, nombre: "Museo arqueol√≥gico La Almo√≠na" },
      { tipo: "parada", parada: 13, nombre: "Vista de la Catedral, Cimborrio" },
      { tipo: "tramo", tramo: 7, nombre: "Museo arqueol√≥gico La Almo√≠na ‚Üí Palacio Arzobispal" },
      { tipo: "parada", parada: 14, nombre: "Palacio Arzobispal y Puerta Rom√°nica de la Catedral" },
      { tipo: "parada", parada: 15, nombre: "Puerta Rom√°nica de la Catedral" },
      { tipo: "tramo", tramo: 8, nombre: "Puerta Rom√°nica de la Catedral ‚Üí Plaza del Ayuntamiento" },
      { tipo: "parada", parada: 16, nombre: "Plaza del Ayuntamiento" },
      { tipo: "tramo", tramo: 9, nombre: "Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento de Val√®ncia" },
      { tipo: "parada", parada: 17, nombre: "Edificio del Ayuntamiento" },
      { tipo: "parada", parada: 18, nombre: "Edificio del Ayuntamiento" },
      { tipo: "tramo", tramo: 10, nombre: "Edificio del Ayuntamiento ‚Üí Estaci√≥n del Norte" },
      { tipo: "parada", parada: 19, nombre: "Estaci√≥n del Norte" },
      { tipo: "tramo", tramo: 11, nombre: "Estaci√≥n del Norte ‚Üí Plaza de Toros de Val√®ncia" },
      { tipo: "tramo", tramo: 12, nombre: "Plaza de Toros ‚Üí Casa estilo √Årabe" },
      { tipo: "parada", parada: 20, nombre: "Casa estilo √Årabe" },
      { tipo: "parada", parada: 21, nombre: "Casa estilo √Årabe, mitad Aventura" },
      { tipo: "tramo", tramo: 13, nombre: "Casa estilo √Årabe ‚Üí Palacio de Comunicaciones (Correos)" },
      { tipo: "parada", parada: 22, nombre: "Palacio de Comunicaciones: Correos" },
      { tipo: "parada", parada: 23, nombre: "Edificio Suay" },
      { tipo: "tramo", tramo: 14, nombre: "Palacio de Comunicaciones ‚Üí Banco de Val√®ncia" },
      { tipo: "parada", parada: 24, nombre: "Banco de Valencia" },
      { tipo: "tramo", tramo: 15, nombre: "Banco de Val√®ncia ‚Üí Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica)" },
      { tipo: "parada", parada: 25, nombre: "Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica)" },
      { tipo: "tramo", tramo: 16, nombre: "Palacio del Marqu√©s ‚Üí Mercado Central" },
      { tipo: "parada", parada: 26, nombre: "Mercado central" },
      { tipo: "tramo", tramo: 17, nombre: "Mercado Central ‚Üí Lonja de la Seda" },
      { tipo: "parada", parada: 27, nombre: "Lonja de la Seda" },
      { tipo: "tramo", tramo: 18, nombre: "Lonja de la Seda ‚Üí Plaza Redonda" },
      { tipo: "parada", parada: 28, nombre: "Plaza Redonda" },
      { tipo: "tramo", tramo: 19, nombre: "Plaza Redonda ‚Üí Iglesia de los Santos Juanes" },
      { tipo: "parada", parada: 29, nombre: "Iglesia de los Santos Juanes" },
      { tipo: "tramo", tramo: 20, nombre: "Iglesia de los Santos Juanes ‚Üí Mercado Central" },
      { tipo: "tramo", tramo: 21, nombre: "Mercado Central ‚Üí Palacio de la Generalitat" },
      { tipo: "parada", parada: 30, nombre: "Palau de la Generalitat" },
      { tipo: "tramo", tramo: 22, nombre: "Palacio de la Generalitat ‚Üí Torres de Serranos (Final)" },
      { tipo: "parada", parada: 31, nombre: "Torres de Serranos (Final)" }
    ];

    // ================== FUNCIONES DE INTERFAZ ==================

    function renderParadasYTramos() {
      try {
        const container = document.getElementById('paradas-list');
        if (!container) {
          console.log('No se encontr√≥ el contenedor de paradas');
          return;
        }

        // Limpiar contenedor
        container.innerHTML = '';

        // Crear elementos para cada punto de la ruta
        puntosRuta.forEach((punto) => {
          const btn = document.createElement('button');
          btn.className = 'parada-tramo-btn';

          const esParada = punto.tipo === 'parada' || punto.tipo === 'inicio';
          const esInicio = punto.tipo === 'inicio';
          const esActual = (esParada && punto.parada === paradaActual) || 
                         (!esParada && punto.tramo === tramoActual);

          if (esActual) btn.classList.add('actual');
          if (esParada) btn.classList.add('parada-btn');
          if (esInicio) btn.classList.add('inicio-btn');
          if (!esParada) btn.classList.add('tramo-btn');

          const numero = esParada ? punto.parada : punto.tramo;
          const icono = esParada ? (esInicio ? 'üèÅ' : 'üìç') : 'üõ£Ô∏è';
          const titulo = esParada ? (esInicio ? 'Inicio' : `Parada ${numero}`) : `Tramo ${numero}`;

          // Crear estructura del bot√≥n
          btn.innerHTML = `
            <div class="btn-content">
              <span class="btn-icon">${icono}</span>
              <span class="btn-title">${titulo}: ${punto.nombre}</span>
            </div>
          `;

          btn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();

            if (esParada) {
              paradaActual = punto.parada;
              tramoActual = -1;
            } else {
              tramoActual = punto.tramo;
              paradaActual = -1;
            }

            renderParadasYTramos();

            // Notificar al padre sobre la selecci√≥n
            if (window.parent) {
              const mensaje = {
                type: 'PUNTO_SELECCIONADO',
                origen: 'hijo5-casa',
                punto: {
                  tipo: esParada ? 'parada' : 'tramo',
                  id: esParada ? `P-${punto.parada}` : `TR-${punto.tramo}`,
                  numero: esParada ? punto.parada : punto.tramo,
                  nombre: punto.nombre,
                  datos: punto
                },
                modo: 'casa',
                timestamp: Date.now()
              };

              console.log('Enviando mensaje al padre:', mensaje);
              window.parent.postMessage(mensaje, '*');
            }
          };

          container.appendChild(btn);
        });

        console.log('Paradas y tramos renderizados correctamente');
      } catch (error) {
        console.error('Error al renderizar paradas y tramos:', error);
      }
    }

    /**
     * Maneja la selecci√≥n de un punto (parada o tramo)
     * @param {Object} punto - Punto seleccionado
     * @param {boolean} esParada - Indica si es una parada o un tramo
     * @param {Event} [event] - Objeto de evento del clic (opcional)
     */
    function manejarSeleccionPunto(punto, esParada, event) {
      try {
        // Prevenir el comportamiento por defecto del bot√≥n
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }

        // Solo procesar la selecci√≥n si estamos en modo GPS OFF (Modo Casa)
        if (gpsActivo) {
          console.log('Selecci√≥n ignorada: El GPS est√° activo (Modo Aventura)');
          return;
        }

        // Notificar al padre sobre la selecci√≥n
        if (window.parent) {
          const mensaje = {
            type: 'PUNTO_SELECCIONADO',
            origen: 'hijo5-casa',
            punto: {
              tipo: esParada ? 'parada' : 'tramo',
              id: esParada ? `P-${punto.parada}` : `TR-${punto.tramo}`,
              numero: esParada ? punto.parada : punto.tramo,
              nombre: punto.nombre
            },
            modo: 'casa',
            timestamp: Date.now()
          };

          console.log('Notificando al padre:', mensaje);
          window.parent.postMessage(mensaje, '*');
        }

      } catch (error) {
        console.error('Error al manejar selecci√≥n de punto:', error);
      }
    }

    /**
     * Env√≠a un mensaje de cambio de parada
     * @param {Object} punto - Punto de parada seleccionado
     */
    function enviarMensajeCambioParada(punto) {
      const mensaje = {
        tipo: 'cambiarParada',
        origen: 'hijo5-casa',
        parada: {
          id: `P-${punto.parada}`,
          numero: punto.parada,
          nombre: punto.nombre
        },
        modo: gpsActivo ? 'aventura' : 'casa',
        gpsActivo: gpsActivo,
        timestamp: Date.now()
      };

      enviarMensaje(mensaje);
    }

    /**
     * Env√≠a un mensaje de cambio de tramo
     * @param {Object} punto - Punto de tramo seleccionado
     */
    function enviarMensajeCambioTramo(punto) {
      const mensaje = {
        tipo: 'cambiarTramo',
        origen: 'hijo5-casa',
        tramo: {
          id: `TR-${punto.tramo}`,
          numero: punto.tramo,
          nombre: punto.nombre
        },
        modo: gpsActivo ? 'aventura' : 'casa',
        gpsActivo: gpsActivo,
        timestamp: Date.now()
      };

      enviarMensaje(mensaje);
    }

    /**
     * Env√≠a una notificaci√≥n de punto actual
     * @param {Object} punto - Punto actual
     * @param {boolean} esParada - Indica si es una parada o un tramo
     */
    function enviarNotificacionPuntoActual(punto, esParada) {
      const mensaje = {
        tipo: 'actualizarPuntoActual',
        origen: 'hijo5-casa',
        puntoActual: {
          tipo: esParada ? 'parada' : 'tramo',
          id: esParada ? `P-${punto.parada}` : `TR-${punto.tramo}`,
          numero: esParada ? punto.parada : punto.tramo,
          nombre: punto.nombre
        },
        modo: gpsActivo ? 'aventura' : 'casa',
        gpsActivo: gpsActivo,
        timestamp: Date.now()
      };

      enviarMensaje(mensaje);
    }

    // Inicializaci√≥n cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM completamente cargado');

      // Variables de √°mbito de m√≥dulo
      const gpsBtn = document.getElementById('gps-casa-btn');
      const paradasWindow = document.getElementById('paradas-window');
      let gpsOn = true; // Estado inicial del GPS

      if (!gpsBtn || !paradasWindow) {
        console.error('No se encontraron los elementos necesarios');
        return;
      }

      console.log('Elementos encontrados:', {gpsBtn, paradasWindow});

      // Funci√≥n para actualizar el estado visual del bot√≥n GPS
      function actualizarBotonGPS() {
        if (!gpsBtn) {
          console.error('No se encontr√≥ el bot√≥n GPS');
          return;
        }
        
        const label = gpsBtn.querySelector('.gps-label');
        
        console.log('Actualizando bot√≥n GPS. Estado:', gpsOn ? 'ON' : 'OFF');
        console.log('Ventana de paradas:', paradasWindow ? 'encontrada' : 'no encontrada');
        
        // Eliminar estilos en l√≠nea que puedan estar sobrescribiendo las clases
        gpsBtn.removeAttribute('style');
        
        // Actualizar clases
        if (gpsOn) {
          gpsBtn.classList.add('on');
          gpsBtn.classList.remove('off');
          gpsBtn.style.backgroundColor = '#4CAF50';
          gpsBtn.style.borderColor = '#45a049';
        } else {
          gpsBtn.classList.add('off');
          gpsBtn.classList.remove('on');
          gpsBtn.style.backgroundColor = '#f44336';
          gpsBtn.style.borderColor = '#d32f2f';
        }
        
        if (label) {
          label.textContent = gpsOn ? 'ON' : 'OFF';
          console.log('Texto del bot√≥n actualizado a:', label.textContent);
        }
        
        const nuevoTitulo = gpsOn ? 'Desactivar GPS (Modo Aventura)' : 'Activar GPS (Modo Casa)';
        gpsBtn.setAttribute('title', nuevoTitulo);
        console.log('T√≠tulo del bot√≥n actualizado a:', nuevoTitulo);
        
        if (paradasWindow) {
          const mostrarParadas = !gpsOn;
          
          // Usar clases para controlar la visibilidad
          if (mostrarParadas) {
            paradasWindow.classList.remove('hidden');
            paradasWindow.classList.add('visible');
          } else {
            paradasWindow.classList.remove('visible');
            paradasWindow.classList.add('hidden');
          }
          
          // Forzar un reflow para asegurar que los cambios se apliquen
          void paradasWindow.offsetHeight;
          
          console.log('Ventana de paradas:', mostrarParadas ? 'visible' : 'oculta', 
                     'clases:', paradasWindow.className);
        } else {
          console.error('No se encontr√≥ el elemento paradas-window');
        }

        // Notificar al padre del cambio de modo usando Mensajeria API
        const modo = gpsOn ? 'aventura' : 'casa';
        if (window.Mensajeria) {
          Mensajeria.enviarMensajeConReintenos(
            'padre',
            'cambioModo',
            {
              modo: modo,
              gpsActivo: gpsOn,
              mensaje: gpsOn ? 'Modo aventura activado' : 'Modo casa activado',
              timestamp: Date.now()
            }
          ).catch(error => {
            console.error('Error al enviar mensaje de cambio de modo:', error);
          });
          console.log(`üè† HIJO5: Notificado cambio de modo a ${modo} usando Mensajeria`);
        }

        // Persistencia en localStorage
        try {
          localStorage.setItem('gpsState', JSON.stringify(gpsOn));
        } catch (e) {
          console.error('Error al guardar el estado del GPS:', e);
        }
      }

      
      // Configurar el manejador de clic
      gpsBtn.onclick = function(e) {
        e.stopPropagation(); // Evitar la propagaci√≥n del evento
        console.log('Clic en el bot√≥n GPS. Estado actual:', gpsOn ? 'ON' : 'OFF');
        
        // Cambiar el estado
        gpsOn = !gpsOn;
        modoCasa = !gpsOn;
        gpsActivo = gpsOn; // Mantener sincronizado con gpsOn
        
        console.log('Nuevo estado GPS:', gpsOn ? 'ON' : 'OFF');
        console.log('Modo casa:', modoCasa ? 'S√≠' : 'No');
        
        // Actualizar la interfaz
        actualizarBotonGPS();
        
        // Si estamos en modo casa, renderizar las paradas
        if (!gpsOn) {
          console.log('Renderizando paradas...');
          renderParadasYTramos();
        } else {
          // Si estamos en modo aventura, detener el seguimiento GPS si existe
          if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
          }
        }
      };
      
      // Configurar el estado inicial
      try {
        const savedState = localStorage.getItem('gpsState');
        if (savedState !== null) {
          gpsOn = JSON.parse(savedState);
          modoCasa = !gpsOn;
          gpsActivo = gpsOn; // Asegurar que gpsActivo est√© sincronizado
        }
      } catch (e) {
        console.error('Error al cargar el estado del GPS:', e);
      }
      
      console.log('Configurando estado inicial. gpsOn:', gpsOn, 'modoCasa:', modoCasa);
      
      // Asegurar que el estado inicial se refleje en la interfaz
      actualizarBotonGPS();
      
      // Si estamos en modo casa, cargar las paradas
      if (modoCasa) {
        console.log('Estado inicial: Modo casa. Renderizando paradas...');
        renderParadasYTramos();
      }
      
      // Notificar al padre que el componente est√° listo
      const modoInicial = gpsOn ? 'aventura' : 'casa';
      window.parent.postMessage({
        type: 'cambioModo',
        origen: 'hijo5-casa',
        datos: {
          modo: modoInicial,
          gpsActivo: gpsOn,
          mensaje: 'Componente listo',
          esInicial: true
        },
        timestamp: Date.now()
      }, '*');
      console.log(`üè† HIJO5: Componente listo en modo ${modoInicial}`);

      // Ocultar la ventana al hacer clic fuera de ella solo si el GPS est√° activo
      document.addEventListener('click', function(e) {
        const paradasWindow = document.getElementById('paradas-window');
        if (paradasWindow && e.target !== gpsBtn && !gpsBtn.contains(e.target) && !paradasWindow.contains(e.target)) {
          // Solo ocultar si el GPS est√° activo
          if (gpsActivo) {
            paradasWindow.style.display = 'none';
          }
        }
      });

      // Cargar el estado guardado o usar el valor por defecto
      try {
        const savedState = localStorage.getItem('gpsState');
        if (savedState !== null) {
          gpsOn = JSON.parse(savedState);
          modoCasa = !gpsOn;
        }
      } catch (e) {
        console.error('Error al cargar el estado del GPS:', e);
      }
      
      // Inicializar la interfaz
      actualizarBotonGPS();
      if (!gpsOn) renderParadasYTramos();
      
      // Notificar que el componente est√° listo
      if (window.parent) {
        window.parent.postMessage({
          type: 'HIJO5_LISTO',
          origen: 'hijo5-casa',
          gpsActivo: gpsOn,
          timestamp: Date.now()
        }, '*');
      }
    });

    // ================== FUNCIONES DE GPS ==================
    
    /**
     * Funci√≥n vac√≠a ya que el seguimiento GPS lo maneja otro componente
     */
    function iniciarSeguimientoGPS() {
      console.log('GPS activado - El seguimiento lo maneja otro componente');
      // No hacemos nada aqu√≠, otro componente maneja el seguimiento GPS
    }
    
    /**
     * Funci√≥n vac√≠a ya que el seguimiento GPS lo maneja otro componente
     */
    function detenerSeguimientoGPS() {
      console.log('GPS desactivado - El seguimiento lo maneja otro componente');
      // No hacemos nada aqu√≠, otro componente maneja el seguimiento GPS
    }
    
    /**
     * Actualiza el estado del bot√≥n GPS y notifica a otros componentes
     * @deprecated Esta funci√≥n ha sido reemplazada por actualizarInterfaz()
     */
    function actualizarBotonGPS() {
      console.log('actualizarBotonGPS() llamado');
      
      // Notificar al padre usando Mensajeria
      if (window.Mensajeria && typeof window.Mensajeria.enviarMensajeConReintenos === 'function') {
        const mensaje = {
          gpsActivo: gpsActivo,
          modo: gpsActivo ? 'aventura' : 'casa',
          timestamp: Date.now()
        };
        
        // Enviar al padre
        window.Mensajeria.enviarMensajeConReintenos(
          'padre',
          'GPS_STATE_CHANGE',
          mensaje
        ).catch(error => {
          console.error('Error al notificar cambio de estado GPS:', error);
        });
        
        // Notificar a otros iframes (si es necesario)
        // Esto ahora se manejar√° a trav√©s del padre o mediante eventos personalizados
      }
      
      // Llamar a las funciones de seguimiento GPS si existen
      if (gpsActivo) {
        if (typeof iniciarSeguimientoGPS === 'function') {
          iniciarSeguimientoGPS();
        }
      } else {
        if (typeof detenerSeguimientoGPS === 'function') {
          detenerSeguimientoGPS();
        }
      }
      
      // Guardar el estado en localStorage
      try {
        localStorage.setItem('gpsActivo', gpsActivo);
      } catch (e) {
        console.warn('No se pudo guardar en localStorage:', e);
      }
    }
    
    // ================== INICIALIZACI√ìN ==================
    
    // Inicializar el bot√≥n GPS cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', () => {
      // Cargar el estado guardado o usar el valor por defecto (false)
      try {
        const estadoGuardado = localStorage.getItem('gpsState');
        if (estadoGuardado !== null) {
          gpsActivo = JSON.parse(estadoGuardado);
        }
        
        // Configurar el manejador de clic del bot√≥n GPS
        const gpsBtn = document.getElementById('gps-casa-btn');
        if (gpsBtn) {
          gpsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Cambiar el estado del GPS
            gpsActivo = !gpsActivo;
            
            // Actualizar la interfaz
            actualizarBotonGPS();
            
            // Mostrar/ocultar la ventana de paradas
            const paradasWindow = document.getElementById('paradas-window');
            if (paradasWindow) {
              if (paradasWindow.style.display === 'block') {
                paradasWindow.style.display = 'none';
              } else {
                paradasWindow.style.display = 'block';
                renderParadasYTramos();
              }
            }
            
            // Notificar el cambio de estado al padre si es necesario
            if (window.parent) {
              window.parent.postMessage({
                type: 'cambiarModo',
                modo: gpsActivo ? 'aventura' : 'casa',
                origen: 'hijo5-casa',
                timestamp: Date.now()
              }, '*');
            }
            
            // Guardar el estado
            try {
              localStorage.setItem('gpsState', JSON.stringify(gpsActivo));
            } catch (e) {
              console.error('Error al guardar el estado del GPS:', e);
            }
          });
          
          // Inicializar el estado del bot√≥n
          actualizarBotonGPS();
        }
        
        // Inicializar el seguimiento GPS si est√° activo
        if (gpsActivo) {
          iniciarSeguimientoGPS();
        }
        
      } catch (error) {
        console.error('Error al inicializar el bot√≥n GPS:', error);
      }
    });
    
    // ================== MANEJO DE MODO ==================
    
    /**
     * Maneja el cambio de modo de la aplicaci√≥n
     * @param {string} modo - Nuevo modo ('casa' o 'aventura')
     * @param {boolean} [habilitar=true] - Si se deben habilitar los controles
     * @param {Object} opciones - Opciones adicionales
     * @param {string} [opciones.motivo='cambio_modo'] - Raz√≥n del cambio
     * @param {boolean} [opciones.forzar=false] - Forzar el cambio
     * @returns {boolean} - True si el cambio fue exitoso
     */
    function manejarCambioModo(modo, habilitar = true, { motivo = 'cambio_modo', forzar = false } = {}) {
      if (modo !== 'casa' && modo !== 'aventura') {
        console.error(`Modo no v√°lido: ${modo}`);
        return false;
      }
      
      console.log(`Cambiando a modo ${modo}. Habilitar: ${habilitar}, Motivo: ${motivo}`, { forzar });
      
      // Actualizar el estado local
      const nuevoEstadoGPS = (modo === 'aventura');
      
      // Si se debe habilitar/deshabilitar los controles
      if (habilitar) {
        enableControls(modo, { motivo, forzar });
      } else {
        disableControls(motivo);
      }
      
      // Actualizar el estado del GPS seg√∫n el modo
      if (gpsActivo !== nuevoEstadoGPS) {
        gpsActivo = nuevoEstadoGPS;
        actualizarBotonGPS();
      }
      
      // Notificar el cambio
      if (window.Mensajeria) {
        Mensajeria.enviarMensajeConReintenos(
          'padre',
          'sistema:configuracion',
          { modo, habilitado: habilitar, motivo }
        ).catch(console.error);
      }
      
      return true;
    }
    
    /**
     * Maneja los mensajes entrantes a trav√©s de Mensajeria.js
     * @param {Object} mensaje - Objeto de mensaje recibido
     * @param {string} tipo - Tipo de mensaje
     * @param {Object} datos - Datos del mensaje
     * @param {string} origen - Origen del mensaje
     */
    function manejarMensaje({ tipo, datos, origen }) {
      try {
        console.log(`[HIJO5] Mensaje recibido - Tipo: ${tipo}`, datos);
        
        switch (tipo) {
          case 'sistema:configuracion':
            if (datos?.estado) {
              gpsActivo = datos.estado.modo === 'aventura';
              if (datos.estado.puntoActual) {
                tramoActual = datos.estado.puntoActual.numero;
              }
              actualizarBotonGPS();
              if (!gpsActivo) renderParadasYTramos();
            }
            break;
            
          case 'sistema:gps_estado':
            if (typeof datos?.activo !== 'undefined') {
              gpsActivo = datos.activo;
              actualizarBotonGPS();
              const paradasWindow = document.getElementById('paradas-window');
              if (gpsActivo && paradasWindow) {
                paradasWindow.style.display = 'none';
              } else if (!gpsActivo) {
                renderParadasYTramos();
              }
            }
            break;
            
          case 'navegacion:cambio_parada':
            if (typeof datos?.parada !== 'undefined') {
              tramoActual = datos.parada;
              renderParadasYTramos();
            }
            break;
            
          case 'navegacion:cambio_tramo':
            if (typeof datos?.tramo !== 'undefined') {
              tramoActual = datos.tramo;
              renderParadasYTramos();
            }
            break;
            
          // Manejo de mensajes de cambio de modo para compatibilidad
          case 'cambiarModo':
            if (datos?.modo === 'casa' || datos?.modo === 'aventura') {
              manejarCambioModo(datos.modo);
            }
            break;
            
          case 'cambiarParada':
            if (typeof datos?.parada === 'number') {
              tramoActual = datos.parada;
              renderParadasYTramos();
            }
            break;
            
          case 'cambiarTramo':
            if (typeof datos?.tramo === 'number') {
              tramoActual = datos.tramo;
              renderParadasYTramos();
            }
            break;
            
          case 'SET_GPS_STATE':
            if (typeof datos?.gpsActivo !== 'undefined') {
              gpsActivo = !!datos.gpsActivo;
              actualizarBotonGPS();
              if (!gpsActivo) renderParadasYTramos();
            }
            break;
            
          case 'sincronizarEstado':
            if (datos?.estado) {
              gpsActivo = datos.estado.modo === 'aventura';
              if (datos.estado.puntoActual) {
                tramoActual = datos.estado.puntoActual.numero;
              }
              actualizarBotonGPS();
              if (!gpsActivo) renderParadasYTramos();
            }
            break;
            
          default:
            console.log(`[HIJO5] Tipo de mensaje no manejado: ${tipo}`, datos);
            break;
        }
      } catch (error) {
        console.error('Error en manejarMensaje:', error);
      }
    }
    
    // Registrar manejador de mensajes usando Mensajeria API
    if (window.Mensajeria) {
      Mensajeria.registrarControlador('mensaje', manejarMensaje);
      console.log('Manejador de mensajes registrado con Mensajeria API');
    }

    // Inicializaci√≥n avanzada
    (function init() {
      try {
        // Inicializar mensajer√≠a
        if (window.Mensajeria) {
          Mensajeria.inicializarMensajeria({
            iframeId: 'hijo5-casa',
            logLevel: 1, // INFO
            debug: true
          });
        }

        const savedState = localStorage.getItem('gpsState');
        if (savedState !== null) {
          gpsActivo = JSON.parse(savedState);
        }
      } catch (e) {
        console.error('Error en inicializaci√≥n:', e);
      }
      
      actualizarBotonGPS();
      if (!gpsActivo) renderParadasYTramos();
      
      // Notificar al padre usando mensajer√≠a
      if (window.Mensajeria) {
        Mensajeria.enviarMensajeConReintenos(
          'padre', 
          'sistema:inicializacion', 
          { 
            gpsActivo: gpsActivo,
            modo: gpsActivo ? 'aventura' : 'casa',
            timestamp: Date.now()
          }
        ).then(() => {
          console.log('Notificaci√≥n de inicializaci√≥n enviada correctamente');
        }).catch(error => {
          console.error('Error al enviar notificaci√≥n de inicializaci√≥n:', error);
        });
      }
    })();
  </script>
</body>
</html>
