<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aventura 1 - Padre</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Estilos del padre original... */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        #mapa { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
        body { margin: 0; padding: 0; background: transparent; }
        iframe { background: transparent; }
        
        /* ================== VARIABLES Y ESTILO HIJO 4 (RETOS) ================== */
        :root {
            --iframe-hijo4-width: 90%;
            --iframe-hijo4-max-width: 600px;
            --iframe-hijo4-height: 70vh;
            --iframe-hijo4-top: 15vh;
            --iframe-hijo4-left: 50%;
            --iframe-hijo4-translate-x: -50%;
            --iframe-hijo4-z: 2000;
            --iframe-hijo4-bg: rgba(255, 255, 255, 0.95);
            --iframe-hijo4-border-radius: 15px;
            --iframe-hijo4-box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
        }
        #hijo4 {
            position: fixed;
            top: var(--iframe-hijo4-top);
            left: var(--iframe-hijo4-left);
            width: var(--iframe-hijo4-width);
            max-width: var(--iframe-hijo4-max-width);
            height: var(--iframe-hijo4-height);
            transform: translateX(var(--iframe-hijo4-translate-x));
            z-index: var(--iframe-hijo4-z);
            background: var(--iframe-hijo4-bg);
            border-radius: var(--iframe-hijo4-border-radius);
            box-shadow: var(--iframe-hijo4-box-shadow);
            border: none;
            pointer-events: auto;
            display: none;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* ESTILO ACTUALIZADO PARA info-parada */
        #info-parada {
            font-weight: bold;
            margin: 0;
            padding: 12px 20px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1201;
            display: none;
            color: #2c3e50;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            bottom: 340px;
            min-width: 250px;
            max-width: 90vw;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }
        
        /* Estilos para los marcadores de navegaci√≥n */
        .marcador-inicio {
            color: #4CAF50; /* Verde para el punto de inicio */
            font-size: 24px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        .marcador-destino {
            color: #F44336; /* Rojo para el destino */
            font-size: 24px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        /* Estilo para la flecha de navegaci√≥n */
        .flecha-navegacion {
            color: #1E88E5; /* Azul para la flecha */
            font-size: 24px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            transform-origin: center;
            transform: rotate(0deg);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        /* Estilos para los marcadores personalizados */
        .custom-marker {
            position: relative;
            width: 30px;
            height: 42px;
            text-align: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            line-height: 42px;
        }
        
        .marker-pin {
            position: absolute;
            width: 30px;
            height: 42px;
            background: #007bff;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            left: 0;
            top: 0;
            margin: -21px 0 0 -15px;
        }
        
        /* Estilos para el marcador verde */
        .green-pin .marker-pin {
            background: #28a745;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .green-pin::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            margin: 3px 0 0 3px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
            opacity: 0.3;
        }
        
        .marker-pin.start {
            background: #2ecc71;
        }
        
        .marker-pin.end {
            background: #3498db;
        }
        
        .custom-marker span {
            position: relative;
            top: -10px;
            left: 0;
            width: 100%;
            text-align: center;
            display: inline-block;
            transform: rotate(45deg);
        }
        #info-parada.error {
            background-color: #ffeaea;
            color: #b30000;
            border: 1.5px solid #b30000;
            animation: shake 0.3s;
        }
        @keyframes shake {
            0% { transform: translateX(-50%) translateY(0); }
            25% { transform: translateX(-50%) translateY(-3px); }
            50% { transform: translateX(-50%) translateY(3px); }
            75% { transform: translateX(-50%) translateY(-3px); }
            100% { transform: translateX(-50%) translateY(0); }
        }

        /* ================== ESTILO PARA VIDEO E IMAGEN ================== */
        #media-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 4000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        #media-container {
            width: 70vw; /* 70% del ancho de la ventana */
            height: 70vh; /* 70% de la altura de la ventana */
            max-width: 70vw;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            padding: 15px;
        }

        #close-media {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 1.2em;
            cursor: pointer;
            z-index: 4001;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #parada-video, #parada-imagen {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            display: none;
            border-radius: 8px;
            object-fit: contain; /* Mantiene proporci√≥n sin cortar */
        }
    </style>
</head>
<body>

    <img id="logo-aventura" src="https://valenciavguides.github.io/Aventura-1-esp-padre-con-hijos/fotos_Av1/LOGO%20LETRAS%20FINAL%20transparente%20recorte.png" alt="Logo" style="position: fixed; top: -32px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 360px; height: 140px;" />

    <div id="mapa"></div>

    <div id="info-parada"></div>
    
    <!-- Fondo blanco para el logo con borde naranja -->
    <div style="position: fixed; top: 0; left: 2px; width: 98%; height: 80px; background: white; z-index: 2999; border: 2px solid #ec7c26; border-top: none; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;"></div>

    <!-- Rutas actualizadas para GitHub Pages -->
    <iframe id="hijo1-hamburguesa" src="./botones-y-subfunciones-hamburguesa.html" style="position:fixed; left:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; border: transparent; background:transparent; pointer-events:auto;"></iframe>
    <iframe id="hijo1-opciones" src="./botones-y-subfunciones-opciones.html" style="position:fixed; right:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; border: transparent; background:transparent; pointer-events:auto;"></iframe>
    <iframe id="hijo5-casa" src="./Av1-boton-casa.html" style="position:fixed; left:5px; top:81px; width:100px; height:calc(100vh - 105px); z-index:3002; border: transparent; background:transparent; pointer-events:auto; transition:width 0.3s; overflow:hidden;"></iframe>

    <iframe id="hijo3" src="./Av1_audio_esp.html"
            style="position:fixed;
                   bottom:-6px;
                   left:50%;
                   transform:translateX(-50%);
                   height:165px;
                   width:310px;
                   z-index:1000;
                   border: transparent;
                   display:block;
                   pointer-events:auto;"></iframe>

    <iframe id="hijo2" src="./Av1-botones-coordenadas.html"
            style="position:fixed;
                   bottom:150px;
                   left:50%;
                   transform:translateX(-50%);
                   height:165px;
                   width:310px;
                   z-index:1001;
                   border: none !important;
                   background-color: transparent !important;
                   overflow: hidden;
                   pointer-events:auto;"
            allow="geolocation"
            frameborder="0"></iframe>

    <iframe id="hijo4" src="./Av1-esp-retos-preguntas.html" style="display:none;"></iframe>

    <div id="media-overlay">
        <div id="media-container">
            <button id="close-media">X</button>
            <video id="parada-video" controls></video>
            <img id="parada-imagen">
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ================== ESTADO GLOBAL CENTRALIZADO ==================
        (function() {
        'use strict';
        
        const estadoGlobal = {
            modo: 'aventura', // 'aventura' o 'casa'
            puntoActual: null, // { tipo: 'parada'|'tramo', id: number, datos: {...} }
            ultimaActualizacion: Date.now(),
            // Datos compartidos entre iframes
            datosCompartidos: {
                // Datos de navegaci√≥n
                navegacionActiva: false,
                // Estado de reproducci√≥n de audio
                audio: {
                    reproduciendo: false,
                    paradaId: null,
                    src: null
                },
                // Estado de retos
                reto: {
                    activo: false,
                    completado: false,
                    paradaId: null
                },
                // Estado de la br√∫jula
                brujulaActiva: false
            }
        };

        // ================== FUNCIONES DE SINCRONIZACI√ìN ==================
        /**
         * Sincroniza el estado global con todos los iframes hijos
         // ================== COMUNICACI√ìN CON IFRAMES ==================
        function sincronizarEstadoConHijos() {
            const timestamp = Date.now();
            const mensaje = {
                type: 'sincronizarEstado',
                timestamp: timestamp,
                origen: 'padre',
                estado: {
                    modo: estadoGlobal.modo,
                    puntoActual: estadoGlobal.puntoActual,
                    datosCompartidos: estadoGlobal.datosCompartidos
                }
            };

            console.log(`üîÑ PADRE [${new Date(timestamp).toISOString()}]: Enviando sincronizaci√≥n a todos los hijos`, {
                modo: estadoGlobal.modo,
                puntoActual: estadoGlobal.puntoActual?.id || 'ninguno',
                origen: 'padre'
            });

            // Enviar a todos los iframes hijos con verificaci√≥n de disponibilidad
            const iframes = ['hijo2', 'hijo3', 'hijo4', 'hijo5-casa'];
            let iframesActivos = 0;
            let iframesConError = [];

            iframes.forEach(id => {
                const iframe = document.getElementById(id);
                if (iframe && iframe.contentWindow) {
                    try {
                        iframe.contentWindow.postMessage(mensaje, '*');
                        console.log(`   ‚úÖ Enviado a ${id}`);
                        iframesActivos++;
                    } catch (error) {
                        console.error(`   ‚ùå Error enviando a ${id}:`, error);
                        iframesConError.push(id);
                    }
                } else {
                    console.warn(`   ‚ö†Ô∏è Iframe ${id} no encontrado`);
                    iframesConError.push(id);
                }
            });

            // Registrar resumen de la sincronizaci√≥n
            console.group('üìä Resumen de sincronizaci√≥n');
            console.log(`üì§ Total iframes: ${iframes.length}`);
            console.log(`‚úÖ Iframes activos: ${iframesActivos}`);
            if (iframesConError.length > 0) {
                console.warn(`‚ùå Iframes con error: ${iframesConError.join(', ')}`);
            }
            console.groupEnd();

            return {
                total: iframes.length,
                exitosos: iframesActivos,
                errores: iframesConError.length,
                iframesConError: iframesConError
            };
        }

        /**
         * Actualiza el estado global y sincroniza con los hijos
         * @param {Object} actualizacion - Objeto con las propiedades a actualizar
         * @param {boolean} [sincronizar=true] - Indica si se debe sincronizar con los hijos
         * @returns {Promise<void>}
         */
        function actualizarEstadoGlobal(actualizacion) {
            // Fusionar la actualizaci√≥n con el estado global
            Object.assign(estadoGlobal, actualizacion);
            // Sincronizar con los hijos
            sincronizarEstadoConHijos();
        }

        // ================== ESTRUCTURA SIMPLIFICADA ==================
        // Ruta base para los archivos de audio
        const AUDIO_BASE_PATH = './audios/';
        
        const PARADAS = [
            // PARADA 0 - Torres de Serranos (start) - Reto 2
            { tipo: "inicio", parada: 0, idAudio: "P-0", nombre: "Torres de Serranos (start)", audio: AUDIO_BASE_PATH + "parada_0_torres_serranos.mp3", reto: 2 },
            // TRAMO 1 - Torres de Serranos ‚Üí Plaza de la crida (Puente de Serranos)
            { tipo: "tramo", tramo: 1, idAudio: "TR-1", nombre: "Torres de Serranos ‚Üí Plaza de la crida (Puente de Serranos)", audio: AUDIO_BASE_PATH + "tramo_1_torres_puente.mp3" },
            // PARADA 1 - Plaza de la crida (Puente de Serranos) - Reto 3
            { tipo: "parada", parada: 1, idAudio: "P-1", nombre: "Plaza de la crida (Puente de Serranos)", audio: AUDIO_BASE_PATH + "parada_1_plaza_crida.mp3", reto: 3 },
            // TRAMO 2 - Plaza de la crida ‚Üí Calle Muro de Santa Ana
            { tipo: "tramo", tramo: 2, idAudio: "TR-2", nombre: "Plaza de la crida ‚Üí Calle Muro de Santa Ana", audio: AUDIO_BASE_PATH + "tramo_2_plaza_muro_santa_ana.mp3" },
            // PARADA 2 - Calle Muro de Santa Ana - Reto 4
            { tipo: "parada", parada: 2, idAudio: "P-2", nombre: "Calle Muro de Santa Ana", audio: AUDIO_BASE_PATH + "parada_2_muro_santa_ana.mp3", reto: 4 },
            // TRAMO 3 - Calle Muro de Santa Ana ‚Üí Palacio de los Borgia
            { tipo: "tramo", tramo: 3, idAudio: "TR-3", nombre: "Calle Muro de Santa Ana ‚Üí Palacio de los Borgia", audio: AUDIO_BASE_PATH + "tramo_3_muro_palacio_borgia.mp3" },
            // PARADA 3 - Iglesia de San Lorenzo - Reto 5
            { tipo: "parada", parada: 3, idAudio: "P-3", nombre: "Iglesia de San Lorenzo", audio: AUDIO_BASE_PATH + "parada_3_iglesia_san_lorenzo.mp3", reto: 5 },
            // TRAMO 4 - Iglesia de San Lorenzo ‚Üí Plaza de la Virgen
            { tipo: "tramo", tramo: 4, idAudio: "TR-4", nombre: "Iglesia de San Lorenzo ‚Üí Plaza de la Virgen", audio: AUDIO_BASE_PATH + "tramo_4_iglesia_plaza_virgen.mp3" },
            // PARADA 4 - Plaza de la Virgen - Reto 6
            { tipo: "parada", parada: 4, idAudio: "P-4", nombre: "Plaza de la Virgen Reto 6", audio: AUDIO_BASE_PATH + "parada_4_plaza_virgen_reto6.mp3", reto: 6 },
            // PARADA 5 - Plaza de la Virgen - Reto 7, 8 (Puzzle plaza de la virgen)
            { tipo: "parada", parada: 5, idAudio: "P-5", nombre: "Plaza de la Virgen Reto 7", audio: AUDIO_BASE_PATH + "parada_5_plaza_virgen_reto7.mp3", reto: 7 },
            // TRAMO 5 - Plaza de la Virgen ‚Üí Plaza de la Almo√≠na
            { tipo: "tramo", tramo: 5, idAudio: "TR-5", nombre: "Plaza de la Virgen ‚Üí Plaza de la Almo√≠na", audio: AUDIO_BASE_PATH + "tramo_5_plaza_virgen_almoina.mp3" },
            // PARADA 6 - Panel cer√°mico muro Catedral
            { tipo: "parada", parada: 6, idAudio: "P-6", nombre: "Panel cer√°mico muro Catedral", audio: AUDIO_BASE_PATH + "parada_6_panel_ceramico.mp3" },
            // PARADA 7 - Capilla exterior catedral - Reto 10
            { tipo: "parada", parada: 7, idAudio: "P-7", nombre: "Capilla exterior catedral Reto 10", audio: AUDIO_BASE_PATH + "parada_7_capilla_exterior_reto10.mp3", reto: 10 },
            // PARADA 8 - Capilla exterior catedral - Reto 11
            { tipo: "parada", parada: 8, idAudio: "P-8", nombre: "Capilla exterior catedral Reto 11", audio: AUDIO_BASE_PATH + "parada_8_capilla_exterior_reto11.mp3", reto: 11 },
            // PARADA 9 - Arco Novo Catedral y Puerta Negra Bas√≠lica
            { tipo: "parada", parada: 9, idAudio: "P-9", nombre: "Arco Novo Catedral y Puerta Negra Bas√≠lica", audio: AUDIO_BASE_PATH + "parada_9_arco_novo_puerta_negra.mp3" },
            // PARADA 10 - Casa del Punt de Gantxo
            { tipo: "parada", parada: 10, idAudio: "P-10", nombre: "Casa del Punt de Gantxo", audio: AUDIO_BASE_PATH + "parada_10_casa_punt_gantxo.mp3" },
            // TRAMO 6 - Plaza de la Almo√≠na ‚Üí Plaza Decimo Junio Bruto
            { tipo: "tramo", tramo: 6, idAudio: "TR-6", nombre: "Plaza de la Almo√≠na ‚Üí Plaza Decimo Junio Bruto (Museo Arqueol√≥gico de la Almo√≠na)", audio: AUDIO_BASE_PATH + "tramo_6_almoina_museo_arqueologico.mp3" },
            // PARADA 11 - Plaza Decimo Junio Bruto (Museo Arqueol√≥gico de la Almo√≠na)
            { tipo: "parada", parada: 11, idAudio: "P-11", nombre: "Plaza Decimo Junio Bruto (Museo Arqueol√≥gico de la Almo√≠na)", audio: AUDIO_BASE_PATH + "parada_11_plaza_decimo_junio.mp3", reto: 14 },
            // TRAMO 7 - Plaza Decimo Junio Bruto ‚Üí Plaza de la Reina
            { tipo: "tramo", tramo: 7, idAudio: "TR-7", nombre: "Plaza Decimo Junio Bruto ‚Üí Plaza de la Reina", audio: AUDIO_BASE_PATH + "tramo_7_museo_plaza_reina.mp3" },
            // PARADA 12 - Plaza de la Reina (Torre del Micalet, Catedral)
            { tipo: "parada", parada: 12, idAudio: "P-12", nombre: "Plaza de la Reina (Torre del Micalet, Catedral)", audio: AUDIO_BASE_PATH + "parada_12_plaza_reina_micalet.mp3", reto: 15 },
            // TRAMO 8 - Plaza de la Reina ‚Üí Calle Barchilla
            { tipo: "tramo", tramo: 8, idAudio: "TR-8", nombre: "Plaza de la Reina ‚Üí Calle Barchilla", audio: AUDIO_BASE_PATH + "tramo_8_plaza_reina_barchilla.mp3" },
            // PARADA 13 - Calle Barchilla (Reto 16)
            { tipo: "parada", parada: 13, idAudio: "P-13", nombre: "Calle Barchilla Reto 16", audio: AUDIO_BASE_PATH + "parada_13_calle_barchilla_reto16.mp3", reto: 16 },
            // TRAMO 9 - Calle Barchilla ‚Üí Plaza Redonda
            { tipo: "tramo", tramo: 9, idAudio: "TR-9", nombre: "Calle Barchilla ‚Üí Plaza Redonda", audio: AUDIO_BASE_PATH + "tramo_9_barchilla_plaza_redonda.mp3" },
            // PARADA 14 - Plaza Redonda (Reto 17)
            { tipo: "parada", parada: 14, idAudio: "P-14", nombre: "Plaza Redonda Reto 17", audio: AUDIO_BASE_PATH + "parada_14_plaza_redonda_reto17.mp3", reto: 17 },
            // TRAMO 10 - Plaza Redonda ‚Üí Mercado Central
            { tipo: "tramo", tramo: 10, idAudio: "TR-10", nombre: "Plaza Redonda ‚Üí Mercado Central", audio: AUDIO_BASE_PATH + "tramo_10_plaza_redonda_mercado_central.mp3" },
            // PARADA 15 - Mercado Central (Reto 18)
            { tipo: "parada", parada: 15, idAudio: "P-15", nombre: "Mercado Central Reto 18", audio: AUDIO_BASE_PATH + "parada_15_mercado_central_reto18.mp3", reto: 18 },
            // TRAMO 11 - Mercado Central ‚Üí Lonja de la Seda
            { tipo: "tramo", tramo: 11, idAudio: "TR-11", nombre: "Mercado Central ‚Üí Lonja de la Seda", audio: AUDIO_BASE_PATH + "tramo_11_mercado_lonja_seda.mp3" },
            // PARADA 16 - Lonja de la Seda (Reto 19)
            { tipo: "parada", parada: 16, idAudio: "P-16", nombre: "Lonja de la Seda Reto 19", audio: AUDIO_BASE_PATH + "parada_16_lonja_seda_reto19.mp3", reto: 19 },
            // TRAMO 12 - Lonja de la Seda ‚Üí Plaza del Mercado
            { tipo: "tramo", tramo: 12, idAudio: "TR-12", nombre: "Lonja de la Seda ‚Üí Plaza del Mercado", audio: AUDIO_BASE_PATH + "tramo_12_lonja_plaza_mercado.mp3" },
            // PARADA 17 - Plaza del Mercado (Reto 20)
            { tipo: "parada", parada: 17, idAudio: "P-17", nombre: "Plaza del Mercado Reto 20", audio: AUDIO_BASE_PATH + "parada_17_plaza_mercado_reto20.mp3", reto: 20 },
            // TRAMO 13 - Plaza del Mercado ‚Üí Torres de Serranos Final
            { tipo: "tramo", tramo: 13, idAudio: "TR-13", nombre: "Plaza del Mercado ‚Üí Torres de Serranos Final", audio: AUDIO_BASE_PATH + "tramo_13_plaza_mercado_torres_serranos.mp3" },
            // PARADA 18 - Torres de Serranos (Final)
            { tipo: "parada", parada: 18, idAudio: "P-18", nombre: "Torres de Serranos Final", audio: AUDIO_BASE_PATH + "parada_18_torres_serranos_final.mp3", reto: 21 },
            // TRAMO 6 - Plaza de la Almo√≠na ‚Üí Plaza Decimo Junio Bruto (Museo Arqueol√≥gico de la Almo√≠na)
            { tipo: "tramo", tramo: 6, idAudio: "TR-6", nombre: "Plaza de la Almo√≠na ‚Üí Plaza Decimo Junio Bruto (Museo Arqueol√≥gico de la Almo√≠na)", audio: AUDIO_BASE_PATH + "tramo_6_almoina_museo_arqueologico.mp3" },
            // PARADA 11 - Museo arqueol√≥gico La Almo√≠na
            { tipo: "parada", parada: 11, idAudio: "P-11", nombre: "Museo arqueol√≥gico La Almo√≠na", audio: AUDIO_BASE_PATH + "parada_11_museo_almoina.mp3" },
            // PARADA 12 - Museo arqueol√≥gico La Almo√≠na (segunda parte)
            { tipo: "parada", parada: 12, idAudio: "P-12", nombre: "Museo arqueol√≥gico La Almo√≠na", audio: AUDIO_BASE_PATH + "parada_12_museo_almoina_2.mp3" },
            // PARADA 13 - Vista de la Catedral, Cimborrio
            { tipo: "parada", parada: 13, idAudio: "P-13", nombre: "Vista de la Catedral, Cimborrio", audio: AUDIO_BASE_PATH + "parada_13_vista_catedral_cimborrio.mp3" },
            // TRAMO 7 - Museo arqueol√≥gico La Almo√≠na ‚Üí Palacio Arzobispal
            { tipo: "tramo", tramo: 7, idAudio: "TR-7", nombre: "Museo arqueol√≥gico La Almo√≠na ‚Üí Palacio Arzobispal", audio: AUDIO_BASE_PATH + "tramo_7_almoina_palacio_arzobispal.mp3" },
            // PARADA 14 - Palacio Arzobispal y Puerta Rom√°nica de la Catedral
            { tipo: "parada", parada: 14, idAudio: "P-14", nombre: "Palacio Arzobispal y Puerta Rom√°nica de la Catedral", audio: AUDIO_BASE_PATH + "parada_14_palacio_arzobispal_puerta_romanica.mp3" },
            // PARADA 15 - Puerta Rom√°nica de la Catedral
            { tipo: "parada", parada: 15, idAudio: "P-15", nombre: "Puerta Rom√°nica de la Catedral", audio: AUDIO_BASE_PATH + "parada_15_puerta_romanica_catedral.mp3" },
            // TRAMO 8 - Puerta Rom√°nica de la Catedral ‚Üí Plaza del Ayuntamiento
            { tipo: "tramo", tramo: 8, idAudio: "TR-8", nombre: "Puerta Rom√°nica de la Catedral ‚Üí Plaza del Ayuntamiento", audio: AUDIO_BASE_PATH + "tramo_8_puerta_romanica_plaza_ayuntamiento.mp3" },
            // PARADA 16 - Plaza del Ayuntamiento
            { tipo: "parada", parada: 16, idAudio: "P-16", nombre: "Plaza del Ayuntamiento", audio: AUDIO_BASE_PATH + "parada_16_plaza_ayuntamiento.mp3" },
            // TRAMO 9 - Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento de Val√®ncia
            { tipo: "tramo", tramo: 9, idAudio: "TR-9", nombre: "Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento de Val√®ncia", audio: AUDIO_BASE_PATH + "tramo_9_plaza_ayuntamiento_edificio.mp3" },
            // PARADA 17 - Edificio del Ayuntamiento
            { tipo: "parada", parada: 17, idAudio: "P-17", nombre: "Edificio del Ayuntamiento", audio: AUDIO_BASE_PATH + "parada_17_edificio_ayuntamiento.mp3" },
            // PARADA 18 - Edificio del Ayuntamiento (continuaci√≥n)
            { tipo: "parada", parada: 18, idAudio: "P-18", nombre: "Edificio del Ayuntamiento", audio: AUDIO_BASE_PATH + "parada_18_edificio_ayuntamiento_2.mp3" },
            // TRAMO 10 - Edificio del Ayuntamiento ‚Üí Estaci√≥n del Norte
            { tipo: "tramo", tramo: 10, idAudio: "TR-10", nombre: "Edificio del Ayuntamiento ‚Üí Estaci√≥n del Norte", audio: AUDIO_BASE_PATH + "tramo_10_ayuntamiento_estacion_norte.mp3" },
            // PARADA 19 - Estaci√≥n del Norte
            { tipo: "parada", parada: 19, idAudio: "P-19", nombre: "Estaci√≥n del Norte", audio: AUDIO_BASE_PATH + "parada_19_estacion_norte.mp3" },
            // TRAMO 11 - Estaci√≥n del Norte ‚Üí Plaza de Toros de Val√®ncia
            { tipo: "tramo", tramo: 11, idAudio: "TR-11", nombre: "Estaci√≥n del Norte ‚Üí Plaza de Toros de Val√®ncia", audio: AUDIO_BASE_PATH + "tramo_11_estacion_plaza_toros.mp3" },
            // TRAMO 12 - Plaza de Toros ‚Üí Casa estilo √Årabe
            { tipo: "tramo", tramo: 12, idAudio: "TR-12", nombre: "Plaza de Toros ‚Üí Casa estilo √Årabe", audio: AUDIO_BASE_PATH + "tramo_12_plaza_toros_casa_arabe.mp3" },
            // PARADA 20 - Casa estilo √Årabe
            { tipo: "parada", parada: 20, idAudio: "P-20", nombre: "Casa estilo √Årabe", audio: AUDIO_BASE_PATH + "parada_20_casa_estilo_arabe.mp3" },
            // PARADA 21 - Casa estilo √Årabe, mitad Aventura
            { tipo: "parada", parada: 21, idAudio: "P-21", nombre: "Casa estilo √Årabe, mitad Aventura", audio: AUDIO_BASE_PATH + "parada_21_casa_arabe_mitad_aventura.mp3" },
            // TRAMO 13 - Casa estilo √Årabe ‚Üí Palacio de Comunicaciones (Correos)
            { tipo: "tramo", tramo: 13, idAudio: "TR-13", nombre: "Casa estilo √Årabe ‚Üí Palacio de Comunicaciones (Correos)", audio: AUDIO_BASE_PATH + "tramo_13_casa_arabe_correos.mp3" },
            // PARADA 22 - Palacio de Comunicaciones: Correos
            { tipo: "parada", parada: 22, idAudio: "P-22", nombre: "Palacio de Comunicaciones: Correos", audio: AUDIO_BASE_PATH + "parada_22_palacio_comunicaciones.mp3" },
            // PARADA 23 - Edificio Suay
            { tipo: "parada", parada: 23, idAudio: "P-23", nombre: "Edificio Suay", audio: AUDIO_BASE_PATH + "parada_23_edificio_suay.mp3" },
            // TRAMO 14 - Correos ‚Üí Banco de Val√®ncia
            { tipo: "tramo", tramo: 14, idAudio: "TR-14", nombre: "Palacio de Comunicaciones ‚Üí Banco de Val√®ncia", audio: AUDIO_BASE_PATH + "tramo_14_correos_banco_valencia.mp3" },
            // PARADA 24 - Banco de Valencia
            { tipo: "parada", parada: 24, idAudio: "P-24", nombre: "Banco de Valencia", audio: AUDIO_BASE_PATH + "parada_24_banco_valencia.mp3" },
            // TRAMO 15 - Banco de Val√®ncia ‚Üí Palacio del Marqu√©s de Dos Aguas
            { tipo: "tramo", tramo: 15, idAudio: "TR-15", nombre: "Banco de Valencia ‚Üí Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica)", audio: AUDIO_BASE_PATH + "tramo_15_banco_marques.mp3" },
            // PARADA 25 - Palacio del Marqu√©s de Dos Aguas
            { tipo: "parada", parada: 25, idAudio: "P-25", nombre: "Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica)", audio: AUDIO_BASE_PATH + "parada_25_marques_dos_aguas.mp3" },
            // TRAMO 16 - Palacio del Marqu√©s ‚Üí Mercado Central
            { tipo: "tramo", tramo: 16, idAudio: "TR-16", nombre: "Palacio del Marqu√©s ‚Üí Mercado Central", audio: AUDIO_BASE_PATH + "tramo_16_marques_mercado_central.mp3" },
            // PARADA 26 - Mercado Central
            { tipo: "parada", parada: 26, idAudio: "P-26", nombre: "Mercado Central", audio: AUDIO_BASE_PATH + "parada_26_mercado_central.mp3" },
            { tipo: "parada", parada: 26, nombre: "Mercado Central", audio: AUDIO_BASE_PATH + "parada_26_mercado_central.mp3" },
            // TRAMO 17 - Mercado Central ‚Üí Iglesia de los Santos Juanes
            { tipo: "tramo", tramo: 17, nombre: "Mercado Central ‚Üí Iglesia de los Santos Juanes", audio: AUDIO_BASE_PATH + "tramo_17_mercado_santos_juanes.mp3" },
            // PARADA 27 - Iglesia de los Santos Juanes - Reto 24
            { tipo: "parada", parada: 27, idAudio: "P-27", nombre: "Iglesia de los Santos Juanes reto 24", audio: AUDIO_BASE_PATH + "parada_27_santos_juanes_reto24.mp3", reto: 24 },
            // PARADA 28 - Iglesia de los Santos Juanes - Reto 25
            { tipo: "parada", parada: 28, idAudio: "P-28", nombre: "Iglesia de los Santos Juanes reto 25", audio: AUDIO_BASE_PATH + "parada_28_santos_juanes_reto25.mp3", reto: 25 },
            // TRAMO 18 - Iglesia Santos Juanes ‚Üí Lonja de Val√®ncia
            { tipo: "tramo", tramo: 18, idAudio: "TR-18", nombre: "Iglesia Santos Juanes ‚Üí Lonja de Val√®ncia (Mercado de la Seda)", audio: AUDIO_BASE_PATH + "tramo_18_santos_juanes_lonja.mp3" },
            // PARADA 29 - Lonja Puerta de Los Pecados barquero
            { tipo: "parada", parada: 29, idAudio: "P-29", nombre: "Lonja Puerta de Los Pecados barquero", audio: AUDIO_BASE_PATH + "parada_29_lonja_barquero.mp3" },
            // PARADA 30 - Lonja Puerta de Los Pecados √°rbol muerto
            { tipo: "parada", parada: 30, idAudio: "P-30", nombre: "Lonja Puerta de Los Pecados √°rbol muerto", audio: AUDIO_BASE_PATH + "parada_30_lonja_arbol_muerto.mp3" },
            // TRAMO 19 - Lonja G√°rgolas
            { tipo: "tramo", tramo: 19, idAudio: "TR-19", nombre: "Lonja G√°rgolas", audio: AUDIO_BASE_PATH + "tramo_19_lonja_gargolas.mp3" },
            // PARADA 31 - Lonja G√°rgolas √°ngel vasija
            { tipo: "parada", parada: 31, idAudio: "P-31", nombre: "Lonja G√°rgolas √°ngel vasija", audio: AUDIO_BASE_PATH + "parada_31_lonja_angel_vasija.mp3" },
            // PARADA 32 - Lonja G√°rgolas barbudo y le√≥n
            { tipo: "parada", parada: 32, idAudio: "P-32", nombre: "Lonja G√°rgolas barbudo y le√≥n", audio: AUDIO_BASE_PATH + "parada_32_lonja_barbudo_leon.mp3" },
            // PARADA 33 - Lonja G√°rgolas fornicador ventana
            { tipo: "parada", parada: 33, idAudio: "P-33", nombre: "Lonja G√°rgolas fornicador ventana", audio: AUDIO_BASE_PATH + "parada_33_lonja_fornicador_ventana.mp3" },
            // TRAMO 20 - Lonja ‚Üí Plaza del Doctor Collado
            { tipo: "tramo", tramo: 20, idAudio: "TR-20", nombre: "Lonja ‚Üí Plaza del Doctor Collado", audio: AUDIO_BASE_PATH + "tramo_20_lonja_plaza_collado.mp3" },
            // TRAMO 21 - Plaza del Doctor Collado ‚Üí Plaza del Negrito
            { tipo: "tramo", tramo: 21, idAudio: "TR-21", nombre: "Plaza del Doctor Collado ‚Üí Plaza del Negrito (Fuente del Negrito)", audio: AUDIO_BASE_PATH + "tramo_21_collado_negrito.mp3" },
            // PARADA 34 - Fuente del Negrito
            { tipo: "parada", parada: 34, idAudio: "P-34", nombre: "Fuente del Negrito", audio: AUDIO_BASE_PATH + "parada_34_fuente_negrito.mp3" },
            // TRAMO 22 - Plaza del Negrito ‚Üí Calle Caballeros
            { tipo: "tramo", tramo: 22, idAudio: "TR-22", nombre: "Plaza del Negrito ‚Üí Calle Caballeros", audio: AUDIO_BASE_PATH + "tramo_22_negrito_caballeros.mp3" },
            // PARADA 35 - Palau de la Generalitat
            { tipo: "parada", parada: 35, idAudio: "P-35", nombre: "Palau de la Generalitat", audio: AUDIO_BASE_PATH + "parada_35_palau_generalitat.mp3" },
            // TRAMO 23 - Palacio de la Generalitat ‚Üí Calle de los Serranos (FINAL)
            { tipo: "tramo", tramo: 23, idAudio: "TR-23", nombre: "Palacio de la Generalitat ‚Üí Calle de los Serranos (FINAL)", audio: AUDIO_BASE_PATH + "tramo_23_generalitat_serranos_final.mp3" },
            // PARADA 36 - Torres de Serranos (Final)
            { tipo: "parada", parada: 36, idAudio: "P-36", nombre: "Torres de Serranos Final", audio: AUDIO_BASE_PATH + "parada_36_torres_serranos_final.mp3" }
        ];
        
        // Variables globales
        window.paradaActual = 0; // √çndice de la parada actual
        
        // Funci√≥n para mostrar mensajes en la ventana de informaci√≥n
        function mostrarMensajeInfoParada(mensaje, esError = false) {
            const info = document.getElementById('info-parada');
            if (info) {
                info.textContent = mensaje;
                info.style.display = 'block';
                if (esError) {
                    info.classList.add('error');
                } else {
                    info.classList.remove('error');
                }
            }
        }
        
        // Hacer la funci√≥n accesible globalmente
        window.mostrarMensajeInfoParada = mostrarMensajeInfoParada;

        // Funci√≥n para ocultar la informaci√≥n de la parada
        function ocultarInfoParada() {
            const info = document.getElementById('info-parada');
            if (info) {
                info.style.display = 'none';
            }
        }
        
        // Hacer la funci√≥n accesible globalmente
        window.ocultarInfoParada = ocultarInfoParada;

        // Inicializaci√≥n del mapa
        let map;
        document.addEventListener('DOMContentLoaded', function() {
            map = L.map('mapa', {
                center: [39.4622, -0.37802],
                zoom: 14,
                zoomControl: false,
                rotate: false,
                touchRotate: false,
                bearing: 0
            });
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                maxZoom: 40, 
                attribution: '¬© OpenStreetMap contributors' 
            }).addTo(map);

            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                    console.log("map.invalidateSize() ejecutado.");
                }
            }, 100);
        });

        // Inicializaci√≥n de la aplicaci√≥n
        function inicializarAplicacion() {
            ocultarHijo4();
            ocultarInfoParada();
            closeMediaOverlay();
            
            window.paradaActual = 0;
            
            // Notificar a hijo5-casa (bot√≥n casa) el estado inicial: modo GPS activo y parada 0
            const hijo5 = document.getElementById('hijo5-casa');
            const hijo2 = document.getElementById('hijo2');
            
            if (hijo2 && hijo2.contentWindow) {
                hijo2.contentWindow.postMessage({ tipo: 'mostrar-foto-video', index: 0 }, '*');
                hijo2.contentWindow.postMessage({ tipo: 'activar-botones-foto-video', color: 'green' }, '*');
                hijo2.contentWindow.postMessage({ tipo: 'gps-on' }, '*');
            }
            
            if (hijo5 && hijo5.contentWindow) {
                hijo5.contentWindow.postMessage({ type: 'modoGPS', parada: 0 }, '*');
            }
        }
        
        // Iniciar la aplicaci√≥n cuando el DOM est√© completamente cargado
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarAplicacion);
        } else {
            inicializarAplicacion();
        }
        
        // Variables para los elementos de navegaci√≥n en el mapa
        let rutaPolyline = null;
        let marcadorInicio = null;
        let marcadorDestino = null;
        let direccionFlecha = null;

        // Funci√≥n para limpiar la navegaci√≥n actual del mapa
        function limpiarNavegacion() {
            if (rutaPolyline) {
                map.removeLayer(rutaPolyline);
                rutaPolyline = null;
            }
            
            if (marcadorInicio) {
                map.removeLayer(marcadorInicio);
                marcadorInicio = null;
            }
            
            if (marcadorDestino) {
                map.removeLayer(marcadorDestino);
                marcadorDestino = null;
            }
            
            if (direccionFlecha) {
                map.removeLayer(direccionFlecha);
                direccionFlecha = null;
            }
        }

        // Funci√≥n para dibujar una flecha en la ruta
        function dibujarFlecha(latlng, angulo) {
            // Usar un √≠cono de marcador con rotaci√≥n para simular una flecha
            const iconoFlecha = L.divIcon({
                className: 'flecha-navegacion',
                html: '‚û§',
                iconSize: [24, 24],
                iconAnchor: [12, 12],
                popupAnchor: [0, -12]
            });
            
            // Crear el marcador con rotaci√≥n
            const flecha = L.marker(latlng, {
                icon: iconoFlecha,
                rotationAngle: angulo,
                rotationOrigin: 'center',
                zIndexOffset: 1000
            });
            
            return flecha;
        }

        // ================== MANEJADOR DE MENSAJES DEL HIJO 2 (COORDENADAS) ==================
        window.addEventListener('message', function(event) {
            const iframe = document.getElementById('hijo2');
            if (!iframe || event.source !== iframe.contentWindow) return;
            
            const data = event.data;
            if (!data || !data.type) return;
            
            console.log(`üì© PADRE: Mensaje recibido de hijo 2 (${data.type})`, data);
            
            switch(data.type) {
                case 'mostrarNavegacion':
                    console.log('üìç PADRE: Mostrando navegaci√≥n a destino:', data.destino.nombre);
                    
                    // Limpiar navegaci√≥n anterior
                    limpiarNavegacion();
                    
                    // Crear los puntos de la ruta (simplificado: l√≠nea recta entre origen y destino)
                    const puntosRuta = [
                        [data.origen.lat, data.origen.lng],
                        [data.destino.coordenadas.lat, data.destino.coordenadas.lng]
                    ];
                    
                    // Dibujar la l√≠nea de ruta
                    rutaPolyline = L.polyline(puntosRuta, {
                        color: '#1E88E5', // Azul
                        weight: 6,
                        opacity: 0.8,
                        lineJoin: 'round'
                    }).addTo(map);
                    
                    // A√±adir marcador de inicio (verde)
                    marcadorInicio = L.marker([data.origen.lat, data.origen.lng], {
                        icon: L.divIcon({
                            className: 'marcador-inicio',
                            html: 'üìç',
                            iconSize: [30, 30],
                            iconAnchor: [15, 30],
                            popupAnchor: [0, -30]
                        })
                    }).addTo(map);
                    
                    // A√±adir marcador de destino (rojo)
                    marcadorDestino = L.marker([data.destino.coordenadas.lat, data.destino.coordenadas.lng], {
                        icon: L.divIcon({
                            className: 'marcador-destino',
                            html: 'üìç',
                            iconSize: [30, 30],
                            iconAnchor: [15, 30],
                            popupAnchor: [0, -30]
                        })
                    }).addTo(map);
                    
                    // A√±adir etiqueta al destino
                    marcadorDestino.bindPopup(`<b>${data.destino.nombre}</b>`).openPopup();
                    
                    // Calcular punto medio para la flecha (80% del camino desde el origen)
                    const puntoIntermedio = {
                        lat: data.origen.lat + (data.destino.coordenadas.lat - data.origen.lat) * 0.8,
                        lng: data.origen.lng + (data.destino.coordenadas.lng - data.origen.lng) * 0.8
                    };
                    
                    // Calcular √°ngulo de la flecha
                    const angulo = Math.atan2(
                        data.destino.coordenadas.lat - data.origen.lat,
                        data.destino.coordenadas.lng - data.origen.lng
                    ) * (180 / Math.PI);
                    
                    // A√±adir flecha de direcci√≥n
                    direccionFlecha = dibujarFlecha(puntoIntermedio, angulo).addTo(map);
                    
                    // Ajustar el mapa para mostrar toda la ruta con un margen
                    map.fitBounds(rutaPolyline.getBounds(), {
                        padding: [50, 50],
                        maxZoom: 17
                    });
                    
                    console.log('üó∫Ô∏è PADRE: Navegaci√≥n mostrada en el mapa');
                    break;
                    
                case 'cambio-estado':
                    console.log('üîÑ PADRE: Cambio de estado en navegaci√≥n:', data.estado);
                    // Aqu√≠ puedes agregar l√≥gica para manejar cambios de estado
                    break;
                    
                case 'interaccion-usuario':
                    console.log('üñ±Ô∏è PADRE: Interacci√≥n del usuario:', data.tipoBoton, data.datos);
                    // Aqu√≠ puedes manejar interacciones del usuario
                    break;
                    
                case 'estado-gps':
                    if (data.estado === 'activo') {
                        console.log('üìç PADRE: GPS activado');
                    } else if (data.estado === 'inactivo') {
                        console.log('‚è∏Ô∏è PADRE: GPS desactivado');
                    } else if (data.estado === 'error') {
                        console.error('‚ùå PADRE: Error en GPS:', data.error);
                    }
                    break;
                    
                case 'llegada-parada':
                    console.log('üéØ PADRE: Llegada a parada detectada:', data.parada);
                    // Limpiar navegaci√≥n al llegar al destino
                    limpiarNavegacion();
                    break;
                    
                case 'inicio-navegacion':
                    console.log('üöÄ PADRE: Inicio de navegaci√≥n a parada:', data.parada);
                    // Aqu√≠ puedes manejar el inicio de la navegaci√≥n
                    break;
                    
                case 'fin-navegacion':
                    console.log('üèÅ PADRE: Navegaci√≥n finalizada');
                    // Limpiar navegaci√≥n al finalizar
                    limpiarNavegacion();
                    break;
                    
                default:
                    console.log('‚ÑπÔ∏è PADRE: Mensaje no manejado de hijo 2:', data);
            }
        });
        
        // ================== MANEJADOR DE MENSAJES DEL HIJO 4 (RETOS Y PREGUNTAS) ==================
        window.addEventListener('message', function(event) {
            const iframe = document.getElementById('hijo4');
            if (!iframe || event.source !== iframe.contentWindow) return;
            
            const data = event.data;
            if (!data || !data.type) return;
            
            console.log('‚ùì PADRE: Mensaje recibido de hijo4 (retos):', data.type, data);
            
            switch(data.type) {
                case 'hijo4Ready':
                case 'retos-hijo-listo':
                    console.log('‚úÖ PADRE: Hijo 4 (Retos) listo y operativo');
                    // Confirmar recepci√≥n
                    iframe.contentWindow.postMessage({ 
                        type: 'confirmacion',
                        origen: 'padre',
                        destino: 'hijo4',
                        mensaje: 'Estado sincronizado',
                        timestamp: Date.now(),
                        estado: {
                            modo: estadoGlobal.modo || 'aventura',
                            retoActivo: estadoGlobal.datosCompartidos.reto.activo || false,
                            retoCompletado: estadoGlobal.datosCompartidos.reto.completado || false,
                            paradaActual: estadoGlobal.puntoActual?.id || null
                        }
                    }, '*');
                    break;
                    
                case 'iniciarReto':
                    console.log('üéÆ PADRE: Iniciando reto para parada:', data.paradaId);
                    // Mostrar el iframe de retos
                    document.getElementById('hijo4').style.display = 'block';
                    // Actualizar estado global
                    actualizarEstadoGlobal({
                        datosCompartidos: {
                            ...estadoGlobal.datosCompartidos,
                            reto: {
                                activo: true,
                                completado: false,
                                paradaId: data.paradaId
                            }
                        }
                    });
                    break;
                    
                case 'retoCompletado':
                    console.log('üèÜ PADRE: Reto completado para parada:', data.paradaId);
                    // Ocultar el iframe de retos
                    document.getElementById('hijo4').style.display = 'none';
                    // Actualizar estado global
                    actualizarEstadoGlobal({
                        datosCompartidos: {
                            ...estadoGlobal.datosCompartidos,
                            reto: {
                                activo: false,
                                completado: true,
                                paradaId: data.paradaId
                            }
                        }
                    });
                    // Notificar a otros hijos del reto completado
                    sincronizarEstadoConHijos();
                    break;
                    
                case 'cerrarReto':
                    console.log('üö™ PADRE: Cerrando reto sin completar');
                    document.getElementById('hijo4').style.display = 'none';
                    actualizarEstadoGlobal({
                        datosCompartidos: {
                            ...estadoGlobal.datosCompartidos,
                            reto: {
                                activo: false,
                                completado: false,
                                paradaId: null
                            }
                        }
                    });
                    break;
                    
                case 'error':
                    console.error('‚ùå PADRE: Error en hijo4 (retos):', data.mensaje);
                    mostrarMensajeInfoParada(`Error en retos: ${data.mensaje}`, true);
                    break;
                    
                case 'solicitarSincronizacion':
                    console.log('üîÑ PADRE: Sincronizaci√≥n solicitada por hijo4');
                    // Enviar estado actual al hijo 4
                    iframe.contentWindow.postMessage({
                        type: 'sincronizarEstado',
                        origen: 'padre',
                        destino: 'hijo4',
                        timestamp: Date.now(),
                        estado: {
                            modo: estadoGlobal.modo || 'aventura',
                            retoActivo: estadoGlobal.datosCompartidos.reto.activo || false,
                            retoCompletado: estadoGlobal.datosCompartidos.reto.completado || false,
                            paradaActual: estadoGlobal.puntoActual?.id || null
                        }
                    }, '*');
                    break;
                    
                default:
                    console.log('‚ÑπÔ∏è PADRE: Mensaje no manejado de hijo4 (retos):', data);
            }
        });
        
        // ================== MANEJADOR DE MENSAJES DEL HIJO 3 (REPRODUCTOR DE AUDIO) ==================
        window.addEventListener('message', function(event) {
            const iframe = document.getElementById('hijo3');
            if (!iframe || event.source !== iframe.contentWindow) return;
            
            const data = event.data;
            if (!data || !data.type) return;
            
            console.log('üì• PADRE: Mensaje recibido de hijo 3 (audio):', data.type, data);
            
            switch(data.type) {
                case 'hijo3Ready':
                case 'audio-hijo-listo':
                    console.log('‚úÖ PADRE: Hijo 3 (Reproductor) listo y operativo');
                    // Confirmar recepci√≥n
                    iframe.contentWindow.postMessage({ 
                        type: 'confirmacion',
                        mensaje: 'Estado sincronizado',
                        timestamp: Date.now()
                    }, '*');
                    break;
                    
                case 'estadoReproduccion':
                    console.log('üéµ PADRE: Estado de reproducci√≥n actualizado:', {
                        reproduciendo: data.reproduciendo,
                        paradaActual: data.paradaActual,
                        tiempoActual: data.tiempoActual
                    });
                    // Actualizar estado global
                    actualizarEstadoGlobal({
                        reproduciendoAudio: data.reproduciendo,
                        audioActual: data.paradaActual
                    });
                    break;
                    
                case 'error':
                    console.error('‚ùå PADRE: Error en hijo 3 (audio):', data.mensaje);
                    mostrarMensajeInfoParada(`Error en reproductor: ${data.mensaje}`, true);
                    break;
                    
                case 'audioFinalizado':
                    console.log('üèÅ PADRE: Audio finalizado:', data.paradaActual);
                    // Aqu√≠ podr√≠as manejar la l√≥gica de qu√© hacer cuando termina un audio
                    break;
                    
                default:
                    console.log('‚ÑπÔ∏è PADRE: Mensaje no manejado de hijo 3 (audio):', data);
            }
        });
        
        // ================== FUNCI√ìN PARA VERIFICAR ESTADO DE IFRAMES ==================
        function verificarEstadoIframes() {
            console.group('üîç Estado actual de iframes');
            ['hijo2', 'hijo3', 'hijo4', 'hijo5-casa'].forEach(id => {
                const iframe = document.getElementById(id);
                console.log(`üì∫ ${id}:`, {
                    existe: !!iframe,
                    cargado: iframe?.contentDocument?.readyState === 'complete',
                    src: iframe?.src
                });
            });
            console.groupEnd();
        }

        // ================== MANEJADOR DE MENSAJES DEL HIJO 5 (BOT√ìN CASA) ==================
        window.addEventListener('message', function(event) {
            // Primero verificar si el mensaje es del hijo5-casa
            const iframe = document.getElementById('hijo5-casa');
            if (!iframe || event.source !== iframe.contentWindow) return;
            
            // Log detallado de los mensajes recibidos
            const timestamp = new Date().toISOString();
            const origen = event.origin || 'unknown-origin';
            
            console.group(`üì® PADRE [${timestamp}] - Mensaje de hijo5-casa (${origen})`);
            console.log('üì¶ Datos recibidos:', event.data);
            console.log('üîó Origen del mensaje:', origen);
            
            // Si el mensaje no tiene tipo, intentar usar 'tipo' como alternativa a 'type'
            const data = event.data || {};
            const tipoMensaje = data.type || data.tipo;
            
            if (!tipoMensaje) {
                console.warn('‚ö†Ô∏è PADRE: Mensaje sin tipo recibido, ignorando...');
                console.groupEnd();
                return;
            }
            
            console.log('üìå Tipo de mensaje:', tipoMensaje);
            console.groupEnd();
            
            // Normalizar el tipo de mensaje
            data.type = tipoMensaje;
            
            console.log(`üè† PADRE: Mensaje de hijo5-casa - Tipo: ${data.type}`, data);
            
            try {
                switch(data.type) {
                    case 'hijo5Ready':
                    case 'casa-hijo-listo':
                    case 'sincronizarEstado':
                        console.log('üîÑ PADRE: Sincronizando estado con hijo5-casa...');
                        // Confirmar recepci√≥n y enviar estado actual
                        iframe.contentWindow.postMessage({ 
                            type: 'sincronizarEstado',
                            origen: 'padre',
                            destino: 'hijo5-casa',
                            mensaje: 'Estado sincronizado',
                            timestamp: Date.now(),
                            estado: {
                                modo: window.estadoGlobal?.modo || 'aventura',
                                paradaActual: window.estadoGlobal?.puntoActual?.id || null,
                                puntoActual: window.estadoGlobal?.puntoActual || null,
                                ultimaActualizacion: Date.now()
                            },
                            datos: {
                                tipo: 'respuestaSincronizacion',
                                origen: 'padre',
                                modo: window.estadoGlobal?.modo || 'aventura',
                                gpsActivo: window.estadoGlobal?.modo === 'aventura'
                            }
                        }, '*');
                        console.log('‚úÖ PADRE: Estado sincronizado con hijo5-casa');
                        break;
                        
                    case 'cambioModo':
                        console.log(`üîÑ PADRE: Cambio de modo solicitado: ${data.modo}`, data);
                        // Actualizar estado global
                        if (window.actualizarEstadoGlobal) {
                            window.actualizarEstadoGlobal({
                                modo: data.modo, // 'casa' o 'aventura'
                                origen: 'hijo5-casa',
                                timestamp: Date.now()
                            });
                            
                            // Confirmar el cambio al hijo5-casa
                            iframe.contentWindow.postMessage({
                                type: 'confirmacionModo',
                                origen: 'padre',
                                destino: 'hijo5-casa',
                                modo: data.modo,
                                timestamp: Date.now()
                            }, '*');
                        }
                        break;
                        
                    case 'expandirIframe':
                        console.log(`üìè PADRE: Solicitando expansi√≥n del iframe a ${data.width}`, data);
                        // Ajustar el ancho del iframe hijo5-casa
                        if (data.width && !isNaN(parseInt(data.width))) {
                            iframe.style.width = `${data.width}px`;
                            console.log(`‚úÖ PADRE: Iframe hijo5-casa ajustado a ${data.width}px`);
                        }
                        break;
                        
                    case 'error':
                        console.error('‚ùå PADRE: Error en hijo5-casa:', data.mensaje || 'Error desconocido', data);
                        if (window.mostrarMensajeInfoParada) {
                            window.mostrarMensajeInfoParada(`Error en bot√≥n casa: ${data.mensaje || 'Error desconocido'}`, true);
                        }
                        break;
                        
                    case 'solicitarSincronizacion':
                        console.log('üîÑ PADRE: Sincronizaci√≥n solicitada por hijo5-casa');
                        // Enviar estado actual al hijo 5
                        iframe.contentWindow.postMessage({
                            type: 'sincronizarEstado',
                            origen: 'padre',
                            destino: 'hijo5-casa',
                            timestamp: Date.now(),
                            estado: {
                                modo: window.estadoGlobal?.modo || 'aventura',
                                paradaActual: window.estadoGlobal?.paradaActual,
                                ultimaActualizacion: window.estadoGlobal?.ultimaActualizacion || Date.now()
                            }
                        }, '*');
                        break;
                        
                    default:
                        console.log(`‚ÑπÔ∏è PADRE: Mensaje no manejado de hijo5-casa:`, data);
                }
            } catch (error) {
                console.error('‚ùå PADRE: Error al procesar mensaje de hijo5-casa:', error, '\nMensaje:', data);
            }
        });
        
        }());
    </script>
</body>
</html>
