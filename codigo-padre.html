<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aventura 1 - Padre</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüó∫Ô∏è%3C/text%3E%3C/svg%3E">

    <!-- Carga de Leaflet desde CDN con Integrity y Crossorigin -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <!-- Script para verificar que Leaflet est√° cargado -->
    <script>
        window.addEventListener('load', function() {
            if (typeof L === 'undefined') {
                console.error('‚ùå Leaflet no se ha cargado correctamente. L no est√° definido en window.');
            } else {
                console.log('‚úÖ Leaflet cargado correctamente:', L.version);
            }
        });
    </script>

    <style>
        /* Estilos generales, mapa, debug, logo, iframes, etc. */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: transparent; }
        iframe { background: transparent; border: none; }
        /* PROBLEMA #1: Mejorar los estilos del mapa para asegurar visibilidad */
        #mapa { 
            position: fixed !important; 
            top: 0 !important; 
            left: 0 !important; 
            width: 100vw !important; 
            height: 100vh !important; 
            z-index: 10 !important;
            background-color: #f5f5f5 !important;
            border: 1px solid #ccc !important;
            visibility: visible !important;
            opacity: 1 !important;
            display: block !important;
            pointer-events: auto !important;
            overflow: visible !important;
        }
        /* Asegurar que los contenedores de Leaflet sean visibles */
        .leaflet-container {
            width: 100% !important;
            height: 100% !important;
            z-index: 10 !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            background: white !important;
        }
        .leaflet-tile-container {
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 200 !important;
        }
        .leaflet-tile {
            visibility: visible !important;
            opacity: 1 !important;
        }
        .leaflet-map-pane,
        .leaflet-overlay-pane,
        .leaflet-marker-pane,
        .leaflet-shadow-pane,
        .leaflet-tooltip-pane,
        .leaflet-popup-pane {
            z-index: auto !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        #map-debug { position: fixed; top: 10px; left: 10px; background: rgba(255, 255, 255, 0.9); padding: 5px 8px; border-radius: 5px; z-index: 5000; font-size: 12px; font-family: monospace; display: none; transition: opacity 0.5s; }
        #logo-aventura { position: fixed; top: -27px; left: 50%; transform: translateX(-50%); width: 320px; height: 125px; z-index: 2999; object-fit: contain; }
        #fondo-blanco { position: fixed; top: -24px; left: 50%; transform: translateX(-50%); width: 400px; height: 100px; z-index: 2998; background: white; border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; }
        #info-parada { font-weight: bold; margin: 0; padding: 7px 12px; background-color: rgba(255, 255, 255, 0.9); border-radius: 7px; position: fixed; left: 50%; transform: translateX(-50%); z-index: 1201; display: none; color: #333; font-family: sans-serif; text-align: center; bottom: 325px; min-width: 220px; max-width: 90vw; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10); }
        #hijo4 { position: fixed; top: 10vh; left: 50%; width: 60vw; height: 40vh; transform: translateX(-50%); z-index: 2000; border: 2px solid red; background: transparent; pointer-events: auto; display: none; }
        #media-overlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.8); z-index: 4000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #media-container { max-width: 90%; max-height: 90%; display: flex; flex-direction: column; align-items: center; position: relative; }
        #close-media { position: absolute; top: 10px; right: 10px; background: #ff5252; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.2em; cursor: pointer; z-index: 4001; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #parada-video, #parada-imagen { max-width: 100%; max-height: calc(100vh - 80px); display: none; border-radius: 5px; }
        
        /* Estilos para waypoints y marcadores de ruta */
        .waypoint-marker {
            background-color: #ff8c00;
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .waypoint-number {
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
        }
        
        .marker-letter {
            background: #ff4500;
            color: white;
            font-weight: bold;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .inicio-marker .marker-letter {
            background: #28a745;
        }
        
        .fin-marker .marker-letter {
            background: #dc3545;
        }
        
        /* Clases para animar la ruta actual */
        .ruta-activa {
            animation: pulse-route 2s infinite;
        }
        
        @keyframes pulse-route {
            0% { stroke-opacity: 0.7; }
            50% { stroke-opacity: 1; }
            100% { stroke-opacity: 0.7; }
        }

        #debug-overlay {
            display: none !important;
        }
    </style>

    <!-- Cargar m√≥dulos ES -->
    <script type="module">
    // 1. Configuraci√≥n global de manejo de errores
    window.handleIframeError = function(iframeId, event) {
        const errorMsg = `Error loading ${iframeId}`;
        console.error(errorMsg, event);
        // Si el logger est√° disponible, usarlo tambi√©n
        if (window.logger?.error) {
            window.logger.error(errorMsg, event);
        }
    };
    
    window.handleIframeLoad = function(iframeId) {
        const msg = `${iframeId} loaded successfully`;
        console.debug(msg);
        if (window.logger?.debug) {
            window.logger.debug(msg);
        }
    }

    // 2. Funci√≥n de inicializaci√≥n as√≠ncrona
    async function initializeApp() {
        try {
            console.log('Iniciando aplicaci√≥n...');
            
            // Importar din√°micamente la aplicaci√≥n
            const { inicializar } = await import('./js/app.js');
            
            // Inicializar la aplicaci√≥n
            await inicializar();
            
            console.log('Aplicaci√≥n inicializada correctamente');
            
        } catch (error) {
            console.error('Error cr√≠tico al inicializar la aplicaci√≥n:', error);
            // Mostrar mensaje de error en la interfaz
            const errorDiv = document.createElement('div');
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '0';
            errorDiv.style.left = '0';
            errorDiv.style.right = '0';
            errorDiv.style.background = '#ffebee';
            errorDiv.style.color = '#c62828';
            errorDiv.style.padding = '1rem';
            errorDiv.style.zIndex = '9999';
            errorDiv.style.fontFamily = 'Arial, sans-serif';
            errorDiv.style.fontSize = '14px';
            errorDiv.style.whiteSpace = 'pre';
            errorDiv.style.overflow = 'auto';
            errorDiv.style.maxHeight = '50vh';
            errorDiv.textContent = `Error al inicializar la aplicaci√≥n:\n\n${error.message}\n\n${error.stack || ''}`;
            document.body.prepend(errorDiv);
        }
    }

    // 3. Inicializar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }
    </script>
</head>
<body>
    <!-- Debug overlay -->
    <div id="debug-overlay" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; z-index: 9999; max-width: 300px; max-height: 80vh; overflow: auto; font-family: monospace; font-size: 12px;">
        <h3 style="margin: 0 0 10px 0;">Debug Info</h3>
        <div id="debug-content">Initializing...</div>
    </div>
    
    <script>
    // Debug logging function
    function debugLog(message, data) {
        const now = new Date().toISOString().substr(11, 12);
        const logLine = document.createElement('div');
        logLine.textContent = `[${now}] ${message}`;
        if (data) {
            try {
                logLine.textContent += ' ' + JSON.stringify(data);
            } catch (e) {
                logLine.textContent += ' [Object]';
            }
        }
        const debugContent = document.getElementById('debug-content');
        debugContent.prepend(logLine);
        console.log(`[DEBUG] ${message}`, data || '');
    }
    
    // Make it globally available
    window.debugLog = debugLog;
    
    // Log initial load
    debugLog('Parent page loading...');
    </script>
    
    <!-- PROBLEMA #2: Arreglar el script de inicializaci√≥n del mapa -->
    <script>
        // Crear el contenedor del mapa inmediatamente - lo m√°s temprano posible
        (function crearContenedorMapa() {
            console.log('Creando contenedor del mapa al cargar el script...');
            let mapContainer = document.getElementById('mapa');
            
            if (!mapContainer) {
                console.log('Contenedor del mapa no encontrado, creando uno nuevo inmediatamente...');
                mapContainer = document.createElement('div');
                mapContainer.id = 'mapa';
                mapContainer.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    height: 100vh !important;
                    z-index: 10 !important;
                    background-color: #f5f5f5 !important;
                    border: 1px solid #ccc !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    display: block !important;
                    pointer-events: auto !important;
                    overflow: visible !important;
                    margin: 0 !important;
                    padding: 0 !important;
                `;
                
                // Si el body ya est√° disponible, a√±adir el contenedor
                if (document.body) {
                    document.body.prepend(mapContainer);
                    console.log('Contenedor del mapa a√±adido al body');
                } else {
                    // Si el body a√∫n no est√° disponible, usar un MutationObserver
                    document.addEventListener('DOMContentLoaded', () => {
                        document.body.prepend(mapContainer);
                        console.log('Contenedor del mapa a√±adido al body en DOMContentLoaded');
                    });
                }
            }
        })();
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç DOM completamente cargado, verificando Leaflet...');
            if (typeof L === 'undefined') {
                console.error('‚ùå ERROR: Leaflet (L) no est√° definido en DOMContentLoaded');
                const mapDebug = document.getElementById('map-debug');
                if (mapDebug) {
                    mapDebug.textContent = 'ERROR: Leaflet no est√° disponible';
                    mapDebug.style.display = 'block';
                    mapDebug.style.color = 'red';
                    mapDebug.style.backgroundColor = 'white';
                    mapDebug.style.padding = '10px';
                }

                // PROBLEMA #3: Cargar Leaflet din√°micamente si no est√° disponible
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                script.onload = () => {
                    console.log('‚úÖ Leaflet cargado din√°micamente');
                    // Preparar el contenedor antes de intentar inicializar el mapa
                    let mapContainer = document.getElementById('mapa');
                    if (!mapContainer) {
                        mapContainer = document.createElement('div');
                        mapContainer.id = 'mapa';
                        mapContainer.style.width = '100vw';
                        mapContainer.style.height = '100vh';
                        mapContainer.style.position = 'fixed';
                        mapContainer.style.top = '0';
                        mapContainer.style.left = '0';
                        mapContainer.style.zIndex = '10';
                        document.body.prepend(mapContainer);
                    }
                    // Esperar un momento y luego inicializar
                    setTimeout(() => {
                        initializeMap().then(result => {
                            console.log('Resultado de inicializaci√≥n del mapa:', result);
                        }).catch(err => {
                            console.error('Error durante inicializaci√≥n del mapa:', err);
                        });
                    }, 100);
                };
                document.head.appendChild(script);
            } else {
                console.log('‚úÖ Leaflet disponible en DOMContentLoaded, versi√≥n:', L.version);
                // Ahora initializeMap devuelve una promesa, as√≠ que manej√©mosla
                initializeMap().then(result => {
                    console.log('Resultado de inicializaci√≥n del mapa:', result);
                }).catch(err => {
                    console.error('Error durante inicializaci√≥n del mapa:', err);
                });
            }
        });

        // PROBLEMA #4: Funci√≥n de inicializaci√≥n del mapa simplificada y separada
        function initializeMap() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('Inicializando mapa...');
                    
                    // 1. PRIMER PASO: Asegurar que el contenedor existe y tiene dimensiones
                    let mapContainer = document.getElementById('mapa');
                    
                    if (!mapContainer) {
                        console.log('Contenedor del mapa no encontrado, creando uno nuevo...');
                        mapContainer = document.createElement('div');
                        mapContainer.id = 'mapa';
                        document.body.prepend(mapContainer);
                        console.log('Contenedor del mapa creado din√°micamente');
                    }
                    
                    // 2. Aplicar estilos imperativa y expl√≠citamente
                    mapContainer.style.cssText = `
                        position: fixed !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100vw !important;
                        height: 100vh !important;
                        z-index: 10 !important;
                        background-color: #f5f5f5 !important;
                        border: 1px solid #ccc !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        display: block !important;
                        pointer-events: auto !important;
                        overflow: visible !important;
                        margin: 0 !important;
                        padding: 0 !important;
                    `;
                    
                    // 3. TERCER PASO: Forzar m√∫ltiples reflows para garantizar que el navegador actualice el DOM
                    void mapContainer.offsetHeight;
                    void mapContainer.offsetWidth;
                    void mapContainer.getBoundingClientRect();
                    
                    console.log('Dimensiones del contenedor: ' + mapContainer.offsetWidth + 'x' + mapContainer.offsetHeight);
                    
                    // Verificar que el contenedor tenga dimensiones v√°lidas
                    if (mapContainer.offsetWidth <= 0 || mapContainer.offsetHeight <= 0) {
                        console.error('‚ùå El contenedor del mapa tiene dimensiones inv√°lidas:', 
                                    mapContainer.offsetWidth + 'x' + mapContainer.offsetHeight);
                        
                        // Reintentar con un timeout m√°s largo
                        return setTimeout(() => {
                            console.log('üîÑ Reintentando inicializar el mapa despu√©s de detectar dimensiones inv√°lidas...');
                            initializeMap().then(resolve).catch(reject);
                        }, 500);
                    }
                    
                    // 4. PASO CR√çTICO: Usar una cadena de delays para asegurar que el contenedor est√° listo
                    console.log('Esperando a que el navegador pinte el contenedor...');
                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            try {
                                // Verificar dimensiones nuevamente despu√©s del delay
                                console.log('Verificando dimensiones despu√©s del delay:', 
                                          mapContainer.offsetWidth + 'x' + mapContainer.offsetHeight);
                                
                                // 5. Si ya hay un mapa existente, destruirlo
                                if (window.mapa && typeof window.mapa.remove === 'function') {
                                    window.mapa.remove();
                                    window.mapa = null;
                                    console.log('Instancia previa del mapa destruida');
                                }
                                
                                // 6. Crear el nuevo mapa con opciones expl√≠citas
                                console.log('Creating new Leaflet map instance');
                                window.mapa = L.map('mapa', {
                                    center: [39.4699, -0.3763], // Valencia
                                    zoom: 16,
                                    minZoom: 12,
                                    maxZoom: 18,
                                    zoomControl: true,
                                    attributionControl: true,
                                    fadeAnimation: false, // Desactivar animaciones para mayor estabilidad
                                    zoomAnimation: false  // Desactivar animaciones para mayor estabilidad
                                });
                                
                                // 7. A√±adir capa de OpenStreetMap con opciones expl√≠citas
                                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                                    maxZoom: 19,
                                    minZoom: 1,
                                    tileSize: 256
                                }).addTo(window.mapa);
                                
                                // 8. Forzar m√∫ltiples actualizaciones del tama√±o del mapa
                                window.mapa.invalidateSize(true);
                                
                                setTimeout(() => {
                                    if (window.mapa && typeof window.mapa.invalidateSize === 'function') {
                                        window.mapa.invalidateSize(true);
                                        console.log('‚úÖ Map size updated (second invalidation)');
                                        
                                        // Agregar marcador de prueba para confirmar que el mapa funciona
                                        L.marker([39.4699, -0.3763]).addTo(window.mapa)
                                            .bindPopup('Mapa inicializado correctamente')
                                            .openPopup();
                                        
                                        resolve(window.mapa);
                                    }
                                }, 250);
                                
                                console.log('‚úÖ Map initialized successfully');
                            } catch (mapError) {
                                console.error('‚ùå Error creating Leaflet map:', mapError);
                                reject(mapError);
                            }
                        }, 150); // Incrementado a 150ms para dar m√°s tiempo al navegador
                    });
                } catch (error) {
                    console.error('‚ùå Error preparing map container:', error);
                    reject(error);
                }
            });
        }
    </script>

    <div id="mapa"></div>    <!-- Contenedor del mapa (ahora se crea din√°micamente) -->

    <!-- IFrames de los Hijos -->
    <iframe id="hijo2" src="Av1-botones-coordenadas.html" style="position: fixed; bottom: 20vh; left: 50%; transform: translateX(-50%); width: 280px; height: 120px; z-index: 1000; border: none; pointer-events: none;"></iframe>

    <iframe id="hijo3" src="Av1_audio_esp.html" style="position: fixed; bottom: 2vh; left: 50%; transform: translateX(-50%); width: 320px; height: 140px; z-index: 1000; border: none; pointer-events: auto;"></iframe>
    
    <iframe id="hijo4" src="Av1-esp-retos-preguntas.html" style="display: none;"></iframe>

    <iframe id="hijo5-casa" src="Av1-boton-casa.html" style="position: fixed; top: 0; left: 0; width: 370px; height: 55px; z-index: 1001; border: none;"></iframe>

    <div id="map-debug"></div>
    <iframe id="fondo-blanco" tabindex="-1" aria-hidden="true"></iframe>
    <img id="logo-aventura" src="fotos_Av1/LOGO LETRAS FINAL transparente recorte.png" alt="Logo" />
    <div id="info-parada"></div>

    <!-- Overlay para Media -->
    <div id="media-overlay">
        <div id="media-container">
            <button id="close-media">&times;</button>
            <video id="parada-video" controls></video>
            <img id="parada-imagen" />
        </div>
    </div>

</body>
</html>
