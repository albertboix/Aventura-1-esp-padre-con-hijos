<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aventura 1 - Padre</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Estilos del padre original... */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        #mapa { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
        body { margin: 0; padding: 0; background: transparent; }
        iframe { background: transparent; }
        
        /* ================== VARIABLES Y ESTILO HIJO 4 (RETOS) ================== */
        :root {
            --iframe-hijo4-width: 60vw;
            --iframe-hijo4-height: 40vh;
            --iframe-hijo4-top: 10vh;
            --iframe-hijo4-left: 50%;
            --iframe-hijo4-translate-x: -50%;
            --iframe-hijo4-z: 2000;
        }
        #hijo4 {
            position: fixed;
            top: var(--iframe-hijo4-top);
            left: var(--iframe-hijo4-left);
            width: var(--iframe-hijo4-width);
            height: var(--iframe-hijo4-height);
            transform: translateX(var(--iframe-hijo4-translate-x));
            z-index: var(--iframe-hijo4-z);
            border: 2px solid red;
            background: transparent;
            pointer-events: auto;
            display: none;
        }

        /* ESTILO ACTUALIZADO PARA info-parada */
        #info-parada {
            font-weight:bold;
            margin:0;
            padding: 12px 20px;
            background-color: rgba(255,255,255,0.95);
            border-radius: 10px;
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1201;
            display: none;
            color: #2c3e50;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            bottom: 340px;
            min-width: 250px;
            max-width: 90vw;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }
        
        /* Estilos para los marcadores personalizados */
        .custom-marker {
            position: relative;
            width: 30px;
            height: 42px;
            text-align: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            line-height: 42px;
        }
        
        .marker-pin {
            position: absolute;
            width: 30px;
            height: 42px;
            background: #007bff;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            left: 0;
            top: 0;
            margin: -21px 0 0 -15px;
        }
        
        /* Estilos para el marcador verde */
        .green-pin .marker-pin {
            background: #28a745;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .green-pin::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            margin: 3px 0 0 3px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
            opacity: 0.3;
        }
        
        .marker-pin.start {
            background: #2ecc71;
        }
        
        .marker-pin.end {
            background: #3498db;
        }
        
        .custom-marker span {
            position: relative;
            top: -10px;
            left: 0;
            width: 100%;
            text-align: center;
            display: inline-block;
            transform: rotate(45deg);
        }
        #info-parada.error {
            background-color: #ffeaea;
            color: #b30000;
            border: 1.5px solid #b30000;
            animation: shake 0.3s;
        }
        @keyframes shake {
            0% { transform: translateX(-50%) translateY(0); }
            25% { transform: translateX(-50%) translateY(-3px); }
            50% { transform: translateX(-50%) translateY(3px); }
            75% { transform: translateX(-50%) translateY(-3px); }
            100% { transform: translateX(-50%) translateY(0); }
        }

        /* ================== ESTILO PARA VIDEO E IMAGEN ================== */
        #media-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 4000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        #media-container {
            width: 70vw; /* 70% del ancho de la ventana */
            height: 70vh; /* 70% de la altura de la ventana */
            max-width: 70vw;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            padding: 15px;
        }

        #close-media {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 1.2em;
            cursor: pointer;
            z-index: 4001;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #parada-video, #parada-imagen {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            display: none;
            border-radius: 8px;
            object-fit: contain; /* Mantiene proporción sin cortar */
        }
    </style>
</head>
<body>

    <img id="logo-aventura" src="https://valenciavguides.github.io/Aventura-1-esp-padre-con-hijos/fotos_Av1/LOGO%20LETRAS%20FINAL%20transparente%20recorte.png" alt="Logo" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; max-width: 300px; height: auto;" />

    <div id="mapa"></div>

    <div id="info-parada"></div>

    <!-- Rutas actualizadas para GitHub Pages -->
    <iframe id="hijo1-hamburguesa" src="./botones-y-subfunciones-hamburguesa.html" style="position:fixed; left:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; border: transparent; background:transparent; pointer-events:auto;"></iframe>
    <iframe id="hijo1-opciones" src="./botones-y-subfunciones-opciones.html" style="position:fixed; right:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; border: transparent; background:transparent; pointer-events:auto;"></iframe>
    <iframe id="hijo1-mapa" src="./botones-y-subfunciones-mapa.html" style="position:fixed; right:1vw; top:20vw; height: 200px; width:57px; z-index:1005; border: transparent; background:transparent; pointer-events:auto;"></iframe>
    <iframe id="hijo5-casa" src="./Av1-boton-casa.html" style="position:fixed; left:10px; top:10px; height:350px; width:100px; z-index:1005; border: transparent; background:transparent; pointer-events:auto; transition:width 0.3s;"></iframe>

    <iframe id="hijo3" src="./Av1_audio_esp.html"
            style="position:fixed;
                   bottom:-6px;
                   left:50%;
                   transform:translateX(-50%);
                   height:165px;
                   width:310px;
                   z-index:1000;
                   border: transparent;
                   display:block;
                   pointer-events:auto;"></iframe>

    <iframe id="hijo2" src="./Av1-botones-coordenadas.html"
            style="position:fixed;
                   bottom:151px;
                   left:50%;
                   transform:translateX(-50%);
                   height:165px;
                   width:310px;
                   z-index:1001;
                   border: none !important;
                   background-color: transparent !important;
                   overflow: hidden;
                   pointer-events:auto;"
            allow="geolocation"
            frameborder="0"></iframe>

    <iframe id="hijo4" src="./Av1-esp-retos-preguntas.html" style="display:none;"></iframe>

    <div id="media-overlay">
        <div id="media-container">
            <button id="close-media">X</button>
            <video id="parada-video" controls></video>
            <img id="parada-imagen">
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ================== ESTADO GLOBAL CENTRALIZADO ==================
        (function() {
        'use strict';
        
        const estadoGlobal = {
            modo: 'aventura', // 'aventura' o 'casa'
            puntoActual: null, // { tipo: 'parada'|'tramo', id: number, datos: {...} }
            ultimaActualizacion: Date.now(),
            // Datos compartidos entre iframes
            datosCompartidos: {
                // Datos de navegación
                navegacionActiva: false,
                // Estado de reproducción de audio
                audio: {
                    reproduciendo: false,
                    paradaId: null,
                    src: null
                },
                // Estado de retos
                reto: {
                    activo: false,
                    completado: false,
                    paradaId: null
                },
                // Estado de la brújula
                brujulaActiva: false
            }
        };

        // ================== FUNCIONES DE SINCRONIZACIÓN ==================
        /**
         * Sincroniza el estado global con todos los iframes hijos
         */
        function sincronizarEstadoConHijos() {
            // Actualizar timestamp
            estadoGlobal.ultimaActualizacion = Date.now();
            
            const mensaje = {
                type: 'sincronizarEstado',
                estado: JSON.parse(JSON.stringify(estadoGlobal)) // Deep clone
            };

            // Enviar a todos los iframes hijos
            ['hijo2', 'hijo3', 'hijo4', 'hijo5'].forEach(id => {
                const iframe = document.getElementById(id);
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage(mensaje, '*');
                }
            });
        }

        /**
         * Actualiza el estado global y sincroniza con los hijos
         * @param {Object} actualizacion - Objeto con las propiedades a actualizar
         */
        function actualizarEstadoGlobal(actualizacion) {
            // Fusionar la actualización con el estado global
            Object.assign(estadoGlobal, actualizacion);
            // Sincronizar con los hijos
            sincronizarEstadoConHijos();
        }

        // ================== ESTRUCTURA SIMPLIFICADA ==================
        // Ruta base para los archivos de audio
        const AUDIO_BASE_PATH = './audios/';
        
        const PARADAS = [
            // PARADA 0 - Torres de Serranos (start) - Reto 2
            { tipo: "inicio", parada: 0, nombre: "Torres de Serranos (start)", audio: AUDIO_BASE_PATH + "parada_0_torres_serranos.mp3", reto: 2 },
            // TRAMO 1 - Torres de Serranos → Plaza de la crida (Puente de Serranos)
            { tipo: "tramo", tramo: 1, nombre: "Torres de Serranos → Plaza de la crida (Puente de Serranos)", audio: AUDIO_BASE_PATH + "tramo_1_torres_puente.mp3" },
            // PARADA 1 - Plaza de la crida (Puente de Serranos) - Reto 3
            { tipo: "parada", parada: 1, nombre: "Plaza de la crida (Puente de Serranos)", audio: AUDIO_BASE_PATH + "parada_1_plaza_crida.mp3", reto: 3 },
            // TRAMO 2 - Plaza de la crida → Calle Muro de Santa Ana
            { tipo: "tramo", tramo: 2, nombre: "Plaza de la crida → Calle Muro de Santa Ana", audio: AUDIO_BASE_PATH + "tramo_2_plaza_muro_santa_ana.mp3" },
            // PARADA 2 - Calle Muro de Santa Ana - Reto 4
            { tipo: "parada", parada: 2, nombre: "Calle Muro de Santa Ana", audio: AUDIO_BASE_PATH + "parada_2_muro_santa_ana.mp3", reto: 4 },
            // TRAMO 3 - Calle Muro de Santa Ana → Palacio de los Borgia
            { tipo: "tramo", tramo: 3, nombre: "Calle Muro de Santa Ana → Palacio de los Borgia", audio: AUDIO_BASE_PATH + "tramo_3_muro_palacio_borgia.mp3" },
            // PARADA 3 - Iglesia de San Lorenzo - Reto 5
            { tipo: "parada", parada: 3, nombre: "Iglesia de San Lorenzo", audio: AUDIO_BASE_PATH + "parada_3_iglesia_san_lorenzo.mp3", reto: 5 },
            // TRAMO 4 - Iglesia de San Lorenzo → Plaza de la Virgen
            { tipo: "tramo", tramo: 4, nombre: "Iglesia de San Lorenzo → Plaza de la Virgen", audio: AUDIO_BASE_PATH + "tramo_4_iglesia_plaza_virgen.mp3" },
            // PARADA 4 - Plaza de la Virgen - Reto 6
            { tipo: "parada", parada: 4, nombre: "Plaza de la Virgen Reto 6", audio: AUDIO_BASE_PATH + "parada_4_plaza_virgen_reto6.mp3", reto: 6 },
            // PARADA 5 - Plaza de la Virgen - Reto 7, 8 (Puzzle plaza de la virgen)
            { tipo: "parada", parada: 5, nombre: "Plaza de la Virgen Reto 7", audio: AUDIO_BASE_PATH + "parada_5_plaza_virgen_reto7.mp3", reto: 7 },
            // TRAMO 5 - Plaza de la Virgen → Plaza de la Almoína
            { tipo: "tramo", tramo: 5, nombre: "Plaza de la Virgen → Plaza de la Almoína", audio: AUDIO_BASE_PATH + "tramo_5_plaza_virgen_almoina.mp3" },
            // PARADA 6 - Panel cerámico muro Catedral
            { tipo: "parada", parada: 6, nombre: "Panel cerámico muro Catedral", audio: AUDIO_BASE_PATH + "parada_6_panel_ceramico.mp3" },
            // PARADA 7 - Capilla exterior catedral - Reto 10
            { tipo: "parada", parada: 7, nombre: "Capilla exterior catedral Reto 10", audio: AUDIO_BASE_PATH + "parada_7_capilla_exterior_reto10.mp3", reto: 10 },
            // PARADA 8 - Capilla exterior catedral - Reto 11
            { tipo: "parada", parada: 8, nombre: "Capilla exterior catedral Reto 11", audio: AUDIO_BASE_PATH + "parada_8_capilla_exterior_reto11.mp3", reto: 11 },
            // PARADA 9 - Arco Novo Catedral y Puerta Negra Basílica
            { tipo: "parada", parada: 9, nombre: "Arco Novo Catedral y Puerta Negra Basílica", audio: AUDIO_BASE_PATH + "parada_9_arco_novo_puerta_negra.mp3" },
            // PARADA 10 - Casa del Punt de Gantxo
            { tipo: "parada", parada: 10, nombre: "Casa del Punt de Gantxo", audio: AUDIO_BASE_PATH + "parada_10_casa_punt_gantxo.mp3" },
            // TRAMO 6 - Plaza de la Almoína → Plaza Decimo Junio Bruto
            { tipo: "tramo", tramo: 6, nombre: "Plaza de la Almoína → Plaza Decimo Junio Bruto (Museo Arqueológico de la Almoína)", audio: AUDIO_BASE_PATH + "tramo_6_almoina_museo_arqueologico.mp3" },
            // PARADA 11 - Plaza Decimo Junio Bruto (Museo Arqueológico de la Almoína)
            { tipo: "parada", parada: 11, nombre: "Plaza Decimo Junio Bruto (Museo Arqueológico de la Almoína)", audio: AUDIO_BASE_PATH + "parada_11_plaza_decimo_junio.mp3", reto: 14 },
            // TRAMO 7 - Plaza Decimo Junio Bruto → Plaza de la Reina
            { tipo: "tramo", tramo: 7, nombre: "Plaza Decimo Junio Bruto → Plaza de la Reina", audio: AUDIO_BASE_PATH + "tramo_7_museo_plaza_reina.mp3" },
            // PARADA 12 - Plaza de la Reina (Torre del Micalet, Catedral)
            { tipo: "parada", parada: 12, nombre: "Plaza de la Reina (Torre del Micalet, Catedral)", audio: AUDIO_BASE_PATH + "parada_12_plaza_reina_micalet.mp3", reto: 15 },
            // TRAMO 8 - Plaza de la Reina → Calle Barchilla
            { tipo: "tramo", tramo: 8, nombre: "Plaza de la Reina → Calle Barchilla", audio: AUDIO_BASE_PATH + "tramo_8_plaza_reina_barchilla.mp3" },
            // PARADA 13 - Calle Barchilla (Reto 16)
            { tipo: "parada", parada: 13, nombre: "Calle Barchilla Reto 16", audio: AUDIO_BASE_PATH + "parada_13_calle_barchilla_reto16.mp3", reto: 16 },
            // TRAMO 9 - Calle Barchilla → Plaza Redonda
            { tipo: "tramo", tramo: 9, nombre: "Calle Barchilla → Plaza Redonda", audio: AUDIO_BASE_PATH + "tramo_9_barchilla_plaza_redonda.mp3" },
            // PARADA 14 - Plaza Redonda (Reto 17)
            { tipo: "parada", parada: 14, nombre: "Plaza Redonda Reto 17", audio: AUDIO_BASE_PATH + "parada_14_plaza_redonda_reto17.mp3", reto: 17 },
            // TRAMO 10 - Plaza Redonda → Mercado Central
            { tipo: "tramo", tramo: 10, nombre: "Plaza Redonda → Mercado Central", audio: AUDIO_BASE_PATH + "tramo_10_plaza_redonda_mercado_central.mp3" },
            // PARADA 15 - Mercado Central (Reto 18)
            { tipo: "parada", parada: 15, nombre: "Mercado Central Reto 18", audio: AUDIO_BASE_PATH + "parada_15_mercado_central_reto18.mp3", reto: 18 },
            // TRAMO 11 - Mercado Central → Lonja de la Seda
            { tipo: "tramo", tramo: 11, nombre: "Mercado Central → Lonja de la Seda", audio: AUDIO_BASE_PATH + "tramo_11_mercado_lonja_seda.mp3" },
            // PARADA 16 - Lonja de la Seda (Reto 19)
            { tipo: "parada", parada: 16, nombre: "Lonja de la Seda Reto 19", audio: AUDIO_BASE_PATH + "parada_16_lonja_seda_reto19.mp3", reto: 19 },
            // TRAMO 12 - Lonja de la Seda → Plaza del Mercado
            { tipo: "tramo", tramo: 12, nombre: "Lonja de la Seda → Plaza del Mercado", audio: AUDIO_BASE_PATH + "tramo_12_lonja_plaza_mercado.mp3" },
            // PARADA 17 - Plaza del Mercado (Reto 20)
            { tipo: "parada", parada: 17, nombre: "Plaza del Mercado Reto 20", audio: AUDIO_BASE_PATH + "parada_17_plaza_mercado_reto20.mp3", reto: 20 },
            // TRAMO 13 - Plaza del Mercado → Torres de Serranos Final
            { tipo: "tramo", tramo: 13, nombre: "Plaza del Mercado → Torres de Serranos Final", audio: AUDIO_BASE_PATH + "tramo_13_plaza_mercado_torres_serranos.mp3" },
            // PARADA 18 - Torres de Serranos (Final)
            { tipo: "parada", parada: 18, nombre: "Torres de Serranos Final", audio: AUDIO_BASE_PATH + "parada_18_torres_serranos_final.mp3", reto: 21 },
            // TRAMO 6 - Plaza de la Almoína → Plaza Decimo Junio Bruto (Museo Arqueológico de la Almoína)
            { tipo: "tramo", tramo: 6, nombre: "Plaza de la Almoína → Plaza Decimo Junio Bruto (Museo Arqueológico de la Almoína)", audio: AUDIO_BASE_PATH + "tramo_6_almoina_museo_arqueologico.mp3" },
            // PARADA 11 - Museo arqueológico La Almoína
            { tipo: "parada", parada: 11, nombre: "Museo arqueológico La Almoína", audio: AUDIO_BASE_PATH + "parada_11_museo_almoina.mp3" },
            // PARADA 12 - Museo arqueológico La Almoína (segunda parte)
            { tipo: "parada", parada: 12, nombre: "Museo arqueológico La Almoína", audio: AUDIO_BASE_PATH + "parada_12_museo_almoina_2.mp3" },
            // PARADA 13 - Vista de la Catedral, Cimborrio
            { tipo: "parada", parada: 13, nombre: "Vista de la Catedral, Cimborrio", audio: AUDIO_BASE_PATH + "parada_13_vista_catedral_cimborrio.mp3" },
            // TRAMO 7 - Museo arqueológico La Almoína → Palacio Arzobispal
            { tipo: "tramo", tramo: 7, nombre: "Museo arqueológico La Almoína → Palacio Arzobispal", audio: AUDIO_BASE_PATH + "tramo_7_almoina_palacio_arzobispal.mp3" },
            // PARADA 14 - Palacio Arzobispal y Puerta Románica de la Catedral
            { tipo: "parada", parada: 14, nombre: "Palacio Arzobispal y Puerta Románica de la Catedral", audio: AUDIO_BASE_PATH + "parada_14_palacio_arzobispal_puerta_romanica.mp3" },
            // PARADA 15 - Puerta Románica de la Catedral
            { tipo: "parada", parada: 15, nombre: "Puerta Románica de la Catedral", audio: AUDIO_BASE_PATH + "parada_15_puerta_romanica_catedral.mp3" },
            // TRAMO 8 - Puerta Románica de la Catedral → Plaza del Ayuntamiento
            { tipo: "tramo", tramo: 8, nombre: "Puerta Románica de la Catedral → Plaza del Ayuntamiento", audio: AUDIO_BASE_PATH + "tramo_8_puerta_romanica_plaza_ayuntamiento.mp3" },
            // PARADA 16 - Plaza del Ayuntamiento
            { tipo: "parada", parada: 16, nombre: "Plaza del Ayuntamiento", audio: AUDIO_BASE_PATH + "parada_16_plaza_ayuntamiento.mp3" },
            // TRAMO 9 - Plaza del Ayuntamiento → Edificio del Ayuntamiento de València
            { tipo: "tramo", tramo: 9, nombre: "Plaza del Ayuntamiento → Edificio del Ayuntamiento de València", audio: AUDIO_BASE_PATH + "tramo_9_plaza_ayuntamiento_edificio.mp3" },
            // PARADA 17 - Edificio del Ayuntamiento
            { tipo: "parada", parada: 17, nombre: "Edificio del Ayuntamiento", audio: AUDIO_BASE_PATH + "parada_17_edificio_ayuntamiento.mp3" },
            // PARADA 18 - Edificio del Ayuntamiento (continuación)
            { tipo: "parada", parada: 18, nombre: "Edificio del Ayuntamiento", audio: AUDIO_BASE_PATH + "parada_18_edificio_ayuntamiento_2.mp3" },
            // TRAMO 10 - Edificio del Ayuntamiento → Estación del Norte
            { tipo: "tramo", tramo: 10, nombre: "Edificio del Ayuntamiento → Estación del Norte", audio: AUDIO_BASE_PATH + "tramo_10_ayuntamiento_estacion_norte.mp3" },
            // PARADA 19 - Estación del Norte
            { tipo: "parada", parada: 19, nombre: "Estación del Norte", audio: AUDIO_BASE_PATH + "parada_19_estacion_norte.mp3" },
            // TRAMO 11 - Estación del Norte → Plaza de Toros de València
            { tipo: "tramo", tramo: 11, nombre: "Estación del Norte → Plaza de Toros de València", audio: AUDIO_BASE_PATH + "tramo_11_estacion_plaza_toros.mp3" },
            // TRAMO 12 - Plaza de Toros → Casa estilo Árabe
            { tipo: "tramo", tramo: 12, nombre: "Plaza de Toros → Casa estilo Árabe", audio: AUDIO_BASE_PATH + "tramo_12_plaza_toros_casa_arabe.mp3" },
            // PARADA 20 - Casa estilo Árabe
            { tipo: "parada", parada: 20, nombre: "Casa estilo Árabe", audio: AUDIO_BASE_PATH + "parada_20_casa_estilo_arabe.mp3" },
            // PARADA 21 - Casa estilo Árabe, mitad Aventura
            { tipo: "parada", parada: 21, nombre: "Casa estilo Árabe, mitad Aventura", audio: AUDIO_BASE_PATH + "parada_21_casa_arabe_mitad_aventura.mp3" },
            // TRAMO 13 - Casa estilo Árabe → Palacio de Comunicaciones (Correos)
            { tipo: "tramo", tramo: 13, nombre: "Casa estilo Árabe → Palacio de Comunicaciones (Correos)", audio: AUDIO_BASE_PATH + "tramo_13_casa_arabe_correos.mp3" },
            // PARADA 22 - Palacio de Comunicaciones: Correos
            { tipo: "parada", parada: 22, nombre: "Palacio de Comunicaciones: Correos", audio: AUDIO_BASE_PATH + "parada_22_palacio_comunicaciones.mp3" },
            // PARADA 23 - Edificio Suay
            { tipo: "parada", parada: 23, nombre: "Edificio Suay", audio: AUDIO_BASE_PATH + "parada_23_edificio_suay.mp3" },
            // TRAMO 14 - Correos → Banco de València
            { tipo: "tramo", tramo: 14, nombre: "Palacio de Comunicaciones → Banco de València", audio: AUDIO_BASE_PATH + "tramo_14_correos_banco_valencia.mp3" },
            // PARADA 24 - Banco de Valencia
            { tipo: "parada", parada: 24, nombre: "Banco de Valencia", audio: AUDIO_BASE_PATH + "parada_24_banco_valencia.mp3" },
            // TRAMO 15 - Banco de València → Palacio del Marqués de Dos Aguas
            { tipo: "tramo", tramo: 15, nombre: "Banco de Valencia → Palacio del Marqués de Dos Aguas (Museo Nacional de Cerámica)", audio: AUDIO_BASE_PATH + "tramo_15_banco_marques.mp3" },
            // PARADA 25 - Palacio del Marqués de Dos Aguas
            { tipo: "parada", parada: 25, nombre: "Palacio del Marqués de Dos Aguas (Museo Nacional de Cerámica)", audio: AUDIO_BASE_PATH + "parada_25_marques_dos_aguas.mp3" },
            // TRAMO 16 - Palacio del Marqués → Mercado Central
            { tipo: "tramo", tramo: 16, nombre: "Palacio del Marqués → Mercado Central", audio: AUDIO_BASE_PATH + "tramo_16_marques_mercado_central.mp3" },
            // PARADA 26 - Mercado Central
            { tipo: "parada", parada: 26, nombre: "Mercado Central", audio: AUDIO_BASE_PATH + "parada_26_mercado_central.mp3" },
            // TRAMO 17 - Mercado Central → Iglesia de los Santos Juanes
            { tipo: "tramo", tramo: 17, nombre: "Mercado Central → Iglesia de los Santos Juanes", audio: AUDIO_BASE_PATH + "tramo_17_mercado_santos_juanes.mp3" },
            // PARADA 27 - Iglesia de los Santos Juanes - Reto 24
            { tipo: "parada", parada: 27, nombre: "Iglesia de los Santos Juanes reto 24", audio: AUDIO_BASE_PATH + "parada_27_santos_juanes_reto24.mp3", reto: 24 },
            // PARADA 28 - Iglesia de los Santos Juanes - Reto 25
            { tipo: "parada", parada: 28, nombre: "Iglesia de los Santos Juanes reto 25", audio: AUDIO_BASE_PATH + "parada_28_santos_juanes_reto25.mp3", reto: 25 },
            // TRAMO 18 - Iglesia Santos Juanes → Lonja de València
            { tipo: "tramo", tramo: 18, nombre: "Iglesia Santos Juanes → Lonja de València (Mercado de la Seda)", audio: AUDIO_BASE_PATH + "tramo_18_santos_juanes_lonja.mp3" },
            // PARADA 29 - Lonja Puerta de Los Pecados barquero
            { tipo: "parada", parada: 29, nombre: "Lonja Puerta de Los Pecados barquero", audio: AUDIO_BASE_PATH + "parada_29_lonja_barquero.mp3" },
            // PARADA 30 - Lonja Puerta de Los Pecados árbol muerto
            { tipo: "parada", parada: 30, nombre: "Lonja Puerta de Los Pecados árbol muerto", audio: AUDIO_BASE_PATH + "parada_30_lonja_arbol_muerto.mp3" },
            // TRAMO 19 - Lonja Gárgolas
            { tipo: "tramo", tramo: 19, nombre: "Lonja Gárgolas", audio: AUDIO_BASE_PATH + "tramo_19_lonja_gargolas.mp3" },
            // PARADA 31 - Lonja Gárgolas ángel vasija
            { tipo: "parada", parada: 31, nombre: "Lonja Gárgolas ángel vasija", audio: AUDIO_BASE_PATH + "parada_31_lonja_angel_vasija.mp3" },
            // PARADA 32 - Lonja Gárgolas barbudo y león
            { tipo: "parada", parada: 32, nombre: "Lonja Gárgolas barbudo y león", audio: AUDIO_BASE_PATH + "parada_32_lonja_barbudo_leon.mp3" },
            // PARADA 33 - Lonja Gárgolas fornicador ventana
            { tipo: "parada", parada: 33, nombre: "Lonja Gárgolas fornicador ventana", audio: AUDIO_BASE_PATH + "parada_33_lonja_fornicador_ventana.mp3" },
            // TRAMO 20 - Lonja → Plaza del Doctor Collado
            { tipo: "tramo", tramo: 20, nombre: "Lonja → Plaza del Doctor Collado", audio: AUDIO_BASE_PATH + "tramo_20_lonja_plaza_collado.mp3" },
            // TRAMO 21 - Plaza del Doctor Collado → Plaza del Negrito
            { tipo: "tramo", tramo: 21, nombre: "Plaza del Doctor Collado → Plaza del Negrito (Fuente del Negrito)", audio: AUDIO_BASE_PATH + "tramo_21_collado_negrito.mp3" },
            // PARADA 34 - Fuente del Negrito
            { tipo: "parada", parada: 34, nombre: "Fuente del Negrito", audio: AUDIO_BASE_PATH + "parada_34_fuente_negrito.mp3" },
            // TRAMO 22 - Plaza del Negrito → Calle Caballeros
            { tipo: "tramo", tramo: 22, nombre: "Plaza del Negrito → Calle Caballeros", audio: AUDIO_BASE_PATH + "tramo_22_negrito_caballeros.mp3" },
            // PARADA 35 - Palau de la Generalitat
            { tipo: "parada", parada: 35, nombre: "Palau de la Generalitat", audio: AUDIO_BASE_PATH + "parada_35_palau_generalitat.mp3" },
            // TRAMO 23 - Palacio de la Generalitat → Calle de los Serranos (FINAL)
            { tipo: "tramo", tramo: 23, nombre: "Palacio de la Generalitat → Calle de los Serranos (FINAL)", audio: AUDIO_BASE_PATH + "tramo_23_generalitat_serranos_final.mp3" },
            // PARADA 36 - Torres de Serranos (Final)
            { tipo: "parada", parada: 36, nombre: "Torres de Serranos Final", audio: AUDIO_BASE_PATH + "parada_36_torres_serranos_final.mp3" }
        ];
        
        // Variables globales
        window.paradaActual = 0; // Índice de la parada actual
        
        // Función para mostrar mensajes en la ventana de información
        function mostrarMensajeInfoParada(mensaje, esError = false) {
            const info = document.getElementById('info-parada');
            if (info) {
                info.textContent = mensaje;
                info.style.display = 'block';
                if (esError) {
                    info.classList.add('error');
                } else {
                    info.classList.remove('error');
                }
            }
        }
        
        // Hacer la función accesible globalmente
        window.mostrarMensajeInfoParada = mostrarMensajeInfoParada;

        // Función para ocultar la información de la parada
        function ocultarInfoParada() {
            const info = document.getElementById('info-parada');
            if (info) {
                info.style.display = 'none';
            }
        }
        
        // Hacer la función accesible globalmente
        window.ocultarInfoParada = ocultarInfoParada;

        // Inicialización del mapa
        let map;
        document.addEventListener('DOMContentLoaded', function() {
            map = L.map('mapa', {
                center: [39.4622, -0.37802],
                zoom: 14,
                zoomControl: false,
                rotate: false,
                touchRotate: false,
                bearing: 0
            });
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                maxZoom: 40, 
                attribution: '© OpenStreetMap contributors' 
            }).addTo(map);

            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                    console.log("map.invalidateSize() ejecutado.");
                }
            }, 100);
        });

        // Inicialización de la aplicación
        function inicializarAplicacion() {
            ocultarHijo4();
            ocultarInfoParada();
            closeMediaOverlay();
            
            window.paradaActual = 0;
            
            // Notificar a hijo5-casa (botón casa) el estado inicial: modo GPS activo y parada 0
            const hijo5 = document.getElementById('hijo5-casa');
            const hijo2 = document.getElementById('hijo2');
            
            if (hijo2 && hijo2.contentWindow) {
                hijo2.contentWindow.postMessage({ tipo: 'mostrar-foto-video', index: 0 }, '*');
                hijo2.contentWindow.postMessage({ tipo: 'activar-botones-foto-video', color: 'green' }, '*');
                hijo2.contentWindow.postMessage({ tipo: 'gps-on' }, '*');
            }
            
            if (hijo5 && hijo5.contentWindow) {
                hijo5.contentWindow.postMessage({ type: 'modoGPS', parada: 0 }, '*');
            }
        }
        
        // Iniciar la aplicación cuando el DOM esté completamente cargado
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarAplicacion);
        } else {
            inicializarAplicacion();
        }
        }());
    </script>
</body>
</html>
