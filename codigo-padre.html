<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aventura 1 - Padre</title>
    
    <!-- Prevenir rotaci√≥n en m√≥viles -->
    <style>
        @media screen and (orientation: landscape) and (max-width: 768px) {
            /* Bloquear orientaci√≥n horizontal en m√≥viles */
            body::before {
                content: "Por favor, rota tu dispositivo a modo vertical";
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                text-align: center;
                z-index: 9999;
                padding: 20px;
                box-sizing: border-box;
            }
            
            /* Ocultar todo el contenido en orientaci√≥n horizontal m√≥vil */
            #mapa,
            iframe,
            #mensaje-flotante,
            #media-overlay {
                display: none !important;
            }
        }
        
        @media screen and (orientation: portrait) and (max-width: 768px) {
            /* Asegurar que en vertical m√≥vil todo funcione normal */
            body::before {
                display: none;
            }
        }
        
        @media screen and (min-width: 769px) {
            /* PC y tablets: permitir cualquier orientaci√≥n */
            body::before {
                display: none !important;
            }
        }
    </style>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Plugin de rotaci√≥n para Leaflet -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-rotate@0.2.8/leaflet-rotate.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet-rotate@0.2.8/leaflet-rotate.js"></script>
    <!-- Plugin de rotaci√≥n para Leaflet -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-rotate@0.2.8/leaflet-rotate.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet-rotate@0.2.8/leaflet-rotate.js"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Evita scroll no deseado */
        }
        #mapa {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1; /* Bajo z-index para que sea el fondo */
        }
        body {
            margin: 0;
            padding: 0;
            background: transparent; /* MUY IMPORTANTE: Para que el mapa se vea a trav√©s del body */
        }
        /* Estilo base para todos los iframes, si no se sobreescribe */
        iframe {
            background: transparent; /* Asegura que los iframes no tapen el mapa con un fondo opaco */
        }

        /* ================== VARIABLES Y ESTILO HIJO 4 (RETOS) ================== */
        :root {
            --iframe-hijo4-width: 60vw;
            --iframe-hijo4-height: 40vh;
            --iframe-hijo4-top: 10vh;
            --iframe-hijo4-left: 50%;
            --iframe-hijo4-translate-x: -50%;
            --iframe-hijo4-z: 2000;
        }
        #hijo4 {
            position: fixed;
            top: var(--iframe-hijo4-top);
            left: var(--iframe-hijo4-left);
            width: var(--iframe-hijo4-width);
            height: var(--iframe-hijo4-height);
            transform: translateX(var(--iframe-hijo4-translate-x));
            z-index: var(--iframe-hijo4-z);
            border: 2px solid red; /* Borde consistente */
            background: transparent;
            pointer-events: auto;
            display: none; /* Oculto por defecto, se muestra por JS */
        }



        /* ================== ESTILO PARA VIDEO E IMAGEN (NUEVO) ================== */
        #media-overlay {
            display: none; /* Oculto por defecto, se cambia a 'flex' para mostrar */
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 4000; /* Alto z-index para estar por encima de todo */
            /* display: flex; REMOVED from CSS, controlled by JS */
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px); /* Efecto de desenfoque */
        }

        #media-container {
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            background: transparent;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            padding: 10px;
        }

        #close-media {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 1.2em;
            cursor: pointer;
            z-index: 4001;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #parada-video, #parada-imagen {
            max-width: 100%;
            max-height: calc(100vh - 80px); /* Ajusta para dejar espacio al bot√≥n de cerrar */
            display: none; /* Oculto por defecto */
            border-radius: 5px;
        }

        /* ================== VENTANA FLOTANTE PARA MENSAJES ================== */
        #mensaje-flotante {
            position: fixed;
            bottom: 295px; /* Pegado arriba del hijo2 (150px altura + 135px hijo3 + 10px margen) */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 8px 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1002;
            font-size: 12px;
            text-align: center;
            max-width: 280px;
            min-height: 30px;
            display: none; /* Oculto por defecto */
            font-family: Arial, sans-serif;
            color: #333;
            backdrop-filter: blur(3px);
        }
        #mensaje-flotante.loading {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="mapa"></div>

    <iframe id="hijo1-hamburguesa" src="botones-y-subfunciones-hamburguesa.html" style="position:fixed; left:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; border: transparent; background:transparent; pointer-events:auto;"></iframe>
    <iframe id="hijo1-opciones" src="botones-y-subfunciones-opciones.html" style="position:fixed; right:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; border: transparent; background:transparent; pointer-events:auto;"></iframe>
    <iframe id="hijo1-mapa" src="botones-y-subfunciones-mapa.html" style="position:fixed; right:1vw; top:0vw; height: 200px; width:57px; z-index:1005; border:2px solid red; background:transparent; pointer-events:auto;"></iframe>
    <iframe id="hijo5-casa" src="Av1-boton-casa.html" style="position:fixed; left:10px; top:10px; height:350px; width:100px; z-index:1005; border:2px solid red; background:transparent; pointer-events:auto; transition:width 0.3s; margin:0; padding:0; box-sizing:border-box;"></iframe>

    <iframe id="hijo3" src="Av1_audio_esp.html"
            style="position:fixed;
                   bottom:0px;
                   left:50%;
                   transform:translateX(-50%);
                   height:140px; /* Altura del hijo 3 */
                   width:310px;
                   z-index:1000;
                   border: transparent;
                   display:block;
                   pointer-events:auto;"></iframe>

    <iframe id="hijo2" src="./Av1-botones-coordenadas.html"
            style="position:fixed;
                   bottom:139px; /* 1px por encima del hijo 3 */
                   left:50%;
                   transform:translateX(-50%);
                   height:160px; /* Altura del hijo 2 */
                   width:310px;
                   z-index:1001;
                   border:transparent;
                   pointer-events:auto;"
            allow="geolocation"></iframe>

    <iframe id="hijo4" src="Av1-esp-retos-preguntas.html"></iframe>

    <!-- Ventana flotante para mensajes -->
    <div id="mensaje-flotante">
        Pulsa GPS para obtener tu ubicaci√≥n
    </div>

    <div id="media-overlay">
        <div id="media-container">
            <button id="close-media">X</button>
            <video id="parada-video" controls></video>
            <img id="parada-imagen">
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ================== ARRAY DE 25 PARADAS (METADATOS) ==================
        // Este array contiene solo el nombre y datos de audio/reto/foto/video.
        // Las coordenadas (lat/lng) se gestionan en Av1-botones-coordenadas.html (Hijo 2).
        const PARADAS = [
            { parada: 0, nombre: "Torres de Serranos (start)", foto: 0, video: 0, audio: "audio_0.mp3", reto: 0 },
            { parada: 1, nombre: "Torres de Serranos ‚Üí Plaza de la crida (Puente de Serranos)", foto: 1, video: 1, audio: "audio_1.mp3", reto: 1 },
            { parada: 2, nombre: "Plaza de la crida ‚Üí Palacio de los Borgia (Cortes Valencianas)", foto: 2, video: 2, audio: "audio_2.mp3", reto: 2 },
            { parada: 3, nombre: "Palacio de los Borgia ‚Üí Plaza de la Virgen", foto: 3, video: 3, audio: "audio_3.mp3", reto: 3 },
            { parada: 4, nombre: "Plaza de la Virgen ‚Üí Plaza de la Almo√≠na", foto: 4, video: 4, audio: "audio_4.mp3", reto: 4 },
            { parada: 5, nombre: "Plaza de la Almo√≠na ‚Üí Catedral de Val√®ncia", foto: 5, video: 5, audio: "audio_5.mp3", reto: 5 },
            { parada: 6, nombre: "Catedral ‚Üí Plaza Decimo Junio Bruto (Museo Arqueol√≥gico de la Almo√≠na)", foto: 6, video: 6, audio: "audio_6.mp3", reto: 6 },
            { parada: 7, nombre: "Plaza Decimo Junio Bruto ‚Üí Bas√≠lica de Val√®ncia", foto: 7, video: 7, audio: "audio_7.mp3", reto: 7 },
            { parada: 8, nombre: "Bas√≠lica ‚Üí Palacio Arzobispal", foto: 8, video: 8, audio: "audio_8.mp3", reto: 8 },
            { parada: 9, nombre: "Palacio Arzobispal ‚Üí Plaza del Ayuntamiento", foto: 9, video: 9, audio: "audio_9.mp3", reto: 9 },
            { parada: 10, nombre: "Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento de Val√®ncia", foto: 10, video: 10, audio: "audio_10.mp3", reto: 10 },
            { parada: 11, nombre: "Edificio del Ayuntamiento ‚Üí Estaci√≥n del Norte", foto: 11, video: 11, audio: "audio_11.mp3", reto: 11 },
            { parada: 12, nombre: "Estaci√≥n del Norte ‚Üí Plaza de Toros de Val√®ncia", foto: 12, video: 12, audio: "audio_12.mp3", reto: 12 },
            { parada: 13, nombre: "Plaza de Toros ‚Üí Casa estilo √Årabe", foto: 13, video: 13, audio: "audio_13.mp3", reto: 13 },
            { parada: 14, nombre: "Casa estilo √Årabe ‚Üí Palacio de Comunicaciones (Correos)", foto: 14, video: 14, audio: "audio_14.mp3", reto: 14 },
            { parada: 15, nombre: "Palacio de Comunicaciones ‚Üí Banco de Val√®ncia", foto: 15, video: 15, audio: "audio_15.mp3", reto: 15 },
            { parada: 16, nombre: "Banco de Val√®ncia ‚Üí Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica)", foto: 16, video: 16, audio: "audio_16.mp3", reto: 16 },
            { parada: 17, nombre: "Palacio del Marqu√©s ‚Üí Mercado Central", foto: 17, video: 17, audio: "audio_17.mp3", reto: 17 },
            { parada: 18, nombre: "Mercado Central ‚Üí Iglesia de los Santos Juanes", foto: 18, video: 18, audio: "audio_18.mp3", reto: 18 },
            { parada: 19, nombre: "Iglesia Santos Juanes ‚Üí Lonja de Val√®ncia (Mercado de la Seda)", foto: 19, video: 19, audio: "audio_19.mp3", reto: 19 },
            { parada: 20, nombre: "Lonja ‚Üí Plaza del Doctor Collado", foto: 20, video: 20, audio: "audio_20.mp3", reto: 20 },
            { parada: 21, nombre: "Plaza del Doctor Collado ‚Üí Plaza del Negrito (Fuente del Negrito)", foto: 21, video: 21, audio: "audio_21.mp3", reto: 21 },
            { parada: 22, nombre: "Plaza del Negrito ‚Üí Calle Caballeros", foto: 22, video: 22, audio: "audio_22.mp3", reto: 22 },
            { parada: 23, nombre: "Calle Caballeros ‚Üí Palacio de la Generalitat", foto: 23, video: 23, audio: "audio_23.mp3", reto: 23 },
            { parada: 24, nombre: "Palacio de la Generalitat ‚Üí Calle de los Serranos (FINAL)", foto: 24, video: 24, audio: "audio_24.mp3", reto: 24 }
        ];

        let paradaActual = 0; // √çndice de la parada actual

        // ================== MAPA LEAFLET ==================
        let map; // Declara 'map' fuera del listener para que sea accesible globalmente
        let userLocationMarker = null; // Marcador para la ubicaci√≥n del usuario (NUEVO)

        document.addEventListener('DOMContentLoaded', function() {
            // Centrar el mapa en las nuevas coordenadas y habilitar rotaci√≥n
            map = L.map('mapa', {
                center: [39.46368, -0.37752], // Nuevas coordenadas del centro
                zoom: 14,
                rotate: true, // Habilitar rotaci√≥n del mapa
                rotateControl: {
                    closeOnZeroBearing: false // Mantener control de rotaci√≥n visible
                },
                bearing: 0 // √Ångulo inicial (0 = norte arriba)
            });
            
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                maxZoom: 40, 
                attribution: '¬© OpenStreetMap contributors' 
            }).addTo(map);

            setTimeout(() => {
                if (map) { // A√±adimos una comprobaci√≥n por si acaso
                    map.invalidateSize();
                    console.log("map.invalidateSize() ejecutado."); // Para depuraci√≥n
                }
            }, 100);
            
            // Control de orientaci√≥n para m√≥viles
            function handleOrientationChange() {
                // Solo aplicar en dispositivos m√≥viles (pantalla peque√±a)
                if (window.innerWidth <= 768) {
                    if (window.orientation === 90 || window.orientation === -90) {
                        // Orientaci√≥n horizontal en m√≥vil - mostrar aviso
                        console.log('üì± Orientaci√≥n horizontal detectada en m√≥vil');
                    } else {
                        // Orientaci√≥n vertical en m√≥vil - todo normal
                        console.log('üì± Orientaci√≥n vertical detectada en m√≥vil');
                        // Invalidar el mapa por si hubo cambios
                        if (map) {
                            setTimeout(() => map.invalidateSize(), 200);
                        }
                    }
                } else {
                    // PC/Tablet - permitir cualquier orientaci√≥n
                    console.log('üíª Dispositivo grande - orientaci√≥n libre');
                    if (map) {
                        setTimeout(() => map.invalidateSize(), 200);
                    }
                }
            }
            
            // Escuchar cambios de orientaci√≥n
            window.addEventListener('orientationchange', handleOrientationChange);
            window.addEventListener('resize', handleOrientationChange);
            
            // Verificar orientaci√≥n inicial
            handleOrientationChange();
        });

        // --- Estado global ---
        let polyline = null;
        let markerA = null, markerB = null;
        let markerParada = null; // marcador de parada seleccionada

        // ================== CONTROL DE VISIBILIDAD HIJO 4 ==================
        const iframeHijo4 = document.getElementById('hijo4');
        function mostrarRetoEnHijo4(index) {
            // Aseg√∫rate de que el √≠ndice sea v√°lido para el array PARADAS
            if (index !== null && index !== undefined && PARADAS[window.paradaActual] && typeof PARADAS[window.paradaActual].reto === 'number') {
                iframeHijo4.contentWindow.postMessage({
                    type: 'mostrarRetoIndex',
                    index: PARADAS[window.paradaActual].reto // Pasamos el 'reto' index del array PARADAS
                }, '*');
                iframeHijo4.style.display = 'block';
            } else {
                console.warn("No se pudo mostrar el reto: √≠ndice o datos de reto inv√°lidos para la parada actual.");
            }
        }
        function ocultarHijo4() {
            iframeHijo4.style.display = 'none';
        }

        // ================== CONTROL DE VISIBILIDAD DE MEDIOS (VIDEO/IMAGEN) (NUEVO) ==================
        const mediaOverlay = document.getElementById('media-overlay');
        const closeMediaButton = document.getElementById('close-media');
        const paradaVideo = document.getElementById('parada-video');
        const paradaImagen = document.getElementById('parada-imagen');

        // Funci√≥n para cerrar la superposici√≥n de medios
        function closeMediaOverlay() {
            mediaOverlay.style.display = 'none';
            paradaVideo.pause();
            paradaVideo.currentTime = 0; // Reinicia el video
            paradaVideo.style.display = 'none';
            paradaImagen.style.display = 'none';
        }

        // Event listener para el bot√≥n de cerrar medios
        closeMediaButton.addEventListener('click', closeMediaOverlay);

        function mostrarVideoParada(paradaData) {
            if (paradaData && paradaData.video) {
                paradaVideo.src = paradaData.video; // Asume que el video est√° en la misma ruta o ruta relativa conocida
                paradaVideo.style.display = 'block';
                paradaImagen.style.display = 'none';
                mediaOverlay.style.display = 'flex'; // Cambiar a flex para mostrar
                paradaVideo.play();
            }
        }

        function mostrarImagenParada(paradaData) {
            if (paradaData && paradaData.foto) {
                paradaImagen.src = paradaData.foto; // Asume que la imagen est√° en la misma ruta o ruta relativa conocida
                paradaImagen.style.display = 'block';
                paradaVideo.style.display = 'none';
                mediaOverlay.style.display = 'flex'; // Cambiar a flex para mostrar
            }
        }

        // ================== NUEVA FUNCI√ìN PARA HIJO2 ACTUALIZADO ==================
        // Funci√≥n para mostrar ruta con chinchetas (verde origen, roja destino)
        function mostrarRutaConChinchetas(ruta, origen, destino, nombre) {
            if (!map) {
                console.error("Mapa no inicializado a√∫n.");
                return;
            }

            // Limpiar elementos previos del mapa
            if (polyline) { map.removeLayer(polyline); }
            if (markerA) { map.removeLayer(markerA); }
            if (markerB) { map.removeLayer(markerB); }

            // Validar datos de entrada
            if (!ruta || !Array.isArray(ruta) || ruta.length < 2) {
                console.warn("Ruta inv√°lida para mostrar en el mapa.");
                return;
            }

            // Crear polyline con toda la ruta (incluye waypoints invisibles)
            const latlngs = ruta.map(p => [p.lat, p.lng]);
            polyline = L.polyline(latlngs, { 
                color: '#007bff', 
                weight: 4, 
                opacity: 0.8 
            }).addTo(map);

            // Chincheta verde (origen - usuario)
            if (origen) {
                markerA = L.marker([origen.lat, origen.lng], { 
                    icon: L.icon({ 
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    }) 
                }).addTo(map).bindPopup('Tu ubicaci√≥n');
            }

            // Chincheta roja (destino - parada objetivo)
            if (destino) {
                markerB = L.marker([destino.lat, destino.lng], { 
                    icon: L.icon({ 
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    }) 
                }).addTo(map).bindPopup(nombre || 'Destino');
            }

            // Auto-zoom para mostrar toda la ruta del segmento actual
            map.fitBounds(polyline.getBounds(), { 
                padding: [30, 30] // Margen visual
            });

            console.log(`Ruta mostrada: ${nombre}`);
        }

        // ================== CONFIGURACI√ìN DE SEGURIDAD ==================
        const SECURITY_CONFIG = {
            ALLOWED_ORIGINS: [
                window.location.origin, // Origen local
                'https://valenciavguides.github.io', // GitHub Pages
                'file://', // Archivos locales
                null // Para archivos locales en algunos navegadores
            ],
            MESSAGE_TIMEOUT: 5000, // 5 segundos timeout para respuestas
            MAX_MESSAGES_PER_SECOND: 20, // AUMENTADO: L√≠mite de mensajes por segundo
            SESSION_TOKEN: 'aventura-valencia-' + Date.now() // Token √∫nico de sesi√≥n
        };

        // Control de velocidad de mensajes
        let messageCounter = 0;
        let lastResetTime = Date.now();

        function isRateLimited() {
            const now = Date.now();
            if (now - lastResetTime > 1000) {
                messageCounter = 0;
                lastResetTime = now;
            }
            
            messageCounter++;
            return messageCounter > SECURITY_CONFIG.MAX_MESSAGES_PER_SECOND;
        }

        function isOriginAllowed(origin) {
            // Permitir or√≠genes expl√≠citamente listados
            if (SECURITY_CONFIG.ALLOWED_ORIGINS.includes(origin)) {
                return true;
            }
            
            // Verificar patrones para archivos locales
            if (origin === 'null' || origin === null) {
                return true; // Archivos locales pueden tener origin null
            }
            
            // Verificar si es un archivo local con protocolo file://
            if (origin && origin.startsWith('file://')) {
                return true;
            }
            
            return false;
        }

        function validateMessageStructure(data) {
            if (!data || typeof data !== 'object') {
                return false;
            }
            
            // Validar que tenga al menos un tipo de mensaje
            if (!data.type && !data.tipo) {
                return false;
            }
            
            // Validar longitud de strings para prevenir ataques
            const maxStringLength = 1000;
            for (const key in data) {
                if (typeof data[key] === 'string' && data[key].length > maxStringLength) {
                    console.warn(`Mensaje rechazado: campo ${key} demasiado largo`);
                    return false;
                }
            }
            
            return true;
        }

        // ================== ESCUCHA MENSAJES DE LOS HIJOS (SEGURO) ==================
        window.addEventListener('message', (event) => {
            // === VALIDACIONES DE SEGURIDAD ===
            
            // 1. Verificar origen
            if (!isOriginAllowed(event.origin)) {
                console.warn('Mensaje rechazado: origen no permitido -', event.origin);
                return;
            }
            
            // 2. Control de velocidad
            if (isRateLimited()) {
                console.warn('Mensaje rechazado: demasiados mensajes por segundo');
                return;
            }
            
            // 3. Validar estructura del mensaje
            if (!validateMessageStructure(event.data)) {
                console.warn('Mensaje rechazado: estructura inv√°lida');
                return;
            }
            
            console.log('‚úÖ Mensaje validado y aceptado desde:', event.origin);
            const data = event.data;

            // HIJO 4: Retos/preguntas (ocultar ventana de retos)
            if (data && data.type === 'ocultarReto') {
                ocultarHijo4();
            }
            // --- L√≥gica para cerrar otros men√∫s de botones ---
            if (data && data.type === 'closeOtherMenus' && data.except) {
                const ids = ['hijo1-hamburguesa', 'hijo1-opciones', 'hijo1-mapa'];
                ids.forEach(id => {
                    if (
                        (id === 'hijo1-hamburguesa' && data.except !== 'hamburguesa') ||
                        (id === 'hijo1-opciones' && data.except !== 'mas-opciones') ||
                        (id === 'hijo1-mapa' && data.except !== 'mapa')
                    ) {
                        const iframe = document.getElementById(id);
                        if (iframe && iframe.contentWindow) {
                            sendSecureMessage(id, {
                                type: 'closeOtherMenus',
                                except: data.except
                            });
                        }
                    }
                });
            }
            // HIJO 1: Botones y subfunciones
            if (data && data.type === 'pauseAudioFromBoton') {
                sendSecureMessage('hijo3', { type: 'pauseAudio' });
            }
            
            // ================== HIJO 2: NUEVOS MENSAJES ==================
            // NUEVO: Mensaje de prueba de comunicaci√≥n
            if (data && data.tipo === 'test-respuesta') {
                console.log('=== PADRE RECIBI√ì RESPUESTA DEL HIJO2 ===');
                console.log('Mensaje:', data.mensaje);
                alert('‚úÖ COMUNICACI√ìN EXITOSA!\n\n' + data.mensaje);
            }
            
            // NUEVO: Mensajes de estado para ventana flotante
            if (data && data.tipo === 'statusMensaje') {
                mostrarMensajeFlotante(data.mensaje, data.loading || false);
            }
            if (data && data.tipo === 'ocultarStatus') {
                ocultarMensajeFlotante();
            }
            
            // NUEVO: Mensaje para mostrar ruta con chinchetas (del hijo2 actualizado)
            if (data && data.tipo === 'mostrar-ruta-con-chinchetas') {
                mostrarRutaConChinchetas(data.ruta, data.origen, data.destino, data.nombre);
            }
            // MANTENER: Mensajes existentes del hijo2
            if (data && data.tipo === 'mostrar-mapa-gps') {
                mostrarRutaEnMapa(data.ruta, data.origen, data.destino);
            }
            if (data && data.tipo === 'mostrar-zoom-streetview') {
                // Implementaci√≥n b√°sica, se podr√≠a expandir con API de StreetView
                alert('Mostrar StreetView de: ' + (data.info && data.info.nombre ? data.info.nombre : ''));
            }
            if (data && data.tipo === 'mostrar-imagen') {
                // data.info deber√≠a ser el objeto de PARADAS completo de la parada
                mostrarImagenParada(data.info);
            }
            if (data && data.tipo === 'mostrar-video') { // NUEVO: Manejo de mensajes de video
                // data.info deber√≠a ser el objeto de PARADAS completo de la parada
                mostrarVideoParada(data.info);
            }
            if (data && data.type === 'actualizarUbicacionMapa') { // NUEVO: Mensaje para actualizar ubicaci√≥n del usuario
                if (!map) {
                    console.error("Mapa no inicializado a√∫n.");
                    return;
                }
                const { lat, lng } = data; // Asume que lat y lng vienen en el mensaje
                if (userLocationMarker) {
                    userLocationMarker.setLatLng([lat, lng]);
                } else {
                    // Icono azul para el usuario
                    userLocationMarker = L.marker([lat, lng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map);
                }
                map.setView([lat, lng], map.getZoom()); // Mantiene el zoom actual, o ajusta si es necesario
            }
            if (data && data.tipo === 'ya-estoy-aqui') {
                // Cuando el GPS confirma que has llegado a una parada
                // Sincroniza la variable global paradaActual del primer script
                window.paradaActual = data.parada; // data.parada es el √≠ndice correcto de la parada
                avanzarAParada(data.parada); // Esta funci√≥n reproduce el audio
            }
            
            // HIJO 3: Audio
            if (data && data.type === 'audioFinalizado') {
                // Aseg√∫rate de que PARADAS[window.paradaActual] no sea undefined si el √≠ndice no existe
                mostrarRetoEnHijo4(PARADAS[window.paradaActual] ? PARADAS[window.paradaActual].reto : null);
            }
            // HIJO 4: Retos/preguntas
            if (data && data.type === 'reto-interactivo-completado') {
                avanzarRuta();
            }
            if (data && data.type === 'reto-respuesta-mostrada') {
                // El usuario ha pedido ver la respuesta, puedes decidir si avanzar o esperar acci√≥n manual
            }
            // HIJO 5: GPS Casa (modo off)
            if (data && data.type === 'gpsStatus') {
                const gpsOn = data.on;
                
                console.log(`üîÑ PADRE: Recibido gpsStatus - ON: ${gpsOn}`);
                
                // Ajustar el ancho del iframe inmediatamente
                ajustarAnchoHijo5(gpsOn);
                
                // Ejecutar las acciones del modo con un peque√±o delay
                setTimeout(() => {
                    if (!gpsOn) {
                        console.log('üè† PADRE: Activando modo casa');
                        activarModoCasa();
                    } else {
                        console.log('üó∫Ô∏è PADRE: Iniciando aventura');
                        iniciarAventura();
                        borrarParadaEnMapa();
                    }
                }, 150);
            }
            
            // NUEVO: Mensajes espec√≠ficos de expansi√≥n/contracci√≥n de iframe
            if (data && data.type === 'expandirIframe') {
                console.log(`üìê PADRE: Recibido expandirIframe - width: ${data.width}, debug: ${data.debug}`);
                const iframe = document.getElementById('hijo5-casa');
                if (iframe) {
                    iframe.style.width = data.width;
                    iframe.style.transition = 'width 0.3s ease-in-out';
                    console.log(`‚úÖ PADRE: Iframe hijo5 expandido a ${data.width}`);
                    
                    // Verificaci√≥n despu√©s de un momento
                    setTimeout(() => {
                        const anchoActual = iframe.style.width;
                        console.log(`üîç PADRE: Verificaci√≥n expansi√≥n - Ancho actual: ${anchoActual}`);
                        if (anchoActual !== data.width) {
                            console.warn(`‚ö†Ô∏è PADRE: Expansi√≥n fallida. Reintentando...`);
                            iframe.style.width = data.width;
                        }
                    }, 400);
                } else {
                    console.error('‚ùå PADRE: No se encontr√≥ iframe hijo5-casa para expandir');
                }
            }
            
            if (data && data.type === 'contraerIframe') {
                console.log(`üìê PADRE: Recibido contraerIframe - width: ${data.width}, debug: ${data.debug}`);
                const iframe = document.getElementById('hijo5-casa');
                if (iframe) {
                    iframe.style.width = data.width;
                    iframe.style.transition = 'width 0.3s ease-in-out';
                    console.log(`‚úÖ PADRE: Iframe hijo5 contra√≠do a ${data.width}`);
                    
                    // Verificaci√≥n despu√©s de un momento
                    setTimeout(() => {
                        const anchoActual = iframe.style.width;
                        console.log(`üîç PADRE: Verificaci√≥n contracci√≥n - Ancho actual: ${anchoActual}`);
                        if (anchoActual !== data.width) {
                            console.warn(`‚ö†Ô∏è PADRE: Contracci√≥n fallida. Reintentando...`);
                            iframe.style.width = data.width;
                        }
                    }, 400);
                } else {
                    console.error('‚ùå PADRE: No se encontr√≥ iframe hijo5-casa para contraer');
                }
            }
            if (data && data.type === 'seleccionParada') {
                // Usamos las coordenadas (lat, lng) que vienen directamente del mensaje de hijo5
                // Y obtenemos el nombre de la parada de nuestro array PARADAS local.
                const paradaConCoordenadas = {
                    lat: data.lat,
                    lng: data.lng,
                    nombre: PARADAS[data.index]?.nombre || 'Parada seleccionada'
                };
                mostrarParadaEnMapa(data.index, paradaConCoordenadas);
                window.paradaActual = data.index;
                
                // ‚≠ê NUEVO: Actualizar la parada actual en hijo2
                console.log(`üîÑ PADRE: Actualizando parada actual a ${data.index} en hijo2`);
                const success = sendSecureMessage('hijo2', {
                    tipo: 'actualizar-parada-actual',
                    parada: data.index
                });
                if (!success) {
                    console.warn("Advertencia: No se pudo actualizar parada en hijo2");
                } else {
                    console.log(`‚úÖ PADRE: Parada ${data.index} actualizada en hijo2`);
                }
                
                activarTodosLosBotones();
            }
            if (data && data.type === 'cerrarParadas') {
                borrarParadaEnMapa();
            }
            // NUEVO: Mensaje para cerrar el visor de medios
            if (data && data.type === 'cerrarMedia') {
                closeMediaOverlay();
            }
            
            // ========== REENV√çO DE MENSAJES ENTRE HIJOS ==========
            
            // Mensaje para reenviar al hijo 2
            if (data && data.tipo === 'mensaje-para-hijo2') {
                console.log('üîÑ PADRE: Reenviando mensaje a Hijo 2:', data.mensaje);
                const success = sendSecureMessage('hijo2', data.mensaje);
                if (!success) {
                    console.warn("Advertencia: No se pudo reenviar mensaje a hijo2");
                } else {
                    console.log('‚úÖ PADRE: Mensaje reenviado exitosamente a Hijo 2');
                }
            }
            
            // Mensaje para reenviar al hijo 3 (audio)
            if (data && data.tipo === 'mensaje-para-hijo3') {
                console.log('üîÑ PADRE: Reenviando mensaje a Hijo 3:', data.mensaje);
                const success = sendSecureMessage('hijo3', data.mensaje);
                if (!success) {
                    console.warn("Advertencia: No se pudo reenviar mensaje a hijo3");
                } else {
                    console.log('‚úÖ PADRE: Mensaje reenviado exitosamente a Hijo 3');
                }
            }
            
            // Mensaje para reenviar al hijo 4 (retos)
            if (data && data.tipo === 'mensaje-para-hijo4') {
                console.log('üîÑ PADRE: Reenviando mensaje a Hijo 4:', data.mensaje);
                const success = sendSecureMessage('hijo4', data.mensaje);
                if (!success) {
                    console.warn("Advertencia: No se pudo reenviar mensaje a hijo4");
                } else {
                    console.log('‚úÖ PADRE: Mensaje reenviado exitosamente a Hijo 4');
                }
            }
        });

        // ================== INICIALIZACI√ìN Y FUNCIONES PRINCIPALES ==================
        ocultarHijo4(); // Oculta el iframe de retos al inicio
        closeMediaOverlay(); // Asegura que el visor de medios est√© oculto al inicio

        // ================== FUNCIONES DE ENV√çO SEGURO ==================
        function sendSecureMessage(iframeId, messageData) {
            const iframe = document.getElementById(iframeId);
            if (!iframe || !iframe.contentWindow) {
                console.warn(`Iframe ${iframeId} no encontrado o no cargado`);
                return false;
            }
            
            // A√±adir token de sesi√≥n al mensaje
            const secureMessage = {
                ...messageData,
                sessionToken: SECURITY_CONFIG.SESSION_TOKEN,
                timestamp: Date.now()
            };
            
            try {
                // Determinar el origen target apropiado
                let targetOrigin = window.location.origin;
                
                // Para GitHub Pages
                if (iframe.src && iframe.src.includes('valenciavguides.github.io')) {
                    targetOrigin = 'https://valenciavguides.github.io';
                }
                // Para archivos locales
                else if (iframe.src && iframe.src.startsWith('file://')) {
                    targetOrigin = '*'; // Los archivos locales requieren '*'
                }
                // Para rutas relativas locales
                else if (!iframe.src.startsWith('http')) {
                    targetOrigin = window.location.origin;
                }
                
                iframe.contentWindow.postMessage(secureMessage, targetOrigin);
                console.log(`‚úÖ Mensaje enviado de forma segura a ${iframeId}:`, messageData);
                return true;
            } catch (error) {
                console.error(`Error enviando mensaje a ${iframeId}:`, error);
                return false;
            }
        }

        // --- Funciones principales actualizadas con env√≠o seguro ---
        
        function ajustarAnchoHijo5(gpsOn) {
            const iframe = document.getElementById('hijo5-casa');
            if (iframe) {
                const nuevoAncho = gpsOn ? '80px' : '220px';
                console.log(`üîß PADRE: Ajustando ancho hijo5 a ${nuevoAncho}`);
                iframe.style.width = nuevoAncho;
                iframe.style.transition = 'width 0.3s ease-in-out';
                
                // Verificar despu√©s de un momento que el cambio se aplic√≥
                setTimeout(() => {
                    const anchoActual = iframe.style.width;
                    console.log(`‚úÖ PADRE: Ancho actual del iframe hijo5: ${anchoActual}`);
                    if (anchoActual !== nuevoAncho) {
                        console.warn(`‚ö†Ô∏è PADRE: El ancho no se aplic√≥ correctamente. Esperado: ${nuevoAncho}, Actual: ${anchoActual}`);
                        // Forzar el cambio de nuevo
                        iframe.style.width = nuevoAncho;
                    }
                }, 500);
            } else {
                console.error('‚ùå PADRE: No se encontr√≥ iframe hijo5-casa');
            }
        }
        
        function iniciarAventura() {
            window.paradaActual = 0; // Se inicializa la primera parada (√≠ndice 0)
            const success = sendSecureMessage('hijo2', {
                tipo: 'iniciar-gps-a-parada',
                paradaDestinoNombre: PARADAS[window.paradaActual].nombre // Nombre de la Parada 1
            });
            
            if (!success) {
                console.warn("Advertencia: No se pudo enviar mensaje de inicio a hijo2");
            }
        }
        
        function avanzarRuta() {
            // Se llama despu√©s de completar un reto
            window.paradaActual++;
            if (window.paradaActual < PARADAS.length - 1) {
                const success = sendSecureMessage('hijo2', { 
                    tipo: 'navegar-de-a-b', 
                    origen: window.paradaActual, 
                    destino: window.paradaActual + 1 
                });
                
                if (!success) {
                    console.warn("Advertencia: No se pudo enviar mensaje de navegaci√≥n a hijo2");
                }
            } else {
                console.log('¬°Has completado todas las paradas de la aventura!');
                // Aqu√≠ podr√≠as a√±adir l√≥gica para el final de la aventura
            }
        }
        
        function avanzarAParada(paradaIndex) {
            // Esta funci√≥n se llama cuando se confirma la llegada a una parada (mensaje 'ya-estoy-aqui')
            sendSecureMessage('hijo3', { type: 'setAudioParada', index: paradaIndex });
        }
        
        function activarTodosLosBotones() {
            const success = sendSecureMessage('hijo2', { tipo: 'activar-todos-botones' });
            if (!success) {
                console.warn("Advertencia: No se pudo enviar mensaje de activaci√≥n de botones a hijo2");
            }
        }
        
        function activarModoCasa() {
            const success = sendSecureMessage('hijo2', { tipo: 'activar-modo-casa' });
            if (!success) {
                console.warn("Advertencia: No se pudo enviar mensaje de modo casa a hijo2");
            }
        }
        function mostrarRutaEnMapa(ruta, origen, destino) {
            if (!map) {
                console.error("Mapa no inicializado a√∫n.");
                return;
            }
            if (polyline) { map.removeLayer(polyline); }
            if (markerA) { map.removeLayer(markerA); }
            if (markerB) { map.removeLayer(markerB); }
            if (!ruta || !Array.isArray(ruta) || ruta.length < 2) return;
            const latlngs = ruta.map(p => [p.lat, p.lng]);
            polyline = L.polyline(latlngs, { color: 'red', weight: 6 }).addTo(map);
            markerA = L.marker([ruta[0].lat, ruta[0].lng], { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [32, 32] }) }).addTo(map);
            markerB = L.marker([ruta[ruta.length - 1].lat, ruta[ruta.length - 1].lng], { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684912.png', iconSize: [32, 32] }) }).addTo(map);
            map.fitBounds(polyline.getBounds(), { padding: [40, 40] });
        }
        function mostrarParadaEnMapa(index, parada) {
            if (!map) {
                console.error("Mapa no inicializado a√∫n.");
                return;
            }
            if (!parada || typeof parada.lat === 'undefined' || typeof parada.lng === 'undefined') {
                console.error("Error: Las coordenadas de la parada no est√°n definidas para el marcador.");
                return;
            }
            if (markerParada) { map.removeLayer(markerParada); markerParada = null; }
            markerParada = L.marker([parada.lat, parada.lng], { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [32, 32] }) }).addTo(map);
            map.setView([parada.lat, parada.lng], 16);
        }
        // Funci√≥n para borrar el icono de parada seleccionada
        function borrarParadaEnMapa() {
            if (markerParada) { map.removeLayer(markerParada); markerParada = null; }
        }
        function enviarGPSaHijo2(origen, destino) {
            const success = sendSecureMessage('hijo2', { 
                tipo: 'navegar-de-a-b', 
                origen: origen, 
                destino: destino 
            });
            if (!success) {
                console.warn("Advertencia: No se pudo enviar GPS a hijo2");
            }
        }

        // ================== FUNCIONES VENTANA FLOTANTE ==================
        
        function mostrarMensajeFlotante(mensaje, loading = false) {
            const ventana = document.getElementById('mensaje-flotante');
            if (ventana) {
                ventana.textContent = mensaje;
                ventana.style.display = 'block';
                
                if (loading) {
                    ventana.classList.add('loading');
                } else {
                    ventana.classList.remove('loading');
                }
                
                console.log(`üí¨ VENTANA FLOTANTE: ${mensaje} ${loading ? '(loading)' : ''}`);
            }
        }
        
        function ocultarMensajeFlotante() {
            const ventana = document.getElementById('mensaje-flotante');
            if (ventana) {
                ventana.style.display = 'none';
                ventana.classList.remove('loading');
                console.log('üí¨ VENTANA FLOTANTE: Ocultada');
            }
        }
    </script>
</body>
</html>
