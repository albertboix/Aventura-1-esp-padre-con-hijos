<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Código Padre (Aventura Interactiva)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Evita el scroll global */
            background-color: #f0f0f0;
        }

        #map {
            height: 100vh;
            width: 100vw;
            z-index: 1; /* Asegura que el mapa esté en el fondo */
        }

        /* Controles generales de la interfaz */
        .main-controls {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 15px;
            padding: 10px 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .main-button {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            background-color: #007bff;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .main-button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .main-button:active {
            transform: translateY(0);
        }

        .main-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Contenedores de iframes */
        iframe {
            box-sizing: border-box; /* Asegura que el borde no aumente el tamaño total */
        }

        /* HIJO 1 (Panel de Paradas) - Posicionado a la derecha */
        #hijo1 {
            position: fixed;
            top: 50%;
            right: 0; /* Alineado a la derecha */
            transform: translateY(-50%);
            height: 80%; /* Altura ajustable */
            width: 280px; /* Ancho ajustable */
            border: 5px solid blue; /* Borde azul para distinguirlo */
            border-radius: 18px 0 0 18px; /* Bordes redondeados solo a la izquierda */
            z-index: 1001; /* Asegura que esté por encima del mapa */
            background: rgba(255, 255, 255, 0.85); /* Fondo semitransparente */
            box-shadow: -6px 0 16px rgba(0,0,0,0.15);
            pointer-events: auto; /* Permite interacciones con el iframe */
        }

        /* HIJO 2 (Botones y Coordenadas) - Posicionado en el centro inferior, encima de Hijo 3 */
        #hijo2 {
            position: fixed; 
            bottom:120px; /* La altura de Hijo 3 es 120px, así que este estará justo encima */
            left:50%; 
            transform:translateX(-50%); 
            height:120px; /* MISMA ALTURA QUE HIJO 3 */
            width:340px; /* MISMO ANCHO QUE HIJO 3 */
            z-index:1001; 
            border:5px solid yellow; /* Borde amarillo para distinguirlo */
            background:rgba(255, 255, 0, 0.5); 
            pointer-events:auto;
        }

        /* HIJO 3 (Reproductor de Audio) - Posicionado en el centro inferior */
        #hijo3 {
            position: fixed;
            bottom: 0; /* Parte inferior de la pantalla */
            left: 50%;
            transform: translateX(-50%);
            height: 120px; /* Altura del trapecio */
            width: 340px; /* Ancho del trapecio */
            z-index: 1001;
            border: 5px solid green; /* Borde verde para distinguirlo */
            background: rgba(0, 255, 0, 0.5); /* Fondo semitransparente verde */
            pointer-events: auto;
        }

        /* Media queries para ajustes de pantalla pequeña */
        @media (max-width: 768px) {
            .main-controls {
                flex-direction: column;
                width: auto;
                top: 10px;
                padding: 8px 15px;
                gap: 8px;
            }

            .main-button {
                padding: 8px 12px;
                font-size: 1em;
            }

            #hijo1 {
                width: 100%;
                height: 50%;
                top: 0;
                left: 0;
                right: auto;
                transform: none;
                border-radius: 0 0 18px 18px;
                box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            }

            #hijo2, #hijo3 {
                width: 90%; /* Ajuste para pantallas más pequeñas */
                max-width: 340px; /* Mantener el ancho máximo si es posible */
                height: 100px; /* Reducir altura en pantallas pequeñas */
                bottom: 10px; /* Un poco más arriba para dejar espacio */
            }

            #hijo2 {
                 bottom: 115px; /* Ajuste para estar encima del Hijo 3 reducido */
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="main-controls">
        <button id="startAdventureBtn" class="main-button">Iniciar Aventura</button>
        <button id="endAdventureBtn" class="main-button" disabled>Finalizar Aventura</button>
        <button id="homeModeBtn" class="main-button">Modo Casa</button>
    </div>

    <iframe id="hijo1" src="Av1-panel-paradas.html"></iframe>

    <iframe id="hijo2" src="Av1-botones-coordenadas.html" 
            style="position:fixed; 
                   bottom:120px; /* La altura de Hijo 3 es 120px, así que este estará justo encima */
                   left:50%; 
                   transform:translateX(-50%); 
                   height:120px; /* MISMA ALTURA QUE HIJO 3 */
                   width:340px; /* MISMO ANCHO QUE HIJO 3 */
                   z-index:1001; 
                   border:5px solid yellow; /* Borde amarillo para distinguirlo */
                   background:rgba(255, 255, 0, 0.5); 
                   pointer-events:auto;"></iframe>

    <iframe id="hijo3" src="Av1_audio_esp.html"></iframe>

    <script>
        const map = L.map('map').setView([39.4702, -0.3768], 15); // Centrado en Valencia
        let userMarker;
        let routePolyline;
        let targetMarker; // Marcador para la parada objetivo

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Definición de las paradas
        const PARADAS = [
            { lat: 39.478046, lng: -0.375515, nombre: "Torres de Serranos", audio: "audio/audio1.mp3" },
            { lat: 39.4795, lng: -0.375, nombre: "Puente de Serranos – Plaza de la crida", audio: "audio/audio2.mp3" },
            { lat: 39.4779, lng: -0.3734, nombre: "Cortes Valencianas (Palacio de los Borgia)", audio: "audio/audio3.mp3" },
            { lat: 39.4764, lng: -0.3756, nombre: "Plaza de la Virgen", audio: "audio/audio4.mp3" },
            { lat: 39.4761, lng: -0.3752, nombre: "Plaza de la Almoína", audio: "audio/audio5.mp3" },
            { lat: 39.4754, lng: -0.3752, nombre: "Catedral de València", audio: "audio/audio6.mp3" },
            { lat: 39.4752, lng: -0.3748, nombre: "Plaza decimo Juno Bruto (Museo Arqueológico de la Almoína)", audio: "audio/audio7.mp3" },
            { lat: 39.4753, lng: -0.3744, nombre: "Basílica de València", audio: "audio/audio8.mp3" },
            { lat: 39.475, lng: -0.3739, nombre: "Palacio Arzobispal", audio: "audio/audio9.mp3" },
            { lat: 39.4705, lng: -0.3764, nombre: "Plaza del Ayuntamiento", audio: "audio/audio10.mp3" },
            { lat: 39.4705, lng: -0.3768, nombre: "Edificio del Ayuntamiento de València", audio: "audio/audio11.mp3" },
            { lat: 39.4697, lng: -0.3768, nombre: "Estación de Ferrocarril (Estación del Norte)", audio: "audio/audio12.mp3" },
            { lat: 39.4697, lng: -0.3758, nombre: "Plaza de Toros de València", audio: "audio/audio13.mp3" },
            { lat: 39.4715, lng: -0.3747, nombre: "Casa estilo Árabe", audio: "audio/audio14.mp3" },
            { lat: 39.4719, lng: -0.3756, nombre: "Palacio de Comunicaciones (Correos)", audio: "audio/audio15.mp3" },
            { lat: 39.4727, lng: -0.3765, nombre: "Antigua sede del Banco de València", audio: "audio/audio16.mp3" },
            { lat: 39.4735, lng: -0.3764, nombre: "Palacio del Marqués de Dos Aguas (Museo Nacional de Crámica)", audio: "audio/audio17.mp3" },
            { lat: 39.4745, lng: -0.3787, nombre: "Mercado Central", audio: "audio/audio18.mp3" },
            { lat: 39.4751, lng: -0.3791, nombre: "San Juan del Mercado (Iglesia de los Santos Juanes)", audio: "audio/audio19.mp3" },
            { lat: 39.4756, lng: -0.3791, nombre: "Lonja de València (Mercado de la Seda)", audio: "audio/audio20.mp3" },
            { lat: 39.4764, lng: -0.3789, nombre: "Plaza del Doctor Collado", audio: "audio/audio21.mp3" },
            { lat: 39.4764, lng: -0.3782, nombre: "Plaza del Negrito (Fuente del Negrito)", audio: "audio/audio22.mp3" },
            { lat: 39.4774, lng: -0.3776, nombre: "Calle Caballeros", audio: "audio/audio23.mp3" },
            { lat: 39.4777, lng: -0.377, nombre: "Palacio de la Generalitat", audio: "audio/audio24.mp3" },
            { lat: 39.4782, lng: -0.3761, nombre: "Calle de los Serranos", audio: "audio/audio25.mp3" }
        ];

        let currentStopIndex = -1; // -1 significa que no hay aventura activa o parada actual
        let isAdventureActive = false;
        let isHomeModeActive = false; // Nuevo estado para el modo casa

        // Referencias a los iframes
        const iframeHijo1 = document.getElementById('hijo1');
        const iframeHijo2 = document.getElementById('hijo2');
        const iframeHijo3 = document.getElementById('hijo3');

        // Referencias a los botones de control principal
        const startAdventureBtn = document.getElementById('startAdventureBtn');
        const endAdventureBtn = document.getElementById('endAdventureBtn');
        const homeModeBtn = document.getElementById('homeModeBtn');

        // Función para enviar mensajes a los iframes
        function sendMessageToIframes(type, payload = {}) {
            if (iframeHijo1.contentWindow) iframeHijo1.contentWindow.postMessage({ type, ...payload }, '*');
            if (iframeHijo2.contentWindow) iframeHijo2.contentWindow.postMessage({ type, ...payload }, '*');
            if (iframeHijo3.contentWindow) iframeHijo3.contentWindow.postMessage({ type, ...payload }, '*');
        }

        // --- Funciones de control de aventura ---
        function startAdventure() {
            isAdventureActive = true;
            isHomeModeActive = false; // Desactiva modo casa
            currentStopIndex = -1; // Reset para iniciar desde la primera parada
            updateMainControls();
            goToNextStop(); // Inicia la aventura en la primera parada
            sendMessageToIframes('activar-modo-aventura');
            sendMessageToIframes('desactivar-reproductor'); // Asegura que el reproductor no se inicie solo
        }

        function endAdventure() {
            isAdventureActive = false;
            currentStopIndex = -1;
            updateMainControls();
            clearMapElements();
            sendMessageToIframes('activar-modo-casa'); // Vuelve a modo casa
            sendMessageToIframes('parar-audio'); // Detiene cualquier audio
        }

        function activateHomeMode() {
            isHomeModeActive = true;
            isAdventureActive = false;
            currentStopIndex = -1; // No hay parada activa en modo casa por GPS
            updateMainControls();
            clearMapElements(); // Limpia marcadores de ruta y usuario
            sendMessageToIframes('activar-modo-casa');
            sendMessageToIframes('parar-audio'); // Asegura que no haya audio reproduciéndose
        }

        function updateMainControls() {
            startAdventureBtn.disabled = isAdventureActive;
            endAdventureBtn.disabled = !isAdventureActive;
            homeModeBtn.disabled = isHomeModeActive;
        }

        function goToNextStop() {
            if (!isAdventureActive) return;

            currentStopIndex++;
            if (currentStopIndex < PARADAS.length) {
                const paradaActual = PARADAS[currentStopIndex];
                sendMessageToIframes('avanzar-parada', { 
                    index: currentStopIndex, 
                    parada: paradaActual 
                });
                // También notifica al Hijo 2 sobre la nueva parada objetivo
                sendMessageToIframes('navegar-de-a-b', { 
                    origen: currentStopIndex > 0 ? currentStopIndex - 1 : null, // Origen es la parada anterior
                    destino: currentStopIndex // Destino es la parada actual
                });
                
                // Centra el mapa en la nueva parada (opcional, si no estás siguiendo el GPS)
                // map.setView([paradaActual.lat, paradaActual.lng], 16); 

                // Muestra la parada actual en el mapa como destino (si el GPS no está activo)
                updateTargetMarker(paradaActual.lat, paradaActual.lng, `Parada ${currentStopIndex + 1}: ${paradaActual.nombre}`);

                // Si el GPS del Hijo 2 está activo, el debería manejar la ruta y la llegada.
                // Si no, podríamos añadir una lógica aquí para "simular" la llegada
            } else {
                alert("¡Aventura finalizada!");
                endAdventure();
            }
        }

        function clearMapElements() {
            if (userMarker) {
                map.removeLayer(userMarker);
                userMarker = null;
            }
            if (routePolyline) {
                map.removeLayer(routePolyline);
                routePolyline = null;
            }
            if (targetMarker) {
                map.removeLayer(targetMarker);
                targetMarker = null;
            }
        }

        function updateTargetMarker(lat, lng, name) {
            if (targetMarker) {
                map.removeLayer(targetMarker);
            }
            targetMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'target-icon',
                    html: `<div style="background-color: orange; border-radius: 50%; width: 25px; height: 25px; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;"></div>`,
                    iconSize: [25, 25],
                    iconAnchor: [12.5, 25]
                })
            }).addTo(map)
              .bindPopup(`<b>Objetivo:</b> ${name}`)
              .openPopup();
        }

        // --- Manejo de mensajes de los Iframes ---
        window.addEventListener('message', (event) => {
            const data = event.data;

            // Mensajes desde Hijo 1 (Panel de Paradas)
            if (data.type === 'seleccionar-parada' && isHomeModeActive) {
                const parada = PARADAS[data.index];
                if (parada) {
                    currentStopIndex = data.index; // Actualiza el índice de la parada activa en modo casa
                    map.setView([parada.lat, parada.lng], 16);
                    updateTargetMarker(parada.lat, parada.lng, `Parada ${data.index + 1}: ${parada.nombre}`);
                    sendMessageToIframes('reproducir-audio', { audioUrl: parada.audio });
                    sendMessageToIframes('activar-todos-botones'); // Para Hijo 2, habilita sus botones de mapa/target
                }
            }

            // Mensajes desde Hijo 2 (Botones y Coordenadas)
            if (data.type === 'actualizarUbicacionMapa' && isAdventureActive) {
                const { lat, lng } = data;
                if (!userMarker) {
                    userMarker = L.marker([lat, lng]).addTo(map);
                } else {
                    userMarker.setLatLng([lat, lng]);
                }
                map.setView([lat, lng], map.getZoom()); // Mantener el mapa centrado en el usuario
            }

            if (data.type === 'mostrarUbicacionObjetivo') {
                const { lat, lng, nombre } = data;
                updateTargetMarker(lat, lng, `Objetivo: ${nombre}`);
            }
            
            if (data.tipo === 'mostrar-mapa-gps') {
                const { ruta, origen, destino } = data;
                clearMapElements(); // Limpia marcadores existentes
                
                // Marcador de Origen
                L.marker([origen.lat, origen.lng], {
                    icon: L.divIcon({
                        className: 'origin-icon',
                        html: `<div style="background-color: blue; border-radius: 50%; width: 20px; height: 20px; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;"></div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 20]
                    })
                }).addTo(map)
                .bindPopup('Tu ubicación actual')
                .openPopup();

                // Marcador de Destino
                L.marker([destino.lat, destino.lng], {
                    icon: L.divIcon({
                        className: 'destination-icon',
                        html: `<div style="background-color: red; border-radius: 50%; width: 20px; height: 20px; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;"></div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 20]
                    })
                }).addTo(map)
                .bindPopup(`Destino: ${destino.nombre}`)
                .openPopup();

                // Dibujar la ruta (esto es una línea recta, para rutas reales necesitarías un servicio de ruteo)
                if (routePolyline) {
                    map.removeLayer(routePolyline);
                }
                routePolyline = L.polyline([[origen.lat, origen.lng], [destino.lat, destino.lng]], { color: 'purple', weight: 5, dashArray: '10, 10' }).addTo(map);

                // Ajustar la vista del mapa para que se vea toda la ruta
                map.fitBounds(routePolyline.getBounds());
            }

            if (data.type === 'ya-estoy-aqui') {
                if (isAdventureActive && data.parada === currentStopIndex) {
                    alert(`¡Hijo 2 dice que has llegado a la Parada ${data.parada + 1}: ${data.info.nombre}!`);
                    // Asegúrate de que el audio de esta parada se reproduzca
                    sendMessageToIframes('reproducir-audio', { audioUrl: PARADAS[data.parada].audio });
                    // Avanza a la siguiente parada automáticamente o espera una acción del usuario
                    // goToNextStop(); // Descomenta si quieres que avance automáticamente
                }
            }

            // Mensajes desde Hijo 3 (Reproductor de Audio)
            if (data.type === 'audio-finalizado') {
                if (isAdventureActive) {
                    // El audio de la parada actual ha terminado, avanzar a la siguiente
                    goToNextStop();
                }
            }
        });

        // --- Inicialización ---
        updateMainControls(); // Establece el estado inicial de los botones
        activateHomeMode(); // Inicia en modo casa
    </script>
</body>
</html>
