<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aventura 1 - Padre (v4.3 Final)</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E🗺️%3C/text%3E%3C/svg%3E">

    <!-- Carga de Leaflet desde CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* Estilos generales, mapa, debug, logo, iframes, etc. */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: transparent; }
        iframe { background: transparent; border: none; }
        #mapa { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; background-color: #f5f5f5; }
        #map-debug { position: fixed; top: 10px; left: 10px; background: rgba(255, 255, 255, 0.9); padding: 5px 8px; border-radius: 5px; z-index: 5000; font-size: 12px; font-family: monospace; display: none; transition: opacity 0.5s; }
        #logo-aventura { position: fixed; top: -13px; left: 50%; transform: translateX(-50%); width: 190px; height: 140px; z-index: 3000; object-fit: contain; }
        #fondo-blanco { position: fixed; top: -24px; left: 50%; transform: translateX(-50%); width: 210px; height: 150px; z-index: 2999; background: white; border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; }
        #info-parada { font-weight: bold; margin: 0; padding: 7px 12px; background-color: rgba(255, 255, 255, 0.9); border-radius: 7px; position: fixed; left: 50%; transform: translateX(-50%); z-index: 1201; display: none; color: #333; font-family: sans-serif; text-align: center; bottom: 325px; min-width: 220px; max-width: 90vw; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10); }
        #hijo4 { position: fixed; top: 10vh; left: 50%; width: 60vw; height: 40vh; transform: translateX(-50%); z-index: 2000; border: 2px solid red; background: transparent; pointer-events: auto; display: none; }
        #media-overlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.8); z-index: 4000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #media-container { max-width: 90%; max-height: 90%; display: flex; flex-direction: column; align-items: center; position: relative; }
        #close-media { position: absolute; top: 10px; right: 10px; background: #ff5252; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.2em; cursor: pointer; z-index: 4001; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #parada-video, #parada-imagen { max-width: 100%; max-height: calc(100vh - 80px); display: none; border-radius: 5px; }
    </style>
</head>
<body>
    <!-- Contenedores de la UI -->
    <div id="mapa"></div>
    <div id="map-debug"></div>
    <iframe id="fondo-blanco" tabindex="-1" aria-hidden="true"></iframe>
    <img id="logo-aventura" src="proyecto valenciavguides/fotos_Av1/LOGO LETRAS FINAL transparente recorte.png" alt="Logo" />
    <div id="info-parada"></div>

    <!-- IFrames de los Hijos -->
    <iframe id="hijo1-hamburguesa" src="proyecto valenciavguides/botones-y-subfunciones-hamburguesa.html" style="position:fixed; left:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; pointer-events:auto;"></iframe>
    <iframe id="hijo1-opciones" src="proyecto valenciavguides/botones-y-subfunciones-opciones.html" style="position:fixed; right:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; pointer-events:auto;"></iframe>
    <iframe id="hijo5-casa" src="proyecto valenciavguides/Av1-boton-casa.html" style="position:fixed; left:10px; top:10px; height:350px; width:100px; z-index:1005; pointer-events:auto; transition:width 0.3s;"></iframe>
    <iframe id="hijo3" src="proyecto valenciavguides/Av1_audio_esp.html" style="position:fixed; bottom:-6px; left:50%; transform:translateX(-50%); height:165px; width:310px; z-index:1000; display:block; pointer-events:auto;"></iframe>
    <iframe id="hijo2" src="proyecto valenciavguides/Av1-botones-coordenadas.html" style="position:fixed; bottom:151px; left:50%; transform:translateX(-50%); height:165px; width:310px; z-index:1001; pointer-events:auto;" allow="geolocation"></iframe>
    <iframe id="hijo4" src="proyecto valenciavguides/Av1-esp-retos-preguntas.html"></iframe>

    <!-- Overlay para Media -->
    <div id="media-overlay">
        <div id="media-container">
            <button id="close-media">X</button>
            <video id="parada-video" controls></video>
            <img id="parada-imagen">
        </div>
    </div>

    <!-- SCRIPT PRINCIPAL UNIFICADO DE LA APLICACIÓN -->
    <script type="module">
        // 1. IMPORTACIONES Y CONFIGURACIÓN
        import { TIPOS_MENSAJE, inicializarMensajeria, registrarControlador, enviarMensaje } from './proyecto valenciavguides/js/mensajeria.js';
        import { inicializarMapa } from './proyecto valenciavguides/js/funciones-mapa.js';

        const CONFIG = {
            ID_PADRE: 'padre',
            HIJOS: {
                HAMBURGUESA: { id: 'hijo1-hamburguesa', nombre: 'Hamburguesa' },
                OPCIONES:    { id: 'hijo1-opciones',    nombre: 'Opciones' },
                COORDENADAS: { id: 'hijo2',             nombre: 'Coordenadas' },
                AUDIO:       { id: 'hijo3',             nombre: 'Audio' },
                RETOS:       { id: 'hijo4',             nombre: 'Retos' },
                CASA:        { id: 'hijo5-casa',        nombre: 'Casa' }
            },
            LOG_LEVEL: 'info'
        };

        const MAP_CONFIG = {
            center: [39.4699, -0.3763], zoom: 14, minZoom: 12, maxZoom: 18, zoomControl: false
        };

        // 2. ESTADO CENTRAL DE LA APLICACIÓN
        const estadoApp = {
            modo: { actual: 'casa', anterior: null },
            paradaActual: 0,
            mensajeriaInicializada: false,
            mapaInicializado: false,
            hijosInicializados: new Set(),
        };
        window.estadoApp = estadoApp;

        // 3. DATOS DE LA AVENTURA
        const AVENTURA_PARADAS = [
            { padreid: "padre-P-0", tipo: "inicio", parada_id: 'P-0', audio_id: "audio-P-0", reto_id: "R-2" },
            { padreid: "padre-TR-1", tipo: "tramo", tramo_id: 'TR-1', audio_id: "audio-TR-1" },
            { padreid: "padre-P-1", tipo: "parada", parada_id: 'P-1', audio_id: "audio-P-1", reto_id: "R-3" },
            { padreid: "padre-TR-2", tipo: "tramo", tramo_id: 'TR-2', audio_id: "audio-TR-2" },
            { padreid: "padre-P-2", tipo: "parada", parada_id: 'P-2', audio_id: "audio-P-2", reto_id: "R-4" },
            { padreid: "padre-TR-3", tipo: "tramo", tramo_id: 'TR-3', audio_id: "audio-TR-3" },
            { padreid: "padre-P-3", tipo: "parada", parada_id: 'P-3', audio_id: "audio-P-3", reto_id: "R-5" },
            { padreid: "padre-TR-4", tipo: "tramo", tramo_id: 'TR-4', audio_id: "audio-TR-4" },
            { padreid: "padre-P-4", tipo: "parada", parada_id: 'P-4', audio_id: "audio-P-4", reto_id: "R-6" },
            { padreid: "padre-P-5", tipo: "parada", parada_id: 'P-5', audio_id: "audio-P-5", retos: [{ tipo: "reto", id: "R-7" },{ tipo: "puzzle", id: "PZ-8" }] },
            { padreid: "padre-TR-5", tipo: "tramo", tramo_id: 'TR-5', audio_id: "audio-TR-5" },
            { padreid: "padre-P-6", tipo: "parada", parada_id: 'P-6', audio_id: "audio-P-6", reto_id: "R-9" },
            { padreid: "padre-P-7", tipo: "parada", parada_id: 'P-7', audio_id: "audio-P-7", reto_id: "R-10" },
            { padreid: "padre-P-8", tipo: "parada", parada_id: 'P-8', audio_id: "audio-P-8", reto_id: "R-11" },
            { padreid: "padre-P-9", tipo: "parada", parada_id: 'P-9', audio_id: "audio-P-9" },
            { padreid: "padre-P-10", tipo: "parada", parada_id: 'P-10', audio_id: "audio-P-10", reto_id: "R-12"  },
            { padreid: "padre-TR-6", tipo: "tramo", tramo_id: 'TR-6', audio_id: "audio-TR-6" },
            { padreid: "padre-P-11", tipo: "parada", parada_id: 'P-11', audio_id: "audio-P-11", reto_id: "R-13" },
            { padreid: "padre-P-12", tipo: "parada", parada_id: 'P-12', audio_id: "audio-P-12" },
            { padreid: "padre-P-13", tipo: "parada", parada_id: 'P-13', audio_id: "audio-P-13", reto_id: "R-14" },
            { padreid: "padre-TR-7", tipo: "tramo", tramo_id: 'TR-7', audio_id: "audio-TR-7" },
            { padreid: "padre-P-14", tipo: "parada", parada_id: 'P-14', audio_id: "audio-P-14", reto_id: "R-15" },
            { padreid: "padre-P-15", tipo: "parada", parada_id: 'P-15', audio_id: "audio-P-15" },
            { padreid: "padre-TR-8", tipo: "tramo", tramo_id: 'TR-8', audio_id: "audio-TR-8" },
            { padreid: "padre-P-16", tipo: "parada", parada_id: 'P-16', audio_id: "audio-P-16" },
            { padreid: "padre-TR-9", tipo: "tramo", tramo_id: 'TR-9', audio_id: "audio-TR-9" },
            { padreid: "padre-P-17", tipo: "parada", parada_id: 'P-17', audio_id: "audio-P-17", reto_id: "R-16" },
            { padreid: "padre-P-18", tipo: "parada", parada_id: 'P-18', audio_id: "audio-P-18" },
            { padreid: "padre-TR-10", tipo: "tramo", tramo_id: 'TR-10', audio_id: "audio-TR-10" },
            { padreid: "padre-P-19", tipo: "parada", parada_id: 'P-19', audio_id: "audio-P-19", retos: [{ tipo: "reto", id: "R-17" },{ tipo: "puzzle", id: "PZ-18" }] },
            { padreid: "padre-TR-11", tipo: "tramo", tramo_id: 'TR-11', audio_id: "audio-TR-11" },
            { padreid: "padre-TR-12", tipo: "tramo", tramo_id: 'TR-12', audio_id: "audio-TR-12" },
            { padreid: "padre-P-20", tipo: "parada", parada_id: 'P-20', audio_id: "audio-P-20", reto_id: "R-19" },
            { padreid: "padre-P-21", tipo: "parada", parada_id: 'P-21', audio_id: "audio-P-21" },
            { padreid: "padre-TR-13", tipo: "tramo", tramo_id: 'TR-13', audio_id: "audio-TR-13" },
            { padreid: "padre-P-22", tipo: "parada", parada_id: 'P-22', audio_id: "audio-P-22", retos: ["R-20", "R-21"] },
            { padreid: "padre-P-23", tipo: "parada", parada_id: 'P-23', audio_id: "audio-P-23", reto_id: "R-21" },
            { padreid: "padre-TR-14", tipo: "tramo", tramo_id: 'TR-14', audio_id: "audio-TR-14" },
            { padreid: "padre-P-24", tipo: "parada", parada_id: 'P-24', audio_id: "audio-P-24", reto_id: "R-22" },
            { padreid: "padre-TR-15", tipo: "tramo", tramo_id: 'TR-15', audio_id: "audio-TR-15" },
            { padreid: "padre-P-25", tipo: "parada", parada_id: 'P-25', audio_id: "audio-P-25" },
            { padreid: "padre-TR-16", tipo: "tramo", tramo_id: 'TR-16', audio_id: "audio-TR-16" },
            { padreid: "padre-P-26", tipo: "parada", parada_id: 'P-26', audio_id: "audio-P-26", reto_id: "R-23" },
            { padreid: "padre-TR-17", tipo: "tramo", tramo_id: 'TR-17', audio_id: "audio-TR-17" },
            { padreid: "padre-P-27", tipo: "parada", parada_id: 'P-27', audio_id: "audio-P-27", reto_id: "R-24" },
            { padreid: "padre-P-28", tipo: "parada", parada_id: 'P-28', audio_id: "audio-P-28", reto_id: "R-25" },
            { padreid: "padre-TR-18", tipo: "tramo", tramo_id: 'TR-18', audio_id: "audio-TR-18" },
            { padreid: "padre-P-29", tipo: "parada", parada_id: 'P-29', audio_id: "audio-P-29", reto_id: "R-27" },
            { padreid: "padre-P-30", tipo: "parada", parada_id: 'P-30', audio_id: "audio-P-30", reto_id: "R-28" },
            { padreid: "padre-TR-19", tipo: "tramo", tramo_id: 'TR-19', audio_id: "audio-TR-19" },
            { padreid: "padre-P-31", tipo: "parada", parada_id: 'P-31', audio_id: "audio-P-31", reto_id: "R-29" },
            { padreid: "padre-P-32", tipo: "parada", parada_id: 'P-32', audio_id: "audio-P-32", reto_id: "R-30" },
            { padreid: "padre-P-33", tipo: "parada", parada_id: 'P-33', audio_id: "audio-P-33", retos: [ { tipo: "reto", id: "R-31" }, { tipo: "puzzle", id: "PZ-26" } ] },
            { padreid: "padre-TR-20", tipo: "tramo", tramo_id: 'TR-20', audio_id: "audio-TR-20" },
            { padreid: "padre-TR-21", tipo: "tramo", tramo_id: 'TR-21', audio_id: "audio-TR-21" },
            { padreid: "padre-P-34", tipo: "parada", parada_id: 'P-34', audio_id: "audio-P-34", reto_id: "R-32" },
            { padreid: "padre-TR-22", tipo: "tramo", tramo_id: 'TR-22', audio_id: "audio-TR-22" },
            { padreid: "padre-P-35", tipo: "parada", parada_id: 'P-35', audio_id: "audio-P-35" },
            { padreid: "padre-TR-23", tipo: "tramo", tramo_id: 'TR-23', audio_id: "audio-TR-23" },
            { padreid: "padre-P-36", tipo: "parada", parada_id: 'P-36', audio_id: "audio-P-36" }
        ];

        // 4. LÓGICA DE ARRANQUE
        document.addEventListener('DOMContentLoaded', async () => {
            console.log(`[${CONFIG.ID_PADRE}] DOM cargado. Iniciando aplicación...`);
            updateMapDebug('DOM Cargado. Iniciando...');
            try {
                await inicializarSistemaMensajeria();
                updateMapDebug('Mensajería OK.');
                registrarControladoresTotales();
                await iniciarSistemaMapa();
                updateMapDebug('Mapa OK.');
                await notificarInicializacionAHijos();
                console.log(`[${CONFIG.ID_PADRE}] ===== INICIALIZACIÓN COMPLETADA =====`);
                updateMapDebug('Sistema listo.', 3000);
            } catch (error) {
                console.error(`[${CONFIG.ID_PADRE}] ERROR FATAL DE INICIALIZACIÓN:`, error);
                updateMapDebug(`Error fatal: ${error.message}`);
            }
        });

        // 5. FUNCIONES PRINCIPALES
        async function inicializarSistemaMensajeria() {
            if (estadoApp.mensajeriaInicializada) return;
            await inicializarMensajeria({ iframeId: CONFIG.ID_PADRE, logLevel: CONFIG.LOG_LEVEL });
            estadoApp.mensajeriaInicializada = true;
            console.log(`[${CONFIG.ID_PADRE}] Sistema de mensajería inicializado.`);
        }

        async function iniciarSistemaMapa() {
            if (typeof L === 'undefined') throw new Error('Leaflet no está disponible.');
            if (estadoApp.mapaInicializado) return;
            const mapaInstance = await inicializarMapa({ arrayParadas: AVENTURA_PARADAS, containerId: 'mapa', ...MAP_CONFIG });
            if (!mapaInstance) throw new Error('inicializarMapa no devolvió una instancia del mapa.');
            window.mapa = mapaInstance;
            estadoApp.mapaInicializado = true;
            console.log(`[${CONFIG.ID_PADRE}] Mapa inicializado.`);
            setTimeout(() => window.mapa.invalidateSize(), 100);
            window.addEventListener('resize', () => setTimeout(() => window.mapa?.invalidateSize(), 100));
        }

        async function notificarInicializacionAHijos() {
            console.log(`[${CONFIG.ID_PADRE}] Notificando inicialización a los hijos...`);
            const promesas = Object.values(CONFIG.HIJOS).map(hijo =>
                enviarMensaje(hijo.id, TIPOS_MENSAJE.SISTEMA.INICIALIZACION, {
                    padre: CONFIG.ID_PADRE,
                    modo: estadoApp.modo.actual,
                    paradaActual: estadoApp.paradaActual,
                    aventuraParadas: AVENTURA_PARADAS
                }).catch(err => console.warn(`[${CONFIG.ID_PADRE}] No se pudo notificar a ${hijo.nombre}:`, err.message))
            );
            await Promise.allSettled(promesas);
            console.log(`[${CONFIG.ID_PADRE}] Notificación a hijos completada.`);
        }

        // 6. REGISTRO DE CONTROLADORES DE MENSAJES
        function registrarControladoresTotales() {
            const controladores = {
                [TIPOS_MENSAJE.SISTEMA.ERROR]: manejarErrorSistema,
                [TIPOS_MENSAJE.SISTEMA.INICIALIZACION_COMPLETADA]: manejarHijoInicializado,
                [TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO]: manejarCambioModo,
                [TIPOS_MENSAJE.DATOS.SOLICITAR_PARADAS]: manejarSolicitudArrayParadas,
                [TIPOS_MENSAJE.NAVEGACION.CAMBIO_PARADA]: manejarCambioParada,
                [TIPOS_MENSAJE.AUDIO.FINALIZADO]: manejarAudioFinalizado,
                [TIPOS_MENSAJE.RETO.MOSTRAR]: manejarMostrarReto,
                [TIPOS_MENSAJE.RETO.OCULTAR]: manejarOcultarReto,
                [TIPOS_MENSAJE.RETO.COMPLETADO]: manejarRetoCompletado,
            };
            for (const tipo in controladores) {
                registrarControlador(tipo, controladores[tipo]);
            }
            console.log(`[${CONFIG.ID_PADRE}] Controladores de mensajes registrados.`);
        }

        // 7. IMPLEMENTACIÓN DE MANEJADORES
        function manejarErrorSistema(msg) { console.error(`[${CONFIG.ID_PADRE}] Error de ${msg.origen}:`, msg.datos); updateMapDebug(`Error de ${msg.origen}: ${msg.datos?.mensaje || 'Desconocido'}`); }
        function manejarHijoInicializado(msg) { console.log(`[${CONFIG.ID_PADRE}] Hijo ${msg.origen} inicializado.`); estadoApp.hijosInicializados.add(msg.origen); }
        function manejarSolicitudArrayParadas(msg) { console.log(`[${CONFIG.ID_PADRE}] ${msg.origen} solicita array de paradas.`); return { exito: true, paradas: AVENTURA_PARADAS }; }
        async function manejarCambioModo(msg) {
            const { modo } = msg.datos;
            if (modo === estadoApp.modo.actual) return { exito: true, mensaje: "Ya en este modo." };
            console.log(`[${CONFIG.ID_PADRE}] Cambiando a modo: ${modo}.`);
            estadoApp.modo.anterior = estadoApp.modo.actual;
            estadoApp.modo.actual = modo;
            const promesas = Object.values(CONFIG.HIJOS).map(h => enviarMensaje(h.id, TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, { modo }));
            await Promise.allSettled(promesas);
            return { exito: true, modoCambiado: modo };
        }
        function manejarCambioParada(msg) {
            const idx = parseInt(msg.datos?.parada);
            if (!isNaN(idx) && idx >= 0 && idx < AVENTURA_PARADAS.length) {
                estadoApp.paradaActual = idx;
                console.log(`[${CONFIG.ID_PADRE}] Cambiando a parada índice: ${idx}`);
            }
        }
        function manejarAudioFinalizado(msg) { console.log(`[${CONFIG.ID_PADRE}] Audio finalizado reportado por ${msg.origen}.`); }
        function manejarRetoCompletado(msg) { console.log(`[${CONFIG.ID_PADRE}] Reto ${msg.datos.retoId} completado.`); manejarOcultarReto(); }
        function manejarMostrarReto() { document.getElementById('hijo4').style.display = 'block'; return { exito: true }; }
        function manejarOcultarReto() { document.getElementById('hijo4').style.display = 'none'; return { exito: true }; }

        // 8. FUNCIONES AUXILIARES
        function updateMapDebug(status, hideAfter = 0) {
            const el = document.getElementById('map-debug');
            if (el) {
                el.style.display = 'block';
                el.style.opacity = '1';
                el.textContent = `Estado: ${status}`;
                if (hideAfter > 0) {
                    setTimeout(() => {
                        el.style.opacity = '0';
                        setTimeout(() => el.style.display = 'none', 500);
                    }, hideAfter);
                }
            }
        }
    </script>
</body>
</html>
