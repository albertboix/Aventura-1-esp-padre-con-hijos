<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Padre - Coordinador Central</title>
    <!-- Estilos CSS para el mapa -->
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #mapa {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        .leaflet-container {
            background: #f8f9fa;
        }
    </style>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tC8quh7qG8H+2g2jC9SM="
          crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <!-- Estilos CSS para el mapa -->
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #mapa {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        .leaflet-container {
            background: #f8f9fa;
        }
    </style>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tC8quh7qG8H+2g2jC9SM="
          crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
</head>
<body>
    <!-- Contenedor del mapa -->
    <div id="mapa"></div>

    <!-- Script principal -->
    <script type="module">
        // ================== IMPORTACI√ìN CENTRALIZADA ==================
        import Mensajeria from './mensajeria.js';
        // Eliminar importaci√≥n incorrecta - el padre contiene toda la l√≥gica
        
        // ================== CONFIGURACI√ìN GLOBAL ==================
        const CONFIG = {
            iframeId: 'padre',
            debug: true,
            logLevel: 1
        };

        // ================== ESTADO GLOBAL CENTRALIZADO ==================
        const estadoGlobal = {
            modo: 'casa',
            gpsActivo: false,
            paradaActual: 0,
            tramoActual: 0,
            hijosListos: new Set(),
            mapa: null,
            audioReproduciendo: false,
            retoActivo: null,
            inicializado: false
        };

        // Lista de hijos conocidos
        const HIJOS_SISTEMA = [
            'Av1_audio_esp',
            'Av1-botones-coordenadas',
            'Av1-esp-retos-preguntas',
            'Av1-boton-casa'
        ];

        // ================== INICIALIZACI√É∆í√¢‚Ç¨≈ìN CENTRALIZADA ==================
        async function inicializar() {
            try {
                console.log('√É¬∞√Ö¬∏√Ö¬Ω√Ç¬Ø Inicializando sistema padre centralizado...');

                // Inicializar mensajer√É∆í√Ç¬≠a centralizada
                await Mensajeria.inicializarMensajeria(CONFIG);

                // Registrar manejadores centralizados
                registrarManejadores();

                // Inicializar mapa si est√É∆í√Ç¬° disponible
                if (typeof inicializarMapa === 'function') {
                    inicializarMapa();
                }

                estadoGlobal.inicializado = true;

                console.log('√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Sistema padre inicializado correctamente');

            } catch (error) {
                console.error('√É¬¢√Ç¬ù√Ö‚Äô Error en inicializaci√É∆í√Ç¬≥n del padre:', error);
                mostrarErrorEnInterfaz('Error cr√É∆í√Ç¬≠tico en la inicializaci√É∆í√Ç¬≥n del sistema');
            }
        }

        // ================== FUNCI√ìN PARA OBTENER DATOS DE UNA PARADA ==================
        function obtenerDatosParada(paradaId) {
            console.log(`Obteniendo datos para parada: ${paradaId}`);
            
            // Buscar la parada en el array AVENTURA_PARADAS
            const parada = AVENTURA_PARADAS.find(p => p.parada_id === paradaId);
            
            if (!parada) {
                console.warn(`No se encontr√≥ la parada ${paradaId}`);
                return null;
            }
            
            // Obtener coordenadas de la parada
            let coordenadas = null;
            if (COORDENADAS_PARADAS && COORDENADAS_PARADAS.get) {
                coordenadas = COORDENADAS_PARADAS.get(paradaId);
            }
            
            // Construir objeto de datos de la parada
            const datosParada = {
                id: paradaId,
                tipo: parada.tipo || 'parada',
                nombre: `Parada ${paradaId}`,
                descripcion: `Descripci√≥n de la parada ${paradaId}`,
                coordenadas: coordenadas,
                audio: parada.audio_id ? `audios/${parada.audio_id}.mp3` : null,
                reto: parada.reto_id ? { id: parada.reto_id, completado: false } : null,
                propiedadesAdicionales: {
                    visitada: false,
                    timestamp: Date.now()
                }
            };
            
            console.log(`Datos generados para parada ${paradaId}:`, datosParada);
            return datosParada;
        }
        
        // ================== MANEJADOR DE SOLICITUDES DE DATOS ==================
        function manejarSolicitudDatos(mensaje) {
            try {
                const { tipo, datos, origen } = mensaje;
                console.log(`Solicitud de datos recibida de ${origen}:`, tipo, datos);
                
                if (tipo === TIPOS_MENSAJE.DATOS.SOLICITAR_PARADA) {
                    const { paradaId } = datos;
                    const datosParada = obtenerDatosParada(paradaId);
                    
                    if (datosParada) {
                        return { 
                            exito: true, 
                            datos: datosParada 
                        };
                    } else {
                        return { 
                            exito: false, 
                            error: `No se encontr√≥ la parada ${paradaId}` 
                        };
                    }
                }
                
                return { exito: false, error: 'Tipo de solicitud no reconocido' };
                
            } catch (error) {
                console.error('Error manejando solicitud de datos:', error);
                return { 
                    exito: false, 
                    error: error.message 
                };
            }
        }
        
        // ================== REGISTRO DE MANEJADORES CENTRALIZADOS ==================
        function registrarManejadores() {
            // Registrar manejador para solicitudes de datos
            Mensajeria.registrarControlador(TIPOS_MENSAJE.DATOS.SOLICITAR_PARADA, manejarSolicitudDatos);
            // Manejador de hijos listos
            Mensajeria.registrarControlador(TIPOS_MENSAJE.SISTEMA.LISTO, manejarHijoListo);
            
            // Manejadores de sistema
            Mensajeria.registrarControlador(TIPOS_MENSAJE.SISTEMA.ERROR, manejarErrorDeHijo);
            Mensajeria.registrarControlador(TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, manejarCambioModoGlobal);
            
            // Manejadores de navegaci√É∆í√Ç¬≥n
            Mensajeria.registrarControlador(TIPOS_MENSAJE.NAVEGACION.CAMBIO_PARADA, manejarCambioParada);
            Mensajeria.registrarControlador(TIPOS_MENSAJE.NAVEGACION.LLEGADA_DETECTADA, manejarLlegadaDestino);
            Mensajeria.registrarControlador(TIPOS_MENSAJE.NAVEGACION.SOLICITAR_DESTINO, manejarSolicitudDestino);
            
            // Manejadores de audio
            Mensajeria.registrarControlador(TIPOS_MENSAJE.AUDIO.FINALIZADO, manejarAudioFinalizado);
            Mensajeria.registrarControlador(TIPOS_MENSAJE.AUDIO.ESTADO, manejarEstadoAudio);
            
            // Manejadores de retos
            Mensajeria.registrarControlador(TIPOS_MENSAJE.RETOS.COMPLETADO, manejarRetoCompletado);
            Mensajeria.registrarControlador(TIPOS_MENSAJE.RETOS.ABRIR, manejarAbrirReto);
            
            // Manejadores de GPS
            Mensajeria.registrarControlador(TIPOS_MENSAJE.GPS.ESTADO, manejarEstadoGPS);

            console.log('√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Manejadores centralizados registrados en el padre');
        }

        // ================== MANEJADORES CENTRALIZADOS ==================
        async function manejarHijoListo(mensaje) {
            try {
                const { componente, capacidades } = mensaje.datos || {};
                
                estadoGlobal.hijosListos.add(mensaje.origen);
                console.log(`√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Hijo listo: ${mensaje.origen} (${componente})`);

                // Si todos los hijos est√É∆í√Ç¬°n listos, sincronizar estado
                if (estadoGlobal.hijosListos.size >= HIJOS_SISTEMA.length) {
                    await sincronizarEstadoGlobal();
                }

                return { estado: 'ok', hijosListos: estadoGlobal.hijosListos.size };

            } catch (error) {
                console.error('√É¬¢√Ç¬ù√Ö‚Äô Error manejando hijo listo:', error);
                throw error;
            }
        }

        async function manejarCambioParada(mensaje) {
            try {
                const { parada } = mensaje.datos || {};
                
                console.log(`√É¬∞√Ö¬∏√Ö¬°√Ç¬© Cambio de parada: ${estadoGlobal.paradaActual} √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ ${parada}`);
                
                estadoGlobal.paradaActual = parada;

                // Notificar a todos los hijos usando mensajer√É∆í√Ç¬≠a centralizada
                await Mensajeria.enviarMensajeATodos(TIPOS_MENSAJE.NAVEGACION.CAMBIO_PARADA, { parada });

                // Reproducir audio correspondiente
                await Mensajeria.enviarMensaje('Av1_audio_esp', TIPOS_MENSAJE.AUDIO.REPRODUCIR, {
                    archivo: `audio-P-${parada}`,
                    parada
                });

                return { estado: 'ok', paradaActual: parada };

            } catch (error) {
                console.error('√É¬¢√Ç¬ù√Ö‚Äô Error en cambio de parada:', error);
                throw error;
            }
        }

        async function manejarAudioFinalizado(mensaje) {
            try {
                const { archivo, parada } = mensaje.datos || {};
                
                console.log('√É¬∞√Ö¬∏√Ö¬Ω√Ç¬µ Audio finalizado:', archivo);
                estadoGlobal.audioReproduciendo = false;

                // Habilitar controles usando mensajer√É∆í√Ç¬≠a centralizada
                await Mensajeria.habilitarControles(estadoGlobal.modo);

                return { estado: 'ok' };

            } catch (error) {
                console.error('√É¬¢√Ç¬ù√Ö‚Äô Error manejando audio finalizado:', error);
                throw error;
            }
        }

        async function manejarLlegadaDestino(mensaje) {
            try {
                const { parada, coordenadas } = mensaje.datos || {};
                
                console.log('√É¬∞√Ö¬∏√Ö¬Ω√Ç¬Ø Llegada a destino detectada:', parada);

                // Secuencia coordinada usando mensajer√É∆í√Ç¬≠a centralizada
                
                // 1. Deshabilitar navegaci√É∆í√Ç¬≥n temporalmente
                await Mensajeria.deshabilitarControles('llegada_destino');
                
                // 2. Reproducir audio de llegada
                await Mensajeria.enviarMensaje('Av1_audio_esp', TIPOS_MENSAJE.AUDIO.REPRODUCIR, {
                    archivo: `audio-llegada-P-${parada}`,
                    parada
                });

                // 3. Preparar reto si existe
                const retoData = obtenerRetoParaParada(parada);
                if (retoData) {
                    estadoGlobal.retoActivo = retoData;
                }

                return { estado: 'ok', parada, retoPreparado: !!retoData };

            } catch (error) {
                console.error('√É¬¢√Ç¬ù√Ö‚Äô Error manejando llegada:', error);
                throw error;
            }
        }

        async function manejarRetoCompletado(mensaje) {
            try {
                const { retoId, parada, exito } = mensaje.datos || {};
                
                console.log('√É¬∞√Ö¬∏√Ç¬è√¢‚Ç¨¬† Reto completado:', retoId, exito ? '√É∆í√¢‚Ç¨¬∞XITO' : 'FALLO');

                if (exito) {
                    // Reproducir audio de felicitaci√É∆í√Ç¬≥n
                    await Mensajeria.enviarMensaje('Av1_audio_esp', TIPOS_MENSAJE.AUDIO.REPRODUCIR, {
                        archivo: 'felicitacion.mp3'
                    });
                }

                // Habilitar navegaci√É∆í√Ç¬≥n nuevamente
                await Mensajeria.habilitarControles(estadoGlobal.modo);

                estadoGlobal.retoActivo = null;

                return { estado: 'ok', retoCompletado: true };

            } catch (error) {
                console.error('√É¬¢√Ç¬ù√Ö‚Äô Error procesando reto completado:', error);
                throw error;
            }
        }

        async function manejarCambioModoGlobal(mensaje) {
            try {
                const { modo } = mensaje.datos || {};
                
                console.log(`√É¬∞√Ö¬∏√¢‚Ç¨¬ù√¢‚Ç¨≈æ Cambio de modo global: ${estadoGlobal.modo} √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ ${modo}`);
                
                estadoGlobal.modo = modo;

                // Propagar cambio a todos los hijos
                await Mensajeria.enviarMensajeATodos(TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, { modo });

                return { estado: 'ok', modoAnterior: estadoGlobal.modo, modoNuevo: modo };

            } catch (error) {
                console.error('√É¬¢√Ç¬ù√Ö‚Äô Error en cambio de modo global:', error);
                throw error;
            }
        }

        async function manejarErrorDeHijo(mensaje) {
            try {
                const { tipo, error, componente } = mensaje.datos || {};
                
                console.error(`√É¬¢√Ç¬ù√Ö‚Äô Error reportado por ${mensaje.origen} (${componente}):`, error);
                
                // Decidir acci√É∆í√Ç¬≥n basada en el tipo de error
                if (tipo === 'error_critico') {
                    await manejarErrorCritico(mensaje.origen, error);
                }

                return { estado: 'ok', errorProcesado: true };

            } catch (error) {
                console.error('√É¬¢√Ç¬ù√Ö‚Äô Error manejando error de hijo:', error);
                throw error;
            }
        }

        async function manejarSolicitudDestino(mensaje) {
            try {
                const { paradaActual: paradaActualHijo } = mensaje.datos || {};
                
                // El padre decide cu√°l es la pr√≥xima parada
                const proximaParada = estadoGlobal.paradaActual + 1;
                const paradaId = `P-${proximaParada}`;
                
                console.log(`üéØ Padre: Solicitud de destino de ${mensaje.origen}, enviando parada ${paradaId}`);
                
                // Enviar datos completos de la parada
                await enviarDatosParadaAHijo(mensaje.origen, paradaId);
                
                return { estado: 'ok', paradaEnviada: paradaId };

            } catch (error) {
                console.error('‚ùå Padre: Error manejando solicitud de destino:', error);
                throw error;
            }
        }

        async function manejarSolicitudReto(mensaje) {
            try {
                const { paradaId } = mensaje.datos || {};
                
                if (!paradaId) {
                    throw new Error('ID de parada no proporcionado');
                }
                
                console.log(`üéØ Padre: Solicitud de reto para ${paradaId} de ${mensaje.origen}`);
                
                // Enviar reto si existe
                const retoEnviado = await enviarRetoAHijo(mensaje.origen, paradaId);
                
                return { estado: 'ok', retoEnviado };

            } catch (error) {
                console.error('‚ùå Padre: Error manejando solicitud de reto:', error);
                throw error;
            }
        }

        // ================== FUNCIONES DE DATOS DEL MAPA (PADRE COMO FUENTE √öNICA) ==================
        
        /**
         * Obtiene datos del reto asociado a una parada
         * El padre es la √∫nica fuente de verdad para esta informaci√≥n
         */
        function obtenerRetoParaParada(paradaId) {
            try {
                console.log(`üéØ Padre: Obteniendo reto para parada ${paradaId}`);
                
                // Buscar la parada en los datos del padre
                const parada = AVENTURA_PARADAS.find(p => p.parada_id === paradaId);
                
                if (!parada) {
                    console.warn(`‚ö†Ô∏è Padre: Parada ${paradaId} no encontrada`);
                    return null;
                }
                
                // Si la parada tiene un reto simple
                if (parada.reto_id) {
                    return {
                        id: parada.reto_id,
                        paradaId: paradaId,
                        tipo: 'reto',
                        titulo: `Reto ${parada.reto_id.replace('R-', '')}`,
                        descripcion: `Completa el reto en la parada ${paradaId}`,
                        puntos: 10,
                        completado: false,
                        origen: 'padre'
                    };
                }
                
                // Si la parada tiene m√∫ltiples retos
                if (parada.retos && parada.retos.length > 0) {
                    return {
                        id: parada.retos[0].id,
                        paradaId: paradaId,
                        tipo: parada.retos[0].tipo,
                        titulo: `${parada.retos[0].tipo} ${parada.retos[0].id.replace(/[A-Z]+-/, '')}`,
                        descripcion: `Completa el ${parada.retos[0].tipo} en la parada ${paradaId}`,
                        puntos: parada.retos[0].tipo === 'puzzle' ? 15 : 10,
                        completado: false,
                        retosAdicionales: parada.retos.slice(1),
                        origen: 'padre'
                    };
                }
                
                // No hay reto en esta parada
                console.log(`‚ÑπÔ∏è Padre: No hay reto en parada ${paradaId}`);
                return null;
                
            } catch (error) {
                console.error('‚ùå Padre: Error obteniendo reto para parada:', error);
                return null;
            }
        }

        /**
         * Obtiene todos los datos de una parada espec√≠fica
         * El padre centraliza toda esta informaci√≥n
         */
        function obtenerDatosParada(paradaId) {
            try {
                console.log(`üìç Padre: Obteniendo datos para parada ${paradaId}`);
                
                // Buscar la parada en los datos del padre
                const parada = AVENTURA_PARADAS.find(p => p.parada_id === paradaId);
                
                if (!parada) {
                    console.warn(`‚ö†Ô∏è Padre: Parada ${paradaId} no encontrada`);
                    return null;
                }
                
                // Obtener coordenadas del mapa del padre
                const coordenadas = coordenadasParadas.get(paradaId);
                
                if (!coordenadas) {
                    console.warn(`‚ö†Ô∏è Padre: No se encontraron coordenadas para ${paradaId}`);
                }
                
                // Obtener reto si existe
                const reto = obtenerRetoParaParada(paradaId);
                
                // Construir objeto completo desde el padre
                const datosCompletos = {
                    id: paradaId,
                    tipo: parada.tipo || 'parada',
                    coordenadas: coordenadas || [39.4489, -0.3749], // Coordenadas por defecto Valencia
                    audio: parada.audio_id || null,
                    reto: reto || null,
                    propiedadesAdicionales: {
                        visitada: paradaId === `P-${estadoGlobal.paradaActual}` || 
                                 parseInt(paradaId.replace('P-', '')) < estadoGlobal.paradaActual,
                        esActual: paradaId === `P-${estadoGlobal.paradaActual}`,
                        fechaUltimaVisita: null,
                        timestamp: new Date().toISOString()
                    },
                    origen: 'padre'
                };
                
                console.log(`‚úÖ Padre: Datos obtenidos para ${paradaId}:`, datosCompletos);
                return datosCompletos;
                
            } catch (error) {
                console.error('‚ùå Padre: Error obteniendo datos de parada:', error);
                return null;
            }
        }

        /**
         * Env√≠a informaci√≥n de parada a un hijo espec√≠fico
         */
        async function enviarDatosParadaAHijo(hijoId, paradaId) {
            try {
                const datosParada = obtenerDatosParada(paradaId);
                
                if (!datosParada) {
                    throw new Error(`No se pudieron obtener datos para parada ${paradaId}`);
                }
                
                await Mensajeria.enviarMensaje(hijoId, TIPOS_MENSAJE.NAVEGACION.ESTADO, {
                    accion: 'datos_parada',
                    parada: datosParada,
                    timestamp: Date.now()
                });
                
                console.log(`üì§ Padre: Datos de parada ${paradaId} enviados a ${hijoId}`);
                return true;
                
            } catch (error) {
                console.error(`‚ùå Padre: Error enviando datos de parada a ${hijoId}:`, error);
                return false;
            }
        }

        /**
         * Env√≠a informaci√≥n de reto a un hijo espec√≠fico
         */
        async function enviarRetoAHijo(hijoId, paradaId) {
            try {
                const retoData = obtenerRetoParaParada(paradaId);
                
                if (!retoData) {
                    console.log(`‚ÑπÔ∏è Padre: No hay reto para enviar en parada ${paradaId}`);
                    return false;
                }
                
                await Mensajeria.enviarMensaje(hijoId, TIPOS_MENSAJE.RETOS.MOSTRAR, {
                    reto: retoData,
                    paradaId: paradaId,
                    timestamp: Date.now()
                });
                
                console.log(`üéØ Padre: Reto ${retoData.id} enviado a ${hijoId}`);
                return true;
                
            } catch (error) {
                console.error(`‚ùå Padre: Error enviando reto a ${hijoId}:`, error);
                return false;
            }
        }

        // ================== MANEJADORES CENTRALIZADOS ACTUALIZADOS ==================
        
        async function manejarSolicitudDestino(mensaje) {
            try {
                const { paradaActual: paradaActualHijo } = mensaje.datos || {};
                
                // El padre decide cu√°l es la pr√≥xima parada
                const proximaParada = estadoGlobal.paradaActual + 1;
                const paradaId = `P-${proximaParada}`;
                
                console.log(`üéØ Padre: Solicitud de destino de ${mensaje.origen}, enviando parada ${paradaId}`);
                
                // Enviar datos completos de la parada
                await enviarDatosParadaAHijo(mensaje.origen, paradaId);
                
                return { estado: 'ok', paradaEnviada: paradaId };

            } catch (error) {
                console.error('‚ùå Padre: Error manejando solicitud de destino:', error);
                throw error;
            }
        }

        async function manejarSolicitudReto(mensaje) {
            try {
                const { paradaId } = mensaje.datos || {};
                
                if (!paradaId) {
                    throw new Error('ID de parada no proporcionado');
                }
                
                console.log(`üéØ Padre: Solicitud de reto para ${paradaId} de ${mensaje.origen}`);
                
                // Enviar reto si existe
                const retoEnviado = await enviarRetoAHijo(mensaje.origen, paradaId);
                
                return { estado: 'ok', retoEnviado };

            } catch (error) {
                console.error('‚ùå Padre: Error manejando solicitud de reto:', error);
                throw error;
            }
        }

        // ================== REGISTRO DE MANEJADORES ACTUALIZADOS ==================
        function registrarManejadores() {
            // Manejador de hijos listos
            Mensajeria.registrarControlador(TIPOS_MENSAJE.SISTEMA.LISTO, manejarHijoListo);
            
            // Manejadores de sistema
            Mensajeria.registrarControlador(TIPOS_MENSAJE.SISTEMA.ERROR, manejarErrorDeHijo);
            Mensajeria.registrarControlador(TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, manejarCambioModoGlobal);
            
            // Manejadores de navegaci√É∆í√Ç¬≥n
            Mensajeria.registrarControlador(TIPOS_MENSAJE.NAVEGACION.CAMBIO_PARADA, manejarCambioParada);
            Mensajeria.registrarControlador(TIPOS_MENSAJE.NAVEGACION.LLEGADA_DETECTADA, manejarLlegadaDestino);
            Mensajeria.registrarControlador(TIPOS_MENSAJE.NAVEGACION.SOLICITAR_DESTINO, manejarSolicitudDestino);
            
            // Manejadores de audio
            Mensajeria.registrarControlador(TIPOS_MENSAJE.AUDIO.FINALIZADO, manejarAudioFinalizado);
            Mensajeria.registrarControlador(TIPOS_MENSAJE.AUDIO.ESTADO, manejarEstadoAudio);
            
            // Manejadores de retos
            Mensajeria.registrarControlador(TIPOS_MENSAJE.RETOS.COMPLETADO, manejarRetoCompletado);
            Mensajeria.registrarControlador(TIPOS_MENSAJE.RETOS.ABRIR, manejarAbrirReto);
            
            // Manejadores de GPS
            Mensajeria.registrarControlador(TIPOS_MENSAJE.GPS.ESTADO, manejarEstadoGPS);

            // Nuevos manejadores para solicitudes de datos
            Mensajeria.registrarControlador(TIPOS_MENSAJE.NAVEGACION.SOLICITAR_DESTINO, manejarSolicitudDestino);
            Mensajeria.registrarControlador(TIPOS_MENSAJE.RETOS.ABRIR, manejarSolicitudReto);
            
            // Manejador para solicitudes espec√≠ficas de datos de parada
            Mensajeria.registrarControlador('DATOS.SOLICITAR_PARADA', async (mensaje) => {
                const { paradaId } = mensaje.datos || {};
                if (paradaId) {
                    await enviarDatosParadaAHijo(mensaje.origen, paradaId);
                }
            });
            
            console.log('‚úÖ Manejadores centralizados registrados en el padre');
        }

        // ================== FUNCIONES P√öBLICAS CENTRALIZADAS ACTUALIZADAS ==================
        window.padreFunciones = {
            // Estado
            obtenerEstadoGlobal: () => ({ ...estadoGlobal }),
            
            // Datos del mapa (PADRE COMO FUENTE √öNICA)
            obtenerRetoParaParada,
            obtenerDatosParada,
            enviarDatosParadaAHijo,
            enviarRetoAHijo,
            
            // Control centralizado
            cambiarModo: async (modo) => {
                return Mensajeria.cambiarModoGlobal(modo);
            },
            
            habilitarControles: async (modo = estadoGlobal.modo) => {
                return Mensajeria.habilitarControles(modo);
            },
            
            deshabilitarControles: async (motivo = 'padre') => {
                return Mensajeria.deshabilitarControles(motivo);
            },
            
            // Navegaci√É∆í√Ç¬≥n centralizada
            cambiarParada: async (parada) => {
                return manejarCambioParada({ datos: { parada } });
            },
            
            // Audio centralizado
            reproducirAudio: async (archivo, parada = null) => {
                return Mensajeria.enviarMensaje('Av1_audio_esp', TIPOS_MENSAJE.AUDIO.REPRODUCIR, {
                    archivo, parada
                });
            },
            
            // Retos centralizados
            abrirReto: async (retoId, parada) => {
                return manejarAbrirReto({ datos: { retoId, parada } });
            },
            
            // Sincronizaci√É∆í√Ç¬≥n
            sincronizar: sincronizarEstadoGlobal
        };

        // ================== INICIALIZACI√É∆í√¢‚Ç¨≈ìN ==================
        document.addEventListener('DOMContentLoaded', inicializar);

        // Exportar para compatibilidad
        window.estadoGlobal = estadoGlobal;
    </script>
</head>
<body>
    <!-- Contenedor del mapa -->
    <div id="mapa"></div>

    <img id="logo-aventura" src="https://valenciavguides.github.io/Aventura-1-esp-padre-con-hijos/fotos_Av1/LOGO%20LETRAS%20FINAL%20transparente%20recorte.png" alt="Logo" style="position: fixed; top: -32px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 360px; height: 140px;" />

    <div id="info-parada"></div>
    
    <!-- Fondo blanco para el logo con borde naranja -->
    <div style="position: fixed; top: 0; left: 0; right: 0; width: 99%; margin: 0 auto; height: 80px; background: white; z-index: 2999; border: 2px solid #ec7c26; border-top: none; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;"></div>

    <!-- Rutas actualizadas para GitHub Pages -->
    <iframe id="hijo1-hamburguesa" src="./botones-y-subfunciones-hamburguesa.html" style="position:fixed; left:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; border: transparent; background:transparent; pointer-events:auto;"></iframe>
    <iframe id="hijo1-opciones" src="./botones-y-subfunciones-opciones.html" style="position:fixed; right:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; border: transparent; background:transparent; pointer-events:auto;"></iframe>
    <iframe id="hijo5-casa" src="./Av1-boton-casa.html" style="position:fixed; right:0; top:70px; width:99%; height:85px; z-index:10000; border: 1px solid red; background:transparent; pointer-events:auto; margin:0; padding:0; overflow:hidden; border-radius:0;"></iframe>

    <iframe id="hijo3" src="./Av1_audio_esp.html"
            style="position:fixed;
                   bottom:-6px;
                   left:50%;
                   transform:translateX(-50%);
                   height:165px;
                   width:310px;
                   z-index:1000;
                   border: transparent;
                   display:block;
                   pointer-events:auto;"></iframe>

    <iframe id="hijo2" src="./Av1-botones-coordenadas.html"
            style="position:fixed;
                   bottom:150px;
                   left:50%;
                   transform:translateX(-50%);
                   height:165px;
                   width:310px;
                   z-index:1001;
                   border: none !important;
                   background-color: transparent !important;
                   overflow: hidden;
                   pointer-events:auto;"
            allow="geolocation"
            frameborder="0"></iframe>

    <iframe id="hijo4" src="./Av1-esp-retos-preguntas.html" style="display:none;"></iframe>

    <div id="media-overlay">
        <div id="media-container">
            <button id="close-media">X</button>
            <video id="parada-video" controls></video>
            <img id="parada-imagen">
        </div>
    </div>
    
    <!-- Scripts de Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Scripts principales -->
    <script>
    'use strict';
    
    // ================== VARIABLES GLOBALES ==================
    let mapa = null;
    let mensajeria = null;
    let mapInitialized = false;
    
    // Variables globales
    window.paradaActual = 0;
    
    // ================== CONFIGURACIONES ==================
    const CONFIGURACIONES_MENSAJE = {
        UI: {
            maxReintentos: 1,
            timeout: 800,
            esperarRespuesta: false
        },
        AUDIO: {
            maxReintentos: 3,
            timeout: 5000,
            esperarRespuesta: true
        },
        GPS: {
            maxReintentos: 5,
            timeout: 10000,
            esperarRespuesta: true
        },
        RETO: {
            maxReintentos: 2,
            timeout: 3000,
            esperarRespuesta: true
        },
        SYNC: {
            maxReintentos: 3,
            timeout: 8000,
            esperarRespuesta: false
        }
    };
    
    // ================== ESTRUCTURA DE DATOS ==================
    const AVENTURA_PARADAS = [
        // Parada 0 √É¬¢√¢‚Äö¬¨√¢‚Ç¨≈ì INICIO (Torres de Serranos start) reto 2 (223, 226, 228, 229)//
        { tipo: "inicio", parada_id: 'P-0', audio_id: "audio-P-0", reto_id: "R-2" },
        // tramo 1 (Torres de Serranos √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Plaza de la crida) (2, 126,)//
        { tipo: "tramo", tramo_id: 'TR-1', audio_id: "audio-TR-1" },
        // Parada 1 - Plaza de la crida (Puente de Serranos) Reto 3 (233) //
        { tipo: "parada", parada_id: 'P-1', audio_id: "audio-P-1", reto_id: "R-3" },
        // tramo 2 (Plaza de la crida √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Calle Muro de Santa Ana) (81) //
        { tipo: "tramo", tramo_id: 'TR-2', audio_id: "audio-TR-2" },
        // Parada 2 (Calle Muro de Santa Ana) Reto 4 (68) //
        { tipo: "parada", parada_id: 'P-2', audio_id: "audio-P-2", reto_id: "R-4" },
        // tramo 3 (Calle Muro de Santa Ana √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Palacio de los Borgia) (52) //
        { tipo: "tramo", tramo_id: 'TR-3', audio_id: "audio-TR-3" },
        // Parada 3 (Iglesia de San Lorenzo) Reto 5 (686, 682-B, 462, 683, 684) //
        { tipo: "parada", parada_id: 'P-3', audio_id: "audio-P-3", reto_id: "R-5" },
        // tramo 4 (Iglesia de San Lorenzo √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Plaza de la Virgen) (465-B) //
        { tipo: "tramo", tramo_id: 'TR-4', audio_id: "audio-TR-4" },
        // Parada 4 (Plaza de la Virgen) Reto 6 (466, 467) //
        { tipo: "parada", parada_id: 'P-4', audio_id: "audio-P-4", reto_id: "R-6" },
        // Parada 5 (Plaza de la Virgen) Reto 7, 8 Puzzle plaza de la virgen (468)  //
        { 
            tipo: "parada", 
            parada_id: 'P-5', 
            audio_id: "audio-P-5", 
            retos: [
                { tipo: "reto", id: "R-7" },
                { tipo: "puzzle", id: "PZ-8" }
            ] 
        },
        // tramo 5 (Plaza de la Virgen √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Plaza de la Almo√É∆í√Ç¬≠na) (477-B, 479, 141, 83, 8-C) //
        { tipo: "tramo", tramo_id: 'TR-5', audio_id: "audio-TR-5" },
        // Parada 6 (Panel cer√É∆í√Ç¬°mico muro Catedral) Reto 9 (434, 440, 441, 442) //
        { tipo: "parada", parada_id: 'P-6', audio_id: "audio-P-6", reto_id: "R-9" },
        // Parada 7 (Capilla exterior catedral) Reto 10 (443, 444, 445) //
        { tipo: "parada", parada_id: 'P-7', audio_id: "audio-P-7", reto_id: "R-10" },
        // Parada 8 (Capilla exterior catedral) Reto 11 (445) //
        { tipo: "parada", parada_id: 'P-8', audio_id: "audio-P-8", reto_id: "R-11" },
        // Parada 9 (Arco Novo Catedral y Puerta Negra Bas√É∆í√Ç¬≠lica) (446, 355, 447, 11-B, 451, 452) //
        { tipo: "parada", parada_id: 'P-9', audio_id: "audio-P-9" },
        // Parada 10 (Casa del Punt de Gantxo) Reto 12 (51-C, 454, 455, 455-B, 456, 148) //
        { tipo: "parada", parada_id: 'P-10', audio_id: "audio-P-10", reto_id: "R-12"  },
        // tramo 6 (Plaza de la Almo√É∆í√Ç¬≠na (casa del punt de Gantxo) √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Plaza Decimo Junio Bruto) (457, 10-B)//
        { tipo: "tramo", tramo_id: 'TR-6', audio_id: "audio-TR-6" },
        // Parada 11 (Museo arqueol√É∆í√Ç¬≥gico La Almo√É∆í√Ç¬≠na) Reto 13 (458) //
        { tipo: "parada", parada_id: 'P-11', audio_id: "audio-P-11", reto_id: "R-13" },
        // Parada 12 (Museo arqueol√É∆í√Ç¬≥gico La Almo√É∆í√Ç¬≠na 2) (459, 460, 461) //
        { tipo: "parada", parada_id: 'P-12', audio_id: "audio-P-12" },
        // Parada 13 (Vista de la Catedral, Cimborrio) Reto 14 (8-C, 464) //
        { tipo: "parada", parada_id: 'P-13', audio_id: "audio-P-13", reto_id: "R-14" },
        // tramo 7 (Museo arqueol√É∆í√Ç¬≥gico La Almo√É∆í√Ç¬≠na √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Palacio Arzobispal) (85) //
        { tipo: "tramo", tramo_id: 'TR-7', audio_id: "audio-TR-7" },
        // Parada 14 (Palacio Arzobispal y Puerta Rom√É∆í√Ç¬°nica de la Catedral) Reto 15 (673, 86, 426-B, 141, 437, 438) //
        { tipo: "parada", parada_id: 'P-14', audio_id: "audio-P-14", reto_id: "R-15" },
        // Parada 15 (Puerta Rom√É∆í√Ç¬°nica de la Catedral) (439) //
        { tipo: "parada", parada_id: 'P-15', audio_id: "audio-P-15" },
        // tramo 8 (Puerta Rom√É∆í√Ç¬°nica de la Catedral √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Plaza del Ayuntamiento) (125) //
        { tipo: "tramo", tramo_id: 'TR-8', audio_id: "audio-TR-8" },
        // Parada 16 (Plaza del Ayuntamiento) (13-B, 263, 332, 14-C) //
        { tipo: "parada", parada_id: 'P-16', audio_id: "audio-P-16" },
        // tramo 9 (Plaza del Ayuntamiento √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Edificio del Ayuntamiento) (334, 335) //
        { tipo: "tramo", tramo_id: 'TR-9', audio_id: "audio-TR-9" },
        // Parada 17 (Edificio del Ayuntamiento) Reto 16 (336, 337, 338) //
        { tipo: "parada", parada_id: 'P-17', audio_id: "audio-P-17", reto_id: "R-16" },
        // Parada 18 (Edificio del Ayuntamiento, leyenda del murci√É∆í√Ç¬©lago) (339, 340, 341, 54) //
        { tipo: "parada", parada_id: 'P-18', audio_id: "audio-P-18" },
        // tramo 10 (Edificio del Ayuntamiento √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Estaci√É∆í√Ç¬≥n del Norte) (87, 15-C) //
        { tipo: "tramo", tramo_id: 'TR-10', audio_id: "audio-TR-10" },
        // Parada 19 (Estaci√É∆í√Ç¬≥n del Norte) Reto 17, 18 Puzzle Estaci√É∆í√Ç¬≥n del Norte (326) //
        { 
            tipo: "parada", 
            parada_id: 'P-19', 
            audio_id: "audio-P-19", 
            retos: [
                { tipo: "reto", id: "R-17" },
                { tipo: "puzzle", id: "PZ-18" }
            ] 
        },
        // tramo 11 (Estaci√É∆í√Ç¬≥n del Norte √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Plaza de Toros) (20-C, 323-B, 88) //
        { tipo: "tramo", tramo_id: 'TR-11', audio_id: "audio-TR-11" },
        // Tramo 12 (Plaza de Toros √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Casa estilo √É∆í√Ç¬Årabe) (89, 3-D) //
        { tipo: "tramo", tramo_id: 'TR-12', audio_id: "audio-TR-12" },
        // Parada 20 (Casa estilo √É∆í√Ç¬Årabe) Reto 19 (99) //
        { tipo: "parada", parada_id: 'P-20', audio_id: "audio-P-20", reto_id: "R-19" },
        // Parada 21 (Casa estilo √É∆í√Ç¬Årabe, mitad Aventura) (100) //
        { tipo: "parada", parada_id: 'P-21', audio_id: "audio-P-21" },
        // tramo 13 (Casa estilo √É∆í√Ç¬Årabe √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Palacio de Comunicaciones) (21-B) //
        { tipo: "tramo", tramo_id: 'TR-13', audio_id: "audio-TR-13" },
        // Parada 22 (Palacio de Comunicaciones) Reto 20 y Reto 21 (700, 343, 344) //
        { tipo: "parada", parada_id: 'P-22', audio_id: "audio-P-22", retos: ["R-20", "R-21"] },
        // Parada 23 (Edificio Suay) Reto 21 (693, 693-B) //
        { tipo: "parada", parada_id: 'P-23', audio_id: "audio-P-23" ,reto_id: "R-21" },
        // tramo 14 (Palacio de Comunicaciones, edificio Suay √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Banco de Val√É∆í√Ç¬®ncia) (345, 347, 348, 22, 109) //
        { tipo: "tramo", tramo_id: 'TR-14', audio_id: "audio-TR-14" },
        // Parada 24 (Banco de Valencia) Reto 22 (349, 350) //
        { tipo: "parada", parada_id: 'P-24', audio_id: "audio-P-24", reto_id: "R-22" },
        // tramo 15 (Banco de Val√É∆í√Ç¬®ncia √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Palacio del Marqu√É∆í√Ç¬©s de Dos Aguas) (351, 23-B, 352, 354) //
        { tipo: "tramo", tramo_id: 'TR-15', audio_id: "audio-TR-15" },
        // Parada 25 (Palacio del Marqu√É∆í√Ç¬©s de Dos Aguas) (356, 357)//
        { tipo: "parada", parada_id: 'P-25', audio_id: "audio-P-25" },
        // tramo 16 (Palacio del Marqu√É∆í√Ç¬©s √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Mercado Central) (358, 359-B, 101) //
        { tipo: "tramo", tramo_id: 'TR-16', audio_id: "audio-TR-16" },
        // Parada 26 (Mercado central) Reto23 (701, 24-D, 361, 362, 363, 364) //
        { tipo: "parada", parada_id: 'P-26', audio_id: "audio-P-26", reto_id: "R-23" },
        // tramo 17 (Mercado Central √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Iglesia de los Santos Juanes) (274, 27-C) //
        { tipo: "tramo", tramo_id: 'TR-17', audio_id: "audio-TR-17" },
        // Parada 27 (Iglesia de los Santos Juanes) Reto 24) (365, 366) //
        { tipo: "parada", parada_id: 'P-27', audio_id: "audio-P-27", reto_id: "R-24" },
        // Parada 28 (Iglesia de los Santos Juanes reto 25) (367) //
        { tipo: "parada", parada_id: 'P-28', audio_id: "audio-P-28", reto_id: "R-25" },
        // tramo 18 (Iglesia Santos Juanes √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Lonja de Val√É∆í√Ç¬®ncia) (368, 369, 28, 370, 371, 372, 373, 374, 375, 376, 377) //
        { tipo: "tramo", tramo_id: 'TR-18', audio_id: "audio-TR-18" },
        // Parada 29 (Lonja Puerta de Los Pecados barquero) Reto 27 (378, 379) //
        { tipo: "parada", parada_id: 'P-29', audio_id: "audio-P-29", reto_id: "R-27" },
        // Parada 30 (Lonja Puerta de Los Pecados √É∆í√Ç¬°rbol muerto) Reto 28 (380, 381) //
        { tipo: "parada", parada_id: 'P-30', audio_id: "audio-P-30", reto_id: "R-28" },
        // tramo 19 (Lonja G√É∆í√Ç¬°rgolas) (383) //
        { tipo: "tramo", tramo_id: 'TR-19', audio_id: "audio-TR-19" },
        // Parada 31 (Lonja G√É∆í√Ç¬°rgolas √É∆í√Ç¬°ngel vasija) Reto 29 (384) //
        { tipo: "parada", parada_id: 'P-31', audio_id: "audio-P-31", reto_id: "R-29" },
        // Parada 32 (Lonja G√É∆í√Ç¬°rgolas barbudo y le√É∆í√Ç¬≥n) Reto 30 (385) //
        { tipo: "parada", parada_id: 'P-32', audio_id: "audio-P-32", reto_id: "R-30" },
        // Parada 33 (Lonja G√É∆í√Ç¬°rgolas fornicador ventana) Reto 31, Puzzle 26 ) (386) //
        { tipo: "parada", parada_id: 'P-33', audio_id: "audio-P-33", retos: [ { tipo: "reto", id: "R-31" }, { tipo: "puzzle", id: "PZ-26" } ] },
        // tramo 20 (Lonja √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Plaza del Doctor Collado) (388, 389, 390, 391, 392) //
        { tipo: "tramo", tramo_id: 'TR-20', audio_id: "audio-TR-20" },
        // tramo 21 (Plaza del Doctor Collado √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Plaza del Negrito) (333, 397, 41, 398, 198, 671, 522, 32-C) //
        { tipo: "tramo", tramo_id: 'TR-21', audio_id: "audio-TR-21" },
        // Parada 34 (Fuente del Negrito) Reto 32 (382, 501) //
        { tipo: "parada", parada_id: 'P-34', audio_id: "audio-P-34", reto_id: "R-32" },
        // tramo 22 (Plaza del Negrito √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Calle Caballeros) (33-B, 486, 480-B) //
        { tipo: "tramo", tramo_id: 'TR-22', audio_id: "audio-TR-22" },
        // Parada 35 (Palau de la Generalitat) (481-B, 482-B, 2-D) //
        { tipo: "parada", parada_id: 'P-35', audio_id: "audio-P-35" },
        // tramo 23 (Palacio de la Generalitat √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Calle de los Serranos - FINAL)  //
        { tipo: "tramo", tramo_id: 'TR-23', audio_id: "audio-TR-23" },
        // Parada 36 (Torres de Serranos Final) //
        { tipo: "parada", parada_id: 'P-36', audio_id: "audio-P-36" }
    ];
    
    // ================== FUNCIONES DE MANEJO DE ERRORES ==================
    function mostrarErrorEnInterfaz(mensaje, onRetry = null, opciones = {}) {
        const config = {
            tiempo: 10000,
            tipo: 'error',
            cerrable: true,
            ...opciones
        };
        
        // Eliminar mensajes anteriores
        const erroresAnteriores = document.querySelectorAll('.error-mensaje');
        erroresAnteriores.forEach(el => {
            if (!el.hasAttribute('data-persistente')) {
                el.remove();
            }
        });
        
        // Crear contenedor del mensaje
        const errorMsg = document.createElement('div');
        errorMsg.className = `error-mensaje error-tipo-${config.tipo}`;
        
        const estilosPorTipo = {
            error: { backgroundColor: '#d32f2f', borderColor: '#b71c1c', icon: '√É¬¢√Ç¬ù√Ö‚Äô' },
            advertencia: { backgroundColor: '#ff9800', borderColor: '#f57c00', icon: '√É¬¢√Ö¬°√Ç¬†√É¬Ø√Ç¬∏√Ç¬è' },
            info: { backgroundColor: '#1976d2', borderColor: '#1565c0', icon: '√É¬¢√¢‚Ç¨≈æ√Ç¬π√É¬Ø√Ç¬∏√Ç¬è' }
        };
        
        const estilo = estilosPorTipo[config.tipo] || estilosPorTipo.error;
        errorMsg.style.backgroundColor = estilo.backgroundColor;
        errorMsg.style.borderLeft = `4px solid ${estilo.borderColor}`;
        
        let contenidoHTML = `
            <h3>${estilo.icon} ${config.tipo.charAt(0).toUpperCase() + config.tipo.slice(1)}</h3>
            <p>${mensaje}</p>
            <div class="error-botones">
        `;
        
        if (onRetry && typeof onRetry === 'function') {
            contenidoHTML += `<button class="error-btn error-btn-reintentar" data-action="reintentar">Reintentar</button>`;
        }
        
        if (config.cerrable) {
            contenidoHTML += `<button class="error-btn error-btn-cerrar" data-action="cerrar">Cerrar</button>`;
        }
        
        contenidoHTML += '</div>';
        errorMsg.innerHTML = contenidoHTML;
        
        // Manejadores de eventos
        errorMsg.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            
            const action = target.getAttribute('data-action');
            if (action === 'reintentar' && onRetry) {
                onRetry();
            }
            cerrarMensaje(errorMsg);
        });
        
        document.body.appendChild(errorMsg);
        
        // Auto-eliminar
        let timeoutId;
        if (config.tiempo > 0) {
            timeoutId = setTimeout(() => cerrarMensaje(errorMsg), config.tiempo);
        }
        
        function cerrarMensaje(elemento) {
            if (elemento && document.body.contains(elemento)) {
                elemento.style.animation = 'fadeOut 0.3s ease-in-out';
                setTimeout(() => elemento.remove(), 300);
                if (timeoutId) clearTimeout(timeoutId);
            }
        }
        
        return () => cerrarMensaje(errorMsg);
    }
    
    // ================== FUNCIONES DE CONTROL ==================
    async function enableControls(modo = 'casa') {
        console.log(`Habilitando controles en modo: ${modo}`);
        try {
            if (mensajeria && typeof mensajeria.enviarMensaje === 'function') {
                const opcionesUI = CONFIGURACIONES_MENSAJE.UI;
                
                const promesas = [
                    mensajeria.enviarMensaje('hijo2', 'habilitar_controles', { modo }, opcionesUI),
                    mensajeria.enviarMensaje('hijo3', 'habilitar_controles', { modo }, opcionesUI),
                    mensajeria.enviarMensaje('hijo4', 'habilitar_controles', { modo }, opcionesUI),
                    mensajeria.enviarMensaje('hijo5-casa', 'habilitar_controles', { modo }, opcionesUI)
                ];
                
                await Promise.allSettled(promesas);
                console.log(`√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Controles habilitados en modo: ${modo}`);
            }
        } catch (error) {
            console.error('Error al habilitar controles:', error);
        }
        return Promise.resolve();
    }

    async function disableControls(motivo = 'desconocido') {
        console.log(`Deshabilitando controles. Motivo: ${motivo}`);
        try {
            if (mensajeria && typeof mensajeria.enviarMensaje === 'function') {
                const opcionesUI = CONFIGURACIONES_MENSAJE.UI;
                
                const promesas = [
                    mensajeria.enviarMensaje('hijo2', 'deshabilitar_controles', { motivo }, opcionesUI),
                    mensajeria.enviarMensaje('hijo3', 'deshabilitar_controles', { motivo }, opcionesUI),
                    mensajeria.enviarMensaje('hijo4', 'deshabilitar_controles', { motivo }, opcionesUI),
                    mensajeria.enviarMensaje('hijo5-casa', 'deshabilitar_controles', { motivo }, opcionesUI)
                ];
                
                await Promise.allSettled(promesas);
                console.log(`√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Controles deshabilitados. Motivo: ${motivo}`);
            }
        } catch (error) {
            console.error('Error al deshabilitar controles:', error);
        }
        return Promise.resolve();
    }
    
    // ================== FUNCIONES DE MENSAJER√É∆í√Ç¬çA OPTIMIZADAS ==================
    async function enviarMensajeOptimizado(destino, tipo, datos = {}, categoria = 'UI') {
        if (!mensajeria) {
            throw new Error('Sistema de mensajer√É∆í√Ç¬≠a no inicializado');
        }
        
        const configuracion = CONFIGURACIONES_MENSAJE[categoria] || CONFIGURACIONES_MENSAJE.UI;
        
        try {
            const resultado = await mensajeria.enviarMensaje(destino, tipo, datos, configuracion);
            console.log(`√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬§ Mensaje enviado a ${destino}:`, tipo);
            return resultado;
        } catch (error) {
            console.error(`√É¬¢√Ç¬ù√Ö‚Äô Error enviando mensaje a ${destino}:`, error);
            throw error;
        }
    }
    
    async function enviarMensajeMultiple(tipo, datos = {}, categoria = 'UI') {
        const destinos = ['hijo2', 'hijo3', 'hijo4', 'hijo5-casa'];
        const configuracion = CONFIGURACIONES_MENSAJE[categoria] || CONFIGURACIONES_MENSAJE.UI;
        
        const promesas = destinos.map(destino => 
            enviarMensajeOptimizado(destino, tipo, datos, categoria)
                .catch(error => ({ destino, error }))
        );
        
        const resultados = await Promise.allSettled(promesas);
        
        const exitosos = resultados.filter(r => r.status === 'fulfilled').length;
        const fallidos = resultados.length - exitosos;
        
        console.log(`√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ö¬† Mensaje m√É∆í√Ç¬∫ltiple completado: ${exitosos} exitosos, ${fallidos} fallidos`);
        return { exitosos, fallidos, resultados };
    }
    
    // ================== FUNCIONES ESPEC√É∆í√Ç¬çFICAS DE COMUNICACI√É∆í√¢‚Ç¨≈ìN ==================
    async function enviarComandoAudio(comando, datos = {}) {
        return enviarMensajeOptimizado('hijo3', 'AUDIO.COMANDO', { comando, ...datos }, 'AUDIO');
    }
    
    async function actualizarCoordenadas(coordenadas) {
        return enviarMensajeOptimizado('hijo2', 'GPS.ACTUALIZAR', coordenadas, 'GPS');
    }
    
    async function enviarReto(retoData) {
        return enviarMensajeOptimizado('hijo4', 'RETO.NUEVO', retoData, 'RETO');
    }
    
    async function sincronizarEstado(estado) {
        return enviarMensajeMultiple('SISTEMA.SINCRONIZAR', estado, 'SYNC');
    }
    
    async function actualizarUITodos(datosUI) {
        return enviarMensajeMultiple('UI.ACTUALIZAR', datosUI, 'UI');
    }
    
    // ================== FUNCIONES ESPEC√É∆í√Ç¬çFICAS DEL MAPA ==================
    async function navegarAParada(paradaId, estado = 'objetivo') {
        return enviarMensajeMultiple('NAVEGACION.ESTADO', {
            accion: 'navegar_parada',
            paradaId: paradaId,
            estado: estado,
            timestamp: Date.now()
        }, 'GPS');
    }
    
    async function centrarMapaEn(lat, lng, zoom = 16) {
        return enviarMensajeMultiple('NAVEGACION.ESTADO', {
            accion: 'centrar_mapa',
            lat: lat,
            lng: lng,
            zoom: zoom,
            timestamp: Date.now()
        }, 'UI');
    }
    
    async function actualizarParadaActual(paradaId, estado = 'actual') {
        return enviarMensajeMultiple('NAVEGACION.ESTADO', {
            accion: 'actualizar_parada',
            paradaId: paradaId,
            estado: estado,
            timestamp: Date.now()
        }, 'UI');
    }
    
    async function iniciarGPS() {
        return enviarMensajeMultiple('GPS.COMANDO', {
            accion: 'iniciar_seguimiento',
            timestamp: Date.now()
        }, 'GPS');
    }
    
    async function detenerGPS() {
        return enviarMensajeMultiple('GPS.COMANDO', {
            accion: 'detener_seguimiento',
            timestamp: Date.now()
        }, 'GPS');
    }
    
    // ================== FUNCIONES DE INTERFAZ ==================
    function mostrarMensajeInfoParada(mensaje, esError = false) {
        const info = document.getElementById('info-parada');
        if (info) {
            info.textContent = mensaje;
            info.style.display = 'block';
            if (esError) {
                info.classList.add('error');
            } else {
                info.classList.remove('error');
            }
        }
    }
    
    function ocultarInfoParada() {
        const info = document.getElementById('info-parada');
        if (info) {
            info.style.display = 'none';
        }
    }
    
    function mostrarImagenOverlay(paradaId) {
        const overlay = document.getElementById('media-overlay');
        const img = document.getElementById('parada-imagen');
        const video = document.getElementById('parada-video');
        
        if (!overlay || !img) return;

        if (video) {
            video.style.display = 'none';
            video.pause && video.pause();
        }

        const rutaImagen = paradaId ? `./fotos_Av1/${paradaId}.jpg` : './fotos_Av1/default.jpg';
        img.src = rutaImagen;
        img.style.display = 'block';
        overlay.style.display = 'flex';

        const closeBtn = document.getElementById('close-media');
        if (closeBtn) {
            closeBtn.onclick = function(e) {
                e.stopPropagation();
                overlay.style.display = 'none';
                img.src = '';
            };
        }
    }
    
    function closeMediaOverlay() {
        const mediaOverlay = document.getElementById('media-overlay');
        if (mediaOverlay) {
            mediaOverlay.style.display = 'none';
            const mediaElement = mediaOverlay.querySelector('video, audio');
            if (mediaElement) {
                mediaElement.pause();
                mediaElement.currentTime = 0;
            }
        }
        
        // Notificar a los hijos
        ['hijo2', 'hijo3', 'hijo4', 'hijo5-casa'].forEach(id => {
            try {
                if (mensajeria) {
                    mensajeria.enviarMensaje(id, 'mediaOverlayClosed', {});
                }
            } catch (error) {
                console.error(`Error notificando a ${id}:`, error);
            }
        });
    }
    
    // ================== VARIABLES Y CAPAS DEL MAPA ==================
    let marcadoresParadas = new Map();
    let marcadoresUsuario = new Map();
    let rutasActivas = new Map();
    let capaPosicionUsuario = null;
    let watchId = null;
    let coordenadasParadas = new Map();
    
    // Inicializar coordenadas de las paradas
    function inicializarCoordenadasParadas() {
        // Coordenadas reales de Valencia para cada parada
        const coordenadas = new Map([
            ['P-0', [39.44859, -0.37489]], // Torres de Serranos
            ['P-1', [39.44799, -0.37520]], // Plaza de la Crida
            ['P-2', [39.44720, -0.37440]], // Calle Muro Santa Ana
            ['P-3', [39.44650, -0.37380]], // Iglesia San Lorenzo
            ['P-4', [39.44580, -0.37320]], // Plaza de la Virgen
            ['P-5', [39.44580, -0.37320]], // Plaza de la Virgen
            ['P-6', [39.44520, -0.37260]], // Panel cer√É∆í√Ç¬°mico Catedral
            ['P-7', [39.44480, -0.37200]], // Capilla exterior
            ['P-8', [39.44480, -0.37200]], // Capilla exterior
            ['P-9', [39.44440, -0.37140]], // Arco Novo Catedral
            ['P-10', [39.44400, -0.37080]], // Casa Punt Gantxo
            ['P-11', [39.44360, -0.37020]], // Museo Almo√É∆í√Ç¬≠na
            ['P-12', [39.44360, -0.37020]], // Museo Almo√É∆í√Ç¬≠na 2
            ['P-13', [39.44320, -0.36960]], // Vista Catedral
            ['P-14', [39.44280, -0.36900]], // Palacio Arzobispal
            ['P-15', [39.44240, -0.36840]], // Puerta Rom√É∆í√Ç¬°nica
            ['P-16', [39.44200, -0.36780]], // Plaza Ayuntamiento
            ['P-17', [39.44160, -0.36720]], // Edificio Ayuntamiento
            ['P-18', [39.44160, -0.36720]], // Ayuntamiento murci√É∆í√Ç¬©lago
            ['P-19', [39.44120, -0.36660]], // Estaci√É∆í√Ç¬≥n Norte
            ['P-20', [39.44080, -0.36600]], // Casa estilo √É∆í√Ç¬Årabe
            ['P-21', [39.44080, -0.36600]], // Casa estilo √É∆í√Ç¬Årabe
            ['P-22', [39.44040, -0.36540]], // Palacio Comunicaciones
            ['P-23', [39.44000, -0.36480]], // Edificio Suay
            ['P-24', [39.43960, -0.36420]], // Banco Valencia
            ['P-25', [39.43920, -0.36360]], // Palacio Marqu√É∆í√Ç¬©s
            ['P-26', [39.43880, -0.36300]], // Mercado Central
            ['P-27', [39.43840, -0.36240]], // Santos Juanes
            ['P-28', [39.43840, -0.36240]], // Santos Juanes
            ['P-29', [39.43800, -0.36180]], // Lonja Pecados
            ['P-30', [39.43800, -0.36180]], // Lonja √É∆í√Ç¬°rbol
            ['P-31', [39.43760, -0.36120]], // Lonja G√É∆í√Ç¬°rgolas
            ['P-32', [39.43760, -0.36120]], // Lonja barbudo
            ['P-33', [39.43760, -0.36120]], // Lonja fornicador
            ['P-34', [39.43720, -0.36060]], // Fuente Negrito
            ['P-35', [39.43680, -0.36000]], // Palau Generalitat
            ['P-36', [39.44859, -0.37489]]  // Torres Serranos Final
        ]);
        
        coordenadas.forEach((coords, paradaId) => {
            coordenadasParadas.set(paradaId, coords);
        });
        
        console.log('√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬ç Coordenadas de paradas inicializadas:', coordenadasParadas.size, 'paradas');
    }

    // ================== INICIALIZACI√É∆í√¢‚Ç¨≈ìN DEL MAPA ==================
    function inicializarMapa() {
        try {
            console.log('√É¬∞√Ö¬∏√¢‚Ç¨¬ù√Ç¬ç Iniciando inicializaci√É∆í√Ç¬≥n del mapa...');
            
            if (typeof L === 'undefined') {
                throw new Error('La biblioteca Leaflet no est√É∆í√Ç¬° cargada correctamente');
            }
            
            const valenciaCoords = [39.44859, -0.37489];
            const mapContainer = document.getElementById('mapa');
            
            if (!mapContainer) {
                throw new Error('No se encontr√É∆í√Ç¬≥ el contenedor del mapa');
            }
            
            mapContainer.style.display = 'block';
            
            mapa = L.map('mapa', {
                center: valenciaCoords,
                zoom: 16,
                zoomControl: false,
                scrollWheelZoom: true,
                doubleClickZoom: true,
                boxZoom: true,
                rotate: false,
                touchRotate: false,
                bearing: 0,
                preferCanvas: true
            });
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '√É‚Äö√Ç¬© OpenStreetMap contributors',
                detectRetina: true
            }).addTo(mapa);
            
            mapa.whenReady(() => {
                console.log('√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Mapa cargado correctamente');
                mapInitialized = true;
                window.mapa = mapa;
                
                setTimeout(() => {
                    mapa.invalidateSize({ animate: true });
                    
                    // Inicializar coordenadas y crear marcadores
                    inicializarCoordenadasParadas();
                    crearMarcadoresIniciales();
                    
                }, 100);
            });
            
            mapa.on('error', (error) => {
                console.error('√É¬¢√Ç¬ù√Ö‚Äô Error en el mapa:', error);
                mostrarErrorEnInterfaz('Error en el mapa: ' + (error.message || 'Error desconocido'));
            });
            
            return mapa;
            
        } catch (error) {
            console.error('√É¬¢√Ç¬ù√Ö‚Äô Error al inicializar el mapa:', error);
            mostrarErrorEnInterfaz(
                'Error al cargar el mapa: ' + (error.message || 'Error desconocido'),
                () => inicializarMapa()
            );
            return null;
        }
    }

    // ================== FUNCIONES DE MARCADORES ==================
    function crearMarcadoresIniciales() {
        console.log('√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬ç Creando marcadores iniciales...');
        
        // Crear marcadores para todas las paradas
        AVENTURA_PARADAS.forEach((item, index) => {
            if (item.tipo === 'parada' || item.tipo === 'inicio') {
                crearMarcadorParada(item.parada_id, index);
            }
        });
        
        console.log(`√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ ${marcadoresParadas.size} marcadores de paradas creados`);
    }
    
    function crearMarcadorParada(paradaId, index = 0) {
        const coords = coordenadasParadas.get(paradaId);
        if (!coords) {
            console.warn(`√É¬¢√Ö¬°√Ç¬†√É¬Ø√Ç¬∏√Ç¬è No se encontraron coordenadas para ${paradaId}`);
            return null;
        }
        
        const esActual = index === window.paradaActual;
        const esPasada = index < window.paradaActual;
        
        let color = '#9E9E9E'; // Gris por defecto
        let className = 'marcador-futuro';
        
        if (esActual) {
            color = '#4CAF50'; // Verde para actual
            className = 'marcador-actual';
        } else if (esPasada) {
            color = '#2196F3'; // Azul para visitadas
            className = 'marcador-visitada';
        }
        
        const marcador = L.circleMarker(coords, {
            radius: 8,
            fillColor: color,
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8,
            className: className
        });
        
        // Obtener informaci√É∆í√Ç¬≥n de la parada
        const infoParada = AVENTURA_PARADAS[index];
        let popupContent = `<b>Parada ${paradaId}</b><br>`;
        
        if (infoParada.reto_id) {
            popupContent += `Reto: ${infoParada.reto_id}<br>`;
        }
        if (infoParada.retos) {
            popupContent += `Retos: ${infoParada.retos.map(r => r.id).join(', ')}<br>`;
        }
        
        marcador.bindPopup(popupContent);
        marcador.addTo(mapa);
        
        marcadoresParadas.set(paradaId, marcador);
        
        return marcador;
    }
    
    function actualizarMarcadorParada(paradaId, estado = 'actual') {
        const marcador = marcadoresParadas.get(paradaId);
        if (!marcador) return;
        
        const colores = {
            'actual': '#4CAF50',
            'visitada': '#2196F3',
            'futuro': '#9E9E9E',
            'objetivo': '#FF5722'
        };
        
        marcador.setStyle({
            fillColor: colores[estado] || colores.futuro,
            radius: estado === 'actual' ? 10 : 8
        });
    }
    
    function crearMarcadorUsuario(lat, lng, tipo = 'usuario') {
        const colores = {
            'usuario': '#E91E63',
            'destino': '#FF5722',
            'temporal': '#FFC107'
        };
        
        const marcador = L.circleMarker([lat, lng], {
            radius: 6,
            fillColor: colores[tipo],
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 1
        });
        
        marcador.addTo(mapa);
        marcadoresUsuario.set(tipo, marcador);
        
        return marcador;
    }

    // ================== FUNCIONES DE GEOLOCALIZACI√É∆í√¢‚Ç¨≈ìN ==================
    function iniciarSeguimientoGPS() {
        if (!navigator.geolocation) {
            console.error('√É¬¢√Ç¬ù√Ö‚Äô Geolocalizaci√É∆í√Ç¬≥n no soportada');
            mostrarErrorEnInterfaz('Tu dispositivo no soporta geolocalizaci√É∆í√Ç¬≥n');
            return false;
        }
        
        const opciones = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 30000
        };
        
        watchId = navigator.geolocation.watchPosition(
            (position) => {
                const { latitude, longitude, accuracy } = position.coords;
                actualizarPosicionUsuario(latitude, longitude, accuracy);
            },
            (error) => {
                console.error('√É¬¢√Ç¬ù√Ö‚Äô Error de geolocalizaci√É∆í√Ç¬≥n:', error);
                mostrarErrorEnInterfaz(`Error GPS: ${error.message}`);
            },
            opciones
        );
        
        console.log('√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬ç Seguimiento GPS iniciado');
        return true;
    }
    
    function detenerSeguimientoGPS() {
        if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
            console.log('√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬ç Seguimiento GPS detenido');
        }
    }
    
    function actualizarPosicionUsuario(lat, lng, accuracy = 0) {
        // Actualizar o crear marcador de posici√É∆í√Ç¬≥n
        if (capaPosicionUsuario) {
            mapa.removeLayer(capaPosicionUsuario);
        }
        
        capaPosicionUsuario = L.circleMarker([lat, lng], {
            radius: 8,
            fillColor: '#E91E63',
            color: '#fff',
            weight: 3,
            opacity: 1,
            fillOpacity: 1
        }).addTo(mapa);
        
        // Agregar c√É∆í√Ç¬≠rculo de precisi√É∆í√Ç¬≥n si es necesario
        if (accuracy > 0 && accuracy < 100) {
            L.circle([lat, lng], {
                radius: accuracy,
                fillColor: 'transparent',
                color: '#E91E63',
                weight: 1,
                opacity: 0.3
            }).addTo(mapa);
        }
        
        // Notificar a los hijos usando el sistema centralizado
        enviarMensajeMultiple('GPS.ACTUALIZAR', {
            lat, lng, accuracy, timestamp: Date.now()
        }, 'GPS');
        
        console.log(`√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬ç Posici√É∆í√Ç¬≥n actualizada: ${lat}, ${lng} (√É‚Äö√Ç¬±${accuracy}m)`);
    }

    // ================== FUNCIONES DE RUTAS Y NAVEGACI√É∆í√¢‚Ç¨≈ìN ==================
    function crearRuta(origen, destino, tipo = 'walking') {
        if (!origen || !destino) {
            console.error('√É¬¢√Ç¬ù√Ö‚Äô Origen o destino no definidos para la ruta');
            return null;
        }
        
        // Para simplicidad, crear una l√É∆í√Ç¬≠nea directa
        // En producci√É∆í√Ç¬≥n, usar un servicio de routing como OpenRouteService
        const ruta = L.polyline([origen, destino], {
            color: '#2196F3',
            weight: 4,
            opacity: 0.8,
            dashArray: tipo === 'estimated' ? '5, 10' : null
        });
        
        ruta.addTo(mapa);
        
        const rutaId = `ruta_${Date.now()}`;
        rutasActivas.set(rutaId, ruta);
        
        return rutaId;
    }
    
    function eliminarRuta(rutaId) {
        const ruta = rutasActivas.get(rutaId);
        if (ruta) {
            mapa.removeLayer(ruta);
            rutasActivas.delete(rutaId);
            return true;
        }
        return false;
    }
    
        });
        
        // Manejador de navegaci√É∆í√Ç¬≥n - EXTENDIDO PARA MAPA
        mensajeria.registrarControlador('NAVEGACION.ESTADO', (mensaje) => {
            console.log(`√É¬∞√Ö¬∏√Ç¬ß√Ç¬≠ Navegaci√É∆í√Ç¬≥n desde ${mensaje.origen}:`, mensaje.datos);
            
            // Manejar navegaci√É∆í√Ç¬≥n a paradas
            if (mensaje.datos.accion === 'navegar_parada' && mensaje.datos.paradaId) {
                if (window.mapaFunciones) {
                    window.mapaFunciones.navegarAParada(mensaje.datos.paradaId);
                }
            }
            
            // Manejar centrado del mapa
            if (mensaje.datos.accion === 'centrar_mapa' && mensaje.datos.lat && mensaje.datos.lng) {
                if (window.mapaFunciones) {
                    window.mapaFunciones.centrarMapa(mensaje.datos.lat, mensaje.datos.lng, mensaje.datos.zoom);
                }
            }
            
            // Manejar actualizaci√É∆í√Ç¬≥n de parada actual
            if (mensaje.datos.accion === 'actualizar_parada' && mensaje.datos.paradaId) {
                if (window.mapaFunciones) {
                    window.mapaFunciones.actualizarMarcadorParada(mensaje.datos.paradaId, mensaje.datos.estado || 'actual');
                    // Actualizar variable global
                    if (mensaje.datos.estado === 'actual') {
                        const paradaIndex = AVENTURA_PARADAS.findIndex(p => p.parada_id === mensaje.datos.paradaId);
                        if (paradaIndex !== -1) {
                            window.paradaActual = paradaIndex;
                        }
                    }
                }
            }
        });
        
        // Manejador de audio
        mensajeria.registrarControlador('AUDIO.ESTADO', (mensaje) => {
            console.log(`√É¬∞√Ö¬∏√¢‚Ç¨¬ù√Ö¬† Audio desde ${mensaje.origen}:`, mensaje.datos);
        });
        
        // Manejador de retos
        mensajeria.registrarControlador('RETO.ESTADO', (mensaje) => {
            console.log(`√É¬∞√Ö¬∏√Ö¬Ω√Ç¬Ø Reto desde ${mensaje.origen}:`, mensaje.datos);
        });
        
        // Manejador de GPS - EXTENDIDO PARA MAPA
        mensajeria.registrarControlador('GPS.COMANDO', (mensaje) => {
            console.log(`√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬° Comando GPS desde ${mensaje.origen}:`, mensaje.datos);
            
            if (mensaje.datos.accion === 'iniciar_seguimiento') {
                if (window.mapaFunciones) {
                    window.mapaFunciones.iniciarSeguimientoGPS();
                }
            }
            
            if (mensaje.datos.accion === 'detener_seguimiento') {
                if (window.mapaFunciones) {
                    window.mapaFunciones.detenerSeguimientoGPS();
                }
            }
            
            if (mensaje.datos.accion === 'crear_marcador' && mensaje.datos.lat && mensaje.datos.lng) {
                if (window.mapaFunciones) {
                    window.mapaFunciones.crearMarcadorUsuario(mensaje.datos.lat, mensaje.datos.lng, mensaje.datos.tipo || 'usuario');
                }
            }
        });
        
        // Manejador de confirmaciones
        mensajeria.registrarControlador('SISTEMA.CONFIRMACION', (mensaje) => {
            console.log(`√É¬¢√Ö‚Äú√¢‚Ç¨≈ì Confirmaci√É∆í√Ç¬≥n de ${mensaje.origen}:`, mensaje.datos);
        });
        
        // Manejador de errores
        mensajeria.registrarControlador('SISTEMA.ERROR', (mensaje) => {
            console.error(`√É¬¢√Ç¬ù√Ö‚Äô Error de ${mensaje.origen}:`, mensaje.datos);
        });
        
        console.log('√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Manejadores de mensajes configurados');
    }
    
    // ================== INICIALIZACI√É∆í√¢‚Ç¨≈ìN PRINCIPAL ==================
    async function inicializarAplicacion() {
        console.log('√É¬∞√Ö¬∏√Ö¬°√¢‚Äö¬¨ Inicializando aplicaci√É∆í√Ç¬≥n...');
        
        try {
            // 1. Inicializar mensajer√É∆í√Ç¬≠a
            await inicializarMensajeria();
            
            // 2. Inicializar mapa
            inicializarMapa();
            
            // 3. Configurar overlay de medios
            const overlay = document.getElementById('media-overlay');
            if (overlay) {
                overlay.onclick = closeMediaOverlay;
            }
            
            // 4. Establecer variables globales
            window.paradaActual = 0;
            
            // 5. Hacer funciones accesibles globalmente - SISTEMA CENTRALIZADO
            window.enableControls = enableControls;
            window.disableControls = disableControls;
            window.enviarMensajeOptimizado = enviarMensajeOptimizado;
            window.enviarMensajeMultiple = enviarMensajeMultiple;
            window.enviarComandoAudio = enviarComandoAudio;
            window.actualizarCoordenadas = actualizarCoordenadas;
            window.enviarReto = enviarReto;
            window.sincronizarEstado = sincronizarEstado;
            window.actualizarUITodos = actualizarUITodos;
            
            // Funciones espec√É∆í√Ç¬≠ficas del mapa usando el sistema centralizado
            window.navegarAParada = navegarAParada;
            window.centrarMapaEn = centrarMapaEn;
            window.actualizarParadaActual = actualizarParadaActual;
            window.iniciarGPS = iniciarGPS;
            window.detenerGPS = detenerGPS;
            
            // Funciones de interfaz
            window.mostrarMensajeInfoParada = mostrarMensajeInfoParada;
            window.ocultarInfoParada = ocultarInfoParada;
            window.mostrarImagenOverlay = mostrarImagenOverlay;
            window.closeMediaOverlay = closeMediaOverlay;
            window.mostrarErrorEnInterfaz = mostrarErrorEnInterfaz;
            
            // Datos y configuraciones
            window.CONFIGURACIONES_MENSAJE = CONFIGURACIONES_MENSAJE;
            window.AVENTURA_PARADAS = AVENTURA_PARADAS;
            
            // Esperar a que el mapa est√É∆í√Ç¬© listo antes de exponer las funciones
            const esperarMapa = setInterval(() => {
                if (window.mapaFunciones && window.mapaFunciones.estaInicializado()) {
                    console.log('√É¬∞√Ö¬∏√¢‚Ç¨‚Äù√Ç¬∫√É¬Ø√Ç¬∏√Ç¬è Funciones de mapa disponibles para los hijos');
                    clearInterval(esperarMapa);
                    
                    // Notificar a los hijos que el mapa est√É∆í√Ç¬° listo usando el sistema centralizado
                    setTimeout(() => {
                        enviarMensajeMultiple('SISTEMA.SINCRONIZAR', {
                            mapaListo: true,
                            funcionesDisponibles: [
                                'navegarAParada',
                                'centrarMapaEn', 
                                'actualizarParadaActual',
                                'iniciarGPS',
                                'detenerGPS'
                            ],
                            paradaActual: window.paradaActual,
                            coordenadasDisponibles: window.mapaFunciones.obtenerTodasParadas()
                        }, 'SYNC');
                    }, 1000);
                }
            }, 100);
            
            console.log('√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Aplicaci√É∆í√Ç¬≥n inicializada correctamente');
            
        } catch (error) {
            console.error('√É¬¢√Ç¬ù√Ö‚Äô Error al inicializar la aplicaci√É∆í√Ç¬≥n:', error);
            mostrarErrorEnInterfaz('Error cr√É∆í√Ç¬≠tico al inicializar la aplicaci√É∆í√Ç¬≥n');
        }
    }
    
    // ================== EVENTOS DE INICIALIZACI√É∆í√¢‚Ç¨≈ìN ==================
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializarAplicacion);
    } else {
        inicializarAplicacion();
    }
    
    // Forzar inicializaci√É∆í√Ç¬≥n adicional despu√É∆í√Ç¬©s de la carga completa
    window.addEventListener('load', () => {
        setTimeout(() => {
            if (mapa && mapa.invalidateSize) {
                mapa.invalidateSize(true);
                console.log('√É¬∞√Ö¬∏√¢‚Ç¨¬ù√¢‚Ç¨≈æ Tama√É∆í√Ç¬±o del mapa actualizado');
            }
        }, 500);
    });
    
    </script>
</head>
<body>
    <!-- Contenedor del mapa -->
    <div id="mapa"></div>

    <img id="logo-aventura" src="https://valenciavguides.github.io/Aventura-1-esp-padre-con-hijos/fotos_Av1/LOGO%20LETRAS%20FINAL%20transparente%20recorte.png" alt="Logo" style="position: fixed; top: -32px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 360px; height: 140px;" />

    <div id="info-parada"></div>
    
    <!-- Fondo blanco para el logo con borde naranja -->
    <div style="position: fixed; top: 0; left: 0; right: 0; width: 99%; margin: 0 auto; height: 80px; background: white; z-index: 2999; border: 2px solid #ec7c26; border-top: none; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;"></div>

    <!-- Rutas actualizadas para GitHub Pages -->
    <iframe id="hijo1-hamburguesa" src="./botones-y-subfunciones-hamburguesa.html" style="position:fixed; left:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; border: transparent; background:transparent; pointer-events:auto;"></iframe>
    <iframe id="hijo1-opciones" src="./botones-y-subfunciones-opciones.html" style="position:fixed; right:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; border: transparent; background:transparent; pointer-events:auto;"></iframe>
    <iframe id="hijo5-casa" src="./Av1-boton-casa.html" style="position:fixed; right:0; top:70px; width:99%; height:85px; z-index:10000; border: 1px solid red; background:transparent; pointer-events:auto; margin:0; padding:0; overflow:hidden; border-radius:0;"></iframe>

    <iframe id="hijo3" src="./Av1_audio_esp.html"
            style="position:fixed;
                   bottom:-6px;
                   left:50%;
                   transform:translateX(-50%);
                   height:165px;
                   width:310px;
                   z-index:1000;
                   border: transparent;
                   display:block;
                   pointer-events:auto;"></iframe>

    <iframe id="hijo2" src="./Av1-botones-coordenadas.html"
            style="position:fixed;
                   bottom:150px;
                   left:50%;
                   transform:translateX(-50%);
                   height:165px;
                   width:310px;
                   z-index:1001;
                   border: none !important;
                   background-color: transparent !important;
                   overflow: hidden;
                   pointer-events:auto;"
            allow="geolocation"
            frameborder="0"></iframe>

    <iframe id="hijo4" src="./Av1-esp-retos-preguntas.html" style="display:none;"></iframe>

    <div id="media-overlay">
        <div id="media-container">
            <button id="close-media">X</button>
            <video id="parada-video" controls></video>
            <img id="parada-imagen">
        </div>
    </div>
    
    <!-- Scripts de Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Scripts principales -->
    <script>
    'use strict';
    
    // ================== VARIABLES GLOBALES ==================
    let mapa = null;
    let mensajeria = null;
    let mapInitialized = false;
    
    // Variables globales
    window.paradaActual = 0;
    
    // ================== CONFIGURACIONES ==================
    const CONFIGURACIONES_MENSAJE = {
        UI: {
            maxReintentos: 1,
            timeout: 800,
            esperarRespuesta: false
        },
        AUDIO: {
            maxReintentos: 3,
            timeout: 5000,
            esperarRespuesta: true
        },
        GPS: {
            maxReintentos: 5,
            timeout: 10000,
            esperarRespuesta: true
        },
        RETO: {
            maxReintentos: 2,
            timeout: 3000,
            esperarRespuesta: true
        },
        SYNC: {
            maxReintentos: 3,
            timeout: 8000,
            esperarRespuesta: false
        }
    };
    
    // ================== ESTRUCTURA DE DATOS ==================
    const AVENTURA_PARADAS = [
        // Parada 0 √É¬¢√¢‚Äö¬¨√¢‚Ç¨≈ì INICIO (Torres de Serranos start) reto 2 (223, 226, 228, 229)//
        { tipo: "inicio", parada_id: 'P-0', audio_id: "audio-P-0", reto_id: "R-2" },
        // tramo 1 (Torres de Serranos √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Plaza de la crida) (2, 126,)//
        { tipo: "tramo", tramo_id: 'TR-1', audio_id: "audio-TR-1" },
        // Parada 1 - Plaza de la crida (Puente de Serranos) Reto 3 (233) //
        { tipo: "parada", parada_id: 'P-1', audio_id: "audio-P-1", reto_id: "R-3" },
        // tramo 2 (Plaza de la crida √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Calle Muro de Santa Ana) (81) //
        { tipo: "tramo", tramo_id: 'TR-2', audio_id: "audio-TR-2" },
        // Parada 2 (Calle Muro de Santa Ana) Reto 4 (68) //
        { tipo: "parada", parada_id: 'P-2', audio_id: "audio-P-2", reto_id: "R-4" },
        // tramo 3 (Calle Muro de Santa Ana √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Palacio de los Borgia) (52) //
        { tipo: "tramo", tramo_id: 'TR-3', audio_id: "audio-TR-3" },
        // Parada 3 (Iglesia de San Lorenzo) Reto 5 (686, 682-B, 462, 683, 684) //
        { tipo: "parada", parada_id: 'P-3', audio_id: "audio-P-3", reto_id: "R-5" },
        // tramo 4 (Iglesia de San Lorenzo √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Plaza de la Virgen) (465-B) //
        { tipo: "tramo", tramo_id: 'TR-4', audio_id: "audio-TR-4" },
        // Parada 4 (Plaza de la Virgen) Reto 6 (466, 467) //
        { tipo: "parada", parada_id: 'P-4', audio_id: "audio-P-4", reto_id: "R-6" },
        // Parada 5 (Plaza de la Virgen) Reto 7, 8 Puzzle plaza de la virgen (468)  //
        { 
            tipo: "parada", 
            parada_id: 'P-5', 
            audio_id: "audio-P-5", 
            retos: [
                { tipo: "reto", id: "R-7" },
                { tipo: "puzzle", id: "PZ-8" }
            ] 
        },
        // tramo 5 (Plaza de la Virgen √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Plaza de la Almo√É∆í√Ç¬≠na) (477-B, 479, 141, 83, 8-C) //
        { tipo: "tramo", tramo_id: 'TR-5', audio_id: "audio-TR-5" },
        // Parada 6 (Panel cer√É∆í√Ç¬°mico muro Catedral) Reto 9 (434, 440, 441, 442) //
        { tipo: "parada", parada_id: 'P-6', audio_id: "audio-P-6", reto_id: "R-9" },
        // Parada 7 (Capilla exterior catedral) Reto 10 (443, 444, 445) //
        { tipo: "parada", parada_id: 'P-7', audio_id: "audio-P-7", reto_id: "R-10" },
        // Parada 8 (Capilla exterior catedral) Reto 11 (445) //
        { tipo: "parada", parada_id: 'P-8', audio_id: "audio-P-8", reto_id: "R-11" },
        // Parada 9 (Arco Novo Catedral y Puerta Negra Bas√É∆í√Ç¬≠lica) (446, 355, 447, 11-B, 451, 452) //
        { tipo: "parada", parada_id: 'P-9', audio_id: "audio-P-9" },
        // Parada 10 (Casa del Punt de Gantxo) Reto 12 (51-C, 454, 455, 455-B, 456, 148) //
        { tipo: "parada", parada_id: 'P-10', audio_id: "audio-P-10", reto_id: "R-12"  },
        // tramo 6 (Plaza de la Almo√É∆í√Ç¬≠na (casa del punt de Gantxo) √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Plaza Decimo Junio Bruto) (457, 10-B)//
        { tipo: "tramo", tramo_id: 'TR-6', audio_id: "audio-TR-6" },
        // Parada 11 (Museo arqueol√É∆í√Ç¬≥gico La Almo√É∆í√Ç¬≠na) Reto 13 (458) //
        { tipo: "parada", parada_id: 'P-11', audio_id: "audio-P-11", reto_id: "R-13" },
        // Parada 12 (Museo arqueol√É∆í√Ç¬≥gico La Almo√É∆í√Ç¬≠na 2) (459, 460, 461) //
        { tipo: "parada", parada_id: 'P-12', audio_id: "audio-P-12" },
        // Parada 13 (Vista de la Catedral, Cimborrio) Reto 14 (8-C, 464) //
        { tipo: "parada", parada_id: 'P-13', audio_id: "audio-P-13", reto_id: "R-14" },
        // tramo 7 (Museo arqueol√É∆í√Ç¬≥gico La Almo√É∆í√Ç¬≠na √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Palacio Arzobispal) (85) //
        { tipo: "tramo", tramo_id: 'TR-7', audio_id: "audio-TR-7" },
        // Parada 14 (Palacio Arzobispal y Puerta Rom√É∆í√Ç¬°nica de la Catedral) Reto 15 (673, 86, 426-B, 141, 437, 438) //
        { tipo: "parada", parada_id: 'P-14', audio_id: "audio-P-14", reto_id: "R-15" },
        // Parada 15 (Puerta Rom√É∆í√Ç¬°nica de la Catedral) (439) //
        { tipo: "parada", parada_id: 'P-15', audio_id: "audio-P-15" },
        // tramo 8 (Puerta Rom√É∆í√Ç¬°nica de la Catedral √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Plaza del Ayuntamiento) (125) //
        { tipo: "tramo", tramo_id: 'TR-8', audio_id: "audio-TR-8" },
        // Parada 16 (Plaza del Ayuntamiento) (13-B, 263, 332, 14-C) //
        { tipo: "parada", parada_id: 'P-16', audio_id: "audio-P-16" },
        // tramo 9 (Plaza del Ayuntamiento √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Edificio del Ayuntamiento) (334, 335) //
        { tipo: "tramo", tramo_id: 'TR-9', audio_id: "audio-TR-9" },
        // Parada 17 (Edificio del Ayuntamiento) Reto 16 (336, 337, 338) //
        { tipo: "parada", parada_id: 'P-17', audio_id: "audio-P-17", reto_id: "R-16" },
        // Parada 18 (Edificio del Ayuntamiento, leyenda del murci√É∆í√Ç¬©lago) (339, 340, 341, 54) //
        { tipo: "parada", parada_id: 'P-18', audio_id: "audio-P-18" },
        // tramo 10 (Edificio del Ayuntamiento √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Estaci√É∆í√Ç¬≥n del Norte) (87, 15-C) //
        { tipo: "tramo", tramo_id: 'TR-10', audio_id: "audio-TR-10" },
        // Parada 19 (Estaci√É∆í√Ç¬≥n del Norte) Reto 17, 18 Puzzle Estaci√É∆í√Ç¬≥n del Norte (326) //
        { 
            tipo: "parada", 
            parada_id: 'P-19', 
            audio_id: "audio-P-19", 
            retos: [
                { tipo: "reto", id: "R-17" },
                { tipo: "puzzle", id: "PZ-18" }
            ] 
        },
        // tramo 11 (Estaci√É∆í√Ç¬≥n del Norte √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Plaza de Toros) (20-C, 323-B, 88) //
        { tipo: "tramo", tramo_id: 'TR-11', audio_id: "audio-TR-11" },
        // Tramo 12 (Plaza de Toros √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Casa estilo √É∆í√Ç¬Årabe) (89, 3-D) //
        { tipo: "tramo", tramo_id: 'TR-12', audio_id: "audio-TR-12" },
        // Parada 20 (Casa estilo √É∆í√Ç¬Årabe) Reto 19 (99) //
        { tipo: "parada", parada_id: 'P-20', audio_id: "audio-P-20", reto_id: "R-19" },
        // Parada 21 (Casa estilo √É∆í√Ç¬Årabe, mitad Aventura) (100) //
        { tipo: "parada", parada_id: 'P-21', audio_id: "audio-P-21" },
        // tramo 13 (Casa estilo √É∆í√Ç¬Årabe √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Palacio de Comunicaciones) (21-B) //
        { tipo: "tramo", tramo_id: 'TR-13', audio_id: "audio-TR-13" },
        // Parada 22 (Palacio de Comunicaciones) Reto 20 y Reto 21 (700, 343, 344) //
        { tipo: "parada", parada_id: 'P-22', audio_id: "audio-P-22", retos: ["R-20", "R-21"] },
        // Parada 23 (Edificio Suay) Reto 21 (693, 693-B) //
        { tipo: "parada", parada_id: 'P-23', audio_id: "audio-P-23" ,reto_id: "R-21" },
        // tramo 14 (Palacio de Comunicaciones, edificio Suay √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Banco de Val√É∆í√Ç¬®ncia) (345, 347, 348, 22, 109) //
        { tipo: "tramo", tramo_id: 'TR-14', audio_id: "audio-TR-14" },
        // Parada 24 (Banco de Valencia) Reto 22 (349, 350) //
        { tipo: "parada", parada_id: 'P-24', audio_id: "audio-P-24", reto_id: "R-22" },
        // tramo 15 (Banco de Val√É∆í√Ç¬®ncia √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Palacio del Marqu√É∆í√Ç¬©s de Dos Aguas) (351, 23-B, 352, 354) //
        { tipo: "tramo", tramo_id: 'TR-15', audio_id: "audio-TR-15" },
        // Parada 25 (Palacio del Marqu√É∆í√Ç¬©s de Dos Aguas) (356, 357)//
        { tipo: "parada", parada_id: 'P-25', audio_id: "audio-P-25" },
        // tramo 16 (Palacio del Marqu√É∆í√Ç¬©s √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Mercado Central) (358, 359-B, 101) //
        { tipo: "tramo", tramo_id: 'TR-16', audio_id: "audio-TR-16" },
        // Parada 26 (Mercado central) Reto23 (701, 24-D, 361, 362, 363, 364) //
        { tipo: "parada", parada_id: 'P-26', audio_id: "audio-P-26", reto_id: "R-23" },
        // tramo 17 (Mercado Central √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Iglesia de los Santos Juanes) (274, 27-C) //
        { tipo: "tramo", tramo_id: 'TR-17', audio_id: "audio-TR-17" },
        // Parada 27 (Iglesia de los Santos Juanes) Reto 24) (365, 366) //
        { tipo: "parada", parada_id: 'P-27', audio_id: "audio-P-27", reto_id: "R-24" },
        // Parada 28 (Iglesia de los Santos Juanes reto 25) (367) //
        { tipo: "parada", parada_id: 'P-28', audio_id: "audio-P-28", reto_id: "R-25" },
        // tramo 18 (Iglesia Santos Juanes √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Lonja de Val√É∆í√Ç¬®ncia) (368, 369, 28, 370, 371, 372, 373, 374, 375, 376, 377) //
        { tipo: "tramo", tramo_id: 'TR-18', audio_id: "audio-TR-18" },
        // Parada 29 (Lonja Puerta de Los Pecados barquero) Reto 27 (378, 379) //
        { tipo: "parada", parada_id: 'P-29', audio_id: "audio-P-29", reto_id: "R-27" },
        // Parada 30 (Lonja Puerta de Los Pecados √É∆í√Ç¬°rbol muerto) Reto 28 (380, 381) //
        { tipo: "parada", parada_id: 'P-30', audio_id: "audio-P-30", reto_id: "R-28" },
        // tramo 19 (Lonja G√É∆í√Ç¬°rgolas) (383) //
        { tipo: "tramo", tramo_id: 'TR-19', audio_id: "audio-TR-19" },
        // Parada 31 (Lonja G√É∆í√Ç¬°rgolas √É∆í√Ç¬°ngel vasija) Reto 29 (384) //
        { tipo: "parada", parada_id: 'P-31', audio_id: "audio-P-31", reto_id: "R-29" },
        // Parada 32 (Lonja G√É∆í√Ç¬°rgolas barbudo y le√É∆í√Ç¬≥n) Reto 30 (385) //
        { tipo: "parada", parada_id: 'P-32', audio_id: "audio-P-32", reto_id: "R-30" },
        // Parada 33 (Lonja G√É∆í√Ç¬°rgolas fornicador ventana) Reto 31, Puzzle 26 ) (386) //
        { tipo: "parada", parada_id: 'P-33', audio_id: "audio-P-33", retos: [ { tipo: "reto", id: "R-31" }, { tipo: "puzzle", id: "PZ-26" } ] },
        // tramo 20 (Lonja √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Plaza del Doctor Collado) (388, 389, 390, 391, 392) //
        { tipo: "tramo", tramo_id: 'TR-20', audio_id: "audio-TR-20" },
        // tramo 21 (Plaza del Doctor Collado √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Plaza del Negrito) (333, 397, 41, 398, 198, 671, 522, 32-C) //
        { tipo: "tramo", tramo_id: 'TR-21', audio_id: "audio-TR-21" },
        // Parada 34 (Fuente del Negrito) Reto 32 (382, 501) //
        { tipo: "parada", parada_id: 'P-34', audio_id: "audio-P-34", reto_id: "R-32" },
        // tramo 22 (Plaza del Negrito √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Calle Caballeros) (33-B, 486, 480-B) //
        { tipo: "tramo", tramo_id: 'TR-22', audio_id: "audio-TR-22" },
        // Parada 35 (Palau de la Generalitat) (481-B, 482-B, 2-D) //
        { tipo: "parada", parada_id: 'P-35', audio_id: "audio-P-35" },
        // tramo 23 (Palacio de la Generalitat √É¬¢√¢‚Ç¨¬†√¢‚Ç¨‚Ñ¢ Calle de los Serranos - FINAL)  //
        { tipo: "tramo", tramo_id: 'TR-23', audio_id: "audio-TR-23" },
        // Parada 36 (Torres de Serranos Final) //
        { tipo: "parada", parada_id: 'P-36', audio_id: "audio-P-36" }
    ];
    
    // ================== FUNCIONES DE MANEJO DE ERRORES ==================
    function mostrarErrorEnInterfaz(mensaje, onRetry = null, opciones = {}) {
        const config = {
            tiempo: 10000,
            tipo: 'error',
            cerrable: true,
            ...opciones
        };
        
        // Eliminar mensajes anteriores
        const erroresAnteriores = document.querySelectorAll('.error-mensaje');
        erroresAnteriores.forEach(el => {
            if (!el.hasAttribute('data-persistente')) {
                el.remove();
            }
        });
        
        // Crear contenedor del mensaje
        const errorMsg = document.createElement('div');
        errorMsg.className = `error-mensaje error-tipo-${config.tipo}`;
        
        const estilosPorTipo = {
            error: { backgroundColor: '#d32f2f', borderColor: '#b71c1c', icon: '√É¬¢√Ç¬ù√Ö‚Äô' },
            advertencia: { backgroundColor: '#ff9800', borderColor: '#f57c00', icon: '√É¬¢√Ö¬°√Ç¬†√É¬Ø√Ç¬∏√Ç¬è' },
            info: { backgroundColor: '#1976d2', borderColor: '#1565c0', icon: '√É¬¢√¢‚Ç¨≈æ√Ç¬π√É¬Ø√Ç¬∏√Ç¬è' }
        };
        
        const estilo = estilosPorTipo[config.tipo] || estilosPorTipo.error;
        errorMsg.style.backgroundColor = estilo.backgroundColor;
        errorMsg.style.borderLeft = `4px solid ${estilo.borderColor}`;
        
        let contenidoHTML = `
            <h3>${estilo.icon} ${config.tipo.charAt(0).toUpperCase() + config.tipo.slice(1)}</h3>
            <p>${mensaje}</p>
            <div class="error-botones">
        `;
        
        if (onRetry && typeof onRetry === 'function') {
            contenidoHTML += `<button class="error-btn error-btn-reintentar" data-action="reintentar">Reintentar</button>`;
        }
        
        if (config.cerrable) {
            contenidoHTML += `<button class="error-btn error-btn-cerrar" data-action="cerrar">Cerrar</button>`;
        }
        
        contenidoHTML += '</div>';
        errorMsg.innerHTML = contenidoHTML;
        
        // Manejadores de eventos
        errorMsg.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            
            const action = target.getAttribute('data-action');
            if (action === 'reintentar' && onRetry) {
                onRetry();
            }
            cerrarMensaje(errorMsg);
        });
        
        document.body.appendChild(errorMsg);
        
        // Auto-eliminar
        let timeoutId;
        if (config.tiempo > 0) {
            timeoutId = setTimeout(() => cerrarMensaje(errorMsg), config.tiempo);
        }
        
        function cerrarMensaje(elemento) {
            if (elemento && document.body.contains(elemento)) {
                elemento.style.animation = 'fadeOut 0.3s ease-in-out';
                setTimeout(() => elemento.remove(), 300);
                if (timeoutId) clearTimeout(timeoutId);
            }
        }
        
        return () => cerrarMensaje(errorMsg);
    }
    
    // ================== FUNCIONES DE CONTROL ==================
    async function enableControls(modo = 'casa') {
        console.log(`Habilitando controles en modo: ${modo}`);
        try {
            if (mensajeria && typeof mensajeria.enviarMensaje === 'function') {
                const opcionesUI = CONFIGURACIONES_MENSAJE.UI;
                
                const promesas = [
                    mensajeria.enviarMensaje('hijo2', 'habilitar_controles', { modo }, opcionesUI),
                    mensajeria.enviarMensaje('hijo3', 'habilitar_controles', { modo }, opcionesUI),
                    mensajeria.enviarMensaje('hijo4', 'habilitar_controles', { modo }, opcionesUI),
                    mensajeria.enviarMensaje('hijo5-casa', 'habilitar_controles', { modo }, opcionesUI)
                ];
                
                await Promise.allSettled(promesas);
                console.log(`√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Controles habilitados en modo: ${modo}`);
            }
        } catch (error) {
            console.error('Error al habilitar controles:', error);
        }
        return Promise.resolve();
    }

    async function disableControls(motivo = 'desconocido') {
        console.log(`Deshabilitando controles. Motivo: ${motivo}`);
        try {
            if (mensajeria && typeof mensajeria.enviarMensaje === 'function') {
                const opcionesUI = CONFIGURACIONES_MENSAJE.UI;
                
                const promesas = [
                    mensajeria.enviarMensaje('hijo2', 'deshabilitar_controles', { motivo }, opcionesUI),
                    mensajeria.enviarMensaje('hijo3', 'deshabilitar_controles', { motivo }, opcionesUI),
                    mensajeria.enviarMensaje('hijo4', 'deshabilitar_controles', { motivo }, opcionesUI),
                    mensajeria.enviarMensaje('hijo5-casa', 'deshabilitar_controles', { motivo }, opcionesUI)
                ];
                
                await Promise.allSettled(promesas);
                console.log(`√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Controles deshabilitados. Motivo: ${motivo}`);
            }
        } catch (error) {
            console.error('Error al deshabilitar controles:', error);
        }
        return Promise.resolve();
    }
    
    // ================== FUNCIONES DE MENSAJER√É∆í√Ç¬çA OPTIMIZADAS ==================
    async function enviarMensajeOptimizado(destino, tipo, datos = {}, categoria = 'UI') {
        if (!mensajeria) {
            throw new Error('Sistema de mensajer√É∆í√Ç¬≠a no inicializado');
        }
        
        const configuracion = CONFIGURACIONES_MENSAJE[categoria] || CONFIGURACIONES_MENSAJE.UI;
        
        try {
            const resultado = await mensajeria.enviarMensaje(destino, tipo, datos, configuracion);
            console.log(`√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬§ Mensaje enviado a ${destino}:`, tipo);
            return resultado;
        } catch (error) {
            console.error(`√É¬¢√Ç¬ù√Ö‚Äô Error enviando mensaje a ${destino}:`, error);
            throw error;
        }
    }
    
    async function enviarMensajeMultiple(tipo, datos = {}, categoria = 'UI') {
        const destinos = ['hijo2', 'hijo3', 'hijo4', 'hijo5-casa'];
        const configuracion = CONFIGURACIONES_MENSAJE[categoria] || CONFIGURACIONES_MENSAJE.UI;
        
        const promesas = destinos.map(destino => 
            enviarMensajeOptimizado(destino, tipo, datos, categoria)
                .catch(error => ({ destino, error }))
        );
        
        const resultados = await Promise.allSettled(promesas);
        
        const exitosos = resultados.filter(r => r.status === 'fulfilled').length;
        const fallidos = resultados.length - exitosos;
        
        console.log(`√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ö¬† Mensaje m√É∆í√Ç¬∫ltiple completado: ${exitosos} exitosos, ${fallidos} fallidos`);
        return { exitosos, fallidos, resultados };
    }
    
    // ================== FUNCIONES ESPEC√É∆í√Ç¬çFICAS DE COMUNICACI√É∆í√¢‚Ç¨≈ìN ==================
    async function enviarComandoAudio(comando, datos = {}) {
        return enviarMensajeOptimizado('hijo3', 'AUDIO.COMANDO', { comando, ...datos }, 'AUDIO');
    }
    
    async function actualizarCoordenadas(coordenadas) {
        return enviarMensajeOptimizado('hijo2', 'GPS.ACTUALIZAR', coordenadas, 'GPS');
    }
    
    async function enviarReto(retoData) {
        return enviarMensajeOptimizado('hijo4', 'RETO.NUEVO', retoData, 'RETO');
    }
    
    async function sincronizarEstado(estado) {
        return enviarMensajeMultiple('SISTEMA.SINCRONIZAR', estado, 'SYNC');
    }
    
    async function actualizarUITodos(datosUI) {
        return enviarMensajeMultiple('UI.ACTUALIZAR', datosUI, 'UI');
    }
    
    // ================== FUNCIONES ESPEC√É∆í√Ç¬çFICAS DEL MAPA ==================
    async function navegarAParada(paradaId, estado = 'objetivo') {
        return enviarMensajeMultiple('NAVEGACION.ESTADO', {
            accion: 'navegar_parada',
            paradaId: paradaId,
            estado: estado,
            timestamp: Date.now()
        }, 'GPS');
    }
    
    async function centrarMapaEn(lat, lng, zoom = 16) {
        return enviarMensajeMultiple('NAVEGACION.ESTADO', {
            accion: 'centrar_mapa',
            lat: lat,
            lng: lng,
            zoom: zoom,
            timestamp: Date.now()
        }, 'UI');
    }
    
    async function actualizarParadaActual(paradaId, estado = 'actual') {
        return enviarMensajeMultiple('NAVEGACION.ESTADO', {
            accion: 'actualizar_parada',
            paradaId: paradaId,
            estado: estado,
            timestamp: Date.now()
        }, 'UI');
    }
    
    async function iniciarGPS() {
        return enviarMensajeMultiple('GPS.COMANDO', {
            accion: 'iniciar_seguimiento',
            timestamp: Date.now()
        }, 'GPS');
    }
    
    async function detenerGPS() {
        return enviarMensajeMultiple('GPS.COMANDO', {
            accion: 'detener_seguimiento',
            timestamp: Date.now()
        }, 'GPS');
    }
    
    // ================== FUNCIONES DE INTERFAZ ==================
    function mostrarMensajeInfoParada(mensaje, esError = false) {
        const info = document.getElementById('info-parada');
        if (info) {
            info.textContent = mensaje;
            info.style.display = 'block';
            if (esError) {
                info.classList.add('error');
            } else {
                info.classList.remove('error');
            }
        }
    }
    
    function ocultarInfoParada() {
        const info = document.getElementById('info-parada');
        if (info) {
            info.style.display = 'none';
        }
    }
    
    function mostrarImagenOverlay(paradaId) {
        const overlay = document.getElementById('media-overlay');
        const img = document.getElementById('parada-imagen');
        const video = document.getElementById('parada-video');
        
        if (!overlay || !img) return;

        if (video) {
            video.style.display = 'none';
            video.pause && video.pause();
        }

        const rutaImagen = paradaId ? `./fotos_Av1/${paradaId}.jpg` : './fotos_Av1/default.jpg';
        img.src = rutaImagen;
        img.style.display = 'block';
        overlay.style.display = 'flex';

        const closeBtn = document.getElementById('close-media');
        if (closeBtn) {
            closeBtn.onclick = function(e) {
                e.stopPropagation();
                overlay.style.display = 'none';
                img.src = '';
            };
        }
    }
    
    function closeMediaOverlay() {
        const mediaOverlay = document.getElementById('media-overlay');
        if (mediaOverlay) {
            mediaOverlay.style.display = 'none';
            const mediaElement = mediaOverlay.querySelector('video, audio');
            if (mediaElement) {
                mediaElement.pause();
                mediaElement.currentTime = 0;
            }
        }
        
        // Notificar a los hijos
        ['hijo2', 'hijo3', 'hijo4', 'hijo5-casa'].forEach(id => {
            try {
                if (mensajeria) {
                    mensajeria.enviarMensaje(id, 'mediaOverlayClosed', {});
                }
            } catch (error) {
                console.error(`Error notificando a ${id}:`, error);
            }
        });
    }
    
    // ================== VARIABLES Y CAPAS DEL MAPA ==================
    let marcadoresParadas = new Map();
    let marcadoresUsuario = new Map();
    let rutasActivas = new Map();
    let capaPosicionUsuario = null;
    let watchId = null;
    let coordenadasParadas = new Map();
    
    // Inicializar coordenadas de las paradas
    function inicializarCoordenadasParadas() {
        // Coordenadas reales de Valencia para cada parada
        const coordenadas = new Map([
            ['P-0', [39.44859, -0.37489]], // Torres de Serranos
            ['P-1', [39.44799, -0.37520]], // Plaza de la Crida
            ['P-2', [39.44720, -0.37440]], // Calle Muro Santa Ana
            ['P-3', [39.44650, -0.37380]], // Iglesia San Lorenzo
            ['P-4', [39.44580, -0.37320]], // Plaza de la Virgen
            ['P-5', [39.44580, -0.37320]], // Plaza de la Virgen
            ['P-6', [39.44520, -0.37260]], // Panel cer√É∆í√Ç¬°mico Catedral
            ['P-7', [39.44480, -0.37200]], // Capilla exterior
            ['P-8', [39.44480, -0.37200]], // Capilla exterior
            ['P-9', [39.44440, -0.37140]], // Arco Novo Catedral
            ['P-10', [39.44400, -0.37080]], // Casa Punt Gantxo
            ['P-11', [39.44360, -0.37020]], // Museo Almo√É∆í√Ç¬≠na
            ['P-12', [39.44360, -0.37020]], // Museo Almo√É∆í√Ç¬≠na 2
            ['P-13', [39.44320, -0.36960]], // Vista Catedral
            ['P-14', [39.44280, -0.36900]], // Palacio Arzobispal
            ['P-15', [39.44240, -0.36840]], // Puerta Rom√É∆í√Ç¬°nica
            ['P-16', [39.44200, -0.36780]], // Plaza Ayuntamiento
            ['P-17', [39.44160, -0.36720]], // Edificio Ayuntamiento
            ['P-18', [39.44160, -0.36720]], // Ayuntamiento murci√É∆í√Ç¬©lago
            ['P-19', [39.44120, -0.36660]], // Estaci√É∆í√Ç¬≥n Norte
            ['P-20', [39.44080, -0.36600]], // Casa estilo √É∆í√Ç¬Årabe
            ['P-21', [39.44080, -0.36600]], // Casa estilo √É∆í√Ç¬Årabe
            ['P-22', [39.44040, -0.36540]], // Palacio Comunicaciones
            ['P-23', [39.44000, -0.36480]], // Edificio Suay
            ['P-24', [39.43960, -0.36420]], // Banco Valencia
            ['P-25', [39.43920, -0.36360]], // Palacio Marqu√É∆í√Ç¬©s
            ['P-26', [39.43880, -0.36300]], // Mercado Central
            ['P-27', [39.43840, -0.36240]], // Santos Juanes
            ['P-28', [39.43840, -0.36240]], // Santos Juanes
            ['P-29', [39.43800, -0.36180]], // Lonja Pecados
            ['P-30', [39.43800, -0.36180]], // Lonja √É∆í√Ç¬°rbol
            ['P-31', [39.43760, -0.36120]], // Lonja G√É∆í√Ç¬°rgolas
            ['P-32', [39.43760, -0.36120]], // Lonja barbudo
            ['P-33', [39.43760, -0.36120]], // Lonja fornicador
            ['P-34', [39.43720, -0.36060]], // Fuente Negrito
            ['P-35', [39.43680, -0.36000]], // Palau Generalitat
            ['P-36', [39.44859, -0.37489]]  // Torres Serranos Final
        ]);
        
        coordenadas.forEach((coords, paradaId) => {
            coordenadasParadas.set(paradaId, coords);
        });
        
        console.log('√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬ç Coordenadas de paradas inicializadas:', coordenadasParadas.size, 'paradas');
    }

    // ================== INICIALIZACI√É∆í√¢‚Ç¨≈ìN DEL MAPA ==================
    function inicializarMapa() {
        try {
            console.log('√É¬∞√Ö¬∏√¢‚Ç¨¬ù√Ç¬ç Iniciando inicializaci√É∆í√Ç¬≥n del mapa...');
            
            if (typeof L === 'undefined') {
                throw new Error('La biblioteca Leaflet no est√É∆í√Ç¬° cargada correctamente');
            }
            
            const valenciaCoords = [39.44859, -0.37489];
            const mapContainer = document.getElementById('mapa');
            
            if (!mapContainer) {
                throw new Error('No se encontr√É∆í√Ç¬≥ el contenedor del mapa');
            }
            
            mapContainer.style.display = 'block';
            
            mapa = L.map('mapa', {
                center: valenciaCoords,
                zoom: 16,
                zoomControl: false,
                scrollWheelZoom: true,
                doubleClickZoom: true,
                boxZoom: true,
                rotate: false,
                touchRotate: false,
                bearing: 0,
                preferCanvas: true
            });
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '√É‚Äö√Ç¬© OpenStreetMap contributors',
                detectRetina: true
            }).addTo(mapa);
            
            mapa.whenReady(() => {
                console.log('√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Mapa cargado correctamente');
                mapInitialized = true;
                window.mapa = mapa;
                
                setTimeout(() => {
                    mapa.invalidateSize({ animate: true });
                    
                    // Inicializar coordenadas y crear marcadores
                    inicializarCoordenadasParadas();
                    crearMarcadoresIniciales();
                    
                }, 100);
            });
            
            mapa.on('error', (error) => {
                console.error('√É¬¢√Ç¬ù√Ö‚Äô Error en el mapa:', error);
                mostrarErrorEnInterfaz('Error en el mapa: ' + (error.message || 'Error desconocido'));
            });
            
            return mapa;
            
        } catch (error) {
            console.error('√É¬¢√Ç¬ù√Ö‚Äô Error al inicializar el mapa:', error);
            mostrarErrorEnInterfaz(
                'Error al cargar el mapa: ' + (error.message || 'Error desconocido'),
                () => inicializarMapa()
            );
            return null;
        }
    }

    // ================== FUNCIONES DE MARCADORES ==================
    function crearMarcadoresIniciales() {
        console.log('√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬ç Creando marcadores iniciales...');
        
        // Crear marcadores para todas las paradas
        AVENTURA_PARADAS.forEach((item, index) => {
            if (item.tipo === 'parada' || item.tipo === 'inicio') {
                crearMarcadorParada(item.parada_id, index);
            }
        });
        
        console.log(`√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ ${marcadoresParadas.size} marcadores de paradas creados`);
    }
    
    function crearMarcadorParada(paradaId, index = 0) {
        const coords = coordenadasParadas.get(paradaId);
        if (!coords) {
            console.warn(`√É¬¢√Ö¬°√Ç¬†√É¬Ø√Ç¬∏√Ç¬è No se encontraron coordenadas para ${paradaId}`);
            return null;
        }
        
        const esActual = index === window.paradaActual;
        const esPasada = index < window.paradaActual;
        
        let color = '#9E9E9E'; // Gris por defecto
        let className = 'marcador-futuro';
        
        if (esActual) {
            color = '#4CAF50'; // Verde para actual
            className = 'marcador-actual';
        } else if (esPasada) {
            color = '#2196F3'; // Azul para visitadas
            className = 'marcador-visitada';
        }
        
        const marcador = L.circleMarker(coords, {
            radius: 8,
            fillColor: color,
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8,
            className: className
        });
        
        // Obtener informaci√É∆í√Ç¬≥n de la parada
        const infoParada = AVENTURA_PARADAS[index];
        let popupContent = `<b>Parada ${paradaId}</b><br>`;
        
        if (infoParada.reto_id) {
            popupContent += `Reto: ${infoParada.reto_id}<br>`;
        }
        if (infoParada.retos) {
            popupContent += `Retos: ${infoParada.retos.map(r => r.id).join(', ')}<br>`;
        }
        
        marcador.bindPopup(popupContent);
        marcador.addTo(mapa);
        
        marcadoresParadas.set(paradaId, marcador);
        
        return marcador;
    }
    
    function actualizarMarcadorParada(paradaId, estado = 'actual') {
        const marcador = marcadoresParadas.get(paradaId);
        if (!marcador) return;
        
        const colores = {
            'actual': '#4CAF50',
            'visitada': '#2196F3',
            'futuro': '#9E9E9E',
            'objetivo': '#FF5722'
        };
        
        marcador.setStyle({
            fillColor: colores[estado] || colores.futuro,
            radius: estado === 'actual' ? 10 : 8
        });
    }
    
    function crearMarcadorUsuario(lat, lng, tipo = 'usuario') {
        const colores = {
            'usuario': '#E91E63',
            'destino': '#FF5722',
            'temporal': '#FFC107'
        };
        
        const marcador = L.circleMarker([lat, lng], {
            radius: 6,
            fillColor: colores[tipo],
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 1
        });
        
        marcador.addTo(mapa);
        marcadoresUsuario.set(tipo, marcador);
        
        return marcador;
    }

    // ================== FUNCIONES DE GEOLOCALIZACI√É∆í√¢‚Ç¨≈ìN ==================
    function iniciarSeguimientoGPS() {
        if (!navigator.geolocation) {
            console.error('√É¬¢√Ç¬ù√Ö‚Äô Geolocalizaci√É∆í√Ç¬≥n no soportada');
            mostrarErrorEnInterfaz('Tu dispositivo no soporta geolocalizaci√É∆í√Ç¬≥n');
            return false;
        }
        
        const opciones = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 30000
        };
        
        watchId = navigator.geolocation.watchPosition(
            (position) => {
                const { latitude, longitude, accuracy } = position.coords;
                actualizarPosicionUsuario(latitude, longitude, accuracy);
            },
            (error) => {
                console.error('√É¬¢√Ç¬ù√Ö‚Äô Error de geolocalizaci√É∆í√Ç¬≥n:', error);
                mostrarErrorEnInterfaz(`Error GPS: ${error.message}`);
            },
            opciones
        );
        
        console.log('√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬ç Seguimiento GPS iniciado');
        return true;
    }
    
    function detenerSeguimientoGPS() {
        if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
            console.log('√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬ç Seguimiento GPS detenido');
        }
    }
    
    function actualizarPosicionUsuario(lat, lng, accuracy = 0) {
        // Actualizar o crear marcador de posici√É∆í√Ç¬≥n
        if (capaPosicionUsuario) {
            mapa.removeLayer(capaPosicionUsuario);
        }
        
        capaPosicionUsuario = L.circleMarker([lat, lng], {
            radius: 8,
            fillColor: '#E91E63',
            color: '#fff',
            weight: 3,
            opacity: 1,
            fillOpacity: 1
        }).addTo(mapa);
        
        // Agregar c√É∆í√Ç¬≠rculo de precisi√É∆í√Ç¬≥n si es necesario
        if (accuracy > 0 && accuracy < 100) {
            L.circle([lat, lng], {
                radius: accuracy,
                fillColor: 'transparent',
                color: '#E91E63',
                weight: 1,
                opacity: 0.3
            }).addTo(mapa);
        }
        
        // Notificar a los hijos usando el sistema centralizado
        enviarMensajeMultiple('GPS.ACTUALIZAR', {
            lat, lng, accuracy, timestamp: Date.now()
        }, 'GPS');
        
        console.log(`√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬ç Posici√É∆í√Ç¬≥n actualizada: ${lat}, ${lng} (√É‚Äö√Ç¬±${accuracy}m)`);
    }

    // ================== FUNCIONES DE RUTAS Y NAVEGACI√É∆í√¢‚Ç¨≈ìN ==================
    function crearRuta(origen, destino, tipo = 'walking') {
        if (!origen || !destino) {
            console.error('√É¬¢√Ç¬ù√Ö‚Äô Origen o destino no definidos para la ruta');
            return null;
        }
        
        // Para simplicidad, crear una l√É∆í√Ç¬≠nea directa
        // En producci√É∆í√Ç¬≥n, usar un servicio de routing como OpenRouteService
        const ruta = L.polyline([origen, destino], {
            color: '#2196F3',
            weight: 4,
            opacity: 0.8,
            dashArray: tipo === 'estimated' ? '5, 10' : null
        });
        
        ruta.addTo(mapa);
        
        const rutaId = `ruta_${Date.now()}`;
        rutasActivas.set(rutaId, ruta);
        
        return rutaId;
    }
    
    function eliminarRuta(rutaId) {
        const ruta = rutasActivas.get(rutaId);
        if (ruta) {
            mapa.removeLayer(ruta);
            rutasActivas.delete(rutaId);
            return true;
        }
        return false;
    }
    
    function calcularDistancia(lat1, lng1, lat2, lng2) {
        const R = 6371e3; // Radio de la Tierra en metros
        const √É¬è√¢‚Ç¨¬†1 = lat1 * Math.PI/180;
        const √É¬è√¢‚Ç¨¬†2 = lat2 * Math.PI/180;
        const √É≈Ω√¢‚Ç¨¬ù√É¬è√¢‚Ç¨¬† = (lat2-lat1) * Math.PI/180;
        const √É≈Ω√¢‚Ç¨¬ù√É≈Ω√Ç¬ª = (lng2-lng1) * Math.PI/180;
        
        const a = Math.sin(√É≈Ω√¢‚Ç¨¬ù√É¬è√¢‚Ç¨¬†/2) * Math.sin(√É≈Ω√¢‚Ç¨¬ù√É¬è√¢‚Ç¨¬†/2) +
                  Math.cos(√É¬è√¢‚Ç¨¬†1) * Math.cos(√É¬è√¢‚Ç¨¬†2) *
                  Math.sin(√É≈Ω√¢‚Ç¨¬ù√É≈Ω√Ç¬ª/2) * Math.sin(√É≈Ω√¢‚Ç¨¬ù√É≈Ω√Ç¬ª/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        
        return R * c; // Distancia en metros
    }
    
    function navegarAParada(paradaId) {
        const coords = coordenadasParadas.get(paradaId);
        if (!coords) {
            console.error(`√É¬¢√Ç¬ù√Ö‚Äô No se encontraron coordenadas para ${paradaId}`);
            return false;
        }
        
        // Centrar mapa en la parada
        mapa.setView(coords, 18, { animate: true, duration: 1 });
        
        // Resaltar marcador
        actualizarMarcadorParada(paradaId, 'objetivo');
        
        // Notificar a los hijos usando el sistema centralizado
        enviarMensajeMultiple('NAVEGACION.ESTADO', {
            accion: 'parada_objetivo',
            paradaId,
            coordenadas: coords,
            timestamp: Date.now()
        }, 'GPS');
        
        console.log(`√É¬∞√Ö¬∏√Ç¬ß√Ç¬≠ Navegando a parada ${paradaId}`);
        return true;
    }

    // ================== FUNCIONES DE CAPAS ADICIONALES ==================
    function agregarCapaPersonalizada(nombre, datos, opciones = {}) {
        try {
            let capa;
            
            switch (datos.tipo) {
                case 'geojson':
                    capa = L.geoJSON(datos.contenido, opciones);
                    break;
                case 'markers':
                    capa = L.featureGroup();
                    datos.contenido.forEach(item => {
                        const marcador = L.marker(item.coords)
                            .bindPopup(item.popup || '');
                        capa.addLayer(marcador);
                    });
                    break;
                default:
                    console.error(`√É¬¢√Ç¬ù√Ö‚Äô Tipo de capa no soportado: ${datos.tipo}`);
                    return null;
            }
            
            capa.addTo(mapa);
            console.log(`√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Capa '${nombre}' agregada al mapa`);
            return capa;
            
        } catch (error) {
            console.error(`√É¬¢√Ç¬ù√Ö‚Äô Error al agregar capa '${nombre}':`, error);
            return null;
        }
    }

    // ================== FUNCIONES P√É∆í√Ö¬°BLICAS PARA LOS HIJOS ==================
    window.mapaFunciones = {
        // Marcadores
        crearMarcadorParada,
        actualizarMarcadorParada,
        crearMarcadorUsuario,
        
        // Geolocalizaci√É∆í√Ç¬≥n
        iniciarSeguimientoGPS,
        detenerSeguimientoGPS,
        actualizarPosicionUsuario,
        
        // Rutas y navegaci√É∆í√Ç¬≥n
        crearRuta,
        eliminarRuta,
        calcularDistancia,
        navegarAParada,
        
        // Capas
        agregarCapaPersonalizada,
        
        // Utilidades
        centrarMapa: (lat, lng, zoom = 16) => {
            if (mapa) mapa.setView([lat, lng], zoom, { animate: true });
        },
        
        obtenerCoordenadas: (paradaId) => coordenadasParadas.get(paradaId),
        
        obtenerTodasParadas: () => Array.from(coordenadasParadas.entries()),
        
        // Estado
        estaInicializado: () => mapInitialized,
        obtenerMapa: () => mapa
    };
    
    // ================== INICIALIZACI√É∆í√¢‚Ç¨≈ìN DEL SISTEMA DE MENSAJER√É∆í√Ç¬çA ==================
    async function inicializarMensajeria() {
        try {
            console.log('√É¬∞√Ö¬∏√¢‚Ç¨≈ì√Ç¬° Inicializando sistema de mensajer√É∆í√Ç¬≠a...');
            
            const module = await import('./js/mensajeria.js');
            mensajeria = module.default || module;
            window.Mensajeria = mensajeria;
            
            if (!mensajeria || typeof mensajeria.inicializarMensajeria !== 'function') {
                throw new Error('La API de mensajer√É∆í√Ç¬≠a no es v√É∆í√Ç¬°lida');
            }
            
            const configuracion = {
                iframeId: 'padre',
                debug: true
            };
            
            if (mensajeria.LOG_LEVELS) {
                configuracion.logLevel = mensajeria.LOG_LEVELS.INFO;
            }
            
            await mensajeria.inicializarMensajeria(configuracion);
            console.log('√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Sistema de mensajer√É∆í√Ç¬≠a inicializado correctamente');
            
            // Configurar manejadores
            configurarManejadoresMensajes();
            
            return mensajeria;
        } catch (error) {
            console.error('√É¬¢√Ç¬ù√Ö‚Äô Error cr√É∆í√Ç¬≠tico al inicializar el sistema de mensajer√É∆í√Ç¬≠a:', error);
            mostrarErrorEnInterfaz('Error al cargar la aplicaci√É∆í√Ç¬≥n. Por favor, recarga la p√É∆í√Ç¬°gina.');
            throw error;
        }
    }
    
    // ================== CONFIGURACI√É∆í√¢‚Ç¨≈ìN DE MANEJADORES ==================
    function configurarManejadoresMensajes() {
        if (!mensajeria || !mensajeria.registrarControlador) {
            console.warn('√É¬¢√Ö¬°√Ç¬†√É¬Ø√Ç¬∏√Ç¬è No se pueden configurar manejadores: mensajer√É∆í√Ç¬≠a no disponible');
            return;
        }
        
        // Manejador de inicializaci√É∆í√Ç¬≥n
        mensajeria.registrarControlador('SISTEMA.INICIALIZACION', (mensaje) => {
            console.log(`√É¬¢√Ö‚Äú√¢‚Ç¨¬¶ ${mensaje.origen} inicializado`);
        });
        
        // Manejador de cambio de modo
        mensajeria.registrarControlador('MODO.CAMBIAR', async (mensaje) => {
            console.log(`√É¬∞√Ö¬∏√¢‚Ç¨¬ù√¢‚Ç¨≈æ Cambio de modo desde ${mensaje.origen}:`, mensaje.datos);
            
            try {
                const { modo, accion } = mensaje.datos;
                
                if (accion === 'habilitar') {
                    await enableControls(modo);
                } else if (accion === 'deshabilitar') {
                    await disableControls('cambio_de_modo');
                }
                
                // Sincronizar con otros hijos
                await sincronizarEstado({ modo, ultimaActualizacion: Date.now() });
                
            } catch (error) {
                console.error('√É¬¢√Ç¬ù√Ö‚Äô Error en cambio de modo:', error);
            }
        });
        
        // Manejador de navegaci√É∆í√Ç¬≥n - EXTENDIDO PARA MAPA
        mensajeria.registrarControlador('NAVEGACION.ESTADO', (mensaje) => {
            console.log(`√É¬∞√Ö¬∏√Ç¬ß√Ç¬≠ Navegaci√É∆í√Ç¬≥n desde ${mensaje.origen}:`, mensaje.datos);
            
            // Manejar navegaci√É∆í√Ç¬≥n a paradas
            if (mensaje.datos.accion === 'navegar_parada' && mensaje.datos.paradaId) {
                if (window.mapaFunciones) {
                    window.mapaFunciones.navegarAParada(mensaje.datos.paradaId);
                }
            }
            
            // Manejar centrado del mapa
            if (mensaje.datos.accion === 'centrar_mapa' && mensaje.datos.lat && mensaje.datos.lng) {
                if (window.mapaFunciones) {
                    window.mapaFunciones.centrarMapa(mensaje.datos.lat, mensaje.datos.lng, mensaje.datos.zoom);
                }
            }
            
            // Manejar actualizaci√É∆í√Ç¬≥n de parada actual
            if (mensaje.datos.accion === 'actualizar_parada' && mensaje.datos.paradaId) {
                if (window.mapaFunciones) {
                    window.mapaFunciones.actualizarMarcadorParada(mensaje.datos.paradaId, mensaje.datos.estado || 'actual');
                    // Actualizar variable global
                    if (mensaje.datos.estado === 'actual') {
                        const paradaIndex = AVENTURA_PARADAS.findIndex(p => p.parada_id === mensaje.datos.paradaId);
                        if (paradaIndex !== -1) {
                            window.paradaActual = paradaIndex;
                        }
                    }
                }
            }
        });
        
        // Manejador de audio
        mensajeria.registrarControlador('AUDIO.ESTADO', (mensaje) => {
            console.log(`√É¬∞√Ö¬∏√¢‚Ç¨¬ù√Ö¬† Audio desde ${mensaje.origen}:`, mensaje.datos);
        });
        
        // Manejador de retos
        mensajeria.registrarControlador('RETO.ESTADO', (mensaje) => {
            console.log(`√É¬∞√Ö¬∏√Ö¬Ω√Ç¬Ø Reto desde ${mensaje.origen}:`, mensaje.datos);
        
// Manejador de cambio de modo
mensajeria.registrarControlador('MODO.CAMBIAR', async (mensaje) => {
    console.log(`√É¬∞√Ö¬∏√¢‚Ç¨¬ù√¢‚Ç¨≈æ Cambio de modo desde ${mensaje.origen}:`, mensaje.datos);
            
    try {
        const { modo, accion } = mensaje.datos;
                
        if (accion === 'habilitar') {
            await enableControls(modo);
        } else if (accion === 'deshabilitar') {
            await disableControls('cambio_de_modo');
        }
                
        // Sincronizar con otros hijos
        await sincronizarEstado({ modo, ultimaActualizacion: Date.now() });
                
    } catch (error) {
        console.error('√É¬¢√Ç¬ù√Ö‚Äô Error en cambio de modo:', error);
    }
});
        
// Manejador de navegaci√É∆í√Ç¬≥n - EXTENDIDO PARA MAPA
mensajeria.registrarControlador('NAVEGACION.ESTADO', (mensaje) => {
    console.log(`√É¬∞√Ö¬∏√Ç¬ß√Ç¬≠ Navegaci√É∆í√Ç¬≥n desde ${mensaje.origen}:`, mensaje.datos);
            
    // Manejar navegaci√É∆í√Ç¬≥n a paradas
    if (mensaje.datos.accion === 'navegar_parada' && mensaje.datos.paradaId) {
        if (window.mapaFunciones) {
            window.mapaFunciones.navegarAParada(mensaje.datos.paradaId);
        }
    }
            
    // Manejar centrado del mapa
    if (mensaje.datos.accion === 'centrar_mapa' && mensaje.datos.lat && mensaje.datos.lng) {
        if (window.mapaFunciones) {
            window.mapaFunciones.centrarMapa(mensaje.datos.lat, mensaje.datos.lng, mensaje.datos.zoom);
        }
    }
            
    // Manejar actualizaci√É∆í√Ç¬≥n de parada actual
    if (mensaje.datos.accion === 'actualizar_parada' && mensaje.datos.paradaId) {
        if (window.mapaFunciones) {
            window.mapaFunciones.actualizarMarcadorParada(mensaje.datos.paradaId, mensaje.datos.estado || 'actual');
            // Actualizar variable global
            if (mensaje.datos.estado === 'actual') {
                const paradaIndex = AVENTURA_PARADAS.findIndex(p => p.parada_id === mensaje.datos.paradaId);
                if (paradaIndex !== -1) {
                    window.paradaActual = paradaIndex;
                }
            }
        }
    }
});
        
// Manejador de audio
mensajeria.registrarControlador('AUDIO.ESTADO', (mensaje) => {
    console.log(`√É¬∞√Ö¬∏√¢‚Ç¨¬ù√Ö¬† Audio desde ${mensaje.origen}:`, mensaje.datos);
});
        
// Manejador de retos
mensajeria.registrarControlador('RETO.ESTADO', (mensaje) => {
    console.log(`√É¬∞√Ö¬∏√Ö¬Ω√Ç¬Ø Reto desde ${mensaje.origen}:`, mensaje.datos);
});
        
// Manejador de GPS - EXTENDIDO PARA MAPA
mensajeria.registrarControlador('GPS.COMANDO', (mensaje) => {
    // Manejar comandos GPS aqu√É¬≠
    console.log('Comando GPS recibido:', mensaje);
    // Aqu√É¬≠ puedes a√É¬±adir la l√É¬≥gica para manejar comandos GPS espec√É¬≠ficos
});
        
// Inicializar el mapa cuando el DOM est√É¬© listo
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM cargado, inicializando mapa...');
    if (typeof inicializarMapa === 'function') {
        inicializarMapa();
    } else {
        console.error('La funci√É¬≥n inicializarMapa no est√É¬° definida');
    }
});
</script>
</body>
</html>
