<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aventura 1 - Padre</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüó∫Ô∏è%3C/text%3E%3C/svg%3E">

    <!-- Carga de Leaflet desde CDN con Integrity y Crossorigin -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <!-- Script para verificar que Leaflet est√° cargado -->
    <script>
        window.addEventListener('load', function() {
            if (typeof L === 'undefined') {
                console.error('‚ùå Leaflet no se ha cargado correctamente. L no est√° definido en window.');
            } else {
                console.log('‚úÖ Leaflet cargado correctamente:', L.version);
            }
        });
    </script>

    <style>
        /* Encapsular estilos globales */
        .padre-container html, .padre-container body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: transparent;
        }

        /* Estilos generales, mapa, debug, logo, iframes, etc. */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: transparent; }
        iframe { background: transparent; border: none; }
        /* PROBLEMA #1: Mejorar los estilos del mapa para asegurar visibilidad */
        #mapa { 
            position: fixed !important; 
            top: 0 !important; 
            left: 0 !important; 
            width: 100vw !important; 
            height: 100vh !important; 
            z-index: 10 !important;
            background-color: #f5f5f5 !important;
            border: 1px solid #ccc !important;
            visibility: visible !important;
            opacity: 1 !important;
            display: block !important;
            pointer-events: auto !important;
            overflow: visible !important;
        }
        /* Asegurar que los contenedores de Leaflet sean visibles */
        .leaflet-container {
            width: 100% !important;
            height: 100% !important;
            z-index: 10 !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            background: white !important;
        }
        .leaflet-tile-container {
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 200 !important;
        }
        .leaflet-tile {
            visibility: visible !important;
            opacity: 1 !important;
        }
        .leaflet-map-pane,
        .leaflet-overlay-pane,
        .leaflet-marker-pane,
        .leaflet-shadow-pane,
        .leaflet-tooltip-pane,
        .leaflet-popup-pane {
            z-index: auto !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        #map-debug { position: fixed; top: 10px; left: 10px; background: rgba(255, 255, 255, 0.9); padding: 5px 8px; border-radius: 5px; z-index: 5000; font-size: 12px; font-family: monospace; display: none; transition: opacity 0.5s; }
        #logo-aventura { position: fixed; top: -27px; left: 50%; transform: translateX(-50%); width: 320px; height: 125px; z-index: 2999; object-fit: contain; }
        #fondo-blanco { position: fixed; top: -24px; left: 50%; transform: translateX(-50%); width: 400px; height: 100px; z-index: 2998; background: white; border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; }
        #info-parada { font-weight: bold; margin: 0; padding: 7px 12px; background-color: rgba(255, 255, 255, 0.9); border-radius: 7px; position: fixed; left: 50%; transform: translateX(-50%); z-index: 1201; display: none; color: #333; font-family: sans-serif; text-align: center; bottom: 325px; min-width: 220px; max-width: 90vw; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10); }
        #hijo4 { position: fixed; top: 10vh; left: 50%; width: 60vw; height: 40vh; transform: translateX(-50%); z-index: 2000; border: 2px solid red; background: transparent; pointer-events: auto; display: none; }
        #media-overlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.8); z-index: 4000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #media-container { max-width: 90%; max-height: 90%; display: flex; flex-direction: column; align-items: center; position: relative; }
        #close-media { position: absolute; top: 10px; right: 10px; background: #ff5252; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.2em; cursor: pointer; z-index: 4001; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #parada-video, #parada-imagen { max-width: 100%; max-height: calc(100vh - 80px); display: none; border-radius: 5px; }
        
        /* Estilos para waypoints y marcadores de ruta */
        .waypoint-marker {
            background-color: #ff8c00;
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .waypoint-number {
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
        }
        
        .marker-letter {
            background: #ff4500;
            color: white;
            font-weight: bold;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .inicio-marker .marker-letter {
            background: #28a745;
        }
        
        .fin-marker .marker-letter {
            background: #dc3545;
        }
        
        /* Clases para animar la ruta actual */
        .ruta-activa {
            animation: pulse-route 2s infinite;
        }
        
        @keyframes pulse-route {
            0% { stroke-opacity: 0.7; }
            50% { stroke-opacity: 1; }
            100% { stroke-opacity: 0.7; }
        }

        #debug-overlay {
            display: none !important;
        }

        /* Estilos para el iframe hijo5-casa (bot√≥n casa) */
        #hijo5-casa {
            position: fixed;
            top: 80px;
            right: 0;
            width: 30px;
            height: 25px;
            border: 1px solid red;
            z-index: 10000;
            overflow: visible;
            background: rgba(255, 255, 255, 0.8);
            pointer-events: auto;
            margin: 0;
            padding: 0;
            border-radius: 4px;
        }
        #hijo5-casa * {
            pointer-events: auto;
        }

        /* Estilos para los marcadores de navegaci√≥n */
        .marcador-inicio {
            color: #4CAF50;
            font-size: 24px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        .marcador-destino {
            color: #F44336;
            font-size: 24px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        /* Estilo para la flecha de navegaci√≥n */
        .flecha-navegacion {
            color: #1E88E5;
            font-size: 24px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            transform-origin: center;
            transform: rotate(0deg);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        /* Estilos para los marcadores personalizados */
        .custom-marker {
            position: relative;
            width: 30px;
            height: 42px;
            text-align: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            line-height: 42px;
        }
        .marker-pin {
            position: absolute;
            width: 30px;
            height: 42px;
            background: #007bff;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            left: 0;
            top: 0;
            margin: -21px 0 0 -15px;
        }
        .green-pin .marker-pin {
            background: #28a745;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .green-pin::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            margin: 3px 0 0 3px;
            background: #fff;
            border-radius: 50%;
            opacity: 0.3;
        }

        /* Estilo para video e imagen */
        #media-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 4000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        #media-container {
            width: 70vw;
            height: 70vh;
            max-width: 70vw;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            padding: 15px;
        }
        #close-media {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 1.2em;
            cursor: pointer;
            z-index: 4001;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #parada-video, #parada-imagen {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            display: none;
            border-radius: 8px;
            object-fit: contain;
        }
    </style>

    <!-- Cargar m√≥dulos ES -->
    <script type="module">
    // 1. Configuraci√≥n global de manejo de errores
    window.handleIframeError = function(iframeId, event) {
        const errorMsg = `Error loading ${iframeId}`;
        console.error(errorMsg, event);
        // Si el logger est√° disponible, usarlo tambi√©n
        if (window.logger?.error) {
            window.logger.error(errorMsg, event);
        }
    };
    
    window.handleIframeLoad = function(iframeId) {
        const msg = `${iframeId} loaded successfully`;
        console.debug(msg);
        if (window.logger?.debug) {
            window.logger.debug(msg);
        }
    }

    // 2. Funci√≥n de inicializaci√≥n as√≠ncrona
    async function initializeApp() {
        try {
            console.log('Iniciando aplicaci√≥n...');
            
            // Importar din√°micamente la aplicaci√≥n
            const { inicializar } = await import('./js/app.js');
            
            // Inicializar la aplicaci√≥n
            await inicializar();
            
            console.log('Aplicaci√≥n inicializada correctamente');
            
        } catch (error) {
            console.error('Error cr√≠tico al inicializar la aplicaci√≥n:', error);
            // Mostrar mensaje de error en la interfaz
            const errorDiv = document.createElement('div');
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '0';
            errorDiv.style.left = '0';
            errorDiv.style.right = '0';
            errorDiv.style.background = '#ffebee';
            errorDiv.style.color = '#c62828';
            errorDiv.style.padding = '1rem';
            errorDiv.style.zIndex = '9999';
            errorDiv.style.fontFamily = 'Arial, sans-serif';
            errorDiv.style.fontSize = '14px';
            errorDiv.style.whiteSpace = 'pre';
            errorDiv.style.overflow = 'auto';
            errorDiv.style.maxHeight = '50vh';
            errorDiv.textContent = `Error al inicializar la aplicaci√≥n:\n\n${error.message}\n\n${error.stack || ''}`;
            document.body.prepend(errorDiv);
        }
    }

    // 3. Inicializar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }
    </script>
</head>
<body>
    <!-- Debug overlay -->
    <div id="debug-overlay" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; z-index: 9999; max-width: 300px; max-height: 80vh; overflow: auto; font-family: monospace; font-size: 12px;">
        <h3 style="margin: 0 0 10px 0;">Debug Info</h3>
        <div id="debug-content">Initializing...</div>
    </div>
    
    <script>
    // Debug logging function
    function debugLog(message, data) {
        const now = new Date().toISOString().substr(11, 12);
        const logLine = document.createElement('div');
        logLine.textContent = `[${now}] ${message}`;
        if (data) {
            try {
                logLine.textContent += ' ' + JSON.stringify(data);
            } catch (e) {
                logLine.textContent += ' [Object]';
            }
        }
        const debugContent = document.getElementById('debug-content');
        debugContent.prepend(logLine);
        console.log(`[DEBUG] ${message}`, data || '');
    }
    
    // Make it globally available
    window.debugLog = debugLog;
    
    // Log initial load
    debugLog('Parent page loading...');
    </script>
    
    <!-- PROBLEMA #2: Arreglar el script de inicializaci√≥n del mapa -->
    <script>
        // Crear el contenedor del mapa inmediatamente y a√±adirlo al DOM
        (function crearContenedorMapa() {
            console.log('Creando contenedor del mapa al cargar el script...');
            let mapContainer = document.getElementById('mapa');
            
            if (!mapContainer) {
                console.log('Contenedor del mapa no encontrado, creando uno nuevo inmediatamente...');
                mapContainer = document.createElement('div');
                mapContainer.id = 'mapa';
                mapContainer.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    height: 100vh !important;
                    z-index: 10 !important;
                    background-color: #f5f5f5 !important;
                    border: 1px solid #ccc !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    display: block !important;
                    pointer-events: auto !important;
                    overflow: visible !important;
                `;
                document.body.appendChild(mapContainer); // A√±adir al DOM
            }
        })();

        // Inicializar el mapa despu√©s de que el DOM est√© completamente cargado
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç DOM completamente cargado, inicializando mapa...');
            if (typeof L !== 'undefined') {
                const map = L.map('mapa').setView([39.47876, -0.37626], 13);
                console.log('‚úÖ Mapa inicializado correctamente');
            } else {
                console.error('‚ùå Leaflet no est√° disponible');
            }
        });
    </script>

    <div id="mapa"></div>    <!-- Contenedor del mapa (ahora se crea din√°micamente) -->

    <!-- IFrames de los Hijos -->
    <iframe id="hijo2" src="./Av1-botones-coordenadas.html"
        style="position:fixed;
               bottom:150px;
               left:50%;
               transform:translateX(-50%);
               height:165px;
               width:310px;
               z-index:1001;
               border: none !important;
               background-color: transparent !important;
               overflow: hidden;
               pointer-events:auto;"
        allow="geolocation"
        frameborder="0"></iframe>

    <iframe id="hijo3" src="Av1_audio_esp.html" style="position: fixed; bottom: 2vh; left: 50%; transform: translateX(-50%); width: 320px; height: 140px; z-index: 1000; border: none; pointer-events: auto;"></iframe>
    
    <iframe id="hijo4" src="Av1-esp-retos-preguntas.html" style="display: none;"></iframe>

    <iframe id="hijo5-casa" src="Av1-boton-casa.html" 
        style="position: fixed; top: 15px; left: 10px; width: 410px; height: 60px; z-index: 99999; border: none; pointer-events: auto;">
    </iframe>

    <!-- A√±adir iframes para hamburguesa y opciones -->
    <iframe id="hijo1-hamburguesa" src="./botones-y-subfunciones-hamburguesa.html" 
        style="position:fixed; left:1vw; bottom:3vw; height:285px; width:61px; 
               z-index:1005; border: transparent; background:transparent; pointer-events:auto;">
    </iframe>
    <iframe id="hijo1-opciones" src="./botones-y-subfunciones-opciones.html" 
        style="position:fixed; right:1vw; bottom:3vw; height:285px; width:61px; 
               z-index:1005; border: transparent; background:transparent; pointer-events:auto;">
    </iframe>

    <div id="map-debug"></div>
    <div id="info-parada"></div>

    <!-- Overlay para Media -->
    <div id="media-overlay">
        <div id="media-container">
            <button id="close-media">&times;</button>
            <video id="parada-video" controls></video>
            <img id="parada-imagen" />
        </div>
    </div>

    <!-- Sistema de orquestaci√≥n entre componentes -->
    <script type="module">
    import { TIPOS_MENSAJE, MODOS } from './js/constants.js';
    import { inicializarMensajeria, registrarControlador, enviarMensaje } from './js/mensajeria.js';
    import logger from './js/logger.js';
    
    // Estado global de la orquestaci√≥n
    const estadoOrquestacion = {
        modo: 'casa',
        paradaActual: null,
        usuarioDistanciaParada: Infinity,
        audioReproduciendo: false,
        retoActivo: false,
        retoCompletado: false,
        botonGPSHabilitado: true
    };
    
    // Funci√≥n para avanzar a la siguiente parada/tramo
    async function avanzarASiguienteParada() {
        try {
            // L√≥gica para determinar la siguiente parada/tramo basado en la actual
            const siguienteParada = obtenerSiguienteParada(estadoOrquestacion.paradaActual);
            
            if (siguienteParada) {
                logger.info(`Avanzando a la siguiente parada: ${siguienteParada.id}`);
                
                // Notificar a todos los componentes del cambio
                await enviarMensaje('todos', TIPOS_MENSAJE.NAVEGACION.CAMBIO_PARADA, {
                    punto: { 
                        parada_id: siguienteParada.parada_id,
                        tramo_id: siguienteParada.tramo_id
                    }
                });
                
                // Actualizar estado
                estadoOrquestacion.paradaActual = siguienteParada;
                estadoOrquestacion.retoCompletado = false;
                estadoOrquestacion.retoActivo = false;
                estadoOrquestacion.audioReproduciendo = false;
            } else {
                logger.warn('No se encontr√≥ una siguiente parada');
            }
        } catch (error) {
            logger.error('Error al avanzar a la siguiente parada:', error);
        }
    }
    
    // Registrar manejadores para coordinar el flujo
    
    // 1. Manejador para actualizaciones de posici√≥n del usuario
    registrarControlador(TIPOS_MENSAJE.NAVEGACION.ACTUALIZAR_POSICION, async (mensaje) => {
        const { coordenadas } = mensaje.datos || {};
        if (!coordenadas) return;
        
        // Calcular distancia a la parada actual
        if (estadoOrquestacion.paradaActual && estadoOrquestacion.paradaActual.coordenadas) {
            const distancia = calcularDistancia(
                coordenadas,
                estadoOrquestacion.paradaActual.coordenadas
            );
            
            estadoOrquestacion.usuarioDistanciaParada = distancia;
            
            // Actualizar habilitaci√≥n de botones seg√∫n la distancia
            actualizarHabilitacionBotones(distancia);
        }
    });
    
    // 2. Manejador para finalizaci√≥n de audio
    registrarControlador(TIPOS_MENSAJE.AUDIO.FIN_REPRODUCCION, async (mensaje) => {
        logger.info('Audio finalizado:', mensaje.datos?.audioId);
        
        estadoOrquestacion.audioReproduciendo = false;
        
        // Verificar si hay un reto asociado a esta parada
        const retoAsociado = obtenerRetoAsociadoAParada(estadoOrquestacion.paradaActual);
        
        if (retoAsociado) {
            // Si hay reto: Primero mostrar el reto, los botones se habilitar√°n despu√©s
            await enviarMensaje('hijo4', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                origen: 'padre',
                timestamp: new Date().toISOString()
            });
            
            await enviarMensaje('hijo4', TIPOS_MENSAJE.RETO.MOSTRAR, {
                reto: retoAsociado,
                parada: estadoOrquestacion.paradaActual
            });
            
            estadoOrquestacion.retoActivo = true;
            
        } else {
            // Si NO hay reto: Habilitar todos los botones inmediatamente
            await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                boton: 'gps',
                origen: 'padre'
            });
            
            await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                boton: 'imagen',
                origen: 'padre'
            });
            
            // Si es un tramo, habilitar tambi√©n el bot√≥n de v√≠deo
            if (estadoOrquestacion.paradaActual && estadoOrquestacion.paradaActual.tramo_id) {
                await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                    boton: 'video',
                    origen: 'padre'
                });
            }
            
            estadoOrquestacion.botonGPSHabilitado = true;
            logger.info('No hay reto asociado, botones habilitados directamente');
        }
        
        // El audio siempre puede reproducirse de nuevo mientras el usuario est√© en la parada/tramo
        await enviarMensaje('hijo3', TIPOS_MENSAJE.CONTROL.HABILITAR, {
            origen: 'padre'
        });
    });
    
    // 3. Manejador para reto completado
    registrarControlador(TIPOS_MENSAJE.RETO.COMPLETADO, async (mensaje) => {
        logger.info('Reto completado:', mensaje.datos);
        
        estadoOrquestacion.retoCompletado = true;
        estadoOrquestacion.retoActivo = false;
        
        // Habilitar TODOS los botones despu√©s de completar el reto
        await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.HABILITAR, {
            boton: 'gps',
            origen: 'padre'
        });
        
        await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.HABILITAR, {
            boton: 'imagen',
            origen: 'padre'
        });
        
        // Si es un tramo, habilitar tambi√©n el bot√≥n de v√≠deo
        if (estadoOrquestacion.paradaActual && estadoOrquestacion.paradaActual.tramo_id) {
            await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                boton: 'video',
                origen: 'padre'
            });
        }
        
        estadoOrquestacion.botonGPSHabilitado = true;
        
        // Avanzar a la siguiente parada
        await avanzarASiguienteParada();
    });
    
    // 4. Manejador para inicio de reproducci√≥n de audio
    registrarControlador(TIPOS_MENSAJE.AUDIO.REPRODUCIR, async (mensaje) => {
        logger.info('Audio iniciado:', mensaje.datos);
        
        estadoOrquestacion.audioReproduciendo = true;
        
        // Deshabilitar bot√≥n GPS durante la reproducci√≥n del audio
        await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.DESHABILITAR, {
            boton: 'gps',
            origen: 'padre'
        });
        
        estadoOrquestacion.botonGPSHabilitado = false;
    });
    
    // Funci√≥n para actualizar la habilitaci√≥n de botones seg√∫n la distancia
    async function actualizarHabilitacionBotones(distancia) {
        try {
            // Si estamos en modo casa, asegurar que los botones audio y retos est√©n siempre habilitados
            if (estadoOrquestacion.modo === 'casa') {
                // Habilitar botones de audio y retos en modo casa
                await enviarMensaje('hijo3', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                    origen: 'padre'
                });
                await enviarMensaje('hijo4', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                    origen: 'padre'
                });
                return; // No seguir con la l√≥gica basada en distancia en modo casa
            }

            // Si est√° activo un reto, no modificar estado del bot√≥n GPS
            if (estadoOrquestacion.retoActivo) {
                logger.debug('Hay un reto activo, no se actualiza estado del bot√≥n GPS');
                return;
            }
            
            if (distancia <= 10) {
                // A menos de 10m: Deshabilitar bot√≥n de imagen
                await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.DESHABILITAR, {
                    boton: 'imagen',
                    origen: 'padre'
                });
                
                // El audio siempre est√° disponible cuando est√° cerca
                await enviarMensaje('hijo3', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                    origen: 'padre'
                });
            } else if (distancia > 10 && distancia <= 60) {
                // Entre 10-60m: Habilitar GPS e imagen
                // Solo habilitar GPS si no est√° reproduciendo audio
                if (!estadoOrquestacion.audioReproduciendo) {
                    await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                        boton: 'gps',
                        origen: 'padre'
                    });
                    estadoOrquestacion.botonGPSHabilitado = true;
                }
                
                await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                    boton: 'imagen',
                    origen: 'padre'
                });
                
                // Habilitar audio tambi√©n
                await enviarMensaje('hijo3', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                    origen: 'padre'
                });
            } else {
                // A m√°s de 60m: Deshabilitar GPS
                await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.DESHABILITAR, {
                    boton: 'gps',
                    origen: 'padre'
                });
                
                estadoOrquestacion.botonGPSHabilitado = false;
            }
        } catch (error) {
            logger.error('Error al actualizar habilitaci√≥n de botones:', error);
        }
    }
    
    // Funciones auxiliares
    function calcularDistancia(coord1, coord2) {
        const R = 6371e3; // Radio de la Tierra en metros
        const œÜ1 = coord1.lat * Math.PI/180;
        const œÜ2 = coord2.lat * Math.PI/180;
        const ŒîœÜ = (coord2.lat - coord1.lat) * Math.PI/180;
        const ŒîŒª = (coord2.lng - coord1.lng) * Math.PI/180;

        const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

        return R * c; // Distancia en metros
    }
    
    function obtenerSiguienteParada(paradaActual) {
        // Implementaci√≥n real buscar√≠a en el array de paradas
        // Simulaci√≥n simple para el ejemplo
        return { id: 'siguiente-parada', parada_id: 'P-' + (parseInt(paradaActual?.id?.split('-')[1] || '0') + 1) };
    }
    
    function obtenerRetoAsociadoAParada(parada) {
        // Verificar si tenemos un punto v√°lido
        if (!parada) return null;
        
        // Obtener el ID normalizado para buscar (parada_id o tramo_id)
        const idBusqueda = parada.parada_id || parada.tramo_id || parada.id || '';
        
        // Lista simple de puntos con retos asociados (tanto paradas como tramos)
        const puntosConReto = ['P-1', 'P-3', 'P-5', 'P-7', 'P-9', 'P-12', 'P-15'];
        
        // Verificar si este punto tiene reto
        if (puntosConReto.includes(idBusqueda)) {
            return {
                id: 'reto-' + idBusqueda.split('-')[1],
                titulo: `Reto del punto ${idBusqueda}`,
                tipo: 'pregunta',
                datos: {
                    pregunta: '¬øCu√°l es el elemento principal que se observa en este punto?',
                    opciones: ['Fuente', 'Estatua', 'Edificio', 'Puerta'],
                    correcta: 2
                }
            };
        }
        
        return null; // Este punto no tiene reto asociado
    }
    
    // Inicializaci√≥n
    async function iniciarOrquestacion() {
        try {
            // Establecer la primera parada por defecto (P-0 Torres de Serranos)
            estadoOrquestacion.paradaActual = {
                id: 'P-0',
                parada_id: 'P-0',
                nombre: 'Torres de Serranos',
                coordenadas: {
                    lat: 39.47876,
                    lng: -0.37626
                }
            };
            
            logger.info('Orquestaci√≥n iniciada con parada inicial:', estadoOrquestacion.paradaActual);
        } catch (error) {
            logger.error('Error al iniciar orquestaci√≥n:', error);
        }
    }
    
    // Iniciar la orquestaci√≥n cuando se cargue el DOM
    document.addEventListener('DOMContentLoaded', iniciarOrquestacion);
</script>

<!-- Logo de la aventura -->
<img id="logo-aventura" src="https://valenciavguides.github.io/Aventura-1-esp-padre-con-hijos/fotos_Av1/LOGO%20LETRAS%20FINAL%20transparente%20recorte.png" alt="Logo" style="position: fixed; top: -32px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 360px; height: 140px;" />

<!-- Funci√≥n para dibujar una flecha en la ruta -->
<script>
    function dibujarFlecha(latlng, angulo) {
        const iconoFlecha = L.divIcon({
            className: 'flecha-navegacion',
            html: '‚û§',
            iconSize: [24, 24],
            iconAnchor: [12, 12],
            popupAnchor: [0, -12]
        });
        const flecha = L.marker(latlng, {
            icon: iconoFlecha,
            rotationAngle: angulo,
            rotationOrigin: 'center',
            zIndexOffset: 1000
        });
        return flecha;
    }
</script>

<!-- Definici√≥n del array de paradas -->
<script type="module">
    // Definici√≥n del array de paradas y tramos
    const PARADAS = [
        { tipo: "inicio", parada: 0, nombre: "Torres de Serranos (start)", audio: "audio-1.mp3", reto: 0, foto: "img_1.jpg", video: "video_1.mp4", padreid: "padre-P-0" },
        { tipo: "tramo", tramo: 1, nombre: "Torres de Serranos ‚Üí Plaza de la crida (Puente de Serranos)", audio: "audio-2.mp3", padreid: "padre-TR-1" },
        { tipo: "parada", parada: 1, nombre: "Plaza de la crida (Puente de Serranos)", audio: "audio-3.mp3", reto: 1, foto: "img_2.jpg", video: "video_2.mp4", padreid: "padre-P-1" },
        { tipo: "tramo", tramo: 2, nombre: "Plaza de la crida ‚Üí Calle Muro de Santa Ana", audio: "audio-4.mp3", padreid: "padre-TR-2" },
        { tipo: "parada", parada: 2, nombre: "Calle Muro de Santa Ana", audio: "audio-5.mp3", reto: 2, foto: "img_3.jpg", video: "video_3.mp4", padreid: "padre-P-2" },
        { tipo: "tramo", tramo: 3, nombre: "Calle Muro de Santa Ana ‚Üí Palacio de los Borgia", audio: "audio-6.mp3", padreid: "padre-TR-3" },
        { tipo: "parada", parada: 3, nombre: "Iglesia de San Lorenzo", audio: "audio-7.mp3", reto: 3, foto: "img_4.jpg", video: "video_4.mp4", padreid: "padre-P-3" },
        { tipo: "tramo", tramo: 4, nombre: "Iglesia de San Lorenzo ‚Üí Plaza de la Virgen", audio: "audio-8.mp3", padreid: "padre-TR-4" },
        { tipo: "parada", parada: 4, nombre: "Plaza de la Virgen Reto 6", audio: "audio-9.mp3", reto: 4, foto: "img_5.jpg", video: "video_5.mp4", padreid: "padre-P-4" },
        { tipo: "parada", parada: 5, nombre: "Plaza de la Virgen Reto 7", audio: "audio-10.mp3", reto: 5, foto: "img_6.jpg", video: "video_6.mp4", padreid: "padre-P-5" },
        { tipo: "tramo", tramo: 5, nombre: "Plaza de la Virgen ‚Üí Plaza de la Almo√≠na", audio: "audio-11.mp3", padreid: "padre-TR-5" },
        { tipo: "parada", parada: 6, nombre: "Panel cer√°mico muro Catedral", audio: "audio-12.mp3", reto: 6, foto: "img_7.jpg", video: "video_7.mp4", padreid: "padre-P-6" },
        { tipo: "parada", parada: 7, nombre: "Capilla exterior catedral Reto 10", audio: "audio-13.mp3", reto: 7, foto: "img_8.jpg", video: "video_8.mp4", padreid: "padre-P-7" },
        { tipo: "parada", parada: 8, nombre: "Capilla exterior catedral Reto 11", audio: "audio-14.mp3", reto: 8, foto: "img_9.jpg", video: "video_9.mp4", padreid: "padre-P-8" },
        { tipo: "parada", parada: 9, nombre: "Arco Novo Catedral y Puerta Negra Bas√≠lica", audio: "audio-15.mp3", reto: 9, foto: "img_10.jpg", video: "video_10.mp4", padreid: "padre-P-9" },
        { tipo: "parada", parada: 10, nombre: "Casa del Punt de Gantxo", audio: "audio-16.mp3", reto: 10, foto: "img_11.jpg", video: "video_11.mp4", padreid: "padre-P-10" },
        { tipo: "tramo", tramo: 6, nombre: "Plaza de la Almo√≠na ‚Üí Plaza Decimo Junio Bruto (Museo Arqueol√≥gico de la Almo√≠na)", audio: "audio-17.mp3", padreid: "padre-TR-6" },
        { tipo: "parada", parada: 11, nombre: "Museo arqueol√≥gico La Almo√≠na", audio: "audio-18.mp3", reto: 11, foto: "img_12.jpg", video: "video_12.mp4", padreid: "padre-P-11" },
        { tipo: "parada", parada: 12, nombre: "Museo arqueol√≥gico La Almo√≠na", audio: "audio-19.mp3", reto: 12, foto: "img_13.jpg", video: "video_13.mp4", padreid: "padre-P-12" },
        { tipo: "parada", parada: 13, nombre: "Vista de la Catedral, Cimborrio", audio: "audio-20.mp3", reto: 13, foto: "img_14.jpg", video: "video_14.mp4", padreid: "padre-P-13" },
        { tipo: "tramo", tramo: 7, nombre: "Museo arqueol√≥gico La Almo√≠na ‚Üí Palacio Arzobispal", audio: "audio-21.mp3", padreid: "padre-TR-7" },
        { tipo: "parada", parada: 14, nombre: "Palacio Arzobispal y Puerta Rom√°nica de la Catedral", audio: "audio-22.mp3", reto: 14, foto: "img_15.jpg", video: "video_15.mp4", padreid: "padre-P-14" },
        { tipo: "parada", parada: 15, nombre: "Puerta Rom√°nica de la Catedral", audio: "audio-23.mp3", reto: 15, foto: "img_16.jpg", video: "video_16.mp4", padreid: "padre-P-15" },
        { tipo: "tramo", tramo: 8, nombre: "Puerta Rom√°nica de la Catedral ‚Üí Plaza del Ayuntamiento", audio: "audio-24.mp3", padreid: "padre-TR-8" },
        { tipo: "parada", parada: 16, nombre: "Plaza del Ayuntamiento", audio: "audio-25.mp3", reto: 16, foto: "img_17.jpg", video: "video_17.mp4", padreid: "padre-P-16" },
        { tipo: "tramo", tramo: 9, nombre: "Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento de Val√®ncia", audio: "audio-26.mp3", padreid: "padre-TR-9" },
        { tipo: "parada", parada: 17, nombre: "Edificio del Ayuntamiento", audio: "audio-27.mp3", reto: 17, foto: "img_18.jpg", video: "video_18.mp4", padreid: "padre-P-17" },
        { tipo: "parada", parada: 18, nombre: "Edificio del Ayuntamiento", audio: "audio-28.mp3", reto: 18, foto: "img_19.jpg", video: "video_19.mp4", padreid: "padre-P-18" },
        { tipo: "tramo", tramo: 10, nombre: "Edificio del Ayuntamiento ‚Üí Estaci√≥n del Norte", audio: "audio-29.mp3", padreid: "padre-TR-10" },
        { tipo: "parada", parada: 19, nombre: "Estaci√≥n del Norte", audio: "audio-30.mp3", reto: 19, foto: "img_20.jpg", video: "video_20.mp4", padreid: "padre-P-19" },
        { tipo: "tramo", tramo: 11, nombre: "Estaci√≥n del Norte ‚Üí Plaza de Toros de Val√®ncia", audio: "audio-31.mp3", padreid: "padre-TR-11" },
        { tipo: "tramo", tramo: 12, nombre: "Plaza de Toros ‚Üí Casa estilo √Årabe", audio: "audio-32.mp3", padreid: "padre-TR-12" },
        { tipo: "parada", parada: 20, nombre: "Casa estilo √Årabe", audio: "audio-33.mp3", reto: 20, foto: "img_21.jpg", video: "video_21.mp4", padreid: "padre-P-20" },
        { tipo: "parada", parada: 21, nombre: "Casa estilo √Årabe, mitad Aventura", audio: "audio-34.mp3", reto: 21, foto: "img_22.jpg", video: "video_22.mp4", padreid: "padre-P-21" },
        { tipo: "tramo", tramo: 13, nombre: "Casa estilo √Årabe ‚Üí Palacio de Comunicaciones (Correos)", audio: "audio-35.mp3", padreid: "padre-TR-13" },
        { tipo: "parada", parada: 22, nombre: "Palacio de Comunicaciones: Correos", audio: "audio-36.mp3", reto: 22, foto: "img_23.jpg", video: "video_23.mp4", padreid: "padre-P-22" },
        { tipo: "parada", parada: 23, nombre: "Edificio Suay", audio: "audio-37.mp3", reto: 23, foto: "img_24.jpg", video: "video_24.mp4", padreid: "padre-P-23" },
        { tipo: "tramo", tramo: 14, nombre: "Palacio de Comunicaciones ‚Üí Banco de Val√®ncia", audio: "audio-38.mp3", padreid: "padre-TR-14" },
        { tipo: "parada", parada: 24, nombre: "Banco de Valencia", audio: "audio-39.mp3", reto: 24, foto: "img_25.jpg", video: "video_25.mp4", padreid: "padre-P-24" },
        { tipo: "tramo", tramo: 15, nombre: "Banco de Val√®ncia ‚Üí Palacio del Marqu√©s de Dos Aguas", audio: "audio-40.mp3", padreid: "padre-TR-15" },
        { tipo: "parada", parada: 25, nombre: "Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica)", audio: "audio-41.mp3", reto: 25, foto: "img_26.jpg", video: "video_26.mp4", padreid: "padre-P-25" },
        { tipo: "tramo", tramo: 16, nombre: "Palacio del Marqu√©s ‚Üí Mercado Central", audio: "audio-42.mp3", padreid: "padre-TR-16" },
        { tipo: "parada", parada: 26, nombre: "Mercado central", audio: "audio-43.mp3", reto: 26, foto: "img_27.jpg", video: "video_27.mp4", padreid: "padre-P-26" },
        { tipo: "tramo", tramo: 17, nombre: "Mercado Central ‚Üí Iglesia de los Santos Juanes", audio: "audio-44.mp3", padreid: "padre-TR-17" },
        { tipo: "parada", parada: 27, nombre: "Iglesia de los Santos Juanes reto 24", audio: "audio-45.mp3", reto: 27, foto: "img_28.jpg", video: "video_28.mp4", padreid: "padre-P-27" },
        { tipo: "parada", parada: 28, nombre: "Iglesia de los Santos Juanes reto 25", audio: "audio-46.mp3", reto: 28, foto: "img_29.jpg", video: "video_29.mp4", padreid: "padre-P-28" },
        { tipo: "tramo", tramo: 18, nombre: "Iglesia Santos Juanes ‚Üí Lonja de Val√®ncia (Mercado de la Seda)", audio: "audio-47.mp3", padreid: "padre-TR-18" },
        { tipo: "parada", parada: 29, nombre: "Lonja Puerta de Los Pecados barquero", audio: "audio-48.mp3", reto: 29, foto: "img_30.jpg", video: "video_30.mp4", padreid: "padre-P-29" },
        { tipo: "parada", parada: 30, nombre: "Lonja Puerta de Los Pecados √°rbol muerto", audio: "audio-49.mp3", reto: 30, foto: "img_31.jpg", video: "video_31.mp4", padreid: "padre-P-30" },
        { tipo: "tramo", tramo: 19, nombre: "Lonja G√°rgolas", audio: "audio-50.mp3", padreid: "padre-TR-19" },
        { tipo: "parada", parada: 31, nombre: "Lonja G√°rgolas √°ngel vasija", audio: "audio-51.mp3", reto: 31, foto: "img_32.jpg", video: "video_32.mp4", padreid: "padre-P-31" },
        { tipo: "parada", parada: 32, nombre: "Lonja G√°rgolas barbudo y le√≥n", audio: "audio-52.mp3", reto: 32, foto: "img_33.jpg", video: "video_33.mp4", padreid: "padre-P-32" },
        { tipo: "parada", parada: 33, nombre: "Lonja G√°rgolas fornicador ventana", audio: "audio-53.mp3", reto: 33, foto: "img_34.jpg", video: "video_34.mp4", padreid: "padre-P-33" },
        { tipo: "tramo", tramo: 20, nombre: "Lonja ‚Üí Plaza del Doctor Collado", audio: "audio-54.mp3", padreid: "padre-TR-20" },
        { tipo: "tramo", tramo: 21, nombre: "Plaza del Doctor Collado ‚Üí Plaza del Negrito (Fuente del Negrito)", audio: "audio-55.mp3", padreid: "padre-TR-21" },
        { tipo: "parada", parada: 34, nombre: "Fuente del Negrito", audio: "audio-56.mp3", reto: 34, foto: "img_35.jpg", video: "video_35.mp4", padreid: "padre-P-34" },
        { tipo: "tramo", tramo: 22, nombre: "Plaza del Negrito ‚Üí Calle Caballeros", audio: "audio-57.mp3", padreid: "padre-TR-22" },
        { tipo: "parada", parada: 35, nombre: "Palau de la Generalitat", audio: "audio-58.mp3", reto: 35, foto: "img_36.jpg", video: "video_36.mp4", padreid: "padre-P-35" },
        { tipo: "tramo", tramo: 23, nombre: "Palacio de la Generalitat ‚Üí Calle de los Serranos (FINAL)", audio: "audio-59.mp3", padreid: "padre-TR-23" },
        { tipo: "parada", parada: 36, nombre: "Torres de Serranos (Final del recorrido)", audio: "audio-60.mp3", reto: 36, foto: "img_37.jpg", video: "video_37.mp4", padreid: "padre-P-36" }
    ];
</script>
</body>
</html>
