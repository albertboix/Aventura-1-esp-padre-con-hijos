
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aventura 1 - Padre</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüó∫Ô∏è%3C/text%3E%3C/svg%3E">

    <!-- Carga de Leaflet desde CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* Estilos generales, mapa, debug, logo, iframes, etc. */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: transparent; }
        iframe { background: transparent; border: none; }
        #mapa { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 3; background-color: #f5f5f5; }
        #map-debug { position: fixed; top: 10px; left: 10px; background: rgba(255, 255, 255, 0.9); padding: 5px 8px; border-radius: 5px; z-index: 5000; font-size: 12px; font-family: monospace; display: none; transition: opacity 0.5s; }
        #logo-aventura { position: fixed; top: -13px; left: 50%; transform: translateX(-50%); width: 190px; height: 140px; z-index: 3000; object-fit: contain; }
        #fondo-blanco { position: fixed; top: -24px; left: 50%; transform: translateX(-50%); width: 210px; height: 150px; z-index: 2999; background: white; border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; }
        #info-parada { font-weight: bold; margin: 0; padding: 7px 12px; background-color: rgba(255, 255, 255, 0.9); border-radius: 7px; position: fixed; left: 50%; transform: translateX(-50%); z-index: 1201; display: none; color: #333; font-family: sans-serif; text-align: center; bottom: 325px; min-width: 220px; max-width: 90vw; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10); }
        #hijo4 { position: fixed; top: 10vh; left: 50%; width: 60vw; height: 40vh; transform: translateX(-50%); z-index: 2000; border: 2px solid red; background: transparent; pointer-events: auto; display: none; }
        #media-overlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.8); z-index: 4000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #media-container { max-width: 90%; max-height: 90%; display: flex; flex-direction: column; align-items: center; position: relative; }
        #close-media { position: absolute; top: 10px; right: 10px; background: #ff5252; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.2em; cursor: pointer; z-index: 4001; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #parada-video, #parada-imagen { max-width: 100%; max-height: calc(100vh - 80px); display: none; border-radius: 5px; }
    </style>

    <!-- Cargar m√≥dulos ES -->
    <script type="module">
    // 1. Configuraci√≥n global de manejo de errores
    window.handleIframeError = function(iframeId, event) {
        const errorMsg = `Error loading ${iframeId}`;
        console.error(errorMsg, event);
        // Si el logger est√° disponible, usarlo tambi√©n
        if (window.logger?.error) {
            window.logger.error(errorMsg, event);
        }
    };
    
    window.handleIframeLoad = function(iframeId) {
        const msg = `${iframeId} loaded successfully`;
        console.debug(msg);
        if (window.logger?.debug) {
            window.logger.debug(msg);
        }
    };

    // 2. Funci√≥n de inicializaci√≥n as√≠ncrona
    async function initializeApp() {
        try {
            console.log('Iniciando aplicaci√≥n...');
            
            // Importar din√°micamente la aplicaci√≥n
            const { inicializar } = await import('./js/app.js');
            
            // Inicializar la aplicaci√≥n
            await inicializar();
            
            console.log('Aplicaci√≥n inicializada correctamente');
            
        } catch (error) {
            console.error('Error cr√≠tico al inicializar la aplicaci√≥n:', error);
            // Mostrar mensaje de error en la interfaz
            const errorDiv = document.createElement('div');
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '0';
            errorDiv.style.left = '0';
            errorDiv.style.right = '0';
            errorDiv.style.background = '#ffebee';
            errorDiv.style.color = '#c62828';
            errorDiv.style.padding = '1rem';
            errorDiv.style.zIndex = '9999';
            errorDiv.style.fontFamily = 'Arial, sans-serif';
            errorDiv.style.fontSize = '14px';
            errorDiv.style.whiteSpace = 'pre';
            errorDiv.style.overflow = 'auto';
            errorDiv.style.maxHeight = '50vh';
            errorDiv.textContent = `Error al inicializar la aplicaci√≥n:\n\n${error.message}\n\n${error.stack || ''}`;
            document.body.prepend(errorDiv);
        }
    }

    // 3. Inicializar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }
    </script>
</head>
<body>
    <!-- Debug overlay -->
    <div id="debug-overlay" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; z-index: 9999; max-width: 300px; max-height: 80vh; overflow: auto; font-family: monospace; font-size: 12px;">
        <h3 style="margin: 0 0 10px 0;">Debug Info</h3>
        <div id="debug-content">Initializing...</div>
    </div>
    
    <script>
    // Debug logging function
    function debugLog(message, data) {
        const now = new Date().toISOString().substr(11, 12);
        const logLine = document.createElement('div');
        logLine.textContent = `[${now}] ${message}`;
        if (data) {
            try {
                logLine.textContent += ' ' + JSON.stringify(data);
            } catch (e) {
                logLine.textContent += ' [Object]';
            }
        }
        const debugContent = document.getElementById('debug-content');
        debugContent.prepend(logLine);
        console.log(`[DEBUG] ${message}`, data || '');
    }
    
    // Make it globally available
    window.debugLog = debugLog;
    
    // Log initial load
    debugLog('Parent page loading...');
    </script>
    <!-- Contenedores de la UI -->
    <div id="mapa"></div>
    <div id="map-debug"></div>
    <iframe id="fondo-blanco" tabindex="-1" aria-hidden="true"></iframe>
    <img id="logo-aventura" src="fotos_Av1/LOGO LETRAS FINAL transparente recorte.png" alt="Logo" />
    <div id="info-parada"></div>

    <!-- IFrames de los Hijos -->
    <iframe id="hijo1-hamburguesa" src="botones-y-subfunciones-hamburguesa.html"
        title="Men√∫ Hamburguesa"
        aria-label="Men√∫ de navegaci√≥n hamburguesa"
        style="position:fixed; left:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; pointer-events:auto;"
        onerror="handleIframeError('hijo1-hamburguesa', event)"></iframe>
    <iframe id="hijo1-opciones" src="botones-y-subfunciones-opciones.html"
        title="Opciones de usuario"
        aria-label="Opciones y configuraci√≥n"
        style="position:fixed; right:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; pointer-events:auto;"
        onerror="handleIframeError('hijo1-opciones', event)"></iframe>
    <iframe id="hijo5-casa" src="Av1-boton-casa.html"
        title="Bot√≥n Casa"
        aria-label="Bot√≥n para cambiar entre modo Casa y Aventura"
        style="position:fixed; left:10px; top:10px; height:100px; width:350px; z-index:1005; pointer-events:auto; transition:width 0.3s; display:block; border:2px solid red;"
        onload="handleIframeLoad('hijo5-casa')" onerror="handleIframeError('hijo5-casa', event)"></iframe>
    <iframe id="hijo3" src="Av1_audio_esp.html"
        title="Audio de la aventura"
        aria-label="Reproductor de audio de la aventura"
        style="position:fixed; bottom:-6px; left:50%; transform:translateX(-50%); height:165px; width:310px; z-index:1000; display:block; pointer-events:auto;"
        onerror="handleIframeError('hijo3-audio', event)"></iframe>
    <iframe id="hijo2" src="Av1-botones-coordenadas.html"
        title="Botones de coordenadas"
        aria-label="Botones de navegaci√≥n y coordenadas"
        style="position:fixed; bottom:151px; left:50%; transform:translateX(-50%); height:165px; width:310px; z-index:1001; pointer-events:auto; display:block;"
        allow="geolocation" onerror="handleIframeError('hijo2-coordenadas', event)"></iframe>
    <iframe id="hijo4" src="Av1-esp-retos-preguntas.html"
        title="Retos y preguntas"
        aria-label="Ventana de retos y preguntas"
        style="display:none;" onload="handleIframeLoad('hijo4-retos')" onerror="handleIframeError('hijo4-retos', event)"></iframe>

    <!-- Overlay para Media -->
    <div id="media-overlay">
        <div id="media-container">
            <button id="close-media">X</button>
            <video id="parada-video" controls></video>
            <img id="parada-imagen">
        </div>
    </div>

    <!-- SCRIPT PRINCIPAL UNIFICADO DE LA APLICACI√ìN -->
    <script type="module">
    // Log module initialization
    window.debugLog('ES Module initializing...');
    
    // Configurar manejador global de errores no capturados
    window.addEventListener('error', (event) => {
        console.error('Error no capturado:', event.error || event.message, event);
    });

    // Configurar manejador para promesas no manejadas
    window.addEventListener('unhandledrejection', (event) => {
        console.error('Promesa rechazada no manejada:', event.reason);
    });

    (async () => {
        try {
            window.debugLog('Inicializando aplicaci√≥n...');
            
            // Importar m√≥dulos
            window.debugLog('Importando m√≥dulos...');
            
            // FIX: Import modules individually to avoid naming conflicts
            const appModule = await import('./js/app.js');
            const mapaModule = await import('./js/funciones-mapa.js');
            const mensajeriaModule = await import('./js/mensajeria.js');
            const constantsModule = await import('./js/constants.js');
            const configModule = await import('./js/config.js');
            const loggerModule = await import('./js/logger.js');
            
            // Destructure with aliases to avoid naming conflicts
            const { 
                estado: appEstado,
                notificarError,
                enviarCambioModo
            } = appModule;
            
            const {
                inicializarMapa,
                inicializarModuloMapa
            } = mapaModule;
            
            const {
                inicializarMensajeria,
                registrarControlador,
                enviarMensaje
            } = mensajeriaModule;
            
            const { TIPOS_MENSAJE } = constantsModule;
            const { CONFIG } = configModule;
            const logger = loggerModule.default; // FIX: Get logger properly
            
            // Make available globally
            window.logger = logger; // FIX: Make logger available globally
            
            // Usar HIJOS de la configuraci√≥n centralizada
            const { HIJOS } = CONFIG;
            
            const MAP_CONFIG = {
                center: [39.4699, -0.3763], zoom: 13, minZoom: 12, maxZoom: 18, zoomControl: false
            };

            // FIX: Use the imported state rather than creating a duplicate
            const estadoApp = appEstado;
            window.estadoApp = estadoApp;

            // 3. DATOS DE LA AVENTURA
            const AVENTURA_PARADAS = [
                { padreid: "padre-P-0", tipo: "inicio", parada_id: 'P-0', audio_id: "audio-P-0", reto_id: "R-2" },
                { padreid: "padre-TR-1", tipo: "tramo", tramo_id: 'TR-1', audio_id: "audio-TR-1" },
                { padreid: "padre-P-1", tipo: "parada", parada_id: 'P-1', audio_id: "audio-P-1", reto_id: "R-3" },
                { padreid: "padre-TR-2", tipo: "tramo", tramo_id: 'TR-2', audio_id: "audio-TR-2" },
                { padreid: "padre-P-2", tipo: "parada", parada_id: 'P-2', audio_id: "audio-P-2", reto_id: "R-4" },
                { padreid: "padre-TR-3", tipo: "tramo", tramo_id: 'TR-3', audio_id: "audio-TR-3" },
                { padreid: "padre-P-3", tipo: "parada", parada_id: 'P-3', audio_id: "audio-P-3", reto_id: "R-5" },
                { padreid: "padre-TR-4", tipo: "tramo", tramo_id: 'TR-4', audio_id: "audio-TR-4" },
                { padreid: "padre-P-4", tipo: "parada", parada_id: 'P-4', audio_id: "audio-P-4", reto_id: "R-6" },
                { padreid: "padre-P-5", tipo: "parada", parada_id: 'P-5', audio_id: "audio-P-5", retos: [{ tipo: "reto", id: "R-7" },{ tipo: "puzzle", id: "PZ-8" }] },
                { padreid: "padre-TR-5", tipo: "tramo", tramo_id: 'TR-5', audio_id: "audio-TR-5" },
                { padreid: "padre-P-6", tipo: "parada", parada_id: 'P-6', audio_id: "audio-P-6", reto_id: "R-9" },
                { padreid: "padre-P-7", tipo: "parada", parada_id: 'P-7', audio_id: "audio-P-7", reto_id: "R-10" },
                { padreid: "padre-P-8", tipo: "parada", parada_id: 'P-8', audio_id: "audio-P-8", reto_id: "R-11" },
                { padreid: "padre-P-9", tipo: "parada", parada_id: 'P-9', audio_id: "audio-P-9" },
                { padreid: "padre-P-10", tipo: "parada", parada_id: 'P-10', audio_id: "audio-P-10", reto_id: "R-12"  },
                { padreid: "padre-TR-6", tipo: "tramo", tramo_id: 'TR-6', audio_id: "audio-TR-6" },
                { padreid: "padre-P-11", tipo: "parada", parada_id: 'P-11', audio_id: "audio-P-11", reto_id: "R-13" },
                { padreid: "padre-P-12", tipo: "parada", parada_id: 'P-12', audio_id: "audio-P-12" },
                { padreid: "padre-P-13", tipo: "parada", parada_id: 'P-13', audio_id: "audio-P-13", reto_id: "R-14" },
                { padreid: "padre-TR-7", tipo: "tramo", tramo_id: 'TR-7', audio_id: "audio-TR-7" },
                { padreid: "padre-P-14", tipo: "parada", parada_id: 'P-14', audio_id: "audio-P-14", reto_id: "R-15" },
                { padreid: "padre-P-15", tipo: "parada", parada_id: 'P-15', audio_id: "audio-P-15" },
                { padreid: "padre-TR-8", tipo: "tramo", tramo_id: 'TR-8', audio_id: "audio-TR-8" },
                { padreid: "padre-P-16", tipo: "parada", parada_id: 'P-16', audio_id: "audio-P-16" },
                { padreid: "padre-TR-9", tipo: "tramo", tramo_id: 'TR-9', audio_id: "audio-TR-9" },
                { padreid: "padre-P-17", tipo: "parada", parada_id: 'P-17', audio_id: "audio-P-17", reto_id: "R-16" },
                { padreid: "padre-P-18", tipo: "parada", parada_id: 'P-18', audio_id: "audio-P-18" },
                { padreid: "padre-TR-10", tipo: "tramo", tramo_id: 'TR-10', audio_id: "audio-TR-10" },
                { padreid: "padre-P-19", tipo: "parada", parada_id: 'P-19', audio_id: "audio-P-19", retos: [{ tipo: "reto", id: "R-17" },{ tipo: "puzzle", id: "PZ-18" }] },
                { padreid: "padre-TR-11", tipo: "tramo", tramo_id: 'TR-11', audio_id: "audio-TR-11" },
                { padreid: "padre-TR-12", tipo: "tramo", tramo_id: 'TR-12', audio_id: "audio-TR-12" },
                { padreid: "padre-P-20", tipo: "parada", parada_id: 'P-20', audio_id: "audio-P-20", reto_id: "R-19" },
                { padreid: "padre-P-21", tipo: "parada", parada_id: 'P-21', audio_id: "audio-P-21" },
                { padreid: "padre-TR-13", tipo: "tramo", tramo_id: 'TR-13', audio_id: "audio-TR-13" },
                { padreid: "padre-P-22", tipo: "parada", parada_id: 'P-22', audio_id: "audio-P-22", retos: ["R-20", "R-21"] },
                { padreid: "padre-P-23", tipo: "parada", parada_id: 'P-23', audio_id: "audio-P-23", reto_id: "R-21" },
                { padreid: "padre-TR-14", tipo: "tramo", tramo_id: 'TR-14', audio_id: "audio-TR-14" },
                { padreid: "padre-P-24", tipo: "parada", parada_id: 'P-24', audio_id: "audio-P-24", reto_id: "R-22" },
                { padreid: "padre-TR-15", tipo: "tramo", tramo_id: 'TR-15', audio_id: "audio-TR-15" },
                { padreid: "padre-P-25", tipo: "parada", parada_id: 'P-25', audio_id: "audio-P-25" },
                { padreid: "padre-TR-16", tipo: "tramo", tramo_id: 'TR-16', audio_id: "audio-TR-16" },
                { padreid: "padre-P-26", tipo: "parada", parada_id: 'P-26', audio_id: "audio-P-26", reto_id: "R-23" },
                { padreid: "padre-TR-17", tipo: "tramo", tramo_id: 'TR-17', audio_id: "audio-TR-17" },
                { padreid: "padre-P-27", tipo: "parada", parada_id: 'P-27', audio_id: "audio-P-27", reto_id: "R-24" },
                { padreid: "padre-P-28", tipo: "parada", parada_id: 'P-28', audio_id: "audio-P-28", reto_id: "R-25" },
                { padreid: "padre-TR-18", tipo: "tramo", tramo_id: 'TR-18', audio_id: "audio-TR-18" },
                { padreid: "padre-P-29", tipo: "parada", parada_id: 'P-29', audio_id: "audio-P-29", reto_id: "R-27" },
                { padreid: "padre-P-30", tipo: "parada", parada_id: 'P-30', audio_id: "audio-P-30", reto_id: "R-28" },
                { padreid: "padre-TR-19", tipo: "tramo", tramo_id: 'TR-19', audio_id: "audio-TR-19" },
                { padreid: "padre-P-31", tipo: "parada", parada_id: 'P-31', audio_id: "audio-P-31", reto_id: "R-29" },
                { padreid: "padre-P-32", tipo: "parada", parada_id: 'P-32', audio_id: "audio-P-32", reto_id: "R-30" },
                { padreid: "padre-P-33", tipo: "parada", parada_id: 'P-33', audio_id: "audio-P-33", retos: [ { tipo: "reto", id: "R-31" }, { tipo: "puzzle", id: "PZ-26" } ] },
                { padreid: "padre-TR-20", tipo: "tramo", tramo_id: 'TR-20', audio_id: "audio-TR-20" },
                { padreid: "padre-TR-21", tipo: "tramo", tramo_id: 'TR-21', audio_id: "audio-TR-21" },
                { padreid: "padre-P-34", tipo: "parada", parada_id: 'P-34', audio_id: "audio-P-34", reto_id: "R-32" },
                { padreid: "padre-TR-22", tipo: "tramo", tramo_id: 'TR-22', audio_id: "audio-TR-22" },
                { padreid: "padre-P-35", tipo: "parada", parada_id: 'P-35', audio_id: "audio-P-35" },
                { padreid: "padre-TR-23", tipo: "tramo", tramo_id: 'TR-23', audio_id: "audio-TR-23" },
                { padreid: "padre-P-36", tipo: "parada", parada_id: 'P-36', audio_id: "audio-P-36" }
            ];

            // 4. L√ìGICA DE ARRANQUE
            document.addEventListener('DOMContentLoaded', async () => {
                const logger = {
                    info: (msg, ...args) => console.log(`[INFO] ${msg}`, ...args),
                    error: (msg, ...args) => console.error(`[ERROR] ${msg}`, ...args),
                    warn: (msg, ...args) => console.warn(`[WARN] ${msg}`, ...args),
                    debug: (msg, ...args) => console.debug(`[DEBUG] ${msg}`, ...args)
                };

                // Funci√≥n para actualizar el tama√±o del mapa
                const updateMapSize = () => {
                    if (window.mapa) {
                        window.mapa.invalidateSize();
                        logger.debug('Map size updated');
                    }
                };

                try {
                    logger.info('Iniciando inicializaci√≥n de la aplicaci√≥n...');
                    
                    // 1. Inicializar mensajer√≠a primero
                    await inicializarSistemaMensajeria();
                    logger.debug('Sistema de mensajer√≠a inicializado');
                    
                    // 2. Registrar manejadores de mensajes
                    registrarControladoresTotales();
                    logger.debug('Manejadores de mensajes registrados');
                    
                    // 3. Inicializar el mapa
                    const mapaContainer = document.getElementById('mapa');
                    if (!mapaContainer) {
                        throw new Error('No se encontr√≥ el contenedor del mapa');
                    }
                    
                    const mapaInstance = await iniciarSistemaMapa();
                    if (!mapaInstance) {
                        throw new Error('No se pudo inicializar el mapa');
                    }
                    
                    logger.info('Sistema de mapa inicializado correctamente');
                    
                    // 4. Configurar actualizaci√≥n de tama√±o del mapa
                    setTimeout(updateMapSize, 100);
                    window.addEventListener('resize', () => setTimeout(updateMapSize, 100));
                    
                    // 5. Notificar que la aplicaci√≥n est√° lista
                    if (typeof enviarMensaje === 'function') {
                        await enviarMensaje('*', TIPOS_MENSAJE.SISTEMA.LISTO, {
                            modulo: 'app',
                            estado: 'listo',
                            timestamp: new Date().toISOString()
                        });
                    }
                    
                    logger.info('Aplicaci√≥n inicializada correctamente');
                    
                } catch (error) {
                    const errorMsg = `Error al inicializar la aplicaci√≥n: ${error.message}`;
                    logger.error(errorMsg, error);
                    
                    // Notificar error al sistema
                    if (typeof enviarMensaje === 'function') {
                        await enviarMensaje('*', TIPOS_MENSAJE.SISTEMA.ERROR, {
                            tipo: 'inicializacion',
                            mensaje: error.message,
                            stack: error.stack,
                            timestamp: new Date().toISOString()
                        }).catch(e => console.error('Error al notificar error:', e));
                    }
                    
                    // Mostrar mensaje de error al usuario
                    alert('Error cr√≠tico al inicializar la aplicaci√≥n. Por favor, recarga la p√°gina.');
                    
                    // Mostrar el contenedor del mapa si existe
                    if (mapaContainer) {
                        mapaContainer.style.visibility = 'visible';
                    }
                    
                    // Actualizar el estado de depuraci√≥n
                    if (typeof updateMapDebug === 'function') {
                        updateMapDebug(`Error: ${error.message}`);
                    }
                    
                    // Registrar el error
                    if (typeof crearObjetoError === 'function') {
                        crearObjetoError('inicializacion', error);
                    }
                }
            });

            // 5. FUNCIONES PRINCIPALES
            async function inicializarSistemaMensajeria() {
                if (estadoApp.mensajeriaInicializada) return;
                await inicializarMensajeria({ iframeId: CONFIG.ID_PADRE, logLevel: CONFIG.LOG_LEVEL });
                estadoApp.mensajeriaInicializada = true;
                logger.info('Sistema de mensajer√≠a inicializado.');
            }

            async function iniciarSistemaMapa() {
                try {
                    logger.info('Iniciando sistema de mapa...'); // Now logger is defined
                    
                    const mapaInstance = await inicializarMapa({ 
                        ...MAP_CONFIG 
                    });
                    
                    if (!mapaInstance) {
                        throw new Error('inicializarMapa no devolvi√≥ una instancia del mapa.');
                    }
                    
                    // Inicializar el m√≥dulo de mapa para registrar manejadores de mensajer√≠a
                    await inicializarModuloMapa();
                    
                    window.mapa = mapaInstance;
                    logger.info('Mapa inicializado correctamente');
                    estadoApp.mapaInicializado = true;
                    
                    // Force map to update its size after a short delay
                    const updateMapSize = () => {
                        if (window.mapa) {
                            window.mapa.invalidateSize();
                            logger.debug('Map size updated');
                        }
                    };
                    
                    setTimeout(updateMapSize, 100);
                    window.addEventListener('resize', () => setTimeout(updateMapSize, 100));
                    
                    return mapaInstance;
                } catch (error) {
                    logger.error('Error al inicializar el mapa:', error); // Now logger is defined
                    throw error;
                }
            }

            async function notificarInicializacionAHijos() {
                logger.info('Notificando inicializaci√≥n a los hijos...');
                const promesas = Object.values(CONFIG.HIJOS).map(hijo =>
                    // FIX: Use the imported function
                    enviarMensaje(hijo.id, TIPOS_MENSAJE.SISTEMA.INICIALIZACION, {
                        aventuraParadas: AVENTURA_PARADAS
                    }).catch(err => logger.warn(`No se pudo notificar a ${hijo.nombre}:`, err.message))
                );
                await Promise.allSettled(promesas);
                logger.info('Notificaci√≥n a hijos completada.');
            }

            // 6. REGISTRO DE CONTROLADORES DE MENSAJES
            // Funci√≥n para manejar actualizaciones del mapa
            function manejarActualizacionMapa(msg) {
                const { accion, datos } = msg.datos || {};
                
                if (!window.mapa) {
                    console.warn('El mapa no est√° inicializado');
                    return;
                }
                
                try {
                    switch (accion) {
                        case 'marcador':
                            // A√±adir o actualizar marcador
                            if (datos.id && datos.lat && datos.lng) {
                                if (!window.mapa._marcadores) window.mapa._marcadores = {};
                                
                                // Eliminar marcador existente si lo hay
                                if (window.mapa._marcadores[datos.id]) {
                                    window.mapa.removeLayer(window.mapa._marcadores[datos.id]);
                                }
                                
                                // Crear nuevo marcador
                                const marcador = L.marker([datos.lat, datos.lng], {
                                    title: datos.titulo || '',
                                    icon: datos.icono || L.divIcon({className: 'marcador-personalizado'})
                                });
                                
                                if (datos.popup) {
                                    marcador.bindPopup(datos.popup);
                                    if (datos.abrirPopup) {
                                        marcador.openPopup();
                                    }
                                }
                                
                                marcador.addTo(window.mapa);
                                window.mapa._marcadores[datos.id] = marcador;
                                
                                // Centrar en el marcador si se solicita
                                if (datos.centrar) {
                                    window.mapa.setView([datos.lat, datos.lng], datos.zoom || window.mapa.getZoom());
                                }
                            }
                            break;
                            
                        case 'limpiar_marcadores':
                            // Limpiar todos los marcadores
                            if (window.mapa._marcadores) {
                                Object.values(window.mapa._marcadores).forEach(marker => {
                                    window.mapa.removeLayer(marker);
                                });
                                window.mapa._marcadores = {};
                            }
                            break;
                            
                        case 'centrar':
                            // Centrar el mapa en una ubicaci√≥n
                            if (datos.lat && datos.lng) {
                                window.mapa.setView(
                                    [datos.lat, datos.lng],
                                    datos.zoom || window.mapa.getZoom()
                                );
                            }
                            break;
                            
                        case 'polilinea':
                            // Dibujar una polil√≠nea
                            if (datos.coordenadas && datos.coordenadas.length > 0) {
                                const polyline = L.polyline(datos.coordenadas, {
                                    color: datos.color || '#3388ff',
                                    weight: datos.ancho || 3,
                                    opacity: datos.opacidad || 0.7
                                }).addTo(window.mapa);
                                
                                // Guardar referencia si se necesita actualizar despu√©s
                                if (datos.id) {
                                    if (!window.mapa._polilineas) window.mapa._polilineas = {};
                                    if (window.mapa._polilineas[datos.id]) {
                                        window.mapa.removeLayer(window.mapa._polilineas[datos.id]);
                                    }
                                    window.mapa._polilineas[datos.id] = polyline;
                                }
                                
                                // Ajustar la vista para mostrar toda la polil√≠nea
                                if (datos.ajustarVista) {
                                    window.mapa.fitBounds(polyline.getBounds(), {
                                        padding: datos.padding || [50, 50]
                                    });
                                }
                            }
                            break;
                            
                        default:
                            console.warn(`Acci√≥n de mapa no soportada: ${accion}`);
                    }
                } catch (error) {
                    console.error('Error al actualizar el mapa:', error);
                }
            }
            
            function registrarControladoresTotales() {
                const controladores = {
                    [TIPOS_MENSAJE.SISTEMA.ERROR]: manejarErrorSistema,
                    [TIPOS_MENSAJE.SISTEMA.INICIALIZACION_COMPLETADA]: manejarHijoInicializado,
                    [TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO]: manejarCambioModo,
                    [TIPOS_MENSAJE.DATOS.SOLICITAR_PARADAS]: manejarSolicitudArrayParadas,
                    [TIPOS_MENSAJE.NAVEGACION.CAMBIO_PARADA]: manejarSeleccionPuntoCasa,
                    [TIPOS_MENSAJE.AUDIO.FINALIZADO]: manejarAudioFinalizado,
                    [TIPOS_MENSAJE.RETO.MOSTRAR]: manejarMostrarReto,
                    [TIPOS_MENSAJE.RETO.OCULTAR]: manejarOcultarReto,
                    [TIPOS_MENSAJE.RETO.COMPLETADO]: manejarRetoCompletado,
                    ['MAPA.ACTUALIZAR']: manejarActualizacionMapa, // Nuevo manejador para actualizaciones del mapa
                };
                for (const tipo in controladores) {
                    // FIX: Use the imported function
                    registrarControlador(tipo, controladores[tipo]);
                }
                logger.info('Controladores de mensajes registrados.');
            }

            // 7. IMPLEMENTACI√ìN DE MANEJADORES
            function manejarErrorSistema(msg) { 
                const { codigo, mensaje, stack } = msg.datos || {};
                const errorMsg = `[${codigo || 'SIN_CODIGO'}] ${mensaje || 'Error desconocido'}`;
                logger.error(`Error de ${msg.origen || 'origen_desconocido'}:`, errorMsg);
                if (stack) logger.debug('Stack trace:', stack);
                updateMapDebug(`Error de ${msg.origen || 'sistema'}: ${errorMsg}`);
            }
            
            function manejarHijoInicializado(msg) { 
                const { idIframe, estado } = msg.datos || {};
                if (idIframe && estado === 'listo') {
                    logger.info(`Hijo ${idIframe} inicializado correctamente.`);
                    estadoApp.hijosInicializados.add(idIframe);
                } else {
                    logger.warn(`Inicializaci√≥n incompleta de ${idIframe || 'hijo_desconocido'}:`, msg.datos);
                }
            }
            
            function manejarSolicitudArrayParadas(msg) { 
                const { origen, timestamp } = msg.datos || {};
                logger.info(`Solicitud de paradas desde ${origen}`, { timestamp });
                return { 
                    exito: true, 
                    paradas: AVENTURA_PARADAS,
                    timestamp: Date.now(),
                    totalParadas: AVENTURA_PARADAS.length
                }; 
            }
            /**
             * Maneja el cambio de modo (casa/aventura) solicitado por un hijo
             * @param {Object} msg - Mensaje de cambio de modo
             * @returns {Promise<Object>} Resultado de la operaci√≥n
             */
            async function manejarCambioModo(msg) {
                const { modo, origen, razon } = msg.datos || {};
                
                // Validar el mensaje recibido
                if (!modo || !origen) {
                    const errorMsg = 'Mensaje de cambio de modo inv√°lido: falta modo u origen';
                    logger.error(errorMsg, msg);
                    await enviarMensaje(msg.origen || 'todos', TIPOS_MENSAJE.SISTEMA.ERROR, {
                        codigo: 'ERROR_CAMBIO_MODO_INVALIDO',
                        mensaje: errorMsg,
                        origen: 'padre',
                        timestamp: Date.now()
                    });
                    return { exito: false, error: errorMsg };
                }
                
                // Verificar si ya estamos en el modo solicitado
                if (modo === estadoApp.modo.actual) {
                    logger.info(`Solicitud de cambio a modo ${modo} ignorada (ya en este modo)`, { origen, razon });
                    return { 
                        exito: true, 
                        mensaje: 'Ya en este modo',
                        modoActual: estadoApp.modo.actual
                    };
                }
                
                logger.info(`Iniciando cambio a modo: ${modo}${razon ? ` (${razon})` : ''}`, { origen });
                
                // Notificar a todos los hijos del cambio de modo
                try {
                    // Primero deshabilitar controles temporalmente
                    await enviarMensaje('todos', TIPOS_MENSAJE.CONTROL.DESHABILITAR, {
                        motivo: `Cambiando a modo ${modo}`,
                        timestamp: Date.now()
                    });
                    
                    // Actualizar el estado local
                    const modoAnterior = estadoApp.modo.actual;
                    estadoApp.modo.anterior = modoAnterior;
                    estadoApp.modo.actual = modo;
                    
                    // Asegurar que el mapa est√© visible y actualizado
                    const mapaDiv = document.getElementById('mapa');
                    if (mapaDiv) {
                        // Asegurar que el mapa est√© siempre visible
                        mapaDiv.style.display = 'block';
                        
                        // Si el mapa ya est√° creado, actualizarlo
                        if (window.mapa) {
                            // Forzar actualizaci√≥n del tama√±o
                            setTimeout(() => {
                                window.mapa.invalidateSize();
                                
                                // Centrar en la ubicaci√≥n actual si est√° disponible
                                if (estadoApp.ubicacionActual) {
                                    window.mapa.setView(
                                        [estadoApp.ubicacionActual.latitud, estadoApp.ubicacionActual.longitud],
                                        window.mapa.getZoom() || MAP_CONFIG.zoom
                                    );
                                }
                            }, 100);
                        } else {
                            // Inicializar el mapa si no est√° creado
                            iniciarSistemaMapa().catch(error => {
                                console.error('Error al iniciar el mapa:', error);
                            });
                        }
                    }
                    
                    // Notificar a todos los hijos del cambio de modo, incluyendo gpsActivo
                    await enviarMensaje('todos', TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, {
                        modo,
                        gpsActivo: modo === 'aventura',
                        origen: 'padre',
                        razon: `Cambio solicitado por ${origen}${razon ? `: ${razon}` : ''}`,
                        timestamp: Date.now()
                    });
                    
                    // Actualizar la interfaz
                    document.body.classList.toggle('modo-aventura', modo === 'aventura');
                    document.body.classList.toggle('modo-casa', modo === 'casa');
                    
                    logger.info(`Cambio a modo ${modo} completado`, { 
                        modoAnterior,
                        origenSolicitud: origen,
                        timestamp: Date.now()
                    });
                    
                    // Re-habilitar controles
                    await enviarMensaje('todos', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                        modo,
                        timestamp: Date.now()
                    });
                    
                    return { 
                        exito: true, 
                        modoAnterior,
                        modoActual: modo,
                        timestamp: Date.now()
                    };
                } catch (error) {
                    const errorMsg = `Error al cambiar a modo ${modo}: ${error.message}`;
                    logger.error(errorMsg, error);
                    
                    // Notificar del error
                    await enviarMensaje('todos', TIPOS_MENSAJE.SISTEMA.ERROR, {
                        codigo: 'ERROR_CAMBIO_MODO',
                        mensaje: errorMsg,
                        origen: 'padre',
                        stack: error.stack,
                        timestamp: Date.now()
                    });
                    
                    // Revertir cambios si es necesario
                    if (estadoApp.modo.actual !== modo) {
                        document.body.classList.toggle('modo-aventura', estadoApp.modo.actual === 'aventura');
                        document.body.classList.toggle('modo-casa', estadoApp.modo.actual === 'casa');
                    }
                    
                    return { 
                        exito: false, 
                        error: errorMsg,
                        modoActual: estadoApp.modo.actual,
                        timestamp: Date.now()
                    };
                }
            }

            /**
             * Maneja la selecci√≥n de un punto en el mapa
             * @param {Object} msg - Mensaje con los datos del punto seleccionado
             * @returns {Promise<Object>} Resultado de la operaci√≥n
             */
            async function manejarSeleccionPuntoCasa(msg) {
                const { punto, origen, timestamp } = msg.datos || {};
                
                if (!punto || !punto.padreid) {
                    const errorMsg = 'Datos de punto inv√°lidos o faltantes';
                    logger.error(errorMsg, { punto, origen, timestamp });
                    
                    await enviarMensaje(origen || 'todos', TIPOS_MENSAJE.SISTEMA.ERROR, {
                        codigo: 'PUNTO_INVALIDO',
                        mensaje: errorMsg,
                        origen: 'padre',
                        timestamp: Date.now(),
                        datos: { puntoId: punto?.padreid }
                    });
                    
                    return { 
                        exito: false, 
                        error: errorMsg,
                        timestamp: Date.now()
                    };
                }
                logger.info(`Recibida selecci√≥n de punto en modo casa: ${punto.padreid}`);

                // 1. Orquestar al mapa para que se centre en el punto
                await enviarMensaje('mapa', TIPOS_MENSAJE.NAVEGACION.ESTABLECER_DESTINO, { punto });

                // 2. Orquestar al hijo de audio para que cargue el audio correspondiente
                if (punto.audio_id) {
                    await enviarMensaje(CONFIG.HIJOS.AUDIO.id, TIPOS_MENSAJE.AUDIO.REPRODUCIR, { id: punto.audio_id });
                }

                // 3. Orquestar al hijo de retos si hay un reto
                if (punto.reto_id) {
                    await manejarMostrarReto({ datos: { retoId: punto.reto_id } });
                } else {
                    await manejarOcultarReto(); // Ocultar si no hay reto
                }

                // 4. Obtener y mostrar medios (imagen/video) desde hijo2
                const puntoId = punto.parada_id || punto.tramo_id;
                const respuestaMedios = await enviarMensaje(CONFIG.HIJOS.COORDENADAS.id, TIPOS_MENSAJE.DATOS.SOLICITAR_PARADAS, { puntoId });
                if (respuestaMedios.exito && respuestaMedios.datosPunto) {
                    const datosPunto = respuestaMedios.datosPunto;
                    // Aqu√≠ se podr√≠a mostrar la imagen/video en un overlay del padre si se desea
                    logger.info(`Medios para ${puntoId}:`, { img: datosPunto.imagen, video: datosPunto.video });
                }

                return { exito: true, mensaje: `Orquestaci√≥n para ${punto.padreid} iniciada.` };
            }

            /**
             * Maneja la finalizaci√≥n de la reproducci√≥n de audio
             * @param {Object} msg - Mensaje con los datos del audio
             * @returns {Promise<Object>} Resultado de la operaci√≥n
             */
            async function manejarAudioFinalizado(msg) {
                const { audioId, exito, error, origen, timestamp } = msg.datos || {};
                const logContext = { audioId, exito, origen, timestamp };
                
                if (!audioId) {
                    const errorMsg = 'ID de audio no proporcionado';
                    logger.error(errorMsg, logContext);
                    return { 
                        exito: false, 
                        error: errorMsg,
                        timestamp: Date.now()
                    };
                }
                
                if (exito) {
                    logger.info(`Audio finalizado correctamente: ${audioId}`, logContext);
                } else {
                    logger.error(`Error al reproducir audio ${audioId}: ${error || 'Error desconocido'}`, logContext);
                }
                
                return { 
                    exito: true, 
                    audioId,
                    timestamp: Date.now()
                };
            }

            /**
             * Maneja la finalizaci√≥n de un reto
             * @param {Object} msg - Mensaje con los datos del reto
             * @returns {Promise<Object>} Resultado de la operaci√≥n
             */
            async function manejarRetoCompletado(msg) {
                const { retoId, exito, puntuacion, datos, origen, timestamp } = msg.datos || {};
                const logContext = { retoId, exito, puntuacion, origen, timestamp };
                
                if (!retoId) {
                    const errorMsg = 'ID de reto no proporcionado';
                    logger.error(errorMsg, logContext);
                    return { 
                        exito: false, 
                        error: errorMsg,
                        timestamp: Date.now()
                    };
                }
                
                if (exito) {
                    logger.info(`Reto ${retoId} completado exitosamente`, logContext);
                    // Actualizar estado de la parada como completada
                    const parada = AVENTURA_PARADAS.find(p => p.reto_id === retoId);
                    if (parada) {
                        logger.info(`Parada ${parada.parada_id} marcada como completada`);
                        // Aqu√≠ podr√≠as actualizar el estado de la parada en la interfaz
                    }
                } else {
                    logger.warn(`Reto ${retoId} no completado`, logContext);
                }
                
                // Ocultar el reto despu√©s de completarse
                await manejarOcultarReto();
                
                return { 
                    exito: true, 
                    retoId,
                    timestamp: Date.now()
                };
            }

            /**
             * Muestra un reto en la interfaz
             * @param {Object} msg - Mensaje con los datos del reto a mostrar
             * @returns {Promise<Object>} Resultado de la operaci√≥n
             */
            async function manejarMostrarReto(msg) {
                const { retoId, datos, origen, timestamp } = msg?.datos || {};
                const logContext = { retoId, origen, timestamp };
                
                if (!retoId) {
                    const errorMsg = 'ID de reto no proporcionado';
                    logger.error(errorMsg, logContext);
                    return { 
                        exito: false, 
                        error: errorMsg,
                        timestamp: Date.now()
                    };
                }
                
                try {
                    const retoElement = document.getElementById('hijo4');
                    if (retoElement) {
                        retoElement.style.display = 'block';
                        logger.info(`Mostrando reto: ${retoId}`, logContext);
                        return { exito: true, retoId, timestamp: Date.now() };
                    } else {
                        throw new Error('Elemento de reto no encontrado');
                    }
                } catch (error) {
                    const errorMsg = `Error al mostrar reto ${retoId}: ${error.message}`;
                    logger.error(errorMsg, { ...logContext, error });
                    return { 
                        exito: false, 
                        error: errorMsg,
                        timestamp: Date.now()
                    };
                }
            }

            /**
             * Oculta el reto actual
             * @returns {Promise<Object>} Resultado de la operaci√≥n
             */
            async function manejarOcultarReto() {
                try {
                    const retoElement = document.getElementById('hijo4');
                    if (retoElement) {
                        retoElement.style.display = 'none';
                        logger.info('Reto ocultado');
                    }
                    return { 
                        exito: true, 
                        timestamp: Date.now() 
                    };
                } catch (error) {
                    const errorMsg = `Error al ocultar reto: ${error.message}`;
                    logger.error(errorMsg, { error });
                    return { 
                        exito: false, 
                        error: errorMsg,
                        timestamp: Date.now()
                    };
                }
            }

            // En el manejador de llegada a parada (ejemplo)
            function manejarLlegadaParada(msg) {
                const { paradaId, origen } = msg.datos || {};
                const paradaIndex = AVENTURA_PARADAS.findIndex(p => p.parada_id === paradaId);
                if (paradaIndex === -1) return;

                // Solo permitir avanzar si la parada anterior fue visitada
                if (paradaIndex > estadoApp.paradaActual + 1) {
                    logger.warn(`Intento de saltar parada. Actual: ${estadoApp.paradaActual}, solicitada: ${paradaIndex}`);
                    // Opcional: notificar al usuario/hijo que debe visitar la anterior primero
                    enviarMensaje(origen, TIPOS_MENSAJE.SISTEMA.ERROR, {
                        tipo: 'orden_paradas',
                        mensaje: 'Debes visitar la parada anterior antes de avanzar.',
                        paradaActual: estadoApp.paradaActual,
                        paradaSolicitada: paradaIndex
                    });
                    return;
                }

                // Si es la siguiente parada, actualizar el estado
                if (paradaIndex === estadoApp.paradaActual + 1) {
                    estadoApp.paradaActual = paradaIndex; // ‚Üê se actualiza la √∫ltima parada completada
                    // Notificar a todos los hijos la nueva parada activa
                    enviarMensaje('todos', TIPOS_MENSAJE.NAVEGACION.CAMBIO_PARADA, {
                        paradaId: AVENTURA_PARADAS[paradaIndex].parada_id,
                        index: paradaIndex
                    });
                }
            }

            // 8. FUNCIONES AUXILIARES
            function updateMapDebug(status, hideAfter = 0) {
                const el = document.getElementById('map-debug');
                if (el) {
                    el.style.display = 'block';
                    el.style.opacity = '1';
                    el.textContent = `Estado: ${status}`;
                    if (hideAfter > 0) {
                        setTimeout(() => {
                            el.style.opacity = '0';
                            setTimeout(() => el.style.display = 'none', 500);
                        }, hideAfter);
                    }
                }
            }
            // Make these available globally
            window.TIPOS_MENSAJE = TIPOS_MENSAJE;
            window.enviarMensaje = enviarMensaje;
            
            // Initialize the app
            try {
                await iniciarSistemaMapa();
                window.debugLog('Aplicaci√≥n inicializada correctamente');
            } catch (error) {
                console.error('Error al inicializar la aplicaci√≥n:', error);
            }
        } catch (error) {
            console.error('Error al inicializar la aplicaci√≥n:', error);
        }
    })();
    </script>
</body>
</html>
