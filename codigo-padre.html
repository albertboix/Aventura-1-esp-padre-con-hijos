<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Padre - Coordinador Central</title>
    <script type="module">
        import Mensajeria, { TIPOS_MENSAJE } from './mensajeria.js';
        
        // ================== ESTADO GLOBAL ==================
        const estadoGlobal = {
            modo: 'casa',
            gpsActivo: false,
            paradaActual: 0,
            tramoActual: 0,
            hijosListos: new Set(),
            mapa: null
        };
        
        // ================== INICIALIZACI√ìN ==================
        async function inicializar() {
            await Mensajeria.inicializarMensajeria({
                iframeId: 'padre',
                debug: true
            });
            
            // Registrar manejadores
            Mensajeria.registrarControlador(TIPOS_MENSAJE.SISTEMA.LISTO, manejarHijoListo);
            Mensajeria.registrarControlador(TIPOS_MENSAJE.NAVEGACION.CAMBIO_PARADA, manejarCambioParada);
            Mensajeria.registrarControlador(TIPOS_MENSAJE.AUDIO.FINALIZADO, manejarAudioFinalizado);
            
            console.log('üéØ Sistema padre inicializado');
        }
        
        // ================== MANEJADORES ==================
        async function manejarHijoListo(mensaje) {
            estadoGlobal.hijosListos.add(mensaje.origen);
            console.log(`‚úÖ Hijo listo: ${mensaje.origen}`);
            
            // Si todos los hijos est√°n listos, sincronizar estado
            if (estadoGlobal.hijosListos.size >= 4) {
                await sincronizarEstadoGlobal();
            }
        }
        
        async function manejarCambioParada(mensaje) {
            const { parada } = mensaje.datos;
            estadoGlobal.paradaActual = parada;
            
            // Notificar a todos los hijos
            await notificarATodosLosHijos(TIPOS_MENSAJE.NAVEGACION.CAMBIO_PARADA, { parada });
            
            // Reproducir audio correspondiente
            await Mensajeria.enviarMensaje('Av1_audio_esp', TIPOS_MENSAJE.AUDIO.REPRODUCIR, {
                archivo: `audio-P-${parada}`
            });
        }
        
        async function manejarAudioFinalizado(mensaje) {
            console.log('üéµ Audio finalizado, habilitando controles');
            await notificarATodosLosHijos('habilitar_controles', {});
        }
        
        // ================== FUNCIONES AUXILIARES ==================
        async function sincronizarEstadoGlobal() {
            const estado = {
                modo: estadoGlobal.modo,
                gpsActivo: estadoGlobal.gpsActivo,
                paradaActual: estadoGlobal.paradaActual,
                tramoActual: estadoGlobal.tramoActual
            };
            
            await notificarATodosLosHijos(TIPOS_MENSAJE.SISTEMA.INICIALIZACION, { estado });
        }
        
        async function notificarATodosLosHijos(tipo, datos) {
            const hijos = ['Av1-esp-retos-preguntas', 'Av1-botones-coordenadas', 'Av1-boton-casa', 'Av1_audio_esp'];
            
            for (const hijo of hijos) {
                try {
                    await Mensajeria.enviarMensaje(hijo, tipo, datos);
                } catch (error) {
                    console.error(`‚ùå Error notificando a ${hijo}:`, error);
                }
            }
        }
        
        // Inicializar cuando DOM est√© listo
        document.addEventListener('DOMContentLoaded', inicializar);
    </script>
</head>
<body>
    <div id="mapa-container">
        <!-- Aqu√≠ ir√≠a el mapa principal -->
    </div>
    
    <div id="iframes-container">
        <iframe id="Av1-esp-retos-preguntas" src="./Av1-esp-retos-preguntas.html"></iframe>
        <iframe id="Av1-botones-coordenadas" src="./Av1-botones-coordenadas.html"></iframe>
        <iframe id="Av1-boton-casa" src="./Av1-boton-casa.html"></iframe>
        <iframe id="Av1_audio_esp" src="./Av1_audio_esp.html"></iframe>
    </div>
</body>
</html>
            }
        }
        
        function detectarIframesHijos() {
            const iframes = document.querySelectorAll('iframe');
            console.log(`üîç Detectados ${iframes.length} iframes hijos`);
            
            iframes.forEach(iframe => {
                if (iframe.id) {
                    estadoPadre.iframesHijos.set(iframe.id, {
                        id: iframe.id,
                        elemento: iframe,
                        estado: 'detectado',
                        ultimaActividad: null
                    });
                }
            });
        }
        
        // ================== MANEJADORES ESPEC√çFICOS ==================
        async function cambiarModoGlobal(nuevoModo) {
            console.log(`üîÑ Cambiando modo global: ${estadoPadre.modoActual} ‚Üí ${nuevoModo}`);
            
            estadoPadre.modoActual = nuevoModo;
            
            // Notificar a todos los hijos
            const promesasNotificacion = Array.from(estadoPadre.iframesHijos.keys()).map(hijoId => 
                Mensajeria.enviarMensaje(hijoId, TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, {
                    modo: nuevoModo,
                    timestamp: Date.now()
                }).catch(error => {
                    console.warn(`‚ö†Ô∏è Error notificando a ${hijoId}:`, error.message);
                })
            );
            
            await Promise.allSettled(promesasNotificacion);
            console.log(`‚úÖ Modo global cambiado a: ${nuevoModo}`);
        }
        
        async function manejarLlegadaDestino(mensaje) {
            console.log('üéØ Llegada a destino detectada:', mensaje.datos);
            
            // Secuencia de acciones coordinadas
            try {
                // 1. Reproducir audio de llegada
                await Mensajeria.enviarMensaje('Av1_audio_esp', TIPOS_MENSAJE.AUDIO.REPRODUCIR, {
                    archivo: mensaje.datos.audioLlegada,
                    parada: mensaje.datos.parada
                });
                
                // 2. Mostrar reto correspondiente
                await Mensajeria.enviarMensaje('Av1-esp-retos-preguntas', TIPOS_MENSAJE.RETO.MOSTRAR, {
                    retoId: mensaje.datos.retoId,
                    parada: mensaje.datos.parada
                });
                
                // 3. Deshabilitar navegaci√≥n temporalmente
                await Mensajeria.enviarMensaje('Av1-botones-coordenadas', TIPOS_MENSAJE.SISTEMA.CONTROLES_DESHABILITADOS, {
                    motivo: 'reto_activo',
                    temporal: true
                });
                
            } catch (error) {
                console.error('‚ùå Error en secuencia de llegada:', error);
            }
        }
        
        async function manejarRetoCompletado(mensaje) {
            console.log('üèÜ Reto completado:', mensaje.datos);
            
            try {
                // 1. Reproducir audio de felicitaci√≥n
                await Mensajeria.enviarMensaje('Av1_audio_esp', TIPOS_MENSAJE.AUDIO.REPRODUCIR, {
                    archivo: 'felicitacion.mp3'
                });
                
                // 2. Habilitar navegaci√≥n nuevamente
                await Mensajeria.enviarMensaje('Av1-botones-coordenadas', TIPOS_MENSAJE.SISTEMA.CONTROLES_HABILITADOS, {
                    motivo: 'reto_completado'
                });
                
                // 3. Actualizar progreso
                actualizarProgreso(mensaje.datos.parada);
                
            } catch (error) {
                console.error('‚ùå Error procesando reto completado:', error);
            }
        }
        
        async function manejarAudioFinalizado(mensaje) {
            console.log('üîä Audio finalizado:', mensaje.datos);
            
            // L√≥gica para continuar con la siguiente acci√≥n
            if (mensaje.datos.tipoAudio === 'llegada') {
                // El audio de llegada termin√≥, preparar para el reto
                await prepararReto(mensaje.datos.parada);
            }
        }
        
        // ================== FUNCIONES DE UTILIDAD ==================
        function actualizarProgreso(parada) {
            // Actualizar barra de progreso u otros indicadores
            console.log(`üìä Progreso actualizado para parada: ${parada}`);
        }
        
        async function prepararReto(parada) {
            // Preparar el sistema para mostrar el reto
            console.log(`üéÆ Preparando reto para parada: ${parada}`);
        }
        
        // ================== MANEJO DE ERRORES ==================
        function manejarErrorComunicacion(error, contexto) {
            console.error(`‚ùå Error de comunicaci√≥n en ${contexto}:`, error);
            
            // Intentar reconexi√≥n si es necesario
            if (error.message.includes('timeout') || error.message.includes('no encontrado')) {
                console.log('üîÑ Intentando reconexi√≥n...');
                setTimeout(inicializarComunicacionBidireccional, 2000);
            }
        }
        
        // ================== INICIALIZACI√ìN ==================
        document.addEventListener('DOMContentLoaded', inicializarSistemaCentralizado);
        
        // Hacer funciones disponibles globalmente para compatibilidad
        window.estadoPadre = estadoPadre;
        window.cambiarModoGlobal = cambiarModoGlobal;
    </script>
</head>
<body>
    <h1>Sistema de Comunicaci√≥n Centralizada</h1>
    <div id="estado-sistema">
        <p>üîÑ Inicializando sistema centralizado...</p>
    </div>
    
    <!-- Los iframes hijos se cargar√°n aqu√≠ -->
    <iframe id="Av1_audio_esp" src="Av1_audio_esp.html"></iframe>
    <iframe id="Av1-botones-coordenadas" src="Av1-botones-coordenadas.html"></iframe>
    <iframe id="Av1-esp-retos-preguntas" src="Av1-esp-retos-preguntas.html"></iframe>
    <iframe id="Av1-boton-casa" src="Av1-boton-casa.html"></iframe>
</body>
</html>
            color: white;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .error-mensaje p {
            margin: 0 0 12px 0;
            line-height: 1.4;
        }
        
        .error-botones {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 12px;
        }
        
        .error-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }
        
        .error-btn-reintentar {
            background-color: white;
            color: #d32f2f;
        }
        
        .error-btn-cerrar {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.3) !important;
        }
        
        .error-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- Contenedor del mapa -->
    <div id="mapa"></div>

    <img id="logo-aventura" src="https://valenciavguides.github.io/Aventura-1-esp-padre-con-hijos/fotos_Av1/LOGO%20LETRAS%20FINAL%20transparente%20recorte.png" alt="Logo" style="position: fixed; top: -32px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 360px; height: 140px;" />

    <div id="info-parada"></div>
    
    <!-- Fondo blanco para el logo con borde naranja -->
    <div style="position: fixed; top: 0; left: 0; right: 0; width: 99%; margin: 0 auto; height: 80px; background: white; z-index: 2999; border: 2px solid #ec7c26; border-top: none; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;"></div>

    <!-- Rutas actualizadas para GitHub Pages -->
    <iframe id="hijo1-hamburguesa" src="./botones-y-subfunciones-hamburguesa.html" style="position:fixed; left:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; border: transparent; background:transparent; pointer-events:auto;"></iframe>
    <iframe id="hijo1-opciones" src="./botones-y-subfunciones-opciones.html" style="position:fixed; right:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; border: transparent; background:transparent; pointer-events:auto;"></iframe>
    <iframe id="hijo5-casa" src="./Av1-boton-casa.html" style="position:fixed; right:0; top:70px; width:99%; height:85px; z-index:10000; border: 1px solid red; background:transparent; pointer-events:auto; margin:0; padding:0; overflow:hidden; border-radius:0;"></iframe>

    <iframe id="hijo3" src="./Av1_audio_esp.html"
            style="position:fixed;
                   bottom:-6px;
                   left:50%;
                   transform:translateX(-50%);
                   height:165px;
                   width:310px;
                   z-index:1000;
                   border: transparent;
                   display:block;
                   pointer-events:auto;"></iframe>

    <iframe id="hijo2" src="./Av1-botones-coordenadas.html"
            style="position:fixed;
                   bottom:150px;
                   left:50%;
                   transform:translateX(-50%);
                   height:165px;
                   width:310px;
                   z-index:1001;
                   border: none !important;
                   background-color: transparent !important;
                   overflow: hidden;
                   pointer-events:auto;"
            allow="geolocation"
            frameborder="0"></iframe>

    <iframe id="hijo4" src="./Av1-esp-retos-preguntas.html" style="display:none;"></iframe>

    <div id="media-overlay">
        <div id="media-container">
            <button id="close-media">X</button>
            <video id="parada-video" controls></video>
            <img id="parada-imagen">
        </div>
    </div>
    
    <!-- Scripts de Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Scripts principales -->
    <script>
    'use strict';
    
    // ================== VARIABLES GLOBALES ==================
    let mapa = null;
    let mensajeria = null;
    let mapInitialized = false;
    
    // Variables globales
    window.paradaActual = 0;
    
    // ================== CONFIGURACIONES ==================
    const CONFIGURACIONES_MENSAJE = {
        UI: {
            maxReintentos: 1,
            timeout: 800,
            esperarRespuesta: false
        },
        AUDIO: {
            maxReintentos: 3,
            timeout: 5000,
            esperarRespuesta: true
        },
        GPS: {
            maxReintentos: 5,
            timeout: 10000,
            esperarRespuesta: true
        },
        RETO: {
            maxReintentos: 2,
            timeout: 3000,
            esperarRespuesta: true
        },
        SYNC: {
            maxReintentos: 3,
            timeout: 8000,
            esperarRespuesta: false
        }
    };
    
    // ================== ESTRUCTURA DE DATOS ==================
    const AVENTURA_PARADAS = [
        // Parada 0 ‚Äì INICIO (Torres de Serranos start) reto 2 (223, 226, 228, 229)//
        { tipo: "inicio", parada_id: 'P-0', audio_id: "audio-P-0", reto_id: "R-2" },
        // tramo 1 (Torres de Serranos ‚Üí Plaza de la crida) (2, 126,)//
        { tipo: "tramo", tramo_id: 'TR-1', audio_id: "audio-TR-1" },
        // Parada 1 - Plaza de la crida (Puente de Serranos) Reto 3 (233) //
        { tipo: "parada", parada_id: 'P-1', audio_id: "audio-P-1", reto_id: "R-3" },
        // tramo 2 (Plaza de la crida ‚Üí Calle Muro de Santa Ana) (81) //
        { tipo: "tramo", tramo_id: 'TR-2', audio_id: "audio-TR-2" },
        // Parada 2 (Calle Muro de Santa Ana) Reto 4 (68) //
        { tipo: "parada", parada_id: 'P-2', audio_id: "audio-P-2", reto_id: "R-4" },
        // tramo 3 (Calle Muro de Santa Ana ‚Üí Palacio de los Borgia) (52) //
        { tipo: "tramo", tramo_id: 'TR-3', audio_id: "audio-TR-3" },
        // Parada 3 (Iglesia de San Lorenzo) Reto 5 (686, 682-B, 462, 683, 684) //
        { tipo: "parada", parada_id: 'P-3', audio_id: "audio-P-3", reto_id: "R-5" },
        // tramo 4 (Iglesia de San Lorenzo ‚Üí Plaza de la Virgen) (465-B) //
        { tipo: "tramo", tramo_id: 'TR-4', audio_id: "audio-TR-4" },
        // Parada 4 (Plaza de la Virgen) Reto 6 (466, 467) //
        { tipo: "parada", parada_id: 'P-4', audio_id: "audio-P-4", reto_id: "R-6" },
        // Parada 5 (Plaza de la Virgen) Reto 7, 8 Puzzle plaza de la virgen (468)  //
        { 
            tipo: "parada", 
            parada_id: 'P-5', 
            audio_id: "audio-P-5", 
            retos: [
                { tipo: "reto", id: "R-7" },
                { tipo: "puzzle", id: "PZ-8" }
            ] 
        },
        // tramo 5 (Plaza de la Virgen ‚Üí Plaza de la Almo√≠na) (477-B, 479, 141, 83, 8-C) //
        { tipo: "tramo", tramo_id: 'TR-5', audio_id: "audio-TR-5" },
        // Parada 6 (Panel cer√°mico muro Catedral) Reto 9 (434, 440, 441, 442) //
        { tipo: "parada", parada_id: 'P-6', audio_id: "audio-P-6", reto_id: "R-9" },
        // Parada 7 (Capilla exterior catedral) Reto 10 (443, 444, 445) //
        { tipo: "parada", parada_id: 'P-7', audio_id: "audio-P-7", reto_id: "R-10" },
        // Parada 8 (Capilla exterior catedral) Reto 11 (445) //
        { tipo: "parada", parada_id: 'P-8', audio_id: "audio-P-8", reto_id: "R-11" },
        // Parada 9 (Arco Novo Catedral y Puerta Negra Bas√≠lica) (446, 355, 447, 11-B, 451, 452) //
        { tipo: "parada", parada_id: 'P-9', audio_id: "audio-P-9" },
        // Parada 10 (Casa del Punt de Gantxo) Reto 12 (51-C, 454, 455, 455-B, 456, 148) //
        { tipo: "parada", parada_id: 'P-10', audio_id: "audio-P-10", reto_id: "R-12"  },
        // tramo 6 (Plaza de la Almo√≠na (casa del punt de Gantxo) ‚Üí Plaza Decimo Junio Bruto) (457, 10-B)//
        { tipo: "tramo", tramo_id: 'TR-6', audio_id: "audio-TR-6" },
        // Parada 11 (Museo arqueol√≥gico La Almo√≠na) Reto 13 (458) //
        { tipo: "parada", parada_id: 'P-11', audio_id: "audio-P-11", reto_id: "R-13" },
        // Parada 12 (Museo arqueol√≥gico La Almo√≠na 2) (459, 460, 461) //
        { tipo: "parada", parada_id: 'P-12', audio_id: "audio-P-12" },
        // Parada 13 (Vista de la Catedral, Cimborrio) Reto 14 (8-C, 464) //
        { tipo: "parada", parada_id: 'P-13', audio_id: "audio-P-13", reto_id: "R-14" },
        // tramo 7 (Museo arqueol√≥gico La Almo√≠na ‚Üí Palacio Arzobispal) (85) //
        { tipo: "tramo", tramo_id: 'TR-7', audio_id: "audio-TR-7" },
        // Parada 14 (Palacio Arzobispal y Puerta Rom√°nica de la Catedral) Reto 15 (673, 86, 426-B, 141, 437, 438) //
        { tipo: "parada", parada_id: 'P-14', audio_id: "audio-P-14", reto_id: "R-15" },
        // Parada 15 (Puerta Rom√°nica de la Catedral) (439) //
        { tipo: "parada", parada_id: 'P-15', audio_id: "audio-P-15" },
        // tramo 8 (Puerta Rom√°nica de la Catedral ‚Üí Plaza del Ayuntamiento) (125) //
        { tipo: "tramo", tramo_id: 'TR-8', audio_id: "audio-TR-8" },
        // Parada 16 (Plaza del Ayuntamiento) (13-B, 263, 332, 14-C) //
        { tipo: "parada", parada_id: 'P-16', audio_id: "audio-P-16" },
        // tramo 9 (Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento) (334, 335) //
        { tipo: "tramo", tramo_id: 'TR-9', audio_id: "audio-TR-9" },
        // Parada 17 (Edificio del Ayuntamiento) Reto 16 (336, 337, 338) //
        { tipo: "parada", parada_id: 'P-17', audio_id: "audio-P-17", reto_id: "R-16" },
        // Parada 18 (Edificio del Ayuntamiento, leyenda del murci√©lago) (339, 340, 341, 54) //
        { tipo: "parada", parada_id: 'P-18', audio_id: "audio-P-18" },
        // tramo 10 (Edificio del Ayuntamiento ‚Üí Estaci√≥n del Norte) (87, 15-C) //
        { tipo: "tramo", tramo_id: 'TR-10', audio_id: "audio-TR-10" },
        // Parada 19 (Estaci√≥n del Norte) Reto 17, 18 Puzzle Estaci√≥n del Norte (326) //
        { 
            tipo: "parada", 
            parada_id: 'P-19', 
            audio_id: "audio-P-19", 
            retos: [
                { tipo: "reto", id: "R-17" },
                { tipo: "puzzle", id: "PZ-18" }
            ] 
        },
        // tramo 11 (Estaci√≥n del Norte ‚Üí Plaza de Toros) (20-C, 323-B, 88) //
        { tipo: "tramo", tramo_id: 'TR-11', audio_id: "audio-TR-11" },
        // Tramo 12 (Plaza de Toros ‚Üí Casa estilo √Årabe) (89, 3-D) //
        { tipo: "tramo", tramo_id: 'TR-12', audio_id: "audio-TR-12" },
        // Parada 20 (Casa estilo √Årabe) Reto 19 (99) //
        { tipo: "parada", parada_id: 'P-20', audio_id: "audio-P-20", reto_id: "R-19" },
        // Parada 21 (Casa estilo √Årabe, mitad Aventura) (100) //
        { tipo: "parada", parada_id: 'P-21', audio_id: "audio-P-21" },
        // tramo 13 (Casa estilo √Årabe ‚Üí Palacio de Comunicaciones) (21-B) //
        { tipo: "tramo", tramo_id: 'TR-13', audio_id: "audio-TR-13" },
        // Parada 22 (Palacio de Comunicaciones) Reto 20 y Reto 21 (700, 343, 344) //
        { tipo: "parada", parada_id: 'P-22', audio_id: "audio-P-22", retos: ["R-20", "R-21"] },
        // Parada 23 (Edificio Suay) Reto 21 (693, 693-B) //
        { tipo: "parada", parada_id: 'P-23', audio_id: "audio-P-23" ,reto_id: "R-21" },
        // tramo 14 (Palacio de Comunicaciones, edificio Suay ‚Üí Banco de Val√®ncia) (345, 347, 348, 22, 109) //
        { tipo: "tramo", tramo_id: 'TR-14', audio_id: "audio-TR-14" },
        // Parada 24 (Banco de Valencia) Reto 22 (349, 350) //
        { tipo: "parada", parada_id: 'P-24', audio_id: "audio-P-24", reto_id: "R-22" },
        // tramo 15 (Banco de Val√®ncia ‚Üí Palacio del Marqu√©s de Dos Aguas) (351, 23-B, 352, 354) //
        { tipo: "tramo", tramo_id: 'TR-15', audio_id: "audio-TR-15" },
        // Parada 25 (Palacio del Marqu√©s de Dos Aguas) (356, 357)//
        { tipo: "parada", parada_id: 'P-25', audio_id: "audio-P-25" },
        // tramo 16 (Palacio del Marqu√©s ‚Üí Mercado Central) (358, 359-B, 101) //
        { tipo: "tramo", tramo_id: 'TR-16', audio_id: "audio-TR-16" },
        // Parada 26 (Mercado central) Reto23 (701, 24-D, 361, 362, 363, 364) //
        { tipo: "parada", parada_id: 'P-26', audio_id: "audio-P-26", reto_id: "R-23" },
        // tramo 17 (Mercado Central ‚Üí Iglesia de los Santos Juanes) (274, 27-C) //
        { tipo: "tramo", tramo_id: 'TR-17', audio_id: "audio-TR-17" },
        // Parada 27 (Iglesia de los Santos Juanes) Reto 24) (365, 366) //
        { tipo: "parada", parada_id: 'P-27', audio_id: "audio-P-27", reto_id: "R-24" },
        // Parada 28 (Iglesia de los Santos Juanes reto 25) (367) //
        { tipo: "parada", parada_id: 'P-28', audio_id: "audio-P-28", reto_id: "R-25" },
        // tramo 18 (Iglesia Santos Juanes ‚Üí Lonja de Val√®ncia) (368, 369, 28, 370, 371, 372, 373, 374, 375, 376, 377) //
        { tipo: "tramo", tramo_id: 'TR-18', audio_id: "audio-TR-18" },
        // Parada 29 (Lonja Puerta de Los Pecados barquero) Reto 27 (378, 379) //
        { tipo: "parada", parada_id: 'P-29', audio_id: "audio-P-29", reto_id: "R-27" },
        // Parada 30 (Lonja Puerta de Los Pecados √°rbol muerto) Reto 28 (380, 381) //
        { tipo: "parada", parada_id: 'P-30', audio_id: "audio-P-30", reto_id: "R-28" },
        // tramo 19 (Lonja G√°rgolas) (383) //
        { tipo: "tramo", tramo_id: 'TR-19', audio_id: "audio-TR-19" },
        // Parada 31 (Lonja G√°rgolas √°ngel vasija) Reto 29 (384) //
        { tipo: "parada", parada_id: 'P-31', audio_id: "audio-P-31", reto_id: "R-29" },
        // Parada 32 (Lonja G√°rgolas barbudo y le√≥n) Reto 30 (385) //
        { tipo: "parada", parada_id: 'P-32', audio_id: "audio-P-32", reto_id: "R-30" },
        // Parada 33 (Lonja G√°rgolas fornicador ventana) Reto 31, Puzzle 26 ) (386) //
        { tipo: "parada", parada_id: 'P-33', audio_id: "audio-P-33", retos: [ { tipo: "reto", id: "R-31" }, { tipo: "puzzle", id: "PZ-26" } ] },
        // tramo 20 (Lonja ‚Üí Plaza del Doctor Collado) (388, 389, 390, 391, 392) //
        { tipo: "tramo", tramo_id: 'TR-20', audio_id: "audio-TR-20" },
        // tramo 21 (Plaza del Doctor Collado ‚Üí Plaza del Negrito) (333, 397, 41, 398, 198, 671, 522, 32-C) //
        { tipo: "tramo", tramo_id: 'TR-21', audio_id: "audio-TR-21" },
        // Parada 34 (Fuente del Negrito) Reto 32 (382, 501) //
        { tipo: "parada", parada_id: 'P-34', audio_id: "audio-P-34", reto_id: "R-32" },
        // tramo 22 (Plaza del Negrito ‚Üí Calle Caballeros) (33-B, 486, 480-B) //
        { tipo: "tramo", tramo_id: 'TR-22', audio_id: "audio-TR-22" },
        // Parada 35 (Palau de la Generalitat) (481-B, 482-B, 2-D) //
        { tipo: "parada", parada_id: 'P-35', audio_id: "audio-P-35" },
        // tramo 23 (Palacio de la Generalitat ‚Üí Calle de los Serranos - FINAL)  //
        { tipo: "tramo", tramo_id: 'TR-23', audio_id: "audio-TR-23" },
        // Parada 36 (Torres de Serranos Final) //
        { tipo: "parada", parada_id: 'P-36', audio_id: "audio-P-36" }
    ];
    
    // ================== FUNCIONES DE MANEJO DE ERRORES ==================
    function mostrarErrorEnInterfaz(mensaje, onRetry = null, opciones = {}) {
        const config = {
            tiempo: 10000,
            tipo: 'error',
            cerrable: true,
            ...opciones
        };
        
        // Eliminar mensajes anteriores
        const erroresAnteriores = document.querySelectorAll('.error-mensaje');
        erroresAnteriores.forEach(el => {
            if (!el.hasAttribute('data-persistente')) {
                el.remove();
            }
        });
        
        // Crear contenedor del mensaje
        const errorMsg = document.createElement('div');
        errorMsg.className = `error-mensaje error-tipo-${config.tipo}`;
        
        const estilosPorTipo = {
            error: { backgroundColor: '#d32f2f', borderColor: '#b71c1c', icon: '‚ùå' },
            advertencia: { backgroundColor: '#ff9800', borderColor: '#f57c00', icon: '‚ö†Ô∏è' },
            info: { backgroundColor: '#1976d2', borderColor: '#1565c0', icon: '‚ÑπÔ∏è' }
        };
        
        const estilo = estilosPorTipo[config.tipo] || estilosPorTipo.error;
        errorMsg.style.backgroundColor = estilo.backgroundColor;
        errorMsg.style.borderLeft = `4px solid ${estilo.borderColor}`;
        
        let contenidoHTML = `
            <h3>${estilo.icon} ${config.tipo.charAt(0).toUpperCase() + config.tipo.slice(1)}</h3>
            <p>${mensaje}</p>
            <div class="error-botones">
        `;
        
        if (onRetry && typeof onRetry === 'function') {
            contenidoHTML += `<button class="error-btn error-btn-reintentar" data-action="reintentar">Reintentar</button>`;
        }
        
        if (config.cerrable) {
            contenidoHTML += `<button class="error-btn error-btn-cerrar" data-action="cerrar">Cerrar</button>`;
        }
        
        contenidoHTML += '</div>';
        errorMsg.innerHTML = contenidoHTML;
        
        // Manejadores de eventos
        errorMsg.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            
            const action = target.getAttribute('data-action');
            if (action === 'reintentar' && onRetry) {
                onRetry();
            }
            cerrarMensaje(errorMsg);
        });
        
        document.body.appendChild(errorMsg);
        
        // Auto-eliminar
        let timeoutId;
        if (config.tiempo > 0) {
            timeoutId = setTimeout(() => cerrarMensaje(errorMsg), config.tiempo);
        }
        
        function cerrarMensaje(elemento) {
            if (elemento && document.body.contains(elemento)) {
                elemento.style.animation = 'fadeOut 0.3s ease-in-out';
                setTimeout(() => elemento.remove(), 300);
                if (timeoutId) clearTimeout(timeoutId);
            }
        }
        
        return () => cerrarMensaje(errorMsg);
    }
    
    // ================== FUNCIONES DE CONTROL ==================
    async function enableControls(modo = 'casa') {
        console.log(`Habilitando controles en modo: ${modo}`);
        try {
            if (mensajeria && typeof mensajeria.enviarMensaje === 'function') {
                const opcionesUI = CONFIGURACIONES_MENSAJE.UI;
                
                const promesas = [
                    mensajeria.enviarMensaje('hijo2', 'habilitar_controles', { modo }, opcionesUI),
                    mensajeria.enviarMensaje('hijo3', 'habilitar_controles', { modo }, opcionesUI),
                    mensajeria.enviarMensaje('hijo4', 'habilitar_controles', { modo }, opcionesUI),
                    mensajeria.enviarMensaje('hijo5-casa', 'habilitar_controles', { modo }, opcionesUI)
                ];
                
                await Promise.allSettled(promesas);
                console.log(`‚úÖ Controles habilitados en modo: ${modo}`);
            }
        } catch (error) {
            console.error('Error al habilitar controles:', error);
        }
        return Promise.resolve();
    }

    async function disableControls(motivo = 'desconocido') {
        console.log(`Deshabilitando controles. Motivo: ${motivo}`);
        try {
            if (mensajeria && typeof mensajeria.enviarMensaje === 'function') {
                const opcionesUI = CONFIGURACIONES_MENSAJE.UI;
                
                const promesas = [
                    mensajeria.enviarMensaje('hijo2', 'deshabilitar_controles', { motivo }, opcionesUI),
                    mensajeria.enviarMensaje('hijo3', 'deshabilitar_controles', { motivo }, opcionesUI),
                    mensajeria.enviarMensaje('hijo4', 'deshabilitar_controles', { motivo }, opcionesUI),
                    mensajeria.enviarMensaje('hijo5-casa', 'deshabilitar_controles', { motivo }, opcionesUI)
                ];
                
                await Promise.allSettled(promesas);
                console.log(`‚úÖ Controles deshabilitados. Motivo: ${motivo}`);
            }
        } catch (error) {
            console.error('Error al deshabilitar controles:', error);
        }
        return Promise.resolve();
    }
    
    // ================== FUNCIONES DE MENSAJER√çA OPTIMIZADAS ==================
    async function enviarMensajeOptimizado(destino, tipo, datos = {}, categoria = 'UI') {
        if (!mensajeria) {
            throw new Error('Sistema de mensajer√≠a no inicializado');
        }
        
        const configuracion = CONFIGURACIONES_MENSAJE[categoria] || CONFIGURACIONES_MENSAJE.UI;
        
        try {
            const resultado = await mensajeria.enviarMensaje(destino, tipo, datos, configuracion);
            console.log(`üì§ Mensaje enviado a ${destino}:`, tipo);
            return resultado;
        } catch (error) {
            console.error(`‚ùå Error enviando mensaje a ${destino}:`, error);
            throw error;
        }
    }
    
    async function enviarMensajeMultiple(tipo, datos = {}, categoria = 'UI') {
        const destinos = ['hijo2', 'hijo3', 'hijo4', 'hijo5-casa'];
        const configuracion = CONFIGURACIONES_MENSAJE[categoria] || CONFIGURACIONES_MENSAJE.UI;
        
        const promesas = destinos.map(destino => 
            enviarMensajeOptimizado(destino, tipo, datos, categoria)
                .catch(error => ({ destino, error }))
        );
        
        const resultados = await Promise.allSettled(promesas);
        
        const exitosos = resultados.filter(r => r.status === 'fulfilled').length;
        const fallidos = resultados.length - exitosos;
        
        console.log(`üìä Mensaje m√∫ltiple completado: ${exitosos} exitosos, ${fallidos} fallidos`);
        return { exitosos, fallidos, resultados };
    }
    
    // ================== FUNCIONES ESPEC√çFICAS DE COMUNICACI√ìN ==================
    async function enviarComandoAudio(comando, datos = {}) {
        return enviarMensajeOptimizado('hijo3', 'AUDIO.COMANDO', { comando, ...datos }, 'AUDIO');
    }
    
    async function actualizarCoordenadas(coordenadas) {
        return enviarMensajeOptimizado('hijo2', 'GPS.ACTUALIZAR', coordenadas, 'GPS');
    }
    
    async function enviarReto(retoData) {
        return enviarMensajeOptimizado('hijo4', 'RETO.NUEVO', retoData, 'RETO');
    }
    
    async function sincronizarEstado(estado) {
        return enviarMensajeMultiple('SISTEMA.SINCRONIZAR', estado, 'SYNC');
    }
    
    async function actualizarUITodos(datosUI) {
        return enviarMensajeMultiple('UI.ACTUALIZAR', datosUI, 'UI');
    }
    
    // ================== FUNCIONES ESPEC√çFICAS DEL MAPA ==================
    async function navegarAParada(paradaId, estado = 'objetivo') {
        return enviarMensajeMultiple('NAVEGACION.ESTADO', {
            accion: 'navegar_parada',
            paradaId: paradaId,
            estado: estado,
            timestamp: Date.now()
        }, 'GPS');
    }
    
    async function centrarMapaEn(lat, lng, zoom = 16) {
        return enviarMensajeMultiple('NAVEGACION.ESTADO', {
            accion: 'centrar_mapa',
            lat: lat,
            lng: lng,
            zoom: zoom,
            timestamp: Date.now()
        }, 'UI');
    }
    
    async function actualizarParadaActual(paradaId, estado = 'actual') {
        return enviarMensajeMultiple('NAVEGACION.ESTADO', {
            accion: 'actualizar_parada',
            paradaId: paradaId,
            estado: estado,
            timestamp: Date.now()
        }, 'UI');
    }
    
    async function iniciarGPS() {
        return enviarMensajeMultiple('GPS.COMANDO', {
            accion: 'iniciar_seguimiento',
            timestamp: Date.now()
        }, 'GPS');
    }
    
    async function detenerGPS() {
        return enviarMensajeMultiple('GPS.COMANDO', {
            accion: 'detener_seguimiento',
            timestamp: Date.now()
        }, 'GPS');
    }
    
    // ================== FUNCIONES DE INTERFAZ ==================
    function mostrarMensajeInfoParada(mensaje, esError = false) {
        const info = document.getElementById('info-parada');
        if (info) {
            info.textContent = mensaje;
            info.style.display = 'block';
            if (esError) {
                info.classList.add('error');
            } else {
                info.classList.remove('error');
            }
        }
    }
    
    function ocultarInfoParada() {
        const info = document.getElementById('info-parada');
        if (info) {
            info.style.display = 'none';
        }
    }
    
    function mostrarImagenOverlay(paradaId) {
        const overlay = document.getElementById('media-overlay');
        const img = document.getElementById('parada-imagen');
        const video = document.getElementById('parada-video');
        
        if (!overlay || !img) return;

        if (video) {
            video.style.display = 'none';
            video.pause && video.pause();
        }

        const rutaImagen = paradaId ? `./fotos_Av1/${paradaId}.jpg` : './fotos_Av1/default.jpg';
        img.src = rutaImagen;
        img.style.display = 'block';
        overlay.style.display = 'flex';

        const closeBtn = document.getElementById('close-media');
        if (closeBtn) {
            closeBtn.onclick = function(e) {
                e.stopPropagation();
                overlay.style.display = 'none';
                img.src = '';
            };
        }
    }
    
    function closeMediaOverlay() {
        const mediaOverlay = document.getElementById('media-overlay');
        if (mediaOverlay) {
            mediaOverlay.style.display = 'none';
            const mediaElement = mediaOverlay.querySelector('video, audio');
            if (mediaElement) {
                mediaElement.pause();
                mediaElement.currentTime = 0;
            }
        }
        
        // Notificar a los hijos
        ['hijo2', 'hijo3', 'hijo4', 'hijo5-casa'].forEach(id => {
            try {
                if (mensajeria) {
                    mensajeria.enviarMensaje(id, 'mediaOverlayClosed', {});
                }
            } catch (error) {
                console.error(`Error notificando a ${id}:`, error);
            }
        });
    }
    
    // ================== VARIABLES Y CAPAS DEL MAPA ==================
    let marcadoresParadas = new Map();
    let marcadoresUsuario = new Map();
    let rutasActivas = new Map();
    let capaPosicionUsuario = null;
    let watchId = null;
    let coordenadasParadas = new Map();
    
    // Inicializar coordenadas de las paradas
    function inicializarCoordenadasParadas() {
        // Coordenadas reales de Valencia para cada parada
        const coordenadas = new Map([
            ['P-0', [39.44859, -0.37489]], // Torres de Serranos
            ['P-1', [39.44799, -0.37520]], // Plaza de la Crida
            ['P-2', [39.44720, -0.37440]], // Calle Muro Santa Ana
            ['P-3', [39.44650, -0.37380]], // Iglesia San Lorenzo
            ['P-4', [39.44580, -0.37320]], // Plaza de la Virgen
            ['P-5', [39.44580, -0.37320]], // Plaza de la Virgen
            ['P-6', [39.44520, -0.37260]], // Panel cer√°mico Catedral
            ['P-7', [39.44480, -0.37200]], // Capilla exterior
            ['P-8', [39.44480, -0.37200]], // Capilla exterior
            ['P-9', [39.44440, -0.37140]], // Arco Novo Catedral
            ['P-10', [39.44400, -0.37080]], // Casa Punt Gantxo
            ['P-11', [39.44360, -0.37020]], // Museo Almo√≠na
            ['P-12', [39.44360, -0.37020]], // Museo Almo√≠na 2
            ['P-13', [39.44320, -0.36960]], // Vista Catedral
            ['P-14', [39.44280, -0.36900]], // Palacio Arzobispal
            ['P-15', [39.44240, -0.36840]], // Puerta Rom√°nica
            ['P-16', [39.44200, -0.36780]], // Plaza Ayuntamiento
            ['P-17', [39.44160, -0.36720]], // Edificio Ayuntamiento
            ['P-18', [39.44160, -0.36720]], // Ayuntamiento murci√©lago
            ['P-19', [39.44120, -0.36660]], // Estaci√≥n Norte
            ['P-20', [39.44080, -0.36600]], // Casa estilo √Årabe
            ['P-21', [39.44080, -0.36600]], // Casa estilo √Årabe
            ['P-22', [39.44040, -0.36540]], // Palacio Comunicaciones
            ['P-23', [39.44000, -0.36480]], // Edificio Suay
            ['P-24', [39.43960, -0.36420]], // Banco Valencia
            ['P-25', [39.43920, -0.36360]], // Palacio Marqu√©s
            ['P-26', [39.43880, -0.36300]], // Mercado Central
            ['P-27', [39.43840, -0.36240]], // Santos Juanes
            ['P-28', [39.43840, -0.36240]], // Santos Juanes
            ['P-29', [39.43800, -0.36180]], // Lonja Pecados
            ['P-30', [39.43800, -0.36180]], // Lonja √°rbol
            ['P-31', [39.43760, -0.36120]], // Lonja G√°rgolas
            ['P-32', [39.43760, -0.36120]], // Lonja barbudo
            ['P-33', [39.43760, -0.36120]], // Lonja fornicador
            ['P-34', [39.43720, -0.36060]], // Fuente Negrito
            ['P-35', [39.43680, -0.36000]], // Palau Generalitat
            ['P-36', [39.44859, -0.37489]]  // Torres Serranos Final
        ]);
        
        coordenadas.forEach((coords, paradaId) => {
            coordenadasParadas.set(paradaId, coords);
        });
        
        console.log('üìç Coordenadas de paradas inicializadas:', coordenadasParadas.size, 'paradas');
    }

    // ================== INICIALIZACI√ìN DEL MAPA ==================
    function inicializarMapa() {
        try {
            console.log('üîç Iniciando inicializaci√≥n del mapa...');
            
            if (typeof L === 'undefined') {
                throw new Error('La biblioteca Leaflet no est√° cargada correctamente');
            }
            
            const valenciaCoords = [39.44859, -0.37489];
            const mapContainer = document.getElementById('mapa');
            
            if (!mapContainer) {
                throw new Error('No se encontr√≥ el contenedor del mapa');
            }
            
            mapContainer.style.display = 'block';
            
            mapa = L.map('mapa', {
                center: valenciaCoords,
                zoom: 16,
                zoomControl: false,
                scrollWheelZoom: true,
                doubleClickZoom: true,
                boxZoom: true,
                rotate: false,
                touchRotate: false,
                bearing: 0,
                preferCanvas: true
            });
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors',
                detectRetina: true
            }).addTo(mapa);
            
            mapa.whenReady(() => {
                console.log('‚úÖ Mapa cargado correctamente');
                mapInitialized = true;
                window.mapa = mapa;
                
                setTimeout(() => {
                    mapa.invalidateSize({ animate: true });
                    
                    // Inicializar coordenadas y crear marcadores
                    inicializarCoordenadasParadas();
                    crearMarcadoresIniciales();
                    
                }, 100);
            });
            
            mapa.on('error', (error) => {
                console.error('‚ùå Error en el mapa:', error);
                mostrarErrorEnInterfaz('Error en el mapa: ' + (error.message || 'Error desconocido'));
            });
            
            return mapa;
            
        } catch (error) {
            console.error('‚ùå Error al inicializar el mapa:', error);
            mostrarErrorEnInterfaz(
                'Error al cargar el mapa: ' + (error.message || 'Error desconocido'),
                () => inicializarMapa()
            );
            return null;
        }
    }

    // ================== FUNCIONES DE MARCADORES ==================
    function crearMarcadoresIniciales() {
        console.log('üìç Creando marcadores iniciales...');
        
        // Crear marcadores para todas las paradas
        AVENTURA_PARADAS.forEach((item, index) => {
            if (item.tipo === 'parada' || item.tipo === 'inicio') {
                crearMarcadorParada(item.parada_id, index);
            }
        });
        
        console.log(`‚úÖ ${marcadoresParadas.size} marcadores de paradas creados`);
    }
    
    function crearMarcadorParada(paradaId, index = 0) {
        const coords = coordenadasParadas.get(paradaId);
        if (!coords) {
            console.warn(`‚ö†Ô∏è No se encontraron coordenadas para ${paradaId}`);
            return null;
        }
        
        const esActual = index === window.paradaActual;
        const esPasada = index < window.paradaActual;
        
        let color = '#9E9E9E'; // Gris por defecto
        let className = 'marcador-futuro';
        
        if (esActual) {
            color = '#4CAF50'; // Verde para actual
            className = 'marcador-actual';
        } else if (esPasada) {
            color = '#2196F3'; // Azul para visitadas
            className = 'marcador-visitada';
        }
        
        const marcador = L.circleMarker(coords, {
            radius: 8,
            fillColor: color,
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8,
            className: className
        });
        
        // Obtener informaci√≥n de la parada
        const infoParada = AVENTURA_PARADAS[index];
        let popupContent = `<b>Parada ${paradaId}</b><br>`;
        
        if (infoParada.reto_id) {
            popupContent += `Reto: ${infoParada.reto_id}<br>`;
        }
        if (infoParada.retos) {
            popupContent += `Retos: ${infoParada.retos.map(r => r.id).join(', ')}<br>`;
        }
        
        marcador.bindPopup(popupContent);
        marcador.addTo(mapa);
        
        marcadoresParadas.set(paradaId, marcador);
        
        return marcador;
    }
    
    function actualizarMarcadorParada(paradaId, estado = 'actual') {
        const marcador = marcadoresParadas.get(paradaId);
        if (!marcador) return;
        
        const colores = {
            'actual': '#4CAF50',
            'visitada': '#2196F3',
            'futuro': '#9E9E9E',
            'objetivo': '#FF5722'
        };
        
        marcador.setStyle({
            fillColor: colores[estado] || colores.futuro,
            radius: estado === 'actual' ? 10 : 8
        });
    }
    
    function crearMarcadorUsuario(lat, lng, tipo = 'usuario') {
        const colores = {
            'usuario': '#E91E63',
            'destino': '#FF5722',
            'temporal': '#FFC107'
        };
        
        const marcador = L.circleMarker([lat, lng], {
            radius: 6,
            fillColor: colores[tipo],
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 1
        });
        
        marcador.addTo(mapa);
        marcadoresUsuario.set(tipo, marcador);
        
        return marcador;
    }

    // ================== FUNCIONES DE GEOLOCALIZACI√ìN ==================
    function iniciarSeguimientoGPS() {
        if (!navigator.geolocation) {
            console.error('‚ùå Geolocalizaci√≥n no soportada');
            mostrarErrorEnInterfaz('Tu dispositivo no soporta geolocalizaci√≥n');
            return false;
        }
        
        const opciones = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 30000
        };
        
        watchId = navigator.geolocation.watchPosition(
            (position) => {
                const { latitude, longitude, accuracy } = position.coords;
                actualizarPosicionUsuario(latitude, longitude, accuracy);
            },
            (error) => {
                console.error('‚ùå Error de geolocalizaci√≥n:', error);
                mostrarErrorEnInterfaz(`Error GPS: ${error.message}`);
            },
            opciones
        );
        
        console.log('üìç Seguimiento GPS iniciado');
        return true;
    }
    
    function detenerSeguimientoGPS() {
        if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
            console.log('üìç Seguimiento GPS detenido');
        }
    }
    
    function actualizarPosicionUsuario(lat, lng, accuracy = 0) {
        // Actualizar o crear marcador de posici√≥n
        if (capaPosicionUsuario) {
            mapa.removeLayer(capaPosicionUsuario);
        }
        
        capaPosicionUsuario = L.circleMarker([lat, lng], {
            radius: 8,
            fillColor: '#E91E63',
            color: '#fff',
            weight: 3,
            opacity: 1,
            fillOpacity: 1
        }).addTo(mapa);
        
        // Agregar c√≠rculo de precisi√≥n si es necesario
        if (accuracy > 0 && accuracy < 100) {
            L.circle([lat, lng], {
                radius: accuracy,
                fillColor: 'transparent',
                color: '#E91E63',
                weight: 1,
                opacity: 0.3
            }).addTo(mapa);
        }
        
        // Notificar a los hijos usando el sistema centralizado
        enviarMensajeMultiple('GPS.ACTUALIZAR', {
            lat, lng, accuracy, timestamp: Date.now()
        }, 'GPS');
        
        console.log(`üìç Posici√≥n actualizada: ${lat}, ${lng} (¬±${accuracy}m)`);
    }

    // ================== FUNCIONES DE RUTAS Y NAVEGACI√ìN ==================
    function crearRuta(origen, destino, tipo = 'walking') {
        if (!origen || !destino) {
            console.error('‚ùå Origen o destino no definidos para la ruta');
            return null;
        }
        
        // Para simplicidad, crear una l√≠nea directa
        // En producci√≥n, usar un servicio de routing como OpenRouteService
        const ruta = L.polyline([origen, destino], {
            color: '#2196F3',
            weight: 4,
            opacity: 0.8,
            dashArray: tipo === 'estimated' ? '5, 10' : null
        });
        
        ruta.addTo(mapa);
        
        const rutaId = `ruta_${Date.now()}`;
        rutasActivas.set(rutaId, ruta);
        
        return rutaId;
    }
    
    function eliminarRuta(rutaId) {
        const ruta = rutasActivas.get(rutaId);
        if (ruta) {
            mapa.removeLayer(ruta);
            rutasActivas.delete(rutaId);
            return true;
        }
        return false;
    }
    
    function calcularDistancia(lat1, lng1, lat2, lng2) {
        const R = 6371e3; // Radio de la Tierra en metros
        const œÜ1 = lat1 * Math.PI/180;
        const œÜ2 = lat2 * Math.PI/180;
        const ŒîœÜ = (lat2-lat1) * Math.PI/180;
        const ŒîŒª = (lng2-lng1) * Math.PI/180;
        
        const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                  Math.cos(œÜ1) * Math.cos(œÜ2) *
                  Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        
        return R * c; // Distancia en metros
    }
    
    function navegarAParada(paradaId) {
        const coords = coordenadasParadas.get(paradaId);
        if (!coords) {
            console.error(`‚ùå No se encontraron coordenadas para ${paradaId}`);
            return false;
        }
        
        // Centrar mapa en la parada
        mapa.setView(coords, 18, { animate: true, duration: 1 });
        
        // Resaltar marcador
        actualizarMarcadorParada(paradaId, 'objetivo');
        
        // Notificar a los hijos usando el sistema centralizado
        enviarMensajeMultiple('NAVEGACION.ESTADO', {
            accion: 'parada_objetivo',
            paradaId,
            coordenadas: coords,
            timestamp: Date.now()
        }, 'GPS');
        
        console.log(`üß≠ Navegando a parada ${paradaId}`);
        return true;
    }

    // ================== FUNCIONES DE CAPAS ADICIONALES ==================
    function agregarCapaPersonalizada(nombre, datos, opciones = {}) {
        try {
            let capa;
            
            switch (datos.tipo) {
                case 'geojson':
                    capa = L.geoJSON(datos.contenido, opciones);
                    break;
                case 'markers':
                    capa = L.featureGroup();
                    datos.contenido.forEach(item => {
                        const marcador = L.marker(item.coords)
                            .bindPopup(item.popup || '');
                        capa.addLayer(marcador);
                    });
                    break;
                default:
                    console.error(`‚ùå Tipo de capa no soportado: ${datos.tipo}`);
                    return null;
            }
            
            capa.addTo(mapa);
            console.log(`‚úÖ Capa '${nombre}' agregada al mapa`);
            return capa;
            
        } catch (error) {
            console.error(`‚ùå Error al agregar capa '${nombre}':`, error);
            return null;
        }
    }

    // ================== FUNCIONES P√öBLICAS PARA LOS HIJOS ==================
    window.mapaFunciones = {
        // Marcadores
        crearMarcadorParada,
        actualizarMarcadorParada,
        crearMarcadorUsuario,
        
        // Geolocalizaci√≥n
        iniciarSeguimientoGPS,
        detenerSeguimientoGPS,
        actualizarPosicionUsuario,
        
        // Rutas y navegaci√≥n
        crearRuta,
        eliminarRuta,
        calcularDistancia,
        navegarAParada,
        
        // Capas
        agregarCapaPersonalizada,
        
        // Utilidades
        centrarMapa: (lat, lng, zoom = 16) => {
            if (mapa) mapa.setView([lat, lng], zoom, { animate: true });
        },
        
        obtenerCoordenadas: (paradaId) => coordenadasParadas.get(paradaId),
        
        obtenerTodasParadas: () => Array.from(coordenadasParadas.entries()),
        
        // Estado
        estaInicializado: () => mapInitialized,
        obtenerMapa: () => mapa
    };
    
    // ================== INICIALIZACI√ìN DEL SISTEMA DE MENSAJER√çA ==================
    async function inicializarMensajeria() {
        try {
            console.log('üì° Inicializando sistema de mensajer√≠a...');
            
            const module = await import('./js/mensajeria.js');
            mensajeria = module.default || module;
            window.Mensajeria = mensajeria;
            
            if (!mensajeria || typeof mensajeria.inicializarMensajeria !== 'function') {
                throw new Error('La API de mensajer√≠a no es v√°lida');
            }
            
            const configuracion = {
                iframeId: 'padre',
                debug: true
            };
            
            if (mensajeria.LOG_LEVELS) {
                configuracion.logLevel = mensajeria.LOG_LEVELS.INFO;
            }
            
            await mensajeria.inicializarMensajeria(configuracion);
            console.log('‚úÖ Sistema de mensajer√≠a inicializado correctamente');
            
            // Configurar manejadores
            configurarManejadoresMensajes();
            
            return mensajeria;
        } catch (error) {
            console.error('‚ùå Error cr√≠tico al inicializar el sistema de mensajer√≠a:', error);
            mostrarErrorEnInterfaz('Error al cargar la aplicaci√≥n. Por favor, recarga la p√°gina.');
            throw error;
        }
    }
    
    // ================== CONFIGURACI√ìN DE MANEJADORES ==================
    function configurarManejadoresMensajes() {
        if (!mensajeria || !mensajeria.registrarControlador) {
            console.warn('‚ö†Ô∏è No se pueden configurar manejadores: mensajer√≠a no disponible');
            return;
        }
        
        // Manejador de inicializaci√≥n
        mensajeria.registrarControlador('SISTEMA.INICIALIZACION', (mensaje) => {
            console.log(`‚úÖ ${mensaje.origen} inicializado`);
        });
        
        // Manejador de cambio de modo
        mensajeria.registrarControlador('MODO.CAMBIAR', async (mensaje) => {
            console.log(`üîÑ Cambio de modo desde ${mensaje.origen}:`, mensaje.datos);
            
            try {
                const { modo, accion } = mensaje.datos;
                
                if (accion === 'habilitar') {
                    await enableControls(modo);
                } else if (accion === 'deshabilitar') {
                    await disableControls('cambio_de_modo');
                }
                
                // Sincronizar con otros hijos
                await sincronizarEstado({ modo, ultimaActualizacion: Date.now() });
                
            } catch (error) {
                console.error('‚ùå Error en cambio de modo:', error);
            }
        });
        
        // Manejador de navegaci√≥n - EXTENDIDO PARA MAPA
        mensajeria.registrarControlador('NAVEGACION.ESTADO', (mensaje) => {
            console.log(`üß≠ Navegaci√≥n desde ${mensaje.origen}:`, mensaje.datos);
            
            // Manejar navegaci√≥n a paradas
            if (mensaje.datos.accion === 'navegar_parada' && mensaje.datos.paradaId) {
                if (window.mapaFunciones) {
                    window.mapaFunciones.navegarAParada(mensaje.datos.paradaId);
                }
            }
            
            // Manejar centrado del mapa
            if (mensaje.datos.accion === 'centrar_mapa' && mensaje.datos.lat && mensaje.datos.lng) {
                if (window.mapaFunciones) {
                    window.mapaFunciones.centrarMapa(mensaje.datos.lat, mensaje.datos.lng, mensaje.datos.zoom);
                }
            }
            
            // Manejar actualizaci√≥n de parada actual
            if (mensaje.datos.accion === 'actualizar_parada' && mensaje.datos.paradaId) {
                if (window.mapaFunciones) {
                    window.mapaFunciones.actualizarMarcadorParada(mensaje.datos.paradaId, mensaje.datos.estado || 'actual');
                    // Actualizar variable global
                    if (mensaje.datos.estado === 'actual') {
                        const paradaIndex = AVENTURA_PARADAS.findIndex(p => p.parada_id === mensaje.datos.paradaId);
                        if (paradaIndex !== -1) {
                            window.paradaActual = paradaIndex;
                        }
                    }
                }
            }
        });
        
        // Manejador de audio
        mensajeria.registrarControlador('AUDIO.ESTADO', (mensaje) => {
            console.log(`üîä Audio desde ${mensaje.origen}:`, mensaje.datos);
        });
        
        // Manejador de retos
        mensajeria.registrarControlador('RETO.ESTADO', (mensaje) => {
            console.log(`üéØ Reto desde ${mensaje.origen}:`, mensaje.datos);
        });
        
        // Manejador de GPS - EXTENDIDO PARA MAPA
        mensajeria.registrarControlador('GPS.COMANDO', (mensaje) => {
            console.log(`üì° Comando GPS desde ${mensaje.origen}:`, mensaje.datos);
            
            if (mensaje.datos.accion === 'iniciar_seguimiento') {
                if (window.mapaFunciones) {
                    window.mapaFunciones.iniciarSeguimientoGPS();
                }
            }
            
            if (mensaje.datos.accion === 'detener_seguimiento') {
                if (window.mapaFunciones) {
                    window.mapaFunciones.detenerSeguimientoGPS();
                }
            }
            
            if (mensaje.datos.accion === 'crear_marcador' && mensaje.datos.lat && mensaje.datos.lng) {
                if (window.mapaFunciones) {
                    window.mapaFunciones.crearMarcadorUsuario(mensaje.datos.lat, mensaje.datos.lng, mensaje.datos.tipo || 'usuario');
                }
            }
        });
        
        // Manejador de confirmaciones
        mensajeria.registrarControlador('SISTEMA.CONFIRMACION', (mensaje) => {
            console.log(`‚úì Confirmaci√≥n de ${mensaje.origen}:`, mensaje.datos);
        });
        
        // Manejador de errores
        mensajeria.registrarControlador('SISTEMA.ERROR', (mensaje) => {
            console.error(`‚ùå Error de ${mensaje.origen}:`, mensaje.datos);
        });
        
        console.log('‚úÖ Manejadores de mensajes configurados');
    }
    
    // ================== INICIALIZACI√ìN PRINCIPAL ==================
    async function inicializarAplicacion() {
        console.log('üöÄ Inicializando aplicaci√≥n...');
        
        try {
            // 1. Inicializar mensajer√≠a
            await inicializarMensajeria();
            
            // 2. Inicializar mapa
            inicializarMapa();
            
            // 3. Configurar overlay de medios
            const overlay = document.getElementById('media-overlay');
            if (overlay) {
                overlay.onclick = closeMediaOverlay;
            }
            
            // 4. Establecer variables globales
            window.paradaActual = 0;
            
            // 5. Hacer funciones accesibles globalmente - SISTEMA CENTRALIZADO
            window.enableControls = enableControls;
            window.disableControls = disableControls;
            window.enviarMensajeOptimizado = enviarMensajeOptimizado;
            window.enviarMensajeMultiple = enviarMensajeMultiple;
            window.enviarComandoAudio = enviarComandoAudio;
            window.actualizarCoordenadas = actualizarCoordenadas;
            window.enviarReto = enviarReto;
            window.sincronizarEstado = sincronizarEstado;
            window.actualizarUITodos = actualizarUITodos;
            
            // Funciones espec√≠ficas del mapa usando el sistema centralizado
            window.navegarAParada = navegarAParada;
            window.centrarMapaEn = centrarMapaEn;
            window.actualizarParadaActual = actualizarParadaActual;
            window.iniciarGPS = iniciarGPS;
            window.detenerGPS = detenerGPS;
            
            // Funciones de interfaz
            window.mostrarMensajeInfoParada = mostrarMensajeInfoParada;
            window.ocultarInfoParada = ocultarInfoParada;
            window.mostrarImagenOverlay = mostrarImagenOverlay;
            window.closeMediaOverlay = closeMediaOverlay;
            window.mostrarErrorEnInterfaz = mostrarErrorEnInterfaz;
            
            // Datos y configuraciones
            window.CONFIGURACIONES_MENSAJE = CONFIGURACIONES_MENSAJE;
            window.AVENTURA_PARADAS = AVENTURA_PARADAS;
            
            // Esperar a que el mapa est√© listo antes de exponer las funciones
            const esperarMapa = setInterval(() => {
                if (window.mapaFunciones && window.mapaFunciones.estaInicializado()) {
                    console.log('üó∫Ô∏è Funciones de mapa disponibles para los hijos');
                    clearInterval(esperarMapa);
                    
                    // Notificar a los hijos que el mapa est√° listo usando el sistema centralizado
                    setTimeout(() => {
                        enviarMensajeMultiple('SISTEMA.SINCRONIZAR', {
                            mapaListo: true,
                            funcionesDisponibles: [
                                'navegarAParada',
                                'centrarMapaEn', 
                                'actualizarParadaActual',
                                'iniciarGPS',
                                'detenerGPS'
                            ],
                            paradaActual: window.paradaActual,
                            coordenadasDisponibles: window.mapaFunciones.obtenerTodasParadas()
                        }, 'SYNC');
                    }, 1000);
                }
            }, 100);
            
            console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
            
        } catch (error) {
            console.error('‚ùå Error al inicializar la aplicaci√≥n:', error);
            mostrarErrorEnInterfaz('Error cr√≠tico al inicializar la aplicaci√≥n');
        }
    }
    
    // ================== EVENTOS DE INICIALIZACI√ìN ==================
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializarAplicacion);
    } else {
        inicializarAplicacion();
    }
    
    // Forzar inicializaci√≥n adicional despu√©s de la carga completa
    window.addEventListener('load', () => {
        setTimeout(() => {
            if (mapa && mapa.invalidateSize) {
                mapa.invalidateSize(true);
                console.log('üîÑ Tama√±o del mapa actualizado');
            }
        }, 500);
    });
    
    </script>
</body>
</html>
