<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Aventura 1 - Padre</title>
    
    <!-- Pol√≠tica de seguridad de contenido mejorada -->
    <!-- Hojas de estilo -->
    <script>
      // Inicializaci√≥n b√°sica del mapa
      document.addEventListener('DOMContentLoaded', function() {
        console.log('Inicializando aplicaci√≥n...');
        // Inicializar el mapa cuando el DOM est√© listo
        if (window.inicializarAplicacion && typeof window.inicializarAplicacion === 'function') {
          window.inicializarAplicacion();
        }
      });
    </script>
    
    <title>Valencia Tour</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="js/mensajeria.js" type="module"></script>
    
    <!-- Script de Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
    // Inicializaci√≥n del mapa y mensajer√≠a
    document.addEventListener('DOMContentLoaded', async function() {
        // Inicializar el sistema de mensajer√≠a
        try {
            // Esperar a que el m√≥dulo de mensajer√≠a est√© disponible
            const esperarMensajeria = setInterval(() => {
                if (window.Mensajeria) {
                    clearInterval(esperarMensajeria);
                    
                    const mensajeria = window.Mensajeria;
                    
                    // Configuraci√≥n de la mensajer√≠a
                    mensajeria.inicializarMensajeria({
                        iframeId: 'padre',
                        logLevel: mensajeria.LOG_LEVELS.DEBUG, // M√°s detallado para depuraci√≥n
                        debug: true,
                        dominioPermitido: window.location.origin,
                        maxRetries: 3,
                        retryDelay: 1000
                    });
                    
                    // Registrar manejadores de mensajes con el nuevo sistema
                    mensajeria.registrarControlador(mensajeria.TIPOS_MENSAJE.NAVEGACION, manejarMensajeHijo2);
                    mensajeria.registrarControlador(mensajeria.TIPOS_MENSAJE.AUDIO, manejarMensajeHijo3);
                    mensajeria.registrarControlador(mensajeria.TIPOS_MENSAJE.RETO, manejarMensajeHijo4);
                    mensajeria.registrarControlador(mensajeria.TIPOS_MENSAJE.CONFIRMACION, manejarConfirmacion);
                    mensajeria.registrarControlador(mensajeria.TIPOS_MENSAJE.INICIALIZACION, manejarInicializacionHijo);
                    
                    // Registrar manejadores espec√≠ficos para navegaci√≥n
                    mensajeria.registrarControlador('inicio-navegacion', manejarInicioNavegacion);
                    mensajeria.registrarControlador('fin-navegacion', manejarFinNavegacion);
                    mensajeria.registrarControlador('llegada-parada', manejarLlegadaAParada);
                    mensajeria.registrarControlador('ocultar-flecha-navegacion', manejarOcultarFlecha);
                    
                    console.log('‚úÖ Sistema de mensajer√≠a inicializado correctamente', {
                        version: '1.1.0',
                        timestamp: new Date().toISOString(),
                        config: {
                            iframeId: 'padre',
                            logLevel: 'DEBUG',
                            dominioPermitido: window.location.origin
                        }
                    });
                    
                    // Notificar a la interfaz que la mensajer√≠a est√° lista
                    if (window.mostrarMensajeInfoParada) {
                        window.mostrarMensajeInfoParada('Sistema de mensajer√≠a inicializado correctamente');
                    }
                }
            }, 100);
            
            // Timeout para la inicializaci√≥n
            setTimeout(() => {
                if (!window.Mensajeria) {
                    console.error('‚ùå Tiempo de espera agotado: No se pudo cargar el m√≥dulo de mensajer√≠a');
                    mostrarErrorEnInterfaz('Error al cargar el sistema de mensajer√≠a');
                }
            }, 5000);
            
        } catch (error) {
            console.error('‚ùå Error cr√≠tico al inicializar el sistema de mensajer√≠a:', {
                error: error.message,
                stack: error.stack,
                timestamp: new Date().toISOString()
            });
            
            // Mostrar error en la interfaz
            mostrarErrorEnInterfaz(`Error cr√≠tico: ${error.message}`);
            
            // Intentar notificar al servidor del error
            if (window.navigator && window.navigator.sendBeacon) {
                const errorData = {
                    tipo: 'error_critico',
                    mensaje: error.message,
                    stack: error.stack,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };
                
                try {
                    navigator.sendBeacon('/api/errores', JSON.stringify(errorData));
                } catch (e) {
                    console.error('No se pudo enviar el informe de error:', e);
                }
            }
        }
        // Configuraci√≥n del mapa con mejoras t√°ctiles
        const valenciaCoords = [39.44859, -0.37489]; // Coordenadas exactas de Valencia
        const map = L.map('mapa', {
            center: valenciaCoords,
            zoom: 13,
            zoomControl: false, // Desactivar control de zoom
            tap: true, // Habilitar toques t√°ctiles
            touchZoom: false, // Deshabilitar zoom t√°ctil
            scrollWheelZoom: true, // habilitar zoom con rueda del rat√≥n
            doubleClickZoom: false, // Deshabilitar zoom con doble clic
            boxZoom: false, // Deshabilitar zoom con arrastre
            dragging: true, // Mantener arrastre del mapa
            keyboard: false, // Deshabilitar navegaci√≥n con teclado
            inertia: true, // Inercia al arrastrar
            inertiaDeceleration: 3000, // Deceleraci√≥n de la inercia
            inertiaMaxSpeed: 1500, // Velocidad m√°xima de inercia
            easeLinearity: 0.2, // Suavizado del movimiento
            worldCopyJump: false, // Evitar saltos al arrastrar
            maxBoundsViscosity: 0.7, // Resistencia a salir de los l√≠mites
            tapTolerance: 15, // Tolerancia para toques t√°ctiles
            preferCanvas: true // Mejor rendimiento para muchos marcadores
        });

        // A√±adir capa de OpenStreetMap
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 25,  // Aumentado a 25 para permitir mayor zoom
            minZoom: 12,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            detectRetina: true
        }).addTo(map);

        // Funci√≥n para crear un marcador personalizado
        function crearMarcador(lat, lng, tipo, texto = '') {
            let icono;
            
            switch(tipo) {
                case 'inicio':
                    icono = L.divIcon({
                        className: 'custom-marker',
                        html: '<div class="marker-pin start"></div><span>Inicio</span>',
                        iconSize: [30, 42],
                        iconAnchor: [15, 42],
                        popupAnchor: [0, -42]
                    });
                    break;
                    
                case 'destino':
                    icono = L.divIcon({
                        className: 'custom-marker',
                        html: '<div class="marker-pin end"></div><span>Destino</span>',
                        iconSize: [30, 42],
                        iconAnchor: [15, 42],
                        popupAnchor: [0, -42]
                    });
                    break;
                    
                case 'parada':
                    icono = L.divIcon({
                        className: 'marcador-inicio',
                        html: 'üìç',
                        iconSize: [30, 30],
                        iconAnchor: [15, 30],
                        popupAnchor: [0, -30]
                    });
                    break;
                    
                default:
                    icono = L.divIcon({
                        className: 'custom-marker',
                        html: '<div class="marker-pin"></div><span>' + (texto || '') + '</span>',
                        iconSize: [30, 42],
                        iconAnchor: [15, 42],
                        popupAnchor: [0, -42]
                    });
            }
            
            return L.marker([lat, lng], { icon: icono });
        }

        // Forzar actualizaci√≥n del tama√±o del mapa despu√©s de un breve retraso
        setTimeout(() => {
            map.invalidateSize({ animate: true });
            console.log('‚úÖ Mapa inicializado correctamente');
        }, 100);
        
        // Hacer el mapa accesible globalmente
        window.mapa = map;
        
        // Configurar eventos t√°ctiles mejorados
        map.on('touchstart', function(e) {
            // console.log('Toque detectado en:', e.latlng);
        });
        
        map.on('touchmove', function(e) {
            // Comportamiento personalizado durante el arrastre
        });
        
        map.on('touchend', function(e) {
            // console.log('Toque finalizado en:', e.latlng);
        });
        
        // Configurar gesto de pellizco para zoom
        map.touchZoom.enable();
        
        // Mejorar la experiencia t√°ctil en dispositivos m√≥viles
        if (L.Browser.touch) {
            // Desactivar rotaci√≥n t√°ctil para evitar cambios accidentales
            map.dragging._touchRotate.disable();
            map.dragging._touchZoom.disable();
            
            // Mejorar la respuesta t√°ctil
            map.tap?.enable();
        }
        
        // Deshabilitar controles de zoom
        map.touchZoom.disable();
        map.doubleClickZoom.disable();
        map.scrollWheelZoom.disable();
        map.boxZoom.disable();
        map.keyboard.disable();
        
        // Funci√≥n para manejar el gesto de pellizco
        function handlePinch(e) {
            // La biblioteca Leaflet ya maneja el gesto de pellizco internamente
            // Esta funci√≥n se puede usar para personalizar el comportamiento
        }
        
        // Agregar manejador de eventos para el gesto de pellizco
        map.on('zoomstart', function(e) {
            if (e.originalEvent && e.originalEvent.touches && e.originalEvent.touches.length > 1) {
                handlePinch(e);
            }
        });
    });
    </script>
    
    <style>
        /* Reset y estilos base */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        /* Contenedor del mapa */
        #mapa {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            background: #f8f9fa;
        }
        
        /* Estilos para los marcadores personalizados */
        .marcador-inicio {
            color: #4CAF50; /* Verde para el punto de inicio */
            font-size: 24px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        .marcador-destino {
            color: #F44336; /* Rojo para el destino */
            font-size: 24px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        /* Estilo para la flecha de navegaci√≥n */
        .flecha-navegacion {
            color: #1E88E5; /* Azul para la flecha */
            font-size: 24px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            transform-origin: center;
            transform: rotate(0deg);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        /* Estilos para los marcadores personalizados */
        .custom-marker {
            position: relative;
            width: 30px;
            height: 42px;
            text-align: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            line-height: 42px;
        }
        
        .marker-pin {
            position: absolute;
            width: 30px;
            height: 42px;
            background: #007bff;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            left: 0;
            top: 0;
            margin: -21px 0 0 -15px;
        }
        
        /* Estilos para el marcador verde */
        .green-pin .marker-pin {
            background: #28a745;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .green-pin::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            margin: 3px 0 0 3px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
            opacity: 0.3;
        }
        
        .marker-pin.start {
            background: #2ecc71;
        }
        
        .marker-pin.end {
            background: #3498db;
        }
        
        .custom-marker span {
            position: relative;
            top: -10px;
            left: 0;
            width: 100%;
            text-align: center;
            display: inline-block;
            transform: rotate(45deg);
        }
        
        
        /* Estilos para los iframes hijos */
        iframe {
            border: none;
            background: transparent;
        }
        
        /* Estilos simplificados */
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            font-family: Arial, sans-serif; 
            overflow: hidden; 
            background: #f0f0f0; 
        }
        
        #mapa { 
            height: 100vh; 
            width: 100vw; 
            z-index: 1; 
        }
        
        /* Estilo para iframes */
        iframe { 
            background: transparent;
            border: none;
        }
        
        /* ================== VARIABLES Y ESTILO HIJO 4 (RETOS) ================== */
        :root {
            --iframe-hijo4-width: 90%;
            --iframe-hijo4-max-width: 600px;
            --iframe-hijo4-height: 70vh;
            --iframe-hijo4-top: 15vh;
            --iframe-hijo4-left: 50%;
            --iframe-hijo4-translate-x: -50%;
            --iframe-hijo4-z: 2000;
            --iframe-hijo4-bg: rgba(255, 255, 255, 0.95);
            --iframe-hijo4-border-radius: 15px;
            --iframe-hijo4-box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
        }
        #hijo4 {
            position: fixed;
            top: var(--iframe-hijo4-top);
            left: var(--iframe-hijo4-left);
            width: var(--iframe-hijo4-width);
            max-width: var(--iframe-hijo4-max-width);
            height: var(--iframe-hijo4-height);
            transform: translateX(var(--iframe-hijo4-translate-x));
            z-index: var(--iframe-hijo4-z);
            background: var(--iframe-hijo4-bg);
            border-radius: var(--iframe-hijo4-border-radius);
            box-shadow: var(--iframe-hijo4-box-shadow);
            border: none;
            pointer-events: auto;
            display: none;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* Estilos para el iframe hijo5-casa (bot√≥n casa) */
        #hijo5-casa {
            position: fixed;
            top: 80px; /* 80px desde el borde superior */
            right: 0; /* Sin margen derecho */
            width: 30px; /* Ancho m√≠nimo para el bot√≥n */
            height: 25px; /* Altura justa para el bot√≥n */
            border: 1px solid red; /* Marco rojo de 1px */
            z-index: 10000;
            overflow: visible; /* Permite que el contenido se muestre fuera del iframe */
            background: rgba(255, 255, 255, 0.8); /* Fondo blanco semitransparente */
            pointer-events: none; /* Deshabilitar eventos en el iframe */
            margin: 0; /* Sin m√°rgenes */
            padding: 0; /* Sin padding */
            border-radius: 4px; /* Bordes redondeados */
        }
        
        /* Permitir interacci√≥n con los elementos dentro del iframe */
        #hijo5-casa * {
            pointer-events: auto;
        }
        
        /* ESTILO ACTUALIZADO PARA info-parada */
        #info-parada {
            font-weight: bold;
            margin: 0;
            padding: 12px 20px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1201;
            display: none;
            color: #2c3e50;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            bottom: 340px;
            min-width: 250px;
            max-width: 90vw;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }
        
        /* Estilos para los marcadores de navegaci√≥n */
        .marcador-inicio {
            color: #4CAF50; /* Verde para el punto de inicio */
            font-size: 24px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        .marcador-destino {
            color: #F44336; /* Rojo para el destino */
            font-size: 24px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        /* Estilo para la flecha de navegaci√≥n */
        .flecha-navegacion {
            color: #1E88E5; /* Azul para la flecha */
            font-size: 24px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            transform-origin: center;
            transform: rotate(0deg);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        /* Estilos para los marcadores personalizados */
        .custom-marker {
            position: relative;
            width: 30px;
            height: 42px;
            text-align: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            line-height: 42px;
        }
        
        .marker-pin {
            position: absolute;
            width: 30px;
            height: 42px;
            background: #007bff;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            left: 0;
            top: 0;
            margin: -21px 0 0 -15px;
        }
        
        /* Estilos para el marcador verde */
        .green-pin .marker-pin {
            background: #28a745;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .green-pin::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            margin: 3px 0 0 3px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
            opacity: 0.3;
        }
        
        .marker-pin.start {
            background: #2ecc71;
        }
        
        .marker-pin.end {
            background: #3498db;
        }
        
        .custom-marker span {
            position: relative;
            top: -10px;
            left: 0;
            width: 100%;
            text-align: center;
            display: inline-block;
            transform: rotate(45deg);
        }
        #info-parada.error {
            background-color: #ffeaea;
            color: #b30000;
            border: 1.5px solid #b30000;
            animation: shake 0.3s;
        }
        @keyframes shake {
            0% { transform: translateX(-50%) translateY(0); }
            25% { transform: translateX(-50%) translateY(-3px); }
            50% { transform: translateX(-50%) translateY(3px); }
            75% { transform: translateX(-50%) translateY(-3px); }
            100% { transform: translateX(-50%) translateY(0); }
        }

        /* ================== ESTILO PARA VIDEO E IMAGEN ================== */
        #media-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 4000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        #media-container {
            width: 70vw; /* 70% del ancho de la ventana */
            height: 70vh; /* 70% de la altura de la ventana */
            max-width: 70vw;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            padding: 15px;
        }

        #close-media {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 1.2em;
            cursor: pointer;
            z-index: 4001;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #parada-video, #parada-imagen {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            display: none;
            border-radius: 8px;
            object-fit: contain; /* Mantiene proporci√≥n sin cortar */
        }
    </style>
</head>
<body>
    <!-- Contenedor del mapa -->
    <div id="mapa"></div>

    <img id="logo-aventura" src="https://valenciavguides.github.io/Aventura-1-esp-padre-con-hijos/fotos_Av1/LOGO%20LETRAS%20FINAL%20transparente%20recorte.png" alt="Logo" style="position: fixed; top: -32px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 360px; height: 140px;" />

    <div id="info-parada"></div>
    
    <!-- Fondo blanco para el logo con borde naranja -->
    <div style="position: fixed; top: 0; left: 0; right: 0; width: 99%; margin: 0 auto; height: 80px; background: white; z-index: 2999; border: 2px solid #ec7c26; border-top: none; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;"></div>

    <!-- Rutas actualizadas para GitHub Pages -->
    <iframe id="hijo1-hamburguesa" src="./botones-y-subfunciones-hamburguesa.html" style="position:fixed; left:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; border: transparent; background:transparent; pointer-events:auto;"></iframe>
    <iframe id="hijo1-opciones" src="./botones-y-subfunciones-opciones.html" style="position:fixed; right:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; border: transparent; background:transparent; pointer-events:auto;"></iframe>
    <iframe id="hijo5-casa" src="./Av1-boton-casa.html" style="position:fixed; right:0; top:70px; width:99%; height:85px; z-index:10000; border: 1px solid red; background:transparent; pointer-events:auto; margin:0; padding:0; overflow:hidden; border-radius:0;"></iframe>

    <iframe id="hijo3" src="./Av1_audio_esp.html"
            style="position:fixed;
                   bottom:-6px;
                   left:50%;
                   transform:translateX(-50%);
                   height:165px;
                   width:310px;
                   z-index:1000;
                   border: transparent;
                   display:block;
                   pointer-events:auto;"></iframe>

    <iframe id="hijo2" src="./Av1-botones-coordenadas.html"
            style="position:fixed;
                   bottom:150px;
                   left:50%;
                   transform:translateX(-50%);
                   height:165px;
                   width:310px;
                   z-index:1001;
                   border: none !important;
                   background-color: transparent !important;
                   overflow: hidden;
                   pointer-events:auto;"
            allow="geolocation"
            frameborder="0"></iframe>

    <iframe id="hijo4" src="./Av1-esp-retos-preguntas.html" style="display:none;"></iframe>

    <div id="media-overlay">
        <div id="media-container">
            <button id="close-media">X</button>
            <video id="parada-video" controls></video>
            <img id="parada-imagen">
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ================== ESTADO GLOBAL CENTRALIZADO ==================
        (function() {
        'use strict';
        
        const estadoGlobal = {
            modo: 'aventura', // 'aventura' o 'casa'
            puntoActual: null, // { tipo: 'parada'|'tramo', id: number, datos: {...} }
            ultimaActualizacion: Date.now(),
            // Datos compartidos entre iframes
            datosCompartidos: {
                // Datos de navegaci√≥n
                navegacionActiva: false,
                // Estado de reproducci√≥n de audio
                audio: {
                    reproduciendo: false,
                    paradaId: null,
                    src: null
                },
                // Estado de retos
                reto: {
                    activo: false,
                    completado: false,
                    paradaId: null
                },
                // Estado de la br√∫jula
                brujulaActiva: false
            }
        };

        // ================== FUNCIONES DE SINCRONIZACI√ìN ==================
        
        // Asegurarse de que el estado global exista
        if (!window.estadoGlobal) {
            window.estadoGlobal = {
                modo: 'aventura',
                puntoActual: null,
                datosCompartidos: {},
                ultimaActualizacion: Date.now()
            };
        }
        
        // La funci√≥n actualizarEstadoGlobal ha sido movida a una implementaci√≥n m√°s abajo
        
        /**
         * Sincroniza el estado global con todos los iframes hijos
         * @returns {Promise<Object>} Promesa que se resuelve con el resultado de la sincronizaci√≥n
         */
        async function sincronizarEstadoConHijos() {
            if (!window.estadoGlobal) {
                console.warn('‚ö†Ô∏è No se puede sincronizar: estadoGlobal no est√° definido');
                return { total: 0, exitosos: 0, errores: 0, iframesConError: [] };
            }

            const timestamp = Date.now();
            const estado = { ...window.estadoGlobal };

            console.log(`üîÑ PADRE [${new Date(timestamp).toISOString()}]: Enviando sincronizaci√≥n a todos los hijos`, {
                modo: estado.modo,
                puntoActual: estado.puntoActual?.id || 'ninguno',
                origen: 'padre'
            });

            // Enviar a todos los iframes hijos
            const iframes = ['hijo2', 'hijo3', 'hijo4', 'hijo5-casa'];
            let iframesActivos = 0;
            let iframesConError = [];

            // Usar Promise.allSettled para manejar todas las promesas de env√≠o de mensajes
            const resultados = await Promise.allSettled(
                iframes.map(async (id) => {
                    try {
                        await enviarMensaje(id, 'sincronizarEstado', estado);
                        console.log(`   ‚úÖ Enviado a ${id}`);
                        iframesActivos++;
                        return { id, success: true };
                    } catch (error) {
                        console.error(`   ‚ùå Error enviando a ${id}:`, error);
                        iframesConError.push(id);
                        return { id, success: false, error };
                    }
                })
            );

            // Registrar resumen de la sincronizaci√≥n
            console.group('üìä Resumen de sincronizaci√≥n');
            console.log(`üì§ Total iframes: ${iframes.length}`);
            console.log(`‚úÖ Iframes activos: ${iframesActivos}`);
            if (iframesConError.length > 0) {
                console.warn(`‚ùå Iframes con error: ${iframesConError.join(', ')}`);
            }
            console.groupEnd();

            return {
                total: iframes.length,
                exitosos: iframesActivos,
                errores: iframesConError.length,
                iframesConError: iframesConError
            };
        }

        /**
         * Actualiza el estado global y sincroniza con los hijos
         * @param {Object} actualizacion - Objeto con las propiedades a actualizar
         * @param {boolean} [sincronizar=true] - Indica si se debe sincronizar con los hijos
         * @returns {Promise<void>}
         */
        function actualizarEstadoGlobal(actualizacion, sincronizar = true) {
            // Verificar si el estado global est√° definido
            if (typeof estadoGlobal === 'undefined') {
                console.error('‚ùå Error: estadoGlobal no est√° definido');
                return Promise.reject(new Error('estadoGlobal no est√° definido'));
            }

            return new Promise((resolve) => {
                try {
                    // Actualizar el estado global
                    Object.assign(estadoGlobal, actualizacion, {
                        ultimaActualizacion: Date.now()
                    });

                    console.log('üîÑ PADRE: Estado global actualizado:', estadoGlobal);

                    // Si se debe sincronizar con los hijos
                    if (sincronizar) {
                        const resultado = sincronizarEstadoConHijos();
                        console.log('üì° PADRE: Estado sincronizado con los hijos:', resultado);
                    }

                    resolve();
                } catch (error) {
                    console.error('‚ùå Error en actualizarEstadoGlobal:', error);
                    resolve(); // Resolvemos igualmente para no romper la cadena de promesas
                }
            });
        }

        // ================== ESTRUCTURA SIMPLIFICADA ==================
        // Ruta base para los archivos de audio
        const AUDIO_BASE_PATH = './audios/';
        
        // Mapeo entre retos y sus puzzles asociados
        const RETO_PUZZLE_MAP = {
            'R-7': 'PZ-8',   // Reto 7 -> Puzzle 8
            'R-17': 'PZ-18', // Reto 17 -> Puzzle 18
            'R-25': 'PZ-26'  // Reto 25 -> Puzzle 26
        };
        
        // Mapeo inverso para encontrar el reto asociado a un puzzle
        const PUZZLE_RETO_MAP = {};
        Object.entries(RETO_PUZZLE_MAP).forEach(([retoId, puzzleId]) => {
            PUZZLE_RETO_MAP[puzzleId] = retoId;
        });
        
        const AVENTURA_PARADAS = [
  // Parada 0 ‚Äì INICIO (Torres de Serranos start) reto 2 (223, 226, 228, 229)//
  { tipo: "inicio", parada_id: 'P-0', audio_id: "audio_P-0", reto_id: "R-2" },
  // tramo 1 (Torres de Serranos ‚Üí Plaza de la crida) (2, 126,)//
  { tipo: "tramo", tramo_id: 'TR-1', audio_id: "audio_TR-1" },
  // Parada 1 - Plaza de la crida (Puente de Serranos) Reto 3 (233) //
  { tipo: "parada", parada_id: 'P-1', audio_id: "audio_P-1", reto_id: "R-3" },
  // tramo 2 (Plaza de la crida ‚Üí Calle Muro de Santa Ana) (81) //
  { tipo: "tramo", tramo_id: 'TR-2', audio_id: "audio_TR-2" },
  // Parada 2 (Calle Muro de Santa Ana) Reto 4 (68) //
  { tipo: "parada", parada_id: 'P-2', audio_id: "audio_P-2", reto_id: "R-4" },
  // tramo 3 (Calle Muro de Santa Ana ‚Üí Palacio de los Borgia) (52) //
  { tipo: "tramo", tramo_id: 'TR-3', audio_id: "audio_TR-3" },
  // Parada 3 (Iglesia de San Lorenzo) Reto 5 (686, 682-B, 462, 683, 684) //
  { tipo: "parada", parada_id: 'P-3', audio_id: "audio_P-3", reto_id: "R-5" },
  // tramo 4 (Iglesia de San Lorenzo ‚Üí Plaza de la Virgen) (465-B) //
  { tipo: "tramo", tramo_id: 'TR-4', audio_id: "audio_TR-4" },
  // Parada 4 (Plaza de la Virgen) Reto 6 (466, 467) //
  { tipo: "parada", parada_id: 'P-4', audio_id: "audio_P-4", reto_id: "R-6" },
  // Parada 5 (Plaza de la Virgen) Reto 7, 8 Puzzle plaza de la virgen (468)  //
  { 
      tipo: "parada", 
      parada_id: 'P-5', 
      audio_id: "audio_P-5", 
      retos: [
          { tipo: "reto", id: "R-7" },
          { tipo: "puzzle", id: "PZ-8" }
      ] 
  },
  // tramo 5 (Plaza de la Virgen ‚Üí Plaza de la Almo√≠na) (477-B, 479, 141, 83, 8-C) //
  { tipo: "tramo", tramo_id: 'TR-5', audio_id: "audio_TR-5" },
  // Parada 6 (Panel cer√°mico muro Catedral) Reto 9 (434, 440, 441, 442) //
  { tipo: "parada", parada_id: 'P-6', audio_id: "audio_P-6", reto_id: "R-9" },
  // Parada 7 (Capilla exterior catedral) Reto 10 (443, 444, 445) //
  { tipo: "parada", parada_id: 'P-7', audio_id: "audio_P-7", reto_id: "R-10" },
  // Parada 8 (Capilla exterior catedral) Reto 11 (445) //
  { tipo: "parada", parada_id: 'P-8', audio_id: "audio_P-8", reto_id: "R-11" },
  // Parada 9 (Arco Novo Catedral y Puerta Negra Bas√≠lica) (446, 355, 447, 11-B, 451, 452) //
  { tipo: "parada", parada_id: 'P-9', audio_id: "audio_P-9" },
  // Parada 10 (Casa del Punt de Gantxo) Reto 12 (51-C, 454, 455, 455-B, 456, 148) //
  { tipo: "parada", parada_id: 'P-10', audio_id: "audio_P-10", reto_id: "R-12"  },
  // tramo 6 (Plaza de la Almo√≠na (casa del punt de Gantxo) ‚Üí Plaza Decimo Junio Bruto) (457, 10-B)//
  { tipo: "tramo", tramo_id: 'TR-6', audio_id: "audio_TR-6" },
  // Parada 11 (Museo arqueol√≥gico La Almo√≠na) Reto 13 (458) //
  { tipo: "parada", parada_id: 'P-11', audio_id: "audio_P-11", reto_id: "R-13" },
  // Parada 12 (Museo arqueol√≥gico La Almo√≠na 2) (459, 460, 461) //
  { tipo: "parada", parada_id: 'P-12', audio_id: "audio_P-12" },
  // Parada 13 (Vista de la Catedral, Cimborrio) Reto 14 (8-C, 464) //
  { tipo: "parada", parada_id: 'P-13', audio_id: "audio_P-13", reto_id: "R-14" },
  // tramo 7 (Museo arqueol√≥gico La Almo√≠na ‚Üí Palacio Arzobispal) (85) //
  { tipo: "tramo", tramo_id: 'TR-7', audio_id: "audio_TR-7" },
  // Parada 14 (Palacio Arzobispal y Puerta Rom√°nica de la Catedral) Reto 15 (673, 86, 426-B, 141, 437, 438) //
  { tipo: "parada", parada_id: 'P-14', audio_id: "audio_P-14", reto_id: "R-15" },
  // Parada 15 (Puerta Rom√°nica de la Catedral) (439) //
  { tipo: "parada", parada_id: 'P-15', audio_id: "audio_P-15" },
  // tramo 8 (Puerta Rom√°nica de la Catedral ‚Üí Plaza del Ayuntamiento) (125) //
  { tipo: "tramo", tramo_id: 'TR-8', audio_id: "audio_TR-8" },
  // Parada 16 (Plaza del Ayuntamiento) (13-B, 263, 332, 14-C) //
  { tipo: "parada", parada_id: 'P-16', audio_id: "audio_P-16" },
  // tramo 9 (Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento) (334, 335) //
  { tipo: "tramo", tramo_id: 'TR-9', audio_id: "audio_TR-9" },
  // Parada 17 (Edificio del Ayuntamiento) Reto 16 (336, 337, 338) //
  { tipo: "parada", parada_id: 'P-17', audio_id: "audio_P-17", reto_id: "R-16" },
  // Parada 18 (Edificio del Ayuntamiento, leyenda del murci√©lago) (339, 340, 341, 54) //
  { tipo: "parada", parada_id: 'P-18', audio_id: "audio_P-18" },
  // tramo 10 (Edificio del Ayuntamiento ‚Üí Estaci√≥n del Norte) (87, 15-C) //
  { tipo: "tramo", tramo_id: 'TR-10', audio_id: "audio_TR-10" },
  // Parada 19 (Estaci√≥n del Norte) Reto 17, 18 Puzzle Estaci√≥n del Norte (326) //
  { 
      tipo: "parada", 
      parada_id: 'P-19', 
      audio_id: "audio_P-19", 
      retos: [
          { tipo: "reto", id: "R-17" },
          { tipo: "puzzle", id: "PZ-18" }
      ] 
  },
  // tramo 11 (Estaci√≥n del Norte ‚Üí Plaza de Toros) (20-C, 323-B, 88) //
  { tipo: "tramo", tramo_id: 'TR-11', audio_id: "audio_TR-11" },
  // Tramo 12 (Plaza de Toros ‚Üí Casa estilo √Årabe) (89, 3-D) //
  { tipo: "tramo", tramo_id: 'TR-12', audio_id: "audio_TR-12" },
  // Parada 20 (Casa estilo √Årabe) Reto 19 (99) //
  { tipo: "parada", parada_id: 'P-20', audio_id: "audio_P-20", reto_id: "R-19" },
  // Parada 21 (Casa estilo √Årabe, mitad Aventura) (100) //
  { tipo: "parada", parada_id: 'P-21', audio_id: "audio_P-21" },
  // tramo 13 (Casa estilo √Årabe ‚Üí Palacio de Comunicaciones) (21-B) //
  { tipo: "tramo", tramo_id: 'TR-13', audio_id: "audio_TR-13" },
  // Parada 22 (Palacio de Comunicaciones) Reto 20 y Reto 21 (700, 343, 344) //
  { tipo: "parada", parada_id: 'P-22', audio_id: "audio_P-22", retos: ["R-20", "R-21"] },
  // Parada 23 (Edificio Suay) Reto 21 (693, 693-B) //
  { tipo: "parada", parada_id: 'P-23', audio_id: "audio_P-23" ,reto_id: "R-21" },
  // tramo 14 (Palacio de Comunicaciones, edificio Suay ‚Üí Banco de Val√®ncia) (345, 347, 348, 22, 109) //
  { tipo: "tramo", tramo_id: 'TR-14', audio_id: "audio_TR-14" },
  // Parada 24 (Banco de Valencia) Reto 22 (349, 350) //
  { tipo: "parada", parada_id: 'P-24', audio_id: "audio_P-24", reto_id: "R-22" },
  // tramo 15 (Banco de Val√®ncia ‚Üí Palacio del Marqu√©s de Dos Aguas) (351, 23-B, 352, 354) //
  { tipo: "tramo", tramo_id: 'TR-15', audio_id: "audio_TR-15" },
  // Parada 25 (Palacio del Marqu√©s de Dos Aguas) (356, 357)//
  { tipo: "parada", parada_id: 'P-25', audio_id: "audio_P-25" },
  // tramo 16 (Palacio del Marqu√©s ‚Üí Mercado Central) (358, 359-B, 101) //
  { tipo: "tramo", tramo_id: 'TR-16', audio_id: "audio_TR-16" },
  // Parada 26 (Mercado central) Reto23 (701, 24-D, 361, 362, 363, 364) //
  { tipo: "parada", parada_id: 'P-26', audio_id: "audio_P-26", reto_id: "R-23" },
  // tramo 17 (Mercado Central ‚Üí Iglesia de los Santos Juanes) (274, 27-C) //
  { tipo: "tramo", tramo_id: 'TR-17', audio_id: "audio_TR-17" },
  // Parada 27 (Iglesia de los Santos Juanes) Reto 24) (365, 366) //
  { tipo: "parada", parada_id: 'P-27', audio_id: "audio_P-27", reto_id: "R-24" },
  // Parada 28 (Iglesia de los Santos Juanes reto 25) (367) //
  { tipo: "parada", parada_id: 'P-28', audio_id: "audio_P-28", reto_id: "R-25" },
  // tramo 18 (Iglesia Santos Juanes ‚Üí Lonja de Val√®ncia) (368, 369, 28, 370, 371, 372, 373, 374, 375, 376, 377) //
  { tipo: "tramo", tramo_id: 'TR-18', audio_id: "audio_TR-18" },
  // Parada 29 (Lonja Puerta de Los Pecados barquero) Reto 27 (378, 379) //
  { tipo: "parada", parada_id: 'P-29', audio_id: "audio_P-29", reto_id: "R-27" },
  // Parada 30 (Lonja Puerta de Los Pecados √°rbol muerto) Reto 28 (380, 381) //
  { tipo: "parada", parada_id: 'P-30', audio_id: "audio_P-30", reto_id: "R-28" },
  // tramo 19 (Lonja G√°rgolas) (383) //
  { tipo: "tramo", tramo_id: 'TR-19', audio_id: "audio_TR-19" },
  // Parada 31 (Lonja G√°rgolas √°ngel vasija) Reto 29 (384) //
  { tipo: "parada", parada_id: 'P-31', audio_id: "audio_P-31", reto_id: "R-29" },
  // Parada 32 (Lonja G√°rgolas barbudo y le√≥n) Reto 30 (385) //
  { tipo: "parada", parada_id: 'P-32', audio_id: "audio_P-32", reto_id: "R-30" },
  // Parada 33 (Lonja G√°rgolas fornicador ventana) Reto 31, Puzzle 26 ) (386) //
  { tipo: "parada", parada_id: 'P-33', audio_id: "audio_P-33", retos: [ { tipo: "reto", id: "R-31" }, { tipo: "puzzle", id: "PZ-26" } ] },
  // tramo 20 (Lonja ‚Üí Plaza del Doctor Collado) (388, 389, 390, 391, 392) //
  { tipo: "tramo", tramo_id: 'TR-20', audio_id: "audio_TR-20" },
  // tramo 21 (Plaza del Doctor Collado ‚Üí Plaza del Negrito) (333, 397, 41, 398, 198, 671, 522, 32-C) //
  { tipo: "tramo", tramo_id: 'TR-21', audio_id: "audio_TR-21" },
  // Parada 34 (Fuente del Negrito) Reto 32 (382, 501) //
  { tipo: "parada", parada_id: 'P-34', audio_id: "audio_P-34", reto_id: "R-32" },
  // tramo 22 (Plaza del Negrito ‚Üí Calle Caballeros) (33-B, 486, 480-B) //
  { tipo: "tramo", tramo_id: 'TR-22', audio_id: "audio_TR-22" },
  // Parada 35 (Palau de la Generalitat) (481-B, 482-B, 2-D) //
  { tipo: "parada", parada_id: 'P-35', audio_id: "audio_P-35" },
  // tramo 23 (Palacio de la Generalitat ‚Üí Calle de los Serranos - FINAL)  //
  { tipo: "tramo", tramo_id: 'TR-23', audio_id: "audio_TR-23" },
  // Parada 36 (Torres de Serranos Final) //
  { tipo: "parada", parada_id: 'P-36', audio_id: "audio_P-36" }
];

        
        // Funci√≥n para habilitar controles
        function enableControls() {
            console.log('Habilitando controles...');
            const controls = document.querySelectorAll('button, input, select, textarea');
            controls.forEach(control => {
                control.disabled = false;
            });
            return 'Controles habilitados';
        }
        
        // Funci√≥n para deshabilitar controles
        function disableControls() {
            console.log('Deshabilitando controles...');
            const controls = document.querySelectorAll('button, input, select, textarea');
            controls.forEach(control => {
                control.disabled = true;
            });
            return 'Controles deshabilitados';
        }
        
        // Variables globales
        window.paradaActual = 0; // √çndice de la parada actual
        
        // Funci√≥n para habilitar controles
        function enableControls() {
            console.log('Controles habilitados');
            // Implementaci√≥n b√°sica - puedes personalizar seg√∫n necesites
            const controles = document.querySelectorAll('button, input, select, textarea');
            controles.forEach(control => {
                control.disabled = false;
            });
        }
        
        // Funci√≥n para deshabilitar controles
        function disableControls() {
            console.log('Controles deshabilitados');
            // Implementaci√≥n b√°sica - puedes personalizar seg√∫n necesites
            const controles = document.querySelectorAll('button, input, select, textarea');
            controles.forEach(control => {
                control.disabled = true;
            });
        }
        
        // Hacer las funciones accesibles globalmente
        window.enableControls = enableControls;
        window.disableControls = disableControls;
        
        // Funci√≥n para mostrar mensajes en la ventana de informaci√≥n
        function mostrarMensajeInfoParada(mensaje, esError = false) {
            const info = document.getElementById('info-parada');
            if (info) {
                info.textContent = mensaje;
                info.style.display = 'block';
                if (esError) {
                    info.classList.add('error');
                } else {
                    info.classList.remove('error');
                }
            }
        }
        
        // Funci√≥n para ocultar la informaci√≥n de la parada
        function ocultarInfoParada() {
            const info = document.getElementById('info-parada');
            if (info) {
                info.style.display = 'none';
            }
        }
        
        // Hacer las funciones accesibles globalmente
        window.mostrarMensajeInfoParada = mostrarMensajeInfoParada;
        window.ocultarInfoParada = ocultarInfoParada;

        // Inicializaci√≥n del mapa
        let mapa;
        let polilinea;
        let grupoRuta;
        let grupoMarcadores;
        let mapInitialized = false; // Variable para controlar si el mapa est√° inicializado
        
        function inicializarMapa() {
            try {
                console.log('üîç Iniciando inicializaci√≥n del mapa...');
                
                // Verificar si Leaflet est√° cargado
                if (typeof L === 'undefined') {
                    throw new Error('La biblioteca Leaflet no est√° cargada correctamente');
                }
                
                // Coordenadas de Valencia: 39.44859, -0.37489
                const valenciaCoords = [39.44859, -0.37489];
                
                // Crear el mapa
                const mapContainer = document.getElementById('mapa');
                if (!mapContainer) {
                    throw new Error('No se encontr√≥ el contenedor del mapa');
                }
                
                // Asegurarse de que el contenedor sea visible
                mapContainer.style.display = 'block';
                
                // Inicializar el mapa
                const mapa = L.map('mapa', {
                    center: valenciaCoords,
                    zoom: 13,               // Nivel de zoom predeterminado ajustado a 13
                    zoomControl: false,
                    scrollWheelZoom: true,  // Habilitar zoom con rueda del rat√≥n
                    doubleClickZoom: true,  // Habilitar zoom con doble clic
                    boxZoom: true,          // Habilitar zoom con arrastre de caja
                    rotate: false,
                    touchRotate: false,
                    bearing: 0,
                    preferCanvas: true
                });
                
                // A√±adir capa de OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OpenStreetMap contributors',
                    detectRetina: true
                }).addTo(mapa);
                
                // Manejar evento de carga
                mapa.whenReady(() => {
                    console.log('‚úÖ Mapa cargado correctamente');
                    mapInitialized = true;
                    window.mapa = mapa;
                    
                    // Forzar actualizaci√≥n del tama√±o
                    setTimeout(() => {
                        mapa.invalidateSize({ animate: true });
                        
                        // A√±adir un marcador de prueba
                        L.marker(valenciaCoords)
                            .addTo(mapa)
                            .bindPopup('¬°Mapa funcionando correctamente!')
                            .openPopup();
                    }, 100);
                });
                
                // Manejar errores
                mapa.on('error', (error) => {
                    console.error('‚ùå Error en el mapa:', error);
                    mostrarErrorEnInterfaz('Error en el mapa: ' + (error.message || 'Error desconocido'));
                });
                
                return mapa;
                
            } catch (error) {
                console.error('‚ùå Error al inicializar el mapa:', error);
                
                // Mostrar mensaje de error en la interfaz
                mostrarErrorEnInterfaz(
                    'Error al cargar el mapa: ' + (error.message || 'Error desconocido'),
                    () => {
                        // Funci√≥n de reintento
                        console.log('üîÑ Reintentando inicializaci√≥n del mapa...');
                        verificarEInicializarMapa();
                    }
                );
                
                // Intentar de nuevo despu√©s de un breve retraso (solo si no se ha inicializado)
                if (!mapInitialized) {
                    console.log('üîÑ Reintentando inicializaci√≥n del mapa en 2 segundos...');
                    setTimeout(verificarEInicializarMapa, 2000);
                }
                
                return null;
            }
        }
        
        // Funci√≥n auxiliar para mostrar errores en la interfaz
        function mostrarErrorEnInterfaz(mensaje, onRetry = null) {
            // Eliminar mensajes de error anteriores
            const erroresAnteriores = document.querySelectorAll('.mapa-error-mensaje');
            erroresAnteriores.forEach(el => el.remove());
            
            // Crear y mostrar el nuevo mensaje de error
            const errorMsg = document.createElement('div');
            errorMsg.className = 'mapa-error-mensaje';
            errorMsg.style.position = 'fixed';
            errorMsg.style.top = '50%';
            errorMsg.style.left = '50%';
            errorMsg.style.transform = 'translate(-50%, -50%)';
            errorMsg.style.backgroundColor = 'rgba(255, 0, 0, 0.9)';
            errorMsg.style.color = 'white';
            errorMsg.style.padding = '20px';
            errorMsg.style.borderRadius = '5px';
            errorMsg.style.zIndex = '1000';
            errorMsg.style.maxWidth = '80%';
            errorMsg.style.textAlign = 'center';
            errorMsg.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.3)';
            errorMsg.style.fontFamily = 'Arial, sans-serif';
            errorMsg.style.fontSize = '16px';
            
            let contenidoHTML = `
                <h3 style="margin-top: 0; color: white;">Error en el mapa</h3>
                <p style="margin-bottom: 20px;">${mensaje}</p>
            `;
            
            if (onRetry && typeof onRetry === 'function') {
                contenidoHTML += `
                    <button 
                        onclick="this.parentElement.remove(); ${onRetry.toString().replace(/\n/g, ' ')};" 
                        style="
                            margin-top: 10px; 
                            padding: 8px 16px; 
                            cursor: pointer; 
                            background-color: white; 
                            color: #d32f2f; 
                            border: none; 
                            border-radius: 4px; 
                            font-weight: bold;
                        "
                    >
                        Reintentar
                    </button>
                `;
            }
            
            errorMsg.innerHTML = contenidoHTML;
            document.body.appendChild(errorMsg);
            
            // Eliminar el mensaje despu√©s de 10 segundos si no hay bot√≥n de reintento
            if (!onRetry) {
                setTimeout(() => {
                    if (document.body.contains(errorMsg)) {
                        errorMsg.style.transition = 'opacity 0.5s';
                        errorMsg.style.opacity = '0';
                        setTimeout(() => errorMsg.remove(), 500);
                    }
                }, 10000);
            }
        }
        
        // Funci√≥n para verificar e inicializar el mapa
        function verificarEInicializarMapa() {
            console.log('üîç Verificando estado del mapa...');
            
            // Verificar si el contenedor del mapa existe y es visible
            const mapaContainer = document.getElementById('mapa');
            if (!mapaContainer) {
                console.error('‚ùå No se encontr√≥ el contenedor del mapa');
                return null;
            }
            
            // Asegurar que el contenedor tenga estilos adecuados
            Object.assign(mapaContainer.style, {
                position: 'absolute',
                top: '0',
                left: '0',
                right: '0',
                bottom: '0',
                width: '100%',
                height: '100%',
                margin: '0',
                padding: '0',
                backgroundColor: '#f8f9fa',
                zIndex: '1',
                display: 'block' // Asegurar que sea visible
            });
            
            // Si el mapa ya est√° inicializado, devolver la instancia existente
            if (mapInitialized && window.mapaLeaflet) {
                console.log('‚úÖ Mapa ya est√° inicializado');
                return window.mapaLeaflet;
            }
            
            try {
                console.log('üîÑ Inicializando mapa...');
                const mapa = inicializarMapa();
                
                if (mapa) {
                    console.log('‚úÖ Mapa inicializado correctamente');
                    window.mapaLeaflet = mapa;
                    mapInitialized = true;
                    
                    // Forzar actualizaci√≥n del tama√±o del mapa
                    setTimeout(() => {
                        if (mapa && typeof mapa.invalidateSize === 'function') {
                            console.log('üîÑ Actualizando tama√±o del mapa...');
                            mapa.invalidateSize();
                        }
                    }, 500);
                    
                    return mapa;
                } else {
                    console.warn('‚ö†Ô∏è La funci√≥n inicializarMapa no devolvi√≥ una instancia del mapa');
                    // Reintentar despu√©s de un breve retraso
                    setTimeout(verificarEInicializarMapa, 1000);
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Error al inicializar el mapa:', error);
                // Reintentar despu√©s de un breve retraso
                setTimeout(verificarEInicializarMapa, 1000);
                return null;
            }
        }
        
        // Funci√≥n para forzar la inicializaci√≥n del mapa
        function inicializarMapaForzado() {
            console.log('üîÑ Forzando inicializaci√≥n del mapa...');
            const mapaContainer = document.getElementById('mapa');
            if (mapaContainer) {
                // Forzar estilos en el contenedor
                Object.assign(mapaContainer.style, {
                    display: 'block',
                    position: 'absolute',
                    top: '0',
                    left: '0',
                    right: '0',
                    bottom: '0',
                    width: '100%',
                    height: '100%',
                    margin: '0',
                    padding: '0',
                    backgroundColor: '#f8f9fa',
                    zIndex: '1'
                });
                
                // Llamar a la inicializaci√≥n del mapa
                verificarEInicializarMapa();
                
                // Forzar actualizaci√≥n del tama√±o
                if (window.mapa) {
                    setTimeout(() => {
                        window.mapa.invalidateSize(true);
                        console.log('üîÑ Tama√±o del mapa forzado');
                    }, 100);
                }
            }
        }
        
        // Inicializar el mapa cuando el DOM est√© listo
        console.log('üìÑ Configurando inicializaci√≥n del mapa...');
        if (document.readyState === 'loading') {
            console.log('üìÑ El documento a√∫n se est√° cargando, esperando a que est√© listo...');
            document.addEventListener('DOMContentLoaded', () => {
                console.log('üìÑ DOM completamente cargado, inicializando mapa...');
                inicializarMapaForzado();
            });
        } else {
            console.log('üìÑ El documento ya est√° listo, inicializando mapa...');
            setTimeout(inicializarMapaForzado, 100);
        }
        
        // Forzar actualizaci√≥n adicional despu√©s de la carga completa
        window.addEventListener('load', () => {
            console.log('üîÑ P√°gina completamente cargada, verificando mapa...');
            setTimeout(inicializarMapaForzado, 500);
        });
        
        // Tambi√©n intentar inicializar despu√©s de un breve retraso como respaldo
        setTimeout(verificarEInicializarMapa, 1000);

        // Funci√≥n para cerrar la superposici√≥n de medios
        function closeMediaOverlay() {
            console.log('üîµ Cerrando superposici√≥n de medios...');
            const mediaOverlay = document.getElementById('media-overlay');
            if (mediaOverlay) {
                mediaOverlay.style.display = 'none';
                
                // Pausar cualquier video o audio que est√© reproduci√©ndose
                const mediaElement = mediaOverlay.querySelector('video, audio');
                if (mediaElement) {
                    mediaElement.pause();
                    mediaElement.currentTime = 0;
                }
            }
            
            // Notificar a los iframes hijos que se cerr√≥ el overlay
            ['hijo2', 'hijo3', 'hijo4', 'hijo5-casa'].forEach(id => {
                try {
                    enviarMensaje(id, 'mediaOverlayClosed', {});
                } catch (error) {
                    console.error(`Error notificando a ${id}:`, error);
                }
            });
        }
        
        // Hacer la funci√≥n accesible globalmente
        window.closeMediaOverlay = closeMediaOverlay;

        /**
         * Muestra una imagen en un overlay
         * @param {string} paradaId - ID de la parada para cargar la imagen correspondiente
         */
        function mostrarImagenOverlay(paradaId) {
            const overlay = document.getElementById('media-overlay');
            const img = document.getElementById('parada-imagen');
            const video = document.getElementById('parada-video');
            if (!overlay || !img) return;

            // Oculta el video si estuviera visible
            if (video) {
                video.style.display = 'none';
                video.pause && video.pause();
            }

            // Construye la ruta de la imagen (ajusta seg√∫n tu estructura)
            let rutaImagen = '';
            if (paradaId && typeof paradaId === 'string') {
                rutaImagen = `./fotos_Av1/${paradaId}.jpg`;
            } else {
                rutaImagen = './fotos_Av1/default.jpg';
            }

            img.src = rutaImagen;
            img.style.display = 'block';

            // Muestra el overlay
            overlay.style.display = 'flex';

            // Cierra el overlay al pulsar la X
            const closeBtn = document.getElementById('close-media');
            if (closeBtn) {
                closeBtn.onclick = function(e) {
                    e.stopPropagation();
                    overlay.style.display = 'none';
                    img.src = '';
                };
            }
        }
        
        // Hacer la funci√≥n accesible globalmente
        window.mostrarImagenOverlay = mostrarImagenOverlay;

        // Inicializaci√≥n de la aplicaci√≥n
        function inicializarAplicacion() {
            console.log('üöÄ Inicializando aplicaci√≥n...');
            
            // Ocultar mensajes de informaci√≥n si existen
            if (typeof ocultarInfoParada === 'function') {
                ocultarInfoParada();
            }
            
            // Inicializar el overlay de medios si no existe
            if (!document.getElementById('media-overlay')) {
                console.log('‚ûï Creando overlay de medios...');
                const overlay = document.createElement('div');
                overlay.id = 'media-overlay';
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
                overlay.style.zIndex = '9999';
                overlay.style.display = 'flex';
                overlay.style.justifyContent = 'center';
                overlay.style.alignItems = 'center';
                overlay.style.display = 'none';
                if (typeof closeMediaOverlay === 'function') {
                    overlay.onclick = closeMediaOverlay;
                }
                document.body.appendChild(overlay);
            }
            
            // Cerrar cualquier overlay abierto
            if (typeof closeMediaOverlay === 'function') {
                closeMediaOverlay();
            }
            
            // Inicializar el mapa
            console.log('üó∫Ô∏è Inicializando mapa...');
            const mapa = verificarEInicializarMapa();
            
            if (mapa) {
                console.log('‚úÖ Mapa inicializado correctamente');
                // Asegurarse de que el mapa se redimensione correctamente
                setTimeout(() => {
                    if (mapa.invalidateSize) {
                        mapa.invalidateSize({ animate: true });
                    }
                }, 500);
            } else {
                console.warn('‚ö†Ô∏è No se pudo inicializar el mapa, reintentando...');
                setTimeout(verificarEInicializarMapa, 1000);
            }
            
            // Establecer parada actual
            window.paradaActual = 0;
            
            // Mostrar mensaje de bienvenida
            const mapaContainer = document.getElementById('mapa');
            if (mapaContainer) {
                const mensajeBienvenida = document.createElement('div');
                mensajeBienvenida.id = 'mensaje-bienvenida';
                mensajeBienvenida.style.position = 'absolute';
                mensajeBienvenida.style.top = '20px';
                mensajeBienvenida.style.left = '50%';
                mensajeBienvenida.style.transform = 'translateX(-50%)';
                mensajeBienvenida.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
                mensajeBienvenida.style.padding = '10px 20px';
                mensajeBienvenida.style.borderRadius = '5px';
                mensajeBienvenida.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
                mensajeBienvenida.style.zIndex = '1000';
                mensajeBienvenida.style.textAlign = 'center';
                mensajeBienvenida.style.fontSize = '16px';
                mensajeBienvenida.style.fontWeight = 'bold';
                mensajeBienvenida.textContent = '¬°Bienvenido al Mapa de Valencia!';
                
                // A√±adir mensaje al contenedor del mapa
                mapaContainer.appendChild(mensajeBienvenida);
                
                // Ocultar mensaje despu√©s de 5 segundos
                setTimeout(() => {
                    mensajeBienvenida.style.transition = 'opacity 1s';
                    mensajeBienvenida.style.opacity = '0';
                    setTimeout(() => {
                        if (mensajeBienvenida.parentNode) {
                            mensajeBienvenida.parentNode.removeChild(mensajeBienvenida);
                        }
                    }, 1000);
                }, 5000);
            }
        }
        
        // Iniciar la aplicaci√≥n cuando el DOM est√© completamente cargado
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarAplicacion);
        } else {
            inicializarAplicacion();
        }
        
        // Variables para los elementos de navegaci√≥n en el mapa
        let rutaPolyline = null;
        let marcadorInicio = null;
        let marcadorDestino = null;
        let direccionFlecha = null;

        // Funci√≥n para limpiar la navegaci√≥n actual del mapa
        function limpiarNavegacion() {
            if (rutaPolyline) {
                mapa.removeLayer(rutaPolyline);
                rutaPolyline = null;
            }
            
            if (marcadorInicio) {
                mapa.removeLayer(marcadorInicio);
                marcadorInicio = null;
            }
            
            if (marcadorDestino) {
                mapa.removeLayer(marcadorDestino);
                marcadorDestino = null;
            }
            
            if (direccionFlecha) {
                mapa.removeLayer(direccionFlecha);
                direccionFlecha = null;
            }
        }

        // Funci√≥n para dibujar una flecha en la ruta
        function dibujarFlecha(latlng, angulo) {
            // Usar un √≠cono de marcador con rotaci√≥n para simular una flecha
            const iconoFlecha = L.divIcon({
                className: 'flecha-navegacion',
                html: '‚û§',
                iconSize: [24, 24],
                iconAnchor: [12, 12],
                popupAnchor: [0, -12]
            });
            
            // Crear el marcador con rotaci√≥n
            const flecha = L.marker(latlng, {
                icon: iconoFlecha,
                rotationAngle: angulo,
                rotationOrigin: 'center',
                zIndexOffset: 1000
            });
            
            return flecha;
        }

        // ================== MANEJADORES DE MENSAJES ==================

        /**
         * Maneja la inicializaci√≥n de un iframe hijo
         * @param {Object} mensaje - Mensaje de inicializaci√≥n
         * @returns {Promise<void>}
         */
        async function manejarInicializacionHijo(mensaje) {
            try {
                console.log(`[PADRE] Inicializaci√≥n recibida de iframe: ${mensaje.datos.iframeId}`, mensaje);
                
                // Verificar si el mensaje tiene la estructura esperada
                if (!mensaje.datos || !mensaje.datos.iframeId) {
                    console.warn('[PADRE] Mensaje de inicializaci√≥n con formato inv√°lido:', mensaje);
                    return;
                }
                
                const iframeId = mensaje.datos.iframeId;
                
                // Registrar el iframe como inicializado
                if (!window.iframesInicializados) {
                    window.iframesInicializados = new Set();
                }
                window.iframesInicializados.add(iframeId);
                
                // Notificar al iframe que su inicializaci√≥n fue recibida
                await Mensajeria.enviarMensajeConReintenos(
                    iframeId,
                    Mensajeria.TIPOS_MENSAJE.INICIALIZACION,
                    { 
                        estado: 'confirmado',
                        timestamp: new Date().toISOString(),
                        modo: window.modoActual || 'casa' // Enviar el modo actual
                    },
                    { maxRetries: 3, timeout: 2000 }
                );
                
                console.log(`[PADRE] Confirmaci√≥n de inicializaci√≥n enviada a ${iframeId}`);
                
            } catch (error) {
                console.error('[PADRE] Error al manejar inicializaci√≥n de iframe:', {
                    error: error.message,
                    stack: error.stack,
                    mensajeOriginal: mensaje
                });
            }
        }
        
        /**
         * Maneja la confirmaci√≥n de mensajes
         * @param {Object} mensaje - Mensaje de confirmaci√≥n
         */
        function manejarConfirmacion(mensaje) {
            // Este manejador se llama cuando recibimos una confirmaci√≥n de un mensaje
            // El sistema de mensajer√≠a ya maneja las confirmaciones internamente,
            // pero podemos registrar aqu√≠ cualquier l√≥gica adicional necesaria
            if (mensaje.datos && mensaje.datos.originalId) {
                console.debug(`[PADRE] Confirmaci√≥n recibida para mensaje ${mensaje.datos.originalId}`, mensaje);
            }
        }
        
        /**
         * Maneja la solicitud de ocultar la flecha de navegaci√≥n
         * @param {Object} mensaje - Mensaje con los datos de la solicitud
         */
        function manejarOcultarFlecha(mensaje) {
            try {
                console.log('[PADRE] Ocultando flecha de navegaci√≥n');
                // L√≥gica para ocultar la flecha de navegaci√≥n
                const flechaElement = document.getElementById('flecha-navegacion');
                if (flechaElement) {
                    flechaElement.style.display = 'none';
                }
                
                // Confirmar que se ha ocultado la flecha
                if (mensaje.origen) {
                    Mensajeria.enviarMensajeConReintenos(
                        mensaje.origen,
                        'flecha-ocultada',
                        { 
                            timestamp: new Date().toISOString(),
                            confirmacion: true 
                        }
                    );
                }
            } catch (error) {
                console.error('[PADRE] Error al ocultar la flecha de navegaci√≥n:', error);
            }
        }
        
        // ================== FUNCIONES DE COMUNICACI√ìN ==================

/**
 * Env√≠a un mensaje a un iframe hijo
 * @param {string} destino - ID del iframe destino ('hijo2', 'hijo3', 'hijo4', 'hijo5-casa')
 * @param {string} tipo - Tipo de mensaje
 * @param {Object} [datos={}] - Datos adicionales del mensaje
 */
// ================== INICIALIZACI√ìN DEL SISTEMA DE MENSAJER√çA ==================
        let mensajeria;
        
        // Inicializar el sistema de mensajer√≠a
        async function inicializarMensajeria() {
            try {
                console.log('üì° Inicializando sistema de mensajer√≠a...');
                
                // Importar el m√≥dulo de mensajer√≠a
                const module = await import('./js/mensajeria.js');
                
                // Asignar a la variable local y global
                mensajeria = module.default || module;
                window.Mensajeria = mensajeria;
                
                if (!mensajeria || typeof mensajeria.inicializarMensajeria !== 'function') {
                    throw new Error('La API de mensajer√≠a no es v√°lida');
                }
                
                // Inicializar mensajer√≠a con valores por defecto seguros
                const configuracion = {
                    iframeId: 'padre',
                    debug: true
                };
                
                // Agregar logLevel solo si est√° disponible
                if (mensajeria.LOG_LEVELS) {
                    configuracion.logLevel = mensajeria.LOG_LEVELS.INFO;
                }
                
                await mensajeria.inicializarMensajeria(configuracion);
                
                console.log('‚úÖ Sistema de mensajer√≠a inicializado correctamente');
                
                // Configurar manejadores de mensajes
                if (typeof configurarMensajeria === 'function') {
                    configurarMensajeria();
                }
                
                // Iniciar migraci√≥n si es necesario
                if (typeof iniciarMigracionSistemaMensajeria === 'function') {
                    iniciarMigracionSistemaMensajeria();
                }
                
                return mensajeria;
            } catch (error) {
                const errorMsg = `‚ùå Error cr√≠tico al inicializar el sistema de mensajer√≠a: ${error.message}`;
                console.error(errorMsg, error);
                
                // Notificar al usuario de alguna manera
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;background:red;color:white;padding:10px;z-index:9999;text-align:center;';
                errorDiv.textContent = 'Error al cargar la aplicaci√≥n. Por favor, recarga la p√°gina.';
                document.body.prepend(errorDiv);
                
                throw error; // Propagar el error
            }
        }
        
        // Iniciar migraci√≥n al nuevo sistema de mensajer√≠a
        async function iniciarMigracionSistemaMensajeria() {
            console.log('üîÑ Iniciando migraci√≥n al sistema de mensajer√≠a unificado...');
            
            // Notificar a todos los iframes que deben usar mensajeria.js
            const promesas = ['hijo2', 'hijo3', 'hijo4', 'hijo5-casa'].map(async id => {
                try {
                    console.log(`üì§ Enviando solicitud de migraci√≥n a ${id}`);
                    await enviarMensaje(id, 'SISTEMA.MIGRACION', {
                        requiereActualizacion: true,
                        timestamp: Date.now()
                    });
                    return { id, success: true };
                } catch (error) {
                    console.error(`‚ùå Error notificando a ${id}:`, error);
                    return { id, success: false, error };
                }
            });
            
            // Esperar a que todas las notificaciones se completen
            Promise.allSettled(promesas).then(resultados => {
                const exitosos = resultados.filter(r => r.status === 'fulfilled' && r.value.success).length;
                const fallidos = resultados.length - exitosos;
                console.log(`‚úÖ Migraci√≥n completada: ${exitosos} exitosos, ${fallidos} fallidos`);
            });
        }
        
        // Configurar manejadores de mensajes con el sistema de mensajer√≠a
        function configurarMensajeria() {
            // Configurar manejador de mensajes principal
            window.addEventListener('message', function(event) {
                // Solo procesar mensajes de or√≠genes conocidos
                const origen = determinarOrigenMensaje(event.source);
                if (!origen) {
                    console.debug('Mensaje de origen desconocido, ignorando...');
                    return;
                }
                
                const mensaje = event.data;
                
                try {
                    // Verificar si es un mensaje del sistema de mensajer√≠a
                    if (mensajeria?.validarMensaje) {
                        const validacion = mensajeria.validarMensaje(mensaje);
                        
                        if (!validacion.valido) {
                            console.warn('Mensaje no v√°lido recibido:', validacion.error, mensaje);
                            return;
                        }
                        
                        // Registrar el mensaje recibido
                        mensajeria.logger.log(`üì• PADRE: Mensaje de ${origen} (${mensaje.tipo})`, mensaje);
                        
                        // Delegar al manejador correspondiente
                        switch(origen) {
                            case 'hijo2': 
                                manejarMensajeHijo2(mensaje.tipo, mensaje.datos); 
                                break;
                            case 'hijo3': 
                                manejarMensajeHijo3(mensaje.tipo, mensaje.datos); 
                                break;
                            case 'hijo4': 
                                manejarMensajeHijo4(mensaje.tipo, mensaje.datos); 
                                break;
                            case 'hijo5-casa':
                                manejarMensajeHijo5(mensaje.tipo, mensaje.datos);
                                break;
                            default:
                                console.warn('Origen de mensaje no reconocido:', origen);
                        }
                    }
                } catch (error) {
                    console.error(`‚ùå Error al procesar mensaje de ${origen}:`, error, mensaje);
                }
            }, { capture: true });
            
            console.log('‚úÖ Manejadores de mensajes configurados');
        }
        
        // Determinar el origen de un mensaje
        function determinarOrigenMensaje(source) {
            if (source === window.frames['hijo2']?.contentWindow) return 'hijo2';
            if (source === window.frames['hijo3']?.contentWindow) return 'hijo3';
            if (source === window.frames['hijo4']?.contentWindow) return 'hijo4';
            if (source === window.frames['hijo5-casa']?.contentWindow) return 'hijo5-casa';
            return null;
        }
        
        /**
         * Funci√≥n para enviar mensajes a trav√©s de mensajeria.js
         * @param {string} destino - ID del iframe destino ('hijo2', 'hijo3', 'hijo4', 'hijo5-casa')
         * @param {string} tipo - Tipo de mensaje
         * @param {Object} [datos={}] - Datos adicionales del mensaje
         * @returns {Promise<Object>} Respuesta del receptor (si aplica)
         */
        async function enviarMensaje(destino, tipo, datos = {}) {
            if (!mensajeria?.enviarMensaje) {
                throw new Error('Sistema de mensajer√≠a no inicializado');
            }
            return mensajeria.enviarMensaje(destino, tipo, datos);
        }
        
        /**
         * Env√≠a un mensaje a todos los iframes hijos
         * @param {string} tipo - Tipo de mensaje
         * @param {Object} [datos={}] - Datos adicionales del mensaje
         * @param {Array<string>} [excluir=[]] - IDs de iframes a excluir
         * @returns {Promise<Array>} Promesa que se resuelve cuando se han enviado todos los mensajes
         */
        async function enviarMensajeATodosLosHijos(tipo, datos = {}, excluir = []) {
            if (!window.Mensajeria) {
                console.warn('No se puede enviar mensaje: Mensajeria no est√° disponible');
                return [];
            }
            
            const idsHijos = ['hijo2', 'hijo3', 'hijo4', 'hijo5-casa'];
            const promesas = [];
            
            for (const id of idsHijos) {
                if (excluir.includes(id)) continue;
                
                try {
                    promesas.push(
                        window.Mensajeria.enviarMensajeConReintenos(
                            id,
                            tipo,
                            { ...datos, timestamp: Date.now() }
                        )
                    );
                } catch (error) {
                    console.error(`Error al enviar mensaje a ${id}:`, error);
                }
            }
            
            return Promise.allSettled(promesas);
        }
        
        // Hacer las funciones accesibles globalmente
        window.enableControls = enableControls;
        window.disableControls = disableControls;

        // Inicializar el sistema de mensajer√≠a y el mapa al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('üöÄ Inicializando aplicaci√≥n...');
                
                // Esperar a que Leaflet est√© disponible
                await new Promise(resolve => {
                    if (typeof L !== 'undefined') {
                        console.log('üåç Leaflet ya est√° cargado');
                        resolve();
                        return;
                    }
                    
                    console.log('‚è≥ Esperando a que se cargue Leaflet...');
                    const checkL = setInterval(() => {
                        if (typeof L !== 'undefined') {
                            console.log('‚úÖ Leaflet cargado correctamente');
                            clearInterval(checkL);
                            resolve();
                        }
                    }, 100);
                    
                    // Timeout por si algo falla
                    setTimeout(() => {
                        clearInterval(checkL);
                        console.warn('‚ö†Ô∏è Tiempo de espera agotado para cargar Leaflet');
                        resolve();
                    }, 5000);
                });
                
                // Inicializar el mapa
                console.log('üó∫Ô∏è Inicializando mapa...');
                await verificarEInicializarMapa();
                
                // Inicializar la mensajer√≠a
                console.log('üì® Inicializando mensajer√≠a...');
                if (window.Mensajeria && typeof window.Mensajeria.inicializarMensajeria === 'function') {
                    try {
                        await window.Mensajeria.inicializarMensajeria({
                            iframeId: 'padre',
                            logLevel: 1,
                            debug: true
                        });
                        console.log('‚úÖ Mensajer√≠a inicializada correctamente');
                    } catch (error) {
                        console.error('‚ùå Error al inicializar la mensajer√≠a:', error);
                    }
                } else {
                    console.warn('‚ö†Ô∏è Mensajer√≠a no disponible');
                }
                
                // Luego inicializamos la mensajer√≠a
                console.log('üì° Inicializando mensajer√≠a...');
                await inicializarMensajeria();
                
                // Finalmente inicializamos la aplicaci√≥n
                console.log('üöÄ Inicializando aplicaci√≥n hijo5...');
                if (typeof inicializarAplicacionHijo5 === 'function') {
                    await inicializarAplicacionHijo5();
                    console.log('‚úÖ Aplicaci√≥n hijo5 inicializada correctamente');
                } else {
                    console.warn('‚ö†Ô∏è La funci√≥n inicializarAplicacionHijo5 no est√° definida');
                }
                
                console.log('üèÅ Aplicaci√≥n completamente inicializada');
                
            } catch (error) {
                console.error('‚ùå Error al inicializar la aplicaci√≥n:', error);
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;background:red;color:white;padding:10px;z-index:9999;text-align:center;';
                errorDiv.textContent = 'Error al cargar la aplicaci√≥n. Por favor, recarga la p√°gina.';
                document.body.prepend(errorDiv);
            }
        });

        // ================== MANEJADORES DE MENSAJES CON MENSAJERIA ==================
        // 1. Inicializaci√≥n de un hijo
        Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.INICIALIZACION, function(mensaje) {
            console.log('[PADRE] Inicializaci√≥n recibida de', mensaje.origen, mensaje.datos);
            // Actualizar el estado de conexi√≥n de los hijos aqu√≠
        });

        // 2. Cambio de modo desde hijo5-casa
        Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.CAMBIO_MODO, function(mensaje) {
            console.log('[PADRE] Cambio de modo recibido:', mensaje.datos);
            // Actualiza estado global y reenv√≠a a los dem√°s hijos
            ['hijo2', 'hijo3', 'hijo4'].forEach(id => {
                Mensajeria.enviarMensajeConReintenos(
                    id,
                    Mensajeria.TIPOS_MENSAJE.CAMBIO_MODO,
                    mensaje.datos
                );
            });
        });

        // 3. Selecci√≥n de punto desde hijo5-casa
        Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.SELECCION_PUNTO, function(mensaje) {
            console.log('[PADRE] Selecci√≥n de punto recibida:', mensaje.datos);
            // Reenviar al hijo2 (navegaci√≥n)
            Mensajeria.enviarMensajeConReintenos(
                'hijo2', 
                Mensajeria.TIPOS_MENSAJE.SELECCION_PUNTO, 
                mensaje.datos
            );
        });

        // 4. Mensajes de navegaci√≥n desde hijo2
        Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.NAVEGACION, function(mensaje) {
            console.log('[PADRE] Mensaje de navegaci√≥n recibido:', mensaje.datos);
            // Procesa navegaci√≥n o reenv√≠a si es necesario
        });

        // 5. Mensajes de audio desde hijo3
        Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.AUDIO, function(mensaje) {
            console.log('[PADRE] Mensaje de audio recibido:', mensaje.datos);
            // Procesa audio o reenv√≠a si es necesario
        });

        // 6. Mensajes de retos desde hijo4
        Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.RETO, function(mensaje) {
            console.log('[PADRE] Mensaje de reto recibido:', mensaje.datos);
            // Procesa retos o reenv√≠a si es necesario
        });

        // 7. Confirmaciones
        Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.CONFIRMACION, function(mensaje) {
            console.log('[PADRE] Confirmaci√≥n recibida:', mensaje);
        });

// ================== MANEJADORES POR HIJO ==================

/**
 * Maneja los mensajes recibidos del iframe hijo2 (coordenadas)
 * @param {string} type - Tipo de mensaje recibido
 * @param {Object} data - Datos del mensaje
 * @param {Object} [event=null] - Evento original (opcional)
 * @returns {Promise<void>}
 */
async function manejarMensajeHijo2(type, data, event = null) {
    const timestamp = new Date().toISOString();
    const logPrefix = `[${timestamp}] üì° PADRE -> Hijo2 (${type}):`;
    
    try {
        // Validar datos de entrada
        if (!type || typeof type !== 'string') {
            console.error(`${logPrefix} Tipo de mensaje inv√°lido:`, type);
            return;
        }

        // Registrar recepci√≥n del mensaje
        console.groupCollapsed(`${logPrefix} Mensaje recibido`);
        console.log(`üìã Datos recibidos:`, data);
        if (event) console.log(`üìé Metadata del evento:`, event);
        console.groupEnd();

        // Procesar el mensaje seg√∫n su tipo
        switch (type) {
            case 'llegada-parada':
                await manejarLlegadaAParada(data);
                break;
                
            case 'inicio-navegacion':
                await manejarInicioNavegacion(data);
                break;
                
            case 'fin-navegacion':
                await manejarFinNavegacion(data);
                break;
                
            case 'cambioModo':
                await manejarCambioModoHijo2(data);
                break;
                
            case 'sincronizarEstado':
                await manejarSincronizacionEstadoHijo2(data);
                break;
                
            case 'error':
                await manejarErrorHijo2(data);
                break;
                
            case 'usuario-fuera-radio':
                // El usuario se ha alejado m√°s de 70m tras haber llegado
                console.log('üö® Usuario fuera del radio de 70m de la parada:', data.parada);
                await actualizarEstadoGlobal({
                    ultimaAccion: 'usuario_fuera_radio',
                    paradaActual: data.parada,
                    distancia: data.distancia,
                    timestamp: Date.now()
                });
                break;
                
            case 'estado-inicial':
                // Hijo2 notifica su estado inicial al arrancar (por ejemplo, tras leer localStorage)
                console.log('üîÑ Estado inicial recibido del hijo2:', data);
                await actualizarEstadoGlobal({
                    paradaActual: data.paradaActual,
                    ultimaAccion: 'estado_inicial',
                    timestamp: Date.now()
                });
                break;
                
            case 'parada-completada':
                // Hijo2 notifica que ha completado una parada/tramo
                console.log('‚úÖ Parada completada:', data.parada);
                await actualizarEstadoGlobal({
                    paradaActual: data.parada,
                    ultimaAccion: 'parada_completada',
                    timestamp: Date.now()
                });
                break;
                
            case 'ver-imagen':
                // Mostrar la imagen de la parada en el overlay
                console.log('üñºÔ∏è Mostrando imagen de la parada:', data.parada);
                mostrarImagenOverlay(data.parada);
                break;
                
            default:
                console.warn(`${logPrefix} Tipo de mensaje no reconocido:`, type);
                break;
        }
        
        // Confirmar recepci√≥n del mensaje
        if (event?.data?.id) {
            await enviarMensaje('hijo2', 'confirmacionRecepcion', {
                idMensajeOriginal: event.data.id,
                timestamp: Date.now(),
                estado: 'procesado'
            });
        }
    } catch (error) {
        console.error(`${logPrefix} Error al procesar mensaje:`, error);
        
        // Notificar al hijo2 sobre el error
        try {
            await enviarMensaje('hijo2', 'error', {
                codigo: 'ERROR_PROCESAMIENTO',
                mensaje: error.message || 'Error al procesar el mensaje',
                stack: process.env.NODE_ENV === 'development' ? error.stack : undefined,
                timestamp: Date.now()
            });
        } catch (e) {
            console.error(`${logPrefix} Error al notificar error al hijo2:`, e);
        }
    }
}

/**
 * Maneja el evento de llegada a una parada
 * @param {Object} data - Datos de la parada
 * @returns {Promise<void>}
 */
async function manejarLlegadaAParada(data) {
    const logPrefix = 'üìç PADRE: Llegada a parada:';
    
    // Validar datos de la parada
    if (!data?.parada) {
        console.warn(`${logPrefix} Datos de parada incompletos:`, data);
        return;
    }
    
    console.log(`${logPrefix} ${data.parada.nombre || data.parada.id || 'Desconocida'}`);
    console.debug('Detalles de la parada:', data.parada);
    
    // El hijo2 ya maneja la l√≥gica de navegaci√≥n
    // Aqu√≠ podemos realizar acciones adicionales si es necesario
    
    // Notificar a otros componentes si es necesario
    await actualizarEstadoGlobal({
        ultimaAccion: 'llegada_parada',
        paradaActual: data.parada.id,
        timestamp: Date.now()
    });
}

/**
 * Maneja el inicio de la navegaci√≥n
 * @param {Object} data - Datos de la navegaci√≥n
 * @returns {Promise<void>}
 */
async function manejarInicioNavegacion(data) {
    const logPrefix = 'üöÄ PADRE: Inicio de navegaci√≥n:';
    
    // Validar datos de navegaci√≥n
    if (!data?.parada) {
        console.warn(`${logPrefix} Datos de navegaci√≥n incompletos:`, data);
        return;
    }
    
    console.log(`${logPrefix} hacia ${data.parada.nombre || data.parada.id || 'destino desconocido'}`);
    
    try {
        // Pausar audio al iniciar navegaci√≥n
        await enviarMensaje('hijo3', 'pausarAudio', { 
            motivo: 'inicio_navegacion',
            destino: data.parada.id,
            timestamp: Date.now()
        });
        
        // Actualizar estado global
        await actualizarEstadoGlobal({
            navegando: true,
            destino: data.parada.id,
            ultimaAccion: 'inicio_navegacion',
            timestamp: Date.now()
        });
    } catch (error) {
        console.error(`${logPrefix} Error al pausar audio:`, error);
        throw error;
    }
}

/**
 * Maneja el fin de la navegaci√≥n
 * @param {Object} data - Datos de finalizaci√≥n
 * @returns {Promise<void>}
 */
async function manejarFinNavegacion(data) {
    const logPrefix = 'üèÅ PADRE: Navegaci√≥n finalizada:';
    console.log(logPrefix, data?.motivo || 'sin motivo especificado');
    
    // Actualizar estado global
    await actualizarEstadoGlobal({
        navegando: false,
        ultimaAccion: 'fin_navegacion',
        timestamp: Date.now()
    });
}

/**
 * Maneja el cambio de modo desde el hijo2
 * @param {Object} data - Datos del cambio de modo
 * @returns {Promise<void>}
 */
async function manejarCambioModoHijo2(data) {
    const logPrefix = 'üîÑ PADRE: Cambio de modo desde hijo2:';
    
    if (!data?.modo) {
        console.warn(`${logPrefix} Modo no especificado:`, data);
        return;
    }
    
    console.log(`${logPrefix} ${data.modo}`);
    
    // Delegar al manejador principal de cambio de modo
    await manejarCambioModo(data.modo, data.habilitar);
}

/**
 * Maneja la sincronizaci√≥n de estado con el hijo2
 * @param {Object} data - Datos de sincronizaci√≥n
 * @returns {Promise<void>}
 */
async function manejarSincronizacionEstadoHijo2(data) {
    const logPrefix = 'üîÑ PADRE: Sincronizando estado con hijo2:';
    console.log(logPrefix, data?.mensaje || 'solicitado por el hijo2');
    
    // Obtener estado actual
    const estadoActual = {
        modo: window.estadoGlobal?.modo || 'aventura',
        navegando: window.estadoGlobal?.navegando || false,
        paradaActual: window.estadoGlobal?.paradaActual,
        timestamp: Date.now()
    };
    
    // Enviar estado actual al hijo2
    await enviarMensaje('hijo2', 'estadoSincronizado', estadoActual);
}

/**
 * Maneja los errores reportados por el hijo2
 * @param {Object} data - Datos del error
 * @returns {Promise<void>}
 */
async function manejarErrorHijo2(data) {
    const logPrefix = '‚ùå PADRE: Error en hijo2:';
    
    if (!data) {
        console.error(`${logPrefix} Sin datos de error`);
        return;
    }
    
    const { codigo, mensaje, stack, timestamp } = data;
    const errorMsg = `[${codigo || 'DESCONOCIDO'}] ${mensaje || 'Error sin mensaje'}`;
    
    console.groupCollapsed(`${logPrefix} ${errorMsg}`);
    console.error('Detalles del error:', data);
    if (stack) console.error('Stack trace:', stack);
    console.groupEnd();
    
    // Mostrar notificaci√≥n al usuario si es un error cr√≠tico
    if (window.mostrarMensajeInfoParada) {
        window.mostrarMensajeInfoParada(`Error en navegaci√≥n: ${mensaje || 'Error desconocido'}`, true);
    }
    
    // Actualizar estado global con el error
    await actualizarEstadoGlobal({
        error: {
            codigo,
            mensaje,
            origen: 'hijo2',
            timestamp: timestamp || Date.now()
        },
        ultimaAccion: 'error',
        timestamp: Date.now()
    });
}

/**
 * Maneja los mensajes recibidos del iframe hijo3 (reproductor de audio)
 * @param {string} type - Tipo de mensaje recibido
 * @param {Object} data - Datos del mensaje
 * @param {Object} [event=null] - Evento original (opcional)
 * @returns {Promise<void>}
 */
async function manejarMensajeHijo3(type, data, event = null) {
    const timestamp = new Date().toISOString();
    const logPrefix = `[${timestamp}] üîä PADRE -> Hijo3 (${type}):`;
    
    try {
        // Validaci√≥n b√°sica del mensaje
        if (!type) {
            console.warn(`${logPrefix} Mensaje sin tipo recibido:`, data);
            return;
        }

        // Registrar recepci√≥n del mensaje
        console.groupCollapsed(`${logPrefix} Mensaje recibido`);
        console.log('üìã Datos recibidos:', data);
        if (event) console.log('üìé Metadata del evento:', event);
        console.groupEnd();

        // Procesar el mensaje seg√∫n su tipo
        switch (type) {
            case 'audioIniciado':
                await manejarAudioIniciado(data);
                break;
                
            case 'audioTerminado':
                await manejarAudioTerminado(data);
                break;
                
            case 'cambioVolumen':
                await manejarCambioVolumen(data);
                break;
                
            case 'solicitarEstado':
                await manejarSolicitudEstado(data);
                break;
                
            case 'cambiarTiempo':
                await manejarCambioTiempo(data);
                break;
                
            case 'cambioModo':
                await manejarCambioModoHijo3(data);
                break;
                
            case 'sincronizarEstado':
                await manejarSincronizacionEstadoHijo3(data);
                break;
                
            case 'error':
                await manejarErrorHijo3(data);
                break;
                
            case 'estadoReproduccion':
                await manejarEstadoReproduccion(data);
                break;
                
            default:
                console.warn(`${logPrefix} Tipo de mensaje no reconocido:`, type);
                break;
        }
        
        // Confirmar recepci√≥n del mensaje si tiene un ID
        if (event?.data?.id) {
            await enviarMensaje('hijo3', 'confirmacionRecepcion', {
                idMensajeOriginal: event.data.id,
                timestamp: Date.now(),
                estado: 'procesado',
                tipo: type
            });
        }
    } catch (error) {
        console.error(`${logPrefix} Error al procesar mensaje:`, error);
        
        // Notificar al hijo3 sobre el error
        try {
            await enviarMensaje('hijo3', 'error', {
                codigo: 'ERROR_PROCESAMIENTO',
                mensaje: error.message || 'Error al procesar el mensaje',
                stack: process.env.NODE_ENV === 'development' ? error.stack : undefined,
                timestamp: Date.now(),
                tipoMensajeOriginal: type
            });
        } catch (e) {
            console.error(`${logPrefix} Error al notificar error al hijo3:`, e);
        }
    }
}

/**
 * Maneja el evento de inicio de reproducci√≥n de audio
 * @param {Object} data - Datos del audio
 * @returns {Promise<void>}
 */
async function manejarAudioIniciado(data) {
    const logPrefix = 'üîä PADRE: Audio iniciado:';
    
    if (!data?.audioId) {
        console.warn(`${logPrefix} Datos de audio incompletos:`, data);
        return;
    }
    
    console.log(`${logPrefix} ${data.audioId}`);
    
    // Actualizar el estado global
    await actualizarEstadoGlobal({
        ultimaAccion: 'audio_iniciado',
        audioActual: data.audioId,
        estadoReproduccion: 'reproduciendo',
        timestamp: Date.now()
    });
    
    // Notificar a otros componentes si es necesario
    if (data.paradaId) {
        await actualizarEstadoGlobal({
            paradaActual: data.paradaId
        });
    }
}

/**
 * Maneja el evento de finalizaci√≥n de audio
 * @param {Object} data - Datos del audio
 * @returns {Promise<void>}
 */
async function manejarAudioTerminado(data) {
    const logPrefix = 'üîä PADRE: Audio terminado:';
    
    if (!data?.audioId) {
        console.warn(`${logPrefix} Datos de audio incompletos:`, data);
        return;
    }
    
    console.log(`${logPrefix} ${data.audioId}`);
    
    // Actualizar el estado global
    await actualizarEstadoGlobal({
        ultimaAccion: 'audio_terminado',
        audioAnterior: data.audioId,
        estadoReproduccion: 'detenido',
        timestamp: Date.now()
    });
    
    // Si es un audio de parada con retos, mostrarlos
    const puntoActual = estadoGlobal.puntoActual;
    if (puntoActual?.retos?.length > 0) {
        const primerReto = puntoActual.retos[0];
        await enviarMensaje('hijo4', 'mostrarReto', { 
            reto: primerReto,
            esPrimero: true,
            esUltimo: puntoActual.retos.length === 1
        });
    } else {
        avanzarSiguientePunto();
    }
}

/**
 * Maneja el cambio de volumen del reproductor de audio
 * @param {Object} data - Datos del cambio de volumen
 * @returns {Promise<void>}
 */
async function manejarCambioVolumen(data) {
    const logPrefix = 'üîä PADRE: Cambio de volumen:';
    
    if (typeof data?.volumen !== 'number') {
        console.warn(`${logPrefix} Volumen no especificado o inv√°lido:`, data);
        return;
    }
    
    console.log(`${logPrefix} ${data.volumen * 100}%`);
    
    // Actualizar el estado global
    await actualizarEstadoGlobal({
        volumen: data.volumen,
        timestamp: Date.now()
    });
}

/**
 * Maneja la solicitud de estado del reproductor
 * @param {Object} data - Datos de la solicitud
 * @returns {Promise<void>}
 */
async function manejarSolicitudEstado(data) {
    const logPrefix = 'üîä PADRE: Solicitud de estado recibida:';
    console.log(logPrefix, data);
    
    // Enviar el estado actual al hijo3
    await enviarMensaje('hijo3', 'estadoActual', {
        volumen: estadoGlobal.volumen || 0.7,
        modo: estadoGlobal.modo || 'aventura',
        audioActual: estadoGlobal.audioActual || null,
        estadoReproduccion: estadoGlobal.estadoReproduccion || 'detenido',
        timestamp: Date.now()
    });
}

/**
 * Maneja el cambio de tiempo de reproducci√≥n
 * @param {Object} data - Datos del cambio de tiempo
 * @returns {Promise<void>}
 */
async function manejarCambioTiempo(data) {
    const logPrefix = 'üîä PADRE: Cambio de tiempo:';
    
    if (typeof data?.tiempo !== 'number') {
        console.warn(`${logPrefix} Tiempo no especificado o inv√°lido:`, data);
        return;
    }
    
    console.log(`${logPrefix} ${data.tiempo} segundos`);
    
    // Actualizar el estado global si es necesario
    await actualizarEstadoGlobal({
        tiempoReproduccion: data.tiempo,
        timestamp: Date.now()
    });
}

/**
 * Maneja el cambio de modo desde el hijo3
 * @param {Object} data - Datos del cambio de modo
 * @returns {Promise<void>}
 */
async function manejarCambioModoHijo3(data) {
    const logPrefix = 'üîä PADRE: Cambio de modo desde hijo3:';
    
    if (!data?.modo) {
        console.warn(`${logPrefix} Modo no especificado:`, data);
        return;
    }
    
    console.log(`${logPrefix} ${data.modo}`);
    
    // Actualizar el estado global
    await actualizarEstadoGlobal({
        modo: data.modo,
        timestamp: Date.now()
    });
    
    // Asegurarse de que los iframes est√©n en el estado correcto
    await actualizarEstadoIframesHijos(data.modo);
}

/**
 * Maneja la sincronizaci√≥n de estado con el hijo3
 * @param {Object} data - Datos de sincronizaci√≥n
 * @returns {Promise<void>}
 */
async function manejarSincronizacionEstadoHijo3(data) {
    const logPrefix = 'üîä PADRE: Sincronizaci√≥n de estado con hijo3:';
    console.log(logPrefix, data);
    
    // Enviar el estado actual al hijo3
    await enviarMensaje('hijo3', 'estadoSincronizado', {
        ...estadoGlobal,
        timestamp: Date.now()
    });
}

/**
 * Maneja los errores reportados por el hijo3
 * @param {Object} data - Datos del error
 * @returns {Promise<void>}
 */
async function manejarErrorHijo3(data) {
    const logPrefix = 'üîä PADRE: Error reportado por hijo3:';
    
    if (!data?.mensaje) {
        console.error(`${logPrefix} Error sin mensaje:`, data);
        return;
    }
    
    console.error(`${logPrefix} ${data.codigo || 'ERROR_DESCONOCIDO'}: ${data.mensaje}`);
    
    if (data.stack) {
        console.error('Stack trace:', data.stack);
    }
    
    // Mostrar notificaci√≥n al usuario si es necesario
    if (data.mostrarAlUsuario) {
        mostrarMensajeInfoParada(`Error de audio: ${data.mensaje}`, true);
    }
    
    // Actualizar el estado global
    await actualizarEstadoGlobal({
        ultimoError: {
            origen: 'hijo3',
            codigo: data.codigo || 'ERROR_DESCONOCIDO',
            mensaje: data.mensaje,
            timestamp: Date.now()
        },
        estadoReproduccion: 'error'
    });
}

/**
 * Maneja las actualizaciones de estado de reproducci√≥n
 * @param {Object} data - Datos del estado de reproducci√≥n
 * @returns {Promise<void>}
 */
async function manejarEstadoReproduccion(data) {
    const logPrefix = 'üîä PADRE: Estado de reproducci√≥n actualizado:';
    
    if (!data?.estado) {
        console.warn(`${logPrefix} Estado no especificado:`, data);
        return;
    }
    
    console.log(`${logPrefix} ${data.estado}`, data);
    
    // Actualizar el estado global
    await actualizarEstadoGlobal({
        estadoReproduccion: data.estado,
        tiempoActual: data.tiempoActual || 0,
        duracion: data.duracion || 0,
        timestamp: Date.now()
    });
}

/**
 * Maneja los mensajes recibidos del iframe hijo4 (retos y preguntas)
 * @param {string} type - Tipo de mensaje recibido
 * @param {Object} data - Datos del mensaje
 * @param {Object} [event=null] - Evento original (opcional)
 * @returns {Promise<void>}
 */
async function manejarMensajeHijo4(type, data, event = null) {
    const timestamp = new Date().toISOString();
    const logPrefix = `[${timestamp}] üéÆ PADRE -> Hijo4 (${type}):`;
    
    try {
        // Validaci√≥n b√°sica del mensaje
        if (!type) {
            console.warn(`${logPrefix} Mensaje sin tipo recibido:`, data);
            return;
        }

        // Registrar recepci√≥n del mensaje
        console.groupCollapsed(`${logPrefix} Mensaje recibido`);
        console.log('üìã Datos recibidos:', data);
        if (event) console.log('üìé Metadata del evento:', event);
        console.groupEnd();

        // Procesar el mensaje seg√∫n su tipo
        switch (type) {
            case 'retoIniciado':
                await manejarRetoIniciado(data);
                break;
                
            case 'retoCompletado':
                await manejarRetoCompletado(data);
                break;
                
            case 'retoFallido':
                await manejarRetoFallido(data);
                break;
                
            case 'retoExpirado':
                await manejarRetoExpirado(data);
                break;
                
            case 'solicitarPista':
                await manejarSolicitudPista(data);
                break;
                
            case 'puzzleCompletado':
                await manejarPuzzleCompletado(data);
                break;
                
            case 'cambioModo':
                await manejarCambioModoHijo4(data);
                break;
                
            case 'sincronizarEstado':
                await manejarSincronizacionEstadoHijo4(data);
                break;
                
            case 'error':
                await manejarErrorHijo4(data);
                break;
                
            default:
                console.warn(`${logPrefix} Tipo de mensaje no reconocido:`, type);
                break;
        }
        
        // Confirmar recepci√≥n del mensaje si tiene un ID
        if (event?.data?.id) {
            await enviarMensaje('hijo4', 'confirmacionRecepcion', {
                idMensajeOriginal: event.data.id,
                timestamp: Date.now(),
                estado: 'procesado',
                tipo: type
            });
        }
    } catch (error) {
        console.error(`${logPrefix} Error al procesar mensaje:`, error);
        
        // Notificar al hijo4 sobre el error
        try {
            await enviarMensaje('hijo4', 'error', {
                codigo: 'ERROR_PROCESAMIENTO',
                mensaje: error.message || 'Error al procesar el mensaje',
                stack: process.env.NODE_ENV === 'development' ? error.stack : undefined,
                timestamp: Date.now(),
                tipoMensajeOriginal: type
            });
        } catch (e) {
            console.error(`${logPrefix} Error al notificar error al hijo4:`, e);
        }
    }
}

/**
 * Maneja el inicio de un reto
 * @param {Object} data - Datos del reto
 * @returns {Promise<void>}
 */
async function manejarRetoIniciado(data) {
    const logPrefix = 'üéØ PADRE: Reto iniciado:';
    
    if (!data?.retoId) {
        console.warn(`${logPrefix} Datos de reto incompletos:`, data);
        return;
    }
    
    console.log(`${logPrefix} ${data.retoId}`);
    
    // Pausar audio al iniciar reto
    await enviarMensaje('hijo3', 'pausarAudio', { 
        motivo: 'reto_iniciado',
        retoId: data.retoId
    });
    
    // Actualizar el estado global
    await actualizarEstadoGlobal({
        ultimaAccion: 'reto_iniciado',
        retoActual: {
            id: data.retoId,
            estado: 'en_progreso',
            inicio: Date.now(),
            tiempoLimite: data.tiempoLimite || null,
            pistasUsadas: 0,
            intentos: 0
        },
        timestamp: Date.now()
    });
}

/**
 * Maneja la finalizaci√≥n exitosa de un reto
 * @param {Object} data - Datos del reto completado
 * @returns {Promise<void>}
 */
async function manejarRetoCompletado(data) {
    const logPrefix = 'üèÜ PADRE: Reto completado:';
    
    if (!data?.retoId) {
        console.warn(`${logPrefix} Datos de reto incompletos:`, data);
        return;
    }
    
    console.log(`${logPrefix} ${data.retoId}`);
    
    // Actualizar el estado global
    await actualizarEstadoGlobal({
        ultimaAccion: 'reto_completado',
        retoActual: {
            ...(estadoGlobal.retoActual || { id: data.retoId }),
            estado: 'completado',
            fin: Date.now(),
            exito: true
        },
        timestamp: Date.now()
    });
    
    // Manejar la l√≥gica de finalizaci√≥n del reto
    manejarRetoCompletado(data.retoId);
}

/**
 * Maneja el fallo en un reto
 * @param {Object} data - Datos del reto fallido
 * @returns {Promise<void>}
 */
async function manejarRetoFallido(data) {
    const logPrefix = '‚ùå PADRE: Reto fallido:';
    
    if (!data?.retoId) {
        console.warn(`${logPrefix} Datos de reto incompletos:`, data);
        return;
    }
    
    console.log(`${logPrefix} ${data.retoId}`, data.mensaje || '');
    
    // Actualizar el estado global
    await actualizarEstadoGlobal({
        ultimaAccion: 'reto_fallido',
        retoActual: {
            ...(estadoGlobal.retoActual || { id: data.retoId }),
            estado: 'fallido',
            fin: Date.now(),
            exito: false,
            motivo: data.motivo || 'desconocido',
            intentos: (estadoGlobal.retoActual?.intentos || 0) + 1
        },
        timestamp: Date.now()
    });
    
    // Notificar al usuario
    mostrarMensajeInfoParada(`Reto fallido: ${data.mensaje || 'Int√©ntalo de nuevo'}`, true);
}

/**
 * Maneja la expiraci√≥n del tiempo de un reto
 * @param {Object} data - Datos del reto expirado
 * @returns {Promise<void>}
 */
async function manejarRetoExpirado(data) {
    const logPrefix = '‚è∞ PADRE: Tiempo de reto agotado:';
    
    if (!data?.retoId) {
        console.warn(`${logPrefix} Datos de reto incompletos:`, data);
        return;
    }
    
    console.log(`${logPrefix} ${data.retoId}`);
    
    // Actualizar el estado global
    await actualizarEstadoGlobal({
        ultimaAccion: 'reto_expirado',
        retoActual: {
            ...(estadoGlobal.retoActual || { id: data.retoId }),
            estado: 'expirado',
            fin: Date.now(),
            exito: false,
            motivo: 'tiempo_agotado'
        },
        timestamp: Date.now()
    });
    
    // Notificar al usuario
    mostrarMensajeInfoParada('¬°Tiempo agotado! El reto ha expirado.', true);
}

/**
 * Maneja la solicitud de una pista para el reto actual
 * @param {Object} data - Datos de la solicitud de pista
 * @returns {Promise<void>}
 */
async function manejarSolicitudPista(data) {
    const logPrefix = 'üí° PADRE: Solicitud de pista:';
    
    if (!data?.retoId) {
        console.warn(`${logPrefix} Datos de reto incompletos:`, data);
        return;
    }
    
    console.log(`${logPrefix} ${data.retoId}`);
    
    // Incrementar contador de pistas usadas
    const pistasUsadas = (estadoGlobal.retoActual?.pistasUsadas || 0) + 1;
    
    // Actualizar el estado global
    await actualizarEstadoGlobal({
        retoActual: {
            ...(estadoGlobal.retoActual || { id: data.retoId }),
            pistasUsadas,
            ultimaPista: Date.now()
        },
        timestamp: Date.now()
    });
    
    // Obtener y enviar la pista correspondiente
    const pista = await obtenerPistaParaReto(data.retoId, pistasUsadas);
    if (pista) {
        await enviarMensaje('hijo4', 'nuevaPista', {
            retoId: data.retoId,
            pista,
            numero: pistasUsadas,
            totalPistas: data.totalPistas || 3 // Valor por defecto
        });
    }
}

/**
 * Maneja la finalizaci√≥n exitosa de un puzzle
 * @param {Object} data - Datos del puzzle completado
 * @returns {Promise<void>}
 */
async function manejarPuzzleCompletado(data) {
    const logPrefix = 'üß© PADRE: Puzzle completado:';
    
    if (!data?.puzzleId) {
        console.warn(`${logPrefix} Datos de puzzle incompletos:`, data);
        return;
    }
    
    console.log(`${logPrefix} ${data.puzzleId}`);
    
    // Actualizar el estado global
    await actualizarEstadoGlobal({
        ultimaAccion: 'puzzle_completado',
        puzzleActual: {
            id: data.puzzleId,
            estado: 'completado',
            fin: Date.now(),
            exito: true
        },
        timestamp: Date.now()
    });
    
    // Continuar con el siguiente punto
    avanzarSiguientePunto();
}

/**
 * Maneja el cambio de modo desde el hijo4
 * @param {Object} data - Datos del cambio de modo
 * @returns {Promise<void>}
 */
async function manejarCambioModoHijo4(data) {
    const logPrefix = 'üîÑ PADRE: Cambio de modo desde hijo4:';
    
    if (!data?.modo) {
        console.warn(`${logPrefix} Modo no especificado:`, data);
        return;
    }
    
    console.log(`${logPrefix} ${data.modo}`);
    
    // Actualizar el estado global
    await actualizarEstadoGlobal({
        modo: data.modo,
        timestamp: Date.now()
    });
    
    // Asegurarse de que los iframes est√©n en el estado correcto
    await actualizarEstadoIframesHijos(data.modo);
}

/**
 * Maneja la sincronizaci√≥n de estado con el hijo4
 * @param {Object} data - Datos de sincronizaci√≥n
 * @returns {Promise<void>}
 */
async function manejarSincronizacionEstadoHijo4(data) {
    const logPrefix = 'üîÑ PADRE: Sincronizaci√≥n de estado con hijo4:';
    console.log(logPrefix, data);
    
    // Enviar el estado actual al hijo4
    await enviarMensaje('hijo4', 'estadoSincronizado', {
        ...estadoGlobal,
        timestamp: Date.now()
    });
}

/**
 * Maneja los errores reportados por el hijo4
 * @param {Object} data - Datos del error
 * @returns {Promise<void>}
 */
async function manejarErrorHijo4(data) {
    const logPrefix = '‚ùå PADRE: Error reportado por hijo4:';
    
    if (!data?.mensaje) {
        console.error(`${logPrefix} Error sin mensaje:`, data);
        return;
    }
    
    console.error(`${logPrefix} ${data.codigo || 'ERROR_DESCONOCIDO'}: ${data.mensaje}`);
    
    if (data.stack) {
        console.error('Stack trace:', data.stack);
    }
    
    // Mostrar notificaci√≥n al usuario si es necesario
    if (data.mostrarAlUsuario) {
        mostrarMensajeInfoParada(`Error en el reto: ${data.mensaje}`, true);
    }
    
    // Actualizar el estado global
    await actualizarEstadoGlobal({
        ultimoError: {
            origen: 'hijo4',
            codigo: data.codigo || 'ERROR_DESCONOCIDO',
            mensaje: data.mensaje,
            timestamp: Date.now()
        },
        timestamp: Date.now()
    });
}

/**
 * Obtiene una pista para un reto espec√≠fico
 * @param {string} retoId - ID del reto
 * @param {number} numeroPista - N√∫mero de pista solicitada (1-based)
 * @returns {Promise<string>} - Texto de la pista
 */
async function obtenerPistaParaReto(retoId, numeroPista) {
    // Implementaci√≥n de ejemplo - deber√≠as reemplazarla con tu l√≥gica real
    const pistas = {
        'R-1': [
            'Pista 1: Observa los detalles de la fachada',
            'Pista 2: Busca elementos decorativos en la parte superior',
            'Pista 3: El n√∫mero est√° en un escudo'
        ],
        // Agrega m√°s retos seg√∫n sea necesario
    };
    
    const pistasReto = pistas[retoId] || [];
    return pistasReto[Math.min(numeroPista - 1, pistasReto.length - 1)] || 
           `Pista ${numeroPista}: Sigue intent√°ndolo, est√°s cerca.`;
}

// ================== FUNCIONES DE CONTROL ==================

/**
 * Deshabilita los controles con un motivo espec√≠fico
 * @param {string} motivo - Raz√≥n de la deshabilitaci√≥n
 */
function disableControls(motivo = 'desconocido') {
    console.log(`üîí Deshabilitando controles: ${motivo}`);
    // Implementa la l√≥gica para deshabilitar controles
    return Promise.resolve();
}

/**
 * Habilita los controles seg√∫n el modo especificado
 * @param {string} modo - Modo de operaci√≥n ('casa' o 'aventura')
 */
function enableControls(modo = 'casa') {
    console.log(`üîì PADRE: Habilitando controles en modo ${modo}`);
    
    // Actualizar estado global
    window.estadoGlobal = window.estadoGlobal || {};
    window.estadoGlobal.controlesHabilitados = true;
    window.estadoGlobal.modo = modo;
    
    // Notificar a los hijos sobre el cambio de modo
    actualizarEstadoIframesHijos(modo);
    
    // Actualizar la interfaz de usuario seg√∫n el modo
    actualizarInterfazModo(modo);
}

/**
 * Deshabilita los controles con un motivo espec√≠fico
 * @param {string} motivo - Raz√≥n de la deshabilitaci√≥n
 */
function disableControls(motivo = 'desconocido') {
    console.log(`üîí PADRE: Deshabilitando controles - Motivo: ${motivo}`);
    
    // Actualizar estado global
    window.estadoGlobal = window.estadoGlobal || {};
    window.estadoGlobal.controlesHabilitados = false;
    window.estadoGlobal.motivoDeshabilitacion = motivo;
    
    // Notificar a los hijos sobre la deshabilitaci√≥n
    const iframes = ['hijo2', 'hijo3', 'hijo4'];
    iframes.forEach(id => {
        try {
            enviarMensaje(id, 'SISTEMA.CONTROL', {
                tipo: 'deshabilitar_controles',
                motivo: motivo,
                timestamp: Date.now()
            });
        } catch (error) {
            console.error(`Error notificando a ${id}:`, error);
        }
    });
}

/**
 * Maneja el cambio de modo de la aplicaci√≥n
 * @param {string} modo - Nuevo modo ('casa' o 'aventura')
 * @param {boolean} habilitar - Si es true, habilita los controles
 */
function manejarCambioModo(modo, habilitar = false) {
    console.log(`üîÑ PADRE: Cambiando a modo ${modo}, habilitar: ${habilitar}`);
    
    // Validar el modo
    if (modo !== 'casa' && modo !== 'aventura') {
        console.warn(`‚ö†Ô∏è PADRE: Modo no reconocido: ${modo}. Usando 'casa' por defecto.`);
        modo = 'casa';
    }
    
    // Actualizar el estado global
    window.estadoGlobal = window.estadoGlobal || {};
    window.estadoGlobal.modo = modo;
    
    // Habilitar o deshabilitar controles seg√∫n corresponda
    if (habilitar) {
        enableControls(modo);
    } else {
        disableControls(`cambio_a_modo_${modo}`);
    }
    
    // Notificar a los hijos sobre el cambio de modo
    const iframes = ['hijo2', 'hijo3', 'hijo4'];
    iframes.forEach(id => {
        try {
            enviarMensaje(id, 'SISTEMA.CONFIGURACION', {
                tipo: 'cambio_modo',
                modo: modo,
                habilitar: habilitar,
                timestamp: Date.now()
            });
        } catch (error) {
            console.error(`Error notificando a ${id}:`, error);
        }
    });
    
    // Actualizar la interfaz de usuario
    actualizarInterfazModo(modo);
}

/**
 * Actualiza la interfaz de usuario seg√∫n el modo actual
 * @param {string} modo - Modo actual ('casa' o 'aventura')
 */
function actualizarInterfazModo(modo) {
    // Implementar l√≥gica para actualizar la interfaz seg√∫n el modo
    console.log(`üé® PADRE: Actualizando interfaz para modo ${modo}`);
    
    // Ejemplo: Cambiar estilos seg√∫n el modo
    const body = document.body;
    if (modo === 'aventura') {
        body.classList.add('modo-aventura');
        body.classList.remove('modo-casa');
    } else {
        body.classList.add('modo-casa');
        body.classList.remove('modo-aventura');
    }
    
    // Aqu√≠ puedes a√±adir m√°s l√≥gica de actualizaci√≥n de la interfaz
}

// La funci√≥n manejarMensajeHijo4 ya est√° definida en otra parte del c√≥digo

/**
 * Maneja los mensajes de tipo SISTEMA
 * @param {Object} data - Datos del mensaje
 * @returns {Promise<void>}
 */
async function manejarMensajeSistema(data) {
    if (data.tipo === 'hijo_listo') {
        console.log(`‚úÖ PADRE: ${data.id || 'Hijo'} listo en modo ${data.modo || 'desconocido'}`);
        
        // Sincronizar el estado con el hijo reci√©n cargado
        if (window.estadoGlobal) {
            window.estadoGlobal.ultimaActualizacion = Date.now();
            
            // Enviar el estado actual al hijo usando el sistema de mensajer√≠a
            const destino = data.id || 'hijo4';
            try {
                await enviarMensaje(destino, 'ESTADO.ACTUALIZAR', {
                    estado: window.estadoGlobal,
                    modo: window.estadoGlobal.modo || 'casa',
                    controlesHabilitados: window.estadoGlobal.controlesHabilitados !== false
                });
                console.log(`‚úÖ PADRE: Estado sincronizado con ${destino}`);
            } catch (error) {
                console.error(`‚ùå PADRE: Error al sincronizar estado con ${destino}:`, error);
            }
        }
    }
}

/**
 * Maneja los mensajes de configuraci√≥n del sistema
 * @param {Object} data - Datos del mensaje
 */
function manejarMensajeConfiguracion(data) {
    if (data.tipo === 'cambio_modo') {
        console.log(`üîÑ PADRE: Solicitado cambio a modo ${data.modo}`);
        manejarCambioModo(data.modo, data.habilitar);
    }
}

// ================== FUNCIONES AUXILIARES ==================

// La funci√≥n manejarRetoCompletado ya est√° definida en otra parte del c√≥digo

function avanzarSiguientePunto() {
    const indiceActual = AVENTURA_PARADAS.findIndex(p => 
        (p.parada_id === estadoGlobal.puntoActual?.parada_id) || 
        (p.tramo_id === estadoGlobal.puntoActual?.tramo_id)
    );

    if (indiceActual < AVENTURA_PARADAS.length - 1) {
        const siguientePunto = AVENTURA_PARADAS[indiceActual + 1];
        actualizarEstadoGlobal({ puntoActual: siguientePunto });

        // Notificar a los hijos seg√∫n el tipo de punto
        if (siguientePunto.parada_id) {
            // Es una parada
            if (siguientePunto.retos?.length > 0) {
                // Tiene retos, el audio se reproducir√° primero y luego se mostrar√°n los retos
                enviarMensaje('hijo3', 'reproducirAudio', { 
                    audioId: siguientePunto.audio_id,
                    esperarRetos: true
                });
            } else {
                // No tiene retos, solo reproducir audio
                enviarMensaje('hijo3', 'reproducirAudio', { 
                    audioId: siguientePunto.audio_id 
                });
            }
        } else if (siguientePunto.tramo_id) {
            // Es un tramo, reproducir audio
            enviarMensaje('hijo3', 'reproducirAudio', { 
                audioId: siguientePunto.audio_id 
            });
        }
    } else {
        console.log('üèÅ PADRE: Fin del recorrido');
    }
}
            
            try {
                switch(data.type) {
                    case 'hijo4Ready':
                    case 'retos-hijo-listo':
                        console.log('‚úÖ PADRE: Hijo 4 (Retos) listo y operativo');
                        // Confirmar recepci√≥n y sincronizar estado actual
                        const respuesta = {
                            type: 'sincronizarEstado',
                            origen: 'padre',
                            destino: 'hijo4',
                            timestamp: Date.now(),
                            estado: {
                                modo: estadoGlobal.modo || 'aventura',
                                retoActivo: estadoGlobal.datosCompartidos?.reto?.activo || false,
                                retoCompletado: estadoGlobal.datosCompartidos?.reto?.completado || false,
                                paradaActual: estadoGlobal.puntoActual?.id || null,
                                puntoActual: estadoGlobal.puntoActual || null
                            }
                        };
                        
                        iframe.contentWindow.postMessage(respuesta, '*');
                        console.log('üîÑ PADRE: Estado sincronizado con hijo4', respuesta.estado);
                        break;
                        
                    case 'retoIniciado':
                        console.log('üéØ PADRE: Reto iniciado:', data.retoId);
                        // Actualizar estado global
                        const nuevoEstado = {
                            reto: {
                                activo: true,
                                completado: false,
                                id: data.retoId,
                                timestamp: Date.now()
                            },
                            // Pausar la reproducci√≥n de audio cuando se inicia un reto
                            reproduciendoAudio: false
                        };
                        
                        actualizarEstadoGlobal(nuevoEstado);
                        
                        // Notificar al hijo3 (audio) que debe pausar la reproducci√≥n
                        const hijo3 = document.getElementById('hijo3');
                        if (hijo3 && hijo3.contentWindow) {
                            hijo3.contentWindow.postMessage({
                                type: 'pausarReproduccion',
                                motivo: 'reto_iniciado',
                                retoId: data.retoId,
                                timestamp: Date.now()
                            }, '*');
                            console.log('‚è∏Ô∏è PADRE: Solicitada pausa de reproducci√≥n por inicio de reto');
                        }
                        break;
                        
                    case 'retoCompletado':
                        console.log('üèÜ PADRE: Reto completado:', data.retoId);
                        
                        // Verificar si el reto completado tiene un puzzle asociado
                        const puzzleAsociado = RETO_PUZZLE_MAP[data.retoId];
                        
                        // Actualizar estado global
                        actualizarEstadoGlobal({
                            reto: {
                                activo: false,
                                completado: true,
                                id: data.retoId,
                                timestamp: Date.now(),
                                puzzleAsociado: puzzleAsociado || null
                            }
                        });
                        
                        // Ocultar el iframe del reto
                        const iframeHijo4 = document.getElementById('hijo4');
                        if (iframeHijo4) {
                            iframeHijo4.style.display = 'none';
                            console.log('üëã PADRE: Iframe de retos oculto');
                        }
                        
                        // Notificar al hijo3 (audio) que puede reanudar la reproducci√≥n
                        const hijo3Audio = document.getElementById('hijo3');
                        if (hijo3Audio?.contentWindow) {
                            hijo3Audio.contentWindow.postMessage({
                                type: 'reanudarReproduccion',
                                motivo: 'reto_completado',
                                retoId: data.retoId,
                                timestamp: Date.now()
                            }, '*');
                            console.log('‚ñ∂Ô∏è PADRE: Solicitada reanudaci√≥n de reproducci√≥n');
                        }
                        
                        // Si hay un puzzle asociado, mostrarlo despu√©s de un breve retraso
                        if (puzzleAsociado) {
                            console.log(`üß© PADRE: Mostrando puzzle asociado: ${puzzleAsociado}`);
                            
                            // Mostrar el puzzle despu√©s de un breve retraso
                            setTimeout(() => {
                                // Aqu√≠ ir√≠a la l√≥gica para mostrar el puzzle
                                // Por ahora, solo lo registramos en consola
                                console.log(`üîç PADRE: Mostrando puzzle ${puzzleAsociado}...`);
                                
                                // Notificar al hijo4 para que muestre el puzzle
                                if (iframeHijo4 && iframeHijo4.contentWindow) {
                                    iframeHijo4.contentWindow.postMessage({
                                        type: 'mostrarPuzzle',
                                        puzzleId: puzzleAsociado,
                                        retoId: data.retoId
                                    }, '*');
                                    
                                    // Mostrar el iframe del reto/puzzle
                                    iframeHijo4.style.display = 'block';
                                    console.log(`üîÑ PADRE: Solicitado mostrar puzzle ${puzzleAsociado}`);
                                }
                            }, 1000);
                        } else {
                            // Si no hay puzzle asociado, continuar con el siguiente punto
                            if (typeof avanzarSiguientePunto === 'function') {
                                console.log('üîÑ PADRE: No hay puzzle asociado, continuando con el siguiente punto');
                                avanzarSiguientePunto();
                            }
                        }
                        break;
                        
                    case 'cerrarReto':
                        console.log('üö™ PADRE: Cerrando reto sin completar');
                        // Actualizar estado global
                        actualizarEstadoGlobal({
                            reto: {
                                activo: false,
                                completado: false,
                                id: null,
                                timestamp: Date.now()
                            }
                        });
                        break;
                        
                    case 'solicitarSincronizacion':
                        console.log('üîÑ PADRE: Sincronizaci√≥n solicitada por hijo4');
                        // Enviar estado actual al hijo 4
                        iframe.contentWindow.postMessage({
                            type: 'sincronizarEstado',
                            origen: 'padre',
                            destino: 'hijo4',
                            timestamp: Date.now(),
                            estado: {
                                modo: estadoGlobal.modo || 'aventura',
                                retoActivo: estadoGlobal.datosCompartidos?.reto?.activo || false,
                                retoCompletado: estadoGlobal.datosCompartidos?.reto?.completado || false,
                                paradaActual: estadoGlobal.puntoActual?.id || null,
                                puntoActual: estadoGlobal.puntoActual || null
                            }
                        }, '*');
                        break;
                        
                    case 'cambioModo':
                        console.log(`üîÑ PADRE: Hijo4 notifica cambio de modo a ${data.modo}`);
                        // Actualizar estado global y sincronizar con otros hijos
                        actualizarEstadoGlobal({
                            modo: data.modo,
                            ultimaActualizacion: Date.now()
                        });
                        
                        // Notificar al hijo3 (audio) sobre el cambio de modo
                        const hijo3Modo = document.getElementById('hijo3');
                        if (hijo3Modo && hijo3Modo.contentWindow) {
                            hijo3Modo.contentWindow.postMessage({
                                type: 'cambioModo',
                                modo: data.modo,
                                timestamp: Date.now()
                            }, '*');
                            console.log(`üì§ PADRE: Notificado cambio de modo a hijo3: ${data.modo}`);
                        }
                        break;
                        
                    case 'puzzleCompletado':
                        console.log('üèÖ PADRE: Puzzle completado:', data.puzzleId);
                        
                        // Ocultar el iframe del puzzle
                        const iframePuzzle = document.getElementById('hijo4');
                        if (iframePuzzle) {
                            iframePuzzle.style.display = 'none';
                            console.log('üëã PADRE: Iframe de puzzle oculto');
                        }
                        
                        // Actualizar estado global
                        actualizarEstadoGlobal({
                            reto: {
                                activo: false,
                                completado: true,
                                id: data.retoId,
                                timestamp: Date.now(),
                                puzzleCompletado: true
                            }
                        });
                        
                        // Continuar con el siguiente punto de la ruta
                        if (typeof avanzarSiguientePunto === 'function') {
                            console.log('üîÑ PADRE: Puzzle completado, continuando con el siguiente punto');
                            avanzarSiguientePunto();
                        }
                        break;
                        
                    case 'error':
                        console.error('‚ùå PADRE: Error en hijo 4 (retos):', data.mensaje || 'Error desconocido');
                        mostrarMensajeInfoParada(`Error en retos: ${data.mensaje || 'Error desconocido'}`, true);
                        break;
                        
                    default:
                        console.log('‚ÑπÔ∏è PADRE: Mensaje no manejado de hijo4 (retos):', data);
                }
            } catch (error) {
                console.error('‚ùå PADRE: Error al procesar mensaje de hijo4:', error, data);
            } finally {
                console.groupEnd();
            }
        });
        
        // ================== MANEJADOR DE MENSAJES DEL HIJO 3 (REPRODUCTOR DE AUDIO) ==================
        window.addEventListener('message', async function(event) {
            const iframe = document.getElementById('hijo3');
            if (!iframe || event.source !== iframe.contentWindow) return;
            
            const data = event.data;
            if (!data || !data.type) return;
            
            const timestamp = new Date().toISOString();
            console.group(`üéµ PADRE [${timestamp}] - Mensaje de hijo3 (audio): ${data.type}`);
            console.log('üì¶ Datos recibidos:', data);
            console.log('üîó Origen:', event.origin);
            
            try {
                switch(data.type) {
                    case 'hijo3Ready':
                    case 'audio-hijo-listo':
                        console.log('‚úÖ PADRE: Hijo 3 (Reproductor) listo y operativo');
                        // Confirmar recepci√≥n y sincronizar estado actual
                        const respuesta = {
                            type: 'sincronizarEstado',
                            origen: 'padre',
                            destino: 'hijo3',
                            timestamp: Date.now(),
                            estado: {
                                modo: estadoGlobal.modo || 'aventura',
                                puntoActual: estadoGlobal.puntoActual?.id || null,
                                reproduciendo: estadoGlobal.reproduciendoAudio || false
                            }
                        };
                        
                        iframe.contentWindow.postMessage(respuesta, '*');
                        console.log('üîÑ PADRE: Estado sincronizado con hijo3', respuesta.estado);
                        break;
                        
                    case 'estadoReproduccion':
                        console.log('üéµ PADRE: Estado de reproducci√≥n actualizado:', {
                            reproduciendo: data.reproduciendo,
                            paradaActual: data.paradaActual,
                            tiempoActual: data.tiempoActual
                        });
                        
                        // Actualizar estado global
                        await actualizarEstadoGlobal({
                            reproduciendoAudio: data.reproduciendo,
                            audioActual: data.paradaActual
                        });
                        
                        // Notificar a otros componentes si es necesario
                        if (data.paradaActual) {
                            // Notificar al hijo4 (retos) sobre el cambio de parada
                            const hijo4 = document.getElementById('hijo4');
                            if (hijo4 && hijo4.contentWindow) {
                                hijo4.contentWindow.postMessage({
                                    type: 'cambioParada',
                                    parada: data.paradaActual,
                                    modo: estadoGlobal.modo,
                                    timestamp: Date.now()
                                }, '*');
                                console.log(`üì§ PADRE: Notificado cambio de parada a hijo4: ${data.paradaActual}`);
                            }
                        }
                        break;
                        
                    case 'solicitarSincronizacion':
                        console.log('üîÑ PADRE: Sincronizaci√≥n solicitada por hijo3');
                        // Enviar estado actual al hijo 3
                        iframe.contentWindow.postMessage({
                            type: 'sincronizarEstado',
                            origen: 'padre',
                            destino: 'hijo3',
                            timestamp: Date.now(),
                            estado: {
                                modo: estadoGlobal.modo || 'aventura',
                                puntoActual: estadoGlobal.puntoActual?.id || null,
                                reproduciendo: estadoGlobal.reproduciendoAudio || false
                            }
                        }, '*');
                        break;
                        
                    case 'error':
                        console.error('‚ùå PADRE: Error en hijo 3 (audio):', data.mensaje || 'Error desconocido');
                        mostrarMensajeInfoParada(`Error en reproductor: ${data.mensaje || 'Error desconocido'}`, true);
                        break;
                        
                    case 'audioFinalizado':
                        console.log('üèÅ PADRE: Audio finalizado:', data.paradaActual);
                        // Notificar a otros componentes que el audio ha terminado
                        if (data.paradaActual) {
                            // Notificar al hijo4 (retos) que el audio ha terminado
                            try {
                                await enviarMensaje('hijo4', 'audioFinalizado', {
                                    parada: data.paradaActual,
                                    timestamp: Date.now()
                                });
                                console.log(`üì§ PADRE: Notificado finalizaci√≥n de audio a hijo4: ${data.paradaActual}`);
                            } catch (error) {
                                console.error('‚ùå Error notificando finalizaci√≥n de audio a hijo4:', error);
                            }
                        }
                        break;
                        
                    case 'cambioModo':
                        console.log(`üîÑ PADRE: Hijo3 notifica cambio de modo a ${data.modo}`);
                        // Actualizar estado global y sincronizar con otros hijos
                        actualizarEstadoGlobal({
                            modo: data.modo,
                            ultimaActualizacion: Date.now()
                        });
                        break;
                        
                    default:
                        console.log('‚ÑπÔ∏è PADRE: Mensaje no manejado de hijo 3 (audio):', data);
                }
            } catch (error) {
                console.error('‚ùå PADRE: Error al procesar mensaje de hijo3:', error, data);
            } finally {
                console.groupEnd();
            }
        });
        
        // ================== FUNCI√ìN PARA VERIFICAR ESTADO DE IFRAMES ==================
        function verificarEstadoIframes() {
            console.group('üîç Estado actual de iframes');
            ['hijo2', 'hijo3', 'hijo4', 'hijo5-casa'].forEach(id => {
                const iframe = document.getElementById(id);
                console.log(`üì∫ ${id}:`, {
                    existe: !!iframe,
                    cargado: iframe?.contentDocument?.readyState === 'complete',
                    src: iframe?.src
                });
            });
            console.groupEnd();
        }

        // ================== MANEJADOR DE MENSAJES DEL HIJO 5 (BOT√ìN CASA) ==================
        let manejadorHijo5Inicializado = false;
        
        // Referencia al iframe hijo5-casa
        const iframeHijo5 = document.getElementById('hijo5-casa');
        
        // Funci√≥n para manejar el cambio de parada
        function manejarCambioParada(data) {
            console.log('üîÑ PADRE: Cambio de parada solicitado:', data);
            
            // Normalizar el ID de la parada (aceptar tanto 'P-X' como n√∫mero)
            const idParada = data.id || `P-${data.parada}`;
            const numParada = data.parada || parseInt(idParada.replace('P-', ''));
            
            // Buscar la parada en el array PARADAS
            const parada = PARADAS.find(p => 
                (p.tipo === 'parada' || p.tipo === 'inicio') && 
                (p.parada === numParada || `P-${p.parada}` === idParada)
            );
            
            if (parada) {
                // Actualizar estado global
                window.actualizarEstadoGlobal({
                    puntoActual: {
                        tipo: 'parada',
                        id: `P-${parada.parada}`,
                        numero: parada.parada,
                        nombre: parada.nombre,
                        coordenadas: parada.coordenadas,
                        audio: parada.audio,
                        reto: parada.reto
                    },
                    origen: 'hijo5-casa',
                    timestamp: Date.now()
                });
                
                // Notificar a otros iframes
                const mensaje = {
                    type: 'cambiarParada',
                    parada: parada.parada,
                    id: `P-${parada.parada}`,
                    nombre: parada.nombre,
                    coordenadas: parada.coordenadas,
                    audio: parada.audio,
                    reto: parada.reto,
                    origen: 'padre',
                    timestamp: Date.now()
                };
                
                // Enviar a todos los iframes excepto al que origin√≥ el mensaje
                ['hijo2', 'hijo3', 'hijo4'].forEach(id => {
                    enviarMensaje(id, mensaje.type, mensaje)
                        .catch(error => {
                            console.error(`‚ùå PADRE: Error al enviar mensaje a ${id}:`, error);
                        });
                });
                
                console.log(`‚úÖ PADRE: Parada cambiada a P-${parada.parada}: ${parada.nombre}`);
            } else {
                console.error(`‚ùå PADRE: No se encontr√≥ la parada con ID ${idParada} (${numParada})`);
            }
        }
        
        // Funci√≥n para manejar el cambio de tramo
        function manejarCambioTramo(data) {
            console.log('üîÑ PADRE: Cambio de tramo solicitado:', data);
            
            // Normalizar el ID del tramo (aceptar tanto 'TR-X' como n√∫mero)
            const idTramo = data.id || `TR-${data.tramo}`;
            const numTramo = data.tramo || parseInt(idTramo.replace('TR-', ''));
            
            // Buscar el tramo en el array PARADAS
            const tramo = PARADAS.find(p => 
                p.tipo === 'tramo' && 
                (p.tramo === numTramo || `TR-${p.tramo}` === idTramo)
            );
            
            if (tramo) {
                // Actualizar estado global
                window.actualizarEstadoGlobal({
                    puntoActual: {
                        tipo: 'tramo',
                        id: `TR-${tramo.tramo}`,
                        numero: tramo.tramo,
                        nombre: tramo.nombre,
                        inicio: tramo.inicio,
                        fin: tramo.fin,
                        waypoints: tramo.waypoints || [],
                        audio: tramo.audio
                    },
                    origen: 'hijo5-casa',
                    timestamp: Date.now()
                });
                
                // Notificar a otros iframes
                const mensaje = {
                    type: 'cambiarTramo',
                    tramo: tramo.tramo,
                    id: `TR-${tramo.tramo}`,
                    nombre: tramo.nombre,
                    inicio: tramo.inicio,
                    fin: tramo.fin,
                    waypoints: tramo.waypoints || [],
                    audio: tramo.audio,
                    origen: 'padre',
                    timestamp: Date.now()
                };
                
                // Enviar a todos los iframes excepto al que origin√≥ el mensaje
                ['hijo2', 'hijo3', 'hijo4'].forEach(id => {
                    enviarMensaje(id, mensaje.type, mensaje)
                        .catch(error => {
                            console.error(`‚ùå PADRE: Error al enviar mensaje a ${id}:`, error);
                        });
                });
                
                console.log(`‚úÖ PADRE: Tramo cambiado a TR-${tramo.tramo}: ${tramo.nombre}`);
            } else {
                console.error(`‚ùå PADRE: No se encontr√≥ el tramo con ID ${idTramo} (${numTramo})`);
            }
        }
        
        // Funci√≥n para bloquear/desbloquear iframes hijos seg√∫n el modo
        async function actualizarEstadoIframesHijos(modo) {
            const esModoAventura = modo === 'aventura';
            const iframes = ['hijo2', 'hijo3', 'hijo4'];
            
            for (const id of iframes) {
                try {
                    // Mensaje de cambio de modo
                    await enviarMensaje(id, 'cambioModo', {
                        modo: modo,
                        gpsActivo: esModoAventura,
                        timestamp: Date.now(),
                        origen: 'padre',
                        destino: id
                    });
                    
                    // Mensaje espec√≠fico para bloquear/desbloquear controles en hijo2
                    if (id === 'hijo2') {
                        await enviarMensaje(id, 'bloquearControles', {
                            bloquear: !esModoAventura,
                            timestamp: Date.now(),
                            origen: 'padre',
                            destino: id
                        });
                        
                        // Asegurar que el bot√≥n de ubicaci√≥n se actualice
                        await enviarMensaje(id, 'actualizarEstadoBotonUbicacion', {
                            modo: modo,
                            timestamp: Date.now(),
                            origen: 'padre',
                            destino: id
                        });
                    }
                } catch (error) {
                    console.error(`Error actualizando estado de ${id}:`, error);
                }
            }
            
            // Notificar al hijo5-casa sobre el cambio de modo
            const hijo5 = document.getElementById('hijo5-casa');
            if (hijo5 && hijo5.contentWindow) {
                hijo5.contentWindow.postMessage({
                    type: 'actualizarEstadoGPS',
                    gpsActivo: esModoAventura,
                    modo: modo,
                    timestamp: Date.now()
                }, '*');
            }
            
            console.log(`üîÑ PADRE: Estado de iframes actualizado a modo '${modo}'`);
        }

        /**
         * Maneja los mensajes recibidos del iframe hijo5-casa (bot√≥n casa)
         * @param {string} tipo - Tipo de mensaje recibido
         * @param {Object} datos - Datos del mensaje
         * @param {Object} [event=null] - Evento original (opcional)
         * @returns {Promise<void>}
         */
        async function manejarMensajeHijo5(tipo, datos, event = null) {
            const timestamp = new Date().toISOString();
            const logPrefix = `[${timestamp}] üè† PADRE -> Hijo5 (${tipo}):`;
            
            try {
                // Validaci√≥n b√°sica del mensaje
                if (!tipo) {
                    console.warn(`${logPrefix} Mensaje sin tipo recibido:`, datos);
                    return;
                }

                // Registrar recepci√≥n del mensaje
                console.groupCollapsed(`${logPrefix} Mensaje recibido`);
                console.log('üìã Datos recibidos:', datos);
                if (event) console.log('üìé Metadata del evento:', event);
                console.groupEnd();

                // Procesar el mensaje seg√∫n su tipo
                switch (tipo) {
                    case 'SISTEMA.INICIALIZACION':
                        await manejarInicializacionHijo5(datos);
                        break;
                        
                    case 'ESTADO.ACTUALIZAR':
                        await manejarActualizacionEstadoHijo5(datos);
                        break;
                        
                    case 'SISTEMA.CONFIGURACION':
                        await manejarConfiguracionSistema(datos);
                        break;
                        
                    case 'cambioModo':
                        await manejarCambioModoHijo5(datos);
                        break;
                        
                    case 'cambioParada':
                        await manejarCambioParada(datos);
                        // Forward to other children
                        if (datos.parada) {
                            await enviarMensaje('hijo2', 'cambioPunto', {
                                tipo: 'parada',
                                id: datos.parada.id,
                                numero: datos.parada.numero,
                                nombre: datos.parada.nombre,
                                origen: 'hijo5-casa',
                                timestamp: datos.timestamp || Date.now()
                            });
                            
                            await enviarMensaje('hijo3', 'cargarAudio', {
                                tipo: 'parada',
                                id: datos.parada.id,
                                numero: datos.parada.numero,
                                nombre: datos.parada.nombre,
                                origen: 'hijo5-casa',
                                timestamp: datos.timestamp || Date.now()
                            });
                            
                            await enviarMensaje('hijo4', 'mostrarReto', {
                                tipo: 'parada',
                                id: datos.parada.id,
                                numero: datos.parada.numero,
                                nombre: datos.parada.nombre,
                                origen: 'hijo5-casa',
                                timestamp: datos.timestamp || Date.now()
                            });
                        }
                        break;
                        
                    case 'PUNTO_SELECCIONADO':
                        console.log('üìç PUNTO_SELECCIONADO recibido:', datos);
                        
                        if (datos.punto?.tipo === 'parada') {
                            // Notificar a hijo2
                            await enviarMensaje('hijo2', 'cambioPunto', {
                                tipo: 'parada',
                                ...datos.punto,
                                origen: 'padre',
                                timestamp: Date.now()
                            });
                            // Notificar a hijo3
                            await enviarMensaje('hijo3', 'cargarAudio', {
                                tipo: 'parada',
                                ...datos.punto,
                                origen: 'padre',
                                timestamp: Date.now()
                            });
                            // Notificar a hijo4
                            await enviarMensaje('hijo4', 'mostrarReto', {
                                tipo: 'parada',
                                ...datos.punto,
                                origen: 'padre',
                                timestamp: Date.now()
                            });
                        } else if (datos.punto?.tipo === 'tramo') {
                            // Notificar a hijo2
                            await enviarMensaje('hijo2', 'cambioPunto', {
                                tipo: 'tramo',
                                ...datos.punto,
                                origen: 'padre',
                                timestamp: Date.now()
                            });
                            // Notificar a hijo3
                            await enviarMensaje('hijo3', 'cargarVideo', {
                                tipo: 'tramo',
                                ...datos.punto,
                                origen: 'padre',
                                timestamp: Date.now()
                            });
                            // Notificar a hijo4
                            await enviarMensaje('hijo4', 'ocultarReto', {
                                tipo: 'tramo',
                                ...datos.punto,
                                origen: 'padre',
                                timestamp: Date.now()
                            });
                        }
                        break;
                        
                    case 'cambioTramo':
                        await manejarCambioTramo(datos);
                        // Forward to other children
                        if (datos.tramo) {
                            await enviarMensaje('hijo2', 'cambioPunto', {
                                tipo: 'tramo',
                                id: datos.tramo.id,
                                numero: datos.tramo.numero,
                                nombre: datos.tramo.nombre,
                                origen: 'hijo5-casa',
                                timestamp: datos.timestamp || Date.now()
                            });
                            
                            await enviarMensaje('hijo3', 'cargarVideo', {
                                tipo: 'tramo',
                                id: datos.tramo.id,
                                numero: datos.tramo.numero,
                                nombre: datos.tramo.nombre,
                                origen: 'hijo5-casa',
                                timestamp: datos.timestamp || Date.now()
                            });
                            
                            await enviarMensaje('hijo4', 'ocultarReto', {
                                origen: 'hijo5-casa',
                                timestamp: datos.timestamp || Date.now()
                            });
                        }
                        break;
                        
                    case 'actualizarPuntoActual':
                        // Handle the update point message
                        if (datos.puntoActual) {
                            const { tipo, id, numero, nombre } = datos.puntoActual;
                            await actualizarEstadoPuntoActual(tipo, id, numero, nombre);
                            await sincronizarEstadoConHijos();
                        }
                        break;
                        
                    case 'solicitarEstado':
                        await enviarEstadoHijo5();
                        break;
                        
                    case 'reiniciarRuta':
                        await manejarReinicioRuta(datos);
                        break;
                        
                    case 'sincronizarEstado':
                    case 'hijo5Ready':
                    case 'casa-hijo-listo':
                        await enviarEstadoHijo5();
                        break;
                        
                    case 'error':
                        await manejarErrorHijo5(datos);
                        break;
                        
                    case 'expandirIframe':
                        await manejarExpansionIframe(datos);
                        break;
                        
                    default:
                        console.warn(`${logPrefix} Tipo de mensaje no reconocido:`, tipo);
                }
                
                // Confirmar recepci√≥n del mensaje si tiene un ID
                if (event?.data?.id) {
                    await enviarMensaje('hijo5-casa', 'confirmacionRecepcion', {
                        idMensajeOriginal: event.data.id,
                        timestamp: Date.now(),
                        estado: 'procesado',
                        tipo: tipo
                    });
                }
            } catch (error) {
                console.error(`${logPrefix} Error al procesar mensaje:`, error);
                
                // Notificar al hijo5 sobre el error
                try {
                    await enviarMensaje('hijo5-casa', 'error', {
                        codigo: 'ERROR_PROCESAMIENTO',
                        mensaje: error.message || 'Error al procesar el mensaje',
                        stack: process.env.NODE_ENV === 'development' ? error.stack : undefined,
                        timestamp: Date.now(),
                        tipoMensajeOriginal: tipo
                    });
                } catch (e) {
                    console.error(`${logPrefix} Error al notificar error al hijo5-casa:`, e);
                }
            }
        }

        /**
         * Actualiza el estado del punto actual
         * @param {string} tipo - Tipo de punto ('parada' o 'tramo')
         * @param {string} id - ID del punto (ej: 'P-1', 'TR-1')
         * @param {number} numero - N√∫mero del punto
         * @param {string} nombre - Nombre del punto
         * @returns {Promise<void>}
         */
        async function actualizarEstadoPuntoActual(tipo, id, numero, nombre) {
            if (tipo === 'parada') {
                window.paradaActual = numero;
                window.tramoActual = -1;
            } else if (tipo === 'tramo') {
                window.tramoActual = numero;
                window.paradaActual = -1;
            }
            
            console.log(`üîÑ Punto actual actualizado: ${tipo} ${numero} - ${nombre}`);
            
            // Actualizar la interfaz si es necesario
            // ... (agregar l√≥gica de actualizaci√≥n de UI si es necesario)
        }
        
        /**
         * Sincroniza el estado con todos los hijos
         * @returns {Promise<void>}
         */
        async function sincronizarEstadoConHijos() {
            // Get current state
            const puntoActual = window.paradaActual !== -1 
                ? { 
                    tipo: 'parada', 
                    id: `P-${window.paradaActual}`, 
                    numero: window.paradaActual,
                    nombre: `Parada ${window.paradaActual}` // Ajustar seg√∫n tu estructura de datos
                }
                : { 
                    tipo: 'tramo', 
                    id: `TR-${window.tramoActual}`, 
                    numero: window.tramoActual,
                    nombre: `Tramo ${window.tramoActual}` // Ajustar seg√∫n tu estructura de datos
                };
            
            // Send to all children
            const timestamp = Date.now();
            const estado = {
                puntoActual,
                modo: window.modoActual || 'aventura',
                timestamp
            };
            
            await Promise.all([
                enviarMensaje('hijo2', 'sincronizarEstado', estado),
                enviarMensaje('hijo3', 'sincronizarEstado', estado),
                enviarMensaje('hijo4', 'sincronizarEstado', estado),
                enviarMensaje('hijo5-casa', 'sincronizarEstado', estado)
            ]);
            
            console.log('üîÑ Estado sincronizado con todos los hijos:', estado);
        }
        
        /**
         * Maneja la inicializaci√≥n del hijo5-casa
         * @param {Object} datos - Datos de inicializaci√≥n
         * @returns {Promise<void>}
         */
        async function manejarInicializacionHijo5(datos) {
            console.log('üè† PADRE: Hijo5-casa inicializado:', datos);
            
            // Actualizar estado global con la informaci√≥n de inicializaci√≥n
            const modo = datos.modo || 'aventura';
            window.modoActual = modo;
            
            await actualizarEstadoGlobal({
                controlesHabilitados: datos.controlesHabilitados !== false, // Por defecto true si no se especifica
                modo: modo,
                ultimaAccion: 'inicializacion_hijo5',
                timestamp: Date.now()
            });
            
            // Enviar estado actual al hijo5
            await enviarEstadoHijo5();
        }

        /**
         * Maneja la actualizaci√≥n de estado desde el hijo5-casa
         * @param {Object} datos - Datos de estado actualizados
         * @returns {Promise<void>}
         */
        async function manejarActualizacionEstadoHijo5(datos) {
            const logPrefix = 'üè† PADRE: Actualizaci√≥n de estado desde hijo5-casa:';
            console.log(logPrefix, datos);
            
            // Actualizar estado seg√∫n el tipo de actualizaci√≥n
            const actualizaciones = {
                ultimaActualizacion: Date.now(),
                origen: 'hijo5-casa'
            };
            
            if (datos.tipo === 'estado_gps') {
                actualizaciones.gpsOn = datos.gpsOn !== false; // Por defecto true si no se especifica
                actualizaciones.modo = datos.modo || 'aventura';
                
                // Actualizar la interfaz seg√∫n el modo
                actualizarInterfazModo(actualizaciones.modo);
                
                // Si se desactiva el GPS, mostrar la ventana de paradas
                if (!actualizaciones.gpsOn) {
                    const iframeHijo5 = document.getElementById('hijo5-casa');
                    const paradasWindow = iframeHijo5?.contentWindow?.document?.getElementById('paradas-window');
                    if (paradasWindow) {
                        paradasWindow.style.display = 'flex';
                    }
                }
            } else if (datos.paradaActual !== undefined) {
                actualizaciones.paradaActual = datos.paradaActual;
            } else if (datos.tramoActual !== undefined) {
                actualizaciones.tramoActual = datos.tramoActual;
            }
            
            // Aplicar actualizaciones al estado global
            await actualizarEstadoGlobal(actualizaciones);
        }

        /**
         * Maneja la configuraci√≥n del sistema
         * @param {Object} datos - Datos de configuraci√≥n
         * @returns {Promise<void>}
         */
        async function manejarConfiguracionSistema(datos) {
            if (datos.tipo === 'cambio_modo') {
                console.log('üè† PADRE: Solicitud de cambio de modo desde hijo5-casa:', datos);
                await manejarCambioModo(datos.modo, datos.habilitar);
            } else if (datos.tipo === 'actualizar_paradas') {
                console.log('üè† PADRE: Actualizando lista de paradas desde hijo5-casa');
                // Aqu√≠ puedes implementar la l√≥gica para actualizar la lista de paradas
                // Por ejemplo, recargar los datos de la ruta o sincronizar con el servidor
            }
        }

        /**
         * Maneja el cambio de modo desde el hijo5-casa
         * @param {Object} datos - Datos del cambio de modo
         * @returns {Promise<void>}
         */
        async function manejarCambioModoHijo5(datos) {
            console.log(`üè† PADRE: Cambio de modo solicitado: ${datos.modo}`, datos);
            
            // Validar el modo
            const modoValido = ['casa', 'aventura'].includes(datos.modo);
            if (!modoValido) {
                throw new Error(`Modo no v√°lido: ${datos.modo}`);
            }
            
            // Actualizar estado global
            await actualizarEstadoGlobal({
                modo: datos.modo,
                origen: 'hijo5-casa',
                ultimaAccion: 'cambio_modo',
                timestamp: Date.now()
            });
            
            // Notificar a todos los iframes sobre el cambio de modo
            const iframes = ['hijo2', 'hijo3', 'hijo4', 'hijo5-casa'];
            const notificaciones = iframes.map(async (id) => {
                const targetIframe = document.getElementById(id);
                if (targetIframe?.contentWindow) {
                    try {
                        await enviarMensaje(id, 'cambioModo', {
                            modo: datos.modo,
                            origen: 'padre',
                            timestamp: Date.now()
                        });
                        console.log(`‚úÖ PADRE: Notificado cambio de modo a ${id}`);
                        return true;
                    } catch (error) {
                        console.error(`‚ùå PADRE: Error notificando a ${id}:`, error);
                        return false;
                    }
                }
                return false;
            });
            
            // Esperar a que se completen todas las notificaciones
            await Promise.all(notificaciones);
        }

        /**
         * Maneja el reinicio de la ruta
         * @param {Object} datos - Datos del reinicio
         * @returns {Promise<void>}
         */
        async function manejarReinicioRuta(datos = {}) {
            console.log('üîÑ PADRE: Reiniciando ruta...', datos);
            
            // Actualizar estado global
            await actualizarEstadoGlobal({
                paradaActual: 0,
                tramoActual: 0,
                ultimaAccion: 'reinicio_ruta',
                timestamp: Date.now(),
                origen: 'hijo5-casa',
                ...datos // Permitir sobrescribir propiedades espec√≠ficas
            });
            
            // Notificar a los iframes relevantes sobre el reinicio
            await Promise.all([
                enviarMensaje('hijo2', 'reiniciarRuta', { motivo: 'reinicio_solicitado' }),
                enviarMensaje('hijo3', 'detenerAudio', { motivo: 'reinicio_ruta' })
            ]);
            
            console.log('‚úÖ PADRE: Ruta reiniciada correctamente');
        }

        /**
         * Maneja los errores reportados por el hijo5-casa
         * @param {Object} datos - Datos del error
         * @returns {Promise<void>}
         */
        async function manejarErrorHijo5(datos) {
            const logPrefix = '‚ùå PADRE: Error en hijo5-casa:';
            const mensajeError = datos.mensaje || 'Error desconocido';
            const codigoError = datos.codigo || 'ERROR_DESCONOCIDO';
            
            console.error(`${logPrefix} ${codigoError}: ${mensajeError}`, datos);
            
            // Mostrar notificaci√≥n al usuario si es necesario
            if (window.mostrarMensajeInfoParada) {
                window.mostrarMensajeInfoParada(`Error en bot√≥n casa: ${mensajeError}`, true);
            }
            
            // Registrar el error en el estado global
            await actualizarEstadoGlobal({
                ultimoError: {
                    origen: 'hijo5-casa',
                    codigo: codigoError,
                    mensaje: mensajeError,
                    timestamp: Date.now(),
                    detalles: datos.detalles
                },
                timestamp: Date.now()
            });
            
            // Intentar recuperaci√≥n autom√°tica para ciertos errores
            if (codigoError === 'GPS_NO_DISPONIBLE') {
                console.log('‚ö†Ô∏è  Intentando recuperaci√≥n autom√°tica para error de GPS...');
                // Aqu√≠ podr√≠as implementar l√≥gica de recuperaci√≥n, como reintentar la operaci√≥n
            }
        }

        /**
         * Maneja la expansi√≥n del iframe hijo5-casa
         * @param {Object} datos - Datos de la expansi√≥n
         * @returns {Promise<void>}
         */
        async function manejarExpansionIframe(datos) {
            console.log(`üìè PADRE: Solicitando expansi√≥n del iframe a ${datos.width}`, datos);
            
            const iframe = document.getElementById('hijo5-casa');
            if (!iframe) {
                throw new Error('No se encontr√≥ el iframe hijo5-casa');
            }
            
            // Validar dimensiones
            const ancho = parseInt(datos.width, 10);
            const alto = parseInt(datos.height || '250', 10);
            
            if (isNaN(ancho) || ancho <= 0) {
                throw new Error(`Ancho no v√°lido: ${datos.width}`);
            }
            
            // Aplicar dimensiones
            iframe.style.width = `${ancho}px`;
            iframe.style.height = `${alto}px`;
            
            console.log(`‚úÖ PADRE: Iframe hijo5-casa ajustado a ${ancho}px x ${alto}px`);
            
            // Notificar al hijo5 que la expansi√≥n se ha completado
            await enviarMensaje('hijo5-casa', 'expansionCompletada', {
                ancho,
                alto,
                timestamp: Date.now()
            });
        }

        /**
         * Env√≠a el estado actual al hijo5-casa
         * @returns {Promise<void>}
         */
        async function enviarEstadoHijo5() {
            console.log('üîÑ PADRE: Sincronizando estado con hijo5-casa...');
            
            const iframeHijo5 = document.getElementById('hijo5-casa');
            if (!iframeHijo5?.contentWindow) {
                console.warn('No se puede sincronizar estado: iframe hijo5-casa no est√° disponible');
                return;
            }
            
            // Preparar estado actual
            const estadoActual = {
                modo: window.estadoGlobal?.modo || 'aventura',
                paradaActual: window.estadoGlobal?.paradaActual,
                tramoActual: window.estadoGlobal?.tramoActual,
                gpsOn: window.estadoGlobal?.gpsOn !== false, // Por defecto true
                controlesHabilitados: window.estadoGlobal?.controlesHabilitados !== false, // Por defecto true
                ultimaActualizacion: Date.now(),
                // Incluir cualquier otro estado relevante que necesite el hijo5
                ...(window.estadoGlobal?.rutaActual && { rutaActual: window.estadoGlobal.rutaActual }),
                ...(window.estadoGlobal?.paradas && { paradas: window.estadoGlobal.paradas }),
                ...(window.estadoGlobal?.tramos && { tramos: window.estadoGlobal.tramos })
            };
            
            // Enviar estado al hijo5
            await enviarMensaje('hijo5-casa', 'sincronizarEstado', {
                origen: 'padre',
                destino: 'hijo5-casa',
                mensaje: 'Estado sincronizado',
                timestamp: Date.now(),
                estado: estadoActual
            });
            
            console.log('‚úÖ PADRE: Estado sincronizado con hijo5-casa');
        }
        
        // Las funciones de inicializaci√≥n de hijo5 han sido eliminadas ya que ahora usamos mensajeria.js
        
        // Inicializar mensajer√≠a de forma as√≠ncrona
        async function inicializarMensajeriaHijo5() {
            try {
                mensajeria = await inicializarMensajeria({
                    iframeId: 'padre',
                    logLevel: LOG_LEVELS.DEBUG,
                    debug: true
                });
                
                // Configurar manejadores de mensajes
                configurarManejadorMensajes();
                return true;
            } catch (error) {
                console.error('Error al inicializar mensajer√≠a:', error);
                return false;
            }
        }
        
        // Inicializar la mensajer√≠a cuando el DOM est√© listo
        async function inicializarAplicacionHijo5() {
            try {
                // Inicializar mensajer√≠a si no est√° ya inicializada
                if (!window.Mensajeria) {
                    console.log('Inicializando mensajer√≠a...');
                    await inicializarMensajeria();
                }
                
                console.log('‚úÖ Mensajer√≠a inicializada correctamente');
                
                // Notificar a los hijos que la aplicaci√≥n est√° lista
                if (window.Mensajeria && window.Mensajeria.TIPOS_MENSAJE) {
                    enviarMensajeATodosLosHijos(window.Mensajeria.TIPOS_MENSAJE.INICIALIZACION, {
                        estado: 'listo',
                        modo: window.estadoGlobal?.modo || 'aventura',
                        timestamp: Date.now()
                    });
                } else {
                    console.warn('Mensajer√≠a no est√° disponible correctamente');
                }
            } catch (error) {
                console.error('‚ùå Error al inicializar la aplicaci√≥n:', error);
                // Intentar notificar al usuario de alguna manera
                alert('Error al inicializar la aplicaci√≥n. Por favor, recarga la p√°gina.');
            }
        }
        
        // Hacer que las funciones est√©n disponibles globalmente
        window.enableControls = enableControls;
        window.disableControls = disableControls;
        window.manejarCambioModo = manejarCambioModo;
        window.actualizarEstadoGlobal = actualizarEstadoGlobal;
        window.enviarMensaje = enviarMensaje;
        window.manejarMensajeHijo2 = manejarMensajeHijo2;
        window.manejarMensajeHijo3 = manejarMensajeHijo3;
        window.manejarMensajeHijo4 = manejarMensajeHijo4;
        window.manejarRetoCompletado = manejarRetoCompletado;
        window.avanzarSiguientePunto = avanzarSiguientePunto;
    
        // Inicializar la aplicaci√≥n
        inicializarAplicacionHijo5();
        
        // ================== MANEJADORES DE MENSAJES ==================
        
        /**
         * Maneja los mensajes de navegaci√≥n del hijo2
         * @param {Object} mensaje - Mensaje recibido
         */
        function manejarMensajeNavegacion(mensaje) {
            console.log('üì° Mensaje de navegaci√≥n recibido:', mensaje);
            // Aqu√≠ puedes manejar los mensajes de navegaci√≥n
            // Ejemplo: actualizar la posici√≥n en el mapa, mostrar indicaciones, etc.
        }
        
        /**
         * Maneja los mensajes de audio del hijo3
         * @param {Object} mensaje - Mensaje recibido
         */
        function manejarMensajeAudio(mensaje) {
            console.log('üîä Mensaje de audio recibido:', mensaje);
            // Aqu√≠ puedes manejar los mensajes de audio
            // Ejemplo: reproducir/pausar audio, ajustar volumen, etc.
        }
        
        /**
         * Maneja los mensajes de retos del hijo4
         * @param {Object} mensaje - Mensaje recibido
         */
        function manejarMensajeReto(mensaje) {
            console.log('üéØ Mensaje de reto recibido:', mensaje);
            // Aqu√≠ puedes manejar los mensajes de retos
            // Ejemplo: mostrar/ocultar interfaz de retos, verificar respuestas, etc.
        }
        
        /**
         * Maneja las confirmaciones de mensajes
         * @param {Object} mensaje - Mensaje de confirmaci√≥n
         */
        function manejarConfirmacion(mensaje) {
            console.log('‚úì Confirmaci√≥n recibida para mensaje:', mensaje.mensajeOriginalId);
            // Aqu√≠ puedes manejar las confirmaciones de mensajes enviados
        }
        
        // Hacer las funciones accesibles globalmente
        window.manejarMensajeNavegacion = manejarMensajeNavegacion;
        window.manejarMensajeAudio = manejarMensajeAudio;
        window.manejarMensajeReto = manejarMensajeReto;
        window.manejarConfirmacion = manejarConfirmacion;
    </script>
</body>
</html>
