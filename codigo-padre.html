<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aventura 1 - Padre</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüó∫Ô∏è%3C/text%3E%3C/svg%3E">

    <!-- Carga de Leaflet desde CDN con Integrity y Crossorigin -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <!-- Script para verificar que Leaflet est√° cargado -->
    <script>
        window.addEventListener('load', function() {
            if (typeof L === 'undefined') {
                console.error('‚ùå Leaflet no se ha cargado correctamente. L no est√° definido en window.');
            } else {
                console.log('‚úÖ Leaflet cargado correctamente:', L.version);
            }
        });
    </script>

    <style>
        /* Encapsular estilos globales */
        .padre-container html, .padre-container body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: transparent;
        }

        /* Estilos generales, mapa, debug, logo, iframes, etc. */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: transparent; }
        iframe { background: transparent; border: none; }
        /* PROBLEMA #1: Mejorar los estilos del mapa para asegurar visibilidad */
        #mapa { 
            position: fixed !important; 
            top: 0 !important; 
            left: 0 !important; 
            width: 100vw !important; 
            height: 100vh !important; 
            z-index: 10 !important;
            background-color: #f5f5f5 !important;
            border: 1px solid #ccc !important;
            visibility: visible !important;
            opacity: 1 !important;
            display: block !important;
            pointer-events: auto !important;
            overflow: visible !important;
        }
        /* Asegurar que los contenedores de Leaflet sean visibles */
        .leaflet-container {
            width: 100% !important;
            height: 100% !important;
            z-index: 10 !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            background: white !important;
        }
        .leaflet-tile-container {
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 200 !important;
        }
        .leaflet-tile {
            visibility: visible !important;
            opacity: 1 !important;
        }
        .leaflet-map-pane,
        .leaflet-overlay-pane,
        .leaflet-marker-pane,
        .leaflet-shadow-pane,
        .leaflet-tooltip-pane,
        .leaflet-popup-pane {
            z-index: auto !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        #map-debug { position: fixed; top: 10px; left: 10px; background: rgba(255, 255, 255, 0.9); padding: 5px 8px; border-radius: 5px; z-index: 5000; font-size: 12px; font-family: monospace; display: none; transition: opacity 0.5s; }
        #logo-aventura { position: fixed; top: -27px; left: 50%; transform: translateX(-50%); width: 320px; height: 125px; z-index: 2999; object-fit: contain; }
        #fondo-blanco { position: fixed; top: -24px; left: 50%; transform: translateX(-50%); width: 400px; height: 100px; z-index: 2998; background: white; border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; }
        #info-parada { font-weight: bold; margin: 0; padding: 7px 12px; background-color: rgba(255, 255, 255, 0.9); border-radius: 7px; position: fixed; left: 50%; transform: translateX(-50%); z-index: 1201; display: none; color: #333; font-family: sans-serif; text-align: center; bottom: 325px; min-width: 220px; max-width: 90vw; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10); }
        #hijo4 { position: fixed; top: 10vh; left: 50%; width: 60vw; height: 40vh; transform: translateX(-50%); z-index: 2000; border: 2px solid red; background: transparent; pointer-events: auto; display: none; }
        #media-overlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.8); z-index: 4000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #media-container { max-width: 90%; max-height: 90%; display: flex; flex-direction: column; align-items: center; position: relative; }
        #close-media { position: absolute; top: 10px; right: 10px; background: #ff5252; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.2em; cursor: pointer; z-index: 4001; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #parada-video, #parada-imagen { max-width: 100%; max-height: calc(100vh - 80px); display: none; border-radius: 5px; }
        
        /* Estilos para waypoints y marcadores de ruta */
        .waypoint-marker {
            background-color: #ff8c00;
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .waypoint-number {
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
        }
        
        .marker-letter {
            background: #ff4500;
            color: white;
            font-weight: bold;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .inicio-marker .marker-letter {
            background: #28a745;
        }
        
        .fin-marker .marker-letter {
            background: #dc3545;
        }
        
        /* Clases para animar la ruta actual */
        .ruta-activa {
            animation: pulse-route 2s infinite;
        }
        
        @keyframes pulse-route {
            0% { stroke-opacity: 0.7; }
            50% { stroke-opacity: 1; }
            100% { stroke-opacity: 0.7; }
        }

        #debug-overlay {
            display: none !important;
        }

        /* Estilos para el iframe hijo5-casa (bot√≥n casa) */
        #hijo5-casa {
            position: fixed;
            top: 80px;
            right: 0;
            width: 30px;
            height: 25px;
            border: 1px solid red;
            z-index: 10000;
            overflow: visible;
            background: rgba(255, 255, 255, 0.8);
            pointer-events: auto;
            margin: 0;
            padding: 0;
            border-radius: 4px;
        }
        #hijo5-casa * {
            pointer-events: auto;
        }

        /* Estilos para los marcadores de navegaci√≥n */
        .marcador-inicio {
            color: #4CAF50;
            font-size: 24px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        .marcador-destino {
            color: #F44336;
            font-size: 24px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        /* Estilo para la flecha de navegaci√≥n */
        .flecha-navegacion {
            color: #1E88E5;
            font-size: 24px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            transform-origin: center;
            transform: rotate(0deg);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        /* Estilos para los marcadores personalizados */
        .custom-marker {
            position: relative;
            width: 30px;
            height: 42px;
            text-align: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            line-height: 42px;
        }
        .marker-pin {
            position: absolute;
            width: 30px;
            height: 42px;
            background: #007bff;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            left: 0;
            top: 0;
            margin: -21px 0 0 -15px;
        }
        .green-pin .marker-pin {
            background: #28a745;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .green-pin::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            margin: 3px 0 0 3px;
            background: #fff;
            border-radius: 50%;
            opacity: 0.3;
        }

        /* Estilo para video e imagen */
        #media-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 4000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        #media-container {
            width: 70vw;
            height: 70vh;
            max-width: 70vw;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            padding: 15px;
        }
        #close-media {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 1.2em;
            cursor: pointer;
            z-index: 4001;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #parada-video, #parada-imagen {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            display: none;
            border-radius: 8px;
            object-fit: contain;
        }
    </style>

    <!-- Cargar m√≥dulos ES -->
    <script type="module">
    // 1. Importar m√≥dulos necesarios
    import { inicializarMensajeria, enviarMensaje, registrarControlador } from './js/mensajeria.js';
    import { TIPOS_MENSAJE } from './js/constants.js';
    import logger from './js/logger.js';
    
    // 2. Configuraci√≥n global de manejo de errores
    window.handleIframeError = function(iframeId, event) {
        const errorMsg = `Error loading ${iframeId}`;
        console.error(errorMsg, event);
        // Si el logger est√° disponible, usarlo tambi√©n
        if (window.logger?.error) {
            window.logger.error(errorMsg, event);
        }
    };
    
    window.handleIframeLoad = function(iframeId) {
        const msg = `${iframeId} loaded successfully`;
        console.debug(msg);
        if (window.logger?.debug) {
            window.logger.debug(msg);
        }
    }

    // 2. Funci√≥n de inicializaci√≥n as√≠ncrona
    async function initializeApp() {
        try {
            console.log('Iniciando aplicaci√≥n...');
            
            // Importar din√°micamente la aplicaci√≥n
            const { inicializar } = await import('./js/app.js');
            
            // Inicializar la aplicaci√≥n
            await inicializar();
            
            console.log('Aplicaci√≥n inicializada correctamente');
            
        } catch (error) {
            console.error('Error cr√≠tico al inicializar la aplicaci√≥n:', error);
            // Mostrar mensaje de error en la interfaz
            const errorDiv = document.createElement('div');
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '0';
            errorDiv.style.left = '0';
            errorDiv.style.right = '0';
            errorDiv.style.background = '#ffebee';
            errorDiv.style.color = '#c62828';
            errorDiv.style.padding = '1rem';
            errorDiv.style.zIndex = '9999';
            errorDiv.style.fontFamily = 'Arial, sans-serif';
            errorDiv.style.fontSize = '14px';
            errorDiv.style.whiteSpace = 'pre';
            errorDiv.style.overflow = 'auto';
            errorDiv.style.maxHeight = '50vh';
            errorDiv.textContent = `Error al inicializar la aplicaci√≥n:\n\n${error.message}\n\n${error.stack || ''}`;
            document.body.prepend(errorDiv);
        }
    }

    // 3. Inicializar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }
    </script>
</head>
<body>
    <!-- Map Container -->
    <div id="mapa" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0;">
        <!-- Map will be initialized here -->
    </div>
    
    <!-- Coordenadas iframe (hidden) -->
    <iframe id="coordenadas-iframe" 
            src="Av1-botones-coordenadas.html" 
            style="display: none;"
            title="Coordenadas">
    </iframe>
    
    <!-- Debug overlay -->
    <div id="debug-overlay" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; z-index: 10000; max-width: 300px; max-height: 80vh; overflow: auto; font-family: monospace; font-size: 12px;">
        <h3 style="margin: 0 0 10px 0;">Debug Info</h3>
        <div id="debug-content">Initializing...</div>
    </div>
    
    <script>
    // Debug logging function
    function debugLog(message, data) {
        const now = new Date().toISOString().substr(11, 12);
        const logLine = document.createElement('div');
        logLine.textContent = `[${now}] ${message}`;
        if (data) {
            try {
                logLine.textContent += ' ' + JSON.stringify(data);
            } catch (e) {
                logLine.textContent += ' [Object]';
            }
        }
        const debugContent = document.getElementById('debug-content');
        debugContent.prepend(logLine);
        console.log(`[DEBUG] ${message}`, data || '');
    }
    
    // Make it globally available
    window.debugLog = debugLog;
    
    // Log initial load
    debugLog('Parent page loading...');
    </script>
    
    <!-- PROBLEMA #2: Arreglar el script de inicializaci√≥n del mapa -->
    <script>
        // Crear el contenedor del mapa si no existe
        (function crearContenedorMapa() {
            console.log('Verificando existencia del contenedor del mapa...');
            let mapContainer = document.getElementById('mapa');
            
            if (!mapContainer) {
                console.log('Contenedor del mapa no encontrado, creando uno nuevo...');
                mapContainer = document.createElement('div');
                mapContainer.id = 'mapa';
                mapContainer.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    z-index: 10;
                    background-color: #f5f5f5;
                    border: 1px solid #ccc;
                `;
                document.body.appendChild(mapContainer);
            }
        })();
    </script>

    <!-- Contenedor del mapa -->
    <div id="mapa"></div>    <!-- Contenedor del mapa (ahora se crea din√°micamente) -->

    <!-- IFrames de los Hijos -->
    <iframe id="hijo2" src="./Av1-botones-coordenadas.html"
        style="position:fixed;
               bottom:150px;
               left:50%;
               transform:translateX(-50%);
               height:165px;
               width:310px;
               z-index:1001;
               border: none !important;
               background-color: transparent !important;
               overflow: hidden;
               pointer-events:auto;"
        allow="geolocation"
        frameborder="0"></iframe>

    <iframe id="hijo3" src="Av1_audio_esp.html" style="position: fixed; bottom: 2vh; left: 50%; transform: translateX(-50%); width: 320px; height: 140px; z-index: 1000; border: none; pointer-events: auto;"></iframe>
    
    <iframe id="hijo4" src="Av1-esp-retos-preguntas.html" style="display: none;"></iframe>

    <iframe id="hijo5-casa" src="Av1-boton-casa.html" 
        style="position: fixed; top: 15px; left: 10px; width: 410px; height: 60px; z-index: 99999; border: none; pointer-events: auto;">
    </iframe>

    <!-- A√±adir iframes para hamburguesa y opciones -->
    <iframe id="hijo1-hamburguesa" src="./botones-y-subfunciones-hamburguesa.html" 
        style="position:fixed; left:1vw; bottom:3vw; height:285px; width:61px; 
               z-index:1005; border: transparent; background:transparent; pointer-events:auto;">
    </iframe>
    <iframe id="hijo1-opciones" src="./botones-y-subfunciones-opciones.html" 
        style="position:fixed; right:1vw; bottom:3vw; height:285px; width:61px; 
               z-index:1005; border: transparent; background:transparent; pointer-events:auto;">
    </iframe>

    <div id="map-debug"></div>
    <div id="info-parada"></div>

    <!-- Overlay para Media -->
    <div id="media-overlay">
        <div id="media-container">
            <button id="close-media">&times;</button>
            <video id="parada-video" controls></video>
            <img id="parada-imagen" />
        </div>
    </div>

    <!-- Sistema de orquestaci√≥n entre componentes -->
    <script type="module">
    import { TIPOS_MENSAJE, MODOS } from './js/constants.js';
    import { inicializarMensajeria, registrarControlador, enviarMensaje } from './js/mensajeria.js';
    import { modoHandler } from './js/modo-handler.js';
    import { inicializarMapa, actualizarModoMapa, estadoMapa } from './js/funciones-mapa.js';
    import logger from './js/logger.js';
    
    // Inicializar el mapa cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Inicializar el mapa
            await inicializarMapa({
                containerId: 'mapa',
                center: [39.4699, -0.3763], // Coordenadas de Valencia
                zoom: 14,
                minZoom: 12,
                maxZoom: 18,
                zoomControl: true
            });
            
            // Actualizar el modo del mapa
            actualizarModoMapa('casa');
            
            // Notificar que el mapa est√° listo
            logger.info('Mapa inicializado correctamente');
            
            // Forzar una actualizaci√≥n del tama√±o del mapa
            if (window.mapa) {
                setTimeout(() => {
                    window.mapa.invalidateSize(true);
                    logger.info('Tama√±o del mapa actualizado forzosamente');
                }, 500);
            }
        } catch (error) {
            logger.error('Error al inicializar el mapa:', error);
        }
    });
    
    // Estado global de la orquestaci√≥n
    let estadoOrquestacion = {
        // modo ahora se maneja a trav√©s de modoHandler
        paradaActual: null,
        usuarioDistanciaParada: Infinity,
        audioReproduciendo: false,
        retoActivo: false,
        retoCompletado: false,
        botonGPSHabilitado: true
    };
    
    // Obtener el modo actual del manejador centralizado
    Object.defineProperty(estadoOrquestacion, 'modo', {
        get: function() {
            return modoHandler.obtenerModoActual();
        },
        set: function(nuevoModo) {
            modoHandler.cambiarModo(nuevoModo, 'PADRE');
        },
        enumerable: true,
        configurable: true
    });
    
    // Funci√≥n para avanzar a la siguiente parada/tramo
    async function avanzarASiguienteParada() {
        try {
            // L√≥gica para determinar la siguiente parada/tramo basado en la actual
            const siguienteParada = obtenerSiguienteParada(estadoOrquestacion.paradaActual);
            
            if (siguienteParada) {
                logger.info(`Avanzando a la siguiente parada: ${siguienteParada.id}`);
                
                // Notificar a todos los componentes del cambio
                await enviarMensaje('todos', TIPOS_MENSAJE.NAVEGACION.CAMBIO_PARADA, {
                    punto: { 
                        parada_id: siguienteParada.parada_id,
                        tramo_id: siguienteParada.tramo_id
                    }
                });
                
                // Actualizar estado
                estadoOrquestacion.paradaActual = siguienteParada;
                estadoOrquestacion.retoCompletado = false;
                estadoOrquestacion.retoActivo = false;
                estadoOrquestacion.audioReproduciendo = false;
            } else {
                logger.warn('No se encontr√≥ una siguiente parada');
            }
        } catch (error) {
            logger.error('Error al avanzar a la siguiente parada:', error);
        }
    }
    
    // Registrar manejadores para coordinar el flujo
    
    // Manejador para solicitudes de estado del mapa
    registrarControlador(TIPOS_MENSAJE.NAVEGACION.SOLICITAR_ESTADO_MAPA, (mensaje) => {
        try {
            if (window.mapa) {
                // Obtener el array de paradas y tramos del script en la p√°gina
                const paradasTramos = window.AVENTURA_PARADAS || [];
                
                // Enviar los datos de paradas junto con el estado del mapa
                enviarMensaje(mensaje.origen, TIPOS_MENSAJE.NAVEGACION.ESTADO_MAPA, {
                    centro: window.mapa.getCenter(),
                    zoom: window.mapa.getZoom(),
                    modo: modoHandler.obtenerModoActual(),
                    estado: estadoMapa,
                    paradasTramos: paradasTramos  // Incluir el array de paradas y tramos
                });
                
                logger.debug(`Estado del mapa y datos de paradas enviados a ${mensaje.origen}`, { 
                    totalParadasTramos: paradasTramos.length 
                });
            } else {
                logger.warn('Se solicit√≥ el estado del mapa pero el mapa no est√° inicializado');
            }
        } catch (error) {
            logger.error('Error al enviar el estado del mapa:', error);
            // Intentar enviar un mensaje de error
            try {
                enviarMensaje(mensaje.origen, TIPOS_MENSAJE.SISTEMA.ERROR, {
                    mensaje: 'Error al obtener el estado del mapa',
                    error: error.message
                });
            } catch (e) {
                console.error('Error al enviar mensaje de error:', e);
            }
        }
    });
    
    // 1. Manejador para actualizaciones de posici√≥n del usuario
    registrarControlador(TIPOS_MENSAJE.NAVEGACION.ACTUALIZAR_POSICION, async (mensaje) => {
        const { coordenadas } = mensaje.datos || {};
        if (!coordenadas) return;
        
        // Calcular distancia a la parada actual
        if (estadoOrquestacion.paradaActual && estadoOrquestacion.paradaActual.coordenadas) {
            const distancia = calcularDistancia(
                coordenadas,
                estadoOrquestacion.paradaActual.coordenadas
            );
            
            estadoOrquestacion.usuarioDistanciaParada = distancia;
            
            // Actualizar habilitaci√≥n de botones seg√∫n la distancia
            actualizarHabilitacionBotones(distancia);
        }
    });
    
    // 2. Manejador para finalizaci√≥n de audio
    registrarControlador(TIPOS_MENSAJE.AUDIO.FIN_REPRODUCCION, async (mensaje) => {
        logger.info('Audio finalizado:', mensaje.datos?.audioId);
        
        estadoOrquestacion.audioReproduciendo = false;
        
        // Verificar si hay un reto asociado a esta parada
        const retoAsociado = obtenerRetoAsociadoAParada(estadoOrquestacion.paradaActual);
        
        if (retoAsociado) {
            // Si hay reto: Primero mostrar el reto, los botones se habilitar√°n despu√©s
            await enviarMensaje('hijo4', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                origen: 'padre',
                timestamp: new Date().toISOString()
            });
            
            await enviarMensaje('hijo4', TIPOS_MENSAJE.RETO.MOSTRAR, {
                reto: retoAsociado,
                parada: estadoOrquestacion.paradaActual
            });
            
            estadoOrquestacion.retoActivo = true;
            
        } else {
            // Si NO hay reto: Habilitar todos los botones inmediatamente
            await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                boton: 'gps',
                origen: 'padre'
            });
            
            await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                boton: 'imagen',
                origen: 'padre'
            });
            
            // Si es un tramo, habilitar tambi√©n el bot√≥n de v√≠deo
            if (estadoOrquestacion.paradaActual && estadoOrquestacion.paradaActual.tramo_id) {
                await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                    boton: 'video',
                    origen: 'padre'
                });
            }
            
            estadoOrquestacion.botonGPSHabilitado = true;
            logger.info('No hay reto asociado, botones habilitados directamente');
        }
        
        // El audio siempre puede reproducirse de nuevo mientras el usuario est√© en la parada/tramo
        await enviarMensaje('hijo3', TIPOS_MENSAJE.CONTROL.HABILITAR, {
            origen: 'padre'
        });
    });
    
    // 3. Manejador para reto completado
    registrarControlador(TIPOS_MENSAJE.RETO.COMPLETADO, async (mensaje) => {
        logger.info('Reto completado:', mensaje.datos);
        
        estadoOrquestacion.retoCompletado = true;
        estadoOrquestacion.retoActivo = false;
        
        // Habilitar TODOS los botones despu√©s de completar el reto
        await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.HABILITAR, {
            boton: 'gps',
            origen: 'padre'
        });
        
        await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.HABILITAR, {
            boton: 'imagen',
            origen: 'padre'
        });
        
        // Si es un tramo, habilitar tambi√©n el bot√≥n de v√≠deo
        if (estadoOrquestacion.paradaActual && estadoOrquestacion.paradaActual.tramo_id) {
            await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                boton: 'video',
                origen: 'padre'
            });
        }
        
        estadoOrquestacion.botonGPSHabilitado = true;
        
        // Avanzar a la siguiente parada
        await avanzarASiguienteParada();
    });
    
    // 4. Manejador para inicio de reproducci√≥n de audio
    registrarControlador(TIPOS_MENSAJE.AUDIO.REPRODUCIR, async (mensaje) => {
        logger.info('Audio iniciado:', mensaje.datos);
        
        estadoOrquestacion.audioReproduciendo = true;
        
        // Deshabilitar bot√≥n GPS durante la reproducci√≥n del audio
        await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.DESHABILITAR, {
            boton: 'gps',
            origen: 'padre'
        });
        
        estadoOrquestacion.botonGPSHabilitado = false;
    });
    
    // Funci√≥n para actualizar la habilitaci√≥n de botones seg√∫n la distancia
    async function actualizarHabilitacionBotones(distancia) {
        try {
            // Si estamos en modo casa, asegurar que los botones audio y retos est√©n siempre habilitados
            if (estadoOrquestacion.modo === 'casa') {
                // Habilitar botones de audio y retos en modo casa
                await enviarMensaje('hijo3', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                    origen: 'padre'
                });
                await enviarMensaje('hijo4', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                    origen: 'padre'
                });
                return; // No seguir con la l√≥gica basada en distancia en modo casa
            }

            // Si est√° activo un reto, no modificar estado del bot√≥n GPS
            if (estadoOrquestacion.retoActivo) {
                logger.debug('Hay un reto activo, no se actualiza estado del bot√≥n GPS');
                return;
            }
            
            if (distancia <= 10) {
                // A menos de 10m: Deshabilitar bot√≥n de imagen
                await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.DESHABILITAR, {
                    boton: 'imagen',
                    origen: 'padre'
                });
                
                // El audio siempre est√° disponible cuando est√° cerca
                await enviarMensaje('hijo3', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                    origen: 'padre'
                });
            } else if (distancia > 10 && distancia <= 60) {
                // Entre 10-60m: Habilitar GPS e imagen
                // Solo habilitar GPS si no est√° reproduciendo audio
                if (!estadoOrquestacion.audioReproduciendo) {
                    await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                        boton: 'gps',
                        origen: 'padre'
                    });
                    estadoOrquestacion.botonGPSHabilitado = true;
                }
                
                await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                    boton: 'imagen',
                    origen: 'padre'
                });
                
                // Habilitar audio tambi√©n
                await enviarMensaje('hijo3', TIPOS_MENSAJE.CONTROL.HABILITAR, {
                    origen: 'padre'
                });
            } else {
                // A m√°s de 60m: Deshabilitar GPS
                await enviarMensaje('hijo2', TIPOS_MENSAJE.CONTROL.DESHABILITAR, {
                    boton: 'gps',
                    origen: 'padre'
                });
                
                estadoOrquestacion.botonGPSHabilitado = false;
            }
        } catch (error) {
            logger.error('Error al actualizar habilitaci√≥n de botones:', error);
        }
    }
    
    // Funciones auxiliares
    function calcularDistancia(coord1, coord2) {
        const R = 6371e3; // Radio de la Tierra en metros
        const œÜ1 = coord1.lat * Math.PI/180;
        const œÜ2 = coord2.lat * Math.PI/180;
        const ŒîœÜ = (coord2.lat - coord1.lat) * Math.PI/180;
        const ŒîŒª = (coord2.lng - coord1.lng) * Math.PI/180;

        const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

        return R * c; // Distancia en metros
    }
    
    function obtenerSiguienteParada(paradaActual) {
        // Implementaci√≥n real buscar√≠a en el array de paradas
        // Simulaci√≥n simple para el ejemplo
        return { id: 'siguiente-parada', parada_id: 'P-' + (parseInt(paradaActual?.id?.split('-')[1] || '0') + 1) };
    }
    
    function obtenerRetoAsociadoAParada(parada) {
        // Verificar si tenemos un punto v√°lido
        if (!parada) return null;
        
        // Obtener el ID normalizado para buscar (parada_id o tramo_id)
        const idBusqueda = parada.parada_id || parada.tramo_id || parada.id || '';
        
        // Lista simple de puntos con retos asociados (tanto paradas como tramos)
        const puntosConReto = ['P-1', 'P-3', 'P-5', 'P-7', 'P-9', 'P-12', 'P-15'];
        
        // Verificar si este punto tiene reto
        if (puntosConReto.includes(idBusqueda)) {
            return {
                id: 'reto-' + idBusqueda.split('-')[1],
                titulo: `Reto del punto ${idBusqueda}`,
                tipo: 'pregunta',
                datos: {
                    pregunta: '¬øCu√°l es el elemento principal que se observa en este punto?',
                    opciones: ['Fuente', 'Estatua', 'Edificio', 'Puerta'],
                    correcta: 2
                }
            };
        }
        
        return null; // Este punto no tiene reto asociado
    }
    
    // Inicializaci√≥n
    // Funci√≥n para solicitar las coordenadas al componente de coordenadas
    async function solicitarCoordenadas() {
        try {
            console.log('üì° Solicitando coordenadas al componente de coordenadas...');
            
            // Asegurarse de que el iframe est√© cargado
            const iframe = document.getElementById('coordenadas-iframe');
            if (!iframe) {
                throw new Error('No se encontr√≥ el iframe de coordenadas');
            }
            
            // Usar el ID correcto para el destino (el ID del iframe)
            await enviarMensaje('coordenadas-iframe', TIPOS_MENSAJE.NAVEGACION.SOLICITAR_ESTADO_MAPA, {});
        } catch (error) {
            console.error('‚ùå Error al solicitar coordenadas:', error);
        }
    }

    // Manejador para recibir el estado del mapa con las paradas
    function manejarEstadoMapa(mensaje) {
        try {
            const { paradas } = mensaje.datos;
            console.log('üìç Paradas recibidas:', paradas);
            
            // Actualizar el estado con las paradas recibidas
            if (paradas && paradas.length > 0) {
                // Aqu√≠ deber√≠as actualizar el estado de tu aplicaci√≥n con las paradas
                // Por ejemplo: estadoOrquestacion.paradas = paradas;
                console.log(`‚úÖ ${paradas.length} paradas cargadas correctamente`);
                
                // Si hay un mapa, actualizarlo con las nuevas paradas
                if (window.mostrarTodasLasParadas && typeof window.mostrarTodasLasParadas === 'function') {
                    window.mostrarTodasLasParadas(paradas);
                }
            } else {
                console.warn('‚ö†Ô∏è No se recibieron paradas v√°lidas');
            }
        } catch (error) {
            console.error('‚ùå Error al procesar el estado del mapa:', error);
        }
    }

    async function iniciarOrquestacion() {
        try {
            // Registrar manejador para el estado del mapa
            registrarControlador(TIPOS_MENSAJE.NAVEGACION.ESTADO_MAPA, manejarEstadoMapa);
            
            // Solicitar coordenadas al componente de coordenadas
            await solicitarCoordenadas();
            
            // Establecer la primera parada por defecto (P-0 Torres de Serranos)
            estadoOrquestacion.paradaActual = {
                id: 'P-0',
                parada_id: 'P-0',
                nombre: 'Torres de Serranos',
                coordenadas: {
                    lat: 39.47876,
                    lng: -0.37626
                }
            };
            
            logger.info('Orquestaci√≥n iniciada con parada inicial:', estadoOrquestacion.paradaActual);
        } catch (error) {
            logger.error('Error al iniciar orquestaci√≥n:', error);
        }
    }
    
    // Funci√≥n para cambiar el modo del iframe hijo5-casa
    async function cambiarModoHijo5Casa(nuevoModo) {
        try {
            logger.debug(`[PADRE] Solicitando cambio de modo a "${nuevoModo}" para hijo5-casa`);
            
            const iframe = document.getElementById('hijo5-casa');
            if (!iframe) {
                logger.warn('[PADRE] No se encontr√≥ el iframe hijo5-casa');
                return;
            }

            // Verificar que el modo sea v√°lido
            if (nuevoModo !== 'casa' && nuevoModo !== 'aventura') {
                logger.warn(`[PADRE] Intento de cambiar a modo no v√°lido: ${nuevoModo}`);
                return;
            }

            // Enviar mensaje al iframe para cambiar el modo
            await enviarMensaje('hijo5-casa', TIPOS_MENSAJE.CONTROL.CAMBIAR_MODO, { 
                modo: nuevoModo,
                origen: 'PADRE',
                timestamp: new Date().toISOString()
            });
            
            logger.info(`[PADRE] Modo cambiado a "${nuevoModo}" en hijo5-casa`);
        } catch (error) {
            logger.error('[PADRE] Error al cambiar el modo de hijo5-casa:', error);
            
            // Enviar mensaje de error al sistema
            enviarMensaje('todos', TIPOS_MENSAJE.SISTEMA.ERROR, {
                tipo: 'CAMBIO_MODO',
                error: error.message,
                stack: error.stack,
                origen: 'PADRE',
                timestamp: new Date().toISOString()
            });
        }
    }

    // Suscribir el manejador de cambios de modo
    modoHandler.suscribir('PADRE', (nuevoModo) => {
        logger.info(`[PADRE] Recibido cambio de modo a: ${nuevoModo}`);
        
        // Actualizar la interfaz del padre seg√∫n el modo
        try {
            // Aqu√≠ puedes a√±adir l√≥gica espec√≠fica para actualizar la interfaz del padre
            const body = document.body;
            if (nuevoModo === 'aventura') {
                body.classList.add('modo-aventura');
                body.classList.remove('modo-casa');
            } else {
                body.classList.add('modo-casa');
                body.classList.remove('modo-aventura');
            }
            
            // Actualizar el iframe hijo5-casa
            cambiarModoHijo5Casa(nuevoModo);
            
            logger.debug(`[PADRE] Interfaz actualizada para modo: ${nuevoModo}`);
        } catch (error) {
            logger.error('[PADRE] Error al actualizar la interfaz para el nuevo modo:', error);
        }
    });

    // Observa cambios en el estado de la orquestaci√≥n
    function observarEstadoOrquestacion() {
        return new Proxy(estadoOrquestacion, {
            set(target, prop, value) {
                const oldValue = target[prop];
                target[prop] = value;

                if (prop === 'modo' && value !== oldValue) {
                    // Usar el modoHandler para manejar el cambio de modo
                    modoHandler.cambiarModo(value, 'PADRE');
                }

                return true;
            }
        });

        return observer;
    }

    // Reemplazar el estado global con el proxy observado
    estadoOrquestacion = observarEstadoOrquestacion();

    // Iniciar la orquestaci√≥n cuando se cargue el DOM
    document.addEventListener('DOMContentLoaded', iniciarOrquestacion);
</script>

<!-- Logo de la aventura -->
<img id="logo-aventura" src="https://valenciavguides.github.io/Aventura-1-esp-padre-con-hijos/fotos_Av1/LOGO%20LETRAS%20FINAL%20transparente%20recorte.png" alt="Logo" style="position: fixed; top: -32px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 360px; height: 140px;" />

<!-- Funci√≥n para dibujar una flecha en la ruta -->
<script>
    function dibujarFlecha(latlng, angulo) {
        const iconoFlecha = L.divIcon({
            className: 'flecha-navegacion',
            html: '‚û§',
            iconSize: [24, 24],
            iconAnchor: [12, 12],
            popupAnchor: [0, -12]
        });
        const flecha = L.marker(latlng, {
            icon: iconoFlecha,
            rotationAngle: angulo,
            rotationOrigin: 'center',
            zIndexOffset: 1000
        });
        return flecha;
    }
</script>

<!-- Definici√≥n del array de paradas -->
<script type="module">
    // Definici√≥n del array de paradas y tramos
    const AVENTURA_PARADAS = [
        { padreid: "padre-P-0", tipo: "inicio", parada_id: 'P-0', audio_id: "audio-P-0", reto_id: "R-2" },
        { padreid: "padre-TR-1", tipo: "tramo", tramo_id: 'TR-1', audio_id: "audio-TR-1" },
        { padreid: "padre-P-1", tipo: "parada", parada_id: 'P-1', audio_id: "audio-P-1", reto_id: "R-3" },
        { padreid: "padre-TR-2", tipo: "tramo", tramo_id: 'TR-2', audio_id: "audio-TR-2" },
        { padreid: "padre-P-2", tipo: "parada", parada_id: 'P-2', audio_id: "audio-P-2", reto_id: "R-4" },
        { padreid: "padre-TR-3", tipo: "tramo", tramo_id: 'TR-3', audio_id: "audio-TR-3" },
        { padreid: "padre-P-3", tipo: "parada", parada_id: 'P-3', audio_id: "audio-P-3", reto_id: "R-5" },
        { padreid: "padre-TR-4", tipo: "tramo", tramo_id: 'TR-4', audio_id: "audio-TR-4" },
        { padreid: "padre-P-4", tipo: "parada", parada_id: 'P-4', audio_id: "audio-P-4", reto_id: "R-6" },
        { padreid: "padre-P-5", tipo: "parada", parada_id: 'P-5', audio_id: "audio-P-5", retos: [{ tipo: "reto", id: "R-7" }, { tipo: "puzzle", id: "PZ-8" }] },
        { padreid: "padre-TR-5", tipo: "tramo", tramo_id: 'TR-5', audio_id: "audio-TR-5" },
        { padreid: "padre-P-6", tipo: "parada", parada_id: 'P-6', audio_id: "audio-P-6", reto_id: "R-9" },
        { padreid: "padre-P-7", tipo: "parada", parada_id: 'P-7', audio_id: "audio-P-7", reto_id: "R-10" },
        { padreid: "padre-P-8", tipo: "parada", parada_id: 'P-8', audio_id: "audio-P-8", reto_id: "R-11" },
        { padreid: "padre-P-9", tipo: "parada", parada_id: 'P-9', audio_id: "audio-P-9" },
        { padreid: "padre-P-10", tipo: "parada", parada_id: 'P-10', audio_id: "audio-P-10", reto_id: "R-12" },
        { padreid: "padre-TR-6", tipo: "tramo", tramo_id: 'TR-6', audio_id: "audio-TR-6" },
        { padreid: "padre-P-11", tipo: "parada", parada_id: 'P-11', audio_id: "audio-P-11", reto_id: "R-13" },
        { padreid: "padre-P-12", tipo: "parada", parada_id: 'P-12', audio_id: "audio-P-12" },
        { padreid: "padre-P-13", tipo: "parada", parada_id: 'P-13', audio_id: "audio-P-13", reto_id: "R-14" },
        { padreid: "padre-TR-7", tipo: "tramo", tramo_id: 'TR-7', audio_id: "audio-TR-7" },
        { padreid: "padre-P-14", tipo: "parada", parada_id: 'P-14', audio_id: "audio-P-14", reto_id: "R-15" },
        { padreid: "padre-P-15", tipo: "parada", parada_id: 'P-15', audio_id: "audio-P-15" },
        { padreid: "padre-TR-8", tipo: "tramo", tramo_id: 'TR-8', audio_id: "audio-TR-8" },
        { padreid: "padre-P-16", tipo: "parada", parada_id: 'P-16', audio_id: "audio-P-16" },
        { padreid: "padre-TR-9", tipo: "tramo", tramo_id: 'TR-9', audio_id: "audio-TR-9" },
        { padreid: "padre-P-17", tipo: "parada", parada_id: 'P-17', audio_id: "audio-P-17", reto_id: "R-16" },
        { padreid: "padre-P-18", tipo: "parada", parada_id: 'P-18', audio_id: "audio-P-18" },
        { padreid: "padre-TR-10", tipo: "tramo", tramo_id: 'TR-10', audio_id: "audio-TR-10" },
        { padreid: "padre-P-19", tipo: "parada", parada_id: 'P-19', audio_id: "audio-P-19", retos: [{ tipo: "reto", id: "R-17" }, { tipo: "puzzle", id: "PZ-18" }] },
        { padreid: "padre-TR-11", tipo: "tramo", tramo_id: 'TR-11', audio_id: "audio-TR-11" },
        { padreid: "padre-TR-12", tipo: "tramo", tramo_id: 'TR-12', audio_id: "audio-TR-12" },
        { padreid: "padre-P-20", tipo: "parada", parada_id: 'P-20', audio_id: "audio-P-20", reto_id: "R-19" },
        { padreid: "padre-P-21", tipo: "parada", parada_id: 'P-21', audio_id: "audio-P-21" },
        { padreid: "padre-TR-13", tipo: "tramo", tramo_id: 'TR-13', audio_id: "audio-TR-13" },
        { padreid: "padre-P-22", tipo: "parada", parada_id: 'P-22', audio_id: "audio-P-22", retos: ["R-20", "R-21"] },
        { padreid: "padre-P-23", tipo: "parada", parada_id: 'P-23', audio_id: "audio-P-23", reto_id: "R-21" },
        { padreid: "padre-TR-14", tipo: "tramo", tramo_id: 'TR-14', audio_id: "audio-TR-14" },
        { padreid: "padre-P-24", tipo: "parada", parada_id: 'P-24', audio_id: "audio-P-24", reto_id: "R-22" },
        { padreid: "padre-TR-15", tipo: "tramo", tramo_id: 'TR-15', audio_id: "audio-TR-15" },
        { padreid: "padre-P-25", tipo: "parada", parada_id: 'P-25', audio_id: "audio-P-25" },
        { padreid: "padre-TR-16", tipo: "tramo", tramo_id: 'TR-16', audio_id: "audio-TR-16" },
        { padreid: "padre-P-26", tipo: "parada", parada_id: 'P-26', audio_id: "audio-P-26", reto_id: "R-23" },
        { padreid: "padre-TR-17", tipo: "tramo", tramo_id: 'TR-17', audio_id: "audio-TR-17" },
        { padreid: "padre-P-27", tipo: "parada", parada_id: 'P-27', audio_id: "audio-P-27", reto_id: "R-24" },
        { padreid: "padre-P-28", tipo: "parada", parada_id: 'P-28', audio_id: "audio-P-28", reto_id: "R-25" },
        { padreid: "padre-TR-18", tipo: "tramo", tramo_id: 'TR-18', audio_id: "audio-TR-18" },
        { padreid: "padre-P-29", tipo: "parada", parada_id: 'P-29', audio_id: "audio-P-29", reto_id: "R-27" },
        { padreid: "padre-P-30", tipo: "parada", parada_id: 'P-30', audio_id: "audio-P-30", reto_id: "R-28" },
        { padreid: "padre-TR-19", tipo: "tramo", tramo_id: 'TR-19', audio_id: "audio-TR-19" },
        { padreid: "padre-P-31", tipo: "parada", parada_id: 'P-31', audio_id: "audio-P-31", reto_id: "R-29" },
        { padreid: "padre-P-32", tipo: "parada", parada_id: 'P-32', audio_id: "audio-P-32", reto_id: "R-30" },
        { padreid: "padre-P-33", tipo: "parada", parada_id: 'P-33', audio_id: "audio-P-33", retos: [{ tipo: "reto", id: "R-31" }, { tipo: "puzzle", id: "PZ-26" }] },
        { padreid: "padre-TR-20", tipo: "tramo", tramo_id: 'TR-20', audio_id: "audio-TR-20" },
        { padreid: "padre-TR-21", tipo: "tramo", tramo_id: 'TR-21', audio_id: "audio-TR-21" },
        { padreid: "padre-P-34", tipo: "parada", parada_id: 'P-34', audio_id: "audio-P-34", reto_id: "R-32" },
        { padreid: "padre-TR-22", tipo: "tramo", tramo_id: 'TR-22', audio_id: "audio-TR-22" },
        { padreid: "padre-P-35", tipo: "parada", parada_id: 'P-35', audio_id: "audio-P-35" },
        { padreid: "padre-TR-23", tipo: "tramo", tramo_id: 'TR-23', audio_id: "audio-TR-23" },
        { padreid: "padre-P-36", tipo: "parada", parada_id: 'P-36', audio_id: "audio-P-36" }
    ];
</script>
</body>
</html>
