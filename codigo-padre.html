<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aventura 1 - Padre</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüó∫Ô∏è%3C/text%3E%3C/svg%3E">

    <!-- Carga de Leaflet desde CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Add warning suppression script early in the head -->
    <script src="js/suppress-warnings.js"></script>

    <style>
        /* Estilos generales, mapa, debug, logo, iframes, etc. */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: transparent; }
        iframe { background: transparent; border: none; }
        #mapa { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 3; background-color: #f5f5f5; }
        #map-debug { position: fixed; top: 10px; left: 10px; background: rgba(255, 255, 255, 0.9); padding: 5px 8px; border-radius: 5px; z-index: 5000; font-size: 12px; font-family: monospace; display: none; transition: opacity 0.5s; }
        
        /* Logo styling with exact positioning */
        #logo-aventura { position: fixed; top: -13px; left: 50%; transform: translateX(-50%); width: 190px; height: 140px; z-index: 3000; object-fit: contain; }
        #fondo-blanco { position: fixed; top: -24px; left: 50%; transform: translateX(-50%); width: 210px; height: 150px; z-index: 2999; background: white; border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; }
        
        #info-parada { font-weight: bold; margin: 0; padding: 7px 12px; background-color: rgba(255, 255, 255, 0.9); border-radius: 7px; position: fixed; left: 50%; transform: translateX(-50%); z-index: 1201; display: none; color: #333; font-family: sans-serif; text-align: center; bottom: 325px; min-width: 220px; max-width: 90vw; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10); }
        
        /* Shape styles for trapezoid iframes */
        .iframe-trapezoid {
            clip-path: polygon(0% 0%, 100% 0%, 95% 100%, 5% 100%);
        }
        
        .iframe-trapezoid-inverse {
            clip-path: polygon(5% 0%, 95% 0%, 100% 100%, 0% 100%);
        }
        
        /* Media overlay elements */
        #media-overlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.8); z-index: 4000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #media-container { max-width: 90%; max-height: 90%; display: flex; flex-direction: column; align-items: center; position: relative; }
        #close-media { position: absolute; top: 10px; right: 10px; background: #ff5252; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.2em; cursor: pointer; z-index: 4001; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #parada-video, #parada-imagen { max-width: 100%; max-height: calc(100vh - 80px); display: none; border-radius: 5px; }
        
        /* Hijo4 styling */
        #hijo4 { position: fixed; top: 10vh; left: 50%; width: 60vw; height: 40vh; transform: translateX(-50%); z-index: 2000; border: 2px solid red; background: transparent; pointer-events: auto; display: none; }

        /* Notification system styles */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 350px;
            width: 100%;
            pointer-events: none; /* Allow click through when no notification */
        }
        
        .notification {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease-in-out;
            opacity: 0;
            transform: translateX(30px);
            pointer-events: auto; /* Make notifications clickable */
            display: flex;
            align-items: flex-start;
            overflow: hidden;
            max-width: 100%;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification-icon {
            margin-right: 12px;
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .notification-content {
            flex-grow: 1;
            padding-right: 25px;
        }
        
        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .notification-message {
            font-size: 14px;
            line-height: 1.4;
            word-break: break-word;
        }
        
        .notification-close {
            position: absolute;
            top: 8px;
            right: 10px;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.6;
        }
        
        .notification-close:hover {
            opacity: 1;
        }
        
        .notification.info {
            border-left: 4px solid #2196F3;
        }
        
        .notification.success {
            border-left: 4px solid #4CAF50;
        }
        
        .notification.warning {
            border-left: 4px solid #FF9800;
        }
        
        .notification.error {
            border-left: 4px solid #F44336;
        }
        
        .notification-icon.info { color: #2196F3; }
        .notification-icon.success { color: #4CAF50; }
        .notification-icon.warning { color: #FF9800; }
        .notification-icon.error { color: #F44336; }
    </style>

    <!-- Create map container early with inline script -->
    <script>
        // Create map container if it doesn't exist when DOM starts parsing
        document.addEventListener('DOMContentLoaded', function() {
            // Check if container already exists
            if (!document.getElementById('mapa')) {
                console.log('Creating #mapa container during early DOM initialization');
                const mapContainer = document.createElement('div');
                mapContainer.id = 'mapa';
                mapContainer.setAttribute('data-created-by', 'early-initialization');
                mapContainer.style.cssText = 'width: 100%; height: 400px; position: relative; display: block !important; visibility: visible !important; opacity: 1 !important; z-index: 10; background-color: #f0f0f0;';
                
                // Insert at the beginning of container or body
                const container = document.querySelector('.container') || document.body;
                if (container && container.firstChild) {
                    container.insertBefore(mapContainer, container.firstChild);
                } else if (container) {
                    container.appendChild(mapContainer);
                } else {
                    document.body.appendChild(mapContainer);
                }
                console.log('#mapa container created successfully during early initialization');
            }
        }, { once: true });
    </script>
</head>
<body>
    <!-- Contenedores de la UI -->
    <div id="mapa"></div>
    <div id="map-debug"></div>
    <iframe id="fondo-blanco" tabindex="-1" aria-hidden="true"></iframe>
    <img id="logo-aventura" src="img/LOGO LETRAS FINAL transparente recorte.png" alt="Logo" />
    <div id="info-parada"></div>

    <!-- IFrames de los Hijos con posicionamiento preciso -->
    <iframe id="hijo1-hamburguesa" src="botones-y-subfunciones-hamburguesa.html"
        title="Men√∫ Hamburguesa"
        aria-label="Men√∫ de navegaci√≥n hamburguesa"
        style="position:fixed; left:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; pointer-events:auto;"
        onerror="handleIframeError('hijo1-hamburguesa', event)"></iframe>
    
    <iframe id="hijo1-opciones" src="botones-y-subfunciones-opciones.html"
        title="Opciones de usuario"
        aria-label="Opciones y configuraci√≥n"
        style="position:fixed; right:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; pointer-events:auto;"
        onerror="handleIframeError('hijo1-opciones', event)"></iframe>
    
    <iframe id="hijo5-casa" src="Av1-boton-casa.html"
        title="Bot√≥n Casa"
        aria-label="Bot√≥n para cambiar entre modo Casa y Aventura"
        style="position:fixed; left:10px; top:10px; height:350px; width:100px; z-index:1005; pointer-events:auto; transition:width 0.3s; display:block;"
        onload="handleIframeLoad('hijo5-casa')" onerror="handleIframeError('hijo5-casa', event)"></iframe>
    
    <!-- Trapezoid-shaped audio component -->
    <iframe id="hijo3" src="Av1_audio_esp.html"
        title="Audio de la aventura"
        aria-label="Reproductor de audio de la aventura con bot√≥n de retos"
        style="position:fixed; bottom:-6px; left:50%; transform:translateX(-50%); height:165px; width:310px; z-index:1000; display:block; pointer-events:auto;"
        class="iframe-trapezoid-inverse"
        onerror="handleIframeError('hijo3-audio', event)"></iframe>
    
    <!-- Inverse trapezoid-shaped coordinates component -->
    <iframe id="hijo2" src="Av1-botones-coordenadas.html"
        title="Botones de coordenadas"
        aria-label="Botones de navegaci√≥n y coordenadas"
        style="position:fixed; bottom:151px; left:50%; transform:translateX(-50%); height:165px; width:310px; z-index:1001; pointer-events:auto; display:block;"
        class="iframe-trapezoid"
        allow="geolocation" onerror="handleIframeError('hijo2-coordenadas', event)"></iframe>
    
    <!-- Retos iframe -->
    <iframe id="hijo4" src="Av1-esp-retos-preguntas.html"
        title="Retos y preguntas"
        aria-label="Ventana de retos y preguntas"
        style="display:none;" onload="handleIframeLoad('hijo4-retos')" onerror="handleIframeError('hijo4-retos', event)"></iframe>

    <!-- Overlay para Media -->
    <div id="media-overlay">
        <div id="media-container">
            <button id="close-media">X</button>
            <video id="parada-video" controls></video>
            <img id="parada-imagen">
        </div>
    </div>

    <!-- Error handling and map initialization -->
    <script>
        // Improved global map verification function with more robust error handling
        function verifyMapContainer() {
            try {
                let mapContainer = document.getElementById('mapa');
                if (!mapContainer) {
                    console.warn("Map container #mapa not found! Creating it...");
                    mapContainer = document.createElement('div');
                    mapContainer.id = 'mapa';
                    mapContainer.setAttribute('data-created-by', 'verify-function');
                    mapContainer.style.cssText = 'width: 100%; height: 400px; position: relative; display: block !important; visibility: visible !important; opacity: 1 !important; z-index: 10; background-color: #f0f0f0;';
                    
                    // Add it as the first child of container or body
                    const container = document.querySelector('.container');
                    if (container) {
                        container.insertBefore(mapContainer, container.firstChild);
                    } else {
                        document.body.insertBefore(mapContainer, document.body.firstChild);
                    }
                    console.log("Map container #mapa created by verify function");
                }
                
                // Ensure the container has proper styling even if it already existed
                if (mapContainer) {
                    // Force visibility with !important
                    mapContainer.style.display = 'block';
                    mapContainer.style.visibility = 'visible';
                    mapContainer.style.opacity = '1';
                    
                    if (mapContainer.offsetWidth === 0 || mapContainer.offsetHeight === 0) {
                        mapContainer.style.width = '100%';
                        mapContainer.style.height = '400px';
                        mapContainer.style.minHeight = '400px';
                        console.log("Fixed map container dimensions");
                    }
                }
                
                // Check container dimensions and report
                const width = mapContainer?.offsetWidth || 0;
                const height = mapContainer?.offsetHeight || 0;
                const display = mapContainer ? window.getComputedStyle(mapContainer).display : 'none';
                const visibility = mapContainer ? window.getComputedStyle(mapContainer).visibility : 'hidden';
                
                console.log("Map container verification:", {
                    exists: !!mapContainer,
                    id: mapContainer?.id,
                    width,
                    height,
                    display,
                    visibility,
                    createdBy: mapContainer?.getAttribute('data-created-by') || 'unknown'
                });
                
                return mapContainer;
            } catch (error) {
                console.error("Error in verifyMapContainer:", error);
                // Last resort recovery
                try {
                    const emergencyContainer = document.createElement('div');
                    emergencyContainer.id = 'mapa';
                    emergencyContainer.setAttribute('data-created-by', 'emergency-recovery');
                    emergencyContainer.style.cssText = 'width: 100%; height: 400px; position: relative; display: block !important; z-index: 9999; background: #eee;';
                    document.body.insertBefore(emergencyContainer, document.body.firstChild);
                    console.log("EMERGENCY: Created map container after error");
                    return emergencyContainer;
                } catch (e) {
                    console.error("Fatal error creating emergency map container:", e);
                    return null;
                }
            }
        }
        
        // Run verification after a short delay to ensure DOM is ready
        setTimeout(() => {
            const mapContainer = verifyMapContainer();
            if (mapContainer && mapContainer.exists) {
                console.log('‚úÖ Map container verified, dimensions:', 
                    { width: mapContainer.width, height: mapContainer.height });
            } else {
                console.error('‚ùå Map container not properly initialized');
                // Create a fallback container if needed
                if (!document.getElementById('mapa')) {
                    const newMap = document.createElement('div');
                    newMap.id = 'mapa';
                    newMap.style.width = '100%';
                    newMap.style.height = '400px';
                    newMap.style.position = 'relative';
                    document.body.prepend(newMap);
                    console.log('‚ûï Created fallback map container');
                }
            }
        }, 300);
        
        // Also verify before any map initialization
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM ready for map initialization');
            verifyMapContainer();
        });

        // Error handler for map initialization
        window.handleMapInitError = function(error) {
            console.error("‚ùå Error al inicializar mapa:", error);
            
            // Verify map container still exists
            verifyMapContainer();
            
            // Load emergency script
            console.log("üîÑ Cargando script de reparaci√≥n de emergencia...");
            
            const script = document.createElement('script');
            script.src = './js/fix-mapas-duplicados.js';
            script.onload = function() {
                console.log("‚úÖ Script de reparaci√≥n cargado correctamente");
                
                // Run the map repair
                if (typeof window.corregirMapasDuplicados === 'function') {
                    window.corregirMapasDuplicados()
                        .then(result => {
                            console.log("Resultado de la reparaci√≥n:", result ? "√âxito" : "Requiere m√°s acciones");
                            
                            // If repair failed or more actions are needed, initialize emergency map
                            if (!result && typeof window.initializeEmergencyMap === 'function') {
                                window.initializeEmergencyMap();
                            }
                        })
                        .catch(err => {
                            console.error("Error en la reparaci√≥n:", err);
                            // Try emergency map as last resort
                            if (typeof window.initializeEmergencyMap === 'function') {
                                window.initializeEmergencyMap();
                            }
                        });
                }
            };
            
            document.head.appendChild(script);
        };
        
        // Log when DOM is ready for map initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM ready for map initialization');
        });

        // Setup an interval to periodically check if the map container exists
        setInterval(function() {
            if (!document.getElementById('mapa')) {
                console.warn('Map container disappeared! Re-creating it...');
                verifyMapContainer();
            }
        }, 3000); // Check every 3 seconds
    </script>

    <!-- Main application initialization -->
    <script type="module">
        import { CONFIG } from './js/config.js';
        import { TIPOS_MENSAJE } from './js/constants.js';
        import { inicializarMensajeria, registrarControlador } from './js/mensajeria.js';
        import { inicializarMapa } from './js/funciones-mapa.js';
        import logger from './js/logger.js';
        
        // Define AVENTURA_PARADAS global array for all stops data
        const AVENTURA_PARADAS = [
            { padreid: "padre-P-0", tipo: "inicio", parada_id: 'P-0', audio_id: "audio-P-0", reto_id: "R-2" },
            { padreid: "padre-TR-1", tipo: "tramo", tramo_id: 'TR-1', audio_id: "audio-TR-1" },
            { padreid: "padre-P-1", tipo: "parada", parada_id: 'P-1', audio_id: "audio-P-1", reto_id: "R-3" },
            { padreid: "padre-TR-2", tipo: "tramo", tramo_id: 'TR-2', audio_id: "audio-TR-2" },
            { padreid: "padre-P-2", tipo: "parada", parada_id: 'P-2', audio_id: "audio-P-2", reto_id: "R-4" },
            { padreid: "padre-TR-3", tipo: "tramo", tramo_id: 'TR-3', audio_id: "audio-TR-3" },
            { padreid: "padre-P-3", tipo: "parada", parada_id: 'P-3', audio_id: "audio-P-3", reto_id: "R-5" },
            { padreid: "padre-TR-4", tipo: "tramo", tramo_id: 'TR-4', audio_id: "audio-TR-4" },
            { padreid: "padre-P-4", tipo: "parada", parada_id: 'P-4', audio_id: "audio-P-4", reto_id: "R-6" },
            { padreid: "padre-P-5", tipo: "parada", parada_id: 'P-5', audio_id: "audio-P-5", reto_id: "R-7" },
            { padreid: "padre-TR-5", tipo: "tramo", tramo_id: 'TR-5', audio_id: "audio-TR-5" },
            { padreid: "padre-P-6", tipo: "parada", parada_id: 'P-6', audio_id: "audio-P-6", reto_id: "R-8" },
            { padreid: "padre-P-7", tipo: "parada", parada_id: 'P-7', audio_id: "audio-P-7", reto_id: "R-9" },
            { padreid: "padre-P-8", tipo: "parada", parada_id: 'P-8', audio_id: "audio-P-8", reto_id: "R-10" },
            { padreid: "padre-P-9", tipo: "parada", parada_id: 'P-9', audio_id: "audio-P-9", reto_id: "R-11" },
            { padreid: "padre-P-10", tipo: "parada", parada_id: 'P-10', audio_id: "audio-P-10", reto_id: "R-12" },
            { padreid: "padre-TR-6", tipo: "tramo", tramo_id: 'TR-6', audio_id: "audio-TR-6" },
            { padreid: "padre-P-11", tipo: "parada", parada_id: 'P-11', audio_id: "audio-P-11", reto_id: "R-13" },
            { padreid: "padre-P-12", tipo: "parada", parada_id: 'P-12', audio_id: "audio-P-12", reto_id: "R-14" },
            { padreid: "padre-P-13", tipo: "parada", parada_id: 'P-13', audio_id: "audio-P-13", reto_id: "R-15" },
            { padreid: "padre-TR-7", tipo: "tramo", tramo_id: 'TR-7', audio_id: "audio-TR-7" },
            { padreid: "padre-P-14", tipo: "parada", parada_id: 'P-14', audio_id: "audio-P-14", reto_id: "R-16" },
            { padreid: "padre-P-15", tipo: "parada", parada_id: 'P-15', audio_id: "audio-P-15", reto_id: "R-17" },
            { padreid: "padre-TR-8", tipo: "tramo", tramo_id: 'TR-8', audio_id: "audio-TR-8" },
            { padreid: "padre-P-16", tipo: "parada", parada_id: 'P-16', audio_id: "audio-P-16", reto_id: "R-18" },
            { padreid: "padre-TR-9", tipo: "tramo", tramo_id: 'TR-9', audio_id: "audio-TR-9" },
            { padreid: "padre-P-17", tipo: "parada", parada_id: 'P-17', audio_id: "audio-P-17", reto_id: "R-19" },
            { padreid: "padre-P-18", tipo: "parada", parada_id: 'P-18', audio_id: "audio-P-18", reto_id: "R-20" },
            { padreid: "padre-TR-10", tipo: "tramo", tramo_id: 'TR-10', audio_id: "audio-TR-10" },
            { padreid: "padre-P-19", tipo: "parada", parada_id: 'P-19', audio_id: "audio-P-19", reto_id: "R-21" },
            { padreid: "padre-TR-11", tipo: "tramo", tramo_id: 'TR-11', audio_id: "audio-TR-11" },
            { padreid: "padre-TR-12", tipo: "tramo", tramo_id: 'TR-12', audio_id: "audio-TR-12" },
            { padreid: "padre-P-20", tipo: "parada", parada_id: 'P-20', audio_id: "audio-P-20", reto_id: "R-22" },
            { padreid: "padre-P-21", tipo: "parada", parada_id: 'P-21', audio_id: "audio-P-21", reto_id: "R-23" },
            { padreid: "padre-TR-13", tipo: "tramo", tramo_id: 'TR-13', audio_id: "audio-TR-13" },
            { padreid: "padre-P-22", tipo: "parada", parada_id: 'P-22', audio_id: "audio-P-22", reto_id: "R-24" },
            { padreid: "padre-P-23", tipo: "parada", parada_id: 'P-23', audio_id: "audio-P-23", reto_id: "R-25" },
            { padreid: "padre-TR-14", tipo: "tramo", tramo_id: 'TR-14', audio_id: "audio-TR-14" },
            { padreid: "padre-P-24", tipo: "parada", parada_id: 'P-24', audio_id: "audio-P-24", reto_id: "R-26" },
            { padreid: "padre-TR-15", tipo: "tramo", tramo_id: 'TR-15', audio_id: "audio-TR-15" },
            { padreid: "padre-P-25", tipo: "parada", parada_id: 'P-25', audio_id: "audio-P-25", reto_id: "R-27" },
            { padreid: "padre-TR-16", tipo: "tramo", tramo_id: 'TR-16', audio_id: "audio-TR-16" },
            { padreid: "padre-P-26", tipo: "parada", parada_id: 'P-26', audio_id: "audio-P-26", reto_id: "R-28" },
            { padreid: "padre-TR-17", tipo: "tramo", tramo_id: 'TR-17', audio_id: "audio-TR-17" },
            { padreid: "padre-P-27", tipo: "parada", parada_id: 'P-27', audio_id: "audio-P-27", reto_id: "R-29" },
            { padreid: "padre-TR-18", tipo: "tramo", tramo_id: 'TR-18', audio_id: "audio-TR-18" },
            { padreid: "padre-P-28", tipo: "parada", parada_id: 'P-28', audio_id: "audio-P-28", reto_id: "R-30" },
            { padreid: "padre-TR-19", tipo: "tramo", tramo_id: 'TR-19', audio_id: "audio-TR-19" },
            { padreid: "padre-P-29", tipo: "parada", parada_id: 'P-29', audio_id: "audio-P-29", reto_id: "R-31" },
            { padreid: "padre-TR-20", tipo: "tramo", tramo_id: 'TR-20', audio_id: "audio-TR-20" },
            { padreid: "padre-TR-21", tipo: "tramo", tramo_id: 'TR-21', audio_id: "audio-TR-21" },
            { padreid: "padre-P-30", tipo: "parada", parada_id: 'P-30', audio_id: "audio-P-30", reto_id: "R-32" },
            { padreid: "padre-TR-22", tipo: "tramo", tramo_id: 'TR-22', audio_id: "audio-TR-22" },
            { padreid: "padre-P-31", tipo: "parada", parada_id: 'P-31', audio_id: "audio-P-31", reto_id: "R-33" }
        ];
        
        // Make AVENTURA_PARADAS available globally
        window.AVENTURA_PARADAS = AVENTURA_PARADAS;

        /**
         * Handle requests for all paradas data
         * @param {Object} mensaje - The request message
         * @returns {Object} Response with paradas data
         */
        function handleAllParadasRequest(mensaje) {
            try {
                logger.info(`[padre] Received request for all paradas from ${mensaje.origen || 'unknown'}`);
                
                // Return the paradas data with the expected format
                return {
                    exito: true,
                    datos: AVENTURA_PARADAS,
                    total: AVENTURA_PARADAS.length,
                    timestamp: Date.now()
                };
            } catch (error) {
                logger.error(`[padre] Error handling paradas request:`, error);
                return {
                    exito: false,
                    error: error.message,
                    timestamp: Date.now()
                };
            }
        }
        
        /**
         * Handle component ready notifications
         * @param {Object} mensaje - The message with component data
         * @returns {Object} Response confirming receipt
         */
        function handleComponenteReady(mensaje) {
            try {
                logger.info(`[padre] Component ${mensaje.origen} is ready`);
                
                return {
                    exito: true,
                    mensaje: `Component ${mensaje.origen} registered successfully`,
                    timestamp: Date.now()
                };
            } catch (error) {
                logger.error(`[padre] Error handling component ready:`, error);
                return {
                    exito: false,
                    error: error.message,
                    timestamp: Date.now()
                };
            }
        }
        
        /**
         * Improved map initialization with better error handling
         */
        async function initializeMapWithRetry(maxRetries = 3) {
            let attempt = 0;
            let mapa = null;
            
            while (attempt < maxRetries && !mapa) {
                attempt++;
                logger.info(`üó∫Ô∏è Map initialization attempt ${attempt}/${maxRetries}`);
                
                try {
                    // Ensure map container exists
                    let mapContainer = document.getElementById('mapa');
                    if (!mapContainer) {
                        logger.warn("Map container missing! Creating one...");
                        mapContainer = document.createElement('div');
                        mapContainer.id = 'mapa';
                        mapContainer.style.cssText = 'width: 100%; height: 400px; position: relative; display: block !important;';
                        
                        const container = document.querySelector('.container');
                        if (container) {
                            container.insertBefore(mapContainer, container.firstChild);
                        } else {
                            document.body.insertBefore(mapContainer, document.body.firstChild);
                        }
                        
                        // Wait for DOM update
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    mapa = await inicializarMapa({
                        containerId: 'mapa',
                        center: CONFIG.MAPA.CENTER,
                        zoom: CONFIG.MAPA.ZOOM,
                        fallbackContainer: true,
                        forceVisibility: true
                    });
                    
                    if (mapa) {
                        logger.info("‚úÖ Map initialized successfully");
                        window.mapa = mapa;
                        return mapa;
                    }
                } catch (error) {
                    logger.error(`‚ùå Map initialization attempt ${attempt} failed:`, error);
                    
                    // If this is the last attempt, try emergency initialization
                    if (attempt >= maxRetries) {
                        logger.warn("Trying emergency map initialization...");
                        try {
                            if (typeof window.initializeEmergencyMap === 'function') {
                                mapa = await window.initializeEmergencyMap();
                                if (mapa) {
                                    logger.info("‚úÖ Emergency map initialization successful");
                                    window.mapa = mapa;
                                    return mapa;
                                }
                            }
                        } catch (emergencyError) {
                            logger.error("‚ùå Emergency map initialization failed:", emergencyError);
                        }
                    }
                    
                    // Wait before retry
                    await new Promise(resolve => setTimeout(resolve, 300 * attempt));
                }
            }
            
            throw new Error("Failed to initialize map after multiple attempts");
        }
        
        async function initializeApplication() {
            try {
                logger.info('üöÄ Inicializando componente padre...');
                
                // Initialize messaging system with proper error handling
                await inicializarMensajeria({ 
                    iframeId: 'padre', 
                    debug: true, 
                    logLevel: 0
                });
                
                // Register message handlers
                registrarControlador(TIPOS_MENSAJE.DATOS.SOLICITAR_PARADAS, handleAllParadasRequest);
                registrarControlador(TIPOS_MENSAJE.SISTEMA.COMPONENTE_LISTO, handleComponenteReady);
                registrarControlador(TIPOS_MENSAJE.SISTEMA.COMPONENTE_INICIALIZADO, handleComponenteReady);
                
                // Set up parada handlers
                await setupParadaHandlers();
                
                // Initialize map with retry
                let mapa;
                try {
                    mapa = await initializeMapWithRetry(3);
                    logger.info('‚úÖ Mapa inicializado correctamente');
                } catch (mapError) {
                    logger.error('‚ùå Error al inicializar mapa:', mapError);
                    
                    // Show error visually in the page
                    const errorContainer = document.createElement('div');
                    errorContainer.style.cssText = 'background-color: #f8d7da; color: #721c24; padding: 10px; margin: 10px 0; border-radius: 5px;';
                    errorContainer.innerHTML = `<strong>Error al inicializar el mapa:</strong> ${mapError.message}`;
                    document.body.insertBefore(errorContainer, document.body.firstChild);
                    
                    // Try to handle the error
                    window.handleMapInitError(mapError);
                }
                
                // Continue with other initialization...
                
            } catch (error) {
                logger.error('‚ùå Error en inicializaci√≥n:', error);
            }
        }

        // Ensure handlers are set up first, then initialize
        window.addEventListener('DOMContentLoaded', () => {
            // Register SOLICITAR_PARADAS handler immediately
            try {
                registrarControlador(TIPOS_MENSAJE.DATOS.SOLICITAR_PARADAS, handleAllParadasRequest);
                registrarControlador(TIPOS_MENSAJE.SISTEMA.COMPONENTE_LISTO, handleComponenteReady);
                registrarControlador(TIPOS_MENSAJE.SISTEMA.COMPONENTE_INICIALIZADO, handleComponenteReady);
                logger.info('‚úÖ Message handlers registered early');
            } catch (error) {
                logger.error('‚ùå Error registering early handlers:', error);
            }
            
            // Delay actual initialization to allow DOM to be fully ready
            setTimeout(initializeApplication, 100);
        });
    </script>

    <!-- Global iframe handling functions -->
    <script>
    // Global iframe handling functions
    window.handleIframeError = function(iframeId, event) {
        const errorMsg = `Error loading ${iframeId}`;
        console.error(errorMsg, event);
        // If logger is available, use it too
        if (window.logger?.error) {
            window.logger.error(errorMsg, event);
        }
    };
    
    window.handleIframeLoad = function(iframeId) {
        const msg = `${iframeId} loaded successfully`;
        console.debug(msg);
        if (window.logger?.debug) {
            window.logger.debug(msg);
        }
    };
    
    // Improved message handling system for parent component
    document.addEventListener('DOMContentLoaded', function() {
        // Import required modules for proper message handling
        Promise.all([
            import('./js/constants.js'),
            import('./js/mensajeria.js')
        ]).then(([constantsModule, mensajeriaModule]) => {
            const { TIPOS_MENSAJE } = constantsModule;
            const { enviarACK, inicializarMensajeria } = mensajeriaModule;
            
            console.log("Initializing parent component messaging system");
            
            // Initialize the messaging system for the parent
            inicializarMensajeria({ 
                iframeId: 'padre',
                debug: true 
            }).then(() => {
                console.log("Parent messaging system initialized");
                
                // Register proper message handlers that use the messaging system
                window.addEventListener('message', function(event) {
                    try {
                        const message = event.data;
                        
                        // Only process messages with valid structure
                        if (message && message.tipo && message.origen && message.mensajeId) {
                            console.log(`Parent received message: ${message.tipo} from ${message.origen}`);
                            
                            // Handle system messages from child components
                            if (message.tipo === TIPOS_MENSAJE.SISTEMA.COMPONENTE_INICIALIZADO || 
                                message.tipo === TIPOS_MENSAJE.SISTEMA.COMPONENTE_LISTO) {
                                
                                // Use the proper ACK function from mensajeria.js
                                enviarACK(message, {
                                    estado: 'recibido',
                                    timestamp: Date.now(),
                                    recibidoEn: 'padre'
                                }).then(() => {
                                    console.log(`Sent ACK for ${message.tipo} to ${message.origen}`);
                                }).catch(error => {
                                    console.error(`Error sending ACK to ${message.origen}:`, error);
                                });
                            }
                        }
                    } catch (error) {
                        console.error('Error handling message in parent:', error);
                    }
                });
                
                // Notify that the parent is ready to handle messages
                console.log("Parent component ready to handle messages");
            }).catch(error => {
                console.error("Error initializing parent messaging system:", error);
            });
        }).catch(error => {
            console.error("Error importing modules:", error);
        });
    });
    </script>

    <!-- Notification container - will be created dynamically if needed -->
    <div id="notification-container"></div>

    <script>
    // Global initialization state to prevent duplicate initialization
    window.mapInitialization = {
        started: false,
        completed: false,
        timestamp: null
    };
    
    // Unified map initialization function to prevent duplicates
    function initializeMap() {
        // Check if initialization has already started
        if (window.mapInitialization.started) {
            console.log('Map initialization already in progress, skipping duplicate call.');
            return Promise.resolve(window.mapa);
        }
        
        console.log('DOM ready for map initialization');
        window.mapInitialization.started = true;
        window.mapInitialization.timestamp = new Date().toISOString();
        
        // Check map container
        const mapContainer = document.getElementById('mapa');
        console.log('Map container verification:', {
            exists: !!mapContainer,
            id: mapContainer ? mapContainer.id : null,
            width: mapContainer ? mapContainer.offsetWidth : null,
            height: mapContainer ? mapContainer.offsetHeight : null,
            display: mapContainer ? window.getComputedStyle(mapContainer).display : null,
            visibility: mapContainer ? window.getComputedStyle(mapContainer).visibility : null,
            position: mapContainer ? window.getComputedStyle(mapContainer).position : null
        });
        
        // If container is not properly initialized or visible
        if (!mapContainer || mapContainer.offsetWidth === 0 || mapContainer.offsetHeight === 0) {
            console.error('‚ùå Map container not properly initialized');
            
            // Give more time before attempting initialization
            return new Promise(resolve => {
                setTimeout(async () => {
                    try {
                        // Try to initialize map with fix-mapas-duplicados
                        if (typeof window.initializeEmergencyMap === 'function') {
                            console.log('Attempting emergency map initialization');
                            const map = await window.initializeEmergencyMap();
                            window.mapInitialization.completed = true;
                            resolve(map);
                        } else {
                            console.error('Emergency map initialization function not available');
                            resolve(null);
                        }
                    } catch (error) {
                        console.error('Failed to initialize map:', error);
                        resolve(null);
                    }
                }, 200);
            });
        }
        
        // Import and use the proper initialization function
        return import('./js/funciones-mapa.js')
            .then(module => {
                if (typeof module.inicializarMapa === 'function') {
                    return module.inicializarMapa({
                        containerId: 'mapa',
                        forceVisibility: true,
                        fallbackContainer: true
                    });
                } else {
                    throw new Error('inicializarMapa function not found in module');
                }
            })
            .then(map => {
                console.log('‚úÖ Map successfully initialized');
                window.mapInitialization.completed = true;
                window.mapa = map;
                return map;
            })
            .catch(error => {
                console.error('‚ùå Error initializing map:', error);
                
                // Try emergency initialization as fallback
                if (typeof window.initializeEmergencyMap === 'function') {
                    console.log('Attempting emergency map initialization after error');
                    return window.initializeEmergencyMap();
                }
                throw error;
            });
    }
    
    // Single event listener for DOM ready with a clear role
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM ready - initializing application');
        
        // Ensure the map container exists
        let mapContainer = document.getElementById('mapa');
        if (!mapContainer) {
            console.warn('Map container not found, creating one');
            mapContainer = document.createElement('div');
            mapContainer.id = 'mapa';
            mapContainer.style.position = 'fixed';
            mapContainer.style.top = '0';
            mapContainer.style.left = '0';
            mapContainer.style.width = '100vw';
            mapContainer.style.height = '100vh';
            mapContainer.style.zIndex = '3';
            document.body.appendChild(mapContainer);
        }
        
        // Initialize map once
        initializeMap()
            .then(map => {
                if (map) {
                    console.log('Map initialization complete, setting up application');
                    // Any additional setup that depends on the map
                }
            })
            .catch(err => {
                console.error('Failed to initialize map:', err);
            });
            
        // Setup Parada handlers
        setupParadaHandlers();
    });
    </script>

    <!-- Add this function definition to your JavaScript section -->
    <script>
    /**
     * Sets up handlers for paradas/tramos interactions
     * This function was referenced but not defined, causing a ReferenceError
     */
    function setupParadaHandlers() {
        console.log('Setting up parada/tramo handlers...');
        
        try {
            // Set up click handlers for parada/tramo buttons that might be in the DOM
            document.querySelectorAll('.parada-btn, .tramo-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const tipo = this.classList.contains('parada-btn') ? 'parada' : 'tramo';
                    const id = this.dataset.id;
                    if (id) {
                        console.log(`${tipo.toUpperCase()} clicked: ${id}`);
                        // Any additional logic you want to perform can go here
                    }
                });
            });
            
            console.log('‚úÖ Parada/tramo handlers set up successfully');
            return true;
        } catch (error) {
            console.error('Error setting up parada handlers:', error);
            return false;
        }
    }
    </script>

    <!-- Verificar que el archivo exista en la ruta especificada -->
    <img src="./assets/images/logo.png" alt="Logo" onerror="console.error('Error: Imagen no encontrada')">
</body>
</html>
