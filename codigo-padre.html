<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Aventura 1 - Padre</title>
    
    <!-- Hojas de estilo -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tF/mi8yWeCOpaeEgUhyE=" 
          crossorigin=""/>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
            
    <!-- M√≥dulo de mensajer√≠a estandarizada -->
    <script src="js/mensajeria.js" type="module"></script>
    <style>
        /* Estilos base */
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        /* Contenedor del mapa */
        #mapa { 
            position: absolute; 
            top: 0; 
            left: 0; 
            right: 0;
            bottom: 0;
            width: 100%; 
            height: 100%; 
            z-index: 1;
            background: #f0f0f0;
        }
        
        /* Asegurar que el body no tenga m√°rgenes ni padding */
        body { 
            margin: 0; 
            padding: 0; 
            background: transparent;
            height: 100%;
            width: 100%;
            position: fixed;
            overflow: hidden;
        }
        
        /* Estilo para iframes */
        iframe { 
            background: transparent;
            border: none;
        }
        
        /* ================== VARIABLES Y ESTILO HIJO 4 (RETOS) ================== */
        :root {
            --iframe-hijo4-width: 90%;
            --iframe-hijo4-max-width: 600px;
            --iframe-hijo4-height: 70vh;
            --iframe-hijo4-top: 15vh;
            --iframe-hijo4-left: 50%;
            --iframe-hijo4-translate-x: -50%;
            --iframe-hijo4-z: 2000;
            --iframe-hijo4-bg: rgba(255, 255, 255, 0.95);
            --iframe-hijo4-border-radius: 15px;
            --iframe-hijo4-box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
        }
        #hijo4 {
            position: fixed;
            top: var(--iframe-hijo4-top);
            left: var(--iframe-hijo4-left);
            width: var(--iframe-hijo4-width);
            max-width: var(--iframe-hijo4-max-width);
            height: var(--iframe-hijo4-height);
            transform: translateX(var(--iframe-hijo4-translate-x));
            z-index: var(--iframe-hijo4-z);
            background: var(--iframe-hijo4-bg);
            border-radius: var(--iframe-hijo4-border-radius);
            box-shadow: var(--iframe-hijo4-box-shadow);
            border: none;
            pointer-events: auto;
            display: none;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* Estilos para el iframe hijo5-casa (bot√≥n casa) */
        #hijo5-casa {
            position: fixed;
            top: 80px; /* 80px desde el borde superior */
            right: 0; /* Sin margen derecho */
            width: 30px; /* Ancho m√≠nimo para el bot√≥n */
            height: 25px; /* Altura justa para el bot√≥n */
            border: 1px solid red; /* Marco rojo de 1px */
            z-index: 10000;
            overflow: visible; /* Permite que el contenido se muestre fuera del iframe */
            background: rgba(255, 255, 255, 0.8); /* Fondo blanco semitransparente */
            pointer-events: none; /* Deshabilitar eventos en el iframe */
            margin: 0; /* Sin m√°rgenes */
            padding: 0; /* Sin padding */
            border-radius: 4px; /* Bordes redondeados */
        }
        
        /* Permitir interacci√≥n con los elementos dentro del iframe */
        #hijo5-casa * {
            pointer-events: auto;
        }
        
        /* ESTILO ACTUALIZADO PARA info-parada */
        #info-parada {
            font-weight: bold;
            margin: 0;
            padding: 12px 20px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1201;
            display: none;
            color: #2c3e50;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            bottom: 340px;
            min-width: 250px;
            max-width: 90vw;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }
        
        /* Estilos para los marcadores de navegaci√≥n */
        .marcador-inicio {
            color: #4CAF50; /* Verde para el punto de inicio */
            font-size: 24px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        .marcador-destino {
            color: #F44336; /* Rojo para el destino */
            font-size: 24px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        /* Estilo para la flecha de navegaci√≥n */
        .flecha-navegacion {
            color: #1E88E5; /* Azul para la flecha */
            font-size: 24px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            transform-origin: center;
            transform: rotate(0deg);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        /* Estilos para los marcadores personalizados */
        .custom-marker {
            position: relative;
            width: 30px;
            height: 42px;
            text-align: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            line-height: 42px;
        }
        
        .marker-pin {
            position: absolute;
            width: 30px;
            height: 42px;
            background: #007bff;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            left: 0;
            top: 0;
            margin: -21px 0 0 -15px;
        }
        
        /* Estilos para el marcador verde */
        .green-pin .marker-pin {
            background: #28a745;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .green-pin::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            margin: 3px 0 0 3px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
            opacity: 0.3;
        }
        
        .marker-pin.start {
            background: #2ecc71;
        }
        
        .marker-pin.end {
            background: #3498db;
        }
        
        .custom-marker span {
            position: relative;
            top: -10px;
            left: 0;
            width: 100%;
            text-align: center;
            display: inline-block;
            transform: rotate(45deg);
        }
        #info-parada.error {
            background-color: #ffeaea;
            color: #b30000;
            border: 1.5px solid #b30000;
            animation: shake 0.3s;
        }
        @keyframes shake {
            0% { transform: translateX(-50%) translateY(0); }
            25% { transform: translateX(-50%) translateY(-3px); }
            50% { transform: translateX(-50%) translateY(3px); }
            75% { transform: translateX(-50%) translateY(-3px); }
            100% { transform: translateX(-50%) translateY(0); }
        }

        /* ================== ESTILO PARA VIDEO E IMAGEN ================== */
        #media-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 4000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        #media-container {
            width: 70vw; /* 70% del ancho de la ventana */
            height: 70vh; /* 70% de la altura de la ventana */
            max-width: 70vw;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            padding: 15px;
        }

        #close-media {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 1.2em;
            cursor: pointer;
            z-index: 4001;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #parada-video, #parada-imagen {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            display: none;
            border-radius: 8px;
            object-fit: contain; /* Mantiene proporci√≥n sin cortar */
        }
    </style>
</head>
<body>
    <!-- Contenedor del mapa -->
    <div id="mapa"></div>

    <img id="logo-aventura" src="https://valenciavguides.github.io/Aventura-1-esp-padre-con-hijos/fotos_Av1/LOGO%20LETRAS%20FINAL%20transparente%20recorte.png" alt="Logo" style="position: fixed; top: -32px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 360px; height: 140px;" />

    <div id="info-parada"></div>
    
    <!-- Fondo blanco para el logo con borde naranja -->
    <div style="position: fixed; top: 0; left: 0; right: 0; width: 99%; margin: 0 auto; height: 80px; background: white; z-index: 2999; border: 2px solid #ec7c26; border-top: none; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;"></div>

    <!-- Rutas actualizadas para GitHub Pages -->
    <iframe id="hijo1-hamburguesa" src="./botones-y-subfunciones-hamburguesa.html" style="position:fixed; left:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; border: transparent; background:transparent; pointer-events:auto;"></iframe>
    <iframe id="hijo1-opciones" src="./botones-y-subfunciones-opciones.html" style="position:fixed; right:1vw; bottom:0vw; height: 265px; width:57px; z-index:1005; border: transparent; background:transparent; pointer-events:auto;"></iframe>
    <iframe id="hijo5-casa" src="./Av1-boton-casa.html" style="position:fixed; right:0; top:70px; width:99%; height:85px; z-index:10000; border: 1px solid red; background:transparent; pointer-events:auto; margin:0; padding:0; overflow:hidden; border-radius:0;"></iframe>

    <iframe id="hijo3" src="./Av1_audio_esp.html"
            style="position:fixed;
                   bottom:-6px;
                   left:50%;
                   transform:translateX(-50%);
                   height:165px;
                   width:310px;
                   z-index:1000;
                   border: transparent;
                   display:block;
                   pointer-events:auto;"></iframe>

    <iframe id="hijo2" src="./Av1-botones-coordenadas.html"
            style="position:fixed;
                   bottom:150px;
                   left:50%;
                   transform:translateX(-50%);
                   height:165px;
                   width:310px;
                   z-index:1001;
                   border: none !important;
                   background-color: transparent !important;
                   overflow: hidden;
                   pointer-events:auto;"
            allow="geolocation"
            frameborder="0"></iframe>

    <iframe id="hijo4" src="./Av1-esp-retos-preguntas.html" style="display:none;"></iframe>

    <div id="media-overlay">
        <div id="media-container">
            <button id="close-media">X</button>
            <video id="parada-video" controls></video>
            <img id="parada-imagen">
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ================== ESTADO GLOBAL CENTRALIZADO ==================
        (function() {
        'use strict';
        
        const estadoGlobal = {
            modo: 'aventura', // 'aventura' o 'casa'
            puntoActual: null, // { tipo: 'parada'|'tramo', id: number, datos: {...} }
            ultimaActualizacion: Date.now(),
            // Datos compartidos entre iframes
            datosCompartidos: {
                // Datos de navegaci√≥n
                navegacionActiva: false,
                // Estado de reproducci√≥n de audio
                audio: {
                    reproduciendo: false,
                    paradaId: null,
                    src: null
                },
                // Estado de retos
                reto: {
                    activo: false,
                    completado: false,
                    paradaId: null
                },
                // Estado de la br√∫jula
                brujulaActiva: false
            }
        };

        // ================== FUNCIONES DE SINCRONIZACI√ìN ==================
        /**
         * Sincroniza el estado global con todos los iframes hijos
         // ================== COMUNICACI√ìN CON IFRAMES ==================
        function sincronizarEstadoConHijos() {
            const timestamp = Date.now();
            const mensaje = {
                type: 'sincronizarEstado',
                timestamp: timestamp,
                origen: 'padre',
                estado: {
                    modo: estadoGlobal.modo,
                    puntoActual: estadoGlobal.puntoActual,
                    datosCompartidos: estadoGlobal.datosCompartidos
                }
            };

            console.log(`üîÑ PADRE [${new Date(timestamp).toISOString()}]: Enviando sincronizaci√≥n a todos los hijos`, {
                modo: estadoGlobal.modo,
                puntoActual: estadoGlobal.puntoActual?.id || 'ninguno',
                origen: 'padre'
            });

            // Enviar a todos los iframes hijos con verificaci√≥n de disponibilidad
            const iframes = ['hijo2', 'hijo3', 'hijo4', 'hijo5-casa'];
            let iframesActivos = 0;
            let iframesConError = [];

            iframes.forEach(id => {
                const iframe = document.getElementById(id);
                if (iframe && iframe.contentWindow) {
                    try {
                        iframe.contentWindow.postMessage(mensaje, '*');
                        console.log(`   ‚úÖ Enviado a ${id}`);
                        iframesActivos++;
                    } catch (error) {
                        console.error(`   ‚ùå Error enviando a ${id}:`, error);
                        iframesConError.push(id);
                    }
                } else {
                    console.warn(`   ‚ö†Ô∏è Iframe ${id} no encontrado`);
                    iframesConError.push(id);
                }
            });

            // Registrar resumen de la sincronizaci√≥n
            console.group('üìä Resumen de sincronizaci√≥n');
            console.log(`üì§ Total iframes: ${iframes.length}`);
            console.log(`‚úÖ Iframes activos: ${iframesActivos}`);
            if (iframesConError.length > 0) {
                console.warn(`‚ùå Iframes con error: ${iframesConError.join(', ')}`);
            }
            console.groupEnd();

            return {
                total: iframes.length,
                exitosos: iframesActivos,
                errores: iframesConError.length,
                iframesConError: iframesConError
            };
        }

        /**
         * Actualiza el estado global y sincroniza con los hijos
         * @param {Object} actualizacion - Objeto con las propiedades a actualizar
         * @param {boolean} [sincronizar=true] - Indica si se debe sincronizar con los hijos
         * @returns {Promise<void>}
         */
        function actualizarEstadoGlobal(actualizacion, sincronizar = true) {
            return new Promise((resolve) => {
                // Actualizar el estado global
                Object.assign(estadoGlobal, actualizacion, {
                    ultimaActualizacion: Date.now()
                });

                console.log('üîÑ PADRE: Estado global actualizado:', estadoGlobal);

                // Si se debe sincronizar con los hijos
                if (sincronizar) {
                    const resultado = sincronizarEstadoConHijos();
                    console.log('üì° PADRE: Estado sincronizado con los hijos:', resultado);
                }

                resolve();
            });
        }

        // Hacer la funci√≥n accesible globalmente
        window.actualizarEstadoGlobal = actualizarEstadoGlobal;

        // ================== ESTRUCTURA SIMPLIFICADA ==================
        // Ruta base para los archivos de audio
        const AUDIO_BASE_PATH = './audios/';
        
        // Mapeo entre retos y sus puzzles asociados
        const RETO_PUZZLE_MAP = {
            'R-7': 'PZ-8',   // Reto 7 -> Puzzle 8
            'R-17': 'PZ-18', // Reto 17 -> Puzzle 18
            'R-25': 'PZ-26'  // Reto 25 -> Puzzle 26
        };
        
        // Mapeo inverso para encontrar el reto asociado a un puzzle
        const PUZZLE_RETO_MAP = {};
        Object.entries(RETO_PUZZLE_MAP).forEach(([retoId, puzzleId]) => {
            PUZZLE_RETO_MAP[puzzleId] = retoId;
        });
        
        const AVENTURA_PARADAS = [
  // Parada 0 ‚Äì INICIO (Torres de Serranos start) reto 2 (223, 226, 228, 229)//
  { tipo: "inicio", parada_id: 'P-0', audio_id: "audio_P-0", reto_id: "R-2" },
  // tramo 1 (Torres de Serranos ‚Üí Plaza de la crida) (2, 126,)//
  { tipo: "tramo", tramo_id: 'TR-1', audio_id: "audio_TR-1" },
  // Parada 1 - Plaza de la crida (Puente de Serranos) Reto 3 (233) //
  { tipo: "parada", parada_id: 'P-1', audio_id: "audio_P-1", reto_id: "R-3" },
  // tramo 2 (Plaza de la crida ‚Üí Calle Muro de Santa Ana) (81) //
  { tipo: "tramo", tramo_id: 'TR-2', audio_id: "audio_TR-2" },
  // Parada 2 (Calle Muro de Santa Ana) Reto 4 (68) //
  { tipo: "parada", parada_id: 'P-2', audio_id: "audio_P-2", reto_id: "R-4" },
  // tramo 3 (Calle Muro de Santa Ana ‚Üí Palacio de los Borgia) (52) //
  { tipo: "tramo", tramo_id: 'TR-3', audio_id: "audio_TR-3" },
  // Parada 3 (Iglesia de San Lorenzo) Reto 5 (686, 682-B, 462, 683, 684) //
  { tipo: "parada", parada_id: 'P-3', audio_id: "audio_P-3", reto_id: "R-5" },
  // tramo 4 (Iglesia de San Lorenzo ‚Üí Plaza de la Virgen) (465-B) //
  { tipo: "tramo", tramo_id: 'TR-4', audio_id: "audio_TR-4" },
  // Parada 4 (Plaza de la Virgen) Reto 6 (466, 467) //
  { tipo: "parada", parada_id: 'P-4', audio_id: "audio_P-4", reto_id: "R-6" },
  // Parada 5 (Plaza de la Virgen) Reto 7, 8 Puzzle plaza de la virgen (468)  //
  { 
      tipo: "parada", 
      parada_id: 'P-5', 
      audio_id: "audio_P-5", 
      retos: [
          { tipo: "reto", id: "R-7" },
          { tipo: "puzzle", id: "PZ-8" }
      ] 
  },
  // tramo 5 (Plaza de la Virgen ‚Üí Plaza de la Almo√≠na) (477-B, 479, 141, 83, 8-C) //
  { tipo: "tramo", tramo_id: 'TR-5', audio_id: "audio_TR-5" },
  // Parada 6 (Panel cer√°mico muro Catedral) Reto 9 (434, 440, 441, 442) //
  { tipo: "parada", parada_id: 'P-6', audio_id: "audio_P-6", reto_id: "R-9" },
  // Parada 7 (Capilla exterior catedral) Reto 10 (443, 444, 445) //
  { tipo: "parada", parada_id: 'P-7', audio_id: "audio_P-7", reto_id: "R-10" },
  // Parada 8 (Capilla exterior catedral) Reto 11 (445) //
  { tipo: "parada", parada_id: 'P-8', audio_id: "audio_P-8", reto_id: "R-11" },
  // Parada 9 (Arco Novo Catedral y Puerta Negra Bas√≠lica) (446, 355, 447, 11-B, 451, 452) //
  { tipo: "parada", parada_id: 'P-9', audio_id: "audio_P-9" },
  // Parada 10 (Casa del Punt de Gantxo) Reto 12 (51-C, 454, 455, 455-B, 456, 148) //
  { tipo: "parada", parada_id: 'P-10', audio_id: "audio_P-10", reto_id: "R-12"  },
  // tramo 6 (Plaza de la Almo√≠na (casa del punt de Gantxo) ‚Üí Plaza Decimo Junio Bruto) (457, 10-B)//
  { tipo: "tramo", tramo_id: 'TR-6', audio_id: "audio_TR-6" },
  // Parada 11 (Museo arqueol√≥gico La Almo√≠na) Reto 13 (458) //
  { tipo: "parada", parada_id: 'P-11', audio_id: "audio_P-11", reto_id: "R-13" },
  // Parada 12 (Museo arqueol√≥gico La Almo√≠na 2) (459, 460, 461) //
  { tipo: "parada", parada_id: 'P-12', audio_id: "audio_P-12" },
  // Parada 13 (Vista de la Catedral, Cimborrio) Reto 14 (8-C, 464) //
  { tipo: "parada", parada_id: 'P-13', audio_id: "audio_P-13", reto_id: "R-14" },
  // tramo 7 (Museo arqueol√≥gico La Almo√≠na ‚Üí Palacio Arzobispal) (85) //
  { tipo: "tramo", tramo_id: 'TR-7', audio_id: "audio_TR-7" },
  // Parada 14 (Palacio Arzobispal y Puerta Rom√°nica de la Catedral) Reto 15 (673, 86, 426-B, 141, 437, 438) //
  { tipo: "parada", parada_id: 'P-14', audio_id: "audio_P-14", reto_id: "R-15" },
  // Parada 15 (Puerta Rom√°nica de la Catedral) (439) //
  { tipo: "parada", parada_id: 'P-15', audio_id: "audio_P-15" },
  // tramo 8 (Puerta Rom√°nica de la Catedral ‚Üí Plaza del Ayuntamiento) (125) //
  { tipo: "tramo", tramo_id: 'TR-8', audio_id: "audio_TR-8" },
  // Parada 16 (Plaza del Ayuntamiento) (13-B, 263, 332, 14-C) //
  { tipo: "parada", parada_id: 'P-16', audio_id: "audio_P-16" },
  // tramo 9 (Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento) (334, 335) //
  { tipo: "tramo", tramo_id: 'TR-9', audio_id: "audio_TR-9" },
  // Parada 17 (Edificio del Ayuntamiento) Reto 16 (336, 337, 338) //
  { tipo: "parada", parada_id: 'P-17', audio_id: "audio_P-17", reto_id: "R-16" },
  // Parada 18 (Edificio del Ayuntamiento, leyenda del murci√©lago) (339, 340, 341, 54) //
  { tipo: "parada", parada_id: 'P-18', audio_id: "audio_P-18" },
  // tramo 10 (Edificio del Ayuntamiento ‚Üí Estaci√≥n del Norte) (87, 15-C) //
  { tipo: "tramo", tramo_id: 'TR-10', audio_id: "audio_TR-10" },
  // Parada 19 (Estaci√≥n del Norte) Reto 17, 18 Puzzle Estaci√≥n del Norte (326) //
  { 
      tipo: "parada", 
      parada_id: 'P-19', 
      audio_id: "audio_P-19", 
      retos: [
          { tipo: "reto", id: "R-17" },
          { tipo: "puzzle", id: "PZ-18" }
      ] 
  },
  // tramo 11 (Estaci√≥n del Norte ‚Üí Plaza de Toros) (20-C, 323-B, 88) //
  { tipo: "tramo", tramo_id: 'TR-11', audio_id: "audio_TR-11" },
  // Tramo 12 (Plaza de Toros ‚Üí Casa estilo √Årabe) (89, 3-D) //
  { tipo: "tramo", tramo_id: 'TR-12', audio_id: "audio_TR-12" },
  // Parada 20 (Casa estilo √Årabe) Reto 19 (99) //
  { tipo: "parada", parada_id: 'P-20', audio_id: "audio_P-20", reto_id: "R-19" },
  // Parada 21 (Casa estilo √Årabe, mitad Aventura) (100) //
  { tipo: "parada", parada_id: 'P-21', audio_id: "audio_P-21" },
  // tramo 13 (Casa estilo √Årabe ‚Üí Palacio de Comunicaciones) (21-B) //
  { tipo: "tramo", tramo_id: 'TR-13', audio_id: "audio_TR-13" },
  // Parada 22 (Palacio de Comunicaciones) Reto 20 y Reto 21 (700, 343, 344) //
  { tipo: "parada", parada_id: 'P-22', audio_id: "audio_P-22", retos: ["R-20", "R-21"] },
  // Parada 23 (Edificio Suay) Reto 21 (693, 693-B) //
  { tipo: "parada", parada_id: 'P-23', audio_id: "audio_P-23" ,reto_id: "R-21" },
  // tramo 14 (Palacio de Comunicaciones, edificio Suay ‚Üí Banco de Val√®ncia) (345, 347, 348, 22, 109) //
  { tipo: "tramo", tramo_id: 'TR-14', audio_id: "audio_TR-14" },
  // Parada 24 (Banco de Valencia) Reto 22 (349, 350) //
  { tipo: "parada", parada_id: 'P-24', audio_id: "audio_P-24", reto_id: "R-22" },
  // tramo 15 (Banco de Val√®ncia ‚Üí Palacio del Marqu√©s de Dos Aguas) (351, 23-B, 352, 354) //
  { tipo: "tramo", tramo_id: 'TR-15', audio_id: "audio_TR-15" },
  // Parada 25 (Palacio del Marqu√©s de Dos Aguas) (356, 357)//
  { tipo: "parada", parada_id: 'P-25', audio_id: "audio_P-25" },
  // tramo 16 (Palacio del Marqu√©s ‚Üí Mercado Central) (358, 359-B, 101) //
  { tipo: "tramo", tramo_id: 'TR-16', audio_id: "audio_TR-16" },
  // Parada 26 (Mercado central) Reto23 (701, 24-D, 361, 362, 363, 364) //
  { tipo: "parada", parada_id: 'P-26', audio_id: "audio_P-26", reto_id: "R-23" },
  // tramo 17 (Mercado Central ‚Üí Iglesia de los Santos Juanes) (274, 27-C) //
  { tipo: "tramo", tramo_id: 'TR-17', audio_id: "audio_TR-17" },
  // Parada 27 (Iglesia de los Santos Juanes) Reto 24) (365, 366) //
  { tipo: "parada", parada_id: 'P-27', audio_id: "audio_P-27", reto_id: "R-24" },
  // Parada 28 (Iglesia de los Santos Juanes reto 25) (367) //
  { tipo: "parada", parada_id: 'P-28', audio_id: "audio_P-28", reto_id: "R-25" },
  // tramo 18 (Iglesia Santos Juanes ‚Üí Lonja de Val√®ncia) (368, 369, 28, 370, 371, 372, 373, 374, 375, 376, 377) //
  { tipo: "tramo", tramo_id: 'TR-18', audio_id: "audio_TR-18" },
  // Parada 29 (Lonja Puerta de Los Pecados barquero) Reto 27 (378, 379) //
  { tipo: "parada", parada_id: 'P-29', audio_id: "audio_P-29", reto_id: "R-27" },
  // Parada 30 (Lonja Puerta de Los Pecados √°rbol muerto) Reto 28 (380, 381) //
  { tipo: "parada", parada_id: 'P-30', audio_id: "audio_P-30", reto_id: "R-28" },
  // tramo 19 (Lonja G√°rgolas) (383) //
  { tipo: "tramo", tramo_id: 'TR-19', audio_id: "audio_TR-19" },
  // Parada 31 (Lonja G√°rgolas √°ngel vasija) Reto 29 (384) //
  { tipo: "parada", parada_id: 'P-31', audio_id: "audio_P-31", reto_id: "R-29" },
  // Parada 32 (Lonja G√°rgolas barbudo y le√≥n) Reto 30 (385) //
  { tipo: "parada", parada_id: 'P-32', audio_id: "audio_P-32", reto_id: "R-30" },
  // Parada 33 (Lonja G√°rgolas fornicador ventana) Reto 31, Puzzle 26 ) (386) //
  { tipo: "parada", parada_id: 'P-33', audio_id: "audio_P-33", retos: [ { tipo: "reto", id: "R-31" }, { tipo: "puzzle", id: "PZ-26" } ] },
  // tramo 20 (Lonja ‚Üí Plaza del Doctor Collado) (388, 389, 390, 391, 392) //
  { tipo: "tramo", tramo_id: 'TR-20', audio_id: "audio_TR-20" },
  // tramo 21 (Plaza del Doctor Collado ‚Üí Plaza del Negrito) (333, 397, 41, 398, 198, 671, 522, 32-C) //
  { tipo: "tramo", tramo_id: 'TR-21', audio_id: "audio_TR-21" },
  // Parada 34 (Fuente del Negrito) Reto 32 (382, 501) //
  { tipo: "parada", parada_id: 'P-34', audio_id: "audio_P-34", reto_id: "R-32" },
  // tramo 22 (Plaza del Negrito ‚Üí Calle Caballeros) (33-B, 486, 480-B) //
  { tipo: "tramo", tramo_id: 'TR-22', audio_id: "audio_TR-22" },
  // Parada 35 (Palau de la Generalitat) (481-B, 482-B, 2-D) //
  { tipo: "parada", parada_id: 'P-35', audio_id: "audio_P-35" },
  // tramo 23 (Palacio de la Generalitat ‚Üí Calle de los Serranos - FINAL)  //
  { tipo: "tramo", tramo_id: 'TR-23', audio_id: "audio_TR-23" },
  // Parada 36 (Torres de Serranos Final) //
  { tipo: "parada", parada_id: 'P-36', audio_id: "audio_P-36" }
];

        
        // Variables globales
        window.paradaActual = 0; // √çndice de la parada actual
        
        // Funci√≥n para mostrar mensajes en la ventana de informaci√≥n
        function mostrarMensajeInfoParada(mensaje, esError = false) {
            const info = document.getElementById('info-parada');
            if (info) {
                info.textContent = mensaje;
                info.style.display = 'block';
                if (esError) {
                    info.classList.add('error');
                } else {
                    info.classList.remove('error');
                }
            }
        }
        
        // Hacer la funci√≥n accesible globalmente
        window.mostrarMensajeInfoParada = mostrarMensajeInfoParada;

        // Funci√≥n para ocultar la informaci√≥n de la parada
        function ocultarInfoParada() {
            const info = document.getElementById('info-parada');
            if (info) {
                info.style.display = 'none';
            }
        }
        
        // Hacer la funci√≥n accesible globalmente
        window.ocultarInfoParada = ocultarInfoParada;

        // Inicializaci√≥n del mapa
        let map;
        let mapInitialized = false;
        
        function inicializarMapa() {
            try {
                console.log('üîç Iniciando inicializaci√≥n del mapa...');
                
                // Verificar si Leaflet est√° cargado
                if (typeof L === 'undefined') {
                    console.error('‚ùå Error: La biblioteca Leaflet no est√° cargada');
                    return null;
                }
                
                // Verificar si el contenedor del mapa existe
                const mapaContainer = document.getElementById('mapa');
                if (!mapaContainer) {
                    console.error('‚ùå Error: No se encontr√≥ el contenedor del mapa');
                    return null;
                }
                
                console.log('‚úÖ Contenedor del mapa encontrado');
                
                // Asegurarse de que el contenedor sea visible
                mapaContainer.style.display = 'block';
                
                // Inicializar el mapa
                map = L.map('mapa', {
                    center: [39.4622, -0.37802],
                    zoom: 14,
                    zoomControl: true,
                    rotate: false,
                    touchRotate: false,
                    bearing: 0,
                    preferCanvas: true,
                    tap: false,
                    fadeAnimation: true,
                    zoomAnimation: true,
                    markerZoomAnimation: true
                });
                
                console.log('‚úÖ Mapa de Leaflet creado');
                
                // A√±adir capa de OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                    maxZoom: 19, 
                    minZoom: 12,
                    attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    detectRetina: true
                }).addTo(map);
                
                console.log('‚úÖ Capa de OpenStreetMap a√±adida');
                
                // A√±adir un marcador de prueba
                const marker = L.marker([39.4622, -0.37802]).addTo(map)
                    .bindPopup('Punto de inicio')
                    .openPopup();
                
                console.log('‚úÖ Marcador de prueba a√±adido');
                
                // Forzar actualizaci√≥n del tama√±o
                const actualizarTama√±oMapa = () => {
                    if (map) {
                        map.invalidateSize({ pan: false });
                        console.log('üîÑ Tama√±o del mapa actualizado');
                    }
                };
                
                // Actualizar el tama√±o despu√©s de un breve retraso
                setTimeout(actualizarTama√±oMapa, 100);
                
                // Actualizar el tama√±o cuando la ventana cambie de tama√±o
                window.addEventListener('resize', actualizarTama√±oMapa);
                
                // Marcar como inicializado
                mapInitialized = true;
                console.log('‚úÖ Mapa inicializado correctamente');
                
                return map;
                
            } catch (error) {
                console.error('‚ùå Error al inicializar el mapa:', error);
                return null;
            }
        }
        
        // Funci√≥n para verificar e inicializar el mapa
        function verificarEInicializarMapa() {
            if (!mapInitialized) {
                console.log('üîç Verificando estado del mapa...');
                window.mapaLeaflet = inicializarMapa();
                
                // Si a√∫n no est√° inicializado, intentar de nuevo
                if (!mapInitialized) {
                    console.log('üîÑ Reintentando inicializaci√≥n del mapa...');
                    setTimeout(verificarEInicializarMapa, 500);
                }
            }
        }
        
        // Inicializar el mapa cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            console.log('üìÑ El documento a√∫n se est√° cargando, esperando a que est√© listo...');
            document.addEventListener('DOMContentLoaded', verificarEInicializarMapa);
        } else {
            console.log('üìÑ El documento ya est√° listo, inicializando mapa...');
            verificarEInicializarMapa();
        }
        
        // Tambi√©n intentar inicializar despu√©s de un breve retraso como respaldo
        setTimeout(verificarEInicializarMapa, 1000);

        // Funci√≥n para cerrar la superposici√≥n de medios
        function closeMediaOverlay() {
            console.log('üîµ Cerrando superposici√≥n de medios...');
            const mediaOverlay = document.getElementById('media-overlay');
            if (mediaOverlay) {
                mediaOverlay.style.display = 'none';
                
                // Pausar cualquier video o audio que est√© reproduci√©ndose
                const mediaElement = mediaOverlay.querySelector('video, audio');
                if (mediaElement) {
                    mediaElement.pause();
                    mediaElement.currentTime = 0;
                }
            }
            
            // Notificar a los iframes hijos que se cerr√≥ el overlay
            ['hijo2', 'hijo3', 'hijo4', 'hijo5-casa'].forEach(id => {
                const iframe = document.getElementById(id);
                if (iframe && iframe.contentWindow) {
                    try {
                        iframe.contentWindow.postMessage({ type: 'mediaOverlayClosed' }, '*');
                    } catch (error) {
                        console.error(`Error notificando a ${id}:`, error);
                    }
                }
            });
        }
        
        // Hacer la funci√≥n accesible globalmente
        window.closeMediaOverlay = closeMediaOverlay;

        // Inicializaci√≥n de la aplicaci√≥n
        function inicializarAplicacion() {
            ocultarInfoParada();
            
            // Inicializar el overlay de medios si no existe
            if (!document.getElementById('media-overlay')) {
                const overlay = document.createElement('div');
                overlay.id = 'media-overlay';
                overlay.style.display = 'none';
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
                overlay.style.zIndex = '9999';
                overlay.style.display = 'flex';
                overlay.style.justifyContent = 'center';
                overlay.style.alignItems = 'center';
                overlay.onclick = closeMediaOverlay;
                document.body.appendChild(overlay);
            }
            
            closeMediaOverlay();
            window.paradaActual = 0;
            
            // Notificar a hijo5-casa (bot√≥n casa) el estado inicial: modo GPS activo y parada 0
            const hijo5 = document.getElementById('hijo5-casa');
            const hijo2 = document.getElementById('hijo2');
            
            if (hijo2 && hijo2.contentWindow) {
                hijo2.contentWindow.postMessage({ tipo: 'mostrar-foto-video', index: 0 }, '*');
                hijo2.contentWindow.postMessage({ tipo: 'activar-botones-foto-video', color: 'green' }, '*');
                hijo2.contentWindow.postMessage({ tipo: 'gps-on' }, '*');
            }
            
            if (hijo5 && hijo5.contentWindow) {
                hijo5.contentWindow.postMessage({ type: 'modoGPS', parada: 0 }, '*');
            }
        }
        
        // Iniciar la aplicaci√≥n cuando el DOM est√© completamente cargado
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarAplicacion);
        } else {
            inicializarAplicacion();
        }
        
        // Variables para los elementos de navegaci√≥n en el mapa
        let rutaPolyline = null;
        let marcadorInicio = null;
        let marcadorDestino = null;
        let direccionFlecha = null;

        // Funci√≥n para limpiar la navegaci√≥n actual del mapa
        function limpiarNavegacion() {
            if (rutaPolyline) {
                map.removeLayer(rutaPolyline);
                rutaPolyline = null;
            }
            
            if (marcadorInicio) {
                map.removeLayer(marcadorInicio);
                marcadorInicio = null;
            }
            
            if (marcadorDestino) {
                map.removeLayer(marcadorDestino);
                marcadorDestino = null;
            }
            
            if (direccionFlecha) {
                map.removeLayer(direccionFlecha);
                direccionFlecha = null;
            }
        }

        // Funci√≥n para dibujar una flecha en la ruta
        function dibujarFlecha(latlng, angulo) {
            // Usar un √≠cono de marcador con rotaci√≥n para simular una flecha
            const iconoFlecha = L.divIcon({
                className: 'flecha-navegacion',
                html: '‚û§',
                iconSize: [24, 24],
                iconAnchor: [12, 12],
                popupAnchor: [0, -12]
            });
            
            // Crear el marcador con rotaci√≥n
            const flecha = L.marker(latlng, {
                icon: iconoFlecha,
                rotationAngle: angulo,
                rotationOrigin: 'center',
                zIndexOffset: 1000
            });
            
            return flecha;
        }

        // ================== MANEJADOR DE MENSAJES DEL HIJO 2 (COORDENADAS) ==================
        window.addEventListener('message', function(event) {
            const iframe = document.getElementById('hijo2');
            if (!iframe || event.source !== iframe.contentWindow) return;
            
            const data = event.data;
            if (!data || !data.type) return;
            
            console.log(`üì© PADRE: Mensaje recibido de hijo 2 (${data.type})`, data);
            
            switch(data.type) {
                case 'mostrarNavegacion':
                    console.log('üìç PADRE: Mostrando navegaci√≥n a destino:', data.destino.nombre);
                    
                    // Limpiar navegaci√≥n anterior
                    limpiarNavegacion();
                    
                    // Crear los puntos de la ruta (simplificado: l√≠nea recta entre origen y destino)
                    const puntosRuta = [
                        [data.origen.lat, data.origen.lng],
                        [data.destino.coordenadas.lat, data.destino.coordenadas.lng]
                    ];
                    
                    // Dibujar la l√≠nea de ruta
                    rutaPolyline = L.polyline(puntosRuta, {
                        color: '#1E88E5', // Azul
                        weight: 6,
                        opacity: 0.8,
                        lineJoin: 'round'
                    }).addTo(map);
                    
                    // A√±adir marcador de inicio (verde)
                    marcadorInicio = L.marker([data.origen.lat, data.origen.lng], {
                        icon: L.divIcon({
                            className: 'marcador-inicio',
                            html: 'üìç',
                            iconSize: [30, 30],
                            iconAnchor: [15, 30],
                            popupAnchor: [0, -30]
                        })
                    }).addTo(map);
                    
                    // A√±adir marcador de destino (rojo)
                    marcadorDestino = L.marker([data.destino.coordenadas.lat, data.destino.coordenadas.lng], {
                        icon: L.divIcon({
                            className: 'marcador-destino',
                            html: 'üìç',
                            iconSize: [30, 30],
                            iconAnchor: [15, 30],
                            popupAnchor: [0, -30]
                        })
                    }).addTo(map);
                    
                    // A√±adir etiqueta al destino
                    marcadorDestino.bindPopup(`<b>${data.destino.nombre}</b>`).openPopup();
                    
                    // Calcular punto medio para la flecha (80% del camino desde el origen)
                    const puntoIntermedio = {
                        lat: data.origen.lat + (data.destino.coordenadas.lat - data.origen.lat) * 0.8,
                        lng: data.origen.lng + (data.destino.coordenadas.lng - data.origen.lng) * 0.8
                    };
                    
                    // Calcular √°ngulo de la flecha
                    const angulo = Math.atan2(
                        data.destino.coordenadas.lat - data.origen.lat,
                        data.destino.coordenadas.lng - data.origen.lng
                    ) * (180 / Math.PI);
                    
                    // A√±adir flecha de direcci√≥n
                    direccionFlecha = dibujarFlecha(puntoIntermedio, angulo).addTo(map);
                    
                    // Ajustar el mapa para mostrar toda la ruta con un margen
                    map.fitBounds(rutaPolyline.getBounds(), {
                        padding: [50, 50],
                        maxZoom: 17
                    });
                    
                    console.log('üó∫Ô∏è PADRE: Navegaci√≥n mostrada en el mapa');
                    break;
                    
                case 'cambio-estado':
                    console.log('üîÑ PADRE: Cambio de estado en navegaci√≥n:', data.estado);
                    // Aqu√≠ puedes agregar l√≥gica para manejar cambios de estado
                    break;
                    
                case 'interaccion-usuario':
                    console.log('üñ±Ô∏è PADRE: Interacci√≥n del usuario:', data.tipoBoton, data.datos);
                    // Aqu√≠ puedes manejar interacciones del usuario
                    break;
                    
                case 'estado-gps':
                    if (data.estado === 'activo') {
                        console.log('üìç PADRE: GPS activado');
                    } else if (data.estado === 'inactivo') {
                        console.log('‚è∏Ô∏è PADRE: GPS desactivado');
                    } else if (data.estado === 'error') {
                        console.error('‚ùå PADRE: Error en GPS:', data.error);
                    }
                    break;
                    
                case 'llegada-parada':
                    console.log('üéØ PADRE: Llegada a parada detectada:', data.parada);
                    // Limpiar navegaci√≥n al llegar al destino
                    limpiarNavegacion();
                    break;
                    
                case 'inicio-navegacion':
                    console.log('üöÄ PADRE: Inicio de navegaci√≥n a parada:', data.parada);
                    // Aqu√≠ puedes manejar el inicio de la navegaci√≥n
                    break;
                    
                case 'fin-navegacion':
                    console.log('üèÅ PADRE: Navegaci√≥n finalizada');
                    // Limpiar navegaci√≥n al finalizar
                    limpiarNavegacion();
                    break;
                    
                default:
                    console.log('‚ÑπÔ∏è PADRE: Mensaje no manejado de hijo 2:', data);
            }
        });
        
        // ================== FUNCIONES DE COMUNICACI√ìN ==================

/**
 * Env√≠a un mensaje a un iframe hijo
 * @param {string} destino - ID del iframe destino ('hijo2', 'hijo3', 'hijo4', 'hijo5-casa')
 * @param {string} tipo - Tipo de mensaje
 * @param {Object} [datos={}] - Datos adicionales del mensaje
 */
function enviarMensaje(destino, tipo, datos = {}) {
    const iframe = document.getElementById(destino);
    if (iframe?.contentWindow) {
        const mensaje = { type: tipo, ...datos, timestamp: Date.now() };
        console.log(`üì§ PADRE ‚Üí ${destino.toUpperCase()}:`, tipo, datos);
        iframe.contentWindow.postMessage(mensaje, '*');
    } else {
        console.error(`‚ùå PADRE: No se pudo enviar mensaje a ${destino}: iframe no disponible`);
    }
}

        // ================== INICIALIZACI√ìN DEL SISTEMA DE MENSAJER√çA ==================
        let mensajeria;
        
        // Inicializar el sistema de mensajer√≠a
        function inicializarMensajeria() {
            try {
                // Importar el m√≥dulo de mensajer√≠a
                import('./js/mensajeria.js')
                    .then(module => {
                        mensajeria = module;
                        mensajeria.inicializarMensajeria({
                            iframeId: 'padre',
                            logLevel: mensajeria.LOG_LEVELS.DEBUG,
                            debug: true
                        });
                        
                        console.log('‚úÖ Sistema de mensajer√≠a inicializado');
                        configurarMensajeria();
                    })
                    .catch(error => {
                        console.error('‚ùå Error al cargar el m√≥dulo de mensajer√≠a:', error);
                        // Configurar un sistema de mensajer√≠a b√°sico como respaldo
                        configurarMensajeriaBasica();
                    });
            } catch (error) {
                console.error('‚ùå Error al inicializar el sistema de mensajer√≠a:', error);
                configurarMensajeriaBasica();
            }
        }
        
        // Configurar manejadores de mensajes con el sistema de mensajer√≠a
        function configurarMensajeria() {
            // Configurar manejador de mensajes principal
            window.addEventListener('message', function(event) {
                try {
                    const mensaje = event.data;
                    
                    // Verificar si es un mensaje del sistema de mensajer√≠a
                    if (mensajeria && mensajeria.validarMensaje) {
                        const validacion = mensajeria.validarMensaje(mensaje);
                        
                        if (!validacion.valido) {
                            console.warn('Mensaje no v√°lido recibido:', validacion.error, mensaje);
                            return;
                        }
                        
                        // Determinar el origen del mensaje
                        const origen = 
                            event.source === window.frames['hijo2']?.contentWindow ? 'hijo2' :
                            event.source === window.frames['hijo3']?.contentWindow ? 'hijo3' :
                            event.source === window.frames['hijo4']?.contentWindow ? 'hijo4' : 'desconocido';
                        
                        // Registrar el mensaje recibido
                        mensajeria.logger.log(`Mensaje recibido de ${origen} (${mensaje.tipo})`, mensaje);
                        
                        // Delegar al manejador correspondiente
                        switch(origen) {
                            case 'hijo2': manejarMensajeHijo2(mensaje.tipo, mensaje.datos); break;
                            case 'hijo3': manejarMensajeHijo3(mensaje.tipo, mensaje.datos); break;
                            case 'hijo4': manejarMensajeHijo4(mensaje.tipo, mensaje.datos); break;
                            default:
                                console.warn('Origen de mensaje no reconocido:', origen);
                        }
                    } else {
                        // Manejar mensajes del sistema antiguo
                        const iframe = 
                            event.source === window.frames['hijo2']?.contentWindow ? 'hijo2' :
                            event.source === window.frames['hijo3']?.contentWindow ? 'hijo3' :
                            event.source === window.frames['hijo4']?.contentWindow ? 'hijo4' : null;
                        
                        if (iframe) {
                            console.log(`üì• PADRE: Mensaje de ${iframe.toUpperCase()} (sistema antiguo):`, mensaje);
                            switch(iframe) {
                                case 'hijo2': manejarMensajeHijo2(mensaje.type, mensaje); break;
                                case 'hijo3': manejarMensajeHijo3(mensaje.type, mensaje); break;
                                case 'hijo4': manejarMensajeHijo4(mensaje.type, mensaje); break;
                            }
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error al procesar mensaje:', error, event.data);
                }
            });
            
            console.log('‚úÖ Manejadores de mensajes configurados');
        }
        
        // Sistema de mensajer√≠a b√°sico como respaldo
        function configurarMensajeriaBasica() {
            console.warn('Usando sistema de mensajer√≠a b√°sico');
            
            window.enviarMensaje = function(destino, tipo, datos = {}) {
                const iframe = document.getElementById(destino);
                if (iframe?.contentWindow) {
                    const mensaje = { type: tipo, ...datos, timestamp: Date.now() };
                    console.log(`üì§ PADRE ‚Üí ${destino.toUpperCase()}:`, tipo, datos);
                    iframe.contentWindow.postMessage(mensaje, '*');
                } else {
                    console.error(`‚ùå PADRE: No se pudo enviar mensaje a ${destino}: iframe no disponible`);
                }
            };
        }
        
        // Inicializar el sistema de mensajer√≠a al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', inicializarMensajeria);

// ================== MANEJADORES POR HIJO ==================

function manejarMensajeHijo2(type, data) {
    switch (type) {
        case 'llegada-parada':
            console.log('üìç PADRE: Llegada a parada detectada:', data.parada);
            // El hijo2 ya maneja la l√≥gica de navegaci√≥n
            break;
            
        case 'inicio-navegacion':
            console.log('üöÄ PADRE: Inicio de navegaci√≥n a parada:', data.parada);
            // Pausar audio al iniciar navegaci√≥n
            enviarMensaje('hijo3', 'pausarAudio', { motivo: 'inicio_navegacion' });
            break;
            
        case 'fin-navegacion':
            console.log('üèÅ PADRE: Navegaci√≥n finalizada');
            break;
    }
}

function manejarMensajeHijo3(type, data) {
    switch (type) {
        case 'audioIniciado':
            console.log('‚ñ∂Ô∏è PADRE: Audio iniciado:', data.audioId);
            break;
            
        case 'audioTerminado':
            console.log('‚èπÔ∏è PADRE: Audio terminado:', data.audioId);
            // Si es un audio de parada con retos, mostrarlos
            const puntoActual = estadoGlobal.puntoActual;
            if (puntoActual?.retos?.length > 0) {
                const primerReto = puntoActual.retos[0];
                enviarMensaje('hijo4', 'mostrarReto', { 
                    reto: primerReto,
                    esPrimero: true,
                    esUltimo: puntoActual.retos.length === 1
                });
            } else {
                avanzarSiguientePunto();
            }
            break;
    }
}

function manejarMensajeHijo4(type, data) {
    switch (type) {
        case 'retoIniciado':
            console.log('üéÆ PADRE: Reto iniciado:', data.retoId);
            // Pausar audio al iniciar reto
            enviarMensaje('hijo3', 'pausarAudio', { motivo: 'reto_iniciado' });
            break;
            
        case 'retoCompletado':
            console.log('üèÜ PADRE: Reto completado:', data.retoId);
            manejarRetoCompletado(data.retoId);
            break;
            
        case 'puzzleCompletado':
            console.log('üß© PADRE: Puzzle completado:', data.puzzleId);
            // Continuar con el siguiente punto
            avanzarSiguientePunto();
            break;
    }
}

// ================== FUNCIONES AUXILIARES ==================

function manejarRetoCompletado(retoId) {
    const puntoActual = estadoGlobal.puntoActual;
    if (!puntoActual?.retos) return;

    const indiceRetoActual = puntoActual.retos.findIndex(r => r.id === retoId);
    if (indiceRetoActual === -1) return;

    const esUltimoReto = indiceRetoActual === puntoActual.retos.length - 1;

    if (!esUltimoReto) {
        // Mostrar siguiente reto
        const siguienteReto = puntoActual.retos[indiceRetoActual + 1];
        enviarMensaje('hijo4', 'mostrarReto', { 
            reto: siguienteReto,
            esUltimo: indiceRetoActual === puntoActual.retos.length - 2
        });
    } else {
        // No hay m√°s retos, ocultar interfaz
        enviarMensaje('hijo4', 'ocultarRetos');
        // Continuar con el flujo normal
        avanzarSiguientePunto();
    }
}

function avanzarSiguientePunto() {
    const indiceActual = AVENTURA_PARADAS.findIndex(p => 
        (p.parada_id === estadoGlobal.puntoActual?.parada_id) || 
        (p.tramo_id === estadoGlobal.puntoActual?.tramo_id)
    );

    if (indiceActual < AVENTURA_PARADAS.length - 1) {
        const siguientePunto = AVENTURA_PARADAS[indiceActual + 1];
        actualizarEstadoGlobal({ puntoActual: siguientePunto });

        // Notificar a los hijos seg√∫n el tipo de punto
        if (siguientePunto.parada_id) {
            // Es una parada
            if (siguientePunto.retos?.length > 0) {
                // Tiene retos, el audio se reproducir√° primero y luego se mostrar√°n los retos
                enviarMensaje('hijo3', 'reproducirAudio', { 
                    audioId: siguientePunto.audio_id,
                    esperarRetos: true
                });
            } else {
                // No tiene retos, solo reproducir audio
                enviarMensaje('hijo3', 'reproducirAudio', { 
                    audioId: siguientePunto.audio_id 
                });
            }
        } else if (siguientePunto.tramo_id) {
            // Es un tramo, reproducir audio
            enviarMensaje('hijo3', 'reproducirAudio', { 
                audioId: siguientePunto.audio_id 
            });
        }
    } else {
        console.log('üèÅ PADRE: Fin del recorrido');
    }
}
            
            try {
                switch(data.type) {
                    case 'hijo4Ready':
                    case 'retos-hijo-listo':
                        console.log('‚úÖ PADRE: Hijo 4 (Retos) listo y operativo');
                        // Confirmar recepci√≥n y sincronizar estado actual
                        const respuesta = {
                            type: 'sincronizarEstado',
                            origen: 'padre',
                            destino: 'hijo4',
                            timestamp: Date.now(),
                            estado: {
                                modo: estadoGlobal.modo || 'aventura',
                                retoActivo: estadoGlobal.datosCompartidos?.reto?.activo || false,
                                retoCompletado: estadoGlobal.datosCompartidos?.reto?.completado || false,
                                paradaActual: estadoGlobal.puntoActual?.id || null,
                                puntoActual: estadoGlobal.puntoActual || null
                            }
                        };
                        
                        iframe.contentWindow.postMessage(respuesta, '*');
                        console.log('üîÑ PADRE: Estado sincronizado con hijo4', respuesta.estado);
                        break;
                        
                    case 'retoIniciado':
                        console.log('üéØ PADRE: Reto iniciado:', data.retoId);
                        // Actualizar estado global
                        const nuevoEstado = {
                            reto: {
                                activo: true,
                                completado: false,
                                id: data.retoId,
                                timestamp: Date.now()
                            },
                            // Pausar la reproducci√≥n de audio cuando se inicia un reto
                            reproduciendoAudio: false
                        };
                        
                        actualizarEstadoGlobal(nuevoEstado);
                        
                        // Notificar al hijo3 (audio) que debe pausar la reproducci√≥n
                        const hijo3 = document.getElementById('hijo3');
                        if (hijo3 && hijo3.contentWindow) {
                            hijo3.contentWindow.postMessage({
                                type: 'pausarReproduccion',
                                motivo: 'reto_iniciado',
                                retoId: data.retoId,
                                timestamp: Date.now()
                            }, '*');
                            console.log('‚è∏Ô∏è PADRE: Solicitada pausa de reproducci√≥n por inicio de reto');
                        }
                        break;
                        
                    case 'retoCompletado':
                        console.log('üèÜ PADRE: Reto completado:', data.retoId);
                        
                        // Verificar si el reto completado tiene un puzzle asociado
                        const puzzleAsociado = RETO_PUZZLE_MAP[data.retoId];
                        
                        // Actualizar estado global
                        actualizarEstadoGlobal({
                            reto: {
                                activo: false,
                                completado: true,
                                id: data.retoId,
                                timestamp: Date.now(),
                                puzzleAsociado: puzzleAsociado || null
                            }
                        });
                        
                        // Ocultar el iframe del reto
                        const iframeHijo4 = document.getElementById('hijo4');
                        if (iframeHijo4) {
                            iframeHijo4.style.display = 'none';
                            console.log('üëã PADRE: Iframe de retos oculto');
                        }
                        
                        // Notificar al hijo3 (audio) que puede reanudar la reproducci√≥n
                        const hijo3Audio = document.getElementById('hijo3');
                        if (hijo3Audio?.contentWindow) {
                            hijo3Audio.contentWindow.postMessage({
                                type: 'reanudarReproduccion',
                                motivo: 'reto_completado',
                                retoId: data.retoId,
                                timestamp: Date.now()
                            }, '*');
                            console.log('‚ñ∂Ô∏è PADRE: Solicitada reanudaci√≥n de reproducci√≥n');
                        }
                        
                        // Si hay un puzzle asociado, mostrarlo despu√©s de un breve retraso
                        if (puzzleAsociado) {
                            console.log(`üß© PADRE: Mostrando puzzle asociado: ${puzzleAsociado}`);
                            
                            // Mostrar el puzzle despu√©s de un breve retraso
                            setTimeout(() => {
                                // Aqu√≠ ir√≠a la l√≥gica para mostrar el puzzle
                                // Por ahora, solo lo registramos en consola
                                console.log(`üîç PADRE: Mostrando puzzle ${puzzleAsociado}...`);
                                
                                // Notificar al hijo4 para que muestre el puzzle
                                if (iframeHijo4 && iframeHijo4.contentWindow) {
                                    iframeHijo4.contentWindow.postMessage({
                                        type: 'mostrarPuzzle',
                                        puzzleId: puzzleAsociado,
                                        retoId: data.retoId
                                    }, '*');
                                    
                                    // Mostrar el iframe del reto/puzzle
                                    iframeHijo4.style.display = 'block';
                                    console.log(`üîÑ PADRE: Solicitado mostrar puzzle ${puzzleAsociado}`);
                                }
                            }, 1000);
                        } else {
                            // Si no hay puzzle asociado, continuar con el siguiente punto
                            if (typeof avanzarSiguientePunto === 'function') {
                                console.log('üîÑ PADRE: No hay puzzle asociado, continuando con el siguiente punto');
                                avanzarSiguientePunto();
                            }
                        }
                        break;
                        
                    case 'cerrarReto':
                        console.log('üö™ PADRE: Cerrando reto sin completar');
                        // Actualizar estado global
                        actualizarEstadoGlobal({
                            reto: {
                                activo: false,
                                completado: false,
                                id: null,
                                timestamp: Date.now()
                            }
                        });
                        break;
                        
                    case 'solicitarSincronizacion':
                        console.log('üîÑ PADRE: Sincronizaci√≥n solicitada por hijo4');
                        // Enviar estado actual al hijo 4
                        iframe.contentWindow.postMessage({
                            type: 'sincronizarEstado',
                            origen: 'padre',
                            destino: 'hijo4',
                            timestamp: Date.now(),
                            estado: {
                                modo: estadoGlobal.modo || 'aventura',
                                retoActivo: estadoGlobal.datosCompartidos?.reto?.activo || false,
                                retoCompletado: estadoGlobal.datosCompartidos?.reto?.completado || false,
                                paradaActual: estadoGlobal.puntoActual?.id || null,
                                puntoActual: estadoGlobal.puntoActual || null
                            }
                        }, '*');
                        break;
                        
                    case 'cambioModo':
                        console.log(`üîÑ PADRE: Hijo4 notifica cambio de modo a ${data.modo}`);
                        // Actualizar estado global y sincronizar con otros hijos
                        actualizarEstadoGlobal({
                            modo: data.modo,
                            ultimaActualizacion: Date.now()
                        });
                        
                        // Notificar al hijo3 (audio) sobre el cambio de modo
                        const hijo3Modo = document.getElementById('hijo3');
                        if (hijo3Modo && hijo3Modo.contentWindow) {
                            hijo3Modo.contentWindow.postMessage({
                                type: 'cambioModo',
                                modo: data.modo,
                                timestamp: Date.now()
                            }, '*');
                            console.log(`üì§ PADRE: Notificado cambio de modo a hijo3: ${data.modo}`);
                        }
                        break;
                        
                    case 'puzzleCompletado':
                        console.log('üèÖ PADRE: Puzzle completado:', data.puzzleId);
                        
                        // Ocultar el iframe del puzzle
                        const iframePuzzle = document.getElementById('hijo4');
                        if (iframePuzzle) {
                            iframePuzzle.style.display = 'none';
                            console.log('üëã PADRE: Iframe de puzzle oculto');
                        }
                        
                        // Actualizar estado global
                        actualizarEstadoGlobal({
                            reto: {
                                activo: false,
                                completado: true,
                                id: data.retoId,
                                timestamp: Date.now(),
                                puzzleCompletado: true
                            }
                        });
                        
                        // Continuar con el siguiente punto de la ruta
                        if (typeof avanzarSiguientePunto === 'function') {
                            console.log('üîÑ PADRE: Puzzle completado, continuando con el siguiente punto');
                            avanzarSiguientePunto();
                        }
                        break;
                        
                    case 'error':
                        console.error('‚ùå PADRE: Error en hijo 4 (retos):', data.mensaje || 'Error desconocido');
                        mostrarMensajeInfoParada(`Error en retos: ${data.mensaje || 'Error desconocido'}`, true);
                        break;
                        
                    default:
                        console.log('‚ÑπÔ∏è PADRE: Mensaje no manejado de hijo4 (retos):', data);
                }
            } catch (error) {
                console.error('‚ùå PADRE: Error al procesar mensaje de hijo4:', error, data);
            } finally {
                console.groupEnd();
            }
        });
        
        // ================== MANEJADOR DE MENSAJES DEL HIJO 3 (REPRODUCTOR DE AUDIO) ==================
        window.addEventListener('message', function(event) {
            const iframe = document.getElementById('hijo3');
            if (!iframe || event.source !== iframe.contentWindow) return;
            
            const data = event.data;
            if (!data || !data.type) return;
            
            const timestamp = new Date().toISOString();
            console.group(`üéµ PADRE [${timestamp}] - Mensaje de hijo3 (audio): ${data.type}`);
            console.log('üì¶ Datos recibidos:', data);
            console.log('üîó Origen:', event.origin);
            
            try {
                switch(data.type) {
                    case 'hijo3Ready':
                    case 'audio-hijo-listo':
                        console.log('‚úÖ PADRE: Hijo 3 (Reproductor) listo y operativo');
                        // Confirmar recepci√≥n y sincronizar estado actual
                        const respuesta = {
                            type: 'sincronizarEstado',
                            origen: 'padre',
                            destino: 'hijo3',
                            timestamp: Date.now(),
                            estado: {
                                modo: estadoGlobal.modo || 'aventura',
                                puntoActual: estadoGlobal.puntoActual?.id || null,
                                reproduciendo: estadoGlobal.reproduciendoAudio || false
                            }
                        };
                        
                        iframe.contentWindow.postMessage(respuesta, '*');
                        console.log('üîÑ PADRE: Estado sincronizado con hijo3', respuesta.estado);
                        break;
                        
                    case 'estadoReproduccion':
                        console.log('üéµ PADRE: Estado de reproducci√≥n actualizado:', {
                            reproduciendo: data.reproduciendo,
                            paradaActual: data.paradaActual,
                            tiempoActual: data.tiempoActual
                        });
                        
                        // Actualizar estado global
                        actualizarEstadoGlobal({
                            reproduciendoAudio: data.reproduciendo,
                            audioActual: data.paradaActual
                        });
                        
                        // Notificar a otros componentes si es necesario
                        if (data.paradaActual) {
                            // Notificar al hijo4 (retos) sobre el cambio de parada
                            const hijo4 = document.getElementById('hijo4');
                            if (hijo4 && hijo4.contentWindow) {
                                hijo4.contentWindow.postMessage({
                                    type: 'cambioParada',
                                    parada: data.paradaActual,
                                    modo: estadoGlobal.modo,
                                    timestamp: Date.now()
                                }, '*');
                                console.log(`üì§ PADRE: Notificado cambio de parada a hijo4: ${data.paradaActual}`);
                            }
                        }
                        break;
                        
                    case 'solicitarSincronizacion':
                        console.log('üîÑ PADRE: Sincronizaci√≥n solicitada por hijo3');
                        // Enviar estado actual al hijo 3
                        iframe.contentWindow.postMessage({
                            type: 'sincronizarEstado',
                            origen: 'padre',
                            destino: 'hijo3',
                            timestamp: Date.now(),
                            estado: {
                                modo: estadoGlobal.modo || 'aventura',
                                puntoActual: estadoGlobal.puntoActual?.id || null,
                                reproduciendo: estadoGlobal.reproduciendoAudio || false
                            }
                        }, '*');
                        break;
                        
                    case 'error':
                        console.error('‚ùå PADRE: Error en hijo 3 (audio):', data.mensaje || 'Error desconocido');
                        mostrarMensajeInfoParada(`Error en reproductor: ${data.mensaje || 'Error desconocido'}`, true);
                        break;
                        
                    case 'audioFinalizado':
                        console.log('üèÅ PADRE: Audio finalizado:', data.paradaActual);
                        // Notificar a otros componentes que el audio ha terminado
                        if (data.paradaActual) {
                            // Notificar al hijo4 (retos) que el audio ha terminado
                            const hijo4 = document.getElementById('hijo4');
                            if (hijo4 && hijo4.contentWindow) {
                                hijo4.contentWindow.postMessage({
                                    type: 'audioFinalizado',
                                    parada: data.paradaActual,
                                    timestamp: Date.now()
                                }, '*');
                                console.log(`üì§ PADRE: Notificado finalizaci√≥n de audio a hijo4: ${data.paradaActual}`);
                            }
                        }
                        break;
                        
                    case 'cambioModo':
                        console.log(`üîÑ PADRE: Hijo3 notifica cambio de modo a ${data.modo}`);
                        // Actualizar estado global y sincronizar con otros hijos
                        actualizarEstadoGlobal({
                            modo: data.modo,
                            ultimaActualizacion: Date.now()
                        });
                        break;
                        
                    default:
                        console.log('‚ÑπÔ∏è PADRE: Mensaje no manejado de hijo 3 (audio):', data);
                }
            } catch (error) {
                console.error('‚ùå PADRE: Error al procesar mensaje de hijo3:', error, data);
            } finally {
                console.groupEnd();
            }
        });
        
        // ================== FUNCI√ìN PARA VERIFICAR ESTADO DE IFRAMES ==================
        function verificarEstadoIframes() {
            console.group('üîç Estado actual de iframes');
            ['hijo2', 'hijo3', 'hijo4', 'hijo5-casa'].forEach(id => {
                const iframe = document.getElementById(id);
                console.log(`üì∫ ${id}:`, {
                    existe: !!iframe,
                    cargado: iframe?.contentDocument?.readyState === 'complete',
                    src: iframe?.src
                });
            });
            console.groupEnd();
        }

        // ================== MANEJADOR DE MENSAJES DEL HIJO 5 (BOT√ìN CASA) ==================
        // Variable para rastrear si ya hemos inicializado el manejador
        let manejadorHijo5Inicializado = false;
        
        // Funci√≥n para manejar el cambio de parada
        function manejarCambioParada(data) {
            console.log('üîÑ PADRE: Cambio de parada solicitado:', data);
            
            // Normalizar el ID de la parada (aceptar tanto 'P-X' como n√∫mero)
            const idParada = data.id || `P-${data.parada}`;
            const numParada = data.parada || parseInt(idParada.replace('P-', ''));
            
            // Buscar la parada en el array PARADAS
            const parada = PARADAS.find(p => 
                (p.tipo === 'parada' || p.tipo === 'inicio') && 
                (p.parada === numParada || `P-${p.parada}` === idParada)
            );
            
            if (parada) {
                // Actualizar estado global
                window.actualizarEstadoGlobal({
                    puntoActual: {
                        tipo: 'parada',
                        id: `P-${parada.parada}`,
                        numero: parada.parada,
                        nombre: parada.nombre,
                        coordenadas: parada.coordenadas,
                        audio: parada.audio,
                        reto: parada.reto
                    },
                    origen: 'hijo5-casa',
                    timestamp: Date.now()
                });
                
                // Notificar a otros iframes
                const mensaje = {
                    type: 'cambiarParada',
                    parada: parada.parada,
                    id: `P-${parada.parada}`,
                    nombre: parada.nombre,
                    coordenadas: parada.coordenadas,
                    audio: parada.audio,
                    reto: parada.reto,
                    origen: 'padre',
                    timestamp: Date.now()
                };
                
                // Enviar a todos los iframes excepto al que origin√≥ el mensaje
                ['hijo2', 'hijo3', 'hijo4'].forEach(id => {
                    const iframe = document.getElementById(id);
                    if (iframe && iframe.contentWindow) {
                        iframe.contentWindow.postMessage(mensaje, '*');
                    }
                });
                
                console.log(`‚úÖ PADRE: Parada cambiada a P-${parada.parada}: ${parada.nombre}`);
            } else {
                console.error(`‚ùå PADRE: No se encontr√≥ la parada con ID ${idParada} (${numParada})`);
            }
        }
        
        // Funci√≥n para manejar el cambio de tramo
        function manejarCambioTramo(data) {
            console.log('üîÑ PADRE: Cambio de tramo solicitado:', data);
            
            // Normalizar el ID del tramo (aceptar tanto 'TR-X' como n√∫mero)
            const idTramo = data.id || `TR-${data.tramo}`;
            const numTramo = data.tramo || parseInt(idTramo.replace('TR-', ''));
            
            // Buscar el tramo en el array PARADAS
            const tramo = PARADAS.find(p => 
                p.tipo === 'tramo' && 
                (p.tramo === numTramo || `TR-${p.tramo}` === idTramo)
            );
            
            if (tramo) {
                // Actualizar estado global
                window.actualizarEstadoGlobal({
                    puntoActual: {
                        tipo: 'tramo',
                        id: `TR-${tramo.tramo}`,
                        numero: tramo.tramo,
                        nombre: tramo.nombre,
                        inicio: tramo.inicio,
                        fin: tramo.fin,
                        waypoints: tramo.waypoints || [],
                        audio: tramo.audio
                    },
                    origen: 'hijo5-casa',
                    timestamp: Date.now()
                });
                
                // Notificar a otros iframes
                const mensaje = {
                    type: 'cambiarTramo',
                    tramo: tramo.tramo,
                    id: `TR-${tramo.tramo}`,
                    nombre: tramo.nombre,
                    inicio: tramo.inicio,
                    fin: tramo.fin,
                    waypoints: tramo.waypoints || [],
                    audio: tramo.audio,
                    origen: 'padre',
                    timestamp: Date.now()
                };
                
                // Enviar a todos los iframes excepto al que origin√≥ el mensaje
                ['hijo2', 'hijo3', 'hijo4'].forEach(id => {
                    const iframe = document.getElementById(id);
                    if (iframe && iframe.contentWindow) {
                        iframe.contentWindow.postMessage(mensaje, '*');
                    }
                });
                
                console.log(`‚úÖ PADRE: Tramo cambiado a TR-${tramo.tramo}: ${tramo.nombre}`);
            } else {
                console.error(`‚ùå PADRE: No se encontr√≥ el tramo con ID ${idTramo} (${numTramo})`);
            }
        }
        
        // Funci√≥n para bloquear/desbloquear iframes hijos seg√∫n el modo
        function actualizarEstadoIframesHijos(modo) {
            const esModoAventura = modo === 'aventura';
            const iframes = ['hijo2', 'hijo3', 'hijo4'];
            
            iframes.forEach(id => {
                const iframe = document.getElementById(id);
                if (iframe && iframe.contentWindow) {
                    try {
                        // Mensaje de cambio de modo
                        iframe.contentWindow.postMessage({
                            type: 'cambioModo',
                            modo: modo,
                            gpsActivo: esModoAventura,
                            timestamp: Date.now(),
                            origen: 'padre',
                            destino: id
                        }, '*');
                        
                        // Mensaje espec√≠fico para bloquear/desbloquear controles
                        if (id === 'hijo2') {
                            iframe.contentWindow.postMessage({
                                type: 'bloquearControles',
                                bloquear: !esModoAventura,
                                timestamp: Date.now(),
                                origen: 'padre',
                                destino: id
                            }, '*');
                            
                            // Asegurar que el bot√≥n de ubicaci√≥n se actualice
                            iframe.contentWindow.postMessage({
                                type: 'actualizarEstadoBotonUbicacion',
                                activo: esModoAventura,
                                timestamp: Date.now()
                            }, '*');
                        }
                        
                        console.log(`‚úÖ PADRE: Mensajes de ${modo} enviados a ${id}`);
                    } catch (error) {
                        console.error(`‚ùå PADRE: Error al actualizar estado de ${id}:`, error);
                    }
                }
            });
            
            // Notificar al hijo5-casa sobre el cambio de modo
            const hijo5 = document.getElementById('hijo5-casa');
            if (hijo5 && hijo5.contentWindow) {
                hijo5.contentWindow.postMessage({
                    type: 'actualizarEstadoGPS',
                    gpsActivo: esModoAventura,
                    modo: modo,
                    timestamp: Date.now()
                }, '*');
            }
            
            console.log(`üîÑ PADRE: Estado de iframes actualizado a modo '${modo}'`);
        }

        // Funci√≥n para manejar los mensajes del hijo5-casa
        function manejarMensajeHijo5(event) {
            // Verificar si el mensaje es del hijo5-casa
            const iframeHijo5 = document.getElementById('hijo5-casa');
            
            // Verificaci√≥n m√°s estricta del origen del mensaje
            const esDeHijo5 = iframeHijo5 && 
                             event.source === iframeHijo5.contentWindow && 
                             event.origin === window.location.origin;
            
            if (!esDeHijo5) {
                // Si no es del hijo5-casa, salir sin hacer nada
                return;
            }
            
            console.log('üîç PADRE: Mensaje recibido de hijo5-casa:', event.data);
            
            // Prevenir el comportamiento por defecto del evento si es cancelable
            if (event.cancelable) {
                event.preventDefault();
            }
            
            // Detener la propagaci√≥n para evitar que otros manejadores procesen este mensaje
            event.stopImmediatePropagation();
            
            // Marcar que hemos manejado este mensaje
            event.handledByHijo5 = true;
            
            // Log detallado de los mensajes recibidos
            const timestamp = new Date().toISOString();
            const origen = event.origin || 'unknown-origin';
            const data = event.data || {};
            
            // Normalizar el tipo de mensaje (aceptar tanto 'type' como 'tipo')
            const tipoMensaje = data.type || data.tipo;
            
            console.group(`üì® PADRE [${timestamp}] - Mensaje de hijo5-casa (${origen})`);
            console.log('üì¶ Datos recibidos:', data);
            console.log('üîó Origen del mensaje:', origen);
            
            // Funci√≥n auxiliar mejorada para reenviar mensajes a otros iframes
            const reenviarAMensaje = (tipoDestino, mensaje) => {
                // Si el destino es 'todos', enviar a todos los hijos
                const destinos = tipoDestino === 'todos' 
                    ? ['hijo2', 'hijo3', 'hijo4'] 
                    : [tipoDestino];
                
                let exitosos = 0;
                const errores = [];
                
                destinos.forEach(dest => {
                    const destino = document.getElementById(dest);
                    if (destino && destino.contentWindow) {
                        try {
                            // Asegurarse de que el mensaje tenga un timestamp
                            const mensajeConTimestamp = {
                                ...mensaje,
                                timestamp: Date.now(),
                                origen: 'padre',
                                destino: dest
                            };
                            
                            console.log(`üîÑ PADRE: Reenviando a ${dest}:`, mensajeConTimestamp);
                            destino.contentWindow.postMessage(mensajeConTimestamp, '*');
                            exitosos++;
                        } catch (error) {
                            console.error(`‚ùå PADRE: Error al enviar a ${dest}:`, error);
                            errores.push(dest);
                        }
                    } else {
                        console.warn(`‚ö†Ô∏è PADRE: No se pudo reenviar a ${dest} - Iframe no encontrado`);
                        errores.push(dest);
                    }
                });
                
                // Devolver resumen de la operaci√≥n
                return {
                    exitosos,
                    total: destinos.length,
                    errores: errores.length,
                    destinosConError: errores
                };
            };
            
            // Manejar mensajes de cambio de estado del GPS
            if (tipoMensaje === 'GPS_STATE_CHANGE') {
                console.log(`üîÑ PADRE: Cambio de estado del GPS recibido: ${data.gpsOn ? 'ENCENDIDO' : 'APAGADO'}`);
                const modo = data.gpsOn ? 'aventura' : 'casa';
                
                // Actualizar estado global
                window.actualizarEstadoGlobal({
                    modo: modo,
                    gpsActivo: data.gpsOn,
                    ultimaActualizacion: Date.now()
                });
                
                // Actualizar estado de los iframes hijos
                actualizarEstadoIframesHijos(modo);
                
                // Si el GPS se apaga, forzar la actualizaci√≥n de la ventana de selecci√≥n
                if (!data.gpsOn) {
                    const hijo5 = document.getElementById('hijo5-casa');
                    if (hijo5 && hijo5.contentWindow) {
                        hijo5.contentWindow.postMessage({
                            type: 'forzarActualizacionVentana',
                            mostrar: true,
                            timestamp: Date.now()
                        }, '*');
                    }
                }
                
                return; // Salir despu√©s de manejar el cambio de estado
            }
            
            // Manejar mensajes que pueden venir con o sin tipo
            if (!tipoMensaje || data.type?.startsWith('mensaje-para-')) {
                console.log('üîç PADRE: Procesando mensaje especial de hijo5-casa...');
                
                // Caso 1: Mensaje directo a un hijo espec√≠fico (formato: {type: 'mensaje-para-hijoX', ...})
                if (tipoMensaje?.startsWith('mensaje-para-')) {
                    const tipoDestino = tipoMensaje.replace('mensaje-para-', '');
                    console.log(`üîÑ PADRE: Reenviando mensaje directo a ${tipoDestino}`, data);
                    const resultado = reenviarAMensaje(tipoDestino, data);
                    console.log(`üìä PADRE: Resultado del reenv√≠o: ${resultado.exitosos}/${resultado.total} exitosos`);
                    console.groupEnd();
                    return;
                } 
                
                // Caso 2: Mensaje estructurado (formato: {tipo: 'mensaje-para-hijoX', mensaje: {...}})
                if (data.tipo && data.mensaje) {
                    const tipoDestino = data.tipo.replace('mensaje-para-', '');
                    console.log(`üîÑ PADRE: Reenviando mensaje estructurado a ${tipoDestino}`, data.mensaje);
                    const resultado = reenviarAMensaje(tipoDestino, data.mensaje);
                    console.log(`üìä PADRE: Resultado del reenv√≠o: ${resultado.exitosos}/${resultado.total} exitosos`);
                    console.groupEnd();
                    return;
                } 
                
                // Caso 3: Mensaje con destino expl√≠cito (formato: {destino: 'hijoX', datos: {...}})
                if (data.destino && data.datos) {
                    console.log(`üîÑ PADRE: Reenviando mensaje a ${data.destino}`, data.datos);
                    const resultado = reenviarAMensaje(data.destino, data.datos);
                    console.log(`üìä PADRE: Resultado del reenv√≠o: ${resultado.exitosos}/${resultado.total} exitosos`);
                    console.groupEnd();
                    return;
                }
                
                // Caso 4: Mensaje para todos los hijos (broadcast)
                if (data.broadcast === true) {
                    console.log('üì£ PADRE: Enviando mensaje de difusi√≥n a todos los hijos', data.datos || data);
                    const mensajeBroadcast = data.datos || data;
                    const resultado = reenviarAMensaje('todos', mensajeBroadcast);
                    console.log(`üìä PADRE: Resultado del broadcast: ${resultado.exitosos}/${resultado.total} exitosos`);
                    if (resultado.errores > 0) {
                        console.warn(`‚ö†Ô∏è PADRE: Errores en el env√≠o a: ${resultado.destinosConError.join(', ')}`);
                    }
                    console.groupEnd();
                    return;
                }
                
                // Si no coincide con ning√∫n formato conocido
                console.warn('‚ö†Ô∏è PADRE: No se pudo determinar el destino del mensaje - Formato no reconocido');
                console.groupEnd();
                return;
            }
            
            console.log('üìå Tipo de mensaje:', tipoMensaje);
            console.groupEnd();
            
            // Normalizar el tipo de mensaje
            data.type = tipoMensaje;
            
            try {
                switch(data.type) {
                    case 'hijo5Ready':
                    case 'casa-hijo-listo':
                    case 'sincronizarEstado':
                        console.log('üîÑ PADRE: Sincronizando estado con hijo5-casa...');
                        
                        // Obtener el estado actual normalizado
                        const estadoActual = {
                            modo: window.estadoGlobal?.modo || 'aventura',
                            puntoActual: null,
                            ultimaActualizacion: Date.now()
                        };
                        
                        // Asegurar que el punto actual tenga un ID consistente
                        if (window.estadoGlobal?.puntoActual) {
                            const punto = window.estadoGlobal.puntoActual;
                            if (punto.tipo === 'parada') {
                                estadoActual.puntoActual = {
                                    ...punto,
                                    id: `P-${punto.numero || punto.parada}`,
                                    tipo: 'parada',
                                    numero: punto.numero || punto.parada
                                };
                            } else if (punto.tipo === 'tramo') {
                                estadoActual.puntoActual = {
                                    ...punto,
                                    id: `TR-${punto.numero || punto.tramo}`,
                                    tipo: 'tramo',
                                    numero: punto.numero || punto.tramo
                                };
                            }
                        }
                        
                        // Enviar estado actualizado al hijo5-casa
                        iframe.contentWindow.postMessage({ 
                            type: 'sincronizarEstado',
                            origen: 'padre',
                            destino: 'hijo5-casa',
                            mensaje: 'Estado sincronizado',
                            timestamp: Date.now(),
                            estado: estadoActual,
                            datos: {
                                tipo: 'respuestaSincronizacion',
                                origen: 'padre',
                                modo: estadoActual.modo,
                                gpsActivo: estadoActual.modo === 'aventura',
                                puntoActual: estadoActual.puntoActual
                            }
                        }, '*');
                        
                        console.log('‚úÖ PADRE: Estado sincronizado con hijo5-casa', estadoActual);
                        break;
                        
                    case 'cambioModo':
                        console.log(`üîÑ PADRE: Cambio de modo solicitado: ${data.modo}`, data);
                        // Actualizar estado global
                        if (window.actualizarEstadoGlobal) {
                            window.actualizarEstadoGlobal({
                                modo: data.modo, // 'casa' o 'aventura'
                                origen: 'hijo5-casa',
                                timestamp: Date.now()
                            });
                            
                            // Notificar a todos los hijos sobre el cambio de modo
                            const iframes = ['hijo2', 'hijo3', 'hijo4', 'hijo5-casa'];
                            iframes.forEach(id => {
                                const targetIframe = document.getElementById(id);
                                if (targetIframe && targetIframe.contentWindow) {
                                    try {
                                        targetIframe.contentWindow.postMessage({
                                            type: 'cambioModo',
                                            modo: data.modo,
                                            origen: 'padre',
                                            timestamp: Date.now()
                                        }, '*');
                                        console.log(`‚úÖ PADRE: Notificado cambio de modo a ${id}`);
                                    } catch (error) {
                                        console.error(`‚ùå PADRE: Error notificando a ${id}:`, error);
                                    }
                                }
                            });
                            
                            // Confirmar el cambio al hijo5-casa
                            iframe.contentWindow.postMessage({
                                type: 'confirmacionModo',
                                origen: 'padre',
                                destino: 'hijo5-casa',
                                modo: data.modo,
                                timestamp: Date.now()
                            }, '*');
                        }
                        break;
                        
                    case 'expandirIframe':
                        console.log(`üìè PADRE: Solicitando expansi√≥n del iframe a ${data.width}`, data);
                        // Ajustar el ancho y alto del iframe hijo5-casa
                        if (data.width && !isNaN(parseInt(data.width))) {
                            iframe.style.width = `${data.width}px`;
                            // Asegurar que el iframe tenga suficiente altura para mostrar el contenido
                            iframe.style.height = '250px'; // O el valor que necesites
                            console.log(`‚úÖ PADRE: Iframe hijo5-casa ajustado a ${data.width}px x 250px`);
                        }
                        break;
                        
                    case 'error':
                        console.error('‚ùå PADRE: Error en hijo5-casa:', data.mensaje || 'Error desconocido', data);
                        if (window.mostrarMensajeInfoParada) {
                            window.mostrarMensajeInfoParada(`Error en bot√≥n casa: ${data.mensaje || 'Error desconocido'}`, true);
                        }
                        break;
                        
                    case 'solicitarSincronizacion':
                        console.log('üîÑ PADRE: Sincronizaci√≥n solicitada por hijo5-casa');
                        // Enviar estado actual al hijo 5
                        iframe.contentWindow.postMessage({
                            type: 'sincronizarEstado',
                            origen: 'padre',
                            destino: 'hijo5-casa',
                            timestamp: Date.now(),
                            estado: {
                                modo: window.estadoGlobal?.modo || 'aventura',
                                paradaActual: window.estadoGlobal?.paradaActual,
                                ultimaActualizacion: window.estadoGlobal?.ultimaActualizacion || Date.now()
                            }
                        }, '*');
                        break;
                        
                    default:
                        console.log(`‚ÑπÔ∏è PADRE: Mensaje no manejado de hijo5-casa:`, data);
                }
            } catch (error) {
                console.error('‚ùå PADRE: Error al procesar mensaje de hijo5-casa:', error, '\nMensaje:', data);
            }
        };
        
        // Funci√≥n para inicializar el manejador de mensajes del hijo5-casa
        function inicializarManejadorHijo5() {
            // Si ya est√° inicializado, no hacer nada
            if (manejadorHijo5Inicializado) {
                console.log('‚ÑπÔ∏è Manejador de hijo5-casa ya estaba inicializado');
                return;
            }
            
            console.log('üîÑ Inicializando manejador de mensajes para hijo5-casa...');
            
            // Primero, eliminar cualquier manejador existente para evitar duplicados
            window.removeEventListener('message', manejarMensajeHijo5);
            
            // Luego, agregar el manejador
            window.addEventListener('message', manejarMensajeHijo5, { 
                capture: true,  // Capturar el evento en la fase de captura
                passive: true   // Mejorar rendimiento
            });
            
            // Marcar como inicializado
            manejadorHijo5Inicializado = true;
            
            console.log('‚úÖ Manejador de mensajes del hijo5-casa inicializado correctamente');
        }
        
        // Inicializar el iframe hijo5-casa
        function inicializarIframeHijo5() {
            const iframeHijo5 = document.getElementById('hijo5-casa');
            if (!iframeHijo5) {
                console.error('‚ùå No se encontr√≥ el iframe hijo5-casa');
                return;
            }
            
            // Verificar si ya tiene una URL para evitar recargas innecesarias
            if (iframeHijo5.src) {
                console.log('‚ÑπÔ∏è El iframe hijo5-casa ya tiene una URL asignada');
                return;
            }
            
            // Asignar la URL del iframe
            iframeHijo5.src = 'Av1-boton-casa.html';
            console.log('üîÑ Inicializando iframe hijo5-casa con URL:', iframeHijo5.src);
            
            // Configurar atributos importantes
            iframeHijo5.setAttribute('name', 'hijo5-casa');
            iframeHijo5.setAttribute('id', 'hijo5-casa');
            iframeHijo5.setAttribute('allow', 'geolocation');
        }
        
        // Inicializar todo cuando el DOM est√© listo
        function inicializarAplicacionHijo5() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    inicializarManejadorHijo5();
                    inicializarIframeHijo5();
                });
            } else {
                // Si el DOM ya est√° listo, inicializar inmediatamente
                setTimeout(() => {
                    inicializarManejadorHijo5();
                    inicializarIframeHijo5();
                }, 0);
            }
        }
        
        // Iniciar la aplicaci√≥n
        inicializarAplicacionHijo5();

        // Hacer que las funciones est√©n disponibles globalmente
        window.actualizarEstadoGlobal = actualizarEstadoGlobal;
        window.enviarMensaje = enviarMensaje;
        window.manejarMensajeHijo2 = manejarMensajeHijo2;
        window.manejarMensajeHijo3 = manejarMensajeHijo3;
        window.manejarMensajeHijo4 = manejarMensajeHijo4;
        window.manejarRetoCompletado = manejarRetoCompletado;
        window.avanzarSiguientePunto = avanzarSiguientePunto;
    
        // Inicializar la aplicaci√≥n
        inicializarAplicacionHijo5();
    </script>
</body>
</html>
