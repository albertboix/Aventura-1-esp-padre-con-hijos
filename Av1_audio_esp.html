<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor de Audio - Aventura 1</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --btn-size: 60px;
            --icon-size: 1.5em;
            --progress-thick: 20px;
            --trapecio-width: 290px;
            --trapecio-height: 155px;
            --trapecio-bg: white;
            --trapecio-shadow: 0 2px 12px rgba(0,0,0,0.13);
            --trapecio-radius: 15px;
            --progress-color: #0077cc;
            --progress-bg: #e0e0e0;
            --timer-font-size: 1.1em;
            --timer-color: #333;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: transparent !important;
        }

        body {
            font-family: "Book Antiqua", "Palatino Linotype", Palatino, Georgia, serif;
            margin: 0;
            padding: 0;
            background: transparent !important;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }

        .audio-player-controls {
            width: var(--trapecio-width);
            max-width: 98vw;
            min-width: 180px;
            height: var(--trapecio-height);
            background: var(--trapecio-bg);
            clip-path: polygon(8% 0%, 92% 0%, 100% 100%, 0% 100%);
            border-radius: var(--trapecio-radius);
            box-shadow: var(--trapecio-shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            gap: 0.1em;
            z-index: 1200;
            padding: 5px 8px 5px 8px;
            box-sizing: border-box;
            border: none;
            margin: 5px 0;
        }

        .player-buttons-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 2px;
        }

        #playPauseBtn {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            padding: 0;
        }

        #playPauseBtn .icon-play {
            color: white;
            font-weight: bold;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        #playPauseBtn:active:not(:disabled) { 
            transform: scale(0.95); 
        }

        #playPauseBtn.active {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            border: none;
        }

        #playPauseBtn:disabled { 
            background: linear-gradient(135deg, #dc3545, #c82333);
            opacity: 0.6;
            cursor: not-allowed; 
            border: none;
        }

        #retosBtn {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            padding: 0;
        }

        #retosBtn .icon-puzzle {
            color: white;
            font-weight: bold;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        #retosBtn:disabled { 
            background: linear-gradient(135deg, #999, #666);
            cursor: not-allowed; 
            opacity: 0.6;
        }

        #retosBtn:active:not(:disabled) { 
            transform: scale(0.95); 
        }

        .progress-row {
            display: flex;
            align-items: center;
            width: 90%;
            margin: 0 0 5px 0;
            padding: 0;
            justify-content: center;
        }

        .progress-container {
            flex: 1;
            width: 100%;
            height: var(--progress-thick);
            background-color: #f0f0f0;
            border-radius: calc(var(--progress-thick) / 2);
            cursor: pointer;
            position: relative;
            margin: 0;
            min-width: 0;
            overflow: visible;
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        #progressBar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #28a745, #1e7e34);
            border-radius: calc(var(--progress-thick) / 2);
            transition: width 0.1s linear;
            position: relative;
        }

        #progressBar::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff;
            border: 3px solid white;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
            display: block;
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        #playPauseBtn:disabled ~ .progress-row #progressBar::after {
            opacity: 0;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            width: 90%;
            font-size: var(--timer-font-size);
            color: var(--timer-color);
            margin-top: 2px;
            font-weight: 500;
        }

        .time-display span {
            font-variant-numeric: tabular-nums;
        }

        /* Estilos para el modo casa (ocultar controles) */
        body.modo-casa .audio-player-controls {
            display: none;
        }

        /* Estilos para el modo aventura (mostrar controles) */
        body.modo-aventura .audio-player-controls {
            display: flex;
        }
    </style>
</head>
<body class="modo-aventura">
    <div class="audio-player-controls">
        <div class="player-buttons-row">
            <button id="playPauseBtn" aria-label="Reproducir/Pausar">
                <i class="fas fa-play icon-play"></i>
            </button>
            <button id="retosBtn" aria-label="Retos">
                <i class="fas fa-puzzle-piece icon-puzzle"></i>
            </button>
        </div>
        <div class="progress-row">
            <div class="progress-container" id="progressContainer">
                <div id="progressBar"></div>
            </div>
        </div>
        <div class="time-display">
            <span id="currentTime">00:00</span>
            <span id="duration">00:00</span>
        </div>
    </div>

    <audio id="audioPlayer" preload="metadata">
        Tu navegador no soporta el elemento de audio.
    </audio>

    <script type="module">
        // Constantes y variables globales
        let audioPlayer;
        let playPauseBtn;
        let retosBtn;
        let progressBar;
        let progressContainer;
        let currentTimeElement;
        let durationElement;
        let isPlaying = false;
        let controlsDisabled = false;
        const IFRAME_ID = 'audioPlayerIframe';

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Inicializar elementos del DOM
                audioPlayer = document.getElementById('audioPlayer');
                playPauseBtn = document.getElementById('playPauseBtn');
                retosBtn = document.getElementById('retosBtn');
                progressBar = document.getElementById('progressBar');
                progressContainer = document.getElementById('progressContainer');
                currentTimeElement = document.getElementById('currentTime');
                durationElement = document.getElementById('duration');

                // Configurar manejadores de eventos
                setupEventListeners();
                
                console.log(`[${IFRAME_ID}] Reproductor de audio inicializado`);
            } catch (error) {
                console.error(`[${IFRAME_ID}] Error al inicializar el reproductor de audio:`, error);
            }
        });

        // Configurar manejadores de eventos
        function setupEventListeners() {
            // Botón de reproducción/pausa
            playPauseBtn.addEventListener('click', togglePlayPause);
            
            // Botón de retos
            retosBtn.addEventListener('click', handleRetosClick);
            
            // Barra de progreso
            progressContainer.addEventListener('click', handleProgressClick);
            
            // Eventos del reproductor de audio
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('loadedmetadata', updateDuration);
            audioPlayer.addEventListener('ended', handleAudioEnded);
            audioPlayer.addEventListener('play', handlePlay);
            audioPlayer.addEventListener('pause', handlePause);
            audioPlayer.addEventListener('error', handleAudioError);
            
            // Eventos de teclado para accesibilidad
            document.addEventListener('keydown', handleKeyDown);
        }

        // Alternar entre reproducir y pausar
        function togglePlayPause() {
            if (controlsDisabled) return;
            
            if (audioPlayer.paused) {
                audioPlayer.play().catch(error => {
                    console.error('Error al reproducir audio:', error);
                });
            } else {
                audioPlayer.pause();
            }
        }

        // Manejar clic en la barra de progreso
        function handleProgressClick(event) {
            if (controlsDisabled) return;
            
            const rect = progressContainer.getBoundingClientRect();
            const pos = (event.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = pos * audioPlayer.duration;
        }

        // Actualizar la barra de progreso
        function updateProgress() {
            const { currentTime, duration } = audioPlayer;
            const progressPercent = (currentTime / duration) * 100;
            progressBar.style.width = `${progressPercent}%`;
            currentTimeElement.textContent = formatTime(currentTime);
        }

        // Actualizar la duración del audio
        function updateDuration() {
            durationElement.textContent = formatTime(audioPlayer.duration);
        }

        // Formatear tiempo (segundos a MM:SS)
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            seconds = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Manejar el final del audio
        function handleAudioEnded() {
            isPlaying = false;
            updatePlayPauseButton();
            notificarEstado('reproduccion_terminada', {
                tiempoActual: audioPlayer.currentTime,
                duracion: audioPlayer.duration
            }).catch(console.error);
        }

        // Manejar el evento de reproducción
        function handlePlay() {
            isPlaying = true;
            updatePlayPauseButton();
            notificarEstado('reproduccion_iniciada', {
                tiempoActual: audioPlayer.currentTime,
                duracion: audioPlayer.duration
            }).catch(console.error);
        }

        // Manejar el evento de pausa
        function handlePause() {
            isPlaying = false;
            updatePlayPauseButton();
            notificarEstado('reproduccion_pausada', {
                tiempoActual: audioPlayer.currentTime,
                duracion: audioPlayer.duration
            }).catch(console.error);
        }

        // Manejar errores de audio
        function handleAudioError() {
            console.error('Error de audio:', audioPlayer.error);
            notificarError('audio', {
                error: audioPlayer.error ? audioPlayer.error.message : 'Error desconocido',
                tiempoActual: audioPlayer.currentTime,
                duracion: audioPlayer.duration
            }).catch(console.error);
        }

        // Actualizar el botón de reproducción/pausa
        function updatePlayPauseButton() {
            const icon = playPauseBtn.querySelector('i');
            if (isPlaying) {
                icon.classList.remove('fa-play');
                icon.classList.add('fa-pause');
            } else {
                icon.classList.remove('fa-pause');
                icon.classList.add('fa-play');
            }
        }

        // Manejar clic en el botón de retos
        function handleRetosClick() {
            if (controlsDisabled) return;
            
            // Notificar al padre que se hizo clic en el botón de retos
            notificarEstado('boton_retos_presionado', {
                tiempoActual: audioPlayer.currentTime,
                duracion: audioPlayer.duration
            }).catch(console.error);
        }

        // Manejar teclas de acceso rápido
        function handleKeyDown(event) {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return; // No hacer nada si el foco está en un campo de entrada
            }
            
            switch (event.key) {
                case ' ':
                case 'k':
                    event.preventDefault();
                    togglePlayPause();
                    break;
                case 'm':
                    event.preventDefault();
                    audioPlayer.muted = !audioPlayer.muted;
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
                    break;
                case 'ArrowRight':
                    event.preventDefault();
                    audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 5);
                    break;
                case '0':
                case '1':
                case '2':
                case '3':
                case '4':
                case '5':
                case '6':
                case '7':
                case '8':
                case '9':
                    event.preventDefault();
                    const percent = parseInt(event.key) / 10;
                    audioPlayer.currentTime = percent * audioPlayer.duration;
                    break;
            }
        }

        // Notificar el estado actual al padre
        function notificarEstado(accion, datos = {}) {
            if (window.parent && window.parent !== window) {
                return new Promise((resolve, reject) => {
                    try {
                        window.parent.postMessage({
                            tipo: 'audio',
                            datos: { accion, ...datos }
                        }, '*');
                        resolve();
                    } catch (error) {
                        console.error('Error al notificar estado:', error);
                        reject(error);
                    }
                });
            }
            return Promise.resolve();
        }

        // Notificar un error
        function notificarError(tipo, detalles = {}) {
            console.error(`[${IFRAME_ID}] Error:`, tipo, detalles);
            return notificarEstado('error', { tipo, ...detalles });
        }

        // API pública para controlar el reproductor
        window.reproductorAudio = {
            // Reproducir un archivo de audio
            reproducir: async (archivo) => {
                try {
                    if (archivo) {
                        audioPlayer.src = archivo;
                        await audioPlayer.play();
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error al reproducir audio:', error);
                    notificarError('reproducir', { error: error.message });
                    throw error;
                }
            },
            
            // Pausar la reproducción
            pausar: () => {
                try {
                    audioPlayer.pause();
                    return true;
                } catch (error) {
                    console.error('Error al pausar audio:', error);
                    notificarError('pausar', { error: error.message });
                    throw error;
                }
            },
            
            // Detener la reproducción
            detener: () => {
                try {
                    audioPlayer.pause();
                    audioPlayer.currentTime = 0;
                    isPlaying = false;
                    updatePlayPauseButton();
                    return true;
                } catch (error) {
                    console.error('Error al detener audio:', error);
                    notificarError('detener', { error: error.message });
                    throw error;
                }
            },
            
            // Establecer el tiempo de reproducción
            establecerTiempo: (tiempo) => {
                try {
                    if (typeof tiempo === 'number') {
                        audioPlayer.currentTime = tiempo;
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error al establecer tiempo:', error);
                    notificarError('tiempo', { 
                        error: error.message, 
                        tiempoSolicitado: tiempo,
                        tiempoActual: audioPlayer.currentTime
                    });
                    throw error;
                }
            },
            
            // Habilitar o deshabilitar controles
            habilitarControles: (habilitar) => {
                controlsDisabled = !habilitar;
                playPauseBtn.disabled = controlsDisabled;
                retosBtn.disabled = controlsDisabled;
                return true;
            },
            
            // Cambiar entre modos de interfaz
            cambiarModo: (modo) => {
                const esModoCasa = modo === 'casa';
                document.body.classList.toggle('modo-casa', esModoCasa);
                document.body.classList.toggle('modo-aventura', !esModoCasa);
                
                // Notificar el cambio de modo
                notificarEstado('modo_cambiado', {
                    modo: esModoCasa ? 'casa' : 'aventura'
                }).catch(console.error);
                
                return true;
            },
            
            // Obtener el estado actual del reproductor
            obtenerEstado: () => {
                return {
                    reproduciendo: !audioPlayer.paused,
                    tiempoActual: audioPlayer.currentTime,
                    duracion: audioPlayer.duration,
                    volumen: audioPlayer.volume,
                    silenciado: audioPlayer.muted,
                    controlesHabilitados: !controlsDisabled
                };
            },
            
            // Establecer el volumen
            establecerVolumen: async (volumen) => {
                try {
                    if (typeof volumen === 'number' && volumen >= 0 && volumen <= 1) {
                        audioPlayer.volume = volumen;
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error al establecer volumen:', error);
                    notificarError('volumen', { 
                        error: error.message,
                        volumenSolicitado: volumen,
                        volumenActual: audioPlayer.volume
                    });
                    throw error;
                }
            }
        };

        // Manejar mensajes entrantes
        function manejarMensajeAudio(mensaje) {
            const { accion, parametros = {} } = mensaje.datos || {};
            console.log(`[${IFRAME_ID}] Mensaje de audio recibido:`, { accion, parametros });
            
            try {
                switch (accion) {
                    case 'reproducir':
                        return window.reproductorAudio.reproducir(parametros.archivo);
                    case 'pausar':
                        return window.reproductorAudio.pausar();
                    case 'detener':
                        return window.reproductorAudio.detener();
                    case 'establecer_volumen':
                        return window.reproductorAudio.establecerVolumen(parametros.volumen);
                    case 'solicitar_estado':
                        return Promise.resolve(window.reproductorAudio.obtenerEstado());
                    case 'habilitar_controles':
                        return Promise.resolve(window.reproductorAudio.habilitarControles(true));
                    case 'deshabilitar_controles':
                        return Promise.resolve(window.reproductorAudio.habilitarControles(false));
                    case 'cambiar_modo':
                        return Promise.resolve(window.reproductorAudio.cambiarModo(parametros.modo));
                    default:
                        console.warn(`[${IFRAME_ID}] Acción no reconocida:`, accion);
                        return Promise.reject(new Error(`Acción no reconocida: ${accion}`));
                }
            } catch (error) {
                console.error(`[${IFRAME_ID}] Error al procesar mensaje:`, error);
                return Promise.reject(error);
            }
        }

        // Escuchar mensajes del padre
        window.addEventListener('message', (event) => {
            // Verificar el origen del mensaje si es necesario
            // if (event.origin !== 'https://origen-permitido.com') return;
            
            const { tipo, datos } = event.data || {};
            
            if (tipo === 'audio') {
                manejarMensajeAudio({ datos })
                    .catch(error => {
                        console.error('Error al manejar mensaje de audio:', error);
                    });
            }
        });

        // Inicializar el reproductor cuando el script se cargue
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePlayer);
        } else {
            setTimeout(initializePlayer, 0);
        }

        function initializePlayer() {
            // Notificar que el reproductor está listo
            notificarEstado('reproductor_listo');
            console.log(`[${IFRAME_ID}] Reproductor de audio inicializado`);
        }
    </script>
</body>
</html>
