<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor de Audio - Aventura 1</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #3a5a80;
            --accent-color: #ff9800;
            --text-color: #333;
            --light-gray: #f5f5f5;
            --dark-gray: #666;
            --progress-thick: 20px;
            --timer-font-size: 1.1em;
        }

        body {
            margin: 0;
            padding: 10px;
            font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif;
            background: transparent;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }

        .audio-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .track-info {
            text-align: center;
            margin-bottom: 15px;
        }

        .track-title {
            font-size: 1.2em;
            font-weight: bold;
            margin: 0 0 5px 0;
        }

        .track-location {
            font-size: 0.9em;
            color: var(--dark-gray);
            margin: 0;
        }

        .progress-container {
            width: 100%;
            margin: 10px 0;
        }

        .progress-bar {
            width: 100%;
            height: var(--progress-thick);
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }

        .progress {
            height: 100%;
            background-color: var(--accent-color);
            width: 0%;
            transition: width 0.1s linear;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: var(--timer-font-size);
            margin-top: 5px;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 15px 0;
        }

        .control-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .control-btn:hover:not(:disabled) {
            background: var(--secondary-color);
            transform: scale(1.05);
        }

        .play-btn {
            width: 60px;
            height: 60px;
            font-size: 1.5em;
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .volume-slider {
            flex-grow: 1;
            height: 5px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            border-radius: 5px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        .disabled-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2em;
            text-align: center;
            z-index: 1000;
            display: none;
        }


    </style>
</head>
<body>

    <div class="audio-container">
        <div class="track-info">
            <div class="track-title" id="trackTitle">Título de la pista</div>
            <div class="track-location" id="trackLocation">Ubicación actual</div>
        </div>

        <div class="progress-container">
            <div class="progress-bar" id="progressBar">
                <div class="progress" id="progress"></div>
            </div>
            <div class="time-display">
                <span id="currentTime">0:00</span>
                <span id="duration">0:00</span>
            </div>
        </div>

        <div class="controls">
            <button class="control-btn" id="prevBtn" title="Pista anterior">
                <i class="fas fa-step-backward"></i>
            </button>
            <button class="control-btn play-btn" id="playPauseBtn" title="Reproducir/Pausar">
                <i class="fas fa-play"></i>
            </button>
            <button class="control-btn" id="nextBtn" title="Siguiente pista">
                <i class="fas fa-step-forward"></i>
            </button>
        </div>

        <div class="volume-container">
            <i class="fas fa-volume-down"></i>
            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.1" value="0.8">
            <i class="fas fa-volume-up"></i>
        </div>
    </div>

    <script>
        // Variables globales
        let audio = new Audio();
        let isPlaying = false;
        let currentTrackIndex = 0;
        let audioEnabled = true; // Audio siempre habilitado
        let audioTracks = [];

        // Elementos del DOM
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const volumeSlider = document.getElementById('volumeSlider');
        const trackTitle = document.getElementById('trackTitle');
        const trackLocation = document.getElementById('trackLocation');


        // Inicialización
        function init() {
            // Event listeners
            playPauseBtn.addEventListener('click', togglePlayPause);
            prevBtn.addEventListener('click', playPrevious);
            nextBtn.addEventListener('click', playNext);
            progressBar.addEventListener('click', setProgress);
            volumeSlider.addEventListener('input', setVolume);
            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('ended', playNext);
            audio.addEventListener('loadedmetadata', updateTrackInfo);
            audio.addEventListener('play', () => { isPlaying = true; updatePlayPauseIcon(); });
            audio.addEventListener('pause', () => { isPlaying = false; updatePlayPauseIcon(); });
            
            // Inicializar volumen
            audio.volume = volumeSlider.value;
            
            // Notificar al padre que el reproductor está listo
            enviarAlPadre({ type: 'audio-hijo-listo' });
            
            // Inicialmente deshabilitado
            disableAudio();
        }

        // Funciones de control de audio
        function togglePlayPause() {
            if (!audioEnabled) return;
            
            if (isPlaying) {
                audio.pause();
            } else {
                audio.play().catch(e => console.error("Error al reproducir:", e));
            }
        }

        function playTrack(index) {
            if (index < 0 || index >= audioTracks.length) return;
            
            currentTrackIndex = index;
            const track = audioTracks[index];
            
            audio.src = track.src;
            audio.load();
            audio.play().catch(e => console.error("Error al reproducir pista:", e));
            
            // Actualizar la interfaz
            trackTitle.textContent = track.title || `Pista ${index + 1}`;
            trackLocation.textContent = track.location || '';
            
            // Notificar al padre sobre el cambio de pista
            enviarAlPadre({ 
                type: 'audio-track-changed',
                index: currentTrackIndex,
                track: track
            });
        }

        function playNext() {
            if (currentTrackIndex < audioTracks.length - 1) {
                playTrack(currentTrackIndex + 1);
            } else {
                // Si es la última pista, detener la reproducción
                audio.pause();
                audio.currentTime = 0;
                isPlaying = false;
                updatePlayPauseIcon();
            }
        }

        function playPrevious() {
            if (audio.currentTime > 3) {
                // Si han pasado más de 3 segundos, reiniciar la pista actual
                audio.currentTime = 0;
            } else if (currentTrackIndex > 0) {
                // Si no, ir a la pista anterior
                playTrack(currentTrackIndex - 1);
            }
        }

        // Funciones de la interfaz de usuario
        function updateProgress() {
            const { duration, currentTime } = audio;
            const progressPercent = (currentTime / duration) * 100;
            progress.style.width = `${progressPercent}%`;
            
            // Actualizar tiempos
            currentTimeEl.textContent = formatTime(currentTime);
            
            // Solo actualizar la duración si es un número válido
            if (!isNaN(duration)) {
                durationEl.textContent = formatTime(duration);
            }
        }

        function setProgress(e) {
            if (!audioEnabled) return;
            
            const width = this.clientWidth;
            const clickX = e.offsetX;
            const duration = audio.duration;
            audio.currentTime = (clickX / width) * duration;
        }

        function setVolume() {
            audio.volume = this.value;
        }

        function updatePlayPauseIcon() {
            const icon = playPauseBtn.querySelector('i');
            icon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
        }

        function updateTrackInfo() {
            // Esta función se llama cuando se cargan los metadatos del audio
            if (!isNaN(audio.duration)) {
                durationEl.textContent = formatTime(audio.duration);
            }
        }

        // Funciones de utilidad
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            seconds = Math.floor(seconds % 60);
            return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        // Funciones de comunicación con el padre
        function enviarAlPadre(mensaje) {
            window.parent.postMessage(mensaje, '*');
        }

        // Funciones de control de habilitación/deshabilitación
        function enableAudio() {
            audioEnabled = true;
            console.log('🔊 HIJO 3: Audio habilitado');
        }

        function disableAudio() {
            // No deshabilitamos el audio, solo pausamos la reproducción si está sonando
            if (isPlaying) {
                audio.pause();
                isPlaying = false;
                updatePlayPauseIcon();
            }
            console.log('⏸️ HIJO 3: Reproducción pausada');
        }

        // Manejar mensajes del padre
        window.addEventListener('message', (event) => {
            const data = event.data;
            
            if (!data || typeof data !== 'object') return;
            
            switch (data.type) {
                case 'loadTracks':
                    if (Array.isArray(data.tracks)) {
                        audioTracks = data.tracks;
                        console.log('🎵 HIJO 3: Lista de pistas cargada', audioTracks);
                        
                        // Si hay pistas, cargar la primera
                        if (audioTracks.length > 0) {
                            playTrack(0);
                        }
                    }
                    break;
                    
                case 'playTrack':
                    if (typeof data.index === 'number' && data.index >= 0 && data.index < audioTracks.length) {
                        playTrack(data.index);
                    }
                    break;
                    
                case 'play':
                    if (audioEnabled) audio.play().catch(console.error);
                    break;
                    
                case 'pause':
                    if (audioEnabled) audio.pause();
                    break;
                    
                case 'stop':
                    if (audioEnabled) {
                        audio.pause();
                        audio.currentTime = 0;
                        isPlaying = false;
                        updatePlayPauseIcon();
                    }
                    break;
                    
                case 'setVolume':
                    if (typeof data.volume === 'number' && data.volume >= 0 && data.volume <= 1) {
                        audio.volume = data.volume;
                        volumeSlider.value = data.volume;
                    }
                    break;
            }
        });

        // Inicializar el reproductor cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
