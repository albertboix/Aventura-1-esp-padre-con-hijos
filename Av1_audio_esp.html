<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor de Audio - Aventura 1</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --btn-size: 60px;
            --icon-size: 1.5em;
            --progress-thick: 20px;
            --trapecio-width: 290px;
            --trapecio-height: 155px;
            --trapecio-bg: white;
            --trapecio-shadow: 0 2px 12px rgba(0,0,0,0.13);
            --trapecio-radius: 15px;
            --progress-color: #0077cc;
            --progress-bg: #e0e0e0;
            --timer-font-size: 1.1em;
            --timer-color: #333;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: transparent !important;
        }

        body {
            font-family: "Book Antiqua", "Palatino Linotype", Palatino, Georgia, serif;
            margin: 0;
            padding: 0;
            background: transparent !important;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }

        .audio-player-controls {
            width: var(--trapecio-width);
            max-width: 98vw;
            min-width: 180px;
            height: var(--trapecio-height);
            background: var(--trapecio-bg);
            clip-path: polygon(8% 0%, 92% 0%, 100% 100%, 0% 100%);
            border-radius: var(--trapecio-radius);
            box-shadow: var(--trapecio-shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            gap: 0.1em;
            z-index: 1200;
            padding: 5px 8px 5px 8px;
            box-sizing: border-box;
            border: none;
            margin: 5px 0;
        }

        .player-buttons-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 2px;
        }

        #playPauseBtn {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            padding: 0;
        }

        #playPauseBtn .icon-play {
            color: white;
            font-weight: bold;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        #playPauseBtn:active:not(:disabled) { 
            transform: scale(0.95); 
        }

        #playPauseBtn.active {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            border: none;
        }

        #playPauseBtn:disabled { 
            background: linear-gradient(135deg, #dc3545, #c82333);
            opacity: 0.6;
            cursor: not-allowed; 
            border: none;
        }

        #retosBtn {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            padding: 0;
        }

        #retosBtn .icon-puzzle {
            color: white;
            font-weight: bold;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        #retosBtn:disabled { 
            background: linear-gradient(135deg, #999, #666);
            cursor: not-allowed; 
            opacity: 0.6;
        }

        #retosBtn:active:not(:disabled) { 
            transform: scale(0.95); 
        }

        .progress-row {
            display: flex;
            align-items: center;
            width: 90%;
            margin: 0 0 5px 0;
            padding: 0;
            justify-content: center;
        }

        .progress-container {
            flex: 1;
            width: 100%;
            height: var(--progress-thick);
            background-color: #f0f0f0;
            border-radius: calc(var(--progress-thick) / 2);
            cursor: pointer;
            position: relative;
            margin: 0;
            min-width: 0;
            overflow: visible;
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        #progressBar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #28a745, #1e7e34);
            border-radius: calc(var(--progress-thick) / 2);
            transition: width 0.1s linear;
            position: relative;
        }

        #progressBar::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff;
            border: 3px solid white;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
            display: block;
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        #playPauseBtn:disabled ~ .progress-row #progressBar::after {
            opacity: 0;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            width: 90%;
            font-size: var(--timer-font-size);
            color: var(--timer-color);
            margin-top: 2px;
            font-weight: 500;
        }

        .time-display span {
            font-variant-numeric: tabular-nums;
        }

        /* Estilos para el modo casa (ocultar controles) */
        body.modo-casa .audio-player-controls {
            display: none;
        }

        /* Estilos para el modo aventura (mostrar controles) */
        body.modo-aventura .audio-player-controls {
            display: flex;
        }
    </style>
</head>
<body class="modo-aventura">
    <div class="audio-player-controls">
        <div class="player-buttons-row">
            <button id="playPauseBtn" aria-label="Reproducir/Pausar">
                <i class="fas fa-play icon-play"></i>
            </button>
            <button id="retosBtn" aria-label="Retos">
                <i class="fas fa-puzzle-piece icon-puzzle"></i>
            </button>
        </div>
        <div class="progress-row">
            <div class="progress-container" id="progressContainer">
                <div id="progressBar"></div>
            </div>
        </div>
        <div class="time-display">
            <span id="currentTime">00:00</span>
            <span id="duration">00:00</span>
        </div>
    </div>

    <audio id="audioPlayer" preload="metadata">
        Tu navegador no soporta el elemento de audio.
    </audio>

    <script type="module">
        // Standardized import for mensajeria.js
        import { 
            Mensajeria,
            TIPOS_MENSAJE, 
            inicializarMensajeria, 
            enviarMensaje, 
            registrarControlador
        } from './Aventura-1-esp-padre-con-hijos/js/mensajeria.js';
        
        // Constantes y variables globales
        let audioPlayer;
        let playPauseBtn;
        let retosBtn;
        let progressBar;
        let progressContainer;
        let currentTimeElement;
        let durationElement;
        let isPlaying = false;
        let controlsDisabled = false;
        const IFRAME_ID = 'audioPlayerIframe';

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Inicializar elementos del DOM
                audioPlayer = document.getElementById('audioPlayer');
                playPauseBtn = document.getElementById('playPauseBtn');
                retosBtn = document.getElementById('retosBtn');
                progressBar = document.getElementById('progressBar');
                progressContainer = document.getElementById('progressContainer');
                currentTimeElement = document.getElementById('currentTime');
                durationElement = document.getElementById('duration');

                // Configurar manejadores de eventos
                setupEventListeners();
                
                console.log(`[${IFRAME_ID}] Reproductor de audio inicializado`);
            } catch (error) {
                console.error(`[${IFRAME_ID}] Error al inicializar el reproductor de audio:`, error);
            }
        });

        // Inicializar la mensajería cuando se cargue el componente
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await inicializarMensajeria({
                    iframeId: IFRAME_ID,
                    logLevel: 1, // INFO
                    debug: true
                });
                console.log(`[${IFRAME_ID}] Sistema de mensajería inicializado correctamente`);
                
                // Registrar manejadores de mensajes
                registrarControlador('audio', manejarMensajeAudio);
                
                // ...existing code...
                
            } catch (error) {
                console.error(`[${IFRAME_ID}] Error al inicializar mensajería:`, error);
            }
        });

        // Configurar manejadores de eventos
        function setupEventListeners() {
            // Botón de reproducción/pausa
            playPauseBtn.addEventListener('click', togglePlayPause);
            
            // Botón de retos
            retosBtn.addEventListener('click', handleRetosClick);
            
            // Barra de progreso
            progressContainer.addEventListener('click', handleProgressClick);
            
            // Eventos del reproductor de audio
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('loadedmetadata', updateDuration);
            audioPlayer.addEventListener('ended', handleAudioEnded);
            audioPlayer.addEventListener('play', handlePlay);
            audioPlayer.addEventListener('pause', handlePause);
            audioPlayer.addEventListener('error', handleAudioError);
            
            // Eventos de teclado para accesibilidad
            document.addEventListener('keydown', handleKeyDown);
        }

        // Alternar entre reproducir y pausar
        function togglePlayPause() {
            if (controlsDisabled) return;
            
            if (audioPlayer.paused) {
                audioPlayer.play().catch(error => {
                    console.error('Error al reproducir audio:', error);
                });
            } else {
                audioPlayer.pause();
            }
        }

        // Manejar clic en la barra de progreso
        function handleProgressClick(event) {
            if (controlsDisabled) return;
            
            const rect = progressContainer.getBoundingClientRect();
            const pos = (event.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = pos * audioPlayer.duration;
        }

        // Actualizar la barra de progreso
        function updateProgress() {
            const { currentTime, duration } = audioPlayer;
            const progressPercent = (currentTime / duration) * 100;
            progressBar.style.width = `${progressPercent}%`;
            currentTimeElement.textContent = formatTime(currentTime);
        }

        // Actualizar la duración del audio
        function updateDuration() {
            durationElement.textContent = formatTime(audioPlayer.duration);
        }

        // Formatear tiempo (segundos a MM:SS)
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            seconds = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Manejar el final del audio
        function handleAudioEnded() {
            isPlaying = false;
            updatePlayPauseButton();
            notificarEstado('reproduccion_terminada', {
                tiempoActual: audioPlayer.currentTime,
                duracion: audioPlayer.duration
            }).catch(console.error);
        }

        // Manejar el evento de reproducción
        function handlePlay() {
            isPlaying = true;
            updatePlayPauseButton();
            notificarEstado('reproduccion_iniciada', {
                tiempoActual: audioPlayer.currentTime,
                duracion: audioPlayer.duration
            }).catch(console.error);
        }

        // Manejar el evento de pausa
        function handlePause() {
            isPlaying = false;
            updatePlayPauseButton();
            notificarEstado('reproduccion_pausada', {
                tiempoActual: audioPlayer.currentTime,
                duracion: audioPlayer.duration
            }).catch(console.error);
        }

        // Manejar errores de audio
        function handleAudioError() {
            console.error('Error de audio:', audioPlayer.error);
            notificarError('audio', {
                error: audioPlayer.error ? audioPlayer.error.message : 'Error desconocido',
                tiempoActual: audioPlayer.currentTime,
                duracion: audioPlayer.duration
            }).catch(console.error);
        }

        // Actualizar el botón de reproducción/pausa
        function updatePlayPauseButton() {
            const icon = playPauseBtn.querySelector('i');
            if (isPlaying) {
                icon.classList.remove('fa-play');
                icon.classList.add('fa-pause');
            } else {
                icon.classList.remove('fa-pause');
                icon.classList.add('fa-play');
            }
        }

        // Manejar clic en el botón de retos
        function handleRetosClick() {
            if (controlsDisabled) return;
            
            // Notificar al padre que se hizo clic en el botón de retos
            notificarEstado('boton_retos_presionado', {
                tiempoActual: audioPlayer.currentTime,
                duracion: audioPlayer.duration
            }).catch(console.error);
        }

        // Manejar teclas de acceso rápido
        function handleKeyDown(event) {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return; // No hacer nada si el foco está en un campo de entrada
            }
            
            switch (event.key) {
                case ' ':
                case 'k':
                    event.preventDefault();
                    togglePlayPause();
                    break;
                case 'm':
                    event.preventDefault();
                    audioPlayer.muted = !audioPlayer.muted;
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
                    break;
                case 'ArrowRight':
                    event.preventDefault();
                    audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 5);
                    break;
                case '0':
                case '1':
                case '2':
                case '3':
                case '4':
                case '5':
                case '6':
                case '7':
                case '8':
                case '9':
                    event.preventDefault();
                    const percent = parseInt(event.key) / 10;
                    audioPlayer.currentTime = percent * audioPlayer.duration;
                    break;
            }
        }

        // Notificar el estado actual al padre usando el módulo de mensajería
        function notificarEstado(accion, datos = {}) {
            if (window.Mensajeria) {
                return enviarMensaje('padre', 'audio:estado', { 
                    accion, 
                    ...datos, 
                    origen: IFRAME_ID,
                    timestamp: new Date().toISOString()
                }).catch(error => {
                    console.error(`[${IFRAME_ID}] Error al notificar estado:`, error);
                    return Promise.reject(error);
                });
            } else {
                // Fallback al método anterior
                if (window.parent && window.parent !== window) {
                    return new Promise((resolve, reject) => {
                        try {
                            window.parent.postMessage({
                                tipo: 'audio',
                                datos: { accion, ...datos }
                            }, '*');
                            resolve();
                        } catch (error) {
                            console.error(`[${IFRAME_ID}] Error al enviar mensaje al padre:`, error);
                            reject(error);
                        }
                    });
                }
                return Promise.resolve(); // No hay padre
            }
        }

        // Notificar un error al padre
        function notificarError(tipo, datos = {}) {
            if (window.Mensajeria) {
                return enviarMensaje('padre', 'error', { 
                    tipo, 
                    ...datos, 
                    origen: IFRAME_ID,
                    timestamp: new Date().toISOString()
                }).catch(error => {
                    console.error(`[${IFRAME_ID}] Error al notificar error:`, error);
                    return Promise.reject(error);
                });
            } else {
                // Fallback al método anterior
                if (window.parent && window.parent !== window) {
                    return new Promise((resolve, reject) => {
                        try {
                            window.parent.postMessage({
                                tipo: 'error',
                                datos: { tipo, ...datos }
                            }, '*');
                            resolve();
                        } catch (error) {
                            console.error(`[${IFRAME_ID}] Error al enviar mensaje de error al padre:`, error);
                            reject(error);
                        }
                    });
                }
                return Promise.resolve(); // No hay padre
            }
        }

        // Manejador de mensajes de audio
        async function manejarMensajeAudio(mensaje) {
            const { accion, url, tiempo, volumen, habilitar, deshabilitar } = mensaje.datos || {};
            
            try {
                console.log(`[${IFRAME_ID}] Mensaje de audio recibido:`, mensaje);
                
                switch (accion) {
                    case 'cargar':
                        if (url) {
                            audioPlayer.src = url;
                            audioPlayer.load();
                            return { estado: 'ok', mensaje: 'Audio cargado correctamente' };
                        }
                        return { estado: 'error', mensaje: 'URL no proporcionada' };
                        
                    case 'reproducir':
                        try {
                            await audioPlayer.play();
                            return { estado: 'ok', mensaje: 'Reproducción iniciada' };
                        } catch (error) {
                            console.error(`[${IFRAME_ID}] Error al reproducir:`, error);
                            return { estado: 'error', mensaje: error.message };
                        }
                        
                    case 'pausar':
                        audioPlayer.pause();
                        return { estado: 'ok', mensaje: 'Audio pausado' };
                        
                    case 'detener':
                        audioPlayer.pause();
                        audioPlayer.currentTime = 0;
                        return { estado: 'ok', mensaje: 'Audio detenido' };
                        
                    case 'saltar':
                        if (typeof tiempo === 'number') {
                            audioPlayer.currentTime = tiempo;
                            return { estado: 'ok', mensaje: 'Tiempo actualizado' };
                        }
                        return { estado: 'error', mensaje: 'Tiempo no válido' };
                        
                    case 'volumen':
                        if (typeof volumen === 'number' && volumen >= 0 && volumen <= 1) {
                            audioPlayer.volume = volumen;
                            return { estado: 'ok', mensaje: 'Volumen actualizado' };
                        }
                        return { estado: 'error', mensaje: 'Volumen no válido' };
                        
                    case 'habilitar_controles':
                        controlsDisabled = false;
                        playPauseBtn.disabled = false;
                        retosBtn.disabled = false;
                        return { estado: 'ok', mensaje: 'Controles habilitados' };
                        
                    case 'deshabilitar_controles':
                        controlsDisabled = true;
                        playPauseBtn.disabled = true;
                        retosBtn.disabled = true;
                        return { estado: 'ok', mensaje: 'Controles deshabilitados' };
                        
                    case 'obtener_estado':
                        return {
                            estado: 'ok',
                            datos: {
                                reproduciendo: !audioPlayer.paused,
                                tiempo: audioPlayer.currentTime,
                                duracion: audioPlayer.duration || 0,
                                volumen: audioPlayer.volume,
                                controlesHabilitados: !controlsDisabled,
                                src: audioPlayer.src || '',
                                muted: audioPlayer.muted
                            }
                        };
                        
                    default:
                        return { estado: 'error', mensaje: `Acción desconocida: ${accion}` };
                }
            } catch (error) {
                console.error(`[${IFRAME_ID}] Error al procesar mensaje de audio:`, error);
                return { estado: 'error', mensaje: error.message };
            }
        }

        // Función para habilitar o deshabilitar los controles
        function setControlsEnabled(enabled) {
            controlsDisabled = !enabled;
            playPauseBtn.disabled = !enabled;
            retosBtn.disabled = !enabled;
        }

        // Función para cambiar entre modo casa y aventura
        function cambiarModo(modo) {
            if (modo === 'casa') {
                document.body.classList.remove('modo-aventura');
                document.body.classList.add('modo-casa');
                audioPlayer.pause();
            } else if (modo === 'aventura') {
                document.body.classList.remove('modo-casa');
                document.body.classList.add('modo-aventura');
            }
        }

        // Registrar el manejador de mensajes de ventana
        window.addEventListener('message', event => {
            try {
                const { tipo, datos } = event.data || {};
                
                if (tipo === 'audio') {
                    manejarMensajeAudio({ datos }).catch(console.error);
                } else if (tipo === 'cambio_modo') {
                    cambiarModo(datos?.modo);
                }
            } catch (error) {
                console.error(`[${IFRAME_ID}] Error al procesar mensaje de ventana:`, error);
            }
        });

        // Notificar que el componente está listo
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                notificarEstado('componente_listo', {
                    id: IFRAME_ID,
                    tipo: 'audio',
                    capacidades: ['reproducir', 'pausar', 'saltar', 'volumen']
                }).catch(console.error);
            }, 500);
        });
    </script>
</body>
</html>
