<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor de Audio de Aventura (Hijo)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --btn-size: 80px;
            --icon-size: 2.7em;
            --progress-thick: 16px;
            --trapecio-width: 340px;
            --trapecio-height: 120px;
            --trapecio-bg: rgba(255,255,255,0.85);
            --trapecio-shadow: 0 2px 12px rgba(0,0,0,0.13);
            --trapecio-radius: 18px;
            --progress-color: #0077cc;
            --progress-bg: #e0e0e0;
            --timer-font-size: 1.3em;
            --timer-color: #444;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: transparent !important;
        }
        body {
            font-family: "Book Antiqua", "Palatino Linotype", "Palatino", Georgia, serif;
            margin: 0;
            padding: 0;
            background: transparent !important;
            overflow: hidden;
        }
        .audio-player-controls {
            position: fixed;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%);
            width: min(var(--trapecio-width), 98vw);
            max-width: 98vw;
            min-width: 180px;
            height: var(--trapecio-height);
            background: var(--trapecio-bg);
            clip-path: polygon(8% 0, 92% 0, 100% 100%, 0 100%);
            border-radius: var(--trapecio-radius);
            box-shadow: var(--trapecio-shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            gap: 0.1em;
            z-index: 1200;
            padding: 2px 4px;
            border: none;
        }
        .progress-row {
            display: flex;
            align-items: center;
            width: 96%;
            gap: 1.2em;
            margin: 0 0 8px 0;
            padding: 0;
            justify-content: center;
        }
        .progress-container {
            flex: 0 0 68%;
            max-width: 68%;
            width: 68%;
            height: var(--progress-thick);
            background-color: var(--progress-bg);
            border-radius: 5px;
            cursor: pointer;
            position: relative;
            margin: 0;
            min-width: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
        }
        #progressBar {
            height: 100%;
            width: 0%;
            background-color: var(--progress-color);
            border-radius: 5px;
            transition: width 0.1s linear;
        }
        .time-display {
            min-width: 80px;
            font-size: var(--timer-font-size);
            color: var(--timer-color);
            text-align: right;
            user-select: none;
            margin-left: 2px;
            white-space: nowrap;
            display: inline-block;
            vertical-align: middle;
            font-family: inherit;
        }
        .player-buttons-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.2em;
            width: 100%;
            margin-bottom: 2px;
        }
        #playPauseBtn {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(90deg, #cc3333 0%, #ff5555 100%) !important;
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            padding: 0;
        }
        #playPauseBtn:active:not(:disabled) { transform: scale(0.95); }
        #playPauseBtn.active {
            background: linear-gradient(90deg, #34c759 0%, #43e97b 100%) !important;
        }
        .player-button:not(#playPauseBtn), #retosBtn, #puzzleBtn {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(90deg, #cc3333 0%, #ff5555 100%);
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            padding: 0;
        }
        .player-button:disabled:not(#playPauseBtn), #retosBtn:disabled, #puzzleBtn:disabled { background: #ccc; cursor: not-allowed; }
        .player-button:active:not(:disabled):not(#playPauseBtn), #retosBtn:active:not(:disabled), #puzzleBtn:active:not(:disabled) { transform: scale(0.95);}
        .player-button.active:not(#playPauseBtn), #retosBtn.active, #puzzleBtn.active {
            background: linear-gradient(90deg, #34c759 0%, #43e97b 100%);
        }
        .icon-play, .icon-puzzle, .icon-puzzle2 {
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .progress-container:active, .progress-container.dragging {
            cursor: grabbing;
        }
        @media (max-width: 500px) {
            :root {
                --btn-size: 48px;
                --icon-size: 1.5em;
                --trapecio-width: 98vw;
                --trapecio-height: 90px;
                --progress-thick: 10px;
                --timer-font-size: 1em;
            }
            .audio-player-controls {
                width: 98vw;
                min-width: unset;
                left: 50%;
                transform: translateX(-50%);
            }
            .progress-row { gap: 0.7em; }
            .progress-container {
                max-width: 62%;
                width: 62%;
                flex-basis: 62%;
            }
            .time-display { min-width: 60px; }
        }
    </style>
</head>
<body>
    <div class="audio-player-controls" id="audioPlayerControls">
        <audio id="audioPlayer"></audio>
        <div class="player-buttons-row">
            <button id="playPauseBtn" class="player-button" title="Reproducir/Pausar" disabled>
                <span class="icon-play"><i class="fas fa-play"></i></span>
            </button>
            <button id="retosBtn" title="Reto" class="player-button" disabled>
                <span class="icon-puzzle">ðŸ§©</span>
            </button>
            <button id="puzzleBtn" title="Puzzle" class="player-button" disabled>
                <span class="icon-puzzle2">ðŸ§©</span>
            </button>
        </div>
        <div class="progress-row">
            <div class="progress-container" id="progressContainer">
                <div id="progressBar"></div>
            </div>
            <span class="time-display">
                <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
            </span>
        </div>
    </div>
    <script>
    // --- ConfiguraciÃ³n de paradas ---
    // Para cada parada, especifica:
    // - nombre: Nombre de la parada
    // - audio: Ruta del archivo de audio
    // - reto: Ruta del archivo de reto (puede ser Av1-esp-retos-preguntas.html?reto=NUM o el que corresponda)
    // - puzzle: Ruta del archivo de puzzle (puede ser null si no hay puzzle en esa parada)
    const PARADAS = [
      { nombre: "1 - Torres de Serranos (start)", audio: "audios/1-torres-serranos.mp3", reto: "Av1-esp-retos-preguntas.html?reto=1", puzzle: null },
      { nombre: "2 - Puente de Serranos â€“ Plaza de la crida", audio: "audios/2-puente-serranos.mp3", reto: "Av1-esp-retos-preguntas.html?reto=2", puzzle: null },
      { nombre: "3 - Cortes Valencianas (Palacio de los Borgia)", audio: "audios/3-cortes-valencianas.mp3", reto: "Av1-esp-retos-preguntas.html?reto=3", puzzle: null },
      { nombre: "4 - Plaza de la Virgen", audio: "audios/4-plaza-virgen.mp3", reto: "Av1-esp-retos-preguntas.html?reto=4", puzzle: "P8_puzzle_plaza_virgen.html" },
      { nombre: "5 - Plaza de la AlmoÃ­na", audio: "audios/5-plaza-almoinia.mp3", reto: "Av1-esp-retos-preguntas.html?reto=5", puzzle: null },
      { nombre: "6 - Catedral de ValÃ¨ncia", audio: "audios/6-catedral.mp3", reto: "Av1-esp-retos-preguntas.html?reto=6", puzzle: null },
      { nombre: "7 - Plaza decimo Juno Bruto (Museo ArqueolÃ³gico de la AlmoÃ­na)", audio: "audios/7-juno-bruto.mp3", reto: "Av1-esp-retos-preguntas.html?reto=7", puzzle: null },
      { nombre: "8 - BasÃ­lica de ValÃ¨ncia", audio: "audios/8-basilica.mp3", reto: "Av1-esp-retos-preguntas.html?reto=8", puzzle: null },
      { nombre: "9 - Palacio Arzobispal", audio: "audios/9-arzobispal.mp3", reto: "Av1-esp-retos-preguntas.html?reto=9", puzzle: null },
      { nombre: "10 - Plaza del Ayuntamiento", audio: "audios/10-ayuntamiento.mp3", reto: "Av1-esp-retos-preguntas.html?reto=10", puzzle: null },
      { nombre: "11 - Edificio del Ayuntamiento de ValÃ¨ncia", audio: "audios/11-edificio-ayuntamiento.mp3", reto: "Av1-esp-retos-preguntas.html?reto=11", puzzle: null },
      { nombre: "12 - EstaciÃ³n de Ferrocarril (EstaciÃ³n del Norte)", audio: "audios/12-estacion-norte.mp3", reto: "Av1-esp-retos-preguntas.html?reto=12", puzzle: null },
      { nombre: "13 - Plaza de Toros de ValÃ¨ncia", audio: "audios/13-plaza-toros.mp3", reto: "Av1-esp-retos-preguntas.html?reto=13", puzzle: "P18_puzzle_plaza_de_Toros_y_estacion_norte.html" },
      { nombre: "14 - Casa estilo Ãrabe", audio: "audios/14-casa-arabe.mp3", reto: "Av1-esp-retos-preguntas.html?reto=14", puzzle: null },
      { nombre: "15 - Palacio de Comunicaciones (Correos)", audio: "audios/15-correos.mp3", reto: "Av1-esp-retos-preguntas.html?reto=15", puzzle: null },
      { nombre: "16 - Antigua sede del Banco de ValÃ¨ncia", audio: "audios/16-banco-valencia.mp3", reto: "Av1-esp-retos-preguntas.html?reto=16", puzzle: null },
      { nombre: "17 - Palacio del MarquÃ©s de Dos Aguas (Museo Nacional de CrÃ¡mica)", audio: "audios/17-dos-aguas.mp3", reto: "Av1-esp-retos-preguntas.html?reto=17", puzzle: null },
      { nombre: "18 - Mercado Central", audio: "audios/18-mercado-central.mp3", reto: "Av1-esp-retos-preguntas.html?reto=18", puzzle: null },
      { nombre: "19 - San Juan del Mercado (Iglesia de los Santos Juanes)", audio: "audios/19-san-juan.mp3", reto: "Av1-esp-retos-preguntas.html?reto=19", puzzle: null },
      { nombre: "20 - Lonja de ValÃ¨ncia (Mercado de la Seda)", audio: "audios/20-lonja.mp3", reto: "Av1-esp-retos-preguntas.html?reto=20", puzzle: "P26_puzzle_lonja.html" },
      { nombre: "21 - Plaza del Doctor Collado", audio: "audios/21-collado.mp3", reto: "Av1-esp-retos-preguntas.html?reto=21", puzzle: null },
      { nombre: "22 - Plaza del Negrito (Fuente del Negrito)", audio: "audios/22-negrito.mp3", reto: "Av1-esp-retos-preguntas.html?reto=22", puzzle: null },
      { nombre: "23 - Calle Caballeros", audio: "audios/23-caballeros.mp3", reto: "Av1-esp-retos-preguntas.html?reto=23", puzzle: null },
      { nombre: "24 - Palacio de la Generalitat", audio: "audios/24-generalitat.mp3", reto: "Av1-esp-retos-preguntas.html?reto=24", puzzle: null },
      { nombre: "25 - Calle de los Serranos (end)", audio: "audios/25-serranos-end.mp3", reto: "Av1-esp-retos-preguntas.html?reto=25", puzzle: null },
      { nombre: "26 - Parada extra 1", audio: "audios/26-extra1.mp3", reto: "Av1-esp-retos-preguntas.html?reto=26", puzzle: null },
      { nombre: "27 - Parada extra 2", audio: "audios/27-extra2.mp3", reto: "Av1-esp-retos-preguntas.html?reto=27", puzzle: null },
      { nombre: "28 - Parada extra 3", audio: "audios/28-extra3.mp3", reto: "Av1-esp-retos-preguntas.html?reto=28", puzzle: null },
      { nombre: "29 - Parada extra 4", audio: "audios/29-extra4.mp3", reto: "Av1-esp-retos-preguntas.html?reto=29", puzzle: null },
      { nombre: "30 - Parada extra 5", audio: "audios/30-extra5.mp3", reto: "Av1-esp-retos-preguntas.html?reto=30", puzzle: null }
    ];

    const audioPlayer = document.getElementById('audioPlayer');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const retosBtn = document.getElementById('retosBtn');
    const puzzleBtn = document.getElementById('puzzleBtn');
    const progressBar = document.getElementById('progressBar');
    const progressContainer = document.getElementById('progressContainer');
    const currentTimeElem = document.getElementById('currentTime');
    const durationElem = document.getElementById('duration');

    let paradaActual = null;
    let audioReady = false;

    // --- Control de mensajes del padre ---
    window.addEventListener('message', (event) => {
      // Validar origen si es necesario
      // if (event.origin !== window.location.origin) return;
      const data = event.data;
      if (data && data.type === 'setAudioParada' && typeof data.index === 'number') {
        cargarParada(data.index);
      }
      if (data && data.type === 'activarReto') {
        activarReto();
      }
      if (data && data.type === 'activarPuzzle') {
        activarPuzzle();
      }
    });

    function cargarParada(index) {
      paradaActual = PARADAS[index];
      if (!paradaActual) return;
      audioPlayer.src = paradaActual.audio;
      playPauseBtn.disabled = false;
      playPauseBtn.classList.remove('active');
      playPauseBtn.style.background = 'linear-gradient(90deg, #cc3333 0%, #ff5555 100%)';
      retosBtn.disabled = true;
      retosBtn.classList.remove('active');
      puzzleBtn.disabled = true;
      puzzleBtn.classList.remove('active');
      audioReady = false;
      progressBar.style.width = '0%';
      currentTimeElem.textContent = '0:00';
      durationElem.textContent = '0:00';
    }

    // --- Control de audio ---
    audioPlayer.addEventListener('loadedmetadata', () => {
      durationElem.textContent = formatTime(audioPlayer.duration);
      playPauseBtn.classList.add('active');
      playPauseBtn.style.background = 'linear-gradient(90deg, #34c759 0%, #43e97b 100%)';
      audioReady = true;
    });

    playPauseBtn.addEventListener('click', () => {
      if (!audioReady) return;
      if (audioPlayer.paused) {
        audioPlayer.play();
      } else {
        audioPlayer.pause();
      }
    });

    audioPlayer.addEventListener('play', () => {
      playPauseBtn.querySelector('i').className = 'fas fa-pause';
    });
    audioPlayer.addEventListener('pause', () => {
      playPauseBtn.querySelector('i').className = 'fas fa-play';
    });

    audioPlayer.addEventListener('timeupdate', () => {
      currentTimeElem.textContent = formatTime(audioPlayer.currentTime);
      if (audioPlayer.duration) {
        progressBar.style.width = `${(audioPlayer.currentTime / audioPlayer.duration) * 100}%`;
      }
    });

    progressContainer.addEventListener('click', (e) => {
      if (!audioReady) return;
      const rect = progressContainer.getBoundingClientRect();
      const percent = (e.clientX - rect.left) / rect.width;
      audioPlayer.currentTime = percent * audioPlayer.duration;
    });

    audioPlayer.addEventListener('ended', () => {
      // Al terminar el audio, notifica al padre para que active el reto/puzzle
      window.parent.postMessage({ type: 'audioFinalizado', parada: paradaActual ? paradaActual.nombre : null }, '*');
    });

    function activarReto() {
      retosBtn.disabled = false;
      retosBtn.classList.add('active');
    }
    function activarPuzzle() {
      if (paradaActual && paradaActual.puzzle) {
        puzzleBtn.disabled = false;
        puzzleBtn.classList.add('active');
      }
    }

    retosBtn.addEventListener('click', () => {
      if (!paradaActual) return;
      window.open(paradaActual.reto, '_blank');
    });

    puzzleBtn.addEventListener('click', () => {
      if (!paradaActual || !paradaActual.puzzle) return;
      window.open(paradaActual.puzzle, '_blank');
    });

    function formatTime(sec) {
      sec = Math.floor(sec);
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    // --- InicializaciÃ³n: desactivar controles hasta que el padre indique parada ---
    playPauseBtn.disabled = true;
    retosBtn.disabled = true;
    puzzleBtn.disabled = true;
    </script>
</body>
</html>
