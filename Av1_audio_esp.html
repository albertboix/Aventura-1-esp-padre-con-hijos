<!DOCTYPE html>
<html lang="es">
<head>
    <script type="module">
      try {
        const moduloMensajeria = await import('./js/mensajeria.js');
        window.Mensajeria = moduloMensajeria.default || moduloMensajeria;
        if (window.Mensajeria && typeof window.Mensajeria.inicializarMensajeria === 'function') {
          window.Mensajeria.inicializarMensajeria({
            iframeId: 'hijo3',
            logLevel: 1,
            debug: true
          });

          // ================== MANEJADORES DE MENSAJES ==================
          // 1. Inicialización (confirmación al padre)
          Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.INICIALIZACION, function(mensaje) {
            console.log('[HIJO3] Confirmando inicialización al padre');
            Mensajeria.enviarMensajeConReintenos(
              'padre',
              Mensajeria.TIPOS_MENSAJE.INICIALIZACION,
              { estado: 'listo', timestamp: Date.now() }
            );
          });

          // 2. Cambio de modo (desde padre u otro hijo)
          Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.CAMBIO_MODO, function(mensaje) {
            console.log('[HIJO3] Cambio de modo recibido:', mensaje.datos);
            // Actualizar el estado local del modo
            const nuevoModo = mensaje.datos.modo || 'aventura';
            console.log(`🔊 HIJO3: Cambiando a modo ${nuevoModo}`);
            
            // Actualizar la interfaz según el modo
            if (nuevoModo === 'casa') {
              document.body.classList.add('modo-casa');
              document.body.classList.remove('modo-aventura');
            } else {
              document.body.classList.add('modo-aventura');
              document.body.classList.remove('modo-casa');
            }
          });

          // 3. Comandos de audio (desde padre u otro hijo)
          Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.AUDIO, function(mensaje) {
            console.log('[HIJO3] Comando de audio recibido:', mensaje.datos);
            const { accion, parametros } = mensaje.datos;
            
            // Procesar el comando de audio
            if (accion === 'reproducir' && parametros && parametros.archivo) {
              // Lógica para reproducir el audio
              console.log(`Reproduciendo audio: ${parametros.archivo}`);
              // Aquí iría el código para reproducir el audio
              
              // Notificar al padre que el audio ha comenzado
              Mensajeria.enviarMensajeConReintenos(
                'padre',
                Mensajeria.TIPOS_MENSAJE.AUDIO,
                { 
                  estado: 'reproduciendo',
                  archivo: parametros.archivo,
                  timestamp: Date.now()
                }
              );
            } else if (accion === 'pausar') {
              // Lógica para pausar el audio
              console.log('Pausando reproducción');
              // Aquí iría el código para pausar el audio
              
              // Notificar al padre que el audio está en pausa
              Mensajeria.enviarMensajeConReintenos(
                'padre',
                Mensajeria.TIPOS_MENSAJE.AUDIO,
                { 
                  estado: 'pausado',
                  timestamp: Date.now()
                }
              );
            } else if (accion === 'detener') {
              // Lógica para detener el audio
              console.log('Deteniendo reproducción');
              // Aquí iría el código para detener el audio
              
              // Notificar al padre que el audio se detuvo
              Mensajeria.enviarMensajeConReintenos(
                'padre',
                Mensajeria.TIPOS_MENSAJE.AUDIO,
                { 
                  estado: 'detenido',
                  timestamp: Date.now()
                }
              );
            }
          });

          // 4. Confirmaciones
          Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.CONFIRMACION, function(mensaje) {
            console.log('[HIJO3] Confirmación recibida:', mensaje);
            // Procesar confirmaciones si es necesario
          });

          // 5. Notificar al padre que está listo
          Mensajeria.enviarMensajeConReintenos(
            'padre',
            Mensajeria.TIPOS_MENSAJE.INICIALIZACION,
            { estado: 'listo', timestamp: Date.now() }
          );
        }
      } catch (e) {
        console.error('No se pudo cargar mensajeria.js', e);
      }
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reproductor de Audio - Aventura 1 (hijo3)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --btn-size: 60px;
            --icon-size: 1.5em;
            --progress-thick: 20px;
            --trapecio-width: 290px;
            --trapecio-height: 155px;
            --trapecio-bg: white;
            --trapecio-shadow: 0 2px 12px rgba(0,0,0,0.13);
            --trapecio-radius: 15px;
            --progress-color: #0077cc;
            --progress-bg: #e0e0e0;
            --timer-font-size: 1.1em;
            --timer-color: #333;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: transparent !important;
        }

        body {
            font-family: "Book Antiqua", "Palatino Linotype", Palatino, Georgia, serif;
            margin: 0;
            padding: 0;
            background: transparent !important;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }

        .audio-player-controls {
            width: var(--trapecio-width);
            max-width: 98vw;
            min-width: 180px;
            height: var(--trapecio-height);
            background: var(--trapecio-bg);
            clip-path: polygon(8% 0%, 92% 0%, 100% 100%, 0% 100%);
            border-radius: var(--trapecio-radius);
            box-shadow: var(--trapecio-shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            gap: 0.1em;
            z-index: 1200;
            padding: 5px 8px 5px 8px;
            box-sizing: border-box;
            border: none;
            margin: 5px 0;
        }

        .player-buttons-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 2px;
        }

        #playPauseBtn {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            padding: 0;
        }

        #playPauseBtn .icon-play {
            color: white;
            font-weight: bold;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        #playPauseBtn:active:not(:disabled) { transform: scale(0.95); }
        #playPauseBtn.active {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            border: none;
        }
        #playPauseBtn:disabled { 
            background: linear-gradient(135deg, #dc3545, #c82333);
            opacity: 1;
            cursor: not-allowed; 
            opacity: 0.6;
            border: none;
        }

        #retosBtn {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            padding: 0;
        }

        #retosBtn .icon-puzzle {
            background: linear-gradient(135deg, #007bff 0%, #0056d3 50%, #00c6ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        #retosBtn:disabled { 
            background: linear-gradient(135deg, #dc3545, #c82333);
            cursor: not-allowed; 
            opacity: 0.6;
        }

        #retosBtn:disabled .icon-puzzle {
            opacity: 0.6;
        }

        #retosBtn:active:not(:disabled) { transform: scale(0.95); }
        #retosBtn.active {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }

        .progress-row {
            display: flex;
            align-items: center;
            width: 90%;
            margin: 0 0 5px 0;
            padding: 0;
            justify-content: center;
        }

        .progress-container {
            flex: 1;
            width: 100%;
            height: var(--progress-thick);
            background-color: #f0f0f0;
            border-radius: calc(var(--progress-thick) / 2);
            cursor: pointer;
            position: relative;
            margin: 0;
            min-width: 0;
            overflow: visible;
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        #progressBar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #28a745, #1e7e34);
            border-radius: calc(var(--progress-thick) / 2);
            transition: width 0.1s linear;
            position: relative;
        }

        #progressBar::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff;
            border: 3px solid white;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
            display: block;
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        #playPauseBtn:disabled ~ .progress-row #progressBar::after {
            opacity: 0;
        }

        #playPauseBtn:disabled ~ .progress-row #progressBar {
            background: linear-gradient(90deg, #dc3545, #c82333);
        }

        .time-display {
            width: 90%;
            font-size: var(--timer-font-size);
            color: #333;
            text-align: left;
            user-select: none;
            margin: 2px 0;
            white-space: nowrap;
            font-family: inherit;
            display: flex;
            justify-content: space-between;
            font-weight: bold;
        }

        /* Efectos hover */
        #playPauseBtn:hover:not(:disabled),
        #retosBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* Estilos responsivos */
        @media (max-width: 500px) {
            :root {
                --btn-size: 50px;
                --icon-size: 1.3em;
                --trapecio-width: 98vw;
                --trapecio-height: 140px;
                --progress-thick: 16px;
                --timer-font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="audio-player-controls">
        <div class="player-buttons-row">
            <button id="playPauseBtn" aria-label="Reproducir/Pausar">
                <i class="fas fa-play icon-play"></i>
            </button>
            <button id="retosBtn" aria-label="Retos">
                <i class="fas fa-puzzle-piece icon-puzzle"></i>
            </button>
        </div>
        <div class="progress-row">
            <div class="progress-container" id="progressContainer">
                <div id="progressBar"></div>
            </div>
        </div>
        <div class="time-display">
            <span id="currentTime">00:00</span>
            <span id="duration">00:00</span>
        </div>
    </div>

    <audio id="audioPlayer" preload="metadata">
        Tu navegador no soporta el elemento de audio.
    </audio>

    <script type="module">
        // Constantes y variables globales
        const IFRAME_ID = 'audioPlayerIframe';
        let audioPlayer;
        let playPauseBtn;
        let retosBtn;
        let progressBar;
        let progressContainer;
        let currentTimeEl;
        let durationEl;
        let isPlaying = false;
        let modoCasa = false;
        let controlsDisabled = true;
        let intervaloFlecha = null;
        let ubicacionActual = null;

        // Mapeo de paradas y tramos a archivos de audio
        const audioFiles = [
            // Parada 0 - Inicio
            { 
                id: "audio_P-0", 
                title: "Torres de Serranos (inicio)", 
                file: "Av1_audio_esp/02 Intro ESPAÑOL 2.mp3"
            },
            // ... (resto de las entradas de audioFiles)
        ];

        // Inicialización cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar referencias a elementos del DOM
            audioPlayer = document.getElementById('audioPlayer');
            playPauseBtn = document.getElementById('playPauseBtn');
            retosBtn = document.getElementById('retosBtn');
            progressBar = document.getElementById('progressBar');
            progressContainer = document.getElementById('progressContainer');
            currentTimeEl = document.getElementById('currentTime');
            durationEl = document.getElementById('duration');

            // Configurar manejadores de eventos
            setupEventListeners();
            
            // Notificar al padre que el reproductor está listo
            window.parent.postMessage({
                tipo: 'reproductor_listo',
                origen: IFRAME_ID,
                datos: { estado: 'listo' }
            }, '*');
            
            console.log('🎵 HIJO 3: Reproductor de audio inicializado');
        });

        function setupEventListeners() {
            // Control de reproducción
            playPauseBtn.addEventListener('click', togglePlay);
            retosBtn.addEventListener('click', handleRetosClick);
            
            // Control de progreso
            progressContainer.addEventListener('click', setProgress);
            
            // Eventos del reproductor de audio
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', handleAudioEnded);
            audioPlayer.addEventListener('loadedmetadata', updateDuration);
            
            // Eventos de teclado para accesibilidad
            document.addEventListener('keydown', handleKeyDown);
            
            // Configurar arrastrar y soltar para el progreso
            setupDragAndDrop();
        }

        function togglePlay() {
            if (controlsDisabled) return;
            
            if (isPlaying) {
                audioPlayer.pause();
            } else {
                audioPlayer.play().catch(error => {
                    console.error('Error al reproducir el audio:', error);
                });
            }
            updatePlayPauseIcon();
        }

        function updatePlayPauseIcon() {
            const icon = playPauseBtn.querySelector('i');
            if (icon) {
                icon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
            }
        }

        function updateProgress() {
            if (!isFinite(audioPlayer.duration)) return;
            
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressBar.style.width = `${progress}%`;
            
            // Actualizar tiempos
            currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
            
            // Notificar al padre sobre el progreso
            window.parent.postMessage({
                tipo: 'progreso_audio',
                origen: IFRAME_ID,
                datos: {
                    progreso: progress,
                    tiempoActual: audioPlayer.currentTime,
                    duracion: audioPlayer.duration
                }
            }, '*');
        }

        function updateDuration() {
            if (isFinite(audioPlayer.duration)) {
                durationEl.textContent = formatTime(audioPlayer.duration);
            }
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function setProgress(e) {
            if (controlsDisabled) return;
            
            const width = this.clientWidth;
            const clickX = e.offsetX;
            const duration = audioPlayer.duration;
            audioPlayer.currentTime = (clickX / width) * duration;
        }

        function handleAudioEnded() {
            isPlaying = false;
            updatePlayPauseIcon();
            
            // Notificar al padre que el audio terminó
            window.parent.postMessage({
                tipo: 'audio_terminado',
                origen: IFRAME_ID,
                datos: { finalizado: true }
            }, '*');
        }

        function handleRetosClick() {
            if (controlsDisabled) return;
            
            // Notificar al padre que se hizo clic en el botón de retos
            window.parent.postMessage({
                tipo: 'abrir_retos',
                origen: IFRAME_ID,
                datos: { mostrar: true }
            }, '*');
        }

        function handleKeyDown(e) {
            if (controlsDisabled) return;
            
            switch(e.key) {
                case ' ':
                case 'Spacebar':
                case 'Enter':
                    e.preventDefault();
                    togglePlay();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    audioPlayer.currentTime = Math.min(audioPlayer.currentTime + 5, audioPlayer.duration);
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
                    break;
            }
        }

        function setupDragAndDrop() {
            let isDragging = false;
            
            progressContainer.addEventListener('mousedown', () => {
                if (controlsDisabled) return;
                isDragging = true;
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging || controlsDisabled) return;
                
                const rect = progressContainer.getBoundingClientRect();
                const pos = (e.clientX - rect.left) / rect.width;
                const newTime = Math.max(0, Math.min(1, pos)) * audioPlayer.duration;
                
                if (isFinite(newTime)) {
                    audioPlayer.currentTime = newTime;
                }
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        }

        // Manejo de mensajes desde la ventana principal
        window.addEventListener('message', async function(event) {
            // Importar el módulo de mensajería si no está disponible
            if (!window.crearMensaje) {
                try {
                    const mod = await import('./js/mensajeria.js');
                    window.crearMensaje = mod.crearMensaje;
                    window.TIPOS_MENSAJE = mod.TIPOS_MENSAJE;
                } catch (error) {
                    console.error('Error al cargar el módulo de mensajería:', error);
                    return;
                }
            }
            
            const mensaje = event.data;
            if (!mensaje || !mensaje.tipo) return;
            
            try {
                console.log(`🔊 HIJO3: Mensaje recibido - tipo: ${mensaje.tipo}`, mensaje);
                
                switch(mensaje.tipo) {
                    case 'cambioModo':
                        // Actualizar el estado local del modo
                        const nuevoModo = mensaje.datos?.modo || 'aventura';
                        console.log(`🔊 HIJO3: Cambiando a modo ${nuevoModo}`);
                        modoCasa = (nuevoModo === 'casa');
                        // En ambos modos, controles habilitados
                        controlsDisabled = false;
                        console.log(`🔊 HIJO3: Controles habilitados (modo ${nuevoModo})`);
                        updatePlayPauseIcon();
                        break;
                        
                    case 'reproducir_audio':
                        if (mensaje.datos && mensaje.datos.archivo) {
                            console.log(`🔊 HIJO3: Reproduciendo archivo: ${mensaje.datos.archivo}`);
                            audioPlayer.src = mensaje.datos.archivo;
                            audioPlayer.play().then(() => {
                                isPlaying = true;
                                updatePlayPauseIcon();
                            }).catch(error => {
                                console.error('Error al reproducir el audio:', error);
                            });
                        }
                        break;
                        
                    case 'pausar_audio':
                        audioPlayer.pause();
                        isPlaying = false;
                        updatePlayPauseIcon();
                        break;
                        
                    case 'reanudar_audio':
                        audioPlayer.play().catch(error => {
                            console.error('Error al reanudar el audio:', error);
                        });
                        isPlaying = true;
                        updatePlayPauseIcon();
                        break;
                        
                    case 'detener_audio':
                        audioPlayer.pause();
                        audioPlayer.currentTime = 0;
                        isPlaying = false;
                        updatePlayPauseIcon();
                        updateProgress();
                        break;
                        
                    case 'establecer_tiempo':
                        if (typeof mensaje.datos.tiempo === 'number') {
                            audioPlayer.currentTime = mensaje.datos.tiempo;
                        }
                        break;
                        
                    case 'habilitar_controles':
                        // Solo permitir habilitar/deshabilitar controles si no estamos en modo casa
                        if (!modoCasa) {
                            controlsDisabled = !mensaje.datos.habilitado;
                            console.log(`🔊 HIJO3: Controles ${controlsDisabled ? 'deshabilitados' : 'habilitados'}`);
                        }
                        break;
                        
                    // Mantener compatibilidad con mensajes antiguos (deprecar en el futuro)
                    case 'cambiar_modo':
                        console.warn('⚠️ HIJO3: El tipo de mensaje "cambiar_modo" está obsoleto. Usa "cambioModo" en su lugar.');
                        const modoAntiguo = mensaje.datos?.modo || 'aventura';
                        // Corregido: Usar window.parent.postMessage en lugar de window.postMessage
                        // y mover los datos al objeto datos para mantener consistencia
                        window.parent.postMessage({
                            tipo: 'cambioModo',
                            origen: 'hijo3-audio',
                            datos: {
                                modo: modoAntiguo,
                                timestamp: Date.now()
                            }
                        }, '*');
                        break;
                } // Fin del switch
            } catch (error) {
                console.error('Error al procesar el mensaje:', error, mensaje);
            }
        });

        // Exponer funciones para acceso externo si es necesario
        window.reproductorAudio = {
            reproducir: (archivo) => {
                if (archivo) audioPlayer.src = archivo;
                return audioPlayer.play().then(() => {
                    isPlaying = true;
                    updatePlayPauseIcon();
                });
            },
            pausar: () => {
                audioPlayer.pause();
                isPlaying = false;
                updatePlayPauseIcon();
            },
            detener: () => {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                isPlaying = false;
                updatePlayPauseIcon();
                updateProgress();
            },
            establecerTiempo: (tiempo) => {
                if (typeof tiempo === 'number') {
                    audioPlayer.currentTime = tiempo;
                }
            },
            habilitarControles: (habilitar) => {
                controlsDisabled = !habilitar;
            },
            cambiarModo: (modo) => {
                modoCasa = modo === 'casa';
            }
        };
    </script>
</body>
</html>
