<!DOCTYPE html>
<html lang="es">
<head>
    <script type="module">
      try {
        const moduloMensajeria = await import('./js/mensajeria.js');
        window.Mensajeria = moduloMensajeria.default || moduloMensajeria;
        if (window.Mensajeria && typeof window.Mensajeria.inicializarMensajeria === 'function') {
          window.Mensajeria.inicializarMensajeria({
            iframeId: 'hijo3',
            logLevel: 1,
            debug: true
          });

          // ================== MANEJADORES DE MENSAJES ==================
          // 1. Inicialización (confirmación al padre)
          Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.INICIALIZACION, function(mensaje) {
            console.log('[HIJO3] Confirmando inicialización al padre');
            Mensajeria.enviarMensajeConReintenos(
              'padre',
              Mensajeria.TIPOS_MENSAJE.INICIALIZACION,
              { estado: 'listo', timestamp: Date.now() }
            );
          });

          // 2. Cambio de modo (desde padre u otro hijo)
          Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.CAMBIO_MODO, function(mensaje) {
            console.log('[HIJO3] Cambio de modo recibido:', mensaje.datos);
            // Actualizar el estado local del modo
            const nuevoModo = mensaje.datos.modo || 'aventura';
            console.log(`🔊 HIJO3: Cambiando a modo ${nuevoModo}`);
            
            // Actualizar la interfaz según el modo
            if (nuevoModo === 'casa') {
              document.body.classList.add('modo-casa');
              document.body.classList.remove('modo-aventura');
            } else {
              document.body.classList.add('modo-aventura');
              document.body.classList.remove('modo-casa');
            }
          });

          // 3. Comandos de audio (desde padre u otro hijo)
          Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.AUDIO, function(mensaje) {
            console.log('[HIJO3] Comando de audio recibido:', mensaje.datos);
            const { accion, parametros } = mensaje.datos;
            
            // Procesar el comando de audio
            if (accion === 'reproducir' && parametros && parametros.archivo) {
              // Lógica para reproducir el audio
              console.log(`Reproduciendo audio: ${parametros.archivo}`);
              // Aquí iría el código para reproducir el audio
              
              // Notificar al padre que el audio ha comenzado
              Mensajeria.enviarMensajeConReintenos(
                'padre',
                Mensajeria.TIPOS_MENSAJE.AUDIO,
                { 
                  estado: 'reproduciendo',
                  archivo: parametros.archivo,
                  timestamp: Date.now()
                }
              );
            } else if (accion === 'pausar') {
              // Lógica para pausar el audio
              console.log('Pausando reproducción');
              // Aquí iría el código para pausar el audio
              
              // Notificar al padre que el audio está en pausa
              Mensajeria.enviarMensajeConReintenos(
                'padre',
                Mensajeria.TIPOS_MENSAJE.AUDIO,
                { 
                  estado: 'pausado',
                  timestamp: Date.now()
                }
              );
            } else if (accion === 'detener') {
              // Lógica para detener el audio
              console.log('Deteniendo reproducción');
              // Aquí iría el código para detener el audio
              
              // Notificar al padre que el audio se detuvo
              Mensajeria.enviarMensajeConReintenos(
                'padre',
                Mensajeria.TIPOS_MENSAJE.AUDIO,
                { 
                  estado: 'detenido',
                  timestamp: Date.now()
                }
              );
            }
          });

          // 4. Confirmaciones
          Mensajeria.registrarControlador(Mensajeria.TIPOS_MENSAJE.CONFIRMACION, function(mensaje) {
            console.log('[HIJO3] Confirmación recibida:', mensaje);
            // Procesar confirmaciones si es necesario
          });

          // 5. Notificar al padre que está listo
          Mensajeria.enviarMensajeConReintenos(
            'padre',
            Mensajeria.TIPOS_MENSAJE.INICIALIZACION,
            { estado: 'listo', timestamp: Date.now() }
          );
        }
      } catch (e) {
        console.error('No se pudo cargar mensajeria.js', e);
      }
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reproductor de Audio - Aventura 1 (hijo3)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --btn-size: 60px;
            --icon-size: 1.5em;
            --progress-thick: 20px;
            --trapecio-width: 290px;
            --trapecio-height: 155px;
            --trapecio-bg: white;
            --trapecio-shadow: 0 2px 12px rgba(0,0,0,0.13);
            --trapecio-radius: 15px;
            --progress-color: #0077cc;
            --progress-bg: #e0e0e0;
            --timer-font-size: 1.1em;
            --timer-color: #333;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: transparent !important;
        }

        body {
            font-family: "Book Antiqua", "Palatino Linotype", Palatino, Georgia, serif;
            margin: 0;
            padding: 0;
            background: transparent !important;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }

        .audio-player-controls {
            width: var(--trapecio-width);
            max-width: 98vw;
            min-width: 180px;
            height: var(--trapecio-height);
            background: var(--trapecio-bg);
            clip-path: polygon(8% 0%, 92% 0%, 100% 100%, 0% 100%);
            border-radius: var(--trapecio-radius);
            box-shadow: var(--trapecio-shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            gap: 0.1em;
            z-index: 1200;
            padding: 5px 8px 5px 8px;
            box-sizing: border-box;
            border: none;
            margin: 5px 0;
        }

        .player-buttons-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 2px;
        }

        #playPauseBtn {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            padding: 0;
        }

        #playPauseBtn .icon-play {
            color: white;
            font-weight: bold;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        #playPauseBtn:active:not(:disabled) { transform: scale(0.95); }
        #playPauseBtn.active {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            border: none;
        }
        #playPauseBtn:disabled { 
            background: linear-gradient(135deg, #dc3545, #c82333);
            opacity: 1;
            cursor: not-allowed; 
            opacity: 0.6;
            border: none;
        }

        #retosBtn {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            padding: 0;
        }

        #retosBtn .icon-puzzle {
            background: linear-gradient(135deg, #007bff 0%, #0056d3 50%, #00c6ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        #retosBtn:disabled { 
            background: linear-gradient(135deg, #dc3545, #c82333);
            cursor: not-allowed; 
            opacity: 0.6;
        }

        #retosBtn:disabled .icon-puzzle {
            opacity: 0.6;
        }

        #retosBtn:active:not(:disabled) { transform: scale(0.95); }
        #retosBtn.active {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }

        .progress-row {
            display: flex;
            align-items: center;
            width: 90%;
            margin: 0 0 5px 0;
            padding: 0;
            justify-content: center;
        }

        .progress-container {
            flex: 1;
            width: 100%;
            height: var(--progress-thick);
            background-color: #f0f0f0;
            border-radius: calc(var(--progress-thick) / 2);
            cursor: pointer;
            position: relative;
            margin: 0;
            min-width: 0;
            overflow: visible;
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        #progressBar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #28a745, #1e7e34);
            border-radius: calc(var(--progress-thick) / 2);
            transition: width 0.1s linear;
            position: relative;
        }

        #progressBar::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff;
            border: 3px solid white;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
            display: block;
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        #playPauseBtn:disabled ~ .progress-row #progressBar::after {
            opacity: 0;
        }

        #playPauseBtn:disabled ~ .progress-row #progressBar {
            background: linear-gradient(90deg, #dc3545, #c82333);
        }

        .time-display {
            width: 90%;
            font-size: var(--timer-font-size);
            color: #333;
            text-align: left;
            user-select: none;
            margin: 2px 0;
            white-space: nowrap;
            font-family: inherit;
            display: flex;
            justify-content: space-between;
            font-weight: bold;
        }

        /* Efectos hover */
        #playPauseBtn:hover:not(:disabled),
        #retosBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* Estilos responsivos */
        @media (max-width: 500px) {
            :root {
                --btn-size: 50px;
                --icon-size: 1.3em;
                --trapecio-width: 98vw;
                --trapecio-height: 140px;
                --progress-thick: 16px;
                --timer-font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="audio-player-controls">
        <div class="player-buttons-row">
            <button id="playPauseBtn" aria-label="Reproducir/Pausar">
                <i class="fas fa-play icon-play"></i>
            </button>
            <button id="retosBtn" aria-label="Retos">
                <i class="fas fa-puzzle-piece icon-puzzle"></i>
            </button>
        </div>
        <div class="progress-row">
            <div class="progress-container" id="progressContainer">
                <div id="progressBar"></div>
            </div>
        </div>
        <div class="time-display">
            <span id="currentTime">00:00</span>
            <span id="duration">00:00</span>
        </div>
    </div>

    <audio id="audioPlayer" preload="metadata">
        Tu navegador no soporta el elemento de audio.
    </audio>

    <script type="module">
        // Constantes y variables globales
        let audioPlayer;
        let playPauseBtn;
        let retosBtn;
        let progressBar;
        let progressContainer;
        let currentTimeEl;
        let durationEl;
        let isPlaying = false;
        let controlsDisabled = true;

        // Inicialización cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar referencias a elementos del DOM
            audioPlayer = document.getElementById('audioPlayer');
            playPauseBtn = document.getElementById('playPauseBtn');
            retosBtn = document.getElementById('retosBtn');
            progressBar = document.getElementById('progressBar');
            progressContainer = document.getElementById('progressContainer');
            currentTimeEl = document.getElementById('currentTime');
            durationEl = document.getElementById('duration');

            // Configurar manejadores de eventos
            setupEventListeners();
            
            // Notificar al padre que el reproductor está listo usando Mensajeria
            if (window.Mensajeria && typeof window.Mensajeria.enviarMensaje === 'function') {
                Mensajeria.enviarMensaje(
                    'padre',
                    'reproductor_listo',
                    { estado: 'listo' }
                ).catch(error => {
                    console.error('Error al notificar que el reproductor está listo:', error);
                });
            }
            
            console.log('🎵 HIJO 3: Reproductor de audio inicializado');
        });

        function setupEventListeners() {
            // Control de reproducción
            playPauseBtn.addEventListener('click', togglePlay);
            retosBtn.addEventListener('click', handleRetosClick);
            
            // Control de progreso
            progressContainer.addEventListener('click', setProgress);
            
            // Eventos del reproductor de audio
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', handleAudioEnded);
            audioPlayer.addEventListener('loadedmetadata', updateDuration);
            
            // Eventos de teclado para accesibilidad
            document.addEventListener('keydown', handleKeyDown);
            
            // Configurar arrastrar y soltar para el progreso
            setupDragAndDrop();
        }

        function togglePlay() {
            if (controlsDisabled) return;
            
            if (isPlaying) {
                audioPlayer.pause();
            } else {
                audioPlayer.play().catch(error => {
                    console.error('Error al reproducir el audio:', error);
                });
            }
            updatePlayPauseIcon();
        }

        function updatePlayPauseIcon() {
            const icon = playPauseBtn.querySelector('i');
            if (icon) {
                icon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
            }
        }

        function updateProgress() {
            if (!isFinite(audioPlayer.duration)) return;
            
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressBar.style.width = `${progress}%`;
            
            // Actualizar tiempos
            currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
            
            // Notificar al padre sobre el progreso
            window.parent.postMessage({
                tipo: 'progreso_audio',
                origen: IFRAME_ID,
                datos: {
                    progreso: progress,
                    tiempoActual: audioPlayer.currentTime,
                    duracion: audioPlayer.duration
                }
            }, '*');
        }

        function updateDuration() {
            if (isFinite(audioPlayer.duration)) {
                durationEl.textContent = formatTime(audioPlayer.duration);
            }
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '00:00';
            const minutes = Math.floor(seconds / 60);
            seconds = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function setProgress(e) {
            if (controlsDisabled) return;

            const width = this.clientWidth;
            const clickX = e.offsetX;
            const duration = audioPlayer.duration;
            audioPlayer.currentTime = (clickX / width) * duration;
        }

        function handleAudioEnded() {
            isPlaying = false;
            updatePlayPauseIcon();
            
            // Notificar al padre que el audio terminó usando Mensajeria
            if (window.Mensajeria && typeof window.Mensajeria.enviarMensaje === 'function') {
                Mensajeria.enviarMensaje(
                    'padre',
                    'audio_terminado',
                    { finalizado: true }
                ).catch(error => {
                    console.error('Error al notificar fin de audio:', error);
                });
            } else {
                console.warn('Mensajeria no disponible para notificar fin de audio');
            }
        }

        function handleRetosClick() {
            if (controlsDisabled) return;
            
            // Notificar al padre que se hizo clic en el botón de retos usando Mensajeria
            if (window.Mensajeria && typeof window.Mensajeria.enviarMensaje === 'function') {
                Mensajeria.enviarMensaje(
                    'padre',
                    'abrir_retos',
                    { mostrar: true }
                ).catch(error => {
                    console.error('Error al notificar clic en retos:', error);
                });
            } else {
                console.warn('Mensajeria no disponible para notificar clic en retos');
            }
        }

        function handleKeyDown(e) {
            if (controlsDisabled) return;
            
            switch(e.key) {
                case ' ':
                case 'Spacebar':
                case 'Enter':
                    e.preventDefault();
                    togglePlay();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    audioPlayer.currentTime = Math.min(audioPlayer.currentTime + 5, audioPlayer.duration);
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
                    break;
            }
        }

        function setupDragAndDrop() {
            let isDragging = false;
            
            progressContainer.addEventListener('mousedown', () => {
                if (controlsDisabled) return;
                isDragging = true;
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging || controlsDisabled) return;
                
                const rect = progressContainer.getBoundingClientRect();
                const pos = (e.clientX - rect.left) / rect.width;
                const newTime = Math.max(0, Math.min(1, pos)) * audioPlayer.duration;
                
                if (isFinite(newTime)) {
                    audioPlayer.currentTime = newTime;
                }
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        }

        // Configurar manejadores de eventos de audio
        function setupAudioEventHandlers() {
            audioPlayer.addEventListener('play', () => {
                isPlaying = true;
                updatePlayPauseIcon();
            });
            
            audioPlayer.addEventListener('pause', () => {
                isPlaying = false;
                updatePlayPauseIcon();
            });
            
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', handleAudioEnded);
            
            // Configurar progreso de la barra de progreso
            progressContainer.addEventListener('click', setProgress);
            
            // Configurar botones
            playPauseBtn.addEventListener('click', togglePlay);
            retosBtn.addEventListener('click', handleRetosClick);
            
            // Configurar arrastrar para la barra de progreso
            setupDragAndDrop();
            
            // Configurar atajos de teclado
            document.addEventListener('keydown', handleKeyDown);
        }
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            // Elementos del DOM
            audioPlayer = document.getElementById('audioPlayer');
            playPauseBtn = document.getElementById('playPauseBtn');
            retosBtn = document.getElementById('retosBtn');
            progressBar = document.getElementById('progressBar');
            progressContainer = document.getElementById('progressContainer');
            currentTimeEl = document.getElementById('currentTime');
            durationEl = document.getElementById('duration');
            
            // Configurar manejadores de eventos
            setupAudioEventHandlers();
            
            // Notificar al padre que el reproductor está listo
            if (window.Mensajeria && typeof window.Mensajeria.enviarMensaje === 'function') {
                Mensajeria.enviarMensaje(
                    'padre',
                    'reproductor_listo',
                    { estado: 'listo' }
                ).catch(error => {
                    console.error('Error al notificar que el reproductor está listo:', error);
                });
            }
        });

        // Función para actualizar el progreso del audio
        function updateProgress() {
            if (!audioPlayer.duration) return;
            
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressBar.style.width = `${progress}%`;
            
            // Actualizar tiempos
            currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
            durationEl.textContent = formatTime(audioPlayer.duration);
            
            // Notificar al padre sobre el progreso actual
            if (window.Mensajeria && typeof window.Mensajeria.enviarMensaje === 'function') {
                Mensajeria.enviarMensaje(
                    'padre',
                    'progreso_audio',
                    {
                        progreso: progress,
                        tiempoActual: audioPlayer.currentTime,
                        duracion: audioPlayer.duration
                    }
                ).catch(error => {
                    console.error('Error al notificar progreso de audio:', error);
                });
            }
        }
        
        // Exponer funciones para acceso externo
        window.reproductorAudio = {
            reproducir: (archivo) => {
                if (archivo) audioPlayer.src = archivo;
                return audioPlayer.play().then(() => {
                    isPlaying = true;
                    updatePlayPauseIcon();
                    
                    // Notificar al padre que la reproducción ha comenzado
                    if (window.Mensajeria && typeof window.Mensajeria.enviarMensaje === 'function') {
                        Mensajeria.enviarMensaje(
                            'padre',
                            'audio_iniciado',
                            { 
                                archivo: archivo || audioPlayer.src,
                                tiempoActual: audioPlayer.currentTime,
                                duracion: audioPlayer.duration
                            }
                        ).catch(error => {
                            console.error('Error al notificar inicio de reproducción:', error);
                        });
                    }
                });
            },
            pausar: () => {
                audioPlayer.pause();
                isPlaying = false;
                updatePlayPauseIcon();
            },
            detener: () => {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                isPlaying = false;
                updatePlayPauseIcon();
                updateProgress();
            },
            establecerTiempo: (tiempo) => {
                if (typeof tiempo === 'number') {
                    audioPlayer.currentTime = tiempo;
                }
            },
            habilitarControles: (habilitar) => {
                controlsDisabled = !habilitar;
            },
            cambiarModo: (modo) => {
                modoCasa = modo === 'casa';
            }
        };
    </script>
</body>
</html>
