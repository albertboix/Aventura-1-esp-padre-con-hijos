<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio esp Av1- hijo3</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --btn-size: 60px;
            --icon-size: 1.5em;
            --progress-thick: 20px;
            --trapecio-width: 290px;
            --trapecio-height: 135px; /* Reducido de 140px a 135px */
            --trapecio-bg: white;
            --trapecio-shadow: 0 2px 12px rgba(0,0,0,0.13);
            --trapecio-radius: 15px;
            --progress-color: #0077cc;
            --progress-bg: #e0e0e0;
            --timer-font-size: 1.1em;
            --timer-color: #333;
        }

        /* Encapsular estilos */
        .hijo3-container body, .hijo3-container html {
            height: 100%;
            margin: 0;
            padding: 0;
            background: transparent !important;
        }

        body {
            font-family: "Book Antiqua", "Palatino Linotype", Palatino, Georgia, serif;
            margin: 0;
            padding: 0;
            background: transparent !important;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }

        .audio-player-controls {
            width: var(--trapecio-width);
            max-width: 98vw;
            min-width: 180px;
            height: var(--trapecio-height);
            background: var(--trapecio-bg);
            clip-path: polygon(8% 0%, 92% 0%, 100% 100%, 0% 100%);
            border-radius: var(--trapecio-radius);
            box-shadow: var(--trapecio-shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            gap: 0.05em;
            z-index: 9999; /* Aseguramos que esté por encima de otros elementos */
            padding: 5px 8px 5px 8px;
            box-sizing: border-box;
            border: 0px solid #0077cc; /* Borde para mejor visibilidad */
            margin: 5px 0;
            position: fixed; /* Fijo en la pantalla */
            bottom: 10px; /* Posicionado en la parte inferior */
            left: 50%; /* Centrado horizontalmente */
            transform: translateX(-50%); /* Centrado exacto */
            opacity: 1 !important; /* Forzar visibilidad */
            visibility: visible !important; /* Forzar visibilidad */
            background-color: white !important; /* Fondo blanco para mejor contraste */
        }

        .player-buttons-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 1px; /* MODIFICADO: Reducido de 2px a 1px (mitad) */
        }

        #playPauseBtn {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            padding: 0;
        }

        #playPauseBtn .icon-play {
            color: white;
            font-weight: bold;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        #playPauseBtn:active:not(:disabled) { 
            transform: scale(0.95); 
        }

        #playPauseBtn.active {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            border: none;
        }

        #playPauseBtn:disabled { 
            background: linear-gradient(135deg, #dc3545, #c82333);
            opacity: 0.6;
            cursor: not-allowed; 
            border: none;
        }

        #retosBtn {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            padding: 0;
        }

        #retosBtn .icon-puzzle {
            color: white;
            font-weight: bold;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        #retosBtn:disabled { 
            background: linear-gradient(135deg, #999, #666);
            cursor: not-allowed; 
            opacity: 0.6;
        }

        #retosBtn:active:not(:disabled) { 
            transform: scale(0.95); 
        }

        .progress-row {
            display: flex;
            align-items: center;
            width: 90%;
            margin: 0 0 1px 0; /* Ajustado a 1px para espaciado total de 1px */
            padding: 0;
            justify-content: center;
        }

        .progress-container {
            flex: 1;
            width: 100%;
            height: var(--progress-thick);
            background-color: #f0f0f0;
            border-radius: calc(var(--progress-thick) / 2);
            cursor: pointer;
            position: relative;
            margin: 0;
            min-width: 0;
            overflow: visible;
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        #progressBar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #28a745, #1e7e34);
            border-radius: calc(var(--progress-thick) / 2);
            transition: width 0.1s linear;
            position: relative;
        }

        #progressBar::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff;
            border: 3px solid white;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
            display: block;
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        #playPauseBtn:disabled ~ .progress-row #progressBar::after {
            opacity: 0;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            width: 90%;
            font-size: var(--timer-font-size);
            color: var(--timer-color);
            margin-top: 0; /* Eliminado para tener un espaciado total de 1px */
            font-weight: 500;
        }

        .time-display span {
            font-variant-numeric: tabular-nums;
        }

        /* Estilos para el modo casa (ocultar controles) */
        body.modo-casa .audio-player-controls {
            display: none;
        }

        /* Estilos para el modo aventura (mostrar controles) */
        body.modo-aventura .audio-player-controls {
            display: flex;
        }
    </style>
</head>
<body class="modo-aventura hijo3-container">
    <script type="module">
       // Array de audios correspondientes a las paradas y tramos del recorrido
        // Usando P- para paradas y TR- para tramos, coincidiendo con los IDs del hijo 2
        const audioFiles = [
            // Parada 0 - Inicio
            { 
                id: "audio-P-0", 
                title: "Torres de Serranos (inicio)", 
                file: "Av1_audio_esp/02 Intro ESPAÑOL 2.mp3"
            },
            
            // Tramo 1: Torres de Serranos → Plaza de la crida (Puente de Serranos)
            { 
                id: "audio-TR-1", 
                title: "Tramo 1: Torres de Serranos → Plaza de la crida", 
                file: "Av1_audio_esp/03 Av1 Pista 3 ESPAÑOL.mp3"
            },
            
            // Parada 1: Plaza de la crida (Puente de Serranos)
            { 
                id: "audio-P-1", 
                title: "Parada 1: Plaza de la crida (Puente de Serranos - Reto 3)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 2: Plaza de la crida → Calle Muro de Santa Ana
            { 
                id: "audio-TR-2", 
                title: "Tramo 2: Plaza de la crida → Calle Muro de Santa Ana", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 2: Calle Muro de Santa Ana
            { 
                id: "audio-P-2", 
                title: "Parada 2: Calle Muro de Santa Ana (Reto 4)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 3: Calle Muro de Santa Ana → Palacio de los Borgia
            { 
                id: "audio-TR-3", 
                title: "Tramo 3: Calle Muro de Santa Ana → Palacio de los Borgia", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 3: Iglesia de San Lorenzo
            { 
                id: "audio-P-3", 
                title: "Parada 3: Iglesia de San Lorenzo (Reto 5)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 4: Iglesia de San Lorenzo → Plaza de la Virgen
            { 
                id: "audio-TR-4", 
                title: "Tramo 4: Iglesia de San Lorenzo → Plaza de la Virgen", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 4: Plaza de la Virgen (Reto 6)
            { 
                id: "audio-P-4", 
                title: "Parada 4: Plaza de la Virgen (Reto 6)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 5: Plaza de la Virgen (Reto 7, 8 Puzzle plaza de la virgen)
            { 
                id: "audio-P-5", 
                title: "Parada 5: Plaza de la Virgen (Reto 7, 8 Puzzle)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 5: Plaza de la Virgen → Plaza de la Almoína
            { 
                id: "audio-TR-5", 
                title: "Tramo 5: Plaza de la Virgen → Plaza de la Almoína", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 6: Panel cerámico muro Catedral
            { 
                id: "audio-P-6", 
                title: "Parada 6: Panel cerámico muro Catedral", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 7: Capilla exterior catedral Reto 10
            { 
                id: "audio-P-7", 
                title: "Parada 7: Capilla exterior catedral (Reto 10)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 8: Capilla exterior catedral Reto 11
            { 
                id: "audio-P-8", 
                title: "Parada 8: Capilla exterior catedral (Reto 11)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 9: Arco Novo Catedral y Puerta Negra Basílica
            { 
                id: "audio-P-9", 
                title: "Parada 9: Arco Novo Catedral y Puerta Negra Basílica", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 10: Casa del Punt de Gantxo
            { 
                id: "audio-P-10", 
                title: "Parada 10: Casa del Punt de Gantxo", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 6: Plaza de la Almoína → Museo Arqueológico
            { 
                id: "audio-TR-6", 
                title: "Tramo 6: Plaza de la Almoína → Museo Arqueológico", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 11: Museo arqueológico La Almoína
            { 
                id: "audio-P-11", 
                title: "Parada 11: Museo arqueológico La Almoína", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 12: Museo arqueológico La Almoína (segunda parte)
            { 
                id: "audio-P-12", 
                title: "Parada 12: Museo arqueológico La Almoína (continuación)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 13: Vista de la Catedral, Cimborrio
            { 
                id: "audio-P-13", 
                title: "Parada 13: Vista de la Catedral, Cimborrio", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 7: Museo arqueológico La Almoína → Palacio Arzobispal
            { 
                id: "audio-TR-7", 
                title: "Tramo 7: Museo arqueológico → Palacio Arzobispal", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 14: Palacio Arzobispal y Puerta Románica de la Catedral
            { 
                id: "audio-P-14", 
                title: "Parada 14: Palacio Arzobispal y Puerta Románica", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 15: Puerta Románica de la Catedral
            { 
                id: "audio-P-15", 
                title: "Parada 15: Puerta Románica de la Catedral", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 8: Puerta Románica de la Catedral → Plaza del Ayuntamiento
            { 
                id: "audio-TR-8", 
                title: "Tramo 8: Puerta Románica → Plaza del Ayuntamiento", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 16: Plaza del Ayuntamiento
            { 
                id: "audio-P-16", 
                title: "Parada 16: Plaza del Ayuntamiento", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 9: Plaza del Ayuntamiento → Edificio del Ayuntamiento de València
            { 
                id: "audio-TR-9", 
                title: "Tramo 9: Plaza del Ayuntamiento → Edificio del Ayuntamiento", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 17: Edificio del Ayuntamiento
            { 
                id: "audio-P-17", 
                title: "Parada 17: Edificio del Ayuntamiento", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 18: Edificio del Ayuntamiento (segunda parte)
            { 
                id: "audio-P-18", 
                title: "Parada 18: Edificio del Ayuntamiento (continuación)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 10: Edificio del Ayuntamiento → Estación del Norte
            { 
                id: "audio-TR-10", 
                title: "Tramo 10: Ayuntamiento → Estación del Norte", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 19: Estación del Norte
            { 
                id: "audio-P-19", 
                title: "Parada 19: Estación del Norte", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 11: Estación del Norte → Plaza de Toros de València
            { 
                id: "audio-TR-11", 
                title: "Tramo 11: Estación del Norte → Plaza de Toros", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 12: Plaza de Toros → Casa estilo Árabe
            { 
                id: "audio-TR-12", 
                title: "Tramo 12: Plaza de Toros → Casa estilo Árabe", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 20: Casa estilo Árabe
            { 
                id: "audio-P-20", 
                title: "Parada 20: Casa estilo Árabe", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 21: Casa estilo Árabe, mitad Aventura
            { 
                id: "audio-P-21", 
                title: "Parada 21: Casa estilo Árabe (mitad Aventura)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 13: Casa estilo Árabe → Palacio de Comunicaciones (Correos)
            { 
                id: "audio-TR-13", 
                title: "Tramo 13: Casa estilo Árabe → Palacio de Comunicaciones", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 22: Palacio de Comunicaciones: Correos
            { 
                id: "audio-P-22", 
                title: "Parada 22: Palacio de Comunicaciones (Correos)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 23: Edificio Suay
            { 
                id: "audio-P-23", 
                title: "Parada 23: Edificio Suay", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 14: Palacio de Comunicaciones → Banco de València
            { 
                id: "audio-TR-14", 
                title: "Tramo 14: Palacio de Comunicaciones → Banco de València", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 24: Banco de Valencia
            { 
                id: "audio-P-24", 
                title: "Parada 24: Banco de Valencia", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 15: Banco de València → Palacio del Marqués de Dos Aguas
            { 
                id: "audio-TR-15", 
                title: "Tramo 15: Banco de València → Palacio del Marqués de Dos Aguas", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 25: Palacio del Marqués de Dos Aguas (Museo Nacional de Cerámica)
            { 
                id: "audio-P-25", 
                title: "Parada 25: Palacio del Marqués de Dos Aguas (Museo de Cerámica)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 16: Palacio del Marqués → Mercado Central
            { 
                id: "audio-TR-16", 
                title: "Tramo 16: Palacio del Marqués → Mercado Central", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 26: Mercado central
            { 
                id: "audio-P-26", 
                title: "Parada 26: Mercado central", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 17: Mercado Central → Iglesia de los Santos Juanes
            { 
                id: "audio-TR-17", 
                title: "Tramo 17: Mercado Central → Iglesia de los Santos Juanes", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 27: Iglesia de los Santos Juanes reto 24
            { 
                id: "audio-P-27", 
                title: "Parada 27: Iglesia de los Santos Juanes (Reto 24)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 28: Iglesia de los Santos Juanes reto 25
            { 
                id: "audio-P-28", 
                title: "Parada 28: Iglesia de los Santos Juanes (Reto 25)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 18: Iglesia Santos Juanes → Lonja de València (Mercado de la Seda)
            { 
                id: "audio-TR-18", 
                title: "Tramo 18: Iglesia Santos Juanes → Lonja de València", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 29: Lonja Puerta de Los Pecados barquero
            { 
                id: "audio-P-29", 
                title: "Parada 29: Lonja - Puerta de Los Pecados (barquero)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 30: Lonja Puerta de Los Pecados árbol muerto
            { 
                id: "audio-P-30", 
                title: "Parada 30: Lonja - Puerta de Los Pecados (árbol muerto)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 19: Lonja Gárgolas
            { 
                id: "audio-TR-19", 
                title: "Tramo 19: Lonja - Gárgolas", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 31: Lonja Gárgolas ángel vasija
            { 
                id: "audio-P-31", 
                title: "Parada 31: Lonja - Gárgola del ángel con vasija", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 32: Lonja Gárgolas barbudo y león
            { 
                id: "audio-P-32", 
                title: "Parada 32: Lonja - Gárgola del barbudo con león", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 33: Lonja Gárgolas fornicador ventana
            { 
                id: "audio-P-33", 
                title: "Parada 33: Lonja - Gárgola del fornicador en ventana", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 20: Lonja → Plaza del Doctor Collado
            { 
                id: "audio-TR-20", 
                title: "Tramo 20: Lonja → Plaza del Doctor Collado", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 21: Plaza del Doctor Collado → Plaza del Negrito (Fuente del Negrito)
            { 
                id: "audio-TR-21", 
                title: "Tramo 21: Plaza del Doctor Collado → Fuente del Negrito", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 34: Fuente del Negrito
            { 
                id: "audio-P-34", 
                title: "Parada 34: Fuente del Negrito", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 22: Plaza del Negrito → Calle Caballeros
            { 
                id: "audio-TR-22", 
                title: "Tramo 22: Fuente del Negrito → Calle Caballeros", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 35: Palau de la Generalitat
            { 
                id: "audio-P-35", 
                title: "Parada 35: Palau de la Generalitat", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Tramo 23: Palacio de la Generalitat → Calle de los Serranos (FINAL)
            { 
                id: "audio-TR-23", 
                title: "Tramo 23: Palacio de la Generalitat → Calle de los Serranos", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            },
            
            // Parada 36 - FINAL: Torres de Serranos Final
            { 
                id: "audio-P-36", 
                title: "Parada 36: Torres de Serranos (Final del recorrido)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
            }
        ];

    </script>
    <div class="audio-player-controls">
        <div class="player-buttons-row">
            <button id="playPauseBtn" aria-label="Reproducir/Pausar">
                <i class="fas fa-play icon-play"></i>
            </button>
            <button id="retosBtn" aria-label="Retos">
                <i class="fas fa-puzzle-piece icon-puzzle"></i>
            </button>
        </div>
        <div class="progress-row">
            <div class="progress-container" id="progressContainer">
                <div id="progressBar"></div>
            </div>
        </div>
        <div class="time-display">
            <span id="currentTime">00:00</span>
            <span id="duration">00:00</span>
        </div>
    </div>

    <audio id="audioPlayer" preload="metadata">
        Tu navegador no soporta el elemento de audio.
    </audio>

    <script type="module">
        // Importar utilidades y mensajería
        import logger from './js/logger.js';
        import { 
            inicializarMensajeria, 
            registrarControlador, 
            enviarMensaje,
            enviarACK,
            enviarNACK
        } from './js/mensajeria.js';
        import { TIPOS_MENSAJE } from './js/constants.js';
        import { modoHandler } from './js/modo-handler.js';
        
        // =================================================================================
        // CONFIGURACIÓN
        // =================================================================================
        const CONFIG = {
            IFRAME_ID: 'hijo3',
            COMPONENTE_ID: 'AUDIO_PLAYER',
            DEBUG: true,
            LOG_LEVEL: 1, // 0: debug, 1: info, 2: warn, 3: error, 4: none
            REINTENTOS: {
                MAXIMOS: 3,
                TIEMPO_ESPERA: 2000,
                FACTOR: 2
            }
        };
        
        // Alias para compatibilidad
        const IFRAME_ID = CONFIG.IFRAME_ID;
        
        // =================================================================================
        // FUNCIONES DE MENSAJERÍA MEJORADAS
        // =================================================================================
        
        /**
         * Envía un mensaje con confirmación ACK/NACK
         * @param {string} destino - Destino del mensaje ('padre' o ID de iframe)
         * @param {string} tipo - Tipo de mensaje
         * @param {Object} datos - Datos del mensaje
         * @param {Object} opciones - Opciones de envío
         * @returns {Promise<Object>} Respuesta del destinatario
         */
        async function enviarMensajeConACK(destino, tipo, datos, opciones = {}) {
            const config = {
                timeout: opciones.timeout || CONFIG.REINTENTOS.TIEMPO_ESPERA,
                reintentos: opciones.reintentos || CONFIG.REINTENTOS.MAXIMOS,
                silencioso: opciones.silencioso || false,
                ...opciones
            };

            if (!destino || !tipo) {
                throw new Error('Se requieren destino y tipo de mensaje');
            }

            const solicitudId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const mensaje = {
                tipo,
                datos: {
                    ...datos,
                    solicitudId,
                    timestamp: new Date().toISOString(),
                    origen: CONFIG.IFRAME_ID
                }
            };

            let ultimoError = null;

            for (let intento = 1; intento <= config.reintentos; intento++) {
                try {
                    console.log(`📤 [${CONFIG.IFRAME_ID}] Enviando mensaje (${solicitudId}) [${intento}/${config.reintentos}]:`, { tipo, destino });

                    const respuesta = await new Promise((resolve, reject) => {
                        const timeoutId = setTimeout(() => {
                            reject(new Error(`Tiempo de espera agotado (${config.timeout}ms)`));
                        }, config.timeout);

                        const manejarRespuesta = (event) => {
                            if (event.data?.tipo === 'SISTEMA.ACK' &&
                                event.data?.datos?.solicitudId === solicitudId) {
                                clearTimeout(timeoutId);
                                window.removeEventListener('message', manejarRespuesta);
                                resolve(event.data);
                            } else if (event.data?.tipo === 'SISTEMA.NACK' &&
                                     event.data?.datos?.solicitudId === solicitudId) {
                                clearTimeout(timeoutId);
                                window.removeEventListener('message', manejarRespuesta);
                                const error = new Error(event.data.datos.mensaje || 'Error en el servidor');
                                error.codigo = event.data.datos.codigo || 'NACK_RECIBIDO';
                                error.detalles = event.data.datos.detalles;
                                reject(error);
                            }
                        };

                        window.addEventListener('message', manejarRespuesta, false);

                        try {
                            window.parent.postMessage(mensaje, '*');
                        } catch (error) {
                            clearTimeout(timeoutId);
                            window.removeEventListener('message', manejarRespuesta);
                            reject(new Error(`Error al enviar mensaje: ${error.message}`));
                        }
                    });

                    console.log(`✅ [${CONFIG.IFRAME_ID}] ACK recibido para ${solicitudId}`, respuesta);
                    return respuesta.datos;

                } catch (error) {
                    ultimoError = error;
                    if (config.onRetry && intento < config.reintentos) {
                        config.onRetry(intento, config.reintentos);
                    }
                    if (intento < config.reintentos) {
                        const delay = Math.min(1000 * Math.pow(2, intento - 1), 10000);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            if (!config.silencioso) {
                console.error(`❌ [${CONFIG.IFRAME_ID}] No se pudo enviar el mensaje después de ${config.reintentos} intentos`);
                if (ultimoError) {
                    console.error('Último error:', ultimoError);
                }
            }
            throw ultimoError || new Error('Error desconocido al enviar mensaje');
        }

        // Elementos del DOM
        const audioPlayer = document.getElementById('audioPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const retosBtn = document.getElementById('retosBtn');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const currentTimeElement = document.getElementById('currentTime');
        const durationElement = document.getElementById('duration');

        let currentAudioId = null;

        // --- LÓGICA DEL REPRODUCTOR ---
        
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function updateUI() {
            if (audioPlayer.paused) {
                playPauseBtn.innerHTML = '<i class="fas fa-play icon-play"></i>';
            } else {
                playPauseBtn.innerHTML = '<i class="fas fa-pause icon-play"></i>';
            }
        }

        audioPlayer.addEventListener('timeupdate', () => {
            const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressBar.style.width = `${percent}%`;
            currentTimeElement.textContent = formatTime(audioPlayer.currentTime);
        });

        audioPlayer.addEventListener('loadedmetadata', () => {
            durationElement.textContent = formatTime(audioPlayer.duration);
        });

        // Modificar manejo de reproducción de audio para notificar al padre
        audioPlayer.addEventListener('play', async () => {
            updateUI();
            
            // Notificar al padre que se inició la reproducción con ACK
            if (currentAudioId) {
                try {
                    await enviarMensajeConACK('padre', TIPOS_MENSAJE.AUDIO.REPRODUCIR, { 
                        audioId: currentAudioId,
                        timestamp: new Date().toISOString(),
                        origen: CONFIG.IFRAME_ID,
                        duracion: audioPlayer.duration || 0,
                        tiempoActual: audioPlayer.currentTime || 0
                    }, {
                        reintentos: 3,
                        timeout: 3000,
                        onRetry: (intento, total) => {
                            console.log(`🔄 [${CONFIG.IFRAME_ID}] Reintentando notificación de reproducción (${intento}/${total})...`);
                        }
                    });
                    console.log(`▶️ [${CONFIG.IFRAME_ID}] Notificación de reproducción confirmada`);
                } catch (error) {
                    console.error(`❌ [${CONFIG.IFRAME_ID}] Error al notificar reproducción:`, error);
                    // No detenemos la reproducción por un error de notificación
                }
            }
        });

        audioPlayer.addEventListener('pause', async () => {
            updateUI();
            
            // Notificar al padre que se pausó la reproducción
            if (currentAudioId) {
                try {
                    await enviarMensajeConACK('padre', TIPOS_MENSAJE.AUDIO.PAUSA, { 
                        audioId: currentAudioId,
                        timestamp: new Date().toISOString(),
                        origen: CONFIG.IFRAME_ID,
                        tiempoActual: audioPlayer.currentTime || 0
                    }, {
                        reintentos: 2,
                        timeout: 2000,
                        silencioso: true
                    });
                    console.log(`⏸️ [${CONFIG.IFRAME_ID}] Notificación de pausa confirmada`);
                } catch (error) {
                    console.error(`❌ [${CONFIG.IFRAME_ID}] Error al notificar pausa:`, error);
                }
            }
        });

        audioPlayer.addEventListener('ended', async () => {
            // Notificar al padre que terminó el audio con ACK
            if (currentAudioId) {
                try {
                    await enviarMensajeConACK('padre', TIPOS_MENSAJE.AUDIO.FIN_REPRODUCCION, { 
                        audioId: currentAudioId,
                        timestamp: new Date().toISOString(),
                        origen: CONFIG.IFRAME_ID,
                        duracion: audioPlayer.duration || 0,
                        tiempoFinal: audioPlayer.currentTime || 0
                    }, {
                        reintentos: 3,
                        timeout: 3000,
                        silencioso: true // No mostrar errores de reintentos
                    });
                    console.log(`⏹️ [${CONFIG.IFRAME_ID}] Notificación de fin de reproducción confirmada`);
                } catch (error) {
                    console.error(`❌ [${CONFIG.IFRAME_ID}] Error al notificar fin de reproducción:`, error);
                }
            }
            updateUI();
        });
        
        // Manejar errores de reproducción
        audioPlayer.addEventListener('error', async () => {
            const errorDetails = {
                code: audioPlayer.error ? audioPlayer.error.code : 'UNKNOWN_ERROR',
                message: audioPlayer.error ? audioPlayer.error.message : 'Error desconocido',
                currentSrc: audioPlayer.currentSrc,
                currentTime: audioPlayer.currentTime,
                duration: audioPlayer.duration,
                audioId: currentAudioId,
                timestamp: new Date().toISOString(),
                origen: CONFIG.IFRAME_ID
            };
            
            logger.error('Error en reproductor de audio', errorDetails);
            console.error(`❌ [${CONFIG.IFRAME_ID}] Error en el reproductor de audio:`, errorDetails);
            
            // Notificar al padre del error
            try {
                await enviarMensajeConACK('padre', TIPOS_MENSAJE.AUDIO.ERROR, errorDetails, {
                    reintentos: 2,
                    timeout: 3000,
                    silencioso: false
                });
            } catch (error) {
                logger.error('Error al notificar error de audio al padre', { 
                    error: error.message,
                    stack: error.stack,
                    timestamp: new Date().toISOString()
                });
                console.error(`❌ [${CONFIG.IFRAME_ID}] No se pudo notificar el error al padre:`, error);
            }
        });

        playPauseBtn.addEventListener('click', () => {
            if (audioPlayer.src) {
                audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause();
            }
        });

        progressContainer.addEventListener('click', (e) => {
            if (!audioPlayer.src || !audioPlayer.duration) return;
            const rect = progressContainer.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = percent * audioPlayer.duration;
        });

        // --- MANEJADORES DE MENSAJES ---

        // Manejadores para mensajes
        async function manejarConfirmacion(mensaje) {
            console.log('✅ [AUDIO] Recibida confirmación:', mensaje);
            return { 
                estado: 'ok',
                timestamp: new Date().toISOString(),
                origen: IFRAME_ID
            };
        }

        // Using the imported manejarPing from mensajeria.js instead of redefini
