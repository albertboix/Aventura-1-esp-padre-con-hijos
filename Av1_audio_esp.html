<!DOCTYPE html>
<html lang="es">
<head>
    <script type="module">
      // Importar el módulo de mensajería
      import { inicializarMensajeria } from './js/mensajeria.js';

      // ================== CONFIGURACIÓN ==================
      const CONFIG = {
        IFRAME_ID: 'hijo3-audio',
        LOG_LEVEL: 1,
        VERSION: '1.0.0',
        DEBUG: true,
        REINTENTOS: { MAXIMOS: 3, TIEMPO_ESPERA: 1000, FACTOR: 2 },
        ESTADO_INICIAL: {
          modo: 'aventura',
          volumen: 0.7,
          reproduciendo: false,
          pistaActual: null,
          controlesHabilitados: true,
          ultimoError: null
        }
      };

      let estadoApp = { ...CONFIG.ESTADO_INICIAL };
      let Mensajeria = null;
      let transaccionActual = null;

      // ================== INICIALIZACIÓN ==================
      async function inicializarSistemaMensajeria() {
        const ID_TRANSACCION = `init-${Date.now()}`;
        transaccionActual = ID_TRANSACCION;
        try {
          window.Mensajeria = await inicializarMensajeria({
            iframeId: CONFIG.IFRAME_ID,
            logLevel: CONFIG.LOG_LEVEL,
            debug: CONFIG.DEBUG
          });
          Mensajeria = window.Mensajeria;
          await registrarControladores();
          configurarSistemaReconexion();
          await notificarEstado('reproductor_listo', {
            configuracion: {
              volumen: estadoApp.volumen,
              modo: estadoApp.modo,
              controlesHabilitados: estadoApp.controlesHabilitados
            }
          });
          return true;
        } catch (error) {
          mostrarError('Error al inicializar el sistema de mensajería: ' + error.message);
          await notificarError('error_inicializacion', {
            error: error.message,
            stack: error.stack,
            timestamp: new Date().toISOString()
          });
          manejarErrorConexion(error);
          return false;
        } finally {
          if (transaccionActual === ID_TRANSACCION) transaccionActual = null;
        }
      }

      function configurarSistemaReconexion() {
        // Verificar si ya está configurado
        if (window.sistemaReconexion) {
          console.warn('[AUDIO] El sistema de reconexión ya está configurado');
          return;
        }
        
        console.log('[AUDIO] Configurando sistema de reconexión...');
        
        const estadoConexion = {
          conectado: navigator.onLine,
          intentos: 0,
          maxIntentos: 5,
          intervalo: null,
          listeners: {
            online: [],
            offline: []
          }
        };
        
        // Función para manejar cambios en la conexión
        const manejarCambioConexion = () => {
          const estabaConectado = estadoConexion.conectado;
          estadoConexion.conectado = navigator.onLine;
          
          // Solo notificar si el estado cambió
          if (estadoConexion.conectado !== estabaConectado) {
            console.log(`[AUDIO] Estado de conexión: ${estadoConexion.conectado ? 'conectado' : 'desconectado'}`);
            
            // Notificar a los listeners
            const evento = estadoConexion.conectado ? 'online' : 'offline';
            estadoConexion.listeners[evento].forEach(callback => {
              try { callback(); } catch (e) { console.error('Error en listener de conexión:', e); }
            });
            
            // Si se recuperó la conexión, notificar al padre
            if (estadoConexion.conectado) {
              notificarEstado('conexion_restablecida');
              estadoConexion.intentos = 0; // Reiniciar contador de intentos
            } else {
              // Si se perdió la conexión, intentar reconexión
              manejarErrorConexion(new Error('Se perdió la conexión a internet'));
            }
          }
        };
        
        // Configurar eventos de red
        window.addEventListener('online', manejarCambioConexion);
        window.addEventListener('offline', manejarCambioConexion);
        
        // Verificación periódica
        estadoConexion.intervalo = setInterval(() => {
          if (!navigator.onLine) {
            manejarErrorConexion(new Error('Verificación periódica: Sin conexión'));
          }
        }, 30000); // Verificar cada 30 segundos
        
        // API pública del sistema de reconexión
        window.sistemaReconexion = {
          get estado() { return { ...estadoConexion }; },
          agregarListener: (evento, callback) => {
            if (estadoConexion.listeners[evento]) {
              estadoConexion.listeners[evento].push(callback);
              return () => {
                estadoConexion.listeners[evento] = estadoConexion.listeners[evento].filter(cb => cb !== callback);
              };
            }
          },
          forzarReconexion: () => {
            console.log('[AUDIO] Reconexión forzada solicitada');
            estadoConexion.intentos = 0;
            window.location.reload();
          },
          limpiar: () => {
            clearInterval(estadoConexion.intervalo);
            window.removeEventListener('online', manejarCambioConexion);
            window.removeEventListener('offline', manejarCambioConexion);
            delete window.sistemaReconexion;
          }
        };
        
        // Estado inicial
        manejarCambioConexion();
        console.log('[AUDIO] Sistema de reconexión configurado');
      }
      
      function manejarErrorConexion(error) {
        console.error('[AUDIO] Error de conexión:', error);
        
        // Mostrar notificación al usuario
        mostrarNotificacion('error', 'Problema de conexión. Intentando reconectar...');
        
        // Si hay un sistema de reconexión configurado, usarlo
        if (window.sistemaReconexion) {
          const { intentos, maxIntentos } = window.sistemaReconexion.estado;
          
          if (intentos < maxIntentos) {
            const tiempoEspera = Math.min(1000 * Math.pow(2, intentos), 30000); // Exponencial hasta 30s
            console.log(`[AUDIO] Reintentando en ${tiempoEspera}ms (${intentos + 1}/${maxIntentos})`);
            
            setTimeout(() => {
              if (navigator.onLine) {
                window.location.reload();
              } else {
                manejarErrorConexion(error);
              }
            }, tiempoEspera);
            
            // Incrementar contador de intentos
            window.sistemaReconexion.estado.intentos++;
          } else {
            console.error('[AUDIO] Se alcanzó el número máximo de intentos de reconexión');
            mostrarError('No se pudo restablecer la conexión. Por favor, recarga la página.');
          }
        } else {
          // Si no hay sistema de reconexión, recargar después de un tiempo
          setTimeout(() => window.location.reload(), 5000);
        }
      }
      
      // ================== REGISTRO DE CONTROLADORES ==================
      
      async function registrarControladores() {
        if (!Mensajeria) throw new Error('Mensajería no inicializada');
        try {
          const manejadores = {
            [Mensajeria.TIPOS_MENSAJE.INICIALIZACION]: manejarInicializacion,
            [Mensajeria.TIPOS_MENSAJE.CAMBIO_MODO]: manejarCambioModo,
            [Mensajeria.TIPOS_MENSAJE.AUDIO]: manejarComandoAudio,
            [Mensajeria.TIPOS_MENSAJE.CONFIRMACION]: manejarConfirmacion,
            [Mensajeria.TIPOS_MENSAJE.SOLICITUD_ESTADO]: manejarSolicitudEstado,
            [Mensajeria.TIPOS_MENSAJE.HABILITAR_CONTROLES]: (msg) => manejarEstadoControles(msg, true),
            [Mensajeria.TIPOS_MENSAJE.DESHABILITAR_CONTROLES]: (msg) => manejarEstadoControles(msg, false),
            'sistema:ping': manejarPing,
            'sistema:reiniciar': manejarReinicio
          };
          for (const [tipo, manejador] of Object.entries(manejadores)) {
            if (typeof manejador === 'function') Mensajeria.registrarControlador(tipo, manejador);
          }
          return true;
        } catch (error) {
          throw error;
        }
      }
      
      // ================== MANEJADORES DE MENSAJES ==================
      
      /**
       * Notifica un error al iframe padre
       * @param {string} tipo - Tipo de error
       * @param {Object} datos - Datos adicionales del error
       */
      async function notificarError(tipo, datos = {}) {
        try {
          if (window.parent && window.parent !== window) {
            await window.parent.postMessage({
              tipo: 'error',
              origen: CONFIG.IFRAME_ID,
              timestamp: new Date().toISOString(),
              error: {
                tipo,
                ...datos
              }
            }, '*');
          }
        } catch (error) {
          console.error('Error al notificar error al padre:', error);
        }
      }
      
      /**
       * Notifica un cambio de estado al iframe padre
       * @param {string} tipo - Tipo de estado
       * @param {Object} datos - Datos del estado
       */
      async function notificarEstado(tipo, datos = {}) {
        try {
          if (window.parent && window.parent !== window) {
            await window.parent.postMessage({
              tipo: 'estado',
              subtipo: tipo,
              origen: CONFIG.IFRAME_ID,
              timestamp: new Date().toISOString(),
              datos
            }, '*');
          }
        } catch (error) {
          console.error('Error al notificar estado al padre:', error);
        }
      }
      
      // Estado global de la aplicación (ya definido al inicio del archivo)
      
      /**
       * Manejador de inicialización
       * @param {Object} mensaje - Mensaje de inicialización
       * @returns {Promise<Object>} Respuesta de confirmación
       */
      async function manejarInicializacion(mensaje) {
        const ID_TRANSACCION = `init-${Date.now()}`;
        const log = (nivel, msg, datos = {}) => {
          console[nivel](`[${CONFIG.IFRAME_ID}] [${ID_TRANSACCION}] ${msg}`, datos);
        };
        
        log('info', 'Manejando inicialización', { origen: mensaje.origen });
        
        try {
          // Validar mensaje de inicialización
          if (!mensaje.datos) {
            throw new Error('Mensaje de inicialización sin datos');
          }
          
          // Aplicar configuración inicial
          const { modo, volumen, controlesHabilitados } = mensaje.datos.configuracion || {};
          
          // Actualizar estado de la aplicación
          if (modo) estadoApp.modo = modo;
          if (volumen !== undefined) estadoApp.volumen = Math.max(0, Math.min(1, parseFloat(volumen)));
          if (typeof controlesHabilitados === 'boolean') {
            estadoApp.controlesHabilitados = controlesHabilitados;
          }
          
          // Aplicar configuración al reproductor de audio si existe
          if (window.audioPlayer) {
            window.audioPlayer.volume = estadoApp.volumen;
          }
          
          // Actualizar interfaz de usuario
          actualizarInterfaz();
          
          // Confirmar inicialización
          const respuesta = {
            estado: 'ok',
            mensaje: 'Reproductor de audio inicializado',
            configuracion: {
              modo: estadoApp.modo,
              volumen: estadoApp.volumen,
              controlesHabilitados: estadoApp.controlesHabilitados
            },
            timestamp: new Date().toISOString()
          }
          
          log('info', 'Inicialización completada', respuesta);
          return respuesta;
          
        } catch (error) {
          const errorMsg = `Error en inicialización: ${error.message}`;
          log('error', errorMsg, { stack: error.stack });
          
          // Notificar error al padre
          await notificarError('error_inicializacion', {
            error: error.message,
            stack: error.stack,
            timestamp: new Date().toISOString()
          });
          
          throw error; // Relanzar para manejo de errores superior
        }
      }
      
      /**
       * Manejador de cambio de modo
       * @param {Object} mensaje - Mensaje con los datos del modo
       * @returns {Promise<Object>} Respuesta de confirmación
       */
      async function manejarCambioModo(mensaje) {
        const ID_TRANSACCION = `modo-${Date.now()}`;
        const log = (nivel, msg, datos = {}) => {
          console[nivel](`[${CONFIG.IFRAME_ID}] [${ID_TRANSACCION}] ${msg}`, datos);
        };
        
        log('info', 'Manejando cambio de modo', { datos: mensaje.datos });
        
        try {
          // Validar mensaje
          if (!mensaje.datos || !mensaje.datos.modo) {
            throw new Error('Mensaje de cambio de modo sin datos válidos');
          }
          
          const { modo, forzar = false } = mensaje.datos;
          
          // Validar modo
          if (!['casa', 'aventura'].includes(modo)) {
            throw new Error(`Modo no válido: ${modo}`);
          }
          
          // Si no hay cambio, retornar sin hacer nada
          if (estadoApp.modo === modo && !forzar) {
            log('debug', 'El modo ya está establecido, ignorando');
            return { estado: 'ok', mensaje: 'El modo ya estaba establecido' };
          }
          
          // Actualizar estado
          const modoAnterior = estadoApp.modo;
          estadoApp.modo = modo;
          
          // Aplicar cambios en la interfaz
          actualizarInterfaz();
          
          // Notificar cambio de modo
          await notificarEstado('cambio_modo', {
            modoAnterior,
            modoNuevo: modo,
            timestamp: new Date().toISOString()
          });
          
          const respuesta = {
            estado: 'ok',
            mensaje: `Modo cambiado a: ${modo}`,
            modoAnterior,
            modoNuevo: modo,
            timestamp: new Date().toISOString()
          };
          
          log('info', 'Cambio de modo completado', respuesta);
          return respuesta;
          
        } catch (error) {
          const errorMsg = `Error al cambiar el modo: ${error.message}`;
          log('error', errorMsg, { stack: error.stack });
          
          // Notificar error al padre
          await notificarError('error_cambio_modo', {
            error: error.message,
            stack: error.stack,
            modoActual: estadoApp.modo,
            timestamp: new Date().toISOString()
          });
          
          throw error; // Relanzar para manejo de errores superior
        }
      }
      
      /**
       * Manejador de confirmaciones
       * @param {Object} mensaje - Mensaje de confirmación
       * @returns {Promise<Object>} Resultado de la confirmación
       */
      async function manejarConfirmacion(mensaje) {
        const ID_TRANSACCION = `confirm-${Date.now()}`;
        const log = (nivel, msg, datos = {}) => {
          console[nivel](`[${CONFIG.IFRAME_ID}] [${ID_TRANSACCION}] ${msg}`, datos);
        };
        
        log('info', 'Manejando confirmación', { tipo: mensaje.tipo });
        
        try {
          // Procesar confirmación según el tipo
          switch (mensaje.tipo) {
            case 'inicializacion':
              log('info', 'Inicialización confirmada por el padre');
              break;
              
            case 'cambio_modo':
              log('info', 'Cambio de modo confirmado', { modo: mensaje.datos?.modo });
              break;
              
            case 'audio':
              log('info', 'Comando de audio confirmado', { accion: mensaje.datos?.accion });
              break;
              
            default:
              log('warn', 'Tipo de confirmación no reconocido', { tipo: mensaje.tipo });
          }
          
          return { estado: 'ok', mensaje: 'Confirmación procesada' };
          
        } catch (error) {
          const errorMsg = `Error al procesar confirmación: ${error.message}`;
          log('error', errorMsg, { stack: error.stack });
          throw error;
        }
      }
      
      /**
       * Manejador de solicitudes de estado
       * @param {Object} mensaje - Mensaje de solicitud de estado
       * @returns {Promise<Object>} Estado actual del reproductor
       */
      async function manejarSolicitudEstado(mensaje) {
        const ID_TRANSACCION = `estado-${Date.now()}`;
        const log = (nivel, msg, datos = {}) => {
          console[nivel](`[${CONFIG.IFRAME_ID}] [${ID_TRANSACCION}] ${msg}`, datos);
        };
        
        log('info', 'Procesando solicitud de estado');
        
        try {
          // Obtener el estado actual del reproductor de audio
          const estadoReproductor = await obtenerEstadoReproductor();
          
          // Construir respuesta con el estado completo
          const respuesta = {
            estado: 'ok',
            reproductor: estadoReproductor,
            aplicacion: {
              modo: estadoApp.modo,
              controlesHabilitados: estadoApp.controlesHabilitados,
              volumen: estadoApp.volumen,
              ultimoError: estadoApp.ultimoError,
              timestamp: new Date().toISOString()
            },
            metadatos: {
              version: CONFIG.VERSION,
              timestamp: new Date().toISOString(),
              idTransaccion: ID_TRANSACCION
            }
          };
          
          log('debug', 'Estado actual del reproductor', respuesta);
          return respuesta;
          
        } catch (error) {
          const errorMsg = `Error al obtener el estado: ${error.message}`;
          log('error', errorMsg, { stack: error.stack });
          
          // Notificar error al padre
          await notificarError('error_estado', {
            error: error.message,
            stack: error.stack,
            timestamp: new Date().toISOString()
          });
          
          throw new Error(errorMsg);
        }
      }
      
      /**
       * Maneja el estado de los controles (habilitar/deshabilitar)
       * @param {Object} mensaje - Mensaje con la acción
       * @param {boolean} habilitar - True para habilitar, false para deshabilitar
       * @returns {Promise<Object>} Resultado de la operación
       */
      async function manejarEstadoControles(mensaje, habilitar) {
        const accion = habilitar ? 'habilitar' : 'deshabilitar';
        const ID_TRANSACCION = `controles-${accion}-${Date.now()}`;
        const log = (nivel, msg, datos = {}) => {
          console[nivel](`[${CONFIG.IFRAME_ID}] [${ID_TRANSACCION}] ${msg}`, datos);
        };
        
        log('info', `${habilitar ? 'Habilitando' : 'Deshabilitando'} controles`);
        
        try {
          // Actualizar estado de la aplicación
          estadoApp.controlesHabilitados = habilitar;
          
          // Aplicar cambios en la interfaz
          actualizarInterfaz();
          
          // Notificar cambio de estado
          await notificarEstado('controles_actualizados', {
            controlesHabilitados: habilitar,
            motivo: mensaje.datos?.razon || 'Solicitado por el sistema',
            timestamp: new Date().toISOString()
          });
          
          const respuesta = {
            estado: 'ok',
            mensaje: `Controles ${habilitar ? 'habilitados' : 'deshabilitados'} correctamente`,
            controlesHabilitados: habilitar,
            timestamp: new Date().toISOString()
          };
          
          log('info', 'Estado de controles actualizado', respuesta);
          return respuesta;
          
        } catch (error) {
          const errorMsg = `Error al ${accion} controles: ${error.message}`;
          log('error', errorMsg, { stack: error.stack });
          
          // Notificar error al padre
          await notificarError(`error_${accion}_controles`, {
            error: error.message,
            stack: error.stack,
            timestamp: new Date().toISOString()
          });
          
          throw error;
        }
      }
      
      /**
       * Manejador de ping del sistema
       * @returns {Promise<Object>} Respuesta de ping
       */
      async function manejarPing() {
        try {
          return {
            estado: 'ok',
            mensaje: 'pong',
            timestamp: new Date().toISOString(),
            modo: estadoApp.modo,
            controlesHabilitados: estadoApp.controlesHabilitados
          };
        } catch (error) {
          console.error('Error en manejarPing:', error);
          return {
            estado: 'error',
            mensaje: error.message,
            timestamp: new Date().toISOString()
          };
        }
      }
      
      /**
       * Manejador de reinicio del sistema
       * @returns {Promise<Object>} Resultado del reinicio
       */
      async function manejarReinicio() {
        const ID_TRANSACCION = `reinicio-${Date.now()}`;
        console.log(`[${CONFIG.IFRAME_ID}] [${ID_TRANSACCION}] Reiniciando reproductor...`);
        
        try {
          // Detener cualquier reproducción en curso
          if (window.audioPlayer) {
            await detenerAudio();
          }
          
          // Restablecer estado
          estadoApp = {
            modo: 'casa',
            controlesHabilitados: true,
            volumen: 0.7,
            ultimoError: null
          };
          
          // Recargar la interfaz
          actualizarInterfaz();
          
          console.log(`[${CONFIG.IFRAME_ID}] [${ID_TRANSACCION}] Reproductor reiniciado`);
          
          return {
            estado: 'ok',
            mensaje: 'Reproductor reiniciado correctamente',
            timestamp: new Date().toISOString()
          };
          
        } catch (error) {
          console.error(`[${CONFIG.IFRAME_ID}] [${ID_TRANSACCION}] Error al reiniciar:`, error);
          throw error;
        }
      }
      
      // ================== FUNCIONES AUXILIARES ==================
      
      /**
       * Obtiene el estado actual del reproductor de audio
       * @returns {Promise<Object>} Estado del reproductor
       */
      async function obtenerEstadoReproductor() {
        if (!window.audioPlayer) {
          return { estado: 'no_inicializado' };
        }
        
        return {
          estado: window.audioPlayer.paused ? 'pausado' : 'reproduciendo',
          volumen: window.audioPlayer.volume,
          muted: window.audioPlayer.muted,
          duracion: window.audioPlayer.duration || 0,
          tiempoActual: window.audioPlayer.currentTime || 0,
          fuenteActual: window.audioPlayer.currentSrc || '',
          velocidad: window.audioPlayer.playbackRate
        };
      }
      
      /**
       * Reproduce un archivo de audio
       * @param {string} archivo - Ruta del archivo de audio
       * @param {Object} opciones - Opciones de reproducción
       * @returns {Promise<Object>} Resultado de la operación
       */
      async function reproducirAudio(archivo, opciones = {}) {
        const ID_TRANSACCION = `play-${Date.now()}`;
        console.log(`[${CONFIG.IFRAME_ID}] [${ID_TRANSACCION}] Reproduciendo audio:`, archivo);
        
        try {
          // Crear o reutilizar el reproductor de audio
          if (!window.audioPlayer) {
            window.audioPlayer = new Audio();
            configurarEventosAudio();
          }
          
          // Detener reproducción actual si hay alguna
          await detenerAudio();
          
          // Configurar la fuente del audio
          window.audioPlayer.src = archivo;
          
          // Aplicar opciones
          if (opciones.volumen !== undefined) {
            window.audioPlayer.volume = Math.max(0, Math.min(1, parseFloat(opciones.volumen)));
          }
          
          if (opciones.velocidad) {
            window.audioPlayer.playbackRate = parseFloat(opciones.velocidad) || 1.0;
          }
          
          // Iniciar reproducción
          await window.audioPlayer.play();
          
          return {
            estado: 'reproduciendo',
            archivo,
            volumen: window.audioPlayer.volume,
            timestamp: new Date().toISOString()
          };
          
        } catch (error) {
          console.error(`[${CONFIG.IFRAME_ID}] [${ID_TRANSACCION}] Error al reproducir audio:`, error);
          
          // Notificar error al padre
          await notificarError('error_reproduccion', {
            archivo,
            error: error.message,
            stack: error.stack,
            timestamp: new Date().toISOString()
          });
          
          throw error;
        }
      }
      
      /**
       * Pausa la reproducción de audio
       * @returns {Promise<Object>} Resultado de la operación
       */
      async function pausarAudio() {
        if (!window.audioPlayer) {
          return { estado: 'no_inicializado' };
        }
        
        try {
          await window.audioPlayer.pause();
          return { estado: 'pausado', timestamp: new Date().toISOString() };
        } catch (error) {
          console.error('[AUDIO] Error al pausar:', error);
          throw error;
        }
      }
      
      /**
       * Detiene la reproducción de audio
       * @returns {Promise<Object>} Resultado de la operación
       */
      async function detenerAudio() {
        if (!window.audioPlayer) {
          return { estado: 'no_inicializado' };
        }
        
        try {
          window.audioPlayer.pause();
          window.audioPlayer.currentTime = 0;
          return { estado: 'detenido', timestamp: new Date().toISOString() };
        } catch (error) {
          console.error('[AUDIO] Error al detener:', error);
          throw error;
        }
      }
      
      /**
       * Establece el volumen del reproductor
       * @param {number} volumen - Nivel de volumen (0-1)
       * @returns {Promise<Object>} Resultado de la operación
       */
      async function establecerVolumen(volumen) {
        if (!window.audioPlayer) {
          return { estado: 'no_inicializado' };
        }
        
        try {
          window.audioPlayer.volume = Math.max(0, Math.min(1, parseFloat(volumen)));
          return { estado: 'ok', volumen: window.audioPlayer.volume };
        } catch (error) {
          console.error('[AUDIO] Error al establecer volumen:', error);
          throw error;
        }
      }
      
      /**
       * Configura los eventos del reproductor de audio
       */
      function configurarEventosAudio() {
        if (!window.audioPlayer) return;
        
        // Evento de reproducción
        window.audioPlayer.addEventListener('play', () => {
          estadoApp.reproduciendo = true;
          notificarEstado('reproduccion_estado', { reproduciendo: true });
        });
        
        // Evento de pausa
        window.audioPlayer.addEventListener('pause', () => {
          estadoApp.reproduciendo = false;
          notificarEstado('reproduccion_estado', { reproduciendo: false });
        });
        
        // Evento de finalización
        window.audioPlayer.addEventListener('ended', async () => {
          estadoApp.reproduciendo = false;
          notificarEstado('reproduccion_terminada', {});
        });
        
        // Evento de error
        window.audioPlayer.addEventListener('error', async (e) => {
          console.error('[AUDIO] Error en reproductor de audio:', e);
          estadoApp.ultimoError = e.message;
          notificarEstado('error', { mensaje: e.message });
        });
      }
      
      /**
       * Limpia los eventos del reproductor de audio
       */
      function limpiarEventosAudio() {
        if (!window.audioPlayer) return;
        
        window.audioPlayer.removeEventListener('play', () => {});
        window.audioPlayer.removeEventListener('pause', () => {});
        window.audioPlayer.removeEventListener('ended', () => {});
        window.audioPlayer.removeEventListener('error', () => {});
      }
      
      /**
       * Actualiza la interfaz de usuario según el estado actual
       */
      function actualizarInterfaz() {
        // Actualizar controles de reproducción
        const controles = document.getElementById('controles-reproduccion');
        if (!controles) return;
        
        // Habilitar o deshabilitar controles
        controles.querySelectorAll('button').forEach(btn => {
          btn.disabled = !estadoApp.controlesHabilitados;
        });
        
        // Actualizar estado de reproducción
        const reproduciendo = estadoApp.reproduciendo ? 'Reproduciendo' : 'Pausado';
        controles.querySelector('.estado-reproduccion').textContent = reproduciendo;
        
        // Actualizar modo
        const modoTexto = estadoApp.modo === 'aventura' ? 'Aventura' : 'Casa';
        document.getElementById('modo-actual').textContent = `Modo: ${modoTexto}`;
      }
      
      /**
       * Manejador del comando de audio
       * @param {Object} mensaje - Mensaje con el comando de audio
       * @returns {Promise<Object>} Resultado del comando
       */
      async function manejarComandoAudio(mensaje) {
        const ID_TRANSACCION = `audio-${Date.now()}`;
        const log = (nivel, msg, datos = {}) => {
          console[nivel](`[${CONFIG.IFRAME_ID}] [${ID_TRANSACCION}] ${msg}`, datos);
        };
        
        log('info', 'Manejando comando de audio', { comando: mensaje.datos });
        
        try {
          const { accion, archivo, opciones } = mensaje.datos;
          
          let resultado;
          switch (accion) {
            case 'reproducir':
              resultado = await reproducirAudio(archivo, opciones);
              break;
              
            case 'pausar':
              resultado = await pausarAudio();
              break;
              
            case 'detener':
              resultado = await detenerAudio();
              break;
              
            case 'volumen':
              resultado = await establecerVolumen(opciones.volumen);
              break;
              
            default:
              throw new Error(`Acción de audio no reconocida: ${accion}`);
          }
          
          // Notificar estado después de ejecutar el comando
          await notificarEstado('estado_audio', {
            reproduciendo: estadoApp.reproduciendo,
            volumen: estadoApp.volumen,
            modo: estadoApp.modo
          });
          
          return {
            estado: 'ok',
            mensaje: `Comando de audio "${accion}" ejecutado`,
            resultado
          };
          
        } catch (error) {
          const errorMsg = `Error al ejecutar comando de audio: ${error.message}`;
          log('error', errorMsg, { stack: error.stack });
          
          // Notificar error al padre
          await notificarError('error_comando_audio', {
            error: error.message,
            stack: error.stack,
            timestamp: new Date().toISOString()
          });
          
          throw error;
        }
      }
      
      // ================== INICIALIZACIÓN DOM ==================
      document.addEventListener('DOMContentLoaded', async () => {
        try {
          await inicializarSistemaMensajeria();
          // Aquí puedes inicializar controles adicionales o el reproductor si es necesario
        } catch (error) {
          mostrarError('Error al inicializar el reproductor: ' + error.message);
        }
      });
      
      // Array de audios correspondientes a las paradas y tramos del recorrido
      const audioFiles = [
        // Parada 0 - Inicio
            { 
                id: "audio-P-0", 
                title: "Torres de Serranos (inicio)", 
                file: "Av1_audio_esp/02 Intro ESPAÑOL 2.mp3"
            },
            
            // Tramo 1: Torres de Serranos → Plaza de la crida (Puente de Serranos)
            { 
                id: "audio-TR-1", 
                title: "Tramo 1: Torres de Serranos → Plaza de la crida", 
                file: "Av1_audio_esp/03 Av1 Pista 3 ESPAÑOL.mp3"
            },
            
            // Parada 1: Plaza de la crida (Puente de Serranos)
            { 
                id: "audio-P-1", 
                title: "Parada 1: Plaza de la crida (Puente de Serranos - Reto 3)", 
                file: "Av1_audio_esp/04 Av1 Pista 4 ESPAÑOL.mp3"
            },
            
            // Tramo 2: Plaza de la crida → Calle Muro de Santa Ana
            { 
                id: "audio-TR-2", 
                title: "Tramo 2: Plaza de la crida → Calle Muro de Santa Ana", 
                file: "Av1_audio_esp/05 Av1 Pista 5 ESPAÑOL.mp3"
            },
            
            // Parada 2: Calle Muro de Santa Ana
            { 
                id: "audio-P-2", 
                title: "Parada 2: Calle Muro de Santa Ana (Reto 4)", 
                file: "Av1_audio_esp/06 Av1 Pista 6 ESPAÑOL.mp3"
            },
            
            // Tramo 3: Calle Muro de Santa Ana → Palacio de los Borgia
            { 
                id: "audio-TR-3", 
                title: "Tramo 3: Calle Muro de Santa Ana → Palacio de los Borgia", 
                file: "Av1_audio_esp/07 Av1 Pista 7 ESPAÑOL.mp3"
            },
            
            // Parada 3: Iglesia de San Lorenzo
            { 
                id: "audio-P-3", 
                title: "Parada 3: Iglesia de San Lorenzo (Reto 5)", 
                file: "Av1_audio_esp/08 Av1 Pista 8 ESPAÑOL.mp3"
            },
            
            // Tramo 4: Iglesia de San Lorenzo → Plaza de la Virgen
            { 
                id: "audio-TR-4", 
                title: "Tramo 4: Iglesia de San Lorenzo → Plaza de la Virgen", 
                file: "Av1_audio_esp/09 Av1 Pista 9 ESPAÑOL.mp3"
            },
            
            // Parada 4: Plaza de la Virgen (Reto 6)
            { 
                id: "audio-P-4", 
                title: "Parada 4: Plaza de la Virgen (Reto 6)", 
                file: "Av1_audio_esp/10 Av1 Pista 10 ESPAÑOL.mp3"
            },
            
            // Parada 5: Plaza de la Virgen (Reto 7, 8 Puzzle plaza de la virgen)
            { 
                id: "audio-P-5", 
                title: "Parada 5: Plaza de la Virgen (Reto 7, 8 Puzzle)", 
                file: "Av1_audio_esp/11 Av1 Pista 11 ESPAÑOL.mp3"
            },
            
            // Tramo 5: Plaza de la Virgen → Plaza de la Almoína
            { 
                id: "audio-TR-5", 
                title: "Tramo 5: Plaza de la Virgen → Plaza de la Almoína", 
                file: "Av1_audio_esp/12 Av1 Pista 12 ESPAÑOL.mp3"
            },
            
            // Parada 6: Panel cerámico muro Catedral
            { 
                id: "audio-P-6", 
                title: "Parada 6: Panel cerámico muro Catedral", 
                file: "Av1_audio_esp/13 Av1 Pista 13 ESPAÑOL.mp3"
            },
            
            // Parada 7: Capilla exterior catedral Reto 10
            { 
                id: "audio-P-7", 
                title: "Parada 7: Capilla exterior catedral (Reto 10)", 
                file: "Av1_audio_esp/14 Av1 Pista 14 ESPAÑOL.mp3"
            },
            
            // Parada 8: Capilla exterior catedral Reto 11
            { 
                id: "audio-P-8", 
                title: "Parada 8: Capilla exterior catedral (Reto 11)", 
                file: "Av1_audio_esp/15 Av1 Pista 15 ESPAÑOL.mp3"
            },
            
            // Parada 9: Arco Novo Catedral y Puerta Negra Basílica
            { 
                id: "audio-P-9", 
                title: "Parada 9: Arco Novo Catedral y Puerta Negra Basílica", 
                file: "Av1_audio_esp/16 Av1 Pista 16 ESPAÑOL.mp3"
            },
            
            // Parada 10: Casa del Punt de Gantxo
            { 
                id: "audio-P-10", 
                title: "Parada 10: Casa del Punt de Gantxo", 
                file: "Av1_audio_esp/17 Av1 Pista 17 ESPAÑOL.mp3"
            },
            
            // Tramo 6: Plaza de la Almoína → Museo Arqueológico
            { 
                id: "audio-TR-6", 
                title: "Tramo 6: Plaza de la Almoína → Museo Arqueológico", 
                file: "Av1_audio_esp/18 Av1 Pista 18 ESPAÑOL.mp3"
            },
            
            // Parada 11: Museo arqueológico La Almoína
            { 
                id: "audio-P-11", 
                title: "Parada 11: Museo arqueológico La Almoína", 
                file: "Av1_audio_esp/19 Av1 Pista 19 ESPAÑOL.mp3"
            },
            
            // Parada 12: Museo arqueológico La Almoína (segunda parte)
            { 
                id: "audio-P-12", 
                title: "Parada 12: Museo arqueológico La Almoína (continuación)", 
                file: "Av1_audio_esp/20 Av1 Pista 20 ESPAÑOL.mp3"
            },
            
            // Parada 13: Vista de la Catedral, Cimborrio
            { 
                id: "audio-P-13", 
                title: "Parada 13: Vista de la Catedral, Cimborrio", 
                file: "Av1_audio_esp/21 Av1 Pista 21 ESPAÑOL.mp3"
            },
            
            // Tramo 7: Museo arqueológico La Almoína → Palacio Arzobispal
            { 
                id: "audio-TR-7", 
                title: "Tramo 7: Museo arqueológico → Palacio Arzobispal", 
                file: "Av1_audio_esp/22 Av1 Pista 22 ESPAÑOL.mp3"
            },
            
            // Parada 14: Palacio Arzobispal y Puerta Románica de la Catedral
            { 
                id: "audio-P-14", 
                title: "Parada 14: Palacio Arzobispal y Puerta Románica", 
                file: "Av1_audio_esp/23 Av1 Pista 23 ESPAÑOL.mp3"
            },
            
            // Parada 15: Puerta Románica de la Catedral
            { 
                id: "audio-P-15", 
                title: "Parada 15: Puerta Románica de la Catedral", 
                file: "Av1_audio_esp/24 Av1 Pista 24 ESPAÑOL.mp3"
            },
            
            // Tramo 8: Puerta Románica de la Catedral → Plaza del Ayuntamiento
            { 
                id: "audio-TR-8", 
                title: "Tramo 8: Puerta Románica → Plaza del Ayuntamiento", 
                file: "Av1_audio_esp/25 Av1 Pista 25 ESPAÑOL.mp3"
            },
            
            // Parada 16: Plaza del Ayuntamiento
            { 
                id: "audio-P-16", 
                title: "Parada 16: Plaza del Ayuntamiento", 
                file: "Av1_audio_esp/26 Av1 Pista 26 ESPAÑOL.mp3"
            },
            
            // Tramo 9: Plaza del Ayuntamiento → Edificio del Ayuntamiento de València
            { 
                id: "audio-TR-9", 
                title: "Tramo 9: Plaza del Ayuntamiento → Edificio del Ayuntamiento", 
                file: "Av1_audio_esp/27 Av1 Pista 27 ESPAÑOL.mp3"
            },
            
            // Parada 17: Edificio del Ayuntamiento
            { 
                id: "audio-P-17", 
                title: "Parada 17: Edificio del Ayuntamiento", 
                file: "Av1_audio_esp/28 Av1 Pista 28 ESPAÑOL.mp3"
            },
            
            // Parada 18: Edificio del Ayuntamiento (segunda parte)
            { 
                id: "audio-P-18", 
                title: "Parada 18: Edificio del Ayuntamiento (continuación)", 
                file: "Av1_audio_esp/29 Av1 Pista 29 ESPAÑOL.mp3"
            },
            
            // Tramo 10: Edificio del Ayuntamiento → Estación del Norte
            { 
                id: "audio-TR-10", 
                title: "Tramo 10: Ayuntamiento → Estación del Norte", 
                file: "Av1_audio_esp/30 Av1 Pista 30 ESPAÑOL.mp3"
            },
            
            // Parada 19: Estación del Norte
            { 
                id: "audio-P-19", 
                title: "Parada 19: Estación del Norte", 
                file: "Av1_audio_esp/31 Av1 Pista 31 ESPAÑOL.mp3"
            },
            
            // Tramo 11: Estación del Norte → Plaza de Toros de València
            { 
                id: "audio-TR-11", 
                title: "Tramo 11: Estación del Norte → Plaza de Toros", 
                file: "Av1_audio_esp/32 Av1 Pista 32 ESPAÑOL.mp3"
            },
            
            // Tramo 12: Plaza de Toros → Casa estilo Árabe
            { 
                id: "audio-TR-12", 
                title: "Tramo 12: Plaza de Toros → Casa estilo Árabe", 
                file: "Av1_audio_esp/33 Av1 Pista 33 ESPAÑOL.mp3"
            },
            
            // Parada 20: Casa estilo Árabe
            { 
                id: "audio-P-20", 
                title: "Parada 20: Casa estilo Árabe", 
                file: "Av1_audio_esp/34 Av1 Pista 34 ESPAÑOL.mp3"
            },
            
            // Parada 21: Casa estilo Árabe, mitad Aventura
            { 
                id: "audio-P-21", 
                title: "Parada 21: Casa estilo Árabe (mitad Aventura)", 
                file: "Av1_audio_esp/35 Av1 Pista 35 ESPAÑOL.mp3"
            },
            
            // Tramo 13: Casa estilo Árabe → Palacio de Comunicaciones (Correos)
            { 
                id: "audio-TR-13", 
                title: "Tramo 13: Casa estilo Árabe → Palacio de Comunicaciones", 
                file: "Av1_audio_esp/36 Av1 Pista 36 ESPAÑOL.mp3"
            },
            
            // Parada 22: Palacio de Comunicaciones: Correos
            { 
                id: "audio-P-22", 
                title: "Parada 22: Palacio de Comunicaciones (Correos)", 
                file: "Av1_audio_esp/37 Av1 Pista 37 ESPAÑOL.mp3"
            },
            
            // Parada 23: Edificio Suay
            { 
                id: "audio-P-23", 
                title: "Parada 23: Edificio Suay", 
                file: "Av1_audio_esp/38 Av1 Pista 38 ESPAÑOL.mp3"
            },
            
            // Tramo 14: Palacio de Comunicaciones → Banco de València
            { 
                id: "audio-TR-14", 
                title: "Tramo 14: Palacio de Comunicaciones → Banco de València", 
                file: "Av1_audio_esp/39 Av1 Pista 39 ESPAÑOL.mp3"
            },
            
            // Parada 24: Banco de Valencia
            { 
                id: "audio-P-24", 
                title: "Parada 24: Banco de Valencia", 
                file: "Av1_audio_esp/40 Av1 Pista 40 ESPAÑOL.mp3"
            },
            
            // Tramo 15: Banco de València → Palacio del Marqués de Dos Aguas
            { 
                id: "audio-TR-15", 
                title: "Tramo 15: Banco de València → Palacio del Marqués de Dos Aguas", 
                file: "Av1_audio_esp/41 Av1 Pista 41 ESPAÑOL.mp3"
            },
            
            // Parada 25: Palacio del Marqués de Dos Aguas (Museo Nacional de Cerámica)
            { 
                id: "audio-P-25", 
                title: "Parada 25: Palacio del Marqués de Dos Aguas (Museo de Cerámica)", 
                file: "Av1_audio_esp/42 Av1 Pista 42 ESPAÑOL.mp3"
            },
            
            // Tramo 16: Palacio del Marqués → Mercado Central
            { 
                id: "audio-TR-16", 
                title: "Tramo 16: Palacio del Marqués → Mercado Central", 
                file: "Av1_audio_esp/43 Av1 Pista 43 ESPAÑOL.mp3"
            },
            
            // Parada 26: Mercado central
            { 
                id: "audio-P-26", 
                title: "Parada 26: Mercado central", 
                file: "Av1_audio_esp/44 Av1 Pista 44 ESPAÑOL.mp3"
            },
            
            // Tramo 17: Mercado Central → Iglesia de los Santos Juanes
            { 
                id: "audio-TR-17", 
                title: "Tramo 17: Mercado Central → Iglesia de los Santos Juanes", 
                file: "Av1_audio_esp/45 Av1 Pista 45 ESPAÑOL.mp3"
            },
            
            // Parada 27: Iglesia de los Santos Juanes reto 24
            { 
                id: "audio-P-27", 
                title: "Parada 27: Iglesia de los Santos Juanes (Reto 24)", 
                file: "Av1_audio_esp/46 Av1 Pista 46 ESPAÑOL.mp3"
            },
            
            // Parada 28: Iglesia de los Santos Juanes reto 25
            { 
                id: "audio-P-28", 
                title: "Parada 28: Iglesia de los Santos Juanes (Reto 25)", 
                file: "Av1_audio_esp/47 Av1 Pista 47 ESPAÑOL.mp3"
            },
            
            // Tramo 18: Iglesia Santos Juanes → Lonja de València (Mercado de la Seda)
            { 
                id: "audio-TR-18", 
                title: "Tramo 18: Iglesia Santos Juanes → Lonja de València", 
                file: "Av1_audio_esp/48 Av1 Pista 48 ESPAÑOL.mp3"
            },
            
            // Parada 29: Lonja Puerta de Los Pecados barquero
            { 
                id: "audio-P-29", 
                title: "Parada 29: Lonja - Puerta de Los Pecados (barquero)", 
                file: "Av1_audio_esp/49 Av1 Pista 49 ESPAÑOL.mp3"
            },
            
            // Parada 30: Lonja Puerta de Los Pecados árbol muerto
            { 
                id: "audio-P-30", 
                title: "Parada 30: Lonja - Puerta de Los Pecados (árbol muerto)", 
                file: "Av1_audio_esp/50 Av1 Pista 50 ESPAÑOL.mp3"
            },
            
            // Tramo 19: Lonja Gárgolas
            { 
                id: "audio-TR-19", 
                title: "Tramo 19: Lonja - Gárgolas", 
                file: "Av1_audio_esp/51 Av1 Pista 51 ESPAÑOL.mp3"
            },
            
            // Parada 31: Lonja Gárgolas ángel vasija
            { 
                id: "audio-P-31", 
                title: "Parada 31: Lonja - Gárgola del ángel con vasija", 
                file: "Av1_audio_esp/52 Av1 Pista 52 ESPAÑOL.mp3"
            },
            
            // Parada 32: Lonja Gárgolas barbudo y león
            { 
                id: "audio-P-32", 
                title: "Parada 32: Lonja - Gárgola del barbudo con león", 
                file: "Av1_audio_esp/53 Av1 Pista 53 ESPAÑOL.mp3"
            },
            
            // Parada 33: Lonja Gárgolas fornicador ventana
            { 
                id: "audio-P-33", 
                title: "Parada 33: Lonja - Gárgola del fornicador en ventana", 
                file: "Av1_audio_esp/54 Av1 Pista 54 ESPAÑOL.mp3"
            },
            
            // Tramo 20: Lonja → Plaza del Doctor Collado
            { 
                id: "audio-TR-20", 
                title: "Tramo 20: Lonja → Plaza del Doctor Collado", 
                file: "Av1_audio_esp/55 Av1 Pista 55 ESPAÑOL.mp3"
            },
            
            // Tramo 21: Plaza del Doctor Collado → Plaza del Negrito (Fuente del Negrito)
            { 
                id: "audio-TR-21", 
                title: "Tramo 21: Plaza del Doctor Collado → Fuente del Negrito", 
                file: "Av1_audio_esp/56 Av1 Pista 56 ESPAÑOL.mp3"
            },
            
            // Parada 34: Fuente del Negrito
            { 
                id: "audio-P-34", 
                title: "Parada 34: Fuente del Negrito", 
                file: "Av1_audio_esp/57 Av1 Pista 57 ESPAÑOL.mp3"
            },
            
            // Tramo 22: Plaza del Negrito → Calle Caballeros
            { 
                id: "audio-TR-22", 
                title: "Tramo 22: Fuente del Negrito → Calle Caballeros", 
                file: "Av1_audio_esp/58 Av1 Pista 58 ESPAÑOL.mp3"
            },
            
            // Parada 35: Palau de la Generalitat
            { 
                id: "audio-P-35", 
                title: "Parada 35: Palau de la Generalitat", 
                file: "Av1_audio_esp/59 Av1 Pista 59 ESPAÑOL.mp3"
            },
            
            // Tramo 23: Palacio de la Generalitat → Calle de los Serranos (FINAL)
            { 
                id: "audio-TR-23", 
                title: "Tramo 23: Palacio de la Generalitat → Calle de los Serranos", 
                file: "Av1_audio_esp/60 Av1 Pista 60 ESPAÑOL.mp3"
            },
            
            // Parada 36 - FINAL: Torres de Serranos Final
            { 
                id: "audio-P-36", 
                title: "Parada 36: Torres de Serranos (Final del recorrido)", 
                file: "Av1_audio_esp/61 Av1 Pista 61 ESPAÑOL.mp3"
            }
      ];
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reproductor de Audio - Aventura 1 (hijo3)</title>
    <style>
      /* Estilos básicos para el reproductor */
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f9;
        margin: 0;
        padding: 0;
      }
      
      h1 {
        text-align: center;
        color: #333;
      }
      
      #reproductor {
        max-width: 600px;
        margin: 20px auto;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      
      #controles-reproduccion {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
      }
      
      button {
        padding: 10px 20px;
        font-size: 16px;
        color: #fff;
        background-color: #007bff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      
      button:hover:not(:disabled) {
        background-color: #0056b3;
      }
      
      .estado-reproduccion {
        font-weight: bold;
        font-size: 18px;
        color: #333;
      }
      
      #modo-actual {
        text-align: center;
        font-size: 16px;
        margin-top: 10px;
        color: #666;
      }
    </style>
</head>
<body>
    <div id="reproductor">
      <h1>Reproductor de Audio - Aventura 1</h1>
      
      <div id="controles-reproduccion">
        <button id="btn-reproducir">Reproducir</button>
        <button id="btn-pausar" disabled>Pausar</button>
        <button id="btn-detener" disabled>Detener</button>
        <button id="btn-volumen" disabled>Volumen</button>
      </div>
      
      <div class="estado-reproduccion">Estado: Detenido</div>
      <div id="modo-actual">Modo: Aventura</div>
    </div>
</body>
</html>
