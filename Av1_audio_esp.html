<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio esp Av1- hijo3</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --btn-size: 60px;
            --icon-size: 1.5em;
            --progress-thick: 20px;
            --trapecio-width: 290px;
            --trapecio-height: 155px;
            --trapecio-bg: white;
            --trapecio-shadow: 0 2px 12px rgba(0,0,0,0.13);
            --trapecio-radius: 15px;
            --progress-color: #0077cc;
            --progress-bg: #e0e0e0;
            --timer-font-size: 1.1em;
            --timer-color: #333;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: transparent !important;
        }

        body {
            font-family: "Book Antiqua", "Palatino Linotype", Palatino, Georgia, serif;
            margin: 0;
            padding: 0;
            background: transparent !important;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }

        .audio-player-controls {
            width: var(--trapecio-width);
            max-width: 98vw;
            min-width: 180px;
            height: var(--trapecio-height);
            background: var(--trapecio-bg);
            clip-path: polygon(8% 0%, 92% 0%, 100% 100%, 0% 100%);
            border-radius: var(--trapecio-radius);
            box-shadow: var(--trapecio-shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            gap: 0.1em;
            z-index: 1200;
            padding: 5px 8px 5px 8px;
            box-sizing: border-box;
            border: none;
            margin: 5px 0;
        }

        .player-buttons-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 2px;
        }

        #playPauseBtn {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            padding: 0;
        }

        #playPauseBtn .icon-play {
            color: white;
            font-weight: bold;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        #playPauseBtn:active:not(:disabled) { 
            transform: scale(0.95); 
        }

        #playPauseBtn.active {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            border: none;
        }

        #playPauseBtn:disabled { 
            background: linear-gradient(135deg, #dc3545, #c82333);
            opacity: 0.6;
            cursor: not-allowed; 
            border: none;
        }

        #retosBtn {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            padding: 0;
        }

        #retosBtn .icon-puzzle {
            color: white;
            font-weight: bold;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        #retosBtn:disabled { 
            background: linear-gradient(135deg, #999, #666);
            cursor: not-allowed; 
            opacity: 0.6;
        }

        #retosBtn:active:not(:disabled) { 
            transform: scale(0.95); 
        }

        .progress-row {
            display: flex;
            align-items: center;
            width: 90%;
            margin: 0 0 5px 0;
            padding: 0;
            justify-content: center;
        }

        .progress-container {
            flex: 1;
            width: 100%;
            height: var(--progress-thick);
            background-color: #f0f0f0;
            border-radius: calc(var(--progress-thick) / 2);
            cursor: pointer;
            position: relative;
            margin: 0;
            min-width: 0;
            overflow: visible;
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        #progressBar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #28a745, #1e7e34);
            border-radius: calc(var(--progress-thick) / 2);
            transition: width 0.1s linear;
            position: relative;
        }

        #progressBar::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff;
            border: 3px solid white;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
            display: block;
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        #playPauseBtn:disabled ~ .progress-row #progressBar::after {
            opacity: 0;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            width: 90%;
            font-size: var(--timer-font-size);
            color: var(--timer-color);
            margin-top: 2px;
            font-weight: 500;
        }

        .time-display span {
            font-variant-numeric: tabular-nums;
        }

        /* Estilos para el modo casa (ocultar controles) */
        body.modo-casa .audio-player-controls {
            display: none;
        }

        /* Estilos para el modo aventura (mostrar controles) */
        body.modo-aventura .audio-player-controls {
            display: flex;
        }
    </style>
</head>
<body class="modo-aventura">
    <script type="module">
import { logger, configurarUtils, crearObjetoError } from './js/utils.js';
configurarUtils({ iframeId: 'audioPlayerIframe', debug: true });

// Array de audios correspondientes a las paradas y tramos del recorrido
// Usando P- para paradas y TR- para tramos, coincidiendo con los IDs del hijo 2
const audioFiles = [
    { id: "audio_P-0", title: "Torres de Serranos (inicio)", file: "Av1_audio_esp/02 Intro ESPAÑOL 2.mp3" },
    // Tramo 1: Torres de Serranos → Plaza de la crida (Puente de Serranos)
    { 
        id: "audio_TR-1", 
        title: "Tramo 1: Torres de Serranos → Plaza de la crida", 
        file: "Av1_audio_esp/03 Av1 Pista 3 ESPAÑOL.mp3"
    },
    // Parada 1: Plaza de la crida (Puente de Serranos)
    { 
        id: "audio_P-1", 
        title: "Parada 1: Plaza de la crida (Puente de Serranos - Reto 3)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Parada 2 - Torres de Serranos
    { 
        id: "audio_P-2", 
        title: "Parada 2: Torres de Serranos", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Tramo 3: Torres de Serranos → Mercado Central
    { 
        id: "audio_TR-3", 
        title: "Tramo 3: Torres de Serranos → Mercado Central", 
        file: "Av1_audio_esp/04 Av1 Pista 4 ESPAÑOL.mp3"
    },
    // Parada 3: Mercado Central
    { 
        id: "audio_P-3", 
        title: "Parada 3: Mercado Central", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Tramo 4: Mercado Central → Plaza de la Virgen
    { 
        id: "audio_TR-4", 
        title: "Tramo 4: Mercado Central → Plaza de la Virgen", 
        file: "Av1_audio_esp/05 Av1 Pista 5 ESPAÑOL.mp3"
    },
    // Parada 4: Plaza de la Virgen
    { 
        id: "audio_P-4", 
        title: "Parada 4: Plaza de la Virgen", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Tramo 5: Plaza de la Virgen → Torres de Serranos
    { 
        id: "audio_TR-5", 
        title: "Tramo 5: Plaza de la Virgen → Torres de Serranos", 
        file: "Av1_audio_esp/06 Av1 Pista 6 ESPAÑOL.mp3"
    },
    // Parada 5 - FINAL: Torres de Serranos
    { 
        id: "audio_P-5", 
        title: "Parada 5: Torres de Serranos (Final del recorrido)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Parada 6 - Torres de Serranos (Inicio Alternativo)
    { 
        id: "audio_P-6", 
        title: "Parada 6: Torres de Serranos (Inicio Alternativo)", 
        file: "Av1_audio_esp/02 Intro ESPAÑOL 2.mp3"
    },
    // Tramo 7: Torres de Serranos → Plaza de la Virgen (Alternativo)
    { 
        id: "audio_TR-7", 
        title: "Tramo 7: Torres de Serranos → Plaza de la Virgen (Alternativo)", 
        file: "Av1_audio_esp/07 Av1 Pista 7 ESPAÑOL.mp3"
    },
    // Parada 7: Plaza de la Virgen (Alternativo)
    { 
        id: "audio_P-7", 
        title: "Parada 7: Plaza de la Virgen (Alternativo)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Tramo 8: Plaza de la Virgen → Torres de Serranos (Alternativo)
    { 
        id: "audio_TR-8", 
        title: "Tramo 8: Plaza de la Virgen → Torres de Serranos (Alternativo)", 
        file: "Av1_audio_esp/08 Av1 Pista 8 ESPAÑOL.mp3"
    },
    // Parada 8 - FINAL: Torres de Serranos (Alternativo)
    { 
        id: "audio_P-8", 
        title: "Parada 8: Torres de Serranos (Final del recorrido Alternativo)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Parada 9 - Torres de Serranos (Inicio Especial)
    { 
        id: "audio_P-9", 
        title: "Parada 9: Torres de Serranos (Inicio Especial)", 
        file: "Av1_audio_esp/02 Intro ESPAÑOL 2.mp3"
    },
    // Tramo 10: Torres de Serranos → Plaza de la Virgen (Especial)
    { 
        id: "audio_TR-10", 
        title: "Tramo 10: Torres de Serranos → Plaza de la Virgen (Especial)", 
        file: "Av1_audio_esp/09 Av1 Pista 9 ESPAÑOL.mp3"
    },
    // Parada 10: Plaza de la Virgen (Especial)
    { 
        id: "audio_P-10", 
        title: "Parada 10: Plaza de la Virgen (Especial)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Tramo 11: Plaza de la Virgen → Torres de Serranos (Especial)
    { 
        id: "audio_TR-11", 
        title: "Tramo 11: Plaza de la Virgen → Torres de Serranos (Especial)", 
        file: "Av1_audio_esp/10 Av1 Pista 10 ESPAÑOL.mp3"
    },
    // Parada 11 - FINAL: Torres de Serranos (Especial)
    { 
        id: "audio_P-11", 
        title: "Parada 11: Torres de Serranos (Final del recorrido Especial)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Parada 12 - Torres de Serranos (Inicio Adicional)
    { 
        id: "audio_P-12", 
        title: "Parada 12: Torres de Serranos (Inicio Adicional)", 
        file: "Av1_audio_esp/02 Intro ESPAÑOL 2.mp3"
    },
    // Tramo 13: Torres de Serranos → Plaza de la Virgen (Adicional)
    { 
        id: "audio_TR-13", 
        title: "Tramo 13: Torres de Serranos → Plaza de la Virgen (Adicional)", 
        file: "Av1_audio_esp/11 Av1 Pista 11 ESPAÑOL.mp3"
    },
    // Parada 13: Plaza de la Virgen (Adicional)
    { 
        id: "audio_P-13", 
        title: "Parada 13: Plaza de la Virgen (Adicional)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Tramo 14: Plaza de la Virgen → Torres de Serranos (Adicional)
    { 
        id: "audio_TR-14", 
        title: "Tramo 14: Plaza de la Virgen → Torres de Serranos (Adicional)", 
        file: "Av1_audio_esp/12 Av1 Pista 12 ESPAÑOL.mp3"
    },
    // Parada 14 - FINAL: Torres de Serranos (Adicional)
    { 
        id: "audio_P-14", 
        title: "Parada 14: Torres de Serranos (Final del recorrido Adicional)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Parada 15 - Torres de Serranos (Inicio Extra)
    { 
        id: "audio_P-15", 
        title: "Parada 15: Torres de Serranos (Inicio Extra)", 
        file: "Av1_audio_esp/02 Intro ESPAÑOL 2.mp3"
    },
    // Tramo 16: Torres de Serranos → Plaza de la Virgen (Extra)
    { 
        id: "audio_TR-16", 
        title: "Tramo 16: Torres de Serranos → Plaza de la Virgen (Extra)", 
        file: "Av1_audio_esp/13 Av1 Pista 13 ESPAÑOL.mp3"
    },
    // Parada 16: Plaza de la Virgen (Extra)
    { 
        id: "audio_P-16", 
        title: "Parada 16: Plaza de la Virgen (Extra)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Tramo 17: Plaza de la Virgen → Torres de Serranos (Extra)
    { 
        id: "audio_TR-17", 
        title: "Tramo 17: Plaza de la Virgen → Torres de Serranos (Extra)", 
        file: "Av1_audio_esp/14 Av1 Pista 14 ESPAÑOL.mp3"
    },
    // Parada 17 - FINAL: Torres de Serranos (Extra)
    { 
        id: "audio_P-17", 
        title: "Parada 17: Torres de Serranos (Final del recorrido Extra)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Parada 18 - Torres de Serranos (Inicio Complementario)
    { 
        id: "audio_P-18", 
        title: "Parada 18: Torres de Serranos (Inicio Complementario)", 
        file: "Av1_audio_esp/02 Intro ESPAÑOL 2.mp3"
    },
    // Tramo 19: Torres de Serranos → Plaza de la Virgen (Complementario)
    { 
        id: "audio_TR-19", 
        title: "Tramo 19: Torres de Serranos → Plaza de la Virgen (Complementario)", 
        file: "Av1_audio_esp/15 Av1 Pista 15 ESPAÑOL.mp3"
    },
    // Parada 19: Plaza de la Virgen (Complementario)
    { 
        id: "audio_P-19", 
        title: "Parada 19: Plaza de la Virgen (Complementario)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Tramo 20: Plaza de la Virgen → Torres de Serranos (Complementario)
    { 
        id: "audio_TR-20", 
        title: "Tramo 20: Plaza de la Virgen → Torres de Serranos (Complementario)", 
        file: "Av1_audio_esp/16 Av1 Pista 16 ESPAÑOL.mp3"
    },
    // Parada 20 - FINAL: Torres de Serranos (Complementario)
    { 
        id: "audio_P-20", 
        title: "Parada 20: Torres de Serranos (Final del recorrido Complementario)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Parada 21 - Torres de Serranos (Inicio Alternativo 2)
    { 
        id: "audio_P-21", 
        title: "Parada 21: Torres de Serranos (Inicio Alternativo 2)", 
        file: "Av1_audio_esp/02 Intro ESPAÑOL 2.mp3"
    },
    // Tramo 22: Torres de Serranos → Plaza de la Virgen (Alternativo 2)
    { 
        id: "audio_TR-22", 
        title: "Tramo 22: Torres de Serranos → Plaza de la Virgen (Alternativo 2)", 
        file: "Av1_audio_esp/17 Av1 Pista 17 ESPAÑOL.mp3"
    },
    // Parada 22: Plaza de la Virgen (Alternativo 2)
    { 
        id: "audio_P-22", 
        title: "Parada 22: Plaza de la Virgen (Alternativo 2)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Tramo 23: Plaza de la Virgen → Torres de Serranos (Alternativo 2)
    { 
        id: "audio_TR-23", 
        title: "Tramo 23: Plaza de la Virgen → Torres de Serranos (Alternativo 2)", 
        file: "Av1_audio_esp/18 Av1 Pista 18 ESPAÑOL.mp3"
    },
    // Parada 23 - FINAL: Torres de Serranos (Alternativo 2)
    { 
        id: "audio_P-23", 
        title: "Parada 23: Torres de Serranos (Final del recorrido Alternativo 2)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Parada 24 - Torres de Serranos (Inicio Extra 2)
    { 
        id: "audio_P-24", 
        title: "Parada 24: Torres de Serranos (Inicio Extra 2)", 
        file: "Av1_audio_esp/02 Intro ESPAÑOL 2.mp3"
    },
    // Tramo 25: Torres de Serranos → Plaza de la Virgen (Extra 2)
    { 
        id: "audio_TR-25", 
        title: "Tramo 25: Torres de Serranos → Plaza de la Virgen (Extra 2)", 
        file: "Av1_audio_esp/19 Av1 Pista 19 ESPAÑOL.mp3"
    },
    // Parada 25: Plaza de la Virgen (Extra 2)
    { 
        id: "audio_P-25", 
        title: "Parada 25: Plaza de la Virgen (Extra 2)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Tramo 26: Plaza de la Virgen → Torres de Serranos (Extra 2)
    { 
        id: "audio_TR-26", 
        title: "Tramo 26: Plaza de la Virgen → Torres de Serranos (Extra 2)", 
        file: "Av1_audio_esp/20 Av1 Pista 20 ESPAÑOL.mp3"
    },
    // Parada 26 - FINAL: Torres de Serranos (Extra 2)
    { 
        id: "audio_P-26", 
        title: "Parada 26: Torres de Serranos (Final del recorrido Extra 2)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Parada 27 - Torres de Serranos (Inicio Complementario 2)
    { 
        id: "audio_P-27", 
        title: "Parada 27: Torres de Serranos (Inicio Complementario 2)", 
        file: "Av1_audio_esp/02 Intro ESPAÑOL 2.mp3"
    },
    // Tramo 28: Torres de Serranos → Plaza de la Virgen (Complementario 2)
    { 
        id: "audio_TR-28", 
        title: "Tramo 28: Torres de Serranos → Plaza de la Virgen (Complementario 2)", 
        file: "Av1_audio_esp/21 Av1 Pista 21 ESPAÑOL.mp3"
    },
    // Parada 28: Plaza de la Virgen (Complementario 2)
    { 
        id: "audio_P-28", 
        title: "Parada 28: Plaza de la Virgen (Complementario 2)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Tramo 29: Plaza de la Virgen → Torres de Serranos (Complementario 2)
    { 
        id: "audio_TR-29", 
        title: "Tramo 29: Plaza de la Virgen → Torres de Serranos (Complementario 2)", 
        file: "Av1_audio_esp/22 Av1 Pista 22 ESPAÑOL.mp3"
    },
    // Parada 29 - FINAL: Torres de Serranos (Complementario 2)
    { 
        id: "audio_P-29", 
        title: "Parada 29: Torres de Serranos (Final del recorrido Complementario 2)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Parada 30 - Torres de Serranos (Inicio Final)
    { 
        id: "audio_P-30", 
        title: "Parada 30: Torres de Serranos (Inicio Final)", 
        file: "Av1_audio_esp/02 Intro ESPAÑOL 2.mp3"
    },
    // Tramo 31: Torres de Serranos → Plaza de la Virgen (Final)
    { 
        id: "audio_TR-31", 
        title: "Tramo 31: Torres de Serranos → Plaza de la Virgen (Final)", 
        file: "Av1_audio_esp/23 Av1 Pista 23 ESPAÑOL.mp3"
    },
    // Parada 31: Plaza de la Virgen (Final)
    { 
        id: "audio_P-31", 
        title: "Parada 31: Plaza de la Virgen (Final)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Tramo 32: Plaza de la Virgen → Torres de Serranos (Final)
    { 
        id: "audio_TR-32", 
        title: "Tramo 32: Plaza de la Virgen → Torres de Serranos (Final)", 
        file: "Av1_audio_esp/24 Av1 Pista 24 ESPAÑOL.mp3"
    },
    // Parada 32 - FINAL: Torres de Serranos (Final)
    { 
        id: "audio_P-32", 
        title: "Parada 32: Torres de Serranos (Final del recorrido)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Parada 33 - Torres de Serranos (Inicio Despedida)
    { 
        id: "audio_P-33", 
        title: "Parada 33: Torres de Serranos (Inicio Despedida)", 
        file: "Av1_audio_esp/02 Intro ESPAÑOL 2.mp3"
    },
    // Tramo 34: Torres de Serranos → Plaza de la Virgen (Despedida)
    { 
        id: "audio_TR-34", 
        title: "Tramo 34: Torres de Serranos → Plaza de la Virgen (Despedida)", 
        file: "Av1_audio_esp/25 Av1 Pista 25 ESPAÑOL.mp3"
    },
    // Parada 34: Plaza de la Virgen (Despedida)
    { 
        id: "audio_P-34", 
        title: "Parada 34: Plaza de la Virgen (Despedida)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Tramo 35: Plaza de la Virgen → Torres de Serranos (Despedida)
    { 
        id: "audio_TR-35", 
        title: "Tramo 35: Plaza de la Virgen → Torres de Serranos (Despedida)", 
        file: "Av1_audio_esp/26 Av1 Pista 26 ESPAÑOL.mp3"
    },
    // Parada 35 - FINAL: Torres de Serranos (Despedida)
    { 
        id: "audio_P-35", 
        title: "Parada 35: Torres de Serranos (Final del recorrido Despedida)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    },
    // Parada 36 - FINAL: Torres de Serranos Final
    { 
        id: "audio_P-36", 
        title: "Parada 36: Torres de Serranos (Final del recorrido)", 
        file: "Av1_audio_esp/12 Av1 Pista 8 ESPAÑOL montada.mp3"
    }
];

    </script>
    <div class="audio-player-controls">
        <div class="player-buttons-row">
            <button id="playPauseBtn" aria-label="Reproducir/Pausar">
                <i class="fas fa-play icon-play"></i>
            </button>
            <button id="retosBtn" aria-label="Retos">
                <i class="fas fa-puzzle-piece icon-puzzle"></i>
            </button>
        </div>
        <div class="progress-row">
            <div class="progress-container" id="progressContainer">
                <div id="progressBar"></div>
            </div>
        </div>
        <div class="time-display">
            <span id="currentTime">00:00</span>
            <span id="duration">00:00</span>
        </div>
    </div>

    <audio id="audioPlayer" preload="metadata">
        Tu navegador no soporta el elemento de audio.
    </audio>

    <script type="module">
        // Importar utilidades primero
        import { 
            logger, 
            configurarUtils, 
            crearObjetoError 
        } from './js/utils.js';
        
        // Configurar el logger inmediatamente
        configurarUtils({ iframeId: 'audioPlayerIframe', debug: true, logLevel: 0 });
        
        // Importar funciones de mensajería
        import { 
            inicializarMensajeria as _inicializarMensajeria,
            registrarControlador as _registrarControlador,
            enviarMensaje as _enviarMensaje
        } from './js/mensajeria.js';
        import { TIPOS_MENSAJE } from './js/constants.js';
        
        // Hacer las funciones disponibles globalmente
        window.inicializarMensajeria = _inicializarMensajeria;
        window.registrarControlador = _registrarControlador;
        window.enviarMensaje = _enviarMensaje;
        window.TIPOS_MENSAJE = TIPOS_MENSAJE;
        
        // Función segura para enviar mensajes
        async function enviarMensajeSeguro(destino, tipo, datos = {}) {
            if (typeof _enviarMensaje === 'function') {
                return await _enviarMensaje(destino, tipo, datos);
            }
            logger.warn('enviarMensaje no está disponible');
            return Promise.reject(new Error('enviarMensaje no disponible'));
        }
        
        // Constantes y variables globales
        let audioPlayer;
        let playPauseBtn;
        let retosBtn;
        let progressBar;
        let progressContainer;
        let elementoActual = null; // Almacena el elemento actual (parada o tramo)
        let estadoApp = {
            modo: 'aventura',
            reproduccionAutomatica: true,
            ultimoEstado: 'detenido', // 'reproduciendo', 'pausado', 'detenido', 'error'
            volumen: 1.0,
            tiempoInicio: null,
            tiempoFin: null,
            mensajesPendientes: []
        };
        let currentTimeElement;
        let durationElement;
        let isPlaying = false;
        let controlsDisabled = false;
        let ultimaActualizacion = 0;
        const IFRAME_ID = 'hijo3'; // Must match the iframe ID in padre.html
        const TIEMPO_ENTRE_ACTUALIZACIONES = 1000; // 1 segundo
        const MAX_REINTENTOS = 3;
        
        // Configuración estándar
        const CONFIG = {
            IFRAME_ID: IFRAME_ID,
            DEBUG: true,
            LOG_LEVEL: 1, // 0: debug, 1: info, 2: warn, 3: error, 4: none
            REINTENTOS: {
                MAXIMOS: 3,
                TIEMPO_ESPERA: 1000,
                FACTOR: 2
            }
        };

        // Función para actualizar el elemento actual with manejo de confirmaciones
        async function actualizarElementoActual(id, mensajeOrigen = null) {
            try {
                if (id) {
                    // Buscar en el array de audios
                    const elemento = audioFiles.find(item => item.id === id);
                    if (elemento) {
                        // Confirmar recepción del mensaje
                        if (mensajeOrigen) {
                            await enviarConfirmacion(mensajeOrigen, { estado: 'procesando' });
                        }
                        
                        elementoActual = elemento;
                        
                        // Actualizar el reproductor con el audio correspondiente
                        if (elemento.file) {
                            audioPlayer.src = elemento.file;
                            // Si hay un audio, cargarlo y actualizar la interfaz
                            audioPlayer.load();
                            
                            // Configurar manejadores de eventos una sola vez
                            if (!audioPlayer._handlersConfigured) {
                                audioPlayer.oncanplay = handleCanPlay;
                                audioPlayer.onplay = handlePlay;
                                audioPlayer.onpause = handlePause;
                                audioPlayer.onended = handleEnded;
                                audioPlayer.onerror = handleError;
                                audioPlayer.ontimeupdate = handleTimeUpdate;
                                audioPlayer._handlersConfigured = true;
                            }
                            
                            // Notificar al padre que el audio está listo
                            await notificarEstado('audio_listo', { 
                                id,
                                duracion: audioPlayer.duration || 0,
                                titulo: elemento.title || ''
                            });
                            
                            // Confirmar finalización exitosa
                            if (mensajeOrigen) {
                                await enviarConfirmacion(mensajeOrigen, { 
                                    estado: 'completado',
                                    id,
                                    timestamp: new Date().toISOString()
                                });
                            }
                        }
                    } else {
                        const error = new Error(`Elemento no encontrado: ${id}`);
                        logger.warn(`[${IFRAME_ID}]`, error.message);
                        throw error;
                    }
                } else {
                    // Si no hay ID, limpiar el reproductor
                    elementoActual = null;
                    if (audioPlayer) {
                        audioPlayer.pause();
                        audioPlayer.src = '';
                    }
                    
                    // Notificar estado actualizado
                    await notificarEstado('audio_detenido', { motivo: 'sin_elemento' });
                    
                    // Confirmar si fue por mensaje
                    if (mensajeOrigen) {
                        await enviarConfirmacion(mensajeOrigen, { 
                            estado: 'completado',
                            accion: 'limpiar',
                            timestamp: new Date().toISOString()
                        });
                    }
                }
            } catch (error) {
                logger.error(`[${IFRAME_ID}] Error en actualizarElementoActual:`, error);
                
                // Notificar error al padre
                await notificarError('actualizar_elemento', error);
                
                // Enviar confirmación de error si hay mensaje de origen
                if (mensajeOrigen) {
                    await enviarError(mensajeOrigen, {
                        codigo: 'ERROR_ACTUALIZAR_ELEMENTO',
                        mensaje: error.message,
                        detalle: error.stack
                    });
                }
                
                throw error; // Relanzar para manejo superior
            }
        }
        
        // Función para configurar manejadores de mensajes
        function configurarManejadoresMensajes() {
            // Verificar que el controlador esté disponible
            if (typeof registrarControlador !== 'function') {
                if (window.logger) {
                    logger.error('registrarControlador no está disponible');
                } else {
                    console.error('registrarControlador no está disponible');
                }
                return;
            }
            // Manejador para cambio de elemento con confirmación
            registrarControlador('NAVEGACION.CAMBIO_ELEMENTO', async (mensaje) => {
                try {
                    const { id } = mensaje.datos || {};
                    if (id) {
                        await actualizarElementoActual(id, mensaje);
                    }
                } catch (error) {
                    logger.error(`[${IFRAME_ID}] Error en manejador de cambio de elemento:`, error);
                    await enviarError(mensaje, {
                        codigo: 'ERROR_CAMBIO_ELEMENTO',
                        mensaje: error.message,
                        detalle: error.stack
                    });
                }
            });
            
            // Manejador para controles de audio
            registrarControlador('AUDIO.REPRODUCIR', async (mensaje) => {
                try {
                    const resultado = await reproducirAudio(mensaje.datos || {});
                    await enviarConfirmacion(mensaje, resultado);
                } catch (error) {
                    logger.error(`[${IFRAME_ID}] Error al reproducir audio:`, error);
                    await enviarError(mensaje, {
                        codigo: 'ERROR_REPRODUCIR_AUDIO',
                        mensaje: error.message,
                        detalle: error.stack
                    });
                }
            });
            
            registrarControlador('AUDIO.PAUSAR', async (mensaje) => {
                try {
                    const resultado = await pausarAudio();
                    await enviarConfirmacion(mensaje, resultado);
                } catch (error) {
                    logger.error(`[${IFRAME_ID}] Error al pausar audio:`, error);
                    await enviarError(mensaje, {
                        codigo: 'ERROR_PAUSAR_AUDIO',
                        mensaje: error.message,
                        detalle: error.stack
                    });
                }
            });
            
            registrarControlador('AUDIO.DETENER', async (mensaje) => {
                try {
                    const resultado = await detenerAudio();
                    await enviarConfirmacion(mensaje, resultado);
                } catch (error) {
                    logger.error(`[${IFRAME_ID}] Error al detener audio:`, error);
                    await enviarError(mensaje, {
                        codigo: 'ERROR_DETENER_AUDIO',
                        mensaje: error.message,
                        detalle: error.stack
                    });
                }
            });
            
            registrarControlador('AUDIO.ESTABLECER_VOLUMEN', async (mensaje) => {
                try {
                    const { volumen } = mensaje.datos || {};
                    const resultado = await establecerVolumen(volumen);
                    await enviarConfirmacion(mensaje, resultado);
                } catch (error) {
                    logger.error(`[${IFRAME_ID}] Error al establecer volumen:`, error);
                    await enviarError(mensaje, {
                        codigo: 'ERROR_ESTABLECER_VOLUMEN',
                        mensaje: error.message,
                        detalle: error.stack
                    });
                }
            });
            
            registrarControlador('AUDIO.ESTABLECER_TIEMPO', async (mensaje) => {
                try {
                    const { tiempo } = mensaje.datos || {};
                    const resultado = await establecerTiempo(tiempo);
                    await enviarConfirmacion(mensaje, resultado);
                } catch (error) {
                    logger.error(`[${IFRAME_ID}] Error al establecer tiempo:`, error);
                    await enviarError(mensaje, {
                        codigo: 'ERROR_ESTABLECER_TIEMPO',
                        mensaje: error.message,
                        detalle: error.stack
                    });
                }
            });
            
            registrarControlador('AUDIO.OBTENER_ESTADO', async (mensaje) => {
                try {
                    const estado = await obtenerEstadoActual();
                    await enviarConfirmacion(mensaje, estado);
                } catch (error) {
                    logger.error(`[${IFRAME_ID}] Error al obtener estado:`, error);
                    await enviarError(mensaje, {
                        codigo: 'ERROR_OBTENER_ESTADO',
                        mensaje: error.message,
                        detalle: error.stack
                    });
                }
            });
        }

        // Add missing event handlers
        function handleEnded() {
            handleAudioEnded();
        }

        function handleError() {
            handleAudioError();
        }

        function handleTimeUpdate() {
            updateProgress();
        }

        // Inicialización cuando el DOM esté listo
        async function inicializarAplicacion() {
            try {
                // Inicializar la mensajería
                await inicializarMensajeria({
                    iframeId: IFRAME_ID,
                    debug: CONFIG.DEBUG,
                    logLevel: CONFIG.LOG_LEVEL
                });
                
                // Configurar manejadores de mensajes
                configurarManejadoresMensajes();
                
                // Configurar elementos de la interfaz
                configurarElementosUI();
                
                // Configurar eventos
                setupEventListeners();
                
                logger.info('Aplicación de audio inicializada correctamente');
            } catch (error) {
                logger.error('Error al inicializar la aplicación de audio:', error);
                notificarError('inicializacion', error);
            }
        }
        
        // Inicialización cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', async () => {
            logger.info(`[${IFRAME_ID}] DOM cargado, inicializando...`);
            
            try {
                // Inicializar elementos del DOM
                audioPlayer = document.getElementById('audioPlayer');
                playPauseBtn = document.getElementById('playPauseBtn');
                retosBtn = document.getElementById('retosBtn');
                progressBar = document.getElementById('progressBar');
                progressContainer = document.getElementById('progressContainer');
                currentTimeElement = document.getElementById('currentTime');
                durationElement = document.getElementById('duration');

                // Configurar manejadores de eventos
                setupEventListeners();
                
                // Inicializar mensajería
                try {
                    await inicializarMensajeria({
                        iframeId: IFRAME_ID,
                        debug: CONFIG.DEBUG,
                        logLevel: CONFIG.LOG_LEVEL || 1, // Default to INFO level if not set
                        reintentos: CONFIG.REINTENTOS || { MAXIMOS: 3, TIEMPO_ESPERA: 1000, FACTOR: 2 }
                    });
                    logger.info('Mensajería inicializada correctamente');
                } catch (error) {
                    logger.error('Error al inicializar la mensajería:', error);
                    throw error; // Re-lanzar para manejarlo en el bloque catch exterior
                }
                
                // Configurar manejadores de mensajes
                configurarManejadoresMensajes();
                
                // Registrar controladores de mensajes estandarizados
                registrarControlador(TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, manejarCambioModo);
                registrarControlador(TIPOS_MENSAJE.SISTEMA.PING, manejarPing);
                
                // Sincronizar estado al inicio
                registrarControlador(TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO_ESTADO, (mensaje) => {
                    if (mensaje.origen !== CONFIG.IFRAME_ID && mensaje.datos.modo !== estadoApp.modo) {
                        manejarCambioModo(mensaje);
                    }
                });
                
                // Notificar que el reproductor está listo
                await notificarEstado('inicializado', { 
                    version: '1.0.0',
                    capacidades: ['reproducir', 'pausar', 'detener', 'ajustar_volumen', 'establecer_tiempo']
                });
                
                logger.info(`[${IFRAME_ID}] Reproductor de audio inicializado correctamente`);
            } catch (error) {
                const errorObj = crearObjetoError('inicializacion', error);
                logger.error(`[${IFRAME_ID}] Error crítico al inicializar el reproductor:`, errorObj);
                
                // Notificar al padre del error de inicialización
                try {
                    await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.ERROR, {
                        tipo: 'error_inicializacion',
                        mensaje: 'Error al inicializar el reproductor de audio',
                        detalle: errorObj,
                        timestamp: new Date().toISOString()
                    });
                } catch (envioError) {
                    logger.error(`[${IFRAME_ID}] No se pudo notificar el error:`, envioError);
                }
                
                throw error;
            }
        });

        // Función para notificar el estado del reproductor
        async function notificarEstado(accion, datos = {}) {
            try {
                const estado = {
                    accion,
                    ...datos,
                    timestamp: new Date().toISOString(),
                    origen: 'audioPlayerIframe',
                    elementoActual: null,
                    estadoReproductor: {
                        estado: estadoApp.ultimoEstado || 'detenido',
                        volumen: audioPlayer ? audioPlayer.volume : 1,
                        muteado: audioPlayer ? audioPlayer.muted : false
                    }
                };

                if (elementoActual) {
                    estado.elementoActual = {
                        id: elementoActual.id,
                        tipo: elementoActual.tipo || 'audio',
                        titulo: elementoActual.title || '',
                        duracion: audioPlayer ? audioPlayer.duration : 0,
                        tiempoActual: audioPlayer ? audioPlayer.currentTime : 0
                    };
                }

                return await enviarMensajeSeguro('padre', TIPOS_MENSAJE.AUDIO.ESTADO, estado);
            } catch (error) {
                const errorObj = crearObjetoError('notificar_estado', error);
                logger.error('Error al notificar estado:', errorObj);
                return Promise.reject(errorObj);
            }
        }

        // Función para notificar errores de manera consistente
        function notificarError(tipo, error) {
            const errorObj = error instanceof Error ? error : new Error(String(error));
            logger.error(`[audioPlayerIframe] Error (${tipo}):`, errorObj);
            
            const errorInfo = {
                tipo,
                mensaje: errorObj.message,
                stack: errorObj.stack,
                timestamp: new Date().toISOString(),
                origen: IFRAME_ID
            };
            
            // Notificar al padre
            enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.ERROR, errorInfo).catch(
                e => logger.error(`[${IFRAME_ID}] Error notificando error:`, e)
            );
            
            return errorInfo;
        }

        // Fix the manejador de cambio de modo with proper CONFIG reference
        async function manejarCambioModo(mensaje) {
            try {
                const { modo, gpsActivo, timestamp, motivo } = mensaje.datos || {};
                
                // Confirmar recepción
                await enviarConfirmacion(mensaje, { estado: 'procesando' });
                
                // Validar modo
                if (modo !== 'casa' && modo !== 'aventura') {
                    throw new Error(`Modo no válido: ${modo}`);
                }

                logger.info(`[${IFRAME_ID}] Cambiando a modo: ${modo}`, motivo ? `(Motivo: ${motivo})` : '');
                
                // Actualizar UI
                if (modo === 'casa') {
                    document.body.classList.remove('modo-aventura');
                    document.body.classList.add('modo-casa');
                    if (audioPlayer && !audioPlayer.paused) {
                        audioPlayer.pause();
                    }
                } else {
                    document.body.classList.remove('modo-casa');
                    document.body.classList.add('modo-aventura');
                }
                
                // Actualizar estado
                estadoApp.modo = modo;
                
                // Acciones específicas según el modo
                if (modo === 'casa' || gpsActivo === false) {
                    // Apagar GPS y pausar audio si está reproduciendo
                    if (audioPlayer && !audioPlayer.paused) {
                        audioPlayer.pause();
                    }
                    logger.info('GPS desactivado en modo casa, audio pausado');
                } else if (modo === 'aventura' || gpsActivo === true) {
                    // GPS activo, controles habilitados
                    logger.info('GPS activado en modo aventura');
                }
                
                // Enviar confirmación
                if (enviarMensaje) {
                    await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.CAMBIO_MODO, {
                        modo,
                        timestamp,
                        origen: IFRAME_ID,
                        exito: true
                    });
                    
                    // Broadcast del nuevo estado
                    await enviarMensaje('todos', TIPOS_MENSAJE.SISTEMA.ESTADO, {
                        modo,
                        timestamp: Date.now(),
                        origen: IFRAME_ID
                    });
                }
                
                return true;
            } catch (error) {
                logger.error(`[${IFRAME_ID}] Error al cambiar modo:`, error);
                
                // Notificar error
                if (enviarMensaje) {
                    await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.ERROR, {
                        tipo: 'cambio_modo',
                        mensaje: error.message,
                        stack: error.stack,
                        origen: IFRAME_ID
                    });
                }
                
                return false;
            }
        }

        // Función para habilitar o deshabilitar los controles
        function setControlsEnabled(enabled) {
            controlsDisabled = !enabled;
            playPauseBtn.disabled = !enabled;
            retosBtn.disabled = !enabled;
        }

        // Notificar que el componente está listo
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar la aplicación
            inicializarAplicacion().catch(error => {
                if (window.logger) {
                    logger.error('Error en la inicialización de la aplicación:', error);
                } else {
                    console.error('Error en la inicialización de la aplicación:', error);
                }
            });
            setTimeout(() => {
                notificarEstado('componente_listo', {
                    id: IFRAME_ID,
                    tipo: 'audio',
                    capacidades: ['reproducir', 'pausar', 'saltar', 'volumen']
                }).catch(console.error);
            }, 500);
        });

        function setupEventListeners() {
            // Ejemplo de configuración de eventos para los controles de audio
            if (playPauseBtn && audioPlayer) {
                playPauseBtn.addEventListener('click', () => {
                    if (audioPlayer.paused) {
                        audioPlayer.play();
                    } else {
                        audioPlayer.pause();
                    }
                });
            }
            if (retosBtn) {
                retosBtn.addEventListener('click', () => {
                    // Acción para el botón de retos
                    alert('Retos no implementados aún.');
                });
            }
            if (progressContainer && audioPlayer) {
                progressContainer.addEventListener('click', (e) => {
                    const rect = progressContainer.getBoundingClientRect();
                    const percent = (e.clientX - rect.left) / rect.width;
                    audioPlayer.currentTime = percent * audioPlayer.duration;
                });
            }
        }

        function manejarPing(mensaje) {
            // Responde al ping con una confirmación simple
            return { exito: true, timestamp: new Date().toISOString(), origen: 'audioPlayerIframe' };
        }
    </script>
</body>
</html>
