<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio esp Av1- hijo3</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --btn-size: 60px;
            --icon-size: 1.5em;
            --progress-thick: 20px;
            --trapecio-width: 290px;
            --trapecio-height: 135px; /* Reducido de 140px a 135px */
            --trapecio-bg: white;
            --trapecio-shadow: 0 2px 12px rgba(0,0,0,0.13);
            --trapecio-radius: 15px;
            --progress-color: #0077cc;
            --progress-bg: #e0e0e0;
            --timer-font-size: 1.1em;
            --timer-color: #333;
        }

        /* Encapsular estilos */
        .hijo3-container body, .hijo3-container html {
            height: 100%;
            margin: 0;
            padding: 0;
            background: transparent !important;
        }

        body {
            font-family: "Book Antiqua", "Palatino Linotype", Palatino, Georgia, serif;
            margin: 0;
            padding: 0;
            background: transparent !important;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }

        .audio-player-controls {
            width: var(--trapecio-width);
            max-width: 98vw;
            min-width: 180px;
            height: var(--trapecio-height);
            background: var(--trapecio-bg);
            clip-path: polygon(8% 0%, 92% 0%, 100% 100%, 0% 100%);
            border-radius: var(--trapecio-radius);
            box-shadow: var(--trapecio-shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            gap: 0.05em;
            z-index: 9999; /* Aseguramos que est√© por encima de otros elementos */
            padding: 5px 8px 5px 8px;
            box-sizing: border-box;
            border: 0px solid #0077cc; /* Borde para mejor visibilidad */
            margin: 5px 0;
            position: fixed; /* Fijo en la pantalla */
            bottom: 10px; /* Posicionado en la parte inferior */
            left: 50%; /* Centrado horizontalmente */
            transform: translateX(-50%); /* Centrado exacto */
            opacity: 1 !important; /* Forzar visibilidad */
            visibility: visible !important; /* Forzar visibilidad */
            background-color: white !important; /* Fondo blanco para mejor contraste */
        }

        .player-buttons-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 1px; /* MODIFICADO: Reducido de 2px a 1px (mitad) */
        }

        #playPauseBtn {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            padding: 0;
        }

        #playPauseBtn .icon-play {
            color: white;
            font-weight: bold;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        #playPauseBtn:active:not(:disabled) { 
            transform: scale(0.95); 
        }

        #playPauseBtn.active {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            border: none;
        }

        #playPauseBtn:disabled { 
            background: linear-gradient(135deg, #dc3545, #c82333);
            opacity: 0.6;
            cursor: not-allowed; 
            border: none;
        }

        #retosBtn {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            padding: 0;
        }

        #retosBtn .icon-puzzle {
            color: white;
            font-weight: bold;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        #retosBtn:disabled { 
            background: linear-gradient(135deg, #999, #666);
            cursor: not-allowed; 
            opacity: 0.6;
        }

        #retosBtn:active:not(:disabled) { 
            transform: scale(0.95); 
        }

        .progress-row {
            display: flex;
            align-items: center;
            width: 90%;
            margin: 0 0 1px 0; /* Ajustado a 1px para espaciado total de 1px */
            padding: 0;
            justify-content: center;
        }

        .progress-container {
            flex: 1;
            width: 100%;
            height: var(--progress-thick);
            background-color: #f0f0f0;
            border-radius: calc(var(--progress-thick) / 2);
            cursor: pointer;
            position: relative;
            margin: 0;
            min-width: 0;
            overflow: visible;
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        #progressBar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #28a745, #1e7e34);
            border-radius: calc(var(--progress-thick) / 2);
            transition: width 0.1s linear;
            position: relative;
        }

        #progressBar::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff;
            border: 3px solid white;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
            display: block;
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        #playPauseBtn:disabled ~ .progress-row #progressBar::after {
            opacity: 0;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            width: 90%;
            font-size: var(--timer-font-size);
            color: var(--timer-color);
            margin-top: 0; /* Eliminado para tener un espaciado total de 1px */
            font-weight: 500;
        }

        .time-display span {
            font-variant-numeric: tabular-nums;
        }

        /* Estilos para el modo casa (ocultar controles) */
        body.modo-casa .audio-player-controls {
            display: none;
        }

        /* Estilos para el modo aventura (mostrar controles) */
        body.modo-aventura .audio-player-controls {
            display: flex;
        }
    </style>
</head>
<body class="modo-aventura hijo3-container">
    <script type="module">
       // Array de audios correspondientes a las paradas y tramos del recorrido
        // Usando P- para paradas y TR- para tramos, coincidiendo con los IDs del hijo 2
        const audioFiles = [
            // Parada 0 - Inicio
            { 
                id: "audio-P-0", 
                title: "Torres de Serranos (inicio)", 
                file: "Av1_audio_esp/02 Intro ESPA√ëOL 2.mp3"
            },
            
            // Tramo 1: Torres de Serranos ‚Üí Plaza de la crida (Puente de Serranos)
            { 
                id: "audio-TR-1", 
                title: "Tramo 1: Torres de Serranos ‚Üí Plaza de la crida", 
                file: "Av1_audio_esp/03 Av1 Pista 3 ESPA√ëOL.mp3"
            },
            
            // Parada 1: Plaza de la crida (Puente de Serranos)
            { 
                id: "audio-P-1", 
                title: "Parada 1: Plaza de la crida (Puente de Serranos - Reto 3)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 2: Plaza de la crida ‚Üí Calle Muro de Santa Ana
            { 
                id: "audio-TR-2", 
                title: "Tramo 2: Plaza de la crida ‚Üí Calle Muro de Santa Ana", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 2: Calle Muro de Santa Ana
            { 
                id: "audio-P-2", 
                title: "Parada 2: Calle Muro de Santa Ana (Reto 4)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 3: Calle Muro de Santa Ana ‚Üí Palacio de los Borgia
            { 
                id: "audio-TR-3", 
                title: "Tramo 3: Calle Muro de Santa Ana ‚Üí Palacio de los Borgia", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 3: Iglesia de San Lorenzo
            { 
                id: "audio-P-3", 
                title: "Parada 3: Iglesia de San Lorenzo (Reto 5)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 4: Iglesia de San Lorenzo ‚Üí Plaza de la Virgen
            { 
                id: "audio-TR-4", 
                title: "Tramo 4: Iglesia de San Lorenzo ‚Üí Plaza de la Virgen", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 4: Plaza de la Virgen (Reto 6)
            { 
                id: "audio-P-4", 
                title: "Parada 4: Plaza de la Virgen (Reto 6)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 5: Plaza de la Virgen (Reto 7, 8 Puzzle plaza de la virgen)
            { 
                id: "audio-P-5", 
                title: "Parada 5: Plaza de la Virgen (Reto 7, 8 Puzzle)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 5: Plaza de la Virgen ‚Üí Plaza de la Almo√≠na
            { 
                id: "audio-TR-5", 
                title: "Tramo 5: Plaza de la Virgen ‚Üí Plaza de la Almo√≠na", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 6: Panel cer√°mico muro Catedral
            { 
                id: "audio-P-6", 
                title: "Parada 6: Panel cer√°mico muro Catedral", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 7: Capilla exterior catedral Reto 10
            { 
                id: "audio-P-7", 
                title: "Parada 7: Capilla exterior catedral (Reto 10)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 8: Capilla exterior catedral Reto 11
            { 
                id: "audio-P-8", 
                title: "Parada 8: Capilla exterior catedral (Reto 11)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 9: Arco Novo Catedral y Puerta Negra Bas√≠lica
            { 
                id: "audio-P-9", 
                title: "Parada 9: Arco Novo Catedral y Puerta Negra Bas√≠lica", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 10: Casa del Punt de Gantxo
            { 
                id: "audio-P-10", 
                title: "Parada 10: Casa del Punt de Gantxo", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 6: Plaza de la Almo√≠na ‚Üí Museo Arqueol√≥gico
            { 
                id: "audio-TR-6", 
                title: "Tramo 6: Plaza de la Almo√≠na ‚Üí Museo Arqueol√≥gico", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 11: Museo arqueol√≥gico La Almo√≠na
            { 
                id: "audio-P-11", 
                title: "Parada 11: Museo arqueol√≥gico La Almo√≠na", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 12: Museo arqueol√≥gico La Almo√≠na (segunda parte)
            { 
                id: "audio-P-12", 
                title: "Parada 12: Museo arqueol√≥gico La Almo√≠na (continuaci√≥n)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 13: Vista de la Catedral, Cimborrio
            { 
                id: "audio-P-13", 
                title: "Parada 13: Vista de la Catedral, Cimborrio", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 7: Museo arqueol√≥gico La Almo√≠na ‚Üí Palacio Arzobispal
            { 
                id: "audio-TR-7", 
                title: "Tramo 7: Museo arqueol√≥gico ‚Üí Palacio Arzobispal", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 14: Palacio Arzobispal y Puerta Rom√°nica de la Catedral
            { 
                id: "audio-P-14", 
                title: "Parada 14: Palacio Arzobispal y Puerta Rom√°nica", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 15: Puerta Rom√°nica de la Catedral
            { 
                id: "audio-P-15", 
                title: "Parada 15: Puerta Rom√°nica de la Catedral", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 8: Puerta Rom√°nica de la Catedral ‚Üí Plaza del Ayuntamiento
            { 
                id: "audio-TR-8", 
                title: "Tramo 8: Puerta Rom√°nica ‚Üí Plaza del Ayuntamiento", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 16: Plaza del Ayuntamiento
            { 
                id: "audio-P-16", 
                title: "Parada 16: Plaza del Ayuntamiento", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 9: Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento de Val√®ncia
            { 
                id: "audio-TR-9", 
                title: "Tramo 9: Plaza del Ayuntamiento ‚Üí Edificio del Ayuntamiento", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 17: Edificio del Ayuntamiento
            { 
                id: "audio-P-17", 
                title: "Parada 17: Edificio del Ayuntamiento", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 18: Edificio del Ayuntamiento (segunda parte)
            { 
                id: "audio-P-18", 
                title: "Parada 18: Edificio del Ayuntamiento (continuaci√≥n)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 10: Edificio del Ayuntamiento ‚Üí Estaci√≥n del Norte
            { 
                id: "audio-TR-10", 
                title: "Tramo 10: Ayuntamiento ‚Üí Estaci√≥n del Norte", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 19: Estaci√≥n del Norte
            { 
                id: "audio-P-19", 
                title: "Parada 19: Estaci√≥n del Norte", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 11: Estaci√≥n del Norte ‚Üí Plaza de Toros de Val√®ncia
            { 
                id: "audio-TR-11", 
                title: "Tramo 11: Estaci√≥n del Norte ‚Üí Plaza de Toros", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 12: Plaza de Toros ‚Üí Casa estilo √Årabe
            { 
                id: "audio-TR-12", 
                title: "Tramo 12: Plaza de Toros ‚Üí Casa estilo √Årabe", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 20: Casa estilo √Årabe
            { 
                id: "audio-P-20", 
                title: "Parada 20: Casa estilo √Årabe", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 21: Casa estilo √Årabe, mitad Aventura
            { 
                id: "audio-P-21", 
                title: "Parada 21: Casa estilo √Årabe (mitad Aventura)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 13: Casa estilo √Årabe ‚Üí Palacio de Comunicaciones (Correos)
            { 
                id: "audio-TR-13", 
                title: "Tramo 13: Casa estilo √Årabe ‚Üí Palacio de Comunicaciones", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 22: Palacio de Comunicaciones: Correos
            { 
                id: "audio-P-22", 
                title: "Parada 22: Palacio de Comunicaciones (Correos)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 23: Edificio Suay
            { 
                id: "audio-P-23", 
                title: "Parada 23: Edificio Suay", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 14: Palacio de Comunicaciones ‚Üí Banco de Val√®ncia
            { 
                id: "audio-TR-14", 
                title: "Tramo 14: Palacio de Comunicaciones ‚Üí Banco de Val√®ncia", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 24: Banco de Valencia
            { 
                id: "audio-P-24", 
                title: "Parada 24: Banco de Valencia", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 15: Banco de Val√®ncia ‚Üí Palacio del Marqu√©s de Dos Aguas
            { 
                id: "audio-TR-15", 
                title: "Tramo 15: Banco de Val√®ncia ‚Üí Palacio del Marqu√©s de Dos Aguas", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 25: Palacio del Marqu√©s de Dos Aguas (Museo Nacional de Cer√°mica)
            { 
                id: "audio-P-25", 
                title: "Parada 25: Palacio del Marqu√©s de Dos Aguas (Museo de Cer√°mica)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 16: Palacio del Marqu√©s ‚Üí Mercado Central
            { 
                id: "audio-TR-16", 
                title: "Tramo 16: Palacio del Marqu√©s ‚Üí Mercado Central", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 26: Mercado central
            { 
                id: "audio-P-26", 
                title: "Parada 26: Mercado central", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 17: Mercado Central ‚Üí Iglesia de los Santos Juanes
            { 
                id: "audio-TR-17", 
                title: "Tramo 17: Mercado Central ‚Üí Iglesia de los Santos Juanes", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 27: Iglesia de los Santos Juanes reto 24
            { 
                id: "audio-P-27", 
                title: "Parada 27: Iglesia de los Santos Juanes (Reto 24)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 28: Iglesia de los Santos Juanes reto 25
            { 
                id: "audio-P-28", 
                title: "Parada 28: Iglesia de los Santos Juanes (Reto 25)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 18: Iglesia Santos Juanes ‚Üí Lonja de Val√®ncia (Mercado de la Seda)
            { 
                id: "audio-TR-18", 
                title: "Tramo 18: Iglesia Santos Juanes ‚Üí Lonja de Val√®ncia", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 29: Lonja Puerta de Los Pecados barquero
            { 
                id: "audio-P-29", 
                title: "Parada 29: Lonja - Puerta de Los Pecados (barquero)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 30: Lonja Puerta de Los Pecados √°rbol muerto
            { 
                id: "audio-P-30", 
                title: "Parada 30: Lonja - Puerta de Los Pecados (√°rbol muerto)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 19: Lonja G√°rgolas
            { 
                id: "audio-TR-19", 
                title: "Tramo 19: Lonja - G√°rgolas", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 31: Lonja G√°rgolas √°ngel vasija
            { 
                id: "audio-P-31", 
                title: "Parada 31: Lonja - G√°rgola del √°ngel con vasija", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 32: Lonja G√°rgolas barbudo y le√≥n
            { 
                id: "audio-P-32", 
                title: "Parada 32: Lonja - G√°rgola del barbudo con le√≥n", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 33: Lonja G√°rgolas fornicador ventana
            { 
                id: "audio-P-33", 
                title: "Parada 33: Lonja - G√°rgola del fornicador en ventana", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 20: Lonja ‚Üí Plaza del Doctor Collado
            { 
                id: "audio-TR-20", 
                title: "Tramo 20: Lonja ‚Üí Plaza del Doctor Collado", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 21: Plaza del Doctor Collado ‚Üí Plaza del Negrito (Fuente del Negrito)
            { 
                id: "audio-TR-21", 
                title: "Tramo 21: Plaza del Doctor Collado ‚Üí Fuente del Negrito", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 34: Fuente del Negrito
            { 
                id: "audio-P-34", 
                title: "Parada 34: Fuente del Negrito", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 22: Plaza del Negrito ‚Üí Calle Caballeros
            { 
                id: "audio-TR-22", 
                title: "Tramo 22: Fuente del Negrito ‚Üí Calle Caballeros", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 35: Palau de la Generalitat
            { 
                id: "audio-P-35", 
                title: "Parada 35: Palau de la Generalitat", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Tramo 23: Palacio de la Generalitat ‚Üí Calle de los Serranos (FINAL)
            { 
                id: "audio-TR-23", 
                title: "Tramo 23: Palacio de la Generalitat ‚Üí Calle de los Serranos", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            },
            
            // Parada 36 - FINAL: Torres de Serranos Final
            { 
                id: "audio-P-36", 
                title: "Parada 36: Torres de Serranos (Final del recorrido)", 
                file: "Av1_audio_esp/12 Av1 Pista 8 ESPA√ëOL montada.mp3"
            }
        ];

    </script>
    <div class="audio-player-controls">
        <div class="player-buttons-row">
            <button id="playPauseBtn" aria-label="Reproducir/Pausar">
                <i class="fas fa-play icon-play"></i>
            </button>
            <button id="retosBtn" aria-label="Retos">
                <i class="fas fa-puzzle-piece icon-puzzle"></i>
            </button>
        </div>
        <div class="progress-row">
            <div class="progress-container" id="progressContainer">
                <div id="progressBar"></div>
            </div>
        </div>
        <div class="time-display">
            <span id="currentTime">00:00</span>
            <span id="duration">00:00</span>
        </div>
    </div>

    <audio id="audioPlayer" preload="metadata">
        Tu navegador no soporta el elemento de audio.
    </audio>

    <script type="module">
        // Importar utilidades y mensajer√≠a
        import logger from './js/logger.js';
        import { inicializarMensajeria, registrarControlador, enviarMensaje } from './js/mensajeria.js';
        import { TIPOS_MENSAJE } from './js/constants.js';
        import { modoHandler } from './js/modo-handler.js';
        
        const IFRAME_ID = 'hijo3';

        // Elementos del DOM
        const audioPlayer = document.getElementById('audioPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const retosBtn = document.getElementById('retosBtn');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const currentTimeElement = document.getElementById('currentTime');
        const durationElement = document.getElementById('duration');

        let currentAudioId = null;

        // --- L√ìGICA DEL REPRODUCTOR ---
        
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function updateUI() {
            if (audioPlayer.paused) {
                playPauseBtn.innerHTML = '<i class="fas fa-play icon-play"></i>';
            } else {
                playPauseBtn.innerHTML = '<i class="fas fa-pause icon-play"></i>';
            }
        }

        audioPlayer.addEventListener('timeupdate', () => {
            const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressBar.style.width = `${percent}%`;
            currentTimeElement.textContent = formatTime(audioPlayer.currentTime);
        });

        audioPlayer.addEventListener('loadedmetadata', () => {
            durationElement.textContent = formatTime(audioPlayer.duration);
        });

        // Modificar manejo de reproducci√≥n de audio para notificar al padre
        audioPlayer.addEventListener('play', async () => {
            updateUI();
            
            // Notificar al padre que se inici√≥ la reproducci√≥n
            await enviarMensaje('padre', TIPOS_MENSAJE.AUDIO.REPRODUCIR, { 
                audioId: currentAudioId,
                timestamp: Date.now()
            });
        });

        audioPlayer.addEventListener('pause', updateUI);

        audioPlayer.addEventListener('ended', async () => {
            // Notificar al padre que termin√≥ el audio
            await enviarMensaje('padre', TIPOS_MENSAJE.AUDIO.FIN_REPRODUCCION, { 
                audioId: currentAudioId,
                timestamp: Date.now()
            });
            updateUI();
        });

        playPauseBtn.addEventListener('click', () => {
            if (audioPlayer.src) {
                audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause();
            }
        });

        progressContainer.addEventListener('click', (e) => {
            if (!audioPlayer.src || !audioPlayer.duration) return;
            const rect = progressContainer.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = percent * audioPlayer.duration;
        });

        // --- MANEJADORES DE MENSAJES ---

        // Manejadores para mensajes
        async function manejarPing(mensaje) {
            console.log('üîî [AUDIO] Recibido PING, enviando PONG');
            return { 
                timestamp: new Date().toISOString(),
                origen: IFRAME_ID
            };
        }

        async function manejarPong(mensaje) {
            console.log('üèì [AUDIO] Recibido PONG:', mensaje);
            return { 
                timestamp: new Date().toISOString(),
                origen: IFRAME_ID
            };
        }

        async function manejarConfirmacion(mensaje) {
            console.log('‚úÖ [AUDIO] Recibida confirmaci√≥n:', mensaje);
            return { 
                estado: 'ok',
                timestamp: new Date().toISOString(),
                origen: IFRAME_ID
            };
        }

        // Manejadores para mensajes
        async function manejarReproducirAudio(mensaje) {
            console.log('üéµ [AUDIO] manejarReproducirAudio INVOCADO con:', mensaje);
            console.log('üìã [AUDIO] Datos del mensaje:', mensaje.datos);

            const { audioId, src } = mensaje.datos;
            console.log('üéµ [AUDIO] Recibido para reproducir:', audioId, 'con src:', src);

            try {
                if (src) {
                    currentAudioId = audioId;
                    console.log('üéµ [AUDIO] Configurando src del audio:', src);
                    audioPlayer.src = src;
                    console.log('üéµ [AUDIO] Iniciando reproducci√≥n...');
                    
                    // Intento de reproducci√≥n que puede fallar si el usuario no ha interactuado
                    try {
                        await audioPlayer.play();
                        console.log('‚úÖ [AUDIO] Reproducci√≥n iniciada correctamente');
                        
                        // Devolver confirmaci√≥n exitosa
                        return {
                            exito: true,
                            mensaje: `Reproducci√≥n de ${audioId} iniciada`,
                            timestamp: Date.now()
                        };
                    } catch (playError) {
                        console.error('‚ùå [AUDIO] Error al reproducir:', playError);
                        
                        // Devolver error espec√≠fico
                        return {
                            exito: false,
                            error: `Error al reproducir: ${playError.message}`,
                            codigo: 'ERROR_REPRODUCCION',
                            timestamp: Date.now()
                        };
                    }
                } else {
                    // Buscar el archivo en nuestro array local
                    const matchingAudio = audioFiles.find(audio => audio.id === audioId);
                    
                    if (matchingAudio) {
                        // Si encontramos el audio, configuramos el src y reproducimos
                        currentAudioId = matchingAudio.id;
                        audioPlayer.src = matchingAudio.file;
                        audioPlayer.play();
                        
                        console.log('üéµ [AUDIO] Audio encontrado localmente y reproducci√≥n iniciada:', matchingAudio);
                        
                        // Devolver resultado exitoso
                        return {
                            exito: true,
                            mensaje: `Reproducci√≥n de ${audioId} iniciada desde fuente local`,
                            timestamp: Date.now()
                        };
                    } else {
                        console.warn('‚ö†Ô∏è [AUDIO] Audio no encontrado en la fuente proporcionada ni en la lista local:', audioId);
                        
                        // Devolver error de audio no encontrado
                        return {
                            exito: false,
                            error: 'Audio no encontrado',
                            codigo: 'AUDIO_NO_ENCONTRADO',
                            timestamp: Date.now()
                        };
                    }
                }
            } catch (error) {
                console.error('‚ùå [AUDIO] Error general al manejar audio:', error);
                
                // Devolver error general
                return {
                    exito: false,
                    error: `Error al manejar audio: ${error.message}`,
                    timestamp: Date.now()
                };
            }
        }

        // Manejador para mensajes de PING (diagn√≥stico)
        // Manejado por la funci√≥n manejarPing declarada anteriormente

        // Manejadores para mensajes de control
        function manejarHabilitarControles(mensaje) {
            console.log('[AUDIO] Recibido CONTROL.HABILITAR:', mensaje.datos);
            // Habilitar botones del reproductor de audio
            playPauseBtn.disabled = false;
            retosBtn.disabled = false;
            logger.info('Controles de audio habilitados por el padre');
        }

        function manejarDeshabilitarControles(mensaje) {
            console.log('[AUDIO] Recibido CONTROL.DESHABILITAR:', mensaje.datos);
            // Deshabilitar botones del reproductor de audio
            playPauseBtn.disabled = true;
            retosBtn.disabled = true;
            logger.info('Controles de audio deshabilitados por el padre');
        }

        // Funci√≥n para actualizar la interfaz seg√∫n el modo
        function actualizarInterfazModo(modo) {
            console.log(`[AUDIO] Actualizando interfaz para modo: ${modo}`);
            const body = document.body;
            
            // Actualizar clases CSS
            body.classList.remove('modo-casa', 'modo-aventura');
            body.classList.add(`modo-${modo}`);
            
            // Ajustes espec√≠ficos seg√∫n el modo
            const audioControls = document.querySelector('.audio-player-controls');
            if (audioControls) {
                audioControls.dataset.modo = modo;
            }
            
            // Pausar la reproducci√≥n al cambiar de modo
            if (audioPlayer && !audioPlayer.paused) {
                audioPlayer.pause();
                playPauseBtn.innerHTML = '<i class="fas fa-play icon-play"></i>';
            }
        }

        // --- INICIALIZACI√ìN ---
        async function inicializar() {
            console.log('üöÄ [AUDIO] Iniciando inicializaci√≥n del reproductor de audio...');
            
            try {
                // Configurar logger
                console.log('üìù [AUDIO] Configurando logger...');
                logger.configure({ iframeId: IFRAME_ID, debug: true });
                
                // Inicializar mensajer√≠a
                console.log('üì© [AUDIO] Inicializando mensajer√≠a...');
                await inicializarMensajeria({ iframeId: IFRAME_ID });
                console.log('‚úÖ [AUDIO] Mensajer√≠a inicializada correctamente');

                registrarControlador(TIPOS_MENSAJE.AUDIO.REPRODUCIR, manejarReproducirAudio);
                registrarControlador(TIPOS_MENSAJE.CONTROL.HABILITAR, manejarHabilitarControles);
                registrarControlador(TIPOS_MENSAJE.CONTROL.DESHABILITAR, manejarDeshabilitarControles);
                // Registrar manejadores de sistema
                registrarControlador(TIPOS_MENSAJE.SISTEMA.PING, manejarPing);
                registrarControlador(TIPOS_MENSAJE.SISTEMA.PONG, manejarPong);
                registrarControlador(TIPOS_MENSAJE.SISTEMA.CONFIRMACION, manejarConfirmacion);
                
                // Suscribirse a cambios de modo
                console.log('üîÑ [AUDIO] Suscribi√©ndose a cambios de modo...');
                modoHandler.suscribir('audio-player', (nuevoModo) => {
                    console.log(`üîÑ [AUDIO] Cambio de modo detectado: ${nuevoModo}`);
                    actualizarInterfazModo(nuevoModo);
                });
                
                // Aplicar el modo actual
                const modoActual = modoHandler.obtenerModoActual();
                console.log(`üé® [AUDIO] Aplicando modo actual: ${modoActual}`);
                actualizarInterfazModo(modoActual);
                
                // Notificar al padre que el componente est√° listo
                console.log('üì§ [AUDIO] Notificando al padre que el componente est√° listo...');
                await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.COMPONENTE_LISTO, { 
                    componente: IFRAME_ID,
                    modo: modoActual,
                    timestamp: new Date().toISOString(),
                    version: '1.0.0',
                    features: ['audio', 'controles', 'cambio_modo']
                });
                
                console.log(`‚úÖ [AUDIO] ${IFRAME_ID} inicializado correctamente en modo ${modoActual}`);
                
                // Notificar inicializaci√≥n completada
                await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.INICIALIZACION_FINALIZADA, {
                    componente: IFRAME_ID,
                    timestamp: new Date().toISOString(),
                    estado: 'listo',
                    modo: modoActual
                });
                
                // Notificar que el componente est√° inicializado
                await enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.COMPONENTE_INICIALIZADO, {
                    componente: IFRAME_ID,
                    timestamp: new Date().toISOString(),
                    estado: 'activo',
                    modo: modoActual
                });
                
                // Forzar visibilidad despu√©s de la inicializaci√≥n
                const container = document.querySelector('.audio-player-controls');
                if (container) {
                    container.style.display = 'flex';
                    container.style.visibility = 'visible';
                    container.style.opacity = '1';
                    console.log('üëÅÔ∏è [AUDIO] Visibilidad forzada despu√©s de la inicializaci√≥n');
                }
            } catch (error) {
                console.error('Error al inicializar el reproductor de audio:', error);
                logger.error('Error al inicializar el reproductor de audio:', error);
            }
        }

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîÑ [AUDIO] DOM cargado, iniciando inicializaci√≥n...');
            
            // Forzar visibilidad del contenedor principal
            const container = document.querySelector('.audio-player-controls');
            if (container) {
                container.style.display = 'flex';
                container.style.visibility = 'visible';
                container.style.opacity = '1';
                console.log('üëÅÔ∏è [AUDIO] Contenedor de controles de audio forzado a visible');
            } else {
                console.error('‚ùå [AUDIO] No se encontr√≥ el contenedor de controles de audio');
            }
            
            // Inicializar el componente
            inicializar().catch(error => {
                console.error('‚ùå [AUDIO] Error durante la inicializaci√≥n:', error);
                // Intentar notificar al padre del error
                try {
                    enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.ERROR, {
                        componente: IFRAME_ID,
                        error: `Error de inicializaci√≥n: ${error.message}`,
                        stack: error.stack,
                        timestamp: new Date().toISOString()
                    });
                } catch (e) {
                    console.error('‚ùå [AUDIO] No se pudo notificar el error al padre:', e);
                }
            });
        });

        // Registrar controlador para solicitud de audio
        registrarControlador(TIPOS_MENSAJE.DATOS.SOLICITAR_PARADA, (mensaje) => {
            const { audio_id } = mensaje.datos || {};
            const audio = audioFiles.find(a => a.id === audio_id);
            if (audio) {
                enviarMensaje(mensaje.origen, TIPOS_MENSAJE.DATOS.RESPUESTA_PARADA, { audio });
            } else {
                enviarMensaje(mensaje.origen, TIPOS_MENSAJE.DATOS.RESPUESTA_PARADA, { error: 'No encontrado', audio_id });
            }
        });

        // Centralizar manejo de errores
        window.addEventListener('error', (event) => {
            enviarMensaje('padre', TIPOS_MENSAJE.SISTEMA.ERROR, {
                mensaje: event.message,
                archivo: event.filename,
                linea: event.lineno,
                columna: event.colno,
                origen: 'hijo3'
            });
        });
    </script>
</body>
</html>
