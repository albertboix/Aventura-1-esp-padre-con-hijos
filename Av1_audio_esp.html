<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor de Audio/Video (Hijo 3)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            /* Variables de diseño para botones y barra de progreso (AHORA COINCIDEN CON HIJO 2) */
            --btn-size: 80px; /* Tamaño grande */
            --icon-size: 2.7em; /* Tamaño grande */
            --progress-thick: 25px; /* Grosor de la barra de progreso */
            --timer-font-size: 1.3em; /* Tamaño de fuente del temporizador */
            --player-border-radius: 18px; /* Bordes redondeados */
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: transparent !important; /* Fondo del iframe transparente */
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end; /* Alinea los elementos abajo del contenedor */
            overflow: hidden; /* Evita scroll dentro del iframe */
            background: transparent !important; /* Asegura que el body también sea transparente */
        }

        /* Contenedor principal con la forma trapezoidal invertida (corta arriba, larga abajo) */
        .player-container {
            width: 100%; /* Ocupa el ancho completo del iframe */
            height: 100%; /* Ocupa el alto completo del iframe */
            background: white; /* Fondo del trapecio blanco */
            border-radius: var(--player-border-radius);
            box-shadow: 0 2px 12px rgba(0,0,0,0.13);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around; /* Distribuye espacio entre elementos */
            padding: 5px 10px;
            box-sizing: border-box;

            /* === CLAVE PARA LA FORMA TRAPEZOIDAL INVERTIDA (corta arriba, larga abajo) === */
            clip-path: polygon(8% 0%, 92% 0%, 100% 100%, 0% 100%);
        }

        .controls {
            display: flex;
            gap: 15px; /* Espacio entre botones */
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 5px; /* Pequeño margen inferior */
        }

        .control-button {
            width: var(--btn-size);
            height: var(--btn-size);
            border-radius: 50%;
            border: none;
            background: linear-gradient(90deg, #0077cc 0%, #00aaff 100%);
            color: white;
            font-size: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
            flex-shrink: 0;
        }

        .control-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .control-button:active:not(:disabled) {
            transform: scale(0.95);
        }

        /* Barra de Progreso */
        .progress-container {
            width: 90%;
            height: var(--progress-thick);
            background-color: #e0e0e0; /* Gris */
            border-radius: calc(var(--progress-thick) / 2);
            overflow: hidden;
            margin-top: 5px; /* Pequeño margen superior */
            position: relative;
            cursor: pointer; /* Indicar que es interactiva */
        }

        .progress-bar {
            height: 100%;
            width: 0%; /* Se actualizará con JS */
            background: linear-gradient(90deg, #007bff, #00c6ff); /* Degradado azul */
            border-radius: calc(var(--progress-thick) / 2);
            transition: none; /* Eliminar transición para permitir arrastre suave */
        }

        .time-display {
            width: 90%;
            display: flex;
            justify-content: space-between;
            color: #333;
            font-size: var(--timer-font-size);
            margin-top: 5px;
            margin-bottom: 5px;
        }

        /* Media queries para pantallas pequeñas (mantiene la coherencia con Hijo 2) */
        @media (max-width: 500px) {
            :root {
                --btn-size: 48px; /* Tamaño pequeño */
                --icon-size: 1.5em; /* Tamaño pequeño */
            }
            .time-display {
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="player-container">
        <div class="controls">
            <button id="prevBtn" class="control-button" title="Anterior">
                <i class="fas fa-backward"></i>
            </button>
            <button id="playPauseBtn" class="control-button" title="Reproducir/Pausar">
                <i class="fas fa-play"></i>
            </button>
            <button id="nextBtn" class="control-button" title="Siguiente">
                <i class="fas fa-forward"></i>
            </button>
            <button id="stopBtn" class="control-button" title="Detener">
                <i class="fas fa-stop"></i>
            </button>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="time-display">
            <span id="currentTime">00:00</span>
            <span id="duration">00:00</span>
        </div>
    </div>

    <script>
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const stopBtn = document.getElementById('stopBtn');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer'); // Nuevo
        const currentTimeSpan = document.getElementById('currentTime');
        const durationSpan = document.getElementById('duration');

        let isPlaying = false;
        let currentMediaIndex = 0;
        let mediaDuration = 0; // Simulación de duración
        let mediaCurrentTime = 0; // Simulación de tiempo actual
        let progressInterval;
        let isDraggingProgress = false; // Estado para el arrastre

        // Simulación de una lista de medios
        const mediaList = [
            { id: 0, title: "Audio 1", duration: 180 }, // 3 minutos
            { id: 1, title: "Audio 2", duration: 240 }, // 4 minutos
            { id: 2, title: "Audio 3", duration: 120 }  // 2 minutos
        ];

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function updateProgressBar() {
            if (mediaDuration > 0) {
                const progress = (mediaCurrentTime / mediaDuration) * 100;
                progressBar.style.width = `${progress}%`;
                currentTimeSpan.textContent = formatTime(mediaCurrentTime);
            }
        }

        function startProgressSimulation() {
            clearInterval(progressInterval);
            progressInterval = setInterval(() => {
                if (!isDraggingProgress && mediaCurrentTime < mediaDuration) { // Solo avanza si no se está arrastrando
                    mediaCurrentTime++;
                    updateProgressBar();
                } else if (mediaCurrentTime >= mediaDuration) {
                    clearInterval(progressInterval);
                    isPlaying = false;
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                    // Opcional: avanzar al siguiente medio automáticamente
                    // playNext();
                }
            }, 1000); // Actualiza cada segundo
        }

        function loadMedia(index) {
            if (index >= 0 && index < mediaList.length) {
                currentMediaIndex = index;
                mediaDuration = mediaList[currentMediaIndex].duration;
                mediaCurrentTime = 0;
                durationSpan.textContent = formatTime(mediaDuration);
                updateProgressBar();
                console.log(`Cargado: ${mediaList[currentMediaIndex].title}`);
                // Notificar al padre sobre el cambio de medio
                window.parent.postMessage({ type: 'media-cargado', index: currentMediaIndex, title: mediaList[currentMediaIndex].title }, '*');
            } else {
                console.log("No hay más medios.");
                stopMedia(); // Detener si no hay siguiente
            }
        }

        function playMedia() {
            isPlaying = true;
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            startProgressSimulation();
            window.parent.postMessage({ type: 'media-reproducido', index: currentMediaIndex }, '*');
        }

        function pauseMedia() {
            isPlaying = false;
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            clearInterval(progressInterval);
            window.parent.postMessage({ type: 'media-pausado', index: currentMediaIndex }, '*');
        }

        function stopMedia() {
            isPlaying = false;
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            clearInterval(progressInterval);
            mediaCurrentTime = 0;
            updateProgressBar();
            window.parent.postMessage({ type: 'media-detenido', index: currentMediaIndex }, '*');
        }

        function playNext() {
            currentMediaIndex++;
            if (currentMediaIndex < mediaList.length) {
                loadMedia(currentMediaIndex);
                playMedia();
            } else {
                currentMediaIndex = 0; // Volver al inicio o detener
                loadMedia(currentMediaIndex); // Cargar el primero pero no reproducir automáticamente
                stopMedia();
            }
        }

        function playPrev() {
            currentMediaIndex--;
            if (currentMediaIndex >= 0) {
                loadMedia(currentMediaIndex);
                playMedia();
            } else {
                currentMediaIndex = mediaList.length - 1; // Ir al final o detener
                loadMedia(currentMediaIndex); // Cargar el último pero no reproducir automáticamente
                stopMedia();
            }
        }

        // Funcionalidad de arrastre de la barra de progreso
        function seek(e) {
            if (mediaDuration === 0) return; // No hacer nada si no hay duración

            const rect = progressContainer.getBoundingClientRect();
            let clickX = e.clientX - rect.left; // Posición X del clic/arrastre dentro del contenedor

            // Manejar touch events
            if (e.touches && e.touches.length > 0) {
                clickX = e.touches[0].clientX - rect.left;
            }

            let newTime = (clickX / rect.width) * mediaDuration;

            // Asegurarse de que el tiempo no exceda la duración ni sea negativo
            newTime = Math.max(0, Math.min(newTime, mediaDuration));

            mediaCurrentTime = newTime;
            updateProgressBar();

            // Si se está reproduciendo, reanudar la simulación de progreso desde el nuevo tiempo
            if (isPlaying) {
                startProgressSimulation();
            }
        }

        progressContainer.addEventListener('mousedown', (e) => {
            isDraggingProgress = true;
            seek(e); // Ajustar inmediatamente al clic inicial
            // Pausar la simulación de avance para evitar conflictos
            clearInterval(progressInterval);
        });

        progressContainer.addEventListener('mousemove', (e) => {
            if (isDraggingProgress) {
                seek(e);
            }
        });

        progressContainer.addEventListener('mouseup', () => {
            isDraggingProgress = false;
            // Reanudar la simulación de avance solo si estaba reproduciendo antes del arrastre
            if (isPlaying) {
                startProgressSimulation();
            }
        });

        // Para eventos táctiles
        progressContainer.addEventListener('touchstart', (e) => {
            isDraggingProgress = true;
            seek(e);
            clearInterval(progressInterval);
        });

        progressContainer.addEventListener('touchmove', (e) => {
            if (isDraggingProgress) {
                seek(e);
            }
        });

        progressContainer.addEventListener('touchend', () => {
            isDraggingProgress = false;
            if (isPlaying) {
                startProgressSimulation();
            }
        });

        playPauseBtn.addEventListener('click', () => {
            if (isPlaying) {
                pauseMedia();
            } else {
                playMedia();
            }
        });

        prevBtn.addEventListener('click', playPrev);
        nextBtn.addEventListener('click', playNext);
        stopBtn.addEventListener('click', stopMedia);

        // Listener para mensajes del padre (ej. para reproducir un audio específico)
        window.addEventListener('message', (event) => {
            const data = event.data;
            if (data && data.tipo === 'reproducir-audio') {
                const audioIndex = data.index;
                if (audioIndex !== undefined && audioIndex < mediaList.length) {
                    loadMedia(audioIndex);
                    playMedia();
                }
            }
            if (data && data.tipo === 'pausar-audio') {
                pauseMedia();
            }
            if (data && data.tipo === 'detener-audio') {
                stopMedia();
            }
        });

        // Inicialización
        loadMedia(0); // Carga el primer medio al iniciar
    </script>
</body>
</html>
